<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpinalHDL documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="_static/gh-fork-ribbon.css" type="text/css" />
      <link rel="stylesheet" href="_static/spinaldoc.css" type="text/css" />
    <link rel="shortcut icon" href="_static/logo3_32x32.png"/>
    <link rel="canonical" href="https://spinalhdl.github.io/SpinalDoc-RTD/master/index.html" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/skins/default.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/wavedrom.min.js"></script>
        <script src="_static/dialog.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
     
    <!-- source/_templates/layout.html -->
    
    
    

</head>

<body class="wy-body-for-nav">
     
    
    
    
    <div class="div-svg-github-corner github-corner-abs">
    <a href="https://github.com/SpinalHDL/SpinalDoc-RTD/blob/master/source/index" class="github-corner github-fork-ribbon" aria-label="Edit on GitHub" data-ribbon="Edit on GitHub" title="Edit on GitHub">
      <object id="svg-github-corner" data="_static/github-corner-right.svg" class="svg-github-corner github-corner-abs" width="80" height="80"></object>
    </a>
    </div>
    
    
    

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            SpinalHDL
          </a>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Foreword/index">Foreword</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#why-moving-away-from-traditional-hdl">Why moving away from traditional HDL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#vhdl-verilog-aren-t-hardware-description-languages">VHDL/Verilog aren’t Hardware Description Languages</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#event-driven-paradigm-doesn-t-make-any-sense-for-rtl">Event driven paradigm doesn’t make any sense for RTL</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#recent-revisions-of-vhdl-and-verilog-aren-t-usable">Recent revisions of VHDL and Verilog aren’t usable</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#vhdl-records-verilog-struct-are-broken-systemverilog-is-good-on-this-if-you-can-use-it">VHDL records, Verilog struct are broken (SystemVerilog is good on this, if you can use it)</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#vhdl-and-verilog-are-so-verbose">VHDL and Verilog are so verbose</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#meta-hardware-description-capabilities">Meta Hardware Description capabilities</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/index">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/SpinalHDL">About SpinalHDL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#what-is-spinalhdl">What is SpinalHDL?</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#what-spinalhdl-is-not">What SpinalHDL is not</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#the-spinal-development-flow">The Spinal development flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#advantages-of-using-spinalhdl-over-vhdl-verilog">Advantages of using SpinalHDL over VHDL / Verilog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/A simple example">A simple example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#component">Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#ports">Ports</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#internal-logic">Internal logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/Projects using SpinalHDL">Projects using SpinalHDL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#repositories">Repositories</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#companies">Companies</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#universities">Universities</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/Getting in touch">Getting in touch</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/License">License</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/Contributing">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/faq">FAQ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#what-is-the-overhead-of-spinalhdl-generated-rtl-compared-to-human-written-vhdl-verilog">What is the overhead of SpinalHDL generated RTL compared to human written VHDL/Verilog?</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#what-if-spinalhdl-becomes-unsupported-in-the-future">What if SpinalHDL becomes unsupported in the future?</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#does-spinalhdl-keep-comments-in-generated-vhdl-verilog">Does SpinalHDL keep comments in generated VHDL/verilog?</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#could-spinalhdl-scale-up-to-big-projects">Could SpinalHDL scale up to big projects?</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-spinalhdl-came-to-be">How SpinalHDL came to be</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#why-develop-a-new-language-when-there-is-vhdl-verilog-systemverilog">Why develop a new language when there is VHDL/Verilog/SystemVerilog?</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-to-use-an-unreleased-version-of-spinalhdl-but-committed-on-git">How to use an unreleased version of SpinalHDL (but committed on git)?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Introduction/Other learning materials">Other learning materials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/index">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Install and setup">Install and setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#required-recommended-tools">Required/Recommended tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#linux-installation">Linux Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#mac-os-x-installation">Mac OS X Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#windows-installation">Windows installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#msys2-verilator-for-simulation">MSYS2 verilator for simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#msys2-for-formal-verification">MSYS2 for formal verification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#oci-container">OCI Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#installing-sbt-in-an-internet-free-linux-environment">Installing SBT in an internet-free Linux environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#create-a-first-spinalhdl-project">Create a first SpinalHDL project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#the-directory-structure-of-a-project">The directory structure of a project</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#using-spinal-on-spinalhdl-code">Using Spinal on SpinalHDL code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/SBT">Using Spinal from CLI with SBT</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/VSCodium">Using Spinal from VSCodium</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/IntelliJ">Using Spinal from IntelliJ IDEA</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Scala Guide/index">Scala Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Scala Guide/basics">Basics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#types">Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#variables">Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#functions">Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#object">Object</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#entry-point-main">Entry point (main)</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#class">Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#templates-type-parameterization">Templates / Type parameterization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Scala Guide/coding_conventions">Coding conventions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#class-vs-case-class">class vs case class</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Scala Guide/interaction">Interaction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#how-spinalhdl-works-behind-the-api">How SpinalHDL works behind the API</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#everything-is-a-reference">Everything is a reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#hardware-types">Hardware types</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#names-of-signals-in-the-generated-rtl">Names of signals in the generated RTL</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#scala-is-for-elaboration-spinalhdl-for-hardware-description">Scala is for elaboration, SpinalHDL for hardware description</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#scala-elaboration-capabilities-if-for-functional-programming">Scala elaboration capabilities (if, for, functional programming)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id1">Scala guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Help for VHDL people/index">Help for VHDL people</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Help for VHDL people/vhdl_comp">VHDL comparison</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#process">Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#implicit-vs-explicit-definitions">Implicit vs explicit definitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#clock-domains">Clock domains</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#component-s-internal-organization">Component’s internal organization</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#safety">Safety</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#functions-and-procedures">Functions and procedures</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#buses-and-interfaces">Buses and Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#signal-declaration">Signal declaration</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#component-instantiation">Component instantiation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#casting">Casting</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#resizing">Resizing</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#parameterization">Parameterization</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#meta-hardware-description">Meta hardware description</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Help for VHDL people/vhdl_perspective">VHDL equivalences</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#entity-and-architecture">Entity and architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#data-types">Data types</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#signal">Signal</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#assignments">Assignments</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#literals">Literals</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#registers">Registers</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#process-blocks">Process blocks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Cheatsheets/index">Cheatsheets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Cheatsheets/core">Core</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Cheatsheets/lib">Lib</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Getting Started/Cheatsheets/symbolic">Symbolic</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/index">Data types</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/bool">Bool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#logic">Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#edge-detection">Edge detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#misc">Misc</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#maskedboolean">MaskedBoolean</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/bits">Bits</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#logic">Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bit-extraction">Bit extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#misc">Misc</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#maskedliteral">MaskedLiteral</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/Int">UInt/SInt</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#logic">Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#arithmetic">Arithmetic</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bit-extraction">Bit extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#misc">Misc</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#fixpoint-operations">FixPoint operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#lower-bit-operations">Lower bit operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#high-bit-operations">High bit operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#fixto-function">fixTo function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/enum">SpinalEnum</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#encoding">Encoding</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#types">Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/bundle">Bundle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#conditional-signals">Conditional signals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#convert-bits-back-to-bundle">Convert Bits back to Bundle</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#io-element-direction">IO Element direction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#in-out">in/out</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#master-slave">master/slave</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/Vec">Vec</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#misc">Misc</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#lib-helper-functions">Lib helper functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/Fix">UFix/SFix</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#unsigned-fixed-point">Unsigned Fixed-Point</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#signed-fixed-point">Signed Fixed-Point</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#format">Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#assignments">Assignments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#valid-assignments">Valid Assignments</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#from-a-scala-constant">From a Scala constant</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#raw-value">Raw value</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#id2">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#arithmetic">Arithmetic</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#comparison">Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#misc">Misc</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/Floating">Floating</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#ieee-754-floating-format">IEEE-754 floating format</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#recoded-floating-format">Recoded floating format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#ieee-754-number">IEEE-754 Number</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#recoded-floating-point-number">Recoded floating-point number</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#type-cast">Type cast</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Data types/AFix">AFix</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#declaration">Declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#mathematical-operations">Mathematical Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#inequality-operations">Inequality Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bitshifting">Bitshifting</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#saturation-and-rounding">Saturation and Rounding</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#assignment">Assignment</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/index">Structuring</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/components_hierarchy">Components and hierarchy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#input-output-definition">Input / output definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#pruned-signals">Pruned signals</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#parametrized-hardware-generic-in-vhdl-parameter-in-verilog">Parametrized Hardware (“Generic” in VHDL, “Parameter” in Verilog)</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#synthesized-component-names">Synthesized component names</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/area">Area</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/function">Function</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#rgb-to-gray">RGB to gray</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#valid-ready-payload-bus">Valid Ready Payload bus</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/clock_domain">Clock domains</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#instantiation">Instantiation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#internal-clock">Internal clock</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#external-clock">External clock</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#signal-priorities-in-hdl-generation">Signal priorities in HDL generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#context">Context</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#clock-domain-crossing">Clock domain crossing</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#special-clocking-areas">Special clocking Areas</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#slow-area">Slow Area</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bootreset">BootReset</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#resetarea">ResetArea</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#clockenablearea">ClockEnableArea</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/blackbox">Instantiate VHDL and Verilog IP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#defining-an-blackbox">Defining an blackbox</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#generics">Generics</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#instantiating-a-blackbox">Instantiating a blackbox</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#clock-and-reset-mapping">Clock and reset mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#io-prefix">io prefix</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#rename-all-io-of-a-blackbox">Rename all io of a blackbox</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#add-rtl-source">Add RTL source</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#vhdl-no-numeric-type">VHDL - No numeric type</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/naming">Preserving names</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#nameable-base-class">Nameable base class</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#name-extraction-from-scala">Name extraction from Scala</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#area-in-a-component">Area in a Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#area-in-a-function">Area in a function</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#composite-in-a-function">Composite in a function</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#composite-chains">Composite chains</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#composite-in-a-bundle-s-function">Composite in a Bundle’s function</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#unnamed-signal-handling">Unnamed signal handling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#verilog-expression-splitting">Verilog expression splitting</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#verilog-long-expression-splitting">Verilog long expression splitting</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#when-statement-condition">When statement condition</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#in-last-resort">In last resort</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Structuring/parametrization">Parametrization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#elaboration-time-parameters">Elaboration time parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#optional-hardware">Optional hardware</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Semantic/index">Semantic</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Semantic/assignments">Assignments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#width-checking">Width checking</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#combinatorial-loops">Combinatorial loops</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#combinit">CombInit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Semantic/when_switch">When/Switch/Mux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#when">When</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#whenbuilder">WhenBuilder</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#switch">Switch</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#additional-options">Additional options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#local-declaration">Local declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#mux">Mux</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bitwise-selection">Bitwise selection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#id1">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Semantic/rules">Rules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#concurrency">Concurrency</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#last-valid-assignment-wins">Last valid assignment wins</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#signal-and-register-interactions-with-scala-oop-reference-functions">Signal and register interactions with Scala (OOP reference + Functions)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Sequential logic/index">Sequential logic</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Sequential logic/registers">Registers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#instantiation">Instantiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#reset-value">Reset value</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#initialization-value-for-simulation-purposes">Initialization value for simulation purposes</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#register-vectors">Register vectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#transforming-a-signal-into-a-register">Transforming a signal into a register</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Sequential logic/memory">RAM/ROM Memory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#synchronous-enable-quirk">Synchronous enable quirk</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#read-under-write-policy">Read-under-write policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#mixed-width-ram">Mixed-width ram</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#automatic-blackboxing">Automatic blackboxing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#blackboxing-policy">Blackboxing policy</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#standard-memory-blackboxes">Standard memory blackboxes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/index">Design errors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/assignment_overlap">Assignment overlap</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/clock_crossing_violation">Clock crossing violation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#crossclockdomain-tag">crossClockDomain tag</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#setsynchronouswith">setSynchronousWith</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#buffercc">BufferCC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/combinatorial_loop">Combinatorial loop</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#false-positives">False-positives</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/hierarchy_violation">Hierarchy violation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/iobundle">IO bundle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/latch_detected">Latch detected</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#due-to-mux">Due to mux</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/no_driver_on">No driver on</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/nullpointerexception">NullPointerException</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#issue-explanation">Issue explanation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/out_of_range_constant">Out of Range Constant</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#specifying-exceptions">Specifying exceptions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/register_defined_as_component_input">Register defined as component input</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/scope_violation">Scope violation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/spinal_cant_clone">Spinal can’t clone class</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example-1">Example 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example-2">Example 2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/unassigned_register">Unassigned register</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#register-with-only-init">Register with only init</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/unreachable_is_statement">Unreachable is statement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Design errors/width_mismatch">Width mismatch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#assignment-example">Assignment example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#operator-example">Operator example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/index">Other language features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/utils">Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#general">General</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#cat">Cat</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#cloning-hardware-datatypes">Cloning hardware datatypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#passing-a-datatype-as-construction-parameter">Passing a datatype as construction parameter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#the-old-way">The old way</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#the-safe-way">The safe way</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#frequency-and-time">Frequency and time</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#binary-prefix">Binary prefix</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/stub">Stub</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/assertion">Assertions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/report">Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/scope_property">ScopeProperty</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/analog_inout">Analog and inout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#analog">Analog</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#inout">inout</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#inoutwrapper">InOutWrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#manually-driving-analog-bundles">Manually driving Analog bundles</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Other language features/vhdl_generation">VHDL and Verilog generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#generate-vhdl-and-verilog-from-a-spinalhdl-component">Generate VHDL and Verilog from a SpinalHDL Component</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#parametrization-from-scala">Parametrization from Scala</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#parametrization-from-shell">Parametrization from shell</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#generated-vhdl-and-verilog">Generated VHDL and Verilog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#organization">Organization</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#combinational-logic">Combinational logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#sequential-logic">Sequential logic</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#vhdl-and-verilog-attributes">VHDL and Verilog attributes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/index">Libraries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/utils">Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#state-less-utilities">State less utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#state-full-utilities">State full utilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#counter">Counter</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#timeout">Timeout</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#resetctrl">ResetCtrl</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#special-utilities">Special utilities</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/stream">Stream</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#semantics">Semantics</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#utils">Utils</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamfifo">StreamFifo</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamfifocc">StreamFifoCC</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamccbytoggle">StreamCCByToggle</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamwidthadapter">StreamWidthAdapter</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamarbiter">StreamArbiter</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamjoin">StreamJoin</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamfork">StreamFork</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streammux">StreamMux</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamdemux">StreamDemux</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamdispatchersequencial">StreamDispatcherSequencial</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#streamtransactionextender">StreamTransactionExtender</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#simulation-support">Simulation support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/flow">Flow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#code-example">Code example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#simulation-support">Simulation Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/fragment">Fragment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/fsm">State machine</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#statemachine">StateMachine</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#entry-point">Entry point</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#transitions">Transitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#state-encoding">State encoding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#states">States</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#statedelay">StateDelay</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#statefsm">StateFsm</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#stateparallelfsm">StateParallelFsm</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#notes-about-the-entry-state">Notes about the entry state</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#notes-about-using-state-value">Notes about using state value</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/vexriscv">VexRiscv (RV32IM CPU)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/bus_slave_factory">Bus Slave Factory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#functionality">Functionality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/fiber">Fiber framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#simple-dummy-example">Simple dummy example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#handle-t">Handle[T]</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#soon-handle">soon(handle)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/binarySystem">BinarySystem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#string-to-int-long-bigint">String to Int/Long/BigInt</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#int-long-bigint-to-string">Int/Long/BigInt to String</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#int-long-bigint-to-binary-list">Int/Long/BigInt to Binary-List</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#binary-list-to-int-long-bigint">Binary-List to Int/Long/BigInt</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bigint-enricher">BigInt enricher</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/regIf">RegIf</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#automatic-allocation">Automatic allocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#access-types">28 Access Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#automatic-documentation-generation">Automatic documentation generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#special-access-usage">Special Access Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#byte-mask">Byte Mask</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#typical-example">Typical Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#interrupt-factory">Interrupt Factory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#ip-level-interrupt-factory">IP level interrupt Factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#sys-level-interrupt-merge">SYS level interrupt merge</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#spinal-factory">Spinal Factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#defaultreadvalue">DefaultReadValue</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#developers-area">Developers Area</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/index">Bus</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/amba3/ahblite3">AHB-Lite3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration-and-instantiation">Configuration and instantiation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#variations">Variations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/amba3/apb3">Apb3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration-and-instantiation">Configuration and instantiation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#functions-and-operators">Functions and operators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/amba4/axi4">Axi4</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration-and-instantiation">Configuration and instantiation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#variations">Variations</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#functions-and-operators">Functions and operators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/avalon/avalonmm">AvalonMM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration-and-instantiation">Configuration and instantiation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/tilelink/tilelink">Tilelink</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration-and-instantiation">Configuration and instantiation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Bus/tilelink/tilelink_fabric">tilelink.fabric.Node</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#example-toplevel">Example Toplevel</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example-gpiofiber">Example GpioFiber</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example-ramfiber">Example RamFiber</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example-cpufiber">Example CpuFiber</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example-widthadapter">Example WidthAdapter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Com/index">Com</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Com/spiXdr">SPI XDR</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#software-driver">Software Driver</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Com/uart">UART</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#bus-definition">Bus definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#uartctrl">UartCtrl</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Com/usb_device">USB device</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#registers">Registers</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#descriptors">Descriptors</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Com/usb_ohci">USB OHCI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#usage">Usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/IO/index">IO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/IO/readableOpenDrain">ReadableOpenDrain</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/IO/tristate">TriState</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#id1">TriState</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#tristatearray">TriStateArray</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Graphics/index">Graphics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Graphics/colors">Colors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#rgb">RGB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Graphics/vga">VGA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#vga-bus">VGA bus</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#vga-timings">VGA timings</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#vga-controller">VGA controller</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/EDA/index">EDA</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/EDA/altera/qsysify">QSysify</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#tags">tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#adding-new-interface-support">Adding new interface support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/EDA/altera/quartus_flow">QuartusFlow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#for-a-single-rtl-file">For a single rtl file</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#for-an-existing-project">For an existing project</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Pipeline/index">Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Pipeline/introduction">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#simple-example">Simple example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#payload">Payload</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#node">Node</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#links">Links</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#directlink">DirectLink</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#stagelink">StageLink</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#s2mlink">S2mLink</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#ctrllink">CtrlLink</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#other-links">Other Links</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#your-custom-link">Your custom Link</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#builders">Builders</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#stagepipeline">StagePipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#stagectrlpipeline">StageCtrlPipeline</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#composability">Composability</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#retiming-variable-length">Retiming / Variable length</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#simple-cpu-example">Simple CPU example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Misc/index">Misc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Misc/PLIC/plic_mapper">Plic Mapper</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#plicmapper-apply"><code class="docutils literal notranslate"><span class="pre">PlicMapper.apply</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#plicmapping-sifive"><code class="docutils literal notranslate"><span class="pre">PlicMapping.sifive</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#plicmapping-light"><code class="docutils literal notranslate"><span class="pre">PlicMapping.light</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Libraries/Misc/service_plugin">Plugin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#execution-order">Execution order</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#simple-example">Simple example</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#interlocking-ordering">Interlocking / Ordering</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/index">Simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/install/index">SBT setup for simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#backend-dependent-installation-instructions">Backend-dependent installation instructions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/install/GHDL">Setup and installation of GHDL</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/install/Icarus Verilog">Setup and installation of Icarus Verilog</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/install/VCS">VCS Simulation Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/install/Verilator">Setup and installation of Verilator</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/bootstraps">Boot a simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#running-multiple-tests-on-the-same-hardware">Running multiple tests on the same hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#throw-success-or-failure-of-the-simulation-from-a-thread">Throw Success or Failure of the simulation from a thread</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#capturing-wave-for-a-given-window-before-failure">Capturing wave for a given window before failure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/signal">Accessing signals of the simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#read-and-write-signals">Read and write signals</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#accessing-signals-inside-the-component-s-hierarchy">Accessing signals inside the component’s hierarchy</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#load-and-store-of-memory-in-simulation">Load and Store of Memory in Simulation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/clock">Clock domains</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#stimulus-api">Stimulus API</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#wait-api">Wait API</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#callback-api">Callback API</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#default-clockdomain">Default ClockDomain</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#new-clockdomain">New ClockDomain</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/threadFull">Thread-full API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#fork-and-join-simulation-threads">Fork and join simulation threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#sleep-and-waituntil">Sleep and waitUntil</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/threadLess">Thread-less API</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/sensitive">Sensitive API</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/simulator_specifics">Simulator specific details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-spinalhdl-simulates-the-hardware-with-verilator-backend">How SpinalHDL simulates the hardware with Verilator backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-spinalhdl-simulates-the-hardware-with-ghdl-icarus-verilog-backend">How SpinalHDL simulates the hardware with GHDL/Icarus Verilog backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-spinalhdl-simulates-the-hardware-with-synopsys-vcs-backend">How SpinalHDL simulates the hardware with Synopsys VCS backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-spinalhdl-simulates-the-hardware-with-xilinx-xsim-backend">How SpinalHDL simulates the hardware with Xilinx XSim backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#performance">Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/engine">Simulation engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/index">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/asynchronous">Asynchronous adder</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/dual_clock_fifo">Dual clock fifo</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/single_clock_fifo">Single clock fifo</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/synchronous">Synchronous adder</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/uart_decoder">Uart decoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Simulation/examples/uart_encoder">Uart encoder</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Formal verification/index">Formal verification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#general">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#formal-backend">Formal backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#installing-requirements">Installing requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#example">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#external-assertions">External assertions</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#internal-assertions">Internal assertions</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#external-stimulus">External stimulus</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#more-assertions-past">More assertions / past</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#assuming-memory-content">Assuming memory content</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#utilities-and-primitives">Utilities and primitives</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#assertions-clock-reset">Assertions / clock / reset</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#specifying-the-initial-value-of-a-signal">Specifying the initial value of a signal</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#specifying-a-initial-assumption">Specifying a initial assumption</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#memory-content-mem">Memory content (Mem)</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#specifying-assertion-in-the-reset-scope">Specifying assertion in the reset scope</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#formal-primitives">Formal primitives</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#naming-polices">Naming polices</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#for-component">For Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#for-interfaces-implement-imasterslave">For interfaces implement IMasterSlave</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/index">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/index">Simple ones</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/apb3">APB3 definition</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#implementation">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/carry_adder">Carry adder</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/color_summing">Color summing</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/counter_with_clear">Counter with clear</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/pll_resetctrl">PLL BlackBox and reset controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#the-pll-blackbox-definition">The PLL BlackBox definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#toplevel-definition">TopLevel definition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/rgb_to_gray">RGB to gray</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Simple ones/sinus_rom">Sinus ROM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Intermediates ones/index">Intermediates ones</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Intermediates ones/fractal">Fractal calculator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#elaboration-parameters-generics">Elaboration parameters (Generics)</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bundle-definition">Bundle definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#component-implementation">Component implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Intermediates ones/uart">UART</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#data-structures">Data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#implementation">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#simple-usage">Simple usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#example-with-test-bench">Example with test bench</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bonus-having-fun-with-stream">Bonus: Having fun with Stream</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Intermediates ones/vga">VGA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#data-structures">Data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#vga-controller">VGA Controller</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Advanced ones/index">Advanced ones</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Advanced ones/jtag">JTAG TAP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#jtag-bus">JTAG bus</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#jtag-state-machine">JTAG state machine</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#id1">JTAG TAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#jtag-instructions">Jtag instructions</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#user-friendly-wrapper">User friendly wrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#usage-demonstration">Usage demonstration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Advanced ones/memory_mapped_uart">Memory mapped UART</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Advanced ones/pinesec">Pinesec</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Advanced ones/slots">Slots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Examples/Advanced ones/timer">Timer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#id2">Timer</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bridging-function">Bridging function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#getting-started">Getting started</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/index">Legacy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/riscv">RiscV</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#features">Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#base-fpga-project">Base FPGA project</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-to-generate-the-cpu-vhdl">How to generate the CPU VHDL</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#how-to-debug">How to debug</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#todo">Todo</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/pinsec/index">pinsec</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/pinsec/introduction">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#id1">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#board-support">Board support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/pinsec/hardware">Hardware</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#riscv">RISCV</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#axi4">AXI4</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#apb3">APB3</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#generate-the-rtl">Generate the RTL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/pinsec/hardware_toplevel">SoC toplevel (Pinsec)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#defining-all-io">Defining all IO</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#clock-and-resets">Clock and resets</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#main-components">Main components</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#peripherals">Peripherals</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#bus-interconnects">Bus interconnects</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#misc">Misc</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#document-SpinalHDL/Legacy/pinsec/software">Software</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#riscv-tool-chain">RISCV tool-chain</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#openocd-gdb-eclipse-configuration">OpenOCD/GDB/Eclipse  configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/miscelenea/index">Miscellaneous</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/miscelenea/frequent_errors">Frequent Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#exception-in-thread-main-java-lang-nullpointerexception">Exception in thread “main” java.lang.NullPointerException</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#hierarchy-violation">Hierarchy violation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#signal-x-can-t-be-assigned-by-y">Signal X can’t be assigned by Y</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#input-signal-x-can-t-be-assigned-by-y">Input signal X can’t be assigned by Y</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#output-signal-x-can-t-be-assigned-by-y">Output signal X can’t be assigned by Y</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/miscelenea/core/core_components">The <code class="docutils literal notranslate"><span class="pre">spinal.core</span></code> components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#clock-domains-definitions">Clock domains definitions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#clock-domain-syntax">Clock domain syntax</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#clock-configuration">Clock configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#external-clock">External clock</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#cross-clock-domain">Cross Clock Domain</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#assignments">Assignments</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#when-switch">When / Switch</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#component-hierarchy">Component/Hierarchy</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#area">Area</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#function">Function</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#rgb-to-gray">RGB to gray</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#valid-ready-payload-bus">Valid Ready Payload bus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#vhdl-generation">VHDL generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#instantiate-vhdl-and-verilog-ip">Instantiate VHDL and Verilog IP</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#utils">Utils</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/miscelenea/core/elements">Element</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#range">Range</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/index">Developers area</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/bus_slave_factory_impl">Bus Slave Factory Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#implementation">Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#busslavefactory">BusSlaveFactory</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#busslavefactorydelayed">BusSlaveFactoryDelayed</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#avalonmmslavefactory">AvalonMMSlaveFactory</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/howotuselocalspinalclone">How to use a local SpinalHDL clone as project dependency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#create-local-git-clone-of-spinalhdl">Create local git clone of SpinalHDL</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#configure-buildsystem">Configure buildsystem</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#configure-sbt-update-build-sbt">Configure sbt (update <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>)</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#configure-mill-update-build-sc">Configure mill (update <code class="docutils literal notranslate"><span class="pre">build.sc</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#done">Done</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/howtodocument">How to HACK this documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#title-convention">Title convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#wavedrom-integration">Wavedrom integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#new-section">New section</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#example">example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/mill support">Build through Mill</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#compile-the-library">Compile the library</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#run-all-test-suites">Run all test suites</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#run-a-specified-test-suite">Run a specified test suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#run-a-specified-app">Run a specified App</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#publish-locally">Publish locally</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/spinalhdl_datamodel">SpinalHDL internal datamodel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#general-structure">General structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#exploring-the-datamodel">Exploring the datamodel</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#compilation-phases">Compilation Phases</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#modifying-a-netlist-as-a-user-without-plugins">Modifying a netlist as a user without plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#user-space-netlist-analysis">User space netlist analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#enumerating-every-clockdomain-in-use">Enumerating every ClockDomain in use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-SpinalHDL/Developers area/types">Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bool">Bool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#declaration">Declaration</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#operators">Operators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#the-bitvector-family-bits-uint-sint">The BitVector family - (<code class="docutils literal notranslate"><span class="pre">Bits</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt</span></code>, <code class="docutils literal notranslate"><span class="pre">SInt</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#declaration-syntax">Declaration syntax</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#id1">Operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#masked-comparison">Masked comparison</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bits">Bits</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#uint-sint">UInt, SInt</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bool-bits-uint-sint">Bool, Bits, UInt, SInt</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#vec">Vec</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#bundle">Bundle</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#simple-example-rgb-vga">Simple example (RGB/VGA)</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#interface-example-apb">Interface example (APB)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#enum">Enum</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#data-bool-bits-uint-sint-enum-bundle-vec">Data (Bool, Bits, UInt, SInt, Enum, Bundle, Vec)</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#literals-as-signal-declaration">Literals as signal declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#continuous-assignment-literals-as-signal-declaration">Continuous Assignment Literals as signal declaration</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">SpinalHDL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">SpinalHDL  documentation</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/SpinalHDL/SpinalDoc-RTD/blob/master/source/index" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             <dialog id="doc-dialog-version" role="dialog" class="collapse-once" aria-modal="false" data-default-state="close" data-current-version="master" data-latest-version="master">
<p class="doc-version-warning-banner">
  <strong>
    
    You're reading an pre-release version of this documentation.<br/>
    For the latest stable release version, please have a look at <a href="index.html">master</a>.
    
  </strong>
  <div>
    <form>
      <button formmethod="dialog" type="submit" class="doc-dialog-dismiss" aria-label="close">Dismiss</button>
    </form>
  </div>
</p>
</dialog>




  <section id="spinal-hardware-description-language">
<h1>Spinal Hardware Description Language<a class="headerlink" href="#spinal-hardware-description-language" title="Permalink to this heading"></a></h1>
<p>Welcome to SpinalHDL’s documentation!</p>
<p>SpinalHDL is an open source high-level hardware description language. It can be
used as an alternative to VHDL or Verilog and has several advantages over them:</p>
<ul class="simple">
<li><p>It focuses on efficient hardware description instead of being event-driven.</p></li>
<li><p>It is embedded into a general purpose programming language, enabling powerful
hardware generation.</p></li>
</ul>
<p>More detailed introduction of the language in <a class="reference internal" href="index.html#introduction-spinalhdl"><span class="std std-ref">About SpinalHDL</span></a></p>
<div class="line-block">
<div class="line">HTML and PDF formats of this documentation are available online:</div>
<div class="line">&gt; <a class="reference external" href="https://spinalhdl.github.io/SpinalDoc-RTD/master/index.html">spinalhdl.github.io/SpinalDoc-RTD</a></div>
<div class="line">(PDF format is accessible from the lower left corner, click <code class="docutils literal notranslate"><span class="pre">v:master</span></code> then PDF)</div>
<div class="line">Chinese version of documentation:</div>
<div class="line">&gt; <a class="reference external" href="https://github.com/thuCGRA/SpinalHDL_Chinese_Doc">github.com/thuCGRA/SpinalHDL_Chinese_Doc</a></div>
<div class="line">You can also find the API documentation:</div>
<div class="line">&gt; <a class="reference external" href="https://spinalhdl.github.io/SpinalHDL/dev/spinal/index.html">spinalhdl.github.io/SpinalHDL</a></div>
</div>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Foreword/index"></span><section id="foreword">
<span id="id1"></span><h2>Foreword<a class="headerlink" href="#foreword" title="Permalink to this heading"></a></h2>
<p>Preliminary notes:</p>
<ul class="simple">
<li><p>All the following statements will be about describing digital hardware.
Verification is another tasty topic.</p></li>
<li><p>For conciseness, let’s assume that SystemVerilog is a recent revision of
Verilog.</p></li>
<li><p>When reading this, we should not underestimate how much our attachment for our
favorite HDL will bias our judgement.</p></li>
</ul>
<section id="why-moving-away-from-traditional-hdl">
<h3>Why moving away from traditional HDL<a class="headerlink" href="#why-moving-away-from-traditional-hdl" title="Permalink to this heading"></a></h3>
<section id="vhdl-verilog-aren-t-hardware-description-languages">
<h4>VHDL/Verilog aren’t Hardware Description Languages<a class="headerlink" href="#vhdl-verilog-aren-t-hardware-description-languages" title="Permalink to this heading"></a></h4>
<p>Those languages are event driven languages created initially for
simulation/documentation purposes. Only in a second time they were used as
inputs languages for synthesis tools. Which explain the roots of a lot of the
following points.</p>
</section>
<section id="event-driven-paradigm-doesn-t-make-any-sense-for-rtl">
<h4>Event driven paradigm doesn’t make any sense for RTL<a class="headerlink" href="#event-driven-paradigm-doesn-t-make-any-sense-for-rtl" title="Permalink to this heading"></a></h4>
<p>When you think about it, describing digital hardware (RTL) by using
process/always blocks doesn’t make any practical senses. Why do we have to worry
about a sensitivity list? Why do we have to split our design between
processes/always blocks of different natures (combinatorial logic / register
without reset / register with async reset)?</p>
<p>For instance, to implement this:</p>
<img alt="_images/example_design.png" class="align-center" src="_images/example_design.png" />
<p>Using VHDL processes you write this:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">signal</span><span class="w"> </span><span class="n">mySignal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="k">signal</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="k">signal</span><span class="w"> </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="k">process</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"></span>
<span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">mySignal</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">        </span><span class="n">mySignal</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">process</span><span class="p">;</span><span class="w"></span>

<span class="k">process</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>
<span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">            </span><span class="n">myRegister</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">process</span><span class="p">;</span><span class="w"></span>

<span class="k">process</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span><span class="n">reset</span><span class="p">)</span><span class="w"></span>
<span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">        </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">elsif</span><span class="w"> </span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">            </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">process</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Using SpinalHDL you write this:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">mySignal</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRegister</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRegisterWithReset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="n">mySignal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">mySignal</span><span class="w">            </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="n">myRegister</span><span class="w">          </span><span class="o">:=</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As for everything, you can get used to this event driven semantic, until you
taste something better.</p>
</section>
<section id="recent-revisions-of-vhdl-and-verilog-aren-t-usable">
<h4>Recent revisions of VHDL and Verilog aren’t usable<a class="headerlink" href="#recent-revisions-of-vhdl-and-verilog-aren-t-usable" title="Permalink to this heading"></a></h4>
<p>The EDA industry is really slow to implement VHDL 2008 and SystemVerilog
synthesis capabilities in their tools. Additionally, when it’s done, it appear
that only a constraining subset of the language is implemented (not talking
about simulation features). It result that using any interesting feature of
those language revision isn’t safe as:</p>
<ul class="simple">
<li><p>It will probably make your code incompatible with many EDA tools.</p></li>
<li><p>Other companies will likely not accept your IP as their flow isn’t ready for
it.</p></li>
</ul>
<p>Anyway, those revisions don’t change the heart of those HDL issues: they are
based on a event driven paradigm which doesn’t make sense to describe digital
hardware.</p>
</section>
<section id="vhdl-records-verilog-struct-are-broken-systemverilog-is-good-on-this-if-you-can-use-it">
<h4>VHDL records, Verilog struct are broken (SystemVerilog is good on this, if you can use it)<a class="headerlink" href="#vhdl-records-verilog-struct-are-broken-systemverilog-is-good-on-this-if-you-can-use-it" title="Permalink to this heading"></a></h4>
<p>You can’t use them to define an interface, because you can’t define their
internal signal directions. Even worst, you can’t give them construction
parameters! So, define your RGB record/struct once, and hope you never have to
use it with bigger/smaller color channels…</p>
<p>Also a fancy thing with VHDL is the fact that if you want to add an array of
something into a component entity, you have to define the type of this array
into a package… Which can’t be parameterized…</p>
<p>For instance, below is a SpinalHDL APB3 bus definition:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Class which can be instantiated to represent a given APB3 configuration</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">selWidth</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">// Class which can be instantiated to represent a given hardware APB3 bus</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w">  </span><span class="c1">// Optional signal</span>

<span class="w">  </span><span class="c1">// Can be used to setup a given APB3 bus into a master interface of the host component</span>
<span class="w">  </span><span class="c1">// `asSlave` is automatically implemented by symmetry</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">PADDR</span><span class="p">,</span><span class="w"> </span><span class="nc">PSEL</span><span class="p">,</span><span class="w"> </span><span class="nc">PENABLE</span><span class="p">,</span><span class="w"> </span><span class="nc">PWRITE</span><span class="p">,</span><span class="w"> </span><span class="nc">PWDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="nc">PREADY</span><span class="p">,</span><span class="w"> </span><span class="nc">PRDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">PSLVERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then about the VHDL 2008 partial solution and the SystemVerilog
interface/modport, lucky you are if your EDA tools / company flow / company
policy allow you to use them.</p>
</section>
<section id="vhdl-and-verilog-are-so-verbose">
<h4>VHDL and Verilog are so verbose<a class="headerlink" href="#vhdl-and-verilog-are-so-verbose" title="Permalink to this heading"></a></h4>
<p>Really, with VHDL and Verilog, when it starts to be about component
instantiation interconnection, the copy-paste god has to be invoked.</p>
<p>To understand it more deeply, below is a SpinalHDL example performing some
peripherals instantiation and adding the APB3 decoder required to access them.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Instantiate an AXI4 to APB3 bridge</span>
<span class="kd">val</span><span class="w"> </span><span class="n">apbBridge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4ToApb3Bridge</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">idWidth</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">// Instantiate some APB3 peripherals</span>
<span class="kd">val</span><span class="w"> </span><span class="n">gpioACtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">(</span><span class="n">gpioWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">gpioBCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">(</span><span class="n">gpioWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">timerCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">PinsecTimerCtrl</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3UartCtrl</span><span class="p">(</span><span class="n">uartCtrlConfig</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">vgaCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4VgaCtrl</span><span class="p">(</span><span class="n">vgaCtrlConfig</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Instantiate an APB3 decoder</span>
<span class="c1">// - Driven by the apbBridge</span>
<span class="c1">// - Map each peripheral in a memory region</span>
<span class="kd">val</span><span class="w"> </span><span class="n">apbDecoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Decoder</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apbBridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">slaves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">gpioACtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">gpioBCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x01000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x10000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">timerCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x20000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">vgaCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x30000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Done. That’s all. You don’t have to bind each signal one by one when you
instantiate a module/component because you can access their interfaces in a
object-oriented manner.</p>
<p>Also about VHDL/Verilog struct/records, we can say that they are really dirty
tricks, without true parameterization and reusability capabilities, trying to
hide the fact that those languages were poorly designed.</p>
</section>
<section id="meta-hardware-description-capabilities">
<h4>Meta Hardware Description capabilities<a class="headerlink" href="#meta-hardware-description-capabilities" title="Permalink to this heading"></a></h4>
<p>Basically VHDL and Verilog provide some elaboration tools which aren’t directly
mapped into hardware as loops / generate statements / macro / function /
procedure / task. But that’s all.</p>
<p>And even then, they are really limited. For instance, one can’t define
process/always/component/module blocks into a task/procedure. It is really a
bottleneck for many fancy things.</p>
<p>With SpinalHDL you can call a user-defined task/procedure on a bus like that:
<code class="docutils literal notranslate"><span class="pre">myHandshakeBus.queue(depth=64)</span></code>. Below is some code including the definition.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define the concept of handshake bus</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w">  </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloneOf</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define an operator to connect the left operand (this) to the right operand (that)</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">&gt;&gt;</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">ready</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Return a Stream connected to this via a FIFO of depth elements</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">queue</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">fifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s see further, imagine you want to define a state machine. With VHDL/Verilog
you have to write a lot of raw code with some switch statements to do it. You
can’t define the notion of “StateMachine”, which would give you a nice syntax to
define each state. Else you can use a third-party tool to draw your state
machine and then generate your VHDL/Verilog equivalent code…</p>
<p>Meta-hardware description capabilities of SpinalHDL enable you to define your
own tools which then allow you to define things in abstracts ways, as for state
machines.</p>
<p>Below is an simple example of the usage of a state machine abstraction defined
on the top of SpinalHDL:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define a new state machine</span>
<span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Define all states</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="p">,</span><span class="w"> </span><span class="n">stateB</span><span class="p">,</span><span class="w"> </span><span class="n">stateC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Set the entry point</span>
<span class="w">  </span><span class="n">setEntry</span><span class="p">(</span><span class="n">stateA</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define a register used into the state machine</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define the state machine behavior for each state</span>
<span class="w">  </span><span class="n">stateA</span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateB</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="n">stateB</span><span class="p">.</span><span class="n">onEntry</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">stateB</span><span class="p">.</span><span class="n">onExit</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">stateB</span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">goto</span><span class="p">(</span><span class="n">stateC</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">stateC</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateA</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Imagine you want to generate the instruction decoding of your CPU. It could
require some fancy elaboration time algorithms to generate the less logic
possible. But in VHDL/Verilog, your only option to do these kind of things is to
write a script which generates the <code class="docutils literal notranslate"><span class="pre">.vhd</span></code> and <code class="docutils literal notranslate"><span class="pre">.v</span></code> that you want.</p>
<p>There is really much to say about meta-hardware description, but the only true
way to understand it and get its real taste is to experiment it. The goal with
it is to stop playing with wires and gates, to start taking some distance with
that low level stuff, to think reusable.</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Introduction/index"></span><section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>This section introduces the SpinalHDL project: the language, and everything
around it.</p>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Introduction/SpinalHDL"></span><section id="about-spinalhdl">
<span id="introduction-spinalhdl"></span><h3>About SpinalHDL<a class="headerlink" href="#about-spinalhdl" title="Permalink to this heading"></a></h3>
<section id="what-is-spinalhdl">
<h4>What is SpinalHDL?<a class="headerlink" href="#what-is-spinalhdl" title="Permalink to this heading"></a></h4>
<p>SpinalHDL is an open source high-level hardware description language with
associated tools. Its development started in December 2014.</p>
<p>SpinalHDL makes it possible to efficiently describe hardware, giving names to
digital hardware notions; the most obvious examples are <code class="docutils literal notranslate"><span class="pre">Reg</span></code> and <code class="docutils literal notranslate"><span class="pre">Latch</span></code>.
In event-driven languages such as VHDL and Verilog, to use these two common
elements, the user has to describe how to simulate them with a process, so that
the synthesis tool can infer what cell it is. With SpinalHDL, you just have to
declare a <code class="docutils literal notranslate"><span class="pre">Reg</span></code> or a <code class="docutils literal notranslate"><span class="pre">Latch</span></code>.</p>
<p>SpinalHDL is a <em>domain-specific language</em> based on Scala a general-purpose
language. It brings several benefits:</p>
<ul>
<li><p>There are free integrated development environments supporting it, providing
many features that simple text editors don’t have:</p>
<blockquote>
<div><ul class="simple">
<li><p>syntax and type errors are highlighted right in the code</p></li>
<li><p>correct renaming, even across files</p></li>
<li><p>smart auto completion / suggestions</p></li>
<li><p>navigation tools (go to definition, show all references, etc.)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>It allows to implement simple to complex hardware generators (meta-hardware
description) with no need to deal with several languages.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://scala-lang.org/">Scala</a> is a statically-typed, functional and
object-oriented language using the Java virtual machine (JVM).</p>
</div>
</section>
<section id="what-spinalhdl-is-not">
<h4>What SpinalHDL is not<a class="headerlink" href="#what-spinalhdl-is-not" title="Permalink to this heading"></a></h4>
<p>SpinalHDL is not an HLS tool: its goal is not to automagically transform an
abstract algorithm into a digital circuit. Its goal is to create a new
abstraction level by naming things, to help the designer reuse their code and
not write the same thing over and over again.</p>
<p>SpinalHDL is not an analog modeling language. VHDL and Verilog make it possible
for analog designers to provide a model of their IP to digital designers.
SpinalHDL does not address this case, and is for digital designers to describe
their own digital designs.</p>
</section>
<section id="the-spinal-development-flow">
<h4>The Spinal development flow<a class="headerlink" href="#the-spinal-development-flow" title="Permalink to this heading"></a></h4>
<p>Once code is written in <em>SpinalHDL</em>, the tool can:</p>
<ul class="simple">
<li><p>Generate VHDL, Verilog or SystemVerilog, to instantiate it in one of these
languages or give it to any simulator or synthesis tool. There is no logic
overhead, hierarchy and names are preserved, and it runs design checks during
generation.</p></li>
<li><p>Boot a simulation using Verilator or another supported simulator.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/SpinalDevFlow.png"><img alt="_images/SpinalDevFlow.png" class="align-center" src="_images/SpinalDevFlow.png" style="height: 16em;" /></a>
<p>As SpinalHDL is interoperable with VHDL and (System)Verilog, you can both
instantiate SpinalHDL IPs in these language (using generated code) and
instantiate IPs in these languages in SpinalHDL (using <code class="docutils literal notranslate"><span class="pre">BlackBox</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SpinalHDL is <em>fully interoperable</em> with standard VHDL/Verilog-based EDA tools
(simulators and synthesizers) as the output generated by the toolchain can be
VHDL or Verilog.</p>
</div>
</section>
<section id="advantages-of-using-spinalhdl-over-vhdl-verilog">
<h4>Advantages of using SpinalHDL over VHDL / Verilog<a class="headerlink" href="#advantages-of-using-spinalhdl-over-vhdl-verilog" title="Permalink to this heading"></a></h4>
<p>As SpinalHDL is based on a high-level language, it provides several advantages to improve your hardware coding:</p>
<ol class="arabic simple">
<li><p><strong>No more endless wiring</strong> - Create and connect complex buses like AXI in one single line.</p></li>
<li><p><strong>Evolving capabilities</strong> - Create your own bus definitions and abstraction layers.</p></li>
<li><p><strong>Reduce code size</strong> - By a high factor, especially for wiring. This enables you to have a better overview of your code base, increase your productivity and create fewer headaches.</p></li>
<li><p><strong>Free and user friendly IDE</strong> - Thanks to Scala tools for auto-completion, error highlighting, navigation shortcuts, and many others.</p></li>
<li><p><strong>Powerful and easy type conversions</strong> - Bidirectional translation between any data type and bits. Useful when loading a complex data structure from a CPU interface.</p></li>
<li><p><strong>Design checks</strong> - Early stage lints to check that there are eg no combinatorial loops / latches.</p></li>
<li><p><strong>Clock domain safety</strong> - Early stage lints to inform you that there are no unintentional clock domain crossings.</p></li>
<li><p><strong>Generic design</strong> - There are no restrictions to the genericity of your hardware description by using Scala constructs.</p></li>
</ol>
</section>
</section>
<span id="document-SpinalHDL/Introduction/A simple example"></span><section id="a-simple-example">
<span id="simple-example"></span><h3>A simple example<a class="headerlink" href="#a-simple-example" title="Permalink to this heading"></a></h3>
<p>Below is a simple hardware description from the <a class="reference external" href="https://github.com/SpinalHDL/SpinalTemplateSbt">getting started</a> repository.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cond0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cond1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">flag</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">cond0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">flag</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cond1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It is split into chunks and explained in this section.</p>
<section id="component">
<h4>Component<a class="headerlink" href="#component" title="Permalink to this heading"></a></h4>
<p>First, there is the structure of a SpinalHDL <code class="docutils literal notranslate"><span class="pre">Component</span></code>.</p>
<p>A component is a piece of logic which can be instantiated (pasted) as many times
as needed, and where the only accessible signals are its inputs and outputs.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// port definitions go here</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// component logic goes here</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MyTopLevel</span></code> is the name of the component.</p>
<p>In SpinalHDL, components use <code class="docutils literal notranslate"><span class="pre">UpperCamelCase</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See also <a class="reference internal" href="index.html#component"><span class="std std-ref">Components and hierarchy</span></a> for more information.</p>
</div>
</section>
<section id="ports">
<h4>Ports<a class="headerlink" href="#ports" title="Permalink to this heading"></a></h4>
<p>Then, the ports are defined.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cond0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">cond1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Directions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cond0</span></code> and <code class="docutils literal notranslate"><span class="pre">cond1</span></code> are inputs ports</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flag</span></code> and <code class="docutils literal notranslate"><span class="pre">state</span></code> are outputs ports</p></li>
</ul>
<p>Types:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cond0</span></code>, <code class="docutils literal notranslate"><span class="pre">cond1</span></code> and <code class="docutils literal notranslate"><span class="pre">flag</span></code> are 1 bit each (as 3 individual signals)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">state</span></code> is an 8-bit unsigned integer (a bus of 8 signals representing an
unsigned integer)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This syntax is only available since SpinalHDL 1.8, see <a class="reference internal" href="index.html#io"><span class="std std-ref">Input / output definition</span></a> for legacy
syntax and more information.</p>
</div>
</section>
<section id="internal-logic">
<h4>Internal logic<a class="headerlink" href="#internal-logic" title="Permalink to this heading"></a></h4>
<p>Finally, there is the component logic:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">cond0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">flag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cond1</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">counter</span></code> is a register containing an 8-bits unsigned integer, with the
initial value 0. Assignments to change the state of a register are available for read-back only
after the next clock sampling.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because of the presence of a register, two implicit signals are added to the
component for the clock and the reset. See <a class="reference internal" href="index.html#reg"><span class="std std-ref">Registers</span></a> and <a class="reference internal" href="index.html#clock-domain"><span class="std std-ref">Clock domains</span></a>
for more information.</p>
</div>
<p>Then a conditional rule is described: when the input <code class="docutils literal notranslate"><span class="pre">cond0</span></code> (which is in the
<code class="docutils literal notranslate"><span class="pre">io</span></code> bundle) is set, the <code class="docutils literal notranslate"><span class="pre">counter</span></code> is incremented by one, else <code class="docutils literal notranslate"><span class="pre">counter</span></code>
keeps its value set in the last rule. But, there is no previous rule, you would
say. With a simple signal it would be a latch, and trigger an error. But here
<code class="docutils literal notranslate"><span class="pre">counter</span></code> is a register, so it has a default case: it just keeps the same
value.</p>
<p>This creates a multiplexer: the input of the <code class="docutils literal notranslate"><span class="pre">counter</span></code> register can be its
output or its output plus one depending on <code class="docutils literal notranslate"><span class="pre">io.cond0</span></code>.</p>
<p>Then unconditional rules (assignments) are described:</p>
<ul class="simple">
<li><p>The output <code class="docutils literal notranslate"><span class="pre">state</span></code> is connected to the output of the register <code class="docutils literal notranslate"><span class="pre">counter</span></code>.</p></li>
<li><p>The output <code class="docutils literal notranslate"><span class="pre">flag</span></code> is the output of an <code class="docutils literal notranslate"><span class="pre">or</span></code> gate between a signal which is
true when the output of “<code class="docutils literal notranslate"><span class="pre">counter</span></code> equals 0”, and the input <code class="docutils literal notranslate"><span class="pre">cond1</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See also <a class="reference internal" href="index.html#semantics"><span class="std std-ref">Semantic</span></a> for more information.</p>
</div>
</section>
</section>
<span id="document-SpinalHDL/Introduction/Projects using SpinalHDL"></span><section id="projects-using-spinalhdl">
<h3>Projects using SpinalHDL<a class="headerlink" href="#projects-using-spinalhdl" title="Permalink to this heading"></a></h3>
<p>Note that the following lists are very incomplete.</p>
<section id="repositories">
<span id="users-repositories"></span><h4>Repositories<a class="headerlink" href="#repositories" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/SteffenReith/J1Sc">J1Sc Stack CPU</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/VexRiscv">VexRiscv CPU and SoC</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/NaxRiscv">NaxRiscv CPU</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/digilent/ArtyA7SmpLinux">SaxonSoc</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/VexiiRiscv">VexiiRiscv CPU</a></p></li>
<li><p><a class="reference external" href="https://github.com/datenlord/open-rdma">open-rdma</a></p></li>
<li><p><a class="reference external" href="https://github.com/agra-uni-bremen/microrv32">MicroRV32 SoC</a></p></li>
<li><p>...</p></li>
</ul>
</section>
<section id="companies">
<h4>Companies<a class="headerlink" href="#companies" title="Permalink to this heading"></a></h4>
<ul>
<li><p><a class="reference external" href="https://datenlord.github.io/">DatenLord, China</a></p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/datenlord/open-rdma">RoCE v2 hardware implementation</a></p></li>
<li><p><a class="reference external" href="https://github.com/datenlord/wavebpf">WaveBPF</a> (wBPF): a
“tightly-coupled multi-core” eBPF CPU, designed to be a high-throughput
coprocessor for processing in-memory data (e.g. network packets).</p></li>
</ul>
</div></blockquote>
</li>
<li><p><a class="reference external" href="https://elitestek.com/product/RISC_V/">Elitestek (FPGA Vendor), China</a></p>
<blockquote>
<div><p>“Elitestek has used the VexRISC-V core in FPGAs and applied in multi
applications in worldwide customers.”</p>
</div></blockquote>
</li>
<li><p><a class="reference external" href="https://www.leaflabs.com">LeafLabs, Massachusetts, USA</a></p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/files/10219043/SpinalHDL.To.Accelerate.Neuro.pdf">SpinalHDL To Accelerate Neuroscience (PDF slideshow)</a></p>
</div></blockquote>
</li>
<li><p>QsPin, Belgium</p></li>
<li><p><a class="reference external" href="https://www.tiempo-secure.com/">Tiempo Secure, France</a></p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/files/10239051/SpinalHDL.for.ASIC.pdf">SpinalHDL for ASIC (PDF slideshow)</a></p>
</div></blockquote>
</li>
<li><p>...</p></li>
</ul>
</section>
<section id="universities">
<h4>Universities<a class="headerlink" href="#universities" title="Permalink to this heading"></a></h4>
<ul>
<li><p><a class="reference external" href="http://www.informatik.uni-bremen.de/agra/ger/index.php">Universität Bremen - Fachbereich 3 - Informatik, Germany</a></p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/files/10244833/20221216_summit_saahm.pdf">SpinalHDL in Computer Architecture Research and Education (PDF slideshow)</a></p>
</div></blockquote>
</li>
<li><p><a class="reference external" href="https://www.uni-potsdam.de/en/aess/">Universität Potsdam - Embedded Systems Architectures for Signalprocessing,
Germany</a></p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/files/10238707/A_Network_Attached_Deep_Learning_Accelerator_for_FPGA_Clusters.pdf">A Network Attached Deep Learning Accelerator for FPGA Clusters (PDF
slideshow)</a></p>
</div></blockquote>
</li>
<li><p>...</p></li>
</ul>
</section>
</section>
<span id="document-SpinalHDL/Introduction/Getting in touch"></span><section id="getting-in-touch">
<h3>Getting in touch<a class="headerlink" href="#getting-in-touch" title="Permalink to this heading"></a></h3>
<ul>
<li><p>For questions about SpinalHDL syntax and live talks:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://gitter.im/SpinalHDL/SpinalHDL">English Matrix channel</a></p></li>
<li><p><a class="reference external" href="https://gitter.im/SpinalHDL-CN/Community">Chinese Matrix channel</a></p></li>
<li><p><a class="reference external" href="https://groups.google.com/forum/#!forum/spinalhdl-hardware-description-language">Google group</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p>For bug reports, feature requests and questions:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/issues/new">Open a ticket</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p>If you are interested in a presentation, a workshop, or consulting:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="mailto:spinalhdl&#37;&#52;&#48;gmail&#46;com">Contact us by email: spinalhdl<span>&#64;</span>gmail<span>&#46;</span>com</a></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<span id="document-SpinalHDL/Introduction/License"></span><section id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this heading"></a></h3>
<p>SpinalHDL uses two licenses, one for <code class="docutils literal notranslate"><span class="pre">spinal.core</span></code> and one for <code class="docutils literal notranslate"><span class="pre">spinal.lib</span></code>
and everything else in the repository.</p>
<p><code class="docutils literal notranslate"><span class="pre">spinal.core</span></code> (the compiler) is under the LGPL license, which can be
summarized as follows:</p>
<ul class="simple">
<li><p>You can make money with your SpinalHDL description and its generated RTL.</p></li>
<li><p>You don’t have to share your SpinalHDL description and its generated RTL.</p></li>
<li><p>There are no fees and no royalties.</p></li>
<li><p>If your make improvements to the SpinalHDL core, and you wish to
redistribute those modifications, you have to share those modifications
to make the tool better for everybody.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">spinal.lib</span></code> (a general purpose library of components/tools/interfaces) is
under the permissive MIT license so you do not have to share it, even if
contributions are really appreciated.</p>
</section>
<span id="document-SpinalHDL/Introduction/Contributing"></span><section id="contributing">
<h3>Contributing<a class="headerlink" href="#contributing" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL">Repository of the language</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/dev/CONTRIBUTING.md">Contributor guide</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalDoc-RTD">Repository of this documentation</a></p></li>
<li><p><a class="reference external" href="https://opencollective.com/spinalhdl">Donation channel</a></p></li>
</ul>
</section>
<span id="document-SpinalHDL/Introduction/faq"></span><section id="faq">
<h3>FAQ<a class="headerlink" href="#faq" title="Permalink to this heading"></a></h3>
<section id="what-is-the-overhead-of-spinalhdl-generated-rtl-compared-to-human-written-vhdl-verilog">
<h4>What is the overhead of SpinalHDL generated RTL compared to human written VHDL/Verilog?<a class="headerlink" href="#what-is-the-overhead-of-spinalhdl-generated-rtl-compared-to-human-written-vhdl-verilog" title="Permalink to this heading"></a></h4>
<p>The overhead is nil.  SpinalHDL generates the same HDL constructs found in
human written VHDL/Verilog with no additional instantiated artifacts present
in the resulting implementation due to its use.  This makes the overhead
zero when comparing the generated HDL against handwritten HDL.</p>
<p>Due to the powerful expressive nature of the Scala/SpinalHDL languages, the
design is more concise for a given complex hardware design and has strong type safety,
strong HDL safety paradigms that result in fewer lines of code, able to achieve more
functionality with fewer bugs.</p>
<p>SpinalHDL does not take a HLS approach and is not itself a HLS solution. Its goal is not
to translate any arbitrary code into RTL, but to provide a powerful language to describe RTL
and raise the abstraction level and increase code reuse at the level the designer is working.</p>
</section>
<section id="what-if-spinalhdl-becomes-unsupported-in-the-future">
<h4>What if SpinalHDL becomes unsupported in the future?<a class="headerlink" href="#what-if-spinalhdl-becomes-unsupported-in-the-future" title="Permalink to this heading"></a></h4>
<p>This question has two sides:</p>
<ol class="arabic simple">
<li><p>SpinalHDL generates VHDL/Verilog files, which means that SpinalHDL will be supported by all EDA tools for many decades.</p></li>
<li><p>If there is a bug in SpinalHDL and there is no longer support to fix it, it’s not a deadly situation,
because the SpinalHDL compiler is fully open source.  For simple issues, you may be able to fix the issue
yourself within a few hours.</p></li>
<li><p>Consider how much time it takes for a commercial EDA vendor to fix issues or to add new features in their closed tools.
Consider also your cost and time savings achieved when using SpinalHDL and the potential for your own entity to give back
to the community some of this as engineering time, open-source contribution time or donations to the project to improve
its future.</p></li>
</ol>
</section>
<section id="does-spinalhdl-keep-comments-in-generated-vhdl-verilog">
<h4>Does SpinalHDL keep comments in generated VHDL/verilog?<a class="headerlink" href="#does-spinalhdl-keep-comments-in-generated-vhdl-verilog" title="Permalink to this heading"></a></h4>
<p>No, it doesn’t. Generated files should be considered as a netlist. For example, when you compile C code, do you care about
your comments in the generated assembly code?</p>
</section>
<section id="could-spinalhdl-scale-up-to-big-projects">
<h4>Could SpinalHDL scale up to big projects?<a class="headerlink" href="#could-spinalhdl-scale-up-to-big-projects" title="Permalink to this heading"></a></h4>
<p>Yes, some experiments were done, and it appears that generating hundreds of 3KLUT CPUs with caches takes around 12 seconds,
which is a ridiculously short time compared to the time required to simulate or synthesize this kind of design.</p>
</section>
<section id="how-spinalhdl-came-to-be">
<h4>How SpinalHDL came to be<a class="headerlink" href="#how-spinalhdl-came-to-be" title="Permalink to this heading"></a></h4>
<p>Between December 2014 and April 2016, it was as a personal hobby project.  But since April 2016 one person is working full
time on it. Some people are also regularly contributing to the project.</p>
</section>
<section id="why-develop-a-new-language-when-there-is-vhdl-verilog-systemverilog">
<h4>Why develop a new language when there is VHDL/Verilog/SystemVerilog?<a class="headerlink" href="#why-develop-a-new-language-when-there-is-vhdl-verilog-systemverilog" title="Permalink to this heading"></a></h4>
<p>The <a class="reference internal" href="index.html#foreword"><span class="std std-ref">Foreword</span></a> is dedicated to this topic.</p>
</section>
<section id="how-to-use-an-unreleased-version-of-spinalhdl-but-committed-on-git">
<h4>How to use an unreleased version of SpinalHDL (but committed on git)?<a class="headerlink" href="#how-to-use-an-unreleased-version-of-spinalhdl-but-committed-on-git" title="Permalink to this heading"></a></h4>
<p>First, you need to get the repository, if you haven’t cloned it yet:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git clone --depth <span class="m">1</span> -b dev https://github.com/SpinalHDL/SpinalHDL.git
<span class="nb">cd</span> SpinalHDL
</pre></div>
</div>
<p>In the command above you can replace <code class="docutils literal notranslate"><span class="pre">dev</span></code> by the name of the branch you want
to checkout. <code class="docutils literal notranslate"><span class="pre">--depth</span> <span class="pre">1</span></code> prevents from downloading the repository history.</p>
<p>Then publish the code as it is in the directory fetched:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sbt clean <span class="s1">&#39;++ 2.12.13&#39;</span> publishLocal
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">2.12.13</span></code> is the Scala version used. The first two numbers must match the
ones of the version used in your project. You can find it in your <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>
and/or <code class="docutils literal notranslate"><span class="pre">build.sc</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalaVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;2.12.16&quot;</span><span class="w"> </span><span class="c1">// in build.sbt</span>
<span class="c1">// or</span>
<span class="k">def</span><span class="w"> </span><span class="nf">scalaVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2.12.16&quot;</span><span class="w"> </span><span class="c1">// in build.sc</span>
</pre></div>
</div>
<p>Then in your project, update the SpinalHDL version specified in your
<code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> or <code class="docutils literal notranslate"><span class="pre">build.sc</span></code>: it should be set to <code class="docutils literal notranslate"><span class="pre">dev</span></code> instead of a version
number.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">spinalVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1.7.3&quot;</span><span class="w"></span>
<span class="c1">// becomes</span>
<span class="kd">val</span><span class="w"> </span><span class="n">spinalVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dev&quot;</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here it is always <code class="docutils literal notranslate"><span class="pre">dev</span></code> no matter the branch you have checked out earlier.</p>
</div>
</section>
</section>
<span id="document-SpinalHDL/Introduction/Other learning materials"></span><section id="other-learning-materials">
<h3>Other learning materials<a class="headerlink" href="#other-learning-materials" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://cdn.jsdelivr.net/gh/SpinalHDL/SpinalDoc&#64;master/presentation/en/motivation.pdf">A short show case (PDF slideshow)</a></p></li>
<li><p><a class="reference external" href="https://cdn.jsdelivr.net/gh/SpinalHDL/SpinalDoc&#64;master/presentation/en/presentation.pdf">Presentation of the language (PDF slideshow)</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/Spinal-bootcamp">Jupyter bootcamp</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SpinalWorkshop">Workshop</a></p></li>
</ul>
<p>There is also a few more specific videos online :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/results?search_query=SpinalHDL">On youtube</a></p></li>
<li><p><a class="reference external" href="https://peertube.f-si.org/search?search=SpinalHDL">On f-si’s peertube</a></p></li>
</ul>
<p>A few SpinalHDL webinar were made and are recorded here :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/&#64;datenlord">Datenlord’s youtube channel</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some of those tutorials are not using the latest version of SpinalHDL, so
they may lack some recent SpinalHDL features.</p>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/Getting Started/index"></span><section id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this heading"></a></h2>
<p>Let’s start learning SpinalHDL! In this chapter, we will install and setup an
environment, taste the language and learn how to generate VHDL and Verilog, and
perform lints on the fly.</p>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Getting Started/Install and setup"></span><section id="install-and-setup">
<span id="install"></span><h3>Install and setup<a class="headerlink" href="#install-and-setup" title="Permalink to this heading"></a></h3>
<p>Spinal is a Scala library (a programming language using the Java VM) so it
requires setting up a Scala environment; there are many ways to do so.
Also, it generates VHDL, Verilog or SystemVerilog, which can be used by many
different tools. This section describes the supported way to install a
<em>SpinalHDL description to Simulation</em> flow, but there can be many variations.</p>
<section id="required-recommended-tools">
<h4>Required/Recommended tools<a class="headerlink" href="#required-recommended-tools" title="Permalink to this heading"></a></h4>
<p>Before you download the SpinalHDL tools, you need to install a Scala environment:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.oracle.com/java/technologies/downloads/">Java JDK</a>, a Java
environment</p></li>
<li><p><a class="reference external" href="https://www.scala-lang.org/">Scala 2</a>, compiler and library</p></li>
<li><p><a class="reference external" href="https://www.scala-sbt.org/download/">SBT</a>, a Scala build tool</p></li>
</ul>
<p>These tools enable to use Spinal; but without any other tools, it is limited to
HDL code generation.</p>
<p>To enable more features we recommend:</p>
<ul>
<li><p>An IDE (for instance the currently recommended <a class="reference external" href="https://www.jetbrains.com/idea/">IntelliJ</a>
with its Scala plugin or <a class="reference external" href="https://vscodium.com/">VSCodium</a> with Metals extension) to
get features such as:</p>
<blockquote>
<div><ul class="simple">
<li><p>Code suggestions / completion</p></li>
<li><p>Automatic build with syntax errors right in the code</p></li>
<li><p>Generate code with a single click</p></li>
<li><p>Run simulation / tests with a single click (if a supported simulator is
set up)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>A supported simulator like <a class="reference external" href="https://www.veripool.org/verilator/">Verilator</a>
to test the design right from SpinalHDL.</p></li>
<li><p><a class="reference external" href="https://gtkwave.sourceforge.net/">Gtkwave</a> to view the waves generated by
Verilator during simulation.</p></li>
<li><p><a class="reference external" href="https://git-scm.com/">Git</a> for version control system</p></li>
<li><p>A C++ toolchain, needed for simulating with Verilator</p></li>
<li><p>A linux shell, needed for simulating with Verilator</p></li>
</ul>
</section>
<section id="linux-installation">
<h4>Linux Installation<a class="headerlink" href="#linux-installation" title="Permalink to this heading"></a></h4>
<p>At time of writing the recommended way of installing Scala and SBT is via <a class="reference external" href="https://get-coursier.io/docs/cli-installation">Coursier</a>.
Coursier is able to in addition to the scala tools install a Java JDK to use, in the
example below we install Java from the package manager. We recommend to install JDK 17 (LTS)
because of compatibility with the used Scala version.</p>
<p>For Debian or Ubuntu we run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install openjdk-17-jdk-headless curl git
curl -fL <span class="s2">&quot;https://github.com/coursier/launchers/raw/master/cs-x86_64-pc-linux.gz&quot;</span> <span class="p">|</span> gzip -d &gt; cs
chmod +x cs
<span class="c1"># should find the just installed jdk, agree to cs&#39; questions for adding to your PATH</span>
./cs setup
<span class="nb">source</span> ~/.profile
</pre></div>
</div>
<p>If you want to install the tools for simulation and/or formal proofs, we recommend <a class="reference external" href="https://github.com/YosysHQ/oss-cad-suite-build">oss-cad-suite</a>.
It contains a waveform viewer (gtkWave), verilog simulators (verilator and iverilog), VHDL simulator (GHDL) and other tools.
In case you want to build the tools yourself have a look at the legacy simulation tool <a class="reference internal" href="index.html#sim-backend-install"><span class="std std-ref">installation instructions</span></a>.</p>
<p>We first install the needed C++ toolchain and download oss-cad-suite. To use it we must load the oss-cad-suite
environment for each shell we want to use it in. Note that oss-cad-suite contains a Python 3 interpreter that
may interfere with the system Python installation if loaded permanently.</p>
<p>Go to the oss-cad-suite <a class="reference external" href="https://github.com/YosysHQ/oss-cad-suite-build/releases/latest">release page</a> to get the
download link for the latest version. You can download/extract oss-cad-suite to a folder of your choice.
(last tested version of oss-cad-suite is <cite>2023-10-22</cite>, but more recent ones will most likely also work)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get install make gcc g++ zlib1g-dev
curl -fLO &lt;download link&gt;
tar xzf &lt;file that you downloaded&gt;
</pre></div>
</div>
<p>To use oss-cad-suite in a shell you need to load it’s environment, e.g. via <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">&lt;path</span> <span class="pre">to</span> <span class="pre">oss-cad-suite&gt;/environment</span></code>.</p>
</section>
<section id="mac-os-x-installation">
<h4>Mac OS X Installation<a class="headerlink" href="#mac-os-x-installation" title="Permalink to this heading"></a></h4>
<p>You can use homebrew to install on Mac OS X.  By default homebrew installs Java 21, but the  SpinalHDL tutorial
SpinalTemplateSbt uses Scala version 2.12.16, which is not supported by Java 21 (17 is still the recommended LTS version,
<a class="reference external" href="https://whichjdk.com/">https://whichjdk.com/</a>). So to install Java version 1.7 do:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>brew install openjdk@17
</pre></div>
</div>
<p>And then add this to your path.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/opt/homebrew/opt/openjdk@17/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>To manage multiple versions of Java it is also essential to have jenv installed.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>brew install jenv
</pre></div>
</div>
<p>Jenv added these lines to my .bash_profile</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.jenv/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>jenv init -<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Next you have to install scala’s interactive build tool sbt.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>brew install sbt
</pre></div>
</div>
<p>If this works for you, please let us know.  If this does not work for you, you can read the github issue about Mac o SX installation here.
<a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/issues/1216">https://github.com/SpinalHDL/SpinalHDL/issues/1216</a></p>
<p>If you want to install the tools for simulation and/or formal proofs, we recommend <a class="reference external" href="https://github.com/YosysHQ/oss-cad-suite-build">oss-cad-suite</a>.</p>
</section>
<section id="windows-installation">
<h4>Windows installation<a class="headerlink" href="#windows-installation" title="Permalink to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While a native installation is possible the simpler and currently recommended way is to use WSL on Windows.
If you want to use WSL, install <a class="reference external" href="https://learn.microsoft.com/en-us/windows/wsl/install">it</a>, a distribution of your choice and
follow the Linux installation instructions. Data in your WSL instance can be accessed from windows under <code class="docutils literal notranslate"><span class="pre">\\wsl$</span></code>.
In case you want to use IntelliJ you’ll have to download the Linux version to WSL, if you want to use VSCode then the Windows
version can be used to remotely edit in WSL.</p>
</div>
<p>At time of writing the recommended way of installing Scala and SBT is via <a class="reference external" href="https://get-coursier.io/docs/cli-installation">Coursier</a>.
Coursier is able to in addition to the scala tools install a Java JDK to use, in the
example below we install Java manually. We recommend to install JDK 17 (LTS) because of
compatibility with Scala.</p>
<p>First download and install <a class="reference external" href="https://adoptium.net/temurin/releases/?os=windows&amp;version=17">Adoptium JDK 17</a>.
Download, unzip and run the <a class="reference external" href="https://github.com/coursier/launchers/raw/master/cs-x86_64-pc-win32.zip">Coursier installer</a>,
when asked agree to an update of your <code class="docutils literal notranslate"><span class="pre">PATH</span></code> variable. Reboot to force an update of <code class="docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
<p>This is sufficient for generating hardware. For simulation continue with either choice below.
In case you want to build the tools yourself have a look at the legacy simulation tool <a class="reference internal" href="index.html#sim-backend-install"><span class="std std-ref">installation instructions</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An All-in-One solution offered by SpinalHDL maintainer <a class="reference external" href="https://github.com/Readon">Readon</a> is available to install and run SpinalHDL with Verilator simulation and formal verification via SymbiYosys.
Download <a class="reference external" href="https://github.com/Readon/msys2-installer/releases">it</a> and install the environment anywhere on your disk.
Start the build environment by clicking on the MSYS2-MINGW64 icon in the Start menu and use the MSYS2 default console.
An alternative is to use the Windows Terminal or a Tabby-like application and use the startup command <code class="docutils literal notranslate"><span class="pre">%MSYS2_ROOT%\msys2_shell.cmd</span> <span class="pre">-defterm</span> <span class="pre">-here</span> <span class="pre">-no-start</span> <span class="pre">-mingw64</span></code>, where the <code class="docutils literal notranslate"><span class="pre">%MSYS2_ROOT%</span></code> is the location of the msys2 installation.
It is worth noting that if you want to use it offline, you should carefully select the libraries that the project depends on, otherwise you will need to download the packages manually.
See the README for the repos for more details.</p>
</div>
<section id="msys2-verilator-for-simulation">
<h5>MSYS2 verilator for simulation<a class="headerlink" href="#msys2-verilator-for-simulation" title="Permalink to this heading"></a></h5>
<p>We recommend to install compiler/verilator through <a class="reference external" href="https://www.msys2.org">MSYS2</a>.
Other methods of installing gcc/make/shell (e.g. chocolatey, scoop, etc.) may also work but are untested.</p>
<p>SpinalHDL maintainer <a class="reference external" href="https://github.com/Readon">Readon</a> is maintaining a MSYS2 fork that default
installs all needed officially available and custom built packages (also maintained by Readon <a class="reference external" href="https://github.com/Readon/MINGW-SpinalHDL">here</a>)
for simulation and formal verification. It can be found <a class="reference external" href="https://github.com/Readon/msys2-installer">here</a>.
If used then the packages installed below via <code class="docutils literal notranslate"><span class="pre">pacman</span></code> are already installed and those
installation steps can be skipped.</p>
<p>Currently verilator 4.228 is latest available version known to work.</p>
<p>Download the latest installer and install MSYS2 with default settings. You should get a MSYS2 terminal at
the end of the installation, there run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -Syuu
<span class="c1"># will (request) close down terminal</span>
<span class="c1"># open &#39;MSYS2 MINGW64&#39; from start menu</span>
pacman -Syuu
pacman -S --needed base-devel mingw-w64-x86_64-toolchain mingw-w64-x86_64-iverilog mingw-w64-x86_64-ghdl-llvm git
curl -O https://repo.msys2.org/mingw/mingw64/mingw-w64-x86_64-verilator-4.228-1-any.pkg.tar.zst
pacman -U mingw-w64-x86_64-verilator-4.228-1-any.pkg.tar.zst
</pre></div>
</div>
<p>In a MSYS2 MINGW64 terminal we need to set some environment variables to make Java/sbt available (you can make these
settings persistent by adding them to <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> in MSYS2):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">VERILATOR_ROOT</span><span class="o">=</span>/mingw64/share/verilator/
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/c/Program<span class="se">\ </span>Files/Eclipse<span class="se">\ </span>Adoptium/jdk-17.0.8.101-hotspot/bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/c/Users/User/AppData/Local/Coursier/data/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>With this you should be able to run sbt/verilator simulations from MSYS2 terminals (sbt via calling <code class="docutils literal notranslate"><span class="pre">sbt.bat</span></code>).</p>
</section>
<section id="msys2-for-formal-verification">
<h5>MSYS2 for formal verification<a class="headerlink" href="#msys2-for-formal-verification" title="Permalink to this heading"></a></h5>
<p>In addition to the steps above we also need to install yosys, sby, z3 and yices. Both yosys(yosys-smtbmc workable) and sby are
not available as official MSYS2 packages, but packages are provided by <a class="reference external" href="https://github.com/Readon">Readon</a>.
If you used their installer then these steps are not needed (you should check if there are newer packages available).</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -S mingw-w64-x86_64-z3 mingw-w64-x86_64-yices mingw-w64-x86_64-autotools mingw-w64-x86_64-python3-pip
python3 -m pip install click
curl -OL https://github.com/Readon/MINGW-SpinalHDL/releases/download/v0.4.9/mingw-w64-x86_64-yosys-0.31-1-any.pkg.tar.zst
curl -OL https://github.com/Readon/MINGW-SpinalHDL/releases/download/v0.4.9/mingw-w64-x86_64-python-sby-0.31-1-any.pkg.tar.zst
pacman -U *-yosys-*.pkg.tar.*
pacman -U *-python-sby-*.pkg.tar*
</pre></div>
</div>
</section>
</section>
<section id="oci-container">
<h4>OCI Container<a class="headerlink" href="#oci-container" title="Permalink to this heading"></a></h4>
<p>A container for SpinalHDL development is available as well.
The container is hosted at <code class="docutils literal notranslate"><span class="pre">ghcr.io/spinalhdl/docker:master</span></code> and can be used with Docker/Podman/Github Codespaces.
It is used for the SpinalHDL CI regression and can therefore be an easy way to run the CI commands locally.</p>
<p>To run the container run e.g. <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">run</span> <span class="pre">-v</span> <span class="pre">.:/workspace</span> <span class="pre">-it</span> <span class="pre">ghcr.io/spinalhdl/docker:master</span></code> in a SpinalHDL project
root directory, making the project directory available in <code class="docutils literal notranslate"><span class="pre">/workspace</span></code>.</p>
<p>Please consult the documentation of you Distribution (Linux, WSL) or Docker (Windows) on how to install the container
runtime you want to use. Multiple editors/IDEs (e.g. VSCode, IntelliJ, Neovide) allow for remote development in a container.
Please consult the documentation of the editor on how to do remote development.</p>
</section>
<section id="installing-sbt-in-an-internet-free-linux-environment">
<h4>Installing SBT in an internet-free Linux environment<a class="headerlink" href="#installing-sbt-in-an-internet-free-linux-environment" title="Permalink to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are not using an air-gapped environment we recommend to
go with the normal linux installation. (which is a subset of the
installation for an air-gapped environment)</p>
</div>
<p>Normally, SBT uses online repositories to download and cache your projects
dependencies. This cache is located in several folders:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">~/.sbt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">~/.cache/JNA</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">~/.cache/coursier</span></code></p></li>
</ul>
<p>To set up an internet-free environment, you can:</p>
<ol class="arabic simple">
<li><p>Set up an environment with internet (see above)</p></li>
<li><p>Launch a Spinal command (see <a class="reference internal" href="index.html#using-sbt"><span class="std std-ref">Using Spinal from CLI with SBT</span></a>) to fetch dependencies (for
instance using the <a class="reference external" href="https://github.com/SpinalHDL/SpinalTemplateSbt">getting started</a> repository)</p></li>
<li><p>Copy the caches to the internet-free environment.</p></li>
</ol>
</section>
</section>
<section id="create-a-first-spinalhdl-project">
<span id="template"></span><h3>Create a first SpinalHDL project<a class="headerlink" href="#create-a-first-spinalhdl-project" title="Permalink to this heading"></a></h3>
<p>We have prepared a ready-to-go project for you the: <a class="reference external" href="https://github.com/SpinalHDL/SpinalTemplateSbt">getting started</a> repository.</p>
<p>You can <a class="reference external" href="https://codeload.github.com/SpinalHDL/SpinalTemplateSbt/zip/master">download</a> it, or clone it.</p>
<p>The following commands clone the project into a new directory named
<code class="docutils literal notranslate"><span class="pre">MySpinalProject</span></code> and initialize a fresh <code class="docutils literal notranslate"><span class="pre">git</span></code> history:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git clone --depth <span class="m">1</span> https://github.com/SpinalHDL/SpinalTemplateSbt.git MySpinalProject
<span class="nb">cd</span> MySpinalProject
rm -rf .git
git init
git add .
git commit -m <span class="s2">&quot;Initial commit from template&quot;</span>
</pre></div>
</div>
<section id="the-directory-structure-of-a-project">
<h4>The directory structure of a project<a class="headerlink" href="#the-directory-structure-of-a-project" title="Permalink to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The structure described here is the default structure, but it can be easily
modified.</p>
</div>
<p>In the root of the project are the following files:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">build.sbt</span></code></p></td>
<td><p>Scala configuration for <code class="docutils literal notranslate"><span class="pre">sbt</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">build.sc</span></code></p></td>
<td><p>Scala configuration for <code class="docutils literal notranslate"><span class="pre">mill</span></code>, an alternative to <code class="docutils literal notranslate"><span class="pre">sbt</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hw/</span></code></p></td>
<td><p>The folder containing hardware descriptions</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">project/</span></code></p></td>
<td><p>More Scala configuration</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">README.md</span></code></p></td>
<td><p>A <code class="docutils literal notranslate"><span class="pre">text/markdown</span></code> file describing your project</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">.gitignore</span></code></p></td>
<td><p>List of files to ignore in versioning</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">.mill-version</span></code></p></td>
<td><p>More configuration for <code class="docutils literal notranslate"><span class="pre">mill</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">.scalafmt.conf</span></code></p></td>
<td><p>Configuration of rules to auto-format the code</p></td>
</tr>
</tbody>
</table>
<p>As you probably guessed it, the interesting thing here is <code class="docutils literal notranslate"><span class="pre">hw/</span></code>. It contains
four folders: <code class="docutils literal notranslate"><span class="pre">spinal/</span></code>, <code class="docutils literal notranslate"><span class="pre">verilog/</span></code> and <code class="docutils literal notranslate"><span class="pre">vhdl/</span></code> for your IPs and <code class="docutils literal notranslate"><span class="pre">gen/</span></code>
for IPs generated with Spinal.</p>
<p><code class="docutils literal notranslate"><span class="pre">hw/spinal/</span></code> contains a folder named after your project name. This name must
be set in <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> (along with the company name) and in <code class="docutils literal notranslate"><span class="pre">build.sc</span></code>; and
it must be the one in <code class="docutils literal notranslate"><span class="pre">package</span> <span class="pre">yourprojectname</span></code> at the beginning of <code class="docutils literal notranslate"><span class="pre">.scala</span></code>
files.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">hw/spinal/yourprojectname/</span></code>, are the descriptions of your IPs, simulation
tests, formal tests; and there is <code class="docutils literal notranslate"><span class="pre">Config.scala</span></code>, which contains the
configuration of <code class="docutils literal notranslate"><span class="pre">Spinal</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">sbt</span></code> must be used <strong>only</strong> at the root of the project, in the folder
containing <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>.</p>
</div>
</section>
<section id="using-spinal-on-spinalhdl-code">
<h4>Using Spinal on SpinalHDL code<a class="headerlink" href="#using-spinal-on-spinalhdl-code" title="Permalink to this heading"></a></h4>
<p>Now the tutorial shows how to use Spinal on SpinalHDL code depending on your
development environment:</p>
<ul class="simple">
<li><p><a class="reference internal" href="index.html#using-sbt"><span class="std std-ref">Using Spinal from CLI with SBT</span></a></p></li>
<li><p><a class="reference internal" href="index.html#using-vscodium"><span class="std std-ref">Using Spinal from VSCodium</span></a></p></li>
<li><p><a class="reference internal" href="index.html#using-intellij"><span class="std std-ref">Using Spinal from IntelliJ IDEA</span></a></p></li>
</ul>
</section>
</section>
<span id="document-SpinalHDL/Getting Started/SBT"></span><section id="using-spinal-from-cli-with-sbt">
<span id="using-sbt"></span><h3>Using Spinal from CLI with SBT<a class="headerlink" href="#using-spinal-from-cli-with-sbt" title="Permalink to this heading"></a></h3>
<p>First, open a terminal in the root of the template you have downloaded earlier
in <a class="reference internal" href="index.html#template"><span class="std std-ref">Create a first SpinalHDL project</span></a>.</p>
<p>Commands can be executed right from the terminal:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sbt <span class="s2">&quot;firstCommand with arguments&quot;</span> <span class="s2">&quot;secondCommand with more arguments&quot;</span>
</pre></div>
</div>
<p>But <code class="docutils literal notranslate"><span class="pre">sbt</span></code> has a quite long boot time so the we recommend to use its
interactive mode:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sbt
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">sbt</span></code> shows a prompt. Let’s start by doing Scala compilation. It will
fetch dependencies so it can take time the first time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">compile</span>
</pre></div>
</div>
<p>Actually you never need to just <code class="docutils literal notranslate"><span class="pre">compile</span></code> as it is done automatically when
needed. The first build time will take a few moments longer compared to future builds
as the sbt tool builds the entire project from a cold start and then uses incremental
building where possible from that point on.  <code class="docutils literal notranslate"><span class="pre">sbt</span></code> supports autocompletion inside
the interactive shell to assist discovery and usage of the available commands.
You can start the interactive shell with <code class="docutils literal notranslate"><span class="pre">sbt</span> <span class="pre">shell</span></code> or running <code class="docutils literal notranslate"><span class="pre">sbt</span></code>
with no arguments from the command line.</p>
<p>To run a specific HDL code-generation or simulation, the command is <code class="docutils literal notranslate"><span class="pre">runMain</span></code>. So
if you type <code class="docutils literal notranslate"><span class="pre">runMain</span></code>, space, and tab, you should get this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbt</span><span class="p">:</span><span class="n">SpinalTemplateSbt</span><span class="o">&gt;</span> <span class="n">runMain</span>
   <span class="p">;</span>                               <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span>
   <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelFormal</span>    <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelVhdl</span>
   <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelSim</span>
</pre></div>
</div>
<p>The autocompletion suggests all things that can be run. Let’s run the Verilog
generation for instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runMain</span> <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span>
</pre></div>
</div>
<p>Look at the directory ./hw/gen/: there is a new <code class="docutils literal notranslate"><span class="pre">MyTopLevel.v</span></code> file!</p>
<p>Now add a <code class="docutils literal notranslate"><span class="pre">~</span></code> at the beginning of the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">~</span> <span class="n">runMain</span> <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span>
</pre></div>
</div>
<p>It prints this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">sbt</span><span class="p">:</span><span class="n">SpinalTemplateSbt</span><span class="o">&gt;</span> <span class="o">~</span> <span class="n">runMain</span> <span class="n">mylib</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">running</span> <span class="p">(</span><span class="n">fork</span><span class="p">)</span> <span class="n">mylib</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Runtime</span><span class="p">]</span> <span class="n">SpinalHDL</span> <span class="n">v1</span><span class="mf">.7.3</span>    <span class="n">git</span> <span class="n">head</span> <span class="p">:</span> <span class="n">aeaeece704fe43c766e0d36a93f2ecbb8a9f2003</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Runtime</span><span class="p">]</span> <span class="n">JVM</span> <span class="nb">max</span> <span class="n">memory</span> <span class="p">:</span> <span class="mi">3968</span><span class="p">,</span><span class="mi">0</span><span class="n">MiB</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Runtime</span><span class="p">]</span> <span class="n">Current</span> <span class="n">date</span> <span class="p">:</span> <span class="mf">2022.11.17</span> <span class="mi">21</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">10</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">running</span> <span class="p">(</span><span class="n">fork</span><span class="p">)</span> <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Runtime</span><span class="p">]</span> <span class="n">SpinalHDL</span> <span class="n">v1</span><span class="mf">.9.3</span>    <span class="n">git</span> <span class="n">head</span> <span class="p">:</span> <span class="mi">029104</span><span class="n">c77a54c53f1edda327a3bea333f7d65fd9</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Runtime</span><span class="p">]</span> <span class="n">JVM</span> <span class="nb">max</span> <span class="n">memory</span> <span class="p">:</span> <span class="mf">4096.0</span><span class="n">MiB</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Runtime</span><span class="p">]</span> <span class="n">Current</span> <span class="n">date</span> <span class="p">:</span> <span class="mf">2023.10.05</span> <span class="mi">19</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">19</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Progress</span><span class="p">]</span> <span class="n">at</span> <span class="mf">0.000</span> <span class="p">:</span> <span class="n">Elaborate</span> <span class="n">components</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Progress</span><span class="p">]</span> <span class="n">at</span> <span class="mf">0.508</span> <span class="p">:</span> <span class="n">Checks</span> <span class="ow">and</span> <span class="n">transforms</span>
 <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Progress</span><span class="p">]</span> <span class="n">at</span> <span class="mf">0.560</span> <span class="p">:</span> <span class="n">Generate</span> <span class="n">Verilog</span>
<span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="n">Done</span><span class="p">]</span> <span class="n">at</span> <span class="mf">0.603</span>
<span class="p">[</span><span class="n">success</span><span class="p">]</span> <span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mi">1</span> <span class="n">s</span><span class="p">,</span> <span class="n">completed</span> <span class="n">Oct</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2023</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">19</span> <span class="n">PM</span>
<span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="mf">1.</span> <span class="n">Monitoring</span> <span class="n">source</span> <span class="n">files</span> <span class="k">for</span> <span class="n">projectname</span><span class="o">/</span><span class="n">runMain</span> <span class="n">projectname</span><span class="o">.</span><span class="n">MyTopLevelVerilog</span><span class="o">...</span>
<span class="p">[</span><span class="n">info</span><span class="p">]</span>    <span class="n">Press</span> <span class="o">&lt;</span><span class="n">enter</span><span class="o">&gt;</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">options</span><span class="o">.</span>
</pre></div>
</div>
<p>So now, each time you save a source file, it will re-generate <code class="docutils literal notranslate"><span class="pre">MyTopLevel.v</span></code>.
To do this, it automatically compiles the source files and it performs lint
checks. This way you can get errors printed on the terminal almost in real-time
while you are editing the source files.</p>
<p>You can press Enter to stop automatic generation, then Ctrl-D to exit <code class="docutils literal notranslate"><span class="pre">sbt</span></code>.</p>
<p>It is also possible to start it right from the terminal, without using <code class="docutils literal notranslate"><span class="pre">sbt</span></code>’s
interactive prompt:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sbt <span class="s2">&quot;~ runMain mylib.MyTopLevelVerilog&quot;</span>
</pre></div>
</div>
<p>Now you can use your environment, let’s explore the code: <a class="reference internal" href="index.html#simple-example"><span class="std std-ref">A simple example</span></a>.</p>
</section>
<span id="document-SpinalHDL/Getting Started/VSCodium"></span><section id="using-spinal-from-vscodium">
<span id="using-vscodium"></span><h3>Using Spinal from VSCodium<a class="headerlink" href="#using-spinal-from-vscodium" title="Permalink to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://vscodium.com/">VSCodium</a> is the open source build of Visual Studio Code, but without the telemetry included in Microsoft’s downloadable version.</p>
</div>
<p>As a one-time setup task, go to view-&gt;extensions search for “Scala” and install the “Scala (Metals)” <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=scalameta.metals">extension</a>.</p>
<p>Open the workspace: <code class="docutils literal notranslate"><span class="pre">File</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">Open</span> <span class="pre">Folder...</span></code> and open the folder you have downloaded earlier in <a class="reference internal" href="index.html#template"><span class="std std-ref">Create a first SpinalHDL project</span></a>.</p>
<p>The other way to start it, is to cd into the appropriate directory and type <code class="docutils literal notranslate"><span class="pre">codium</span> <span class="pre">.</span></code></p>
<p>Wait a little bit, a notification pop-up should appear on the bottom-right
corner: “Multiple build definitions found. Which would you like to use?”. Click
<code class="docutils literal notranslate"><span class="pre">sbt</span></code>, then another pop-up appears, click <code class="docutils literal notranslate"><span class="pre">Import</span> <span class="pre">build</span></code>.</p>
<p>Wait while running <code class="docutils literal notranslate"><span class="pre">sbt</span> <span class="pre">bloopInstall</span></code>. Then a warning pop-up appears, you can
ignore it (don’t show again).</p>
<p>Find and open <code class="docutils literal notranslate"><span class="pre">hw/spinal/projectname/MyTopLevel.scala</span></code>.  Wait a little bit, and see the <code class="docutils literal notranslate"><span class="pre">run</span> <span class="pre">|</span> <span class="pre">debug</span></code> line that is displayed by Metals, before each <code class="docutils literal notranslate"><span class="pre">App</span></code>. For instance, click on <code class="docutils literal notranslate"><span class="pre">run</span></code> just above <code class="docutils literal notranslate"><span class="pre">object</span> <span class="pre">MyTopLevelVerilog</span></code>. Alternatively, you can select Menu Bar -&gt; Run -&gt; Run Without Debugging.  Either approach performs design checks and, as the checks pass, generates the Verilog file
<code class="docutils literal notranslate"><span class="pre">./hw/gen/MyTopLevel.v</span></code></p>
<p>This is all you need to do to use SpinalHDL from VSCodium.  You now have the design-rule-checked Verilog and/or VHDL which you can use as input to your favorite synthesis tool.</p>
<p>Now that you know how to use the VSCodium development environment, let’s explore the code: <a class="reference internal" href="index.html#simple-example"><span class="std std-ref">A simple example</span></a>.</p>
</section>
<span id="document-SpinalHDL/Getting Started/IntelliJ"></span><section id="using-spinal-from-intellij-idea">
<span id="using-intellij"></span><h3>Using Spinal from IntelliJ IDEA<a class="headerlink" href="#using-spinal-from-intellij-idea" title="Permalink to this heading"></a></h3>
<p>In addition to the aforementioned requirements, you also need to download the IntelliJ IDEA (the free <em>Community edition</em> is enough). When you have installed IntelliJ, also check that you have enabled its Scala plugin (<a class="reference external" href="https://www.jetbrains.com/help/idea/2016.1/enabling-and-disabling-plugins.html?origin=old_help">install information</a> can be found here).</p>
<p>And do the following:</p>
<ul class="simple">
<li><p>In <em>Intellij IDEA</em>, “import project” with the root of this repository, the choose the <em>Import project from external model SBT</em> and be sure to check all boxes.</p></li>
<li><p>In addition, you might need to specify some path like where you installed the JDK to <em>IntelliJ</em>.</p></li>
<li><p>In the project (Intellij project GUI), right click on <code class="docutils literal notranslate"><span class="pre">src/main/scala/mylib/MyTopLevel.scala</span></code> and select “Run MyTopLevel”.</p></li>
</ul>
<p>This should generate the output file <code class="docutils literal notranslate"><span class="pre">MyTopLevel.vhd</span></code> in the project directory, which implements a simple 8-bit counter.</p>
<p>Now you can use your environment, let’s explore the code: <a class="reference internal" href="index.html#simple-example"><span class="std std-ref">A simple example</span></a>.</p>
</section>
<span id="document-SpinalHDL/Getting Started/Scala Guide/index"></span><section id="scala-guide">
<h3>Scala Guide<a class="headerlink" href="#scala-guide" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Getting Started/Scala Guide/basics"></span><div class="admonition important">
<p class="admonition-title">Important</p>
<p>Variables and functions should be defined into <code class="docutils literal notranslate"><span class="pre">object</span></code>, <code class="docutils literal notranslate"><span class="pre">class</span></code>, <code class="docutils literal notranslate"><span class="pre">function</span></code>. You can’t define them on the root of a Scala file.</p>
</div>
<section id="basics">
<h4>Basics<a class="headerlink" href="#basics" title="Permalink to this heading"></a></h4>
<section id="types">
<h5>Types<a class="headerlink" href="#types" title="Permalink to this heading"></a></h5>
<p>In Scala, there are 5 major types:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Literal</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Boolean</p></td>
<td><p>true, false</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Int</p></td>
<td><p>3, 0x32</p></td>
<td><p>32 bits integer</p></td>
</tr>
<tr class="row-even"><td><p>Float</p></td>
<td><p>3.14f</p></td>
<td><p>32 bits floating point</p></td>
</tr>
<tr class="row-odd"><td><p>Double</p></td>
<td><p>3.14</p></td>
<td><p>64 bits floating point</p></td>
</tr>
<tr class="row-even"><td><p>String</p></td>
<td><p>“Hello world”</p></td>
<td><p>UTF-16 string</p></td>
</tr>
</tbody>
</table>
</section>
<section id="variables">
<h5>Variables<a class="headerlink" href="#variables" title="Permalink to this heading"></a></h5>
<p>In Scala, you can define a variable by using the <code class="docutils literal notranslate"><span class="pre">var</span></code> keyword:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="n">number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="c1">// 10</span>
</pre></div>
</div>
<p>Scala is able to infer the type automatically. You don’t need to specify it if the variable is assigned at declaration:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="c1">// The type of &#39;number&#39; is inferred as an Int during compilation.</span>
</pre></div>
</div>
<p>However, it’s not very common to use <code class="docutils literal notranslate"><span class="pre">var</span></code> in Scala. Instead, constant values defined by <code class="docutils literal notranslate"><span class="pre">val</span></code> are often used:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">two</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">six</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">three</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="functions">
<h5>Functions<a class="headerlink" href="#functions" title="Permalink to this heading"></a></h5>
<p>For example, if you want to define a function which returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the sum of its two arguments is bigger than zero, you can do as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sumBiggerThanZero</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">):</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then, to call this function, you can write:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">sumBiggerThanZero</span><span class="p">(</span><span class="mf">2.3f</span><span class="p">,</span><span class="w"> </span><span class="mf">5.4f</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>You can also specify arguments by name, which is useful if you have many arguments:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">sumBiggerThanZero</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.3f</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.4f</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<section id="return">
<h6>Return<a class="headerlink" href="#return" title="Permalink to this heading"></a></h6>
<p>The <code class="docutils literal notranslate"><span class="pre">return</span></code> keyword is not necessary. In absence of it, Scala takes the last statement of your function as the returned value.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sumBiggerThanZero</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">):</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="return-type-inferation">
<h6>Return type inferation<a class="headerlink" href="#return-type-inferation" title="Permalink to this heading"></a></h6>
<p>Scala is able to automatically infer the return type. You don’t need to specify it:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sumBiggerThanZero</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="curly-braces">
<h6>Curly braces<a class="headerlink" href="#curly-braces" title="Permalink to this heading"></a></h6>
<p>Scala functions don’t require curly braces if your function contains only one statement:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sumBiggerThanZero</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="function-that-returns-nothing">
<h6>Function that returns nothing<a class="headerlink" href="#function-that-returns-nothing" title="Permalink to this heading"></a></h6>
<p>If you want a function to return nothing, the return type should be set to <code class="docutils literal notranslate"><span class="pre">Unit</span></code>. It’s equivalent to the C/C++ <code class="docutils literal notranslate"><span class="pre">void</span></code> type.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">printer</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;5678&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="argument-default-values">
<h6>Argument default values<a class="headerlink" href="#argument-default-values" title="Permalink to this heading"></a></h6>
<p>You can specify a default value for each argument of a function:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sumBiggerThanZero</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="apply">
<h6>Apply<a class="headerlink" href="#apply" title="Permalink to this heading"></a></h6>
<p>Functions named <code class="docutils literal notranslate"><span class="pre">apply</span></code> are special because you can call them without having to type their name:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Array</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Array</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w">   </span><span class="c1">// array(4) is interpreted as array.apply(4) and will return 7</span>
</pre></div>
</div>
<p>This concept is also applicable for Scala <code class="docutils literal notranslate"><span class="pre">object</span></code> (static)</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">MajorityVote</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MajorityVote</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="c1">// Will call MajorityVote.apply(4)</span>
</pre></div>
</div>
</section>
</section>
<section id="object">
<h5>Object<a class="headerlink" href="#object" title="Permalink to this heading"></a></h5>
<p>In Scala, there is no <code class="docutils literal notranslate"><span class="pre">static</span></code> keyword. In place of that, there is <code class="docutils literal notranslate"><span class="pre">object</span></code>. Everything defined inside an <code class="docutils literal notranslate"><span class="pre">object</span></code> definition is static.</p>
<p>The following example defines a static function named <code class="docutils literal notranslate"><span class="pre">pow2</span></code> which takes a floating point value as parameter and returns a floating point value as well.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">MathUtils</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">pow2</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">):</span><span class="w"> </span><span class="nc">Float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then you can call it by writing:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">MathUtils</span><span class="p">.</span><span class="n">pow2</span><span class="p">(</span><span class="mf">42.0f</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="entry-point-main">
<h5>Entry point (main)<a class="headerlink" href="#entry-point-main" title="Permalink to this heading"></a></h5>
<p>The entry point of a Scala program (the main function) should be defined inside an object as a function named <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">MyTopLevelMain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="class">
<h5>Class<a class="headerlink" href="#class" title="Permalink to this heading"></a></h5>
<p>The class syntax is very similar to Java. Imagine that you want to define a <code class="docutils literal notranslate"><span class="pre">Color</span></code> class which takes as construction parameters three Float values (r,g,b) :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getGrayLevel</span><span class="p">():</span><span class="w"> </span><span class="nc">Float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.3f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.4f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.4f</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then, to instantiate the class from the previous example and use its <code class="docutils literal notranslate"><span class="pre">getGrayLevel</span></code> function:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">grayLevelOfBlue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blue</span><span class="p">.</span><span class="n">getGrayLevel</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>Be careful, if you want to access a construction parameter of the class from the outside, this construction parameter should be defined as a <code class="docutils literal notranslate"><span class="pre">val</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">redLevelOfBlue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blue</span><span class="p">.</span><span class="n">r</span><span class="w"></span>
</pre></div>
</div>
<section id="inheritance">
<h6>Inheritance<a class="headerlink" href="#inheritance" title="Permalink to this heading"></a></h6>
<p>As an example, suppose that you want to define two classes, <code class="docutils literal notranslate"><span class="pre">Rectangle</span></code> and <code class="docutils literal notranslate"><span class="pre">Square</span></code>, which extend the class <code class="docutils literal notranslate"><span class="pre">Shape</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Shape</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getArea</span><span class="p">():</span><span class="w"> </span><span class="nc">Float</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">Square</span><span class="p">(</span><span class="n">sideLength</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Shape</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getArea</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sideLength</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sideLength</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">Rectangle</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Shape</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getArea</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="case-class">
<h6>Case class<a class="headerlink" href="#case-class" title="Permalink to this heading"></a></h6>
<p>Case class is an alternative way of declaring classes.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rectangle</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Shape</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getArea</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then there are some differences between <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code> and <code class="docutils literal notranslate"><span class="pre">class</span></code> :</p>
<ul class="simple">
<li><p>case classes don’t need the <code class="docutils literal notranslate"><span class="pre">new</span></code> keyword to be instantiated.</p></li>
<li><p>construction parameters are accessible from outside; you don’t need to define them as <code class="docutils literal notranslate"><span class="pre">val</span></code>.</p></li>
</ul>
<p>In SpinalHDL, this explains the reasoning behind the coding conventions: it’s in general recommended to use <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code> instead of <code class="docutils literal notranslate"><span class="pre">class</span></code> in order to have less typing and more coherency.</p>
</section>
</section>
<section id="templates-type-parameterization">
<h5>Templates / Type parameterization<a class="headerlink" href="#templates-type-parameterization" title="Permalink to this heading"></a></h5>
<p>Imagine you want to design a class which is a queue of a given datatype, in that case you need to provide a type parameter to the class:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w">  </span><span class="nc">Queue</span><span class="p">[</span><span class="nc">T</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">push</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">():</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If you want to restrict the <code class="docutils literal notranslate"><span class="pre">T</span></code> type to be a sub class of a given type (for example <code class="docutils literal notranslate"><span class="pre">Shape</span></code>), you can use the <code class="docutils literal notranslate"><span class="pre">&lt;:</span> <span class="pre">Shape</span></code> syntax :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Shape</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">getArea</span><span class="p">():</span><span class="w"> </span><span class="nc">Float</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">Rectangle</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Shape</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w">  </span><span class="nc">Queue</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Shape</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">push</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">():</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The same is possible for functions:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">doSomething</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Shape</span><span class="p">](</span><span class="n">shape</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">):</span><span class="w"> </span><span class="nc">Something</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">shape</span><span class="p">.</span><span class="n">getArea</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Getting Started/Scala Guide/coding_conventions"></span><section id="coding-conventions">
<h4>Coding conventions<a class="headerlink" href="#coding-conventions" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>The coding conventions used in SpinalHDL are the same as the ones documented in the <a class="reference external" href="https://docs.scala-lang.org/style/">Scala Style Guide</a>.</p>
<p>Some additional practical details and cases are explained in next pages.</p>
</section>
<section id="class-vs-case-class">
<h5>class vs case class<a class="headerlink" href="#class-vs-case-class" title="Permalink to this heading"></a></h5>
<p>When you define a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> or a <code class="docutils literal notranslate"><span class="pre">Component</span></code>, it is preferable to declare it as a case class.</p>
<p>The reasons are:</p>
<ul class="simple">
<li><p>It avoids the use of <code class="docutils literal notranslate"><span class="pre">new</span></code> keywords. Never having to use it is better than sometimes, under some conditions.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code> provides a <code class="docutils literal notranslate"><span class="pre">clone</span></code> function. This is useful in SpinalHDL when there is a need to clone a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>, for example, when you define a new <code class="docutils literal notranslate"><span class="pre">Reg</span></code> or a new <code class="docutils literal notranslate"><span class="pre">Stream</span></code> of some kind.</p></li>
<li><p>Construction parameters are directly visible from outside.</p></li>
</ul>
<section id="case-class">
<h6>[case] class<a class="headerlink" href="#case-class" title="Permalink to this heading"></a></h6>
<p>All classes names should start with a uppercase letter</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Fifo</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">Counter</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="companion-object">
<h6>companion object<a class="headerlink" href="#companion-object" title="Permalink to this heading"></a></h6>
<p>A <a class="reference external" href="https://docs.scala-lang.org/overviews/scala-book/companion-objects.html">companion object</a> should start with an uppercase letter.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">Fifo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">Bits</span><span class="p">]):</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">Bits</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">MajorityVote</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">):</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>An exception to this rule is when the companion object is used as a function (only <code class="docutils literal notranslate"><span class="pre">apply</span></code> inside), and these <code class="docutils literal notranslate"><span class="pre">apply</span></code> functions don’t generate hardware:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">log2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="function">
<h6>function<a class="headerlink" href="#function" title="Permalink to this heading"></a></h6>
<p>A function should always start with a lowercase letter:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sinTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sinValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nc">S</span><span class="p">((</span><span class="n">sinValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">resolutionWidth</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)).</span><span class="n">toInt</span><span class="p">,</span><span class="w"> </span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">initialContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinTable</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="instances">
<h6>instances<a class="headerlink" href="#instances" title="Permalink to this heading"></a></h6>
<p>Instances of classes should always start with a lowercase letter:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">fifo</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Fifo</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="if-when">
<h6>if / when<a class="headerlink" href="#if-when" title="Permalink to this heading"></a></h6>
<p>Scala <code class="docutils literal notranslate"><span class="pre">if</span></code> and SpinalHDL <code class="docutils literal notranslate"><span class="pre">when</span></code> should normally be written in the following way:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">elsewhen</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Exceptions could be:</p>
<ul class="simple">
<li><p>It’s fine to include a dot before the keyword like methods <code class="docutils literal notranslate"><span class="pre">.elsewhen</span></code> and <code class="docutils literal notranslate"><span class="pre">.otherwise</span></code>.</p></li>
<li><p>It’s fine to compress an <code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">when</span></code> statement onto a single line if it makes the code more readable.</p></li>
</ul>
</section>
<section id="switch">
<h6>switch<a class="headerlink" href="#switch" title="Permalink to this heading"></a></h6>
<p>SpinalHDL <code class="docutils literal notranslate"><span class="pre">switch</span></code> should normally be written in the following way:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It’s fine to compress an <code class="docutils literal notranslate"><span class="pre">is</span></code>/<code class="docutils literal notranslate"><span class="pre">default</span></code> statement onto a single line if it makes the code more readable.</p>
</section>
<section id="parameters">
<h6>Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading"></a></h6>
<p>Grouping parameters of a <code class="docutils literal notranslate"><span class="pre">Component</span></code>/<code class="docutils literal notranslate"><span class="pre">Bundle</span></code> inside a case class is generally welcome because:</p>
<ul class="simple">
<li><p>Easier to carry/manipulate to configure the design</p></li>
<li><p>Better maintainability</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">(</span><span class="n">rWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">gWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">bWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bWidth</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">gWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">bWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But this should not be applied in all cases. For example: in a FIFO, it doesn’t make sense to group the <code class="docutils literal notranslate"><span class="pre">dataType</span></code> parameter with the <code class="docutils literal notranslate"><span class="pre">depth</span></code> parameter of the fifo because, in general, the <code class="docutils literal notranslate"><span class="pre">dataType</span></code> is something related to the design, while the <code class="docutils literal notranslate"><span class="pre">depth</span></code> is something related to the configuration of the design.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Fifo</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Getting Started/Scala Guide/interaction"></span><section id="interaction">
<h4>Interaction<a class="headerlink" href="#interaction" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>SpinalHDL is, in fact, not an language: it’s a regular Scala library. This could seem strange at first glance, but it is a very powerful combination.</p>
<p>You can use the whole Scala world to help you in the description of your hardware via the SpinalHDL library, but to do that properly, it’s important to understand how SpinalHDL interacts with Scala.</p>
</section>
<section id="how-spinalhdl-works-behind-the-api">
<h5>How SpinalHDL works behind the API<a class="headerlink" href="#how-spinalhdl-works-behind-the-api" title="Permalink to this heading"></a></h5>
<p>When you execute your SpinalHDL hardware description, each time you use SpinalHDL functions, operators, or classes, it will build an in-memory graph that represents the netlist of your design.</p>
<p>Then, when the elaboration is done (instantiation of your top-level <code class="docutils literal notranslate"><span class="pre">Component</span></code> classes), SpinalHDL will do some passes on the graph that was constructed, and if everything is fine, it will flush that graph into a VHDL or Verilog file.</p>
</section>
<section id="everything-is-a-reference">
<h5>Everything is a reference<a class="headerlink" href="#everything-is-a-reference" title="Permalink to this heading"></a></h5>
<p>For example, if you define a Scala function which takes a parameter of type <code class="docutils literal notranslate"><span class="pre">Bits</span></code>, when you call it, it will be passed as a reference. As consequence of that, if you assign that argument inside the function, it has the same effect on the underlying <code class="docutils literal notranslate"><span class="pre">Bits</span></code> object as if you had assigned to it outside the function.</p>
</section>
<section id="hardware-types">
<span id="hardware-type"></span><h5>Hardware types<a class="headerlink" href="#hardware-types" title="Permalink to this heading"></a></h5>
<p>Hardware data types in SpinalHDL are the combination of two things:</p>
<ul class="simple">
<li><p>An instance of a given Scala type</p></li>
<li><p>The configuration of that instance</p></li>
</ul>
<p>For example <code class="docutils literal notranslate"><span class="pre">Bits(8</span> <span class="pre">bits)</span></code> is the combination of the Scala type <code class="docutils literal notranslate"><span class="pre">Bits</span></code> and its <code class="docutils literal notranslate"><span class="pre">8</span> <span class="pre">bits</span></code> configuration (as a construction parameter).</p>
<section id="rgb-example">
<h6>RGB example<a class="headerlink" href="#rgb-example" title="Permalink to this heading"></a></h6>
<p>Let’s take an Rgb bundle class as example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">rWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">gWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">bWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">rWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">gWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">bWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The hardware data type here is the combination of the Scala <code class="docutils literal notranslate"><span class="pre">Rgb</span></code> class and its <code class="docutils literal notranslate"><span class="pre">rWidth</span></code>, <code class="docutils literal notranslate"><span class="pre">gWidth</span></code>, and <code class="docutils literal notranslate"><span class="pre">bWidth</span></code> parameterization.</p>
<p>Here is an example of usage:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define an Rgb signal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRgbSignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Define another Rgb signal of the same data type as the preceding one</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRgbCloned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloneOf</span><span class="p">(</span><span class="n">myRgbSignal</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>You can also use functions to define various kinds of type factories (typedef):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define a type factory function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">myRgbTypeDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Use that type factory to create an Rgb signal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRgbFromTypeDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myRgbTypeDef</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="names-of-signals-in-the-generated-rtl">
<h5>Names of signals in the generated RTL<a class="headerlink" href="#names-of-signals-in-the-generated-rtl" title="Permalink to this heading"></a></h5>
<p>To name signals in the generated RTL, SpinalHDL uses Java reflections to walk through your entire component hierarchy, collecting all references stored inside the class attributes, and naming them with their attribute name.</p>
<p>This is why the names of every signal defined inside a function are lost:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">myFunction</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// You will not retrieve the `temp` signal in the generated RTL</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myFunction</span><span class="p">(</span><span class="nc">U</span><span class="s">&quot;000001&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
</pre></div>
</div>
<p>One solution if you want preserve the names of the internal variables in the generated RTL, is to use <code class="docutils literal notranslate"><span class="pre">Area</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">myFunction</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// You will not retrieve the temp signal in the generated RTL</span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">myFunctionCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myFunction</span><span class="p">(</span><span class="nc">U</span><span class="s">&quot;000001&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Will generate `temp` with `myFunctionCall_temp` as the name</span>
<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myFunctionCall</span><span class="p">.</span><span class="n">temp</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="scala-is-for-elaboration-spinalhdl-for-hardware-description">
<h5>Scala is for elaboration, SpinalHDL for hardware description<a class="headerlink" href="#scala-is-for-elaboration-spinalhdl-for-hardware-description" title="Permalink to this heading"></a></h5>
<p>For example, if you write a Scala for loop to generate some hardware, it will generate the unrolled result in VHDL/Verilog.</p>
<p>Also, if you want a constant, you should not use SpinalHDL hardware literals but the Scala ones. For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is wrong, because you can&#39;t use a hardware Bool as construction parameter. (It will cause hierarchy violations.)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SubComponent</span><span class="p">(</span><span class="n">activeHigh</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// This is right, you can use all the Scala world to parameterize your hardware.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SubComponent</span><span class="p">(</span><span class="n">activeHigh</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="scala-elaboration-capabilities-if-for-functional-programming">
<h5>Scala elaboration capabilities (if, for, functional programming)<a class="headerlink" href="#scala-elaboration-capabilities-if-for-functional-programming" title="Permalink to this heading"></a></h5>
<p>All of Scala’s syntax can be used to elaborate hardware designs, for instance, a Scala <code class="docutils literal notranslate"><span class="pre">if</span></code> statement could be used to enable or disable the generation of hardware:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="n">generateAClearWhenHit42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// Elaboration test, like an if generate in vhdl</span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">       </span><span class="c1">// Hardware test</span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The same is true for Scala <code class="docutils literal notranslate"><span class="pre">for</span></code> loops:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Set all bits of value by using a Scala for loop (evaluated during hardware elaboration)</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Also, functional programming techniques can be used with many SpinalHDL types:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">valuesAre42</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">valuesAreAll42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valuesAre42</span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">valuesAreEqualToTheirIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">zipWithIndex</span><span class="p">.</span><span class="n">map</span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
<section id="id1">
<h4>Scala guide<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>Scala is a very capable programming language that was influenced by a unique set of languages, but often, this set of languages doesn’t cross the ones that most programmers use. That can hinder newcomers’ understanding of the concepts and design choices behind Scala.</p>
<p>The following pages will present Scala, and try to provide enough information about it for newcomers to be comfortable with SpinalHDL.</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Getting Started/Help for VHDL people/index"></span><section id="help-for-vhdl-people">
<h3>Help for VHDL people<a class="headerlink" href="#help-for-vhdl-people" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Getting Started/Help for VHDL people/vhdl_comp"></span><section id="vhdl-comparison">
<h4>VHDL comparison<a class="headerlink" href="#vhdl-comparison" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>This page will show the main differences between VHDL and SpinalHDL. Things will not be explained in depth.</p>
</section>
<section id="process">
<h5>Process<a class="headerlink" href="#process" title="Permalink to this heading"></a></h5>
<p>Processes are often needed when you write RTL, however, their semantics can be clunky to work with. Due to how they work in VHDL, they can force you to split your code and duplicate things.</p>
<p>To produce the following RTL:</p>
<img alt="_images/process_rtl.svg" src="_images/process_rtl.svg" /><p>You will have to write the following VHDL:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span>  <span class="n">signal</span> <span class="n">mySignal</span> <span class="p">:</span> <span class="n">std_logic</span><span class="p">;</span>
  <span class="n">signal</span> <span class="n">myRegister</span> <span class="p">:</span> <span class="n">std_logic_vector</span><span class="p">(</span><span class="mi">3</span> <span class="n">downto</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">signal</span> <span class="n">myRegisterWithReset</span> <span class="p">:</span> <span class="n">std_logic_vector</span><span class="p">(</span><span class="mi">3</span> <span class="n">downto</span> <span class="mi">0</span><span class="p">);</span>
<span class="kr">begin</span>
  <span class="n">process</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
  <span class="kr">begin</span>
    <span class="n">mySignal</span> <span class="o">&lt;=</span> <span class="p">&#39;</span><span class="na">0</span><span class="p">&#39;;</span>
    <span class="kr">if</span> <span class="n">cond</span> <span class="o">=</span> <span class="p">&#39;</span><span class="na">1</span><span class="p">&#39;</span> <span class="kr">then</span>
      <span class="n">mySignal</span> <span class="o">&lt;=</span> <span class="p">&#39;</span><span class="na">1</span><span class="p">&#39;;</span>
    <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
  <span class="kr">end</span> <span class="nf">process</span><span class="p">;</span>

  <span class="n">process</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span>
  <span class="kr">begin</span>
    <span class="kr">if</span> <span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span> <span class="kr">then</span>
      <span class="kr">if</span> <span class="n">cond</span> <span class="o">=</span> <span class="p">&#39;</span><span class="na">1</span><span class="p">&#39;</span> <span class="kr">then</span>
        <span class="n">myRegister</span> <span class="o">&lt;=</span> <span class="n">myRegister</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
    <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
  <span class="kr">end</span> <span class="nf">process</span><span class="p">;</span>

  <span class="n">process</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span><span class="n">reset</span><span class="p">)</span>
  <span class="kr">begin</span>
    <span class="kr">if</span> <span class="n">reset</span> <span class="o">=</span> <span class="p">&#39;</span><span class="na">1</span><span class="p">&#39;</span> <span class="kr">then</span>
      <span class="n">myRegisterWithReset</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kr">others</span> <span class="p">=&gt;</span> <span class="p">&#39;</span><span class="na">0</span><span class="p">&#39;);</span>
    <span class="kr">elsif</span> <span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span> <span class="kr">then</span>
      <span class="kr">if</span> <span class="n">cond</span> <span class="o">=</span> <span class="p">&#39;</span><span class="na">1</span><span class="p">&#39;</span> <span class="kr">then</span>
        <span class="n">myRegisterWithReset</span> <span class="o">&lt;=</span> <span class="n">myRegisterWithReset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
    <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
  <span class="kr">end</span> <span class="nf">process</span><span class="p">;</span>
</pre></div>
</div>
<p>While in SpinalHDL, it’s:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">mySignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="n">mySignal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">mySignal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">myRegister</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myRegisterWithReset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="implicit-vs-explicit-definitions">
<h5>Implicit vs explicit definitions<a class="headerlink" href="#implicit-vs-explicit-definitions" title="Permalink to this heading"></a></h5>
<p>In VHDL, when you declare a signal, you don’t specify if it is a combinatorial signal or a register. Where and how you assign to it decides whether it is combinatorial or registered.</p>
<p>In SpinalHDL these kinds of things are explicit. Registers are defined as registers directly in their declaration.</p>
</section>
<section id="clock-domains">
<h5>Clock domains<a class="headerlink" href="#clock-domains" title="Permalink to this heading"></a></h5>
<p>In VHDL, every time you want to define a bunch of registers, you need the carry the clock and the reset signal to them. In addition, you have to hardcode everywhere how those clock and reset signals should be used (clock edge, reset polarity, reset nature (async, sync)).</p>
<p>In SpinalHDL you can define a <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code>, and then define the area of your hardware that uses it.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">coreClk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">coreReset</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clockEdge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RISING</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resetKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ASYNC</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resetActiveLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">HIGH</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">coreClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myCoreClockedRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="c1">// coreClockDomain will also be applied to all sub components instantiated in the Area</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="component-s-internal-organization">
<h5>Component’s internal organization<a class="headerlink" href="#component-s-internal-organization" title="Permalink to this heading"></a></h5>
<p>In VHDL, there is a <code class="docutils literal notranslate"><span class="pre">block</span></code> feature that allows you to define sub-areas of logic inside your component. However, almost no one uses this feature, because most people don’t know about them, and also because all signals defined inside these regions are not readable from the outside.</p>
<p>In SpinalHDL you have an <code class="docutils literal notranslate"><span class="pre">Area</span></code> feature that does this concept much more nicely:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">overflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">overflow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">timeout</span><span class="p">.</span><span class="n">overflow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">timeout</span><span class="p">.</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Variables and signals defined inside of an <code class="docutils literal notranslate"><span class="pre">Area</span></code> are accessible elsewhere in the component, including in other <code class="docutils literal notranslate"><span class="pre">Area</span></code> regions.</p>
</section>
<section id="safety">
<h5>Safety<a class="headerlink" href="#safety" title="Permalink to this heading"></a></h5>
<p>In VHDL as in SpinalHDL, it’s easy to write combinatorial loops, or to infer a latch by forgetting to drive a signal in the path of a process.</p>
<p>Then, to detect those issues, you can use some <code class="docutils literal notranslate"><span class="pre">lint</span></code> tools that will analyze your VHDL, but those tools aren’t free. In SpinalHDL the <code class="docutils literal notranslate"><span class="pre">lint</span></code> process in integrated inside the compiler, and it won’t generate the RTL code until everything is fine. It also checks clock domain crossing.</p>
</section>
<section id="functions-and-procedures">
<h5>Functions and procedures<a class="headerlink" href="#functions-and-procedures" title="Permalink to this heading"></a></h5>
<p>Functions and procedures are not used very often in VHDL, probably because they are very limited:</p>
<ul class="simple">
<li><p>You can only define a chunk of combinational hardware, or only a chunk of registers (if you call the function/procedure inside a clocked process).</p></li>
<li><p>You can’t define a process inside them.</p></li>
<li><p>You can’t instantiate a component inside them.</p></li>
<li><p>The scope of what you can read/write inside them is limited.</p></li>
</ul>
<p>In SpinalHDL, all those limitations are removed.</p>
<p>An example that mixes combinational logic and a register in a single function:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simpleAluPipeline</span><span class="p">(</span><span class="n">op</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">):</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">switch</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">0</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">2</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>An example with the queue function inside the Stream Bundle (handshake). This function instantiates a FIFO component:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w">  </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">DataCarrier</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloneOf</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">queue</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">fifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="bp">this</span><span class="w"></span>
<span class="w">    </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>An example where a function assigns a signal defined outside of itself:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="buses-and-interfaces">
<h5>Buses and Interfaces<a class="headerlink" href="#buses-and-interfaces" title="Permalink to this heading"></a></h5>
<p>VHDL is very boring when it comes to buses and interfaces. You have two options:</p>
<ol class="arabic simple">
<li><p>Define buses and interfaces wire-by-wire, each time and everywhere:</p></li>
</ol>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">PADDR</span>   <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">(</span><span class="n">addressWidth</span><span class="o">-</span><span class="mi">1</span> <span class="n">downto</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">PSEL</span>    <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span>
<span class="n">PENABLE</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
<span class="n">PREADY</span>  <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic</span><span class="p">;</span>
<span class="n">PWRITE</span>  <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
<span class="n">PWDATA</span>  <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">(</span><span class="n">dataWidth</span><span class="o">-</span><span class="mi">1</span> <span class="n">downto</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">PRDATA</span>  <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic_vector</span><span class="p">(</span><span class="n">dataWidth</span><span class="o">-</span><span class="mi">1</span> <span class="n">downto</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Use records but lose parameterization (statically fixed in the package), and you have to define one for each directions:</p></li>
</ol>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">P_m</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">APB_M</span><span class="p">;</span>
<span class="n">P_s</span> <span class="p">:</span> <span class="kr">out</span> <span class="n">APB_S</span><span class="p">;</span>
</pre></div>
</div>
<p>SpinalHDL has very strong support for bus and interface declarations with limitless parameterizations:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">,</span><span class="w"> </span><span class="n">dataWidth</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>You can also use object oriented programming to define configuration objects:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">coreConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CoreConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">pcWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">addrWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">startAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">regFileReadyKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sync</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">branchPrediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamic</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bypassExecute0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bypassExecute1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bypassWriteBack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bypassWriteBackBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">collapseBubble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">fastFetchCmdPcCalculation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dynamicBranchPredictorCacheSizeLog2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">// The CPU has a system of plugins which allows adding new features into the core.</span>
<span class="c1">// Those extensions are not directly implemented in the core, but are kind of an additive logic patch defined in a separate area.</span>
<span class="n">coreConfig</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MulExtension</span><span class="p">)</span><span class="w"></span>
<span class="n">coreConfig</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">DivExtension</span><span class="p">)</span><span class="w"></span>
<span class="n">coreConfig</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">BarrelShifterFullExtension</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">iCacheConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InstructionCacheConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">cacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bytePerLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">wayCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">// Can only be one for the moment</span>
<span class="w">  </span><span class="n">wrappedMemAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">cpuDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">memDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="k">new</span><span class="w"> </span><span class="nc">RiscvCoreAxi4</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">coreConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coreConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">iCacheConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iCacheConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dCacheConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debug</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">interruptCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interruptCount</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="signal-declaration">
<h5>Signal declaration<a class="headerlink" href="#signal-declaration" title="Permalink to this heading"></a></h5>
<p>VHDL forces you to define all signals at the top of your architecture description, which is annoying.</p>
<div class="highlight-VHDL notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">declarations</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="k">signal</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">declarations</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="k">begin</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="n">definitions</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="n">definitions</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
</pre></div>
</div>
<p>SpinalHDL is flexible when it comes to signal declarations.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
</pre></div>
</div>
<p>It also allows you to define and assign signals in a single line.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="component-instantiation">
<h5>Component instantiation<a class="headerlink" href="#component-instantiation" title="Permalink to this heading"></a></h5>
<p>VHDL is very verbose about this, as you have to redefine all signals of your sub-component entity, and then bind them one-by-one when you instantiate your component.</p>
<div class="highlight-VHDL notranslate"><div class="highlight"><pre><span></span><span class="n">divider_cmd_valid</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="n">divider_cmd_ready</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="n">divider_cmd_numerator</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">divider_cmd_denominator</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">divider_rsp_valid</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="n">divider_rsp_ready</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="n">divider_rsp_quotient</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">divider_rsp_remainder</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="n">divider</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">entity</span><span class="w"> </span><span class="nc">work</span><span class="p">.</span><span class="n">UnsignedDivider</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clk</span><span class="w">             </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">reset</span><span class="w">           </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reset</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cmd_valid</span><span class="w">       </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_cmd_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cmd_ready</span><span class="w">       </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_cmd_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cmd_numerator</span><span class="w">   </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_cmd_numerator</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cmd_denominator</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_cmd_denominator</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rsp_valid</span><span class="w">       </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_rsp_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rsp_ready</span><span class="w">       </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_rsp_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rsp_quotient</span><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_rsp_quotient</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rsp_remainder</span><span class="w">   </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">divider_rsp_remainder</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>SpinalHDL removes that, and allows you to access the IO of sub-components in an object-oriented way.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">divider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UnsignedDivider</span><span class="p">()</span><span class="w"></span>

<span class="c1">// And then if you want to access IO signals of that divider:</span>
<span class="n">divider</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="n">divider</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">numerator</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="casting">
<h5>Casting<a class="headerlink" href="#casting" title="Permalink to this heading"></a></h5>
<p>There are two annoying casting methods in VHDL:</p>
<ul class="simple">
<li><p>boolean &lt;&gt; std_logic (ex: To assign a signal using a condition such as <code class="docutils literal notranslate"><span class="pre">mySignal</span> <span class="pre">&lt;=</span> <span class="pre">myValue</span> <span class="pre">&lt;</span> <span class="pre">10</span></code> is not legal)</p></li>
<li><p>unsigned &lt;&gt; integer  (ex: To access an array)</p></li>
</ul>
<p>SpinalHDL removes these casts by unifying things.</p>
<p>boolean/std_logic:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">valueBiggerThanTwo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="n">valueBiggerThanTwo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">// value &gt; 2 return a Bool</span>
</pre></div>
</div>
<p>unsigned/integer:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">arraySel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="c1">// Arrays are indexed directly by using UInt</span>
</pre></div>
</div>
</section>
<section id="resizing">
<h5>Resizing<a class="headerlink" href="#resizing" title="Permalink to this heading"></a></h5>
<p>The fact that VHDL is strict about bit size is probably a good thing.</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">my8BitsSignal</span> <span class="o">&lt;=</span> <span class="n">resize</span><span class="p">(</span><span class="n">my4BitsSignal</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</pre></div>
</div>
<p>In SpinalHDL you have two ways to do the same:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// The traditional way</span>
<span class="n">my8BitsSignal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">my4BitsSignal</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// The smart way</span>
<span class="n">my8BitsSignal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">my4BitsSignal</span><span class="p">.</span><span class="n">resized</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="parameterization">
<h5>Parameterization<a class="headerlink" href="#parameterization" title="Permalink to this heading"></a></h5>
<div class="line-block">
<div class="line">VHDL prior to the 2008 revision has many issues with generics. For example, you can’t parameterize records, you can’t parameterize arrays in the entity, and you can’t have type parameters.</div>
<div class="line">Then VHDL 2008 came and fixed those issues. But RTL tool support for VHDL 2008 is really weak depending on the vendor.</div>
</div>
<p>SpinalHDL has full support for generics integrated natively in its compiler, and it doesn’t rely on VHDL generics.</p>
<p>Here is an example of parameterized data structures:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">colorStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">colorFifo</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"></span>
<span class="n">colorFifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">colorStream</span><span class="w"></span>
</pre></div>
</div>
<p>Here is an example of a parameterized component:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Arbiter</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">payloadType</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">portCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)),</span><span class="w"> </span><span class="n">portCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">payloadType</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="meta-hardware-description">
<h5>Meta hardware description<a class="headerlink" href="#meta-hardware-description" title="Permalink to this heading"></a></h5>
<p>VHDL has kind of a closed syntax. You can’t add abstraction layers on top of it.</p>
<p>SpinalHDL, because it’s built on top of Scala, is very flexible, and allows you to define new abstraction layers very easily.</p>
<p>Some examples of this flexibility are the <a class="reference internal" href="index.html#state-machine"><span class="std std-ref">FSM</span></a> library, the <a class="reference internal" href="index.html#bus-slave-factory"><span class="std std-ref">BusSlaveFactory</span></a> library, and also the <a class="reference internal" href="index.html#jtag"><span class="std std-ref">JTAG</span></a> library.</p>
</section>
</section>
<span id="document-SpinalHDL/Getting Started/Help for VHDL people/vhdl_perspective"></span><section id="vhdl-equivalences">
<h4>VHDL equivalences<a class="headerlink" href="#vhdl-equivalences" title="Permalink to this heading"></a></h4>
<section id="entity-and-architecture">
<h5>Entity and architecture<a class="headerlink" href="#entity-and-architecture" title="Permalink to this heading"></a></h5>
<p>In SpinalHDL, a VHDL entity and architecture are both defined inside a <code class="docutils literal notranslate"><span class="pre">Component</span></code>.</p>
<p>Here is an example of a component which has 3 inputs (<code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">c</span></code>) and an output (<code class="docutils literal notranslate"><span class="pre">result</span></code>). This component also has an <code class="docutils literal notranslate"><span class="pre">offset</span></code> construction parameter (like a VHDL generic).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then to instantiate that component, you don’t need to bind it:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mySubComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="p">...</span><span class="w"></span>

<span class="w">  </span><span class="n">mySubComponent</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">mySubComponent</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">mySubComponent</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">  </span><span class="o">???</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mySubComponent</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"></span>

<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="data-types">
<h5>Data types<a class="headerlink" href="#data-types" title="Permalink to this heading"></a></h5>
<p>SpinalHDL data types are similar to the VHDL ones:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>VHDL</p></th>
<th class="head"><p>SpinalHDL</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>std_logic</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>std_logic_vector</p></td>
<td><p>Bits</p></td>
</tr>
<tr class="row-even"><td><p>unsigned</p></td>
<td><p>UInt</p></td>
</tr>
<tr class="row-odd"><td><p>signed</p></td>
<td><p>SInt</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">In VHDL, to define an 8 bit <code class="docutils literal notranslate"><span class="pre">unsigned</span></code> you have to give the range of bits <code class="docutils literal notranslate"><span class="pre">unsigned(7</span> <span class="pre">downto</span> <span class="pre">0)</span></code>,</div>
<div class="line">whereas in SpinalHDL you simply supply the number of bits <code class="docutils literal notranslate"><span class="pre">UInt(8</span> <span class="pre">bits)</span></code>.</div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>VHDL</p></th>
<th class="head"><p>SpinalHDL</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>records</p></td>
<td><p>Bundle</p></td>
</tr>
<tr class="row-odd"><td><p>array</p></td>
<td><p>Vec</p></td>
</tr>
<tr class="row-even"><td><p>enum</p></td>
<td><p>SpinalEnum</p></td>
</tr>
</tbody>
</table>
<p>Here is an example of the SpinalHDL <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> definition. <code class="docutils literal notranslate"><span class="pre">channelWidth</span></code> is a construction parameter, like VHDL generics, but for data structures:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then for example, to instantiate a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>, you need to write <code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">myColor</span> <span class="pre">=</span> <span class="pre">RGB(channelWidth=8)</span></code>.</p>
</section>
<section id="signal">
<h5>Signal<a class="headerlink" href="#signal" title="Permalink to this heading"></a></h5>
<p>Here is an example about signal instantiations:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">ab</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">abc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w">            </span><span class="c1">// You can define a signal directly with its value</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">abc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="assignments">
<h5>Assignments<a class="headerlink" href="#assignments" title="Permalink to this heading"></a></h5>
<p>In SpinalHDL, the <code class="docutils literal notranslate"><span class="pre">:=</span></code> assignment operator is equivalent to the VHDL signal assignment (<code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
</pre></div>
</div>
<p>Conditional assignments are done like in VHDL by using <code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">case</span></code> statements:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}.</span><span class="n">elsewhen</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">76</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">79</span><span class="w"></span>
<span class="p">}.</span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">counter</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">switch</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">65</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="literals">
<h5>Literals<a class="headerlink" href="#literals" title="Permalink to this heading"></a></h5>
<p>Literals are a little bit different than in VHDL:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;0001_1100&quot;</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;xEE&quot;</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">54</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">((</span><span class="mi">3</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">myBool</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">myUInt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="n">myUInt</span><span class="p">.</span><span class="n">range</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">myUInt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="registers">
<h5>Registers<a class="headerlink" href="#registers" title="Permalink to this heading"></a></h5>
<p>In SpinalHDL, registers are explicitly specified while in VHDL registers are inferred. Here is an example of SpinalHDL registers:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w">  </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="c1">// Count up each cycle</span>

<span class="c1">// init(0) means that the register should be initialized to zero when a reset occurs</span>
</pre></div>
</div>
</section>
<section id="process-blocks">
<h5>Process blocks<a class="headerlink" href="#process-blocks" title="Permalink to this heading"></a></h5>
<p>Process blocks are a simulation feature that is unnecessary to design RTL. It’s why SpinalHDL doesn’t contain any feature analogous to process blocks, and you can assign what you want, where you want.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myCombinatorial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="n">myCombinatorial</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">myCombinatorial</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">myRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myRegister</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Getting Started/Cheatsheets/index"></span><section id="cheatsheets">
<h3>Cheatsheets<a class="headerlink" href="#cheatsheets" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Getting Started/Cheatsheets/core"></span><section id="core">
<h4>Core<a class="headerlink" href="#core" title="Permalink to this heading"></a></h4>
<p>Redirection to <a class="reference external" href="https://github.com/SpinalHDL/SpinalDoc/blob/master/cheatsheet/cheatSheet_core_oo.pdf">https://github.com/SpinalHDL/SpinalDoc/blob/master/cheatsheet/cheatSheet_core_oo.pdf</a></p>
<head>
   <!-- HTML meta refresh URL redirection -->
   <meta http-equiv="refresh"
   content="0; url=https://cdn.jsdelivr.net/gh/SpinalHDL/SpinalDoc@master/cheatsheet/cheatSheet_core_oo.pdf">
</head></section>
<span id="document-SpinalHDL/Getting Started/Cheatsheets/lib"></span><section id="lib">
<h4>Lib<a class="headerlink" href="#lib" title="Permalink to this heading"></a></h4>
<p>Redirection to <a class="reference external" href="https://github.com/SpinalHDL/SpinalDoc/blob/master/cheatsheet/cheatSheet_lib_oo.pdf">https://github.com/SpinalHDL/SpinalDoc/blob/master/cheatsheet/cheatSheet_lib_oo.pdf</a></p>
<head>
   <!-- HTML meta refresh URL redirection -->
   <meta http-equiv="refresh"
   content="0; url=http://cdn.rawgit.com/SpinalHDL/SpinalDoc/9bab57d16ecd3fce53cb1de9f12b63fdae97f188/cheatsheet/cheatSheet_lib_oo.pdf">
</head></section>
<span id="document-SpinalHDL/Getting Started/Cheatsheets/symbolic"></span><section id="symbolic">
<h4>Symbolic<a class="headerlink" href="#symbolic" title="Permalink to this heading"></a></h4>
<p>Redirection to <a class="reference external" href="https://github.com/SpinalHDL/SpinalDoc/blob/master/cheatsheet/cheatSheet_symbolic.pdf">https://github.com/SpinalHDL/SpinalDoc/blob/master/cheatsheet/cheatSheet_symbolic.pdf</a></p>
<head>
   <!-- HTML meta refresh URL redirection -->
   <meta http-equiv="refresh"
   content="0; url=https://cdn.jsdelivr.net/gh/SpinalHDL/SpinalDoc@master/cheatsheet/cheatSheet_symbolic.pdf">
</head></section>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/Data types/index"></span><section id="data-types">
<span id="type-introduction"></span><h2>Data types<a class="headerlink" href="#data-types" title="Permalink to this heading"></a></h2>
<p>The language provides 5 base types, and 2 composite types that can be used.</p>
<ul class="simple">
<li><p>Base types: <a class="reference internal" href="index.html#bool"><span class="std std-ref">Bool</span></a> , <a class="reference internal" href="index.html#bits"><span class="std std-ref">Bits</span></a> , <a class="reference internal" href="index.html#int"><span class="std std-ref">UInt</span></a> for unsigned integers, <a class="reference internal" href="index.html#int"><span class="std std-ref">SInt</span></a> for signed integers and <a class="reference internal" href="index.html#enum"><span class="std std-ref">Enum</span></a>.</p></li>
<li><p>Composite types: <a class="reference internal" href="index.html#bundle"><span class="std std-ref">Bundle</span></a> and <a class="reference internal" href="index.html#vec"><span class="std std-ref">Vec</span></a>.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/types.svg"><img alt="_images/types.svg" src="_images/types.svg" width="400px" /></a>
<p>In addition to the base types, Spinal has support under development for:</p>
<ul class="simple">
<li><p><a class="reference internal" href="index.html#fixed"><span class="std std-ref">Fixed-point</span></a> numbers (partial support)</p></li>
<li><p><a class="reference internal" href="index.html#afix"><span class="std std-ref">Auto-range Fixed-point</span></a> numbers (add,sub,mul support)</p></li>
<li><p><a class="reference internal" href="index.html#floating"><span class="std std-ref">Floating-point</span></a> numbers (experimental support)</p></li>
</ul>
<p>Additionally, if you want to assign a don’t care value to some hardware, for instance, to provide a default value, you can use the assignDontCare API to do so.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myBits</span><span class="p">.</span><span class="n">assignDontCare</span><span class="p">()</span><span class="w"> </span><span class="c1">// Will assign all the bits to &#39;x&#39;</span>
</pre></div>
</div>
<p>Finally, a special type is available for checking equality between a BitVector and a bit constant pattern that contains
holes defined like a bitmask (bit positions not to be compared by the equality expression).</p>
<p>Here is an example to show how you can achieve this (note the use of ‘M’ prefix) :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">itMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">M</span><span class="s">&quot;00--10--&quot;</span><span class="w"> </span><span class="c1">// - for don&#39;t care value</span>
</pre></div>
</div>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Data types/bool"></span><section id="bool">
<span id="id1"></span><h3>Bool<a class="headerlink" href="#bool" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Bool</span></code> type corresponds to a boolean value (True or False) or a single bit/signal
used in a hardware design.  While named similarly it should not be confused with
Scala <cite>Boolean</cite> type which does not describe hardware but truth values in the Scala
generator code.</p>
<p>An important concept and rule-of-thumb to understand is that the Scala
<cite>Boolean</cite> type is used in places where elaboration-time HDL code-generation
decision making is occurring in Scala code.  Like any regular program it affects
execution of the Scala program that is SpinalHDL at the time the program is
being run to perform HDL code generation.</p>
<p>Therefore the value of a Scala <cite>Boolean</cite> can not be observed from hardware,
because it only exists ahead-of-time in the SpinalHDL program at the time of
HDL code-gen.</p>
<p>In scenarios where you might need this for your design, for example to pass a
value (that maybe acting as a parameterized constant input) from Scala into your
hardware design, you can type convert it to Bool with the constructor <cite>Bool(value: Boolean)</cite>.</p>
<p>Similarly the value of a SpinalHDL <cite>Bool</cite> can not be seen at code-generation, all
that can be seen and manipulated is the HDL construct concerning a <cite>wire</cite> and how it
is routed (through modules/Components), driven (sourced) and connected (sunk).</p>
<p>The signal direction of assignment operators <cite>:=</cite> is managed by SpinalHDL.
The use of the Bool instance on the left-hand-side or the right-hand-side of the
assignment operator <cite>:=</cite> dictates if it is a source (provides state) or sink
(captures state) for a given assignment.</p>
<p>Multiple uses of the assignment operator are allowed, such that it is normal
for a signal to act as a source (provides a value to drive HDL state) to be
able to connect and drive multiple inputs of other HDL constructs.  When a Bool
instance used as a source the order the assignment statements appear or are
executed in Scala does not matter, unlike when it is used as a sink
(captures state).</p>
<p>When multiple assignment operators drive the Bool (the Bool is on the
left-hand-side of the assignment expression), the last assignment
statement wins rule; take effect.  The last would be the last to execute in
Scala code.  This matter can affect the layout and ordering of your SpinalHDL
Scala code to ensure the correct precedence order is archived in the hardware
design for assigning a new state to the Bool in hardware.</p>
<p>It may help to understand the concept with relating the Scala/SpinalHDL
<cite>Bool</cite> instance as a reference to a HDL <cite>net</cite> in the net-list.  Which the
assignment <cite>:=</cite> operator is attaching HDL constructs into the same net.</p>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare a boolean value is as follows: (everything between [] is optional)</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 60%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Bool()</p></td>
<td><p>Create a Bool</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>True</p></td>
<td><p>Create a Bool assigned with <code class="docutils literal notranslate"><span class="pre">true</span></code></p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>False</p></td>
<td><p>Create a Bool assigned with <code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>Bool(value: Boolean)</p></td>
<td><p>Create a Bool assigned with a value from a Scala Boolean type (true, false).
This explicitly converts to <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBool_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w">        </span><span class="c1">// Create a Bool</span>
<span class="n">myBool_1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w">            </span><span class="c1">// := is the assignment operator (like verilog &lt;=)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">myBool_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w">         </span><span class="c1">// Equivalent to the code above</span>

<span class="kd">val</span><span class="w"> </span><span class="n">myBool_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w">  </span><span class="c1">// Use a Scala Boolean to create a Bool</span>
</pre></div>
</div>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Bool</span></code> type:</p>
<section id="logic">
<h5>Logic<a class="headerlink" href="#logic" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>!x</p></td>
<td><p>Logical NOT</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">x &amp;&amp; y</div>
<div class="line">x &amp; y</div>
</div>
</td>
<td><p>Logical AND</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">x || y</div>
<div class="line">x | y</div>
</div>
</td>
<td><p>Logical OR</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x ^ y</p></td>
<td><p>Logical XOR</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>~x</p></td>
<td><p>Logical NOT</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.set[()]</p></td>
<td><p>Set x to True</p></td>
<td><p>Unit (none)</p></td>
</tr>
<tr class="row-even"><td><p>x.clear[()]</p></td>
<td><p>Set x to False</p></td>
<td><p>Unit (none)</p></td>
</tr>
<tr class="row-odd"><td><p>x.setWhen(cond)</p></td>
<td><p>Set x when cond is True</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.clearWhen(cond)</p></td>
<td><p>Clear x when cond is True</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.riseWhen(cond)</p></td>
<td><p>Set x when x is False and cond is True</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.fallWhen(cond)</p></td>
<td><p>Clear x when x is True and cond is True</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">c</span><span class="w">   </span><span class="c1">// ((NOT a) AND b) XOR c</span>

<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w"> </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span><span class="p">.</span><span class="n">set</span><span class="p">()</span><span class="w">                </span><span class="c1">// equivalent to d := True</span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">setWhen</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w">          </span><span class="c1">// equivalent to when(cond) { d := True }</span>

<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"> </span><span class="n">fallWhen</span><span class="p">(</span><span class="n">ack</span><span class="p">)</span><span class="w"> </span><span class="n">setWhen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="cm">/** equivalent to</span>
<span class="cm">  * when(f &amp;&amp; ack) { f := False }</span>
<span class="cm">  * when(req) { f := True }</span>
<span class="cm">  * or</span>
<span class="cm">  * f := req || (f &amp;&amp; !ack)</span>
<span class="cm">  */</span><span class="w"></span>

<span class="c1">// mind the order of assignments!  last one wins</span>
<span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"> </span><span class="n">setWhen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="n">fallWhen</span><span class="p">(</span><span class="n">ack</span><span class="p">)</span><span class="w"></span>
<span class="c1">// equivalent to g := ((!g) &amp;&amp; req) || (g &amp;&amp; !ack)</span>
</pre></div>
</div>
</section>
<section id="edge-detection">
<h5>Edge detection<a class="headerlink" href="#edge-detection" title="Permalink to this heading"></a></h5>
<p>All edge detection functions will instantiate an additional register via <a class="reference internal" href="index.html#regnext"><span class="std std-ref">RegNext</span></a>
to get a delayed value of the <code class="docutils literal notranslate"><span class="pre">Bool</span></code> in question.</p>
<p>This feature does not reconfigure a D-type flip-flop to use an alternative CLK
source, it uses two D-type flip-flop in series chain (with both CLK pins inheriting
the default ClockDomain).  It has combinational logic to perform edge detection
based on the output Q states.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 63%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.edge[()]</p></td>
<td><p>Return True when x changes state</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.edge(initAt: Bool)</p></td>
<td><p>Same as x.edge but with a reset value</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.rise[()]</p></td>
<td><p>Return True when x was low at the last cycle and is now high</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.rise(initAt: Bool)</p></td>
<td><p>Same as x.rise but with a reset value</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.fall[()]</p></td>
<td><p>Return True when x was high at the last cycle and is now low</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.fall(initAt: Bool)</p></td>
<td><p>Same as x.fall but with a reset value</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.edges[()]</p></td>
<td><p>Return a bundle (rise, fall, toggle)</p></td>
<td><p>BoolEdges</p></td>
</tr>
<tr class="row-odd"><td><p>x.edges(initAt: Bool)</p></td>
<td><p>Same as x.edges but with a reset value</p></td>
<td><p>BoolEdges</p></td>
</tr>
<tr class="row-even"><td><p>x.toggle[()]</p></td>
<td><p>Return True at every edge</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">myBool_1</span><span class="p">.</span><span class="n">rise</span><span class="p">(</span><span class="nc">False</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// do something when a rising edge is detected</span>
<span class="p">}</span><span class="w"></span>


<span class="kd">val</span><span class="w"> </span><span class="n">edgeBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBool_2</span><span class="p">.</span><span class="n">edges</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">edgeBundle</span><span class="p">.</span><span class="n">rise</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// do something when a rising edge is detected</span>
<span class="p">}</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">edgeBundle</span><span class="p">.</span><span class="n">fall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// do something when a falling edge is detected</span>
<span class="p">}</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">edgeBundle</span><span class="p">.</span><span class="n">toggle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// do something at each edge</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">myBool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Equivalent to when(myBool === True)</span>
<span class="w">    </span><span class="c1">// do something when myBool is True</span>
<span class="p">}</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="o">!</span><span class="n">myBool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Equivalent to when(myBool === False)</span>
<span class="w">    </span><span class="c1">// do something when myBool is False</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(1 bit)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asUInt</p></td>
<td><p>Binary cast to UInt</p></td>
<td><p>UInt(1 bit)</p></td>
</tr>
<tr class="row-even"><td><p>x.asSInt</p></td>
<td><p>Binary cast to SInt</p></td>
<td><p>SInt(1 bit)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asUInt(bitCount)</p></td>
<td><p>Binary cast to UInt and resize, putting Bool value in LSB and padding
with zeros.</p></td>
<td><p>UInt(bitCount bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asBits(bitCount)</p></td>
<td><p>Binary cast to Bits and resize, putting Bool value in LSB and padding
with zeros.</p></td>
<td><p>Bits(bitCount bits)</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Add the carry to an SInt value</span>
<span class="kd">val</span><span class="w"> </span><span class="n">carry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mySInt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">carry</span><span class="p">.</span><span class="n">asSInt</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="misc">
<h5>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x ## y</p></td>
<td><p>Concatenate, x-&gt;high, y-&gt;low</p></td>
<td><p>Bits(w(x) + w(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x #* n</p></td>
<td><p>Repeat x n-times</p></td>
<td><p>Bits(n bits)</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="c1">// Concatenation of three Bool into a single Bits(3 bits) type</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="maskedboolean">
<h5>MaskedBoolean<a class="headerlink" href="#maskedboolean" title="Permalink to this heading"></a></h5>
<p>A masked boolean allows don’t care values. They are usually not used on their own but through <a class="reference internal" href="index.html#maskedliteral"><span class="std std-ref">MaskedLiteral</span></a>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// first argument: Scala Boolean value</span>
<span class="c1">// second argument: do we care ? expressed as a Scala Boolean</span>
<span class="kd">val</span><span class="w"> </span><span class="n">masked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MaskedBoolean</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/bits"></span><section id="bits">
<span id="id1"></span><h3>Bits<a class="headerlink" href="#bits" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Bits</span></code> type is a vector of bits without conveying any arithmetic meaning.</p>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare a bit vector is as follows (everything between [] is optional):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Bits [()]</p></td>
<td><p>Create Bits, bit count is inferred from the widest assignment statement
after construction</p></td>
</tr>
<tr class="row-odd"><td><p>Bits(x bits)</p></td>
<td><p>Create Bits with x bits</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">B(value: Int[, x bits])</div>
<div class="line">B(value: BigInt[, x bits])</div>
</div>
</td>
<td><p>Create Bits with x bits assigned with ‘value’</p></td>
</tr>
<tr class="row-odd"><td><p>B”[[size’]base]value”</p></td>
<td><p>Create Bits assigned with ‘value’ (base: ‘h’, ‘d’, ‘o’, ‘b’)</p></td>
</tr>
<tr class="row-even"><td><p>B([x bits,] elements: Element*)</p></td>
<td><p>Create Bits assigned with the value specified by <a class="reference internal" href="index.html#element"><span class="std std-ref">elements</span></a></p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBits1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;8&#39;xFF&quot;</span><span class="w">   </span><span class="c1">// Base could be x,h (base 16)</span>
<span class="w">                         </span><span class="c1">//               d   (base 10)</span>
<span class="w">                         </span><span class="c1">//               o   (base 8)</span>
<span class="w">                         </span><span class="c1">//               b   (base 2)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;1001_0011&quot;</span><span class="w">  </span><span class="c1">// _ can be used for readability</span>

<span class="c1">// Bits with all ones (&quot;11111111&quot;)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>

<span class="c1">// initialize with &quot;10111000&quot; through a few elements</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;101&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>

<span class="c1">// &quot;10000000&quot; (For assignment purposes, you can omit the B)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myBits7</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>When inferring the width of a <code class="docutils literal notranslate"><span class="pre">Bits</span></code> the sizes of assigned values still have to match
the final size of the signal:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Declaration</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">()</span><span class="w">     </span><span class="c1">// the size is inferred from the widest assignment</span>
<span class="c1">// ....</span>
<span class="c1">// .resized needed to prevent WIDTH MISMATCH error as the constants</span>
<span class="c1">// width does not match size that is inferred from assignment below</span>
<span class="n">myBits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="s">&quot;1010&quot;</span><span class="p">).</span><span class="n">resized</span><span class="w">  </span><span class="c1">// auto-widen Bits(4 bits) to Bits(6 bits)</span>
<span class="n">when</span><span class="p">(</span><span class="n">condxMaybe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Bits(6 bits) is inferred for myBits, this is the widest assignment</span>
<span class="w">  </span><span class="n">myBits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="s">&quot;110000&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Bits</span></code> type:</p>
<section id="logic">
<h5>Logic<a class="headerlink" href="#logic" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 43%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>~x</p></td>
<td><p>Bitwise NOT</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &amp; y</p></td>
<td><p>Bitwise AND</p></td>
<td><p>Bits(w(xy) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x | y</p></td>
<td><p>Bitwise OR</p></td>
<td><p>Bits(w(xy) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x ^ y</p></td>
<td><p>Bitwise XOR</p></td>
<td><p>Bits(w(xy) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.xorR</p></td>
<td><p>XOR all bits of x</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.orR</p></td>
<td><p>OR all bits of x</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.andR</p></td>
<td><p>AND all bits of x</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">y = 1 // Int</div>
<div class="line">x &gt;&gt; y</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Logical shift right, y: Int</div>
<div class="line">Result may reduce width</div>
</div>
</td>
<td><p>Bits(w(x) - y bits)</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">y = U(1) // UInt</div>
<div class="line">x &gt;&gt; y</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Logical shift right, y: UInt</div>
<div class="line">Result is same width</div>
</div>
</td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">y = 1 // Int</div>
<div class="line">x &lt;&lt; y</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Logical shift left, y: Int</div>
<div class="line">Result may increase width</div>
</div>
</td>
<td><p>Bits(w(x) + y bits)</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">y = U(1) // UInt</div>
<div class="line">x &lt;&lt; y</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Logical shift left, y: UInt</div>
<div class="line">Result may increase width</div>
</div>
</td>
<td><p>Bits(w(x) + max(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x |&gt;&gt; y</p></td>
<td><div class="line-block">
<div class="line">Logical shift right, y: Int/UInt</div>
<div class="line">Result is same width</div>
</div>
</td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x |&lt;&lt; y</p></td>
<td><div class="line-block">
<div class="line">Logical shift left, y: Int/UInt</div>
<div class="line">Result is same width</div>
</div>
</td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.rotateLeft(y)</p></td>
<td><div class="line-block">
<div class="line">Logical left rotation, y: UInt/Int</div>
<div class="line">Result is same width</div>
</div>
</td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.rotateRight(y)</p></td>
<td><div class="line-block">
<div class="line">Logical right rotation, y: UInt/Int</div>
<div class="line">Result is same width</div>
</div>
</td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.clearAll[()]</p></td>
<td><p>Clear all bits</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
<tr class="row-even"><td><p>x.setAll[()]</p></td>
<td><p>Set all bits</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
<tr class="row-odd"><td><p>x.setAllTo(value: Boolean)</p></td>
<td><p>Set all bits to the given Boolean value</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
<tr class="row-even"><td><p>x.setAllTo(value: Bool)</p></td>
<td><p>Set all bits to the given Bool value</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Bitwise operator</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="c1">// Inverse(a AND b)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">all_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">andR</span><span class="w"> </span><span class="c1">// Check that all bits are equal to 1</span>

<span class="c1">// Logical shift</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bits_10bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bits_8bits</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">// shift left (results in 10 bits)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">shift_8bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bits_8bits</span><span class="w"> </span><span class="o">|&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">// shift left (results in 8 bits)</span>

<span class="c1">// Logical rotation</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bits_8bits</span><span class="p">.</span><span class="n">rotateLeft</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// left bit rotation</span>

<span class="c1">// Set/clear</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;8&#39;x42&quot;</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">setAll</span><span class="p">()</span><span class="w"> </span><span class="c1">// set all bits to True when cond is True</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">myBits</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">notMySpecialValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_32</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;32&#39;x44332211&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asUInt</p></td>
<td><p>Binary cast to UInt</p></td>
<td><p>UInt(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asSInt</p></td>
<td><p>Binary cast to SInt</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asBools</p></td>
<td><p>Cast to an array of Bools</p></td>
<td><p>Vec(Bool(), w(x))</p></td>
</tr>
<tr class="row-even"><td><p>x.asBool</p></td>
<td><p>Extract LSB of <code class="code docutils literal notranslate"><span class="pre">x</span></code></p></td>
<td><p>Bool(x.lsb)</p></td>
</tr>
<tr class="row-odd"><td><p>B(x: T)</p></td>
<td><p>Cast Data to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
</tbody>
</table>
<p>To cast a <code class="docutils literal notranslate"><span class="pre">Bool</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt</span></code> or an <code class="docutils literal notranslate"><span class="pre">SInt</span></code> into a <code class="docutils literal notranslate"><span class="pre">Bits</span></code>, you can use <code class="docutils literal notranslate"><span class="pre">B(something)</span></code> or <code class="docutils literal notranslate"><span class="pre">B(something[,</span> <span class="pre">x</span> <span class="pre">bits])</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// cast a Bits to SInt</span>
<span class="kd">val</span><span class="w"> </span><span class="n">mySInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="p">.</span><span class="n">asSInt</span><span class="w"></span>

<span class="c1">// create a Vector of bool</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="p">.</span><span class="n">asBools</span><span class="w"></span>

<span class="c1">// Cast a SInt to Bits</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">mySInt</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Cast the same SInt to Bits but resize to 3 bits</span>
<span class="c1">//  (will expand/truncate as necessary, retaining LSB)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">mySInt</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bit-extraction">
<h5>Bit extraction<a class="headerlink" href="#bit-extraction" title="Permalink to this heading"></a></h5>
<p>All of the bit extraction operations can be used to read a bit / group of bits. Like in other HDLs
the extraction operators can also be used to assign a part of a <code class="docutils literal notranslate"><span class="pre">Bits</span></code>.</p>
<p>All of the bit extraction operations can be used to read a bit / group of bits. Like in other HDLs They
can also be used to select a range of bits to be written.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x(y: Int)</p></td>
<td><p>Static bit access of y-th bit</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x(y: UInt)</p></td>
<td><p>Variable bit access of y-th bit</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x(offset: Int, width bits)</p></td>
<td><p>Fixed part select of fixed width, offset is LSB index</p></td>
<td><p>Bits(width bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x(offset: UInt, width bits)</p></td>
<td><p>Variable part-select of fixed width, offset is LSB index</p></td>
<td><p>Bits(width bits)</p></td>
</tr>
<tr class="row-even"><td><p>x(range: Range)</p></td>
<td><p>Access a <a class="reference internal" href="index.html#range"><span class="std std-ref">range</span></a> of bits. Ex : myBits(4 downto 2)</p></td>
<td><p>Bits(range.size bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.subdivideIn(y slices, [strict: Boolean])</p></td>
<td><p>Subdivide x into y slices, y: Int</p></td>
<td><p>Vec(Bits(…), y)</p></td>
</tr>
<tr class="row-even"><td><p>x.subdivideIn(y bits, [strict: Boolean])</p></td>
<td><p>Subdivide x in multiple slices of y bits, y: Int</p></td>
<td><p>Vec(Bits(y bit), …)</p></td>
</tr>
<tr class="row-odd"><td><p>x.msb</p></td>
<td><p>Access most significant bit of x (highest index)</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.lsb</p></td>
<td><p>Access lowest significant bit of x (index 0)</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<p>Some basic examples:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// get the element at the index 4</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="c1">// assign element 1</span>
<span class="n">myBits</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>

<span class="c1">// index dynamically</span>
<span class="kd">val</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>

<span class="c1">// range index</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits_8bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_16bit</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits_7bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_16bit</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits_6bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_16bit</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<span class="c1">// assign to myBits_16bit(3 downto 0)</span>
<span class="n">myBits_8bit</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myBits_4bit</span><span class="w"></span>

<span class="c1">// equivalent slices, no reversing occurs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_16bit</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_16bit</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// read / assign the msb / leftmost bit / x.high bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">isNegative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_16bit</span><span class="p">.</span><span class="n">msb</span><span class="w"></span>
<span class="n">myBits_16bit</span><span class="p">.</span><span class="n">msb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
</pre></div>
</div>
<section id="subdivide-details">
<h6>Subdivide details<a class="headerlink" href="#subdivide-details" title="Permalink to this heading"></a></h6>
<p>Both overloads of <code class="docutils literal notranslate"><span class="pre">subdivideIn</span></code> have an optional parameter <code class="docutils literal notranslate"><span class="pre">strict</span></code> (i.e. <code class="docutils literal notranslate"><span class="pre">subdivideIn(slices:</span> <span class="pre">SlicesCount,</span> <span class="pre">strict:</span> <span class="pre">Boolean</span> <span class="pre">=</span> <span class="pre">true)</span></code>).
If <code class="docutils literal notranslate"><span class="pre">strict</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> an error will be raised if the input could not be divided into equal parts. If set to <code class="docutils literal notranslate"><span class="pre">false</span></code> the last element may
be smaller than the other (equal sized) elements.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Subdivide</span>
<span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBitsWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_128bits</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)(</span><span class="n">sel</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// sel = 3 =&gt; myBitsWord = myBits_128bits(127 downto 96)</span>
<span class="w">    </span><span class="c1">// sel = 2 =&gt; myBitsWord = myBits_128bits( 95 downto 64)</span>
<span class="w">    </span><span class="c1">// sel = 1 =&gt; myBitsWord = myBits_128bits( 63 downto 32)</span>
<span class="w">    </span><span class="c1">// sel = 0 =&gt; myBitsWord = myBits_128bits( 31 downto  0)</span>

<span class="w"> </span><span class="c1">// If you want to access in reverse order you can do:</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">myVector</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">myBits_128bits</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">).</span><span class="n">reverse</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">myRevBitsWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myVector</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"></span>

<span class="w"> </span><span class="c1">// We can also assign through subdivides</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">output8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">pieces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output8</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">slices</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="c1">// assign to output8</span>
<span class="w"> </span><span class="n">pieces</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xf</span><span class="w"></span>
<span class="w"> </span><span class="n">pieces</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x5</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="misc">
<h5>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h5>
<p>In contrast to the bit extraction operations listed above it’s not possible
to use the return values to assign to the original signal.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.getWidth</p></td>
<td><p>Return bitcount</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-odd"><td><p>x.bitsRange</p></td>
<td><p>Return the range (0 to x.high)</p></td>
<td><p>Range</p></td>
</tr>
<tr class="row-even"><td><p>x.valueRange</p></td>
<td><p>Return the range of minimum to maximum x values, interpreted as an unsigned integer (0 to 2 ** width - 1).</p></td>
<td><p>Range</p></td>
</tr>
<tr class="row-odd"><td><p>x.high</p></td>
<td><p>Return the index of the MSB (highest allowed zero-based index for x)</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-even"><td><p>x.reversed</p></td>
<td><p>Return a copy of x with reverse bit order, MSB&lt;&gt;LSB are mirrored.</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x ## y</p></td>
<td><p>Concatenate, x-&gt;high, y-&gt;low</p></td>
<td><p>Bits(w(x) + w(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x #* n</p></td>
<td><p>Repeat x n-times</p></td>
<td><p>Bits(w(x) * n bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.resize(y)</p></td>
<td><p>Return a resized representation of x, if enlarged, it is extended with zero
padding at MSB as necessary, y: Int</p></td>
<td><p>Bits(y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.resized</p></td>
<td><p>Return a version of x which is allowed to be automatically resized were
needed.  The resize operation is deferred until the point of assignment later.
The resize may widen or truncate, retaining the LSB.</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.resizeLeft(x)</p></td>
<td><p>Resize by keeping MSB at the same place, x:Int
The resize may widen or truncate, retaining the MSB.</p></td>
<td><p>Bits(x bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.getZero</p></td>
<td><p>Return a new instance of Bits that is assigned a constant value of zeros the same width as x.</p></td>
<td><p>Bits(0, w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.getAllTrue</p></td>
<td><p>Return a new instance of Bits that is assigned a constant value of ones the same width as x.</p></td>
<td><p>Bits(w(x) bits).setAll()</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><cite>validRange</cite> can only be used for types where the minimum and maximum values fit into a signed
32-bit integer. (This is a limitation given by the Scala <code class="docutils literal notranslate"><span class="pre">scala.collection.immutable.Range</span></code>
type which uses <cite>Int</cite>)</p>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">println</span><span class="p">(</span><span class="n">myBits_32bits</span><span class="p">.</span><span class="n">getWidth</span><span class="p">)</span><span class="w"> </span><span class="c1">// 32</span>

<span class="c1">// Concatenation</span>
<span class="n">myBits_24bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">bits_8bits_1</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">bits_8bits_2</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">bits_8bits_3</span><span class="w"></span>
<span class="c1">// or</span>
<span class="n">myBits_24bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="n">bits_8bits_1</span><span class="p">,</span><span class="w"> </span><span class="n">bits_8bits_2</span><span class="p">,</span><span class="w"> </span><span class="n">bits_8bits_3</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Resize</span>
<span class="n">myBits_32bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;32&#39;x112233344&quot;</span><span class="w"></span>
<span class="n">myBits_8bits</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">myBits_32bits</span><span class="p">.</span><span class="n">resized</span><span class="w">       </span><span class="c1">// automatic resize (myBits_8bits = 0x44)</span>
<span class="n">myBits_8bits</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">myBits_32bits</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">     </span><span class="c1">// resize to 8 bits (myBits_8bits = 0x44)</span>
<span class="n">myBits_8bits</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">myBits_32bits</span><span class="p">.</span><span class="n">resizeLeft</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="c1">// resize to 8 bits (myBits_8bits = 0x11)</span>
</pre></div>
</div>
</section>
</section>
<section id="maskedliteral">
<span id="id2"></span><h4>MaskedLiteral<a class="headerlink" href="#maskedliteral" title="Permalink to this heading"></a></h4>
<p>MaskedLiteral values are bit vectors with don’t care values denoted with <code class="docutils literal notranslate"><span class="pre">-</span></code>.
They can be used for direct comparison or for <code class="docutils literal notranslate"><span class="pre">switch</span></code> statements and <code class="docutils literal notranslate"><span class="pre">mux</span></code> es.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">B</span><span class="s">&quot;1101&quot;</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">M</span><span class="s">&quot;1-01&quot;</span><span class="w"> </span><span class="c1">// True</span>
<span class="kd">val</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">M</span><span class="s">&quot;0---&quot;</span><span class="w"> </span><span class="c1">// False</span>
<span class="kd">val</span><span class="w"> </span><span class="n">test3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">M</span><span class="s">&quot;1--1&quot;</span><span class="w"> </span><span class="c1">// True</span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Data types/Int"></span><section id="uint-sint">
<span id="int"></span><h3>UInt/SInt<a class="headerlink" href="#uint-sint" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt</span></code> types are vectors of bits interpreted as two’s complement unsigned/signed integers.
They can do what <code class="docutils literal notranslate"><span class="pre">Bits</span></code> can do, with the addition of unsigned/signed integer arithmetic and comparisons.</p>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare an integer is as follows:  (everything between [] is optional)</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">UInt[()]</div>
<div class="line">SInt[()]</div>
</div>
</td>
<td><p>Create an unsigned/signed integer, bits count is inferred</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">UInt(x bits)</div>
<div class="line">SInt(x bits)</div>
</div>
</td>
<td><p>Create an unsigned/signed integer with x bits</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">U(value: Int[,x bits])</div>
<div class="line">U(value: BigInt[,x bits])</div>
<div class="line">S(value: Int[,x bits])</div>
<div class="line">S(value: BigInt[,x bits])</div>
</div>
</td>
<td><p>Create an unsigned/signed integer assigned with ‘value’</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">U”[[size’]base]value”</div>
<div class="line">S”[[size’]base]value”</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create an unsigned/signed integer assigned with ‘value’</div>
<div class="line">(base: ‘h’, ‘d’, ‘o’, ‘b’)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">U([x bits,] elements: Element*)</div>
<div class="line">S([x bits,] elements: Element*)</div>
</div>
</td>
<td><p>Create an unsigned integer assigned with the value specified by <a class="reference internal" href="index.html#element"><span class="std std-ref">elements</span></a></p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;0000_0101&quot;</span><span class="w">  </span><span class="c1">// Base per default is binary =&gt; 5</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;h1A&quot;</span><span class="w">        </span><span class="c1">// Base could be x (base 16)</span>
<span class="w">                        </span><span class="c1">//               h (base 16)</span>
<span class="w">                        </span><span class="c1">//               d (base 10)</span>
<span class="w">                        </span><span class="c1">//               o (base 8)</span>
<span class="w">                        </span><span class="c1">//               b (base 2)</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;8&#39;h1A&quot;</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w">             </span><span class="c1">// You can use a Scala Int as a literal value</span>

<span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="n">myUInt</span><span class="p">.</span><span class="n">range</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>

<span class="c1">// For assignment purposes, you can omit the U/S</span>
<span class="c1">// which also allows the use of &quot;default -&gt; ???&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">                        </span><span class="c1">// Assign myUInt with &quot;11111111&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">myUInt</span><span class="p">.</span><span class="n">range</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">                   </span><span class="c1">// Assign myUInt with &quot;11111111&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">            </span><span class="c1">// Assign myUInt with &quot;10000000&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">((</span><span class="mi">4</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="c1">// Assign myUInt with &quot;00011110&quot;</span>
</pre></div>
</div>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">UInt</span></code> and <code class="docutils literal notranslate"><span class="pre">SInt</span></code> types:</p>
<section id="logic">
<h5>Logic<a class="headerlink" href="#logic" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>~x</p></td>
<td><p>Bitwise NOT</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &amp; y</p></td>
<td><p>Bitwise AND</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x | y</p></td>
<td><p>Bitwise OR</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x ^ y</p></td>
<td><p>Bitwise XOR</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.xorR</p></td>
<td><p>XOR all bits of x (reduction operator)</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.orR</p></td>
<td><p>OR all bits of x (reduction operator)</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.andR</p></td>
<td><p>AND all bits of x (reduction operator)</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;&gt; y</p></td>
<td><p>Arithmetic shift right, y : Int</p></td>
<td><p>T(w(x) - y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x &gt;&gt; y</p></td>
<td><p>Arithmetic shift right, y : UInt</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &lt;&lt; y</p></td>
<td><p>Arithmetic shift left, y : Int</p></td>
<td><p>T(w(x) + y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x &lt;&lt; y</p></td>
<td><p>Arithmetic shift left, y : UInt</p></td>
<td><p>T(w(x) + max(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x |&gt;&gt; y</p></td>
<td><p>Logical shift right, y : Int/UInt</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x |&lt;&lt; y</p></td>
<td><p>Logical shift left, y : Int/UInt</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.rotateLeft(y)</p></td>
<td><div class="line-block">
<div class="line">Logical left rotation, y : UInt/Int</div>
<div class="line">The width of y is constrained to the width of log2Up(x) or less</div>
</div>
</td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.rotateRight(y)</p></td>
<td><div class="line-block">
<div class="line">Logical right rotation, y : UInt/Int</div>
<div class="line">The width of y is constrained to the width of log2Up(x) or less</div>
</div>
</td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.clearAll[()]</p></td>
<td><p>Clear all bits</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
<tr class="row-even"><td><p>x.setAll[()]</p></td>
<td><p>Set all bits</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
<tr class="row-odd"><td><p>x.setAllTo(value : Boolean)</p></td>
<td><p>Set all bits to the given Boolean value</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
<tr class="row-even"><td><p>x.setAllTo(value : Bool)</p></td>
<td><p>Set all bits to the given Bool value</p></td>
<td><p><em>modifies x</em></p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice the difference in behavior between <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;&gt;</span> <span class="pre">2</span></code> (result 2 bit narrower than x) and <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;&gt;</span> <span class="pre">U(2)</span></code> (keeping width)
due to the Scala type of <code class="code docutils literal notranslate"><span class="pre">y</span></code>.</p>
<p>In the first case “2” is an <code class="docutils literal notranslate"><span class="pre">Int</span></code> (which can be seen as an
“elaboration integer constant”), and in the second case it is a hardware signal
(type <code class="docutils literal notranslate"><span class="pre">UInt</span></code>) that may or may not be a constant.</p>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">S</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">S</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Bitwise operators</span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">     </span><span class="c1">// Inverse(a AND b)</span>
<span class="n">assert</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">getWidth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Shift</span>
<span class="kd">val</span><span class="w"> </span><span class="n">arithShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w">      </span><span class="c1">// shift left (resulting in 10 bits)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">logicShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">|&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w">     </span><span class="c1">// shift left (resulting in 8 bits)</span>
<span class="n">assert</span><span class="p">(</span><span class="n">arithShift</span><span class="p">.</span><span class="n">getWidth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">logicShift</span><span class="p">.</span><span class="n">getWidth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Rotation</span>
<span class="kd">val</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="n">rotateLeft</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">// left bit rotation</span>
<span class="n">assert</span><span class="p">(</span><span class="n">rotated</span><span class="p">.</span><span class="n">getWidth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Set all bits of b to True when all bits of a are True</span>
<span class="n">when</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">andR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">setAll</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="arithmetic">
<h5>Arithmetic<a class="headerlink" href="#arithmetic" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x + y</p></td>
<td><p>Addition</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x +^ y</p></td>
<td><p>Addition with carry</p></td>
<td><p>T(max(w(x), w(y)) + 1 bits)</p></td>
</tr>
<tr class="row-even"><td><p>x +| y</p></td>
<td><p>Addition of addend with <a class="reference external" href="https://en.wikipedia.org/wiki/Saturation_arithmetic">saturation</a> (see also <cite>T.maxValue</cite> and <cite>T.minValue</cite>)</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x - y</p></td>
<td><p>Subtraction</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x -^ y</p></td>
<td><p>Subtraction with carry</p></td>
<td><p>T(max(w(x), w(y)) + 1 bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x -| y</p></td>
<td><p>Subtraction of subtrahend with <a class="reference external" href="https://en.wikipedia.org/wiki/Saturation_arithmetic">saturation</a> (see also <cite>T.minValue</cite> and <cite>T.maxValue</cite>)</p></td>
<td><p>T(max(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x * y</p></td>
<td><p>Multiplication</p></td>
<td><p>T(w(x) + w(y)) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x / y</p></td>
<td><p>Division</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x % y</p></td>
<td><p>Modulo</p></td>
<td><p>T(min(w(x), w(y)) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>~x</p></td>
<td><p>Unary One’s compliment, Bitwise NOT</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>-x</p></td>
<td><p>Unary Two’s compliment of SInt type.  Not available for UInt.</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;xf0&quot;</span><span class="w"></span>
<span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;x0f&quot;</span><span class="w"></span>

<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;8&#39;xff&quot;</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+^</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;9&#39;x0ff&quot;</span><span class="p">)</span><span class="w"></span>

<span class="c1">// 0xf0 + 0x20 would overflow, the result therefore saturates</span>
<span class="kd">val</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+|</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;8&#39;x20&quot;</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;8&#39;xff&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice how simulation assertions are made here (with <code class="docutils literal notranslate"><span class="pre">===</span></code>), as opposed to elaboration
assertions in the previous example (with <code class="docutils literal notranslate"><span class="pre">==</span></code>).</p>
</div>
</section>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x &gt; y</p></td>
<td><p>Greater than</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;= y</p></td>
<td><p>Greater than or equal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x &lt; y</p></td>
<td><p>Less than</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &lt;= y</p></td>
<td><p>Less than or equal</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;10&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">elsewhen</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;01&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">elsewhen</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="p">.</span><span class="n">setAll</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="p">.</span><span class="n">clearAll</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When comparing <code class="docutils literal notranslate"><span class="pre">UInt</span></code> values in a way that allows for “wraparound” behavior, meaning that the values will “wrap around” to the minimum value when they exceed the maximum value.
The <code class="docutils literal notranslate"><span class="pre">wrap</span></code> method of <code class="docutils literal notranslate"><span class="pre">UInt</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">x.wrap</span> <span class="pre">&lt;</span> <span class="pre">y</span></code> for <code class="docutils literal notranslate"><span class="pre">UInt</span></code> variables <code class="docutils literal notranslate"><span class="pre">x,</span> <span class="pre">y</span></code>, the result will be true if <code class="docutils literal notranslate"><span class="pre">x</span></code> is less than <code class="docutils literal notranslate"><span class="pre">y</span></code> in the wraparound sense.</p>
</div>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asUInt</p></td>
<td><p>Binary cast to UInt</p></td>
<td><p>UInt(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asSInt</p></td>
<td><p>Binary cast to SInt</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asBools</p></td>
<td><p>Cast into a array of Bool</p></td>
<td><p>Vec(Bool(), w(x))</p></td>
</tr>
<tr class="row-even"><td><p>x.asBool</p></td>
<td><p>Extract LSB of <code class="code docutils literal notranslate"><span class="pre">x</span></code></p></td>
<td><p>Bool(x.lsb)</p></td>
</tr>
<tr class="row-odd"><td><p>S(x: T)</p></td>
<td><p>Cast a Data into a SInt</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>U(x: T)</p></td>
<td><p>Cast a Data into an UInt</p></td>
<td><p>UInt(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.intoSInt</p></td>
<td><p>Convert to SInt expanding sign bit</p></td>
<td><p>SInt(w(x) + 1 bits)</p></td>
</tr>
<tr class="row-even"><td><p>myUInt.twoComplement(en: Bool)</p></td>
<td><p>Generate two’s complement of number if <code class="docutils literal notranslate"><span class="pre">en</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, unchanged otherwise. (<code class="docutils literal notranslate"><span class="pre">en</span></code> makes result negative)</p></td>
<td><p>SInt(w(myUInt) + 1, bits)</p></td>
</tr>
<tr class="row-odd"><td><p>mySInt.abs</p></td>
<td><p>Return the absolute value as a UInt value</p></td>
<td><p>UInt(w(mySInt) bits)</p></td>
</tr>
<tr class="row-even"><td><p>mySInt.abs(en: Bool)</p></td>
<td><p>Return the absolute value as a UInt value when <code class="docutils literal notranslate"><span class="pre">en</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, otherwise just reinterpret bits as unsigned</p></td>
<td><p>UInt(w(mySInt) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>mySInt.absWithSym</p></td>
<td><p>Return the absolute value of the UInt value with symmetric, shrink 1 bit</p></td>
<td><p>UInt(w(mySInt) - 1 bits)</p></td>
</tr>
</tbody>
</table>
<p>To cast a <code class="docutils literal notranslate"><span class="pre">Bool</span></code>, a <code class="docutils literal notranslate"><span class="pre">Bits</span></code>, or an <code class="docutils literal notranslate"><span class="pre">SInt</span></code> into a <code class="docutils literal notranslate"><span class="pre">UInt</span></code>, you can use <code class="docutils literal notranslate"><span class="pre">U(something)</span></code>. To cast things into an <code class="docutils literal notranslate"><span class="pre">SInt</span></code>, you can use <code class="docutils literal notranslate"><span class="pre">S(something)</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Cast an SInt to Bits</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mySInt</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>

<span class="c1">// Create a Vector of Bool</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt</span><span class="p">.</span><span class="n">asBools</span><span class="w"></span>

<span class="c1">// Cast a Bits to SInt</span>
<span class="kd">val</span><span class="w"> </span><span class="n">mySInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">S</span><span class="p">(</span><span class="n">myBits</span><span class="p">)</span><span class="w"></span>

<span class="c1">// UInt to SInt conversion</span>
<span class="kd">val</span><span class="w"> </span><span class="n">uInt_30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">sInt_30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uint_30</span><span class="p">.</span><span class="n">intoSInt</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">sInt_30</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">S</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"></span>

<span class="n">mySInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">uInt_30</span><span class="p">.</span><span class="n">twoComplement</span><span class="p">(</span><span class="n">booleanDoInvert</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if booleanDoInvert is True then we get S(-30, 9 bit)</span>
<span class="w">    </span><span class="c1">// otherwise we get S(30, 9 bit)</span>

<span class="c1">// absolute values</span>
<span class="kd">val</span><span class="w"> </span><span class="n">sInt_n_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">S</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">abs_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sInt_n_3</span><span class="p">.</span><span class="n">abs</span><span class="p">(</span><span class="n">booleanDoAbs</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if booleanDoAbs is True we get U(3, 3 bit)</span>
<span class="w">    </span><span class="c1">// otherwise we get U&quot;3&#39;b101&quot; or U(5, 3 bit) (raw bit pattern of -3)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">sInt_n_128</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">S</span><span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">abs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sInt_n_128</span><span class="p">.</span><span class="n">abs</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">abs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">sym_abs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sInt_n_128</span><span class="p">.</span><span class="n">absWithSym</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">sym_abs</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bit-extraction">
<h5>Bit extraction<a class="headerlink" href="#bit-extraction" title="Permalink to this heading"></a></h5>
<p>All of the bit extraction operations can be used to read a bit / group of bits. Like in other HDLs
the extraction operators can also be used to assign a part of a <code class="docutils literal notranslate"><span class="pre">UInt</span></code> / <code class="docutils literal notranslate"><span class="pre">SInt</span></code> .</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x(y: Int)</p></td>
<td><p>Static bit access of y-th bit</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x(y: UInt)</p></td>
<td><p>Variable bit access of y-th bit</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x(offset: Int, width bits)</p></td>
<td><p>Fixed part select of fixed width, offset is LSB index</p></td>
<td><p>Bits(width bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x(offset: UInt, width bits)</p></td>
<td><p>Variable part-select of fixed width, offset is LSB index</p></td>
<td><p>Bits(width bits)</p></td>
</tr>
<tr class="row-even"><td><p>x(range: Range)</p></td>
<td><p>Access a <a class="reference internal" href="index.html#range"><span class="std std-ref">range</span></a> of bits. Ex : myBits(4 downto 2)</p></td>
<td><p>Bits(range.size bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.subdivideIn(y slices, [strict: Boolean])</p></td>
<td><p>Subdivide x into y slices, y: Int</p></td>
<td><p>Vec(Bits(…), y)</p></td>
</tr>
<tr class="row-even"><td><p>x.subdivideIn(y bits, [strict: Boolean])</p></td>
<td><p>Subdivide x in multiple slices of y bits, y: Int</p></td>
<td><p>Vec(Bits(y bit), …)</p></td>
</tr>
<tr class="row-odd"><td><p>x.msb</p></td>
<td><p>Access most significant bit of x (highest index, sign bit for SInt)</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.lsb</p></td>
<td><p>Access lowest significant bit of x (index 0)</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>mySInt.sign</p></td>
<td><p>Access most sign bit, only SInt</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<p>Some basic examples:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// get the element at the index 4</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="c1">// assign element 1</span>
<span class="n">myUInt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>

<span class="c1">// index dynamically</span>
<span class="kd">val</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>

<span class="c1">// range index</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myUInt_8bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_16bit</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myUInt_7bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_16bit</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myUInt_6bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_16bit</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<span class="c1">// assign to myUInt_16bit(3 downto 0)</span>
<span class="n">myUInt_8bit</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt_4bit</span><span class="w"></span>

<span class="c1">// equivalent slices, no reversing occurs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_16bit</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_16bit</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// read / assign the msb / leftmost bit / x.high bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">isNegative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mySInt_16bit</span><span class="p">.</span><span class="n">sign</span><span class="w"></span>
<span class="n">myUInt_16bit</span><span class="p">.</span><span class="n">msb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
</pre></div>
</div>
<section id="subdivide-details">
<h6>Subdivide details<a class="headerlink" href="#subdivide-details" title="Permalink to this heading"></a></h6>
<p>Both overloads of <code class="docutils literal notranslate"><span class="pre">subdivideIn</span></code> have an optional parameter <code class="docutils literal notranslate"><span class="pre">strict</span></code> (i.e. <code class="docutils literal notranslate"><span class="pre">subdivideIn(slices:</span> <span class="pre">SlicesCount,</span> <span class="pre">strict:</span> <span class="pre">Boolean</span> <span class="pre">=</span> <span class="pre">true)</span></code>).
If <code class="docutils literal notranslate"><span class="pre">strict</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> an error will be raised if the input could not be divided into equal parts. If set to <code class="docutils literal notranslate"><span class="pre">false</span></code> the last element may
be smaller than the other (equal sized) elements.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Subdivide</span>
<span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myUIntWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_128bits</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)(</span><span class="n">sel</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// sel = 3 =&gt; myUIntWord = myUInt_128bits(127 downto 96)</span>
<span class="w">    </span><span class="c1">// sel = 2 =&gt; myUIntWord = myUInt_128bits( 95 downto 64)</span>
<span class="w">    </span><span class="c1">// sel = 1 =&gt; myUIntWord = myUInt_128bits( 63 downto 32)</span>
<span class="w">    </span><span class="c1">// sel = 0 =&gt; myUIntWord = myUInt_128bits( 31 downto  0)</span>

<span class="w"> </span><span class="c1">// If you want to access in reverse order you can do:</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">myVector</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_128bits</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">).</span><span class="n">reverse</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">myRevUIntWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myVector</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"></span>

<span class="w"> </span><span class="c1">// We can also assign through subdivides</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">output8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">pieces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output8</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">slices</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="c1">// assign to output8</span>
<span class="w"> </span><span class="n">pieces</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xf</span><span class="w"></span>
<span class="w"> </span><span class="n">pieces</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x5</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="misc">
<h5>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h5>
<p>In contrast to the bit extraction operations listed above it’s not possible
to use the return values to assign to the original signal.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 63%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.getWidth</p></td>
<td><p>Return bitcount</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-odd"><td><p>x.high</p></td>
<td><p>Return the index of the MSB (highest allowed index for Int)</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-even"><td><p>x.bitsRange</p></td>
<td><p>Return the range (0 to x.high)</p></td>
<td><p>Range</p></td>
</tr>
<tr class="row-odd"><td><p>x.minValue</p></td>
<td><p>Lowest possible value of x (e.g. 0 for UInt)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-even"><td><p>x.maxValue</p></td>
<td><p>Highest possible value of x</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-odd"><td><p>x.valueRange</p></td>
<td><p>Return the range from minimum to maximum possible value of x (x.minValue to x.maxValue).</p></td>
<td><p>Range</p></td>
</tr>
<tr class="row-even"><td><p>x ## y</p></td>
<td><p>Concatenate, x-&gt;high, y-&gt;low</p></td>
<td><p>Bits(w(x) + w(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x #* n</p></td>
<td><p>Repeat x n-times</p></td>
<td><p>Bits(w(x) * n bits)</p></td>
</tr>
<tr class="row-even"><td><p>x &#64;&#64; y</p></td>
<td><p>Concatenate x:T with y:Bool/SInt/UInt</p></td>
<td><p>T(w(x) + w(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.resize(y)</p></td>
<td><div class="line-block">
<div class="line">Return a resized copy of x, if enlarged, it is filled with zero</div>
<div class="line">for UInt or filled with the sign for SInt, y: Int</div>
</div>
</td>
<td><p>T(y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.resized</p></td>
<td><div class="line-block">
<div class="line">Return a version of x which is allowed to be automatically</div>
<div class="line">resized where needed</div>
</div>
</td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.expand</p></td>
<td><p>Return x with 1 bit expand</p></td>
<td><p>T(w(x)+1 bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.getZero</p></td>
<td><p>Return a new instance of type T that is assigned a constant value of zeros the same width as x.</p></td>
<td><p>T(0, w(x) bits).clearAll()</p></td>
</tr>
<tr class="row-odd"><td><p>x.getAllTrue</p></td>
<td><p>Return a new instance of type T that is assigned a constant value of ones the same width as x.</p></td>
<td><p>T(w(x) bits).setAll()</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><cite>validRange</cite> can only be used for types where the minimum and maximum values fit into a signed
32-bit integer. (This is a limitation given by the Scala <code class="docutils literal notranslate"><span class="pre">scala.collection.immutable.Range</span></code>
type which uses <cite>Int</cite>)</p>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mySInt</span><span class="p">.</span><span class="n">lsb</span><span class="w">  </span><span class="c1">// equivalent to mySInt(0)</span>

<span class="c1">// Concatenation</span>
<span class="kd">val</span><span class="w"> </span><span class="n">mySInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mySInt_1</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">mySInt_1</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">myBool</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mySInt_1</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">mySInt_1</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">myBool</span><span class="w"></span>

<span class="c1">// Resize</span>
<span class="n">myUInt_32bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;32&#39;x112233344&quot;</span><span class="w"></span>
<span class="n">myUInt_8bits</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt_32bits</span><span class="p">.</span><span class="n">resized</span><span class="w">      </span><span class="c1">// automatic resize (myUInt_8bits = 0x44)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">lowest_8bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myUInt_32bits</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="c1">// resize to 8 bits (myUInt_8bits = 0x44)</span>
</pre></div>
</div>
</section>
</section>
<section id="fixpoint-operations">
<h4>FixPoint operations<a class="headerlink" href="#fixpoint-operations" title="Permalink to this heading"></a></h4>
<p>For fixpoint, we can divide it into two parts:</p>
<blockquote>
<div><ul class="simple">
<li><p>Lower bit operations (rounding methods)</p></li>
<li><p>High bit operations (saturation operations)</p></li>
</ul>
</div></blockquote>
<section id="lower-bit-operations">
<h5>Lower bit operations<a class="headerlink" href="#lower-bit-operations" title="Permalink to this heading"></a></h5>
<img alt="_images/lowerBitOperation.png" src="_images/lowerBitOperation.png" />
<p>About Rounding: <a class="reference external" href="https://en.wikipedia.org/wiki/Rounding">https://en.wikipedia.org/wiki/Rounding</a></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">Spinal HDL</div>
<div class="line">name</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Wikipedia</div>
<div class="line">name</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">API</div>
<div class="line"><br /></div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Mathematic</div>
<div class="line">Algorithm</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">return</div>
<div class="line">(align=false)</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Sup-</div>
<div class="line">port</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FLOOR</p></td>
<td><p>RoundDown</p></td>
<td><p>floor</p></td>
<td><p>floor(x)</p></td>
<td><p>w(x)-n bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>FLOORTOZERO</p></td>
<td><p>RoundToZero</p></td>
<td><p>floorToZero</p></td>
<td><p>sign*floor(abs(x))</p></td>
<td><p>w(x)-n bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>CEIL</p></td>
<td><p>RoundUp</p></td>
<td><p>ceil</p></td>
<td><p>ceil(x)</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>CEILTOINF</p></td>
<td><p>RoundToInf</p></td>
<td><p>ceilToInf</p></td>
<td><p>sign*ceil(abs(x))</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>ROUNDUP</p></td>
<td><p>RoundHalfUp</p></td>
<td><p>roundUp</p></td>
<td><p>floor(x+0.5)</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>ROUNDDOWN</p></td>
<td><p>RoundHalfDown</p></td>
<td><p>roundDown</p></td>
<td><p>ceil(x-0.5)</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>ROUNDTOZERO</p></td>
<td><p>RoundHalfToZero</p></td>
<td><p>roundToZero</p></td>
<td><p>sign*ceil(abs(x)-0.5)</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>ROUNDTOINF</p></td>
<td><p>RoundHalfToInf</p></td>
<td><p>roundToInf</p></td>
<td><p>sign*floor(abs(x)+0.5)</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>ROUNDTOEVEN</p></td>
<td><p>RoundHalfToEven</p></td>
<td><p>roundToEven</p></td>
<td></td>
<td></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>ROUNDTOODD</p></td>
<td><p>RoundHalfToOdd</p></td>
<td><p>roundToOdd</p></td>
<td></td>
<td></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <strong>RoundToEven</strong> and <strong>RoundToOdd</strong> modes are very special, and are used in some big data statistical fields
with high accuracy concerns, SpinalHDL doesn’t support them yet.</p>
</div>
<p>You will find <code class="docutils literal notranslate"><span class="pre">ROUNDUP</span></code>, <code class="docutils literal notranslate"><span class="pre">ROUNDDOWN</span></code>, <code class="docutils literal notranslate"><span class="pre">ROUNDTOZERO</span></code>, <code class="docutils literal notranslate"><span class="pre">ROUNDTOINF</span></code>, <code class="docutils literal notranslate"><span class="pre">ROUNDTOEVEN</span></code>, <code class="docutils literal notranslate"><span class="pre">ROUNTOODD</span></code> are very close in behavior,
<code class="docutils literal notranslate"><span class="pre">ROUNDTOINF</span></code> is the most common. The behavior of rounding in different programming languages may be different.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>language</p></th>
<th class="head"><p>default-RoundType</p></th>
<th class="head"><p>example</p></th>
<th class="head"><p>comments</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Matlab</p></td>
<td><p>ROUNDTOINF</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(1.5)</span> <span class="pre">==</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(2.5)</span> <span class="pre">==</span> <span class="pre">3</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(-1.5)</span> <span class="pre">==</span> <span class="pre">-2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(-2.5)</span> <span class="pre">==</span> <span class="pre">-3</span></code></div>
</div>
</td>
<td><p>round to ±Infinity</p></td>
</tr>
<tr class="row-odd"><td><p>python2</p></td>
<td><p>ROUNDTOINF</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(1.5)</span> <span class="pre">==</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(2.5)</span> <span class="pre">==</span> <span class="pre">3</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(-1.5)</span> <span class="pre">==</span> <span class="pre">-2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(-2.5)</span> <span class="pre">==</span> <span class="pre">-3</span></code></div>
</div>
</td>
<td><p>round to ±Infinity</p></td>
</tr>
<tr class="row-even"><td><p>python3</p></td>
<td><p>ROUNDTOEVEN</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(1.5)</span> <span class="pre">==</span> <span class="pre">round(2.5)</span> <span class="pre">==</span> <span class="pre">2</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(-1.5)</span> <span class="pre">==</span> <span class="pre">round(-2.5)</span> <span class="pre">==</span> <span class="pre">-2</span></code></div>
</div>
</td>
<td><p>close to Even</p></td>
</tr>
<tr class="row-odd"><td><p>Scala.math</p></td>
<td><p>ROUNDTOUP</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(1.5)</span> <span class="pre">==</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(2.5)</span> <span class="pre">==</span> <span class="pre">3</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(-1.5)</span> <span class="pre">==</span> <span class="pre">-1</span></code>, <code class="docutils literal notranslate"><span class="pre">round(-2.5)</span> <span class="pre">==</span> <span class="pre">-2</span></code></div>
</div>
</td>
<td><p>always to +Infinity</p></td>
</tr>
<tr class="row-even"><td><p>SpinalHDL</p></td>
<td><p>ROUNDTOINF</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(1.5)</span> <span class="pre">==</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(2.5)</span> <span class="pre">==</span> <span class="pre">3</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">round(-1.5)</span> <span class="pre">==</span> <span class="pre">-2</span></code>, <code class="docutils literal notranslate"><span class="pre">round(-2.5)</span> <span class="pre">==</span> <span class="pre">-3</span></code></div>
</div>
</td>
<td><p>round to ±Infinity</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In SpinalHDL <cite>ROUNDTOINF</cite> is the default RoundType (<code class="docutils literal notranslate"><span class="pre">round</span> <span class="pre">=</span> <span class="pre">roundToInf</span></code>)</p>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundToInf</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">         </span><span class="c1">// default &#39;align = false&#39; with carry, got 11 bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundToInf</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// sat 1 carry bit, got 10 bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">              </span><span class="c1">// return 10 bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">floorToZero</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">        </span><span class="c1">// return 10 bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">               </span><span class="c1">// ceil with carry so return 11 bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// ceil with carry then sat 1 bit return 10 bit</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ceilToInf</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundUp</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundDown</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundToInf</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundToZero</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">              </span><span class="c1">// SpinalHDL uses roundToInf as the default rounding mode</span>

<span class="kd">val</span><span class="w"> </span><span class="n">b0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundToInf</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">         </span><span class="c1">//  ---+</span>
<span class="w">                                                    </span><span class="c1">//     |--&gt; equal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">roundToInf</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">).</span><span class="n">sat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">//  ---+</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only <code class="docutils literal notranslate"><span class="pre">floor</span></code> and <code class="docutils literal notranslate"><span class="pre">floorToZero</span></code> work without the <code class="docutils literal notranslate"><span class="pre">align</span></code> option; they do not need a carry bit. Other rounding operations default to using a carry bit.</p>
</div>
<p><strong>round Api</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>UInt/SInt</p></th>
<th class="head"><p>description</p></th>
<th class="head"><p>Return(align=false)</p></th>
<th class="head"><p>Return(align=true)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>floor</p></td>
<td><p>Both</p></td>
<td></td>
<td><p>w(x)-n   bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-odd"><td><p>floorToZero</p></td>
<td><p>SInt</p></td>
<td><p>equal to floor in UInt</p></td>
<td><p>w(x)-n   bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-even"><td><p>ceil</p></td>
<td><p>Both</p></td>
<td></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-odd"><td><p>ceilToInf</p></td>
<td><p>SInt</p></td>
<td><p>equal to ceil in UInt</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-even"><td><p>roundUp</p></td>
<td><p>Both</p></td>
<td><p>simple for HW</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-odd"><td><p>roundDown</p></td>
<td><p>Both</p></td>
<td></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-even"><td><p>roundToInf</p></td>
<td><p>SInt</p></td>
<td><p>most Common</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-odd"><td><p>roundToZero</p></td>
<td><p>SInt</p></td>
<td><p>equal to roundDown in UInt</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
<tr class="row-even"><td><p>round</p></td>
<td><p>Both</p></td>
<td><p>SpinalHDL chose roundToInf</p></td>
<td><p>w(x)-n+1 bits</p></td>
<td><p>w(x)-n bits</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Although <code class="docutils literal notranslate"><span class="pre">roundToInf</span></code> is very common, <code class="docutils literal notranslate"><span class="pre">roundUp</span></code> has the least cost and good timing, with almost no performance loss.
As a result, <code class="docutils literal notranslate"><span class="pre">roundUp</span></code> is strongly recommended for production use.</p>
</div>
</section>
<section id="high-bit-operations">
<h5>High bit operations<a class="headerlink" href="#high-bit-operations" title="Permalink to this heading"></a></h5>
<img alt="_images/highBitOperation.png" src="_images/highBitOperation.png" />
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>function</p></th>
<th class="head"><p>Operation</p></th>
<th class="head"><p>Positive-Op</p></th>
<th class="head"><p>Negative-Op</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>sat</p></td>
<td><p>Saturation</p></td>
<td><p>when(Top[w-1, w-n].orR) set maxValue</p></td>
<td><p>When(Top[w-1, w-n].andR) set minValue</p></td>
</tr>
<tr class="row-odd"><td><p>trim</p></td>
<td><p>Discard</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-even"><td><p>symmetry</p></td>
<td><p>Symmetric</p></td>
<td><p>N/A</p></td>
<td><p>minValue = -maxValue</p></td>
</tr>
</tbody>
</table>
<p>Symmetric is only valid for <code class="docutils literal notranslate"><span class="pre">SInt</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">sat</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">      </span><span class="c1">// return 5 bits with saturated highest 3 bits</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">sat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">           </span><span class="c1">// equal to sat(3 bits)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">trim</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">     </span><span class="c1">// return 5 bits with the highest 3 bits discarded</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">trim</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">     </span><span class="c1">// return 5 bits with the highest 3 bits discarded</span>
<span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">symmetry</span><span class="w">         </span><span class="c1">// return 8 bits and symmetry as (-128~127 to -127~127)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">sat</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">symmetry</span><span class="w">  </span><span class="c1">// return 5 bits and symmetry as (-16~15 to -15~15)</span>
</pre></div>
</div>
</section>
<section id="fixto-function">
<h5>fixTo function<a class="headerlink" href="#fixto-function" title="Permalink to this heading"></a></h5>
<p>Two ways are provided in <code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt</span></code> to do fixpoint:</p>
<img alt="_images/fixPoint.png" src="_images/fixPoint.png" />
<p><code class="docutils literal notranslate"><span class="pre">fixTo</span></code> is strongly recommended in your RTL work, you don’t need to handle carry bit alignment and bit width calculations manually like <strong>Way1</strong> in the above diagram.</p>
<p>Factory Fix function with Auto Saturation:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Function</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fixTo(section, roundType, symmetric)</p></td>
<td><p>Factory FixFunction</p></td>
<td><p>section.size bits</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fixTo</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// default RoundType.ROUNDTOINF, sym = false</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fixTo</span><span class="p">(</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDUP</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fixTo</span><span class="p">(</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">CEIL</span><span class="p">,</span><span class="w">       </span><span class="n">sym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fixTo</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDTOINF</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fixTo</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">FLOOR</span><span class="p">)</span><span class="w"> </span><span class="c1">// floor 3 bit, sat 5 bit @ highest</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fixTo</span><span class="p">(</span><span class="mi">20</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">FLOOR</span><span class="p">)</span><span class="w"> </span><span class="c1">// floor 3 bit, expand 2 bit @ highest</span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/enum"></span><section id="spinalenum">
<span id="enum"></span><h3>SpinalEnum<a class="headerlink" href="#spinalenum" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Enumeration</span></code> type corresponds to a list of named values.</p>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The declaration of an enumerated data type is as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">Enumeration</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">element0</span><span class="p">,</span><span class="w"> </span><span class="n">element1</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">elementN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>For the example above, the default encoding is used.
The native enumeration type is used for VHDL and a binary encoding is used for Verilog.</p>
<p>The enumeration encoding can be forced by defining the enumeration as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">Enumeration</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="p">(</span><span class="n">defaultEncoding</span><span class="o">=</span><span class="n">encodingOfYourChoice</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">element0</span><span class="p">,</span><span class="w"> </span><span class="n">element1</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">elementN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to define an enumeration as in/out for a given component, you have to do as following: <code class="docutils literal notranslate"><span class="pre">in(MyEnum())</span></code> or <code class="docutils literal notranslate"><span class="pre">out(MyEnum())</span></code></p>
</div>
<section id="encoding">
<h5>Encoding<a class="headerlink" href="#encoding" title="Permalink to this heading"></a></h5>
<p>The following enumeration encodings are supported:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Encoding</p></th>
<th class="head"><p>Bit width</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">native</span></code></p></td>
<td></td>
<td><p>Use the VHDL enumeration system, this is the default encoding</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">binarySequential</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">log2Up(stateCount)</span></code></p></td>
<td><p>Use Bits to store states in declaration order (value from 0 to n-1)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">binaryOneHot</span></code></p></td>
<td><p>stateCount</p></td>
<td><p>Use Bits to store state. Each bit corresponds to one state, only one
bit is set at a time in the hardware encoded state representation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">graySequential</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">log2Up(stateCount)</span></code></p></td>
<td><p>Encode index (numbers as if using <code class="docutils literal notranslate"><span class="pre">binarySequential</span></code>) as binary gray code.</p></td>
</tr>
</tbody>
</table>
<p>Custom encodings can be performed in two different ways: static or dynamic.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Static encoding</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">object</span><span class="w"> </span><span class="nc">MyEnumStatic</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">e0</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="n">e3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">defaultEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalEnumEncoding</span><span class="p">(</span><span class="s">&quot;staticEncoding&quot;</span><span class="p">)(</span><span class="w"></span>
<span class="w">    </span><span class="n">e0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">e1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">e2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">e3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * Dynamic encoding with the function :  _ * 2 + 1</span>
<span class="cm"> *   e.g. : e0 =&gt; 0 * 2 + 1 = 1</span>
<span class="cm"> *          e1 =&gt; 1 * 2 + 1 = 3</span>
<span class="cm"> *          e2 =&gt; 2 * 2 + 1 = 5</span>
<span class="cm"> *          e3 =&gt; 3 * 2 + 1 = 7</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalEnumEncoding</span><span class="p">(</span><span class="s">&quot;dynamicEncoding&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">MyEnumDynamic</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">e0</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="n">e3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="example">
<h5>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h5>
<p>Instantiate an enumerated signal and assign a value to it:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sIdle</span><span class="p">,</span><span class="w"> </span><span class="n">sStart</span><span class="p">,</span><span class="w"> </span><span class="n">sData</span><span class="p">,</span><span class="w"> </span><span class="n">sParity</span><span class="p">,</span><span class="w"> </span><span class="n">sStop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">stateNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">()</span><span class="w"></span>
<span class="n">stateNext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">sIdle</span><span class="w"></span>

<span class="c1">// You can also import the enumeration to have visibility of its elements</span>
<span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">_</span>
<span class="n">stateNext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sIdle</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Enumeration</span></code> type:</p>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">stateNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">()</span><span class="w"></span>
<span class="n">stateNext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sIdle</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">stateNext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">sStart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">switch</span><span class="p">(</span><span class="n">stateNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">sIdle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">sStart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="types">
<h5>Types<a class="headerlink" href="#types" title="Permalink to this heading"></a></h5>
<p>In order to use your enums, for example in a function, you may need its type.</p>
<p>The value type (e.g. sIdle’s type) is</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spinal</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">SpinalEnumElement</span><span class="p">[</span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="k">type</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>or equivalently</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="nc">E</span><span class="w"></span>
</pre></div>
</div>
<p>The bundle type (e.g. stateNext’s type) is</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spinal</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">SpinalEnumCraft</span><span class="p">[</span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="k">type</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>or equivalently</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="nc">C</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asBits.asUInt</p></td>
<td><p>Binary cast to UInt</p></td>
<td><p>UInt(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asBits.asSInt</p></td>
<td><p>Binary cast to SInt</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>e.assignFromBits(bits)</p></td>
<td><p>Bits cast to enum</p></td>
<td><p>MyEnum()</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">stateNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">()</span><span class="w"></span>
<span class="n">myBits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sIdle</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>

<span class="n">stateNext</span><span class="p">.</span><span class="n">assignFromBits</span><span class="p">(</span><span class="n">myBits</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/bundle"></span><section id="bundle">
<span id="id1"></span><h3>Bundle<a class="headerlink" href="#bundle" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> is a composite type that defines a group of named signals (of any SpinalHDL basic type) under a single name.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> can be used to model data structures, buses, and interfaces.</p>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare a bundle is as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">myBundle</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bundleItem0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AnyType</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bundleItem1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AnyType</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bundleItemN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AnyType</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>For example, a bundle holding a color could be defined as:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can find an <a class="reference internal" href="index.html#example-apb3"><span class="std std-ref">APB3 definition</span></a> among the <a class="reference internal" href="index.html#example-list"><span class="std std-ref">Spinal HDL examples</span></a>.</p>
<section id="conditional-signals">
<h5>Conditional signals<a class="headerlink" href="#conditional-signals" title="Permalink to this heading"></a></h5>
<p>The signals in the <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> can be defined conditionally.
Unless <code class="docutils literal notranslate"><span class="pre">dataWidth</span></code> is greater than 0, there will be no <code class="docutils literal notranslate"><span class="pre">data</span></code> signal in elaborated <code class="docutils literal notranslate"><span class="pre">myBundle</span></code>, as demonstrated in the example below.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">myBundle</span><span class="p">(</span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See also <a class="reference internal" href="index.html#generate"><span class="std std-ref">generate</span></a> for information about this SpinalHDL method.</p>
</div>
</section>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> type:</p>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">color1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="n">color1</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">color1</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">color1</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">color2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="n">color2</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">color2</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">color2</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">color1</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">color2</span><span class="w">  </span><span class="c1">// Compare all elements of the bundle</span>
<span class="c1">// is equivalent to:</span>
<span class="c1">// myBool := color1.r === color2.r &amp;&amp; color1.g === color2.g &amp;&amp; color1.b === color2.b</span>
</pre></div>
</div>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">color1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">color1</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
</pre></div>
</div>
<p>The elements of the bundle will be mapped into place in the order in which they are defined, LSB first.
Thus, <code class="docutils literal notranslate"><span class="pre">r</span></code> in <code class="docutils literal notranslate"><span class="pre">color1</span></code> will occupy bits 0 to 8 of <code class="docutils literal notranslate"><span class="pre">myBits</span></code> (LSB), followed by <code class="docutils literal notranslate"><span class="pre">g</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> in that order,
with <code class="docutils literal notranslate"><span class="pre">b.msb</span></code> also being the MSB of the resulting Bits type.</p>
</section>
<section id="convert-bits-back-to-bundle">
<h5>Convert Bits back to Bundle<a class="headerlink" href="#convert-bits-back-to-bundle" title="Permalink to this heading"></a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">.assignFromBits</span></code> operator can be viewed as the reverse of <code class="docutils literal notranslate"><span class="pre">.asBits</span></code>.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.assignFromBits(y)</p></td>
<td><p>Convert Bits (y) to Bundle(x)</p></td>
<td><p>Unit</p></td>
</tr>
<tr class="row-odd"><td><p>x.assignFromBits(y, hi, lo)</p></td>
<td><p>Convert Bits (y) to Bundle(x) with high/low boundary</p></td>
<td><p>Unit</p></td>
</tr>
</tbody>
</table>
<p>The following example saves a Bundle called CommonDataBus into a circular buffer (3rd party memory), reads the Bits out later and converts them back to CommonDataBus format.</p>
<img alt="_images/CommonDataBus.png" src="_images/CommonDataBus.png" />
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TestBundle</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">we</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">     </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">addrWr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">     </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w">  </span><span class="p">(</span><span class="nc">CommonDataBus</span><span class="p">())</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">addrRd</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">     </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="p">(</span><span class="nc">CommonDataBus</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ram3rdParty_1w_1rs</span><span class="w"> </span><span class="p">(</span><span class="nc">G_DATA_WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">dataIn</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="nc">G_ADDR_WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">addrWr</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="nc">G_VENDOR</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Intel_Arria10_M20K&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clk_in</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="n">clockDomain</span><span class="p">.</span><span class="n">readClockWire</span><span class="w"></span>
<span class="w">  </span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clk_out</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="n">clockDomain</span><span class="p">.</span><span class="n">readClockWire</span><span class="w"></span>

<span class="w">  </span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">we</span><span class="w">        </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">we</span><span class="w"></span>
<span class="w">  </span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">addr_wr</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">addrWr</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="w">  </span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">d</span><span class="w">         </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">dataIn</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>

<span class="w">  </span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">addr_rd</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">addrRd</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">dataOut</span><span class="p">.</span><span class="n">assignFromBits</span><span class="p">(</span><span class="n">mm</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">q</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="io-element-direction">
<h4>IO Element direction<a class="headerlink" href="#io-element-direction" title="Permalink to this heading"></a></h4>
<p>When you define a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> inside the IO definition of your component, you need to specify its direction.</p>
<section id="in-out">
<h5>in/out<a class="headerlink" href="#in-out" title="Permalink to this heading"></a></h5>
<p>If all elements of your bundle go in the same direction you can use <code class="docutils literal notranslate"><span class="pre">in(MyBundle())</span></code> or <code class="docutils literal notranslate"><span class="pre">out(MyBundle())</span></code>.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="master-slave">
<h5>master/slave<a class="headerlink" href="#master-slave" title="Permalink to this heading"></a></h5>
<p>If your interface obeys to a master/slave topology, you can use the <code class="docutils literal notranslate"><span class="pre">IMasterSlave</span></code> trait. Then you have to implement the function <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">asMaster(): Unit</span></code> to set the direction of each element from the master’s perspective. Then you can use the <code class="docutils literal notranslate"><span class="pre">master(MyBundle())</span></code> and <code class="docutils literal notranslate"><span class="pre">slave(MyBundle())</span></code> syntax in the IO definition.</p>
<p>There are functions defined as toXXX, such as the <code class="docutils literal notranslate"><span class="pre">toStream</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Flow</span></code> class.
These functions can usually be called by the master side.
In addition, the fromXXX functions are designed for the slave side.
It is common that there are more functions available for the master side than for the slave side.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">HandShake</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">payloadWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// You have to implement this asMaster function.</span>
<span class="w">  </span><span class="c1">// This function should set the direction of each signals from an master point of view</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">HandShake</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">HandShake</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/Vec"></span><section id="vec">
<span id="id1"></span><h3>Vec<a class="headerlink" href="#vec" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">Vec</span></code> is a composite type that defines a group of indexed signals (of any SpinalHDL basic type) under a single name.</p>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare a vector is as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Declaration</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Vec.fill(size: Int)(type: Data)</p></td>
<td><p>Create a vector of <code class="docutils literal notranslate"><span class="pre">size</span></code> elements of type <code class="docutils literal notranslate"><span class="pre">Data</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Vec(x, y, …)</p></td>
<td><div class="line-block">
<div class="line">Create a vector where indexes point to the provided elements.</div>
<div class="line">Does not create new hardware signals.</div>
<div class="line">This constructor supports mixed element width.</div>
</div>
</td>
</tr>
</tbody>
</table>
<section id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a vector of 2 signed integers</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myVecOfSInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">myVecOfSInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w">                   </span><span class="c1">// assignment to populate index 0</span>
<span class="n">myVecOfSInt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myVecOfSInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="c1">// assignment to populate index 1</span>

<span class="c1">// Create a vector of 3 different type elements</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myVecOfMixedUInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myVecOf_xyz_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Iterate on a vector</span>
<span class="k">for</span><span class="p">(</span><span class="n">element</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">myVecOf_xyz_ref</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">element</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="c1">// Assign x, y, z with the value 0</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Map on vector</span>
<span class="n">myVecOfMixedUInt</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// Assign all elements with value 0</span>

<span class="c1">// Assign 3 to the first element of the vector</span>
<span class="n">myVecOf_xyz_ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Vec</span></code> type:</p>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a vector of 2 signed integers</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vec2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">vec1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">vec2</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">vec1</span><span class="w">  </span><span class="c1">// Compare all elements</span>
<span class="c1">// is equivalent to:</span>
<span class="c1">// myBool := vec2(0) === vec1(0) &amp;&amp; vec2(1) === vec1(1)</span>
</pre></div>
</div>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a vector of 2 signed integers</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vec1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="n">myBits_16bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="misc">
<h5>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 63%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.getBitsWidth</p></td>
<td><p>Return the full size of the Vec</p></td>
<td><p>Int</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a vector of 2 signed integers</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vec1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="n">println</span><span class="p">(</span><span class="n">widthOf</span><span class="p">(</span><span class="n">vec1</span><span class="p">))</span><span class="w"> </span><span class="c1">// 16</span>
</pre></div>
</div>
</section>
<section id="lib-helper-functions">
<h5>Lib helper functions<a class="headerlink" href="#lib-helper-functions" title="Permalink to this heading"></a></h5>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You need to import <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">spinal.lib._</span></code> to put these functions in scope.</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 50%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.sCount(condition: T =&gt; Bool)</p></td>
<td><p>Count the number of occurrence matching a given condition in the Vec.</p></td>
<td><p>UInt</p></td>
</tr>
<tr class="row-odd"><td><p>x.sCount(value: T)</p></td>
<td><p>Count the number of occurrence of a value in the Vec.</p></td>
<td><p>UInt</p></td>
</tr>
<tr class="row-even"><td><p>x.sExists(condition: T =&gt; Bool)</p></td>
<td><p>Check if there is a matching condition in the Vec.</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.sContains(value: T)</p></td>
<td><p>Check if there is an element with a given value present in the Vec.</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.sFindFirst(condition: T =&gt; Bool)</p></td>
<td><p>Find the first element matching the given condition in the Vec, return if any index was successfully found and the index of that element.</p></td>
<td><p>(Bool, UInt)</p></td>
</tr>
<tr class="row-odd"><td><p>x.reduceBalancedTree(op: (T, T) =&gt; T)</p></td>
<td><p>Balanced reduce function, to try to minimize the depth of the resulting circuit. <code class="docutils literal notranslate"><span class="pre">op</span></code> should be commutative and associative.</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-even"><td><p>x.shuffle(indexMapping: Int =&gt; Int)</p></td>
<td><p>Shuffle the Vec using a function that maps the old indexes to new ones.</p></td>
<td><p>Vec[T]</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// Create a vector with 4 unsigned integers</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vec1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">4</span><span class="p">)(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="c1">// ... the vector is actually assigned somewhere</span>

<span class="kd">val</span><span class="w"> </span><span class="n">c1</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">sCount</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="c1">// how many values are lower than 128 in vec</span>
<span class="kd">val</span><span class="w"> </span><span class="n">c2</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">sCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// how many values are equal to zero in vec</span>

<span class="kd">val</span><span class="w"> </span><span class="n">b1</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">sExists</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="c1">// is there a element bigger than 250</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b2</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">sContains</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// is there a zero in vec</span>

<span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="n">u1Found</span><span class="p">,</span><span class="w"> </span><span class="n">u1</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="nc">Bool</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">sFindFirst</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="c1">// get the index of the first element lower than 10</span>
<span class="kd">val</span><span class="w"> </span><span class="n">u2</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec1</span><span class="p">.</span><span class="n">reduceBalancedTree</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="c1">// sum all elements together</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The sXXX prefix is used to disambiguate with respect to identically named Scala functions that accept a lambda function as argument.</p>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/Fix"></span><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>SpinalHDL fixed-point support is only partially used/tested, if you find any bugs with it, or you think that some functionality is missing, please create a <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/issues">Github issue</a>. Also, please do not use undocumented features in your code.</p>
</div>
<section id="ufix-sfix">
<span id="fixed"></span><h3>UFix/SFix<a class="headerlink" href="#ufix-sfix" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">UFix</span></code> and <code class="docutils literal notranslate"><span class="pre">SFix</span></code> types correspond to a vector of bits that can be used for fixed-point arithmetic.</p>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare a fixed-point number is as follows:</p>
<section id="unsigned-fixed-point">
<h5>Unsigned Fixed-Point<a class="headerlink" href="#unsigned-fixed-point" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>bit width</p></th>
<th class="head"><p>resolution</p></th>
<th class="head"><p>max</p></th>
<th class="head"><p>min</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>UFix(peak: ExpNumber, resolution: ExpNumber)</p></td>
<td><p>peak-resolution</p></td>
<td><p>2^resolution</p></td>
<td><p>2^peak-2^resolution</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>UFix(peak: ExpNumber, width: BitCount)</p></td>
<td><p>width</p></td>
<td><p>2^(peak-width)</p></td>
<td><p>2^peak-2^(peak-width)</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
</section>
<section id="signed-fixed-point">
<h5>Signed Fixed-Point<a class="headerlink" href="#signed-fixed-point" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>bit width</p></th>
<th class="head"><p>resolution</p></th>
<th class="head"><p>max</p></th>
<th class="head"><p>min</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SFix(peak: ExpNumber, resolution: ExpNumber)</p></td>
<td><p>peak-resolution+1</p></td>
<td><p>2^resolution</p></td>
<td><p>2^peak-2^resolution</p></td>
<td><p>-(2^peak)</p></td>
</tr>
<tr class="row-odd"><td><p>SFix(peak: ExpNumber, width: BitCount)</p></td>
<td><p>width</p></td>
<td><p>2^(peak-width-1)</p></td>
<td><p>2^peak-2^(peak-width-1)</p></td>
<td><p>-(2^peak)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="format">
<h5>Format<a class="headerlink" href="#format" title="Permalink to this heading"></a></h5>
<p>The chosen format follows the usual way of defining fixed-point number format using Q notation. More information can be found on the <a class="reference external" href="https://en.wikipedia.org/wiki/Q_(number_format)">Wikipedia page about the Q number format</a>.</p>
<p>For example Q8.2 will mean a fixed-point number of 8+2 bits, where 8 bits are used for the natural part and 2 bits for the fractional part.
If the fixed-point number is signed, one more bit is used for the sign.</p>
<p>The resolution is defined as being the smallest power of two that can be represented in this number.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To make representing power-of-two numbers less error prone, there is a numeric type in <code class="docutils literal notranslate"><span class="pre">spinal.core</span></code> called <code class="docutils literal notranslate"><span class="pre">ExpNumber</span></code>, which is used for the fixed-point type constructors.
A convenience wrapper exists for this type, in the form of the <code class="docutils literal notranslate"><span class="pre">exp</span></code> function (used in the code samples on this page).</p>
</div>
</section>
<section id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Unsigned Fixed-Point</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">UQ_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UFix</span><span class="p">(</span><span class="n">peak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="c1">// bit width = 8 - (-2) = 10 bits</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">UQ_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UFix</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="nc">UQ_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UFix</span><span class="p">(</span><span class="n">peak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">UQ_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UFix</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Signed Fixed-Point</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">Q_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="n">peak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="c1">// bit width = 8 - (-2) + 1 = 11 bits</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">Q_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="nc">Q_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="n">peak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">Q_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="assignments">
<h4>Assignments<a class="headerlink" href="#assignments" title="Permalink to this heading"></a></h4>
<section id="valid-assignments">
<h5>Valid Assignments<a class="headerlink" href="#valid-assignments" title="Permalink to this heading"></a></h5>
<p>An assignment to a fixed-point value is valid when there is no bit loss. Any bit loss will result in an error.</p>
<p>If the source fixed-point value is too big, the <code class="docutils literal notranslate"><span class="pre">truncated</span></code> function will allow you to resize the source number to match the destination size.</p>
<section id="example">
<h6>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">i16_m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">i16_0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">i8_m2</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">o16_m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">o16_m0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">o14_m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">14</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>

<span class="n">o16_m2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">i16_m2</span><span class="w">            </span><span class="c1">// OK</span>
<span class="n">o16_m0</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">i16_m2</span><span class="w">            </span><span class="c1">// Not OK, Bit loss</span>
<span class="n">o14_m2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">i16_m2</span><span class="w">            </span><span class="c1">// Not OK, Bit loss</span>
<span class="n">o16_m0</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">i16_m2</span><span class="p">.</span><span class="n">truncated</span><span class="w">  </span><span class="c1">// OK, as it is resized to match assignment target</span>
<span class="n">o14_m2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">i16_m2</span><span class="p">.</span><span class="n">truncated</span><span class="w">  </span><span class="c1">// OK, as it is resized to match assignment target</span>
<span class="kd">val</span><span class="w"> </span><span class="n">o18_m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i16_m2</span><span class="p">.</span><span class="n">truncated</span><span class="p">(</span><span class="mi">18</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">o18_22b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i16_m2</span><span class="p">.</span><span class="n">truncated</span><span class="p">(</span><span class="mi">18</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="from-a-scala-constant">
<h5>From a Scala constant<a class="headerlink" href="#from-a-scala-constant" title="Permalink to this heading"></a></h5>
<p>Scala <code class="docutils literal notranslate"><span class="pre">BigInt</span></code> or <code class="docutils literal notranslate"><span class="pre">Double</span></code> types can be used as constants when assigning to <code class="docutils literal notranslate"><span class="pre">UFix</span></code> or <code class="docutils literal notranslate"><span class="pre">SFix</span></code> signals.</p>
<section id="id1">
<h6>Example<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">i4_m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="n">i4_m2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">1.25</span><span class="w">    </span><span class="c1">// Will load 5 in i4_m2.raw</span>
<span class="n">i4_m2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="c1">// Will load 16 in i4_m2.raw</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="raw-value">
<h4>Raw value<a class="headerlink" href="#raw-value" title="Permalink to this heading"></a></h4>
<p>The integer representation of the fixed-point number can be read or written by using the <code class="docutils literal notranslate"><span class="pre">raw</span></code> property.</p>
<section id="id2">
<h5>Example<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">UQ_8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UFix</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="nc">UQ_8_2</span><span class="p">.</span><span class="n">raw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="w">        </span><span class="c1">// Assign the value corresponding to 1.0</span>
<span class="nc">UQ_8_2</span><span class="p">.</span><span class="n">raw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="w">    </span><span class="c1">// Assign the value corresponding to 4.25</span>
</pre></div>
</div>
</section>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">UFix</span></code> type:</p>
<section id="arithmetic">
<h5>Arithmetic<a class="headerlink" href="#arithmetic" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 5%" />
<col style="width: 37%" />
<col style="width: 21%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Returned resolution</p></th>
<th class="head"><p>Returned amplitude</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x + y</p></td>
<td><p>Addition</p></td>
<td><p>Min(x.resolution, y.resolution)</p></td>
<td><p>Max(x.amplitude, y.amplitude)</p></td>
</tr>
<tr class="row-odd"><td><p>x - y</p></td>
<td><p>Subtraction</p></td>
<td><p>Min(x.resolution, y.resolution)</p></td>
<td><p>Max(x.amplitude, y.amplitude)</p></td>
</tr>
<tr class="row-even"><td><p>x * y</p></td>
<td><p>Multiplication</p></td>
<td><p>x.resolution * y.resolution)</p></td>
<td><p>x.amplitude * y.amplitude</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;&gt; y</p></td>
<td><p>Arithmetic shift right, y : Int</p></td>
<td><p>x.amplitude &gt;&gt; y</p></td>
<td><p>x.resolution &gt;&gt; y</p></td>
</tr>
<tr class="row-even"><td><p>x &lt;&lt; y</p></td>
<td><p>Arithmetic shift left, y : Int</p></td>
<td><p>x.amplitude &lt;&lt; y</p></td>
<td><p>x.resolution &lt;&lt; y</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;&gt;| y</p></td>
<td><p>Arithmetic shift right, y : Int</p></td>
<td><p>x.amplitude &gt;&gt; y</p></td>
<td><p>x.resolution</p></td>
</tr>
<tr class="row-even"><td><p>x &lt;&lt;| y</p></td>
<td><p>Arithmetic shift left, y : Int</p></td>
<td><p>x.amplitude &lt;&lt; y</p></td>
<td><p>x.resolution</p></td>
</tr>
</tbody>
</table>
</section>
<section id="comparison">
<h5>Comparison<a class="headerlink" href="#comparison" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x &gt; y</p></td>
<td><p>Greater than</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;= y</p></td>
<td><p>Greater than or equal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x &lt; y</p></td>
<td><p>Less than</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;= y</p></td>
<td><p>Less than or equal</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
</section>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 50%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asUInt</p></td>
<td><p>Binary cast to UInt</p></td>
<td><p>UInt(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asSInt</p></td>
<td><p>Binary cast to SInt</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asBools</p></td>
<td><p>Cast into a array of Bool</p></td>
<td><p>Vec(Bool(),width(x))</p></td>
</tr>
<tr class="row-even"><td><p>x.toUInt</p></td>
<td><p>Return the corresponding UInt (with truncation)</p></td>
<td><p>UInt</p></td>
</tr>
<tr class="row-odd"><td><p>x.toSInt</p></td>
<td><p>Return the corresponding SInt (with truncation)</p></td>
<td><p>SInt</p></td>
</tr>
<tr class="row-even"><td><p>x.toUFix</p></td>
<td><p>Return the corresponding UFix</p></td>
<td><p>UFix</p></td>
</tr>
<tr class="row-odd"><td><p>x.toSFix</p></td>
<td><p>Return the corresponding SFix</p></td>
<td><p>SFix</p></td>
</tr>
</tbody>
</table>
</section>
<section id="misc">
<h5>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 56%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.maxValue</p></td>
<td><p>Return the maximum value storable</p></td>
<td><p>Double</p></td>
</tr>
<tr class="row-odd"><td><p>x.minValue</p></td>
<td><p>Return the minimum value storable</p></td>
<td><p>Double</p></td>
</tr>
<tr class="row-even"><td><p>x.resolution</p></td>
<td><p>x.amplitude * y.amplitude</p></td>
<td><p>Double</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/Floating"></span><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>SpinalHDL floating-point support is under development and only partially used/tested, if you have any bugs with it, or you think that some functionality is missing, please create a <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/issues">Github issue</a>. Also, please do not use undocumented features in your code.</p>
</div>
<section id="floating">
<span id="id1"></span><h3>Floating<a class="headerlink" href="#floating" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Floating</span></code> type corresponds to IEEE-754 encoded numbers. A second type called <code class="docutils literal notranslate"><span class="pre">RecFloating</span></code> helps in simplifying your design by recoding the floating-point value simplify some edge cases in IEEE-754 floating-point.</p>
<p>It’s composed of a sign bit, an exponent field and a mantissa field. The widths of the different fields are defined in the IEEE-754 or de-facto standards.</p>
<p>This type can be used with the following import:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">experimental</span><span class="p">.</span><span class="nn">math</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
<section id="ieee-754-floating-format">
<h5>IEEE-754 floating format<a class="headerlink" href="#ieee-754-floating-format" title="Permalink to this heading"></a></h5>
<p>The numbers are encoded into IEEE-754 <a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_floating_point">floating-point format</a>.</p>
</section>
<section id="recoded-floating-format">
<h5>Recoded floating format<a class="headerlink" href="#recoded-floating-format" title="Permalink to this heading"></a></h5>
<p>Since IEEE-754 has some quirks about denormalized numbers and special values, Berkeley proposed another way of recoding floating-point values.</p>
<p>The mantissa is modified so that denormalized values can be treated the same as the normalized ones.</p>
<p>The exponent field is one bit larger that one of the IEEE-754 number.</p>
<p>The sign bit is kept unchanged between the two encodings.</p>
<p>Examples can be found <a class="reference external" href="https://github.com/ucb-bar/berkeley-hardfloat/blob/master/README.md">here</a></p>
<section id="zero">
<h6>Zero<a class="headerlink" href="#zero" title="Permalink to this heading"></a></h6>
<p>The zero is encoded with the three leading zeros of the exponent field being set to zero.</p>
</section>
<section id="denormalized-values">
<h6>Denormalized values<a class="headerlink" href="#denormalized-values" title="Permalink to this heading"></a></h6>
<p>Denormalized values are encoded in the same way as a normal floating-point number. The mantissa is shifted so that the first one becomes implicit.
The exponent is encoded as 107 (decimal) plus the index of the highest bit set to 1.</p>
</section>
<section id="normalized-values">
<h6>Normalized values<a class="headerlink" href="#normalized-values" title="Permalink to this heading"></a></h6>
<p>The recoded mantissa for normalized values is exactly the same as the original IEEE-754 mantissa. The recoded exponent is encoded as 130 (decimal) plus the original exponent value.</p>
</section>
<section id="infinity">
<h6>Infinity<a class="headerlink" href="#infinity" title="Permalink to this heading"></a></h6>
<p>The recoded mantissa value is treated as don’t care. The recoded exponent three highest bits is 6 (decimal), the rest of the exponent can be treated as don’t care.</p>
</section>
<section id="nan">
<h6>NaN<a class="headerlink" href="#nan" title="Permalink to this heading"></a></h6>
<p>The recoded mantissa for normalized values is exactly the same as the original IEEE-754 mantissa. The recoded exponent three highest bits is 7 (decimal), the rest of the exponent can be treated as don’t care.</p>
</section>
</section>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>The syntax to declare a floating-point number is as follows:</p>
<section id="ieee-754-number">
<h5>IEEE-754 Number<a class="headerlink" href="#ieee-754-number" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Floating(exponentSize: Int, mantissaSize: Int)</p></td>
<td><p>IEEE-754 Floating-point value with a custom exponent and mantissa size</p></td>
</tr>
<tr class="row-odd"><td><p>Floating16()</p></td>
<td><p>IEEE-754 Half precision floating-point number</p></td>
</tr>
<tr class="row-even"><td><p>Floating32()</p></td>
<td><p>IEEE-754 Single precision floating-point number</p></td>
</tr>
<tr class="row-odd"><td><p>Floating64()</p></td>
<td><p>IEEE-754 Double precision floating-point number</p></td>
</tr>
<tr class="row-even"><td><p>Floating128()</p></td>
<td><p>IEEE-754 Quad precision floating-point number</p></td>
</tr>
</tbody>
</table>
</section>
<section id="recoded-floating-point-number">
<h5>Recoded floating-point number<a class="headerlink" href="#recoded-floating-point-number" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RecFloating(exponentSize: Int, mantissaSize: Int)</p></td>
<td><p>Recoded Floating-point value with a custom exponent and mantissa size</p></td>
</tr>
<tr class="row-odd"><td><p>RecFloating16()</p></td>
<td><p>Recoded Half precision floating-point number</p></td>
</tr>
<tr class="row-even"><td><p>RecFloating32()</p></td>
<td><p>Recoded Single precision floating-point number</p></td>
</tr>
<tr class="row-odd"><td><p>RecFloating64()</p></td>
<td><p>Recoded Double precision floating-point number</p></td>
</tr>
<tr class="row-even"><td><p>RecFloating128()</p></td>
<td><p>Recoded Quad precision floating-point number</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="operators">
<h4>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h4>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Floating</span></code> and <code class="docutils literal notranslate"><span class="pre">RecFloating</span></code> types:</p>
<section id="type-cast">
<h5>Type cast<a class="headerlink" href="#type-cast" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 63%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast to Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asBools</p></td>
<td><p>Cast into a array of Bool</p></td>
<td><p>Vec(Bool(),width(x))</p></td>
</tr>
<tr class="row-even"><td><p>x.toUInt(size: Int)</p></td>
<td><p>Return the corresponding UInt (with truncation)</p></td>
<td><p>UInt</p></td>
</tr>
<tr class="row-odd"><td><p>x.toSInt(size: Int)</p></td>
<td><p>Return the corresponding SInt (with truncation)</p></td>
<td><p>SInt</p></td>
</tr>
<tr class="row-even"><td><p>x.fromUInt</p></td>
<td><p>Return the corresponding Floating (with truncation)</p></td>
<td><p>UInt</p></td>
</tr>
<tr class="row-odd"><td><p>x.fromSInt</p></td>
<td><p>Return the corresponding Floating (with truncation)</p></td>
<td><p>SInt</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<span id="document-SpinalHDL/Data types/AFix"></span><section id="afix">
<span id="id1"></span><h3>AFix<a class="headerlink" href="#afix" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>Auto-ranging Fixed-Point, <code class="docutils literal notranslate"><span class="pre">AFix</span></code>, is a fixed-point class which tracks the representable range of values while preforming fixed-point operations.</p>
<p><strong>Warning: Much of this code is still under development. API and function calls may change.</strong></p>
<p>User feedback is appreciated!</p>
</section>
<section id="declaration">
<h4>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h4>
<p>AFix can be created using bit sizes or exponents:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">AFix</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">             </span><span class="c1">// U12.0</span>
<span class="nc">AFix</span><span class="p">(</span><span class="nc">QFormat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">))</span><span class="w"> </span><span class="c1">// U12.0</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">UQ</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">     </span><span class="c1">// U8.4</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">      </span><span class="c1">// U8.4</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">       </span><span class="c1">// U8.4</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">        </span><span class="c1">// U8.-4</span>
<span class="nc">AFix</span><span class="p">(</span><span class="nc">QFormat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">))</span><span class="w"> </span><span class="c1">// U8.4</span>

<span class="nc">AFix</span><span class="p">.</span><span class="nc">S</span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">             </span><span class="c1">// S11.0 + sign</span>
<span class="nc">AFix</span><span class="p">(</span><span class="nc">QFormat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w">  </span><span class="c1">// S11.0 + sign</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">SQ</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">     </span><span class="c1">// S8.4  + sign</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">S</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">      </span><span class="c1">// S8.3  + sign</span>
<span class="nc">AFix</span><span class="p">.</span><span class="nc">S</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">       </span><span class="c1">// S8.4  + sign</span>
<span class="nc">AFix</span><span class="p">(</span><span class="nc">QFormat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w">  </span><span class="c1">// S7.4  + sign</span>
</pre></div>
</div>
<p>These will have representable ranges for all bits.</p>
<p>For example:</p>
<p><code class="docutils literal notranslate"><span class="pre">AFix.U(12</span> <span class="pre">bits)</span></code> will have a range of 0 to 4095.</p>
<p><code class="docutils literal notranslate"><span class="pre">AFix.SQ(8</span> <span class="pre">bits,</span> <span class="pre">4</span> <span class="pre">bits)</span></code> will have a range of -256 (internaly -4096*2^-4) to 255.9375 (internaly 4095*2^-4)</p>
<p><code class="docutils literal notranslate"><span class="pre">AFix.U(8</span> <span class="pre">exp,</span> <span class="pre">4</span> <span class="pre">exp)</span></code> will have a range of 0 to 240 (internaly 15*2^4)</p>
<p>Custom range <code class="docutils literal notranslate"><span class="pre">AFix</span></code> values can be created be directly instantiating the class.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">maxValue</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">minValue</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">exp</span><span class="p">:</span><span class="w"> </span><span class="nc">ExpNumber</span><span class="p">)</span><span class="w"></span>

<span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">     </span><span class="c1">// [0 to 4096, 2^0]</span>
<span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">  </span><span class="c1">// [-256 to 256, 2^-2]</span>
<span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">       </span><span class="c1">// [8 to 16, 2^2]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">maxValue</span></code> and <code class="docutils literal notranslate"><span class="pre">minValue</span></code> stores what backing integer values are representable.
These values represent the true fixed-point value after multiplying by <code class="docutils literal notranslate"><span class="pre">2^exp</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">AFix.U(2</span> <span class="pre">exp,</span> <span class="pre">-1</span> <span class="pre">exp)</span></code> can represent:
<code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">1.5,</span> <span class="pre">2,</span> <span class="pre">2.5,</span> <span class="pre">3,</span> <span class="pre">3.5</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">AFix.S(2</span> <span class="pre">exp,</span> <span class="pre">-2</span> <span class="pre">exp)</span></code> can represent:
<code class="docutils literal notranslate"><span class="pre">-2.0,</span> <span class="pre">-1.75,</span> <span class="pre">-1.5,</span> <span class="pre">-1.25,</span> <span class="pre">-1,</span> <span class="pre">-0.75,</span> <span class="pre">-0.5,</span> <span class="pre">-0.25,</span> <span class="pre">0,</span> <span class="pre">0.25,</span> <span class="pre">0.5,</span> <span class="pre">0.75,</span> <span class="pre">1,</span> <span class="pre">1.25,</span> <span class="pre">1.5,</span> <span class="pre">1.75</span></code></p>
<p>Exponent values greater 0 are allowed and represent values which are larger than 1.</p>
<p><code class="docutils literal notranslate"><span class="pre">AFix.S(2</span> <span class="pre">exp,</span> <span class="pre">1</span> <span class="pre">exp)</span></code> can represent:
<code class="docutils literal notranslate"><span class="pre">-4,</span> <span class="pre">2,</span> <span class="pre">0,</span> <span class="pre">2</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">AFix(8,</span> <span class="pre">16,</span> <span class="pre">2</span> <span class="pre">exp)</span></code> can represent:
<code class="docutils literal notranslate"><span class="pre">32,</span> <span class="pre">36,</span> <span class="pre">40,</span> <span class="pre">44,</span> <span class="pre">48,</span> <span class="pre">52,</span> <span class="pre">56,</span> <span class="pre">60,</span> <span class="pre">64</span></code></p>
<p>Note: <code class="docutils literal notranslate"><span class="pre">AFix</span></code> will use 5 bits to save this type as that can store <code class="docutils literal notranslate"><span class="pre">16</span></code>, its <code class="docutils literal notranslate"><span class="pre">maxValue</span></code>.</p>
</section>
<section id="mathematical-operations">
<h4>Mathematical Operations<a class="headerlink" href="#mathematical-operations" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> supports Addition (<code class="docutils literal notranslate"><span class="pre">+</span></code>), Subtraction (<code class="docutils literal notranslate"><span class="pre">-</span></code>), and Multiplication (<code class="docutils literal notranslate"><span class="pre">*</span></code>) at the hardware level.
Division (<code class="docutils literal notranslate"><span class="pre">\</span></code>) and Modulo (<code class="docutils literal notranslate"><span class="pre">%</span></code>) operators are provided but are not recommended for hardware elaboration.</p>
<p>Operations are preformed as if the <code class="docutils literal notranslate"><span class="pre">AFix</span></code> value is a regular <code class="docutils literal notranslate"><span class="pre">Int</span></code> number.
Signed and unsigned numbers are interoperable. There are no type differences between signed or unsigned values.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Integer and fractional expansion</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AFix</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">          </span><span class="c1">// [   0 (  0.)     to  15 (15.  )]  4 bits, 2^0</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AFix</span><span class="p">.</span><span class="nc">UQ</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// [   0 (  0.)     to  15 ( 3.75)]  4 bits, 2^-2</span>
<span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w">                   </span><span class="c1">// [   0 (  0.)     to  77 (19.25)]  7 bits, 2^-2</span>
<span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="c1">// [-  4 (- 1.25)   to   8 ( 2.00)]  5 bits, 2^-2</span>
<span class="kd">val</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="w">                   </span><span class="c1">// [-308 (-19.3125) to 616 (38.50)] 11 bits, 2^-4</span>

<span class="c1">// Integer without expansion</span>
<span class="kd">val</span><span class="w"> </span><span class="n">aa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="c1">// [8 to 16] 5 bits, 2^-4</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="c1">// [1 to 15] 4 bits, 2^-4</span>
<span class="kd">val</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bb</span><span class="w">                 </span><span class="c1">// [9 to 31] 5 bits, 2^-4</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> supports operations without without range expansion.
It does this by selecting the aligned maximum and minimum ranges from each of the inputs.</p>
<p><code class="docutils literal notranslate"><span class="pre">+|</span></code> Add without expansion.
<code class="docutils literal notranslate"><span class="pre">-|</span></code> Subtract without expansion.</p>
</section>
<section id="inequality-operations">
<h4>Inequality Operations<a class="headerlink" href="#inequality-operations" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> supports standard inequality operations.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">A</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">B</span><span class="w"></span>
<span class="nc">A</span><span class="w"> </span><span class="o">=\=</span><span class="w"> </span><span class="nc">B</span><span class="w"></span>
<span class="nc">A</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nc">B</span><span class="w"></span>
<span class="nc">A</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nc">B</span><span class="w"></span>
<span class="nc">A</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nc">B</span><span class="w"></span>
<span class="nc">A</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nc">B</span><span class="w"></span>
</pre></div>
</div>
<p>Warning: Operations which are out of range at compile time will be optimized out!</p>
</section>
<section id="bitshifting">
<h4>Bitshifting<a class="headerlink" href="#bitshifting" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> supports decimal and bit shifting</p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> Shifts the decimal to the left. Adds to the exponent.
<code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> Shifts the decimal to the right. Subtracts from the exponent.
<code class="docutils literal notranslate"><span class="pre">&lt;&lt;|</span></code> Shifts the bits to the left. Adds fractional zeros.
<code class="docutils literal notranslate"><span class="pre">&gt;&gt;|</span></code> Shifts the bits to the right. Removes fractional bits.</p>
</section>
<section id="saturation-and-rounding">
<h4>Saturation and Rounding<a class="headerlink" href="#saturation-and-rounding" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> implements saturation and all common rounding methods.</p>
<p>Saturation works by saturating the backing value range of an <code class="docutils literal notranslate"><span class="pre">AFix</span></code> value. There are multiple helper functions which
consider the exponent.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="c1">// [0 to 63, 2^-2]</span>
<span class="n">a</span><span class="p">.</span><span class="n">sat</span><span class="p">(</span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">                    </span><span class="c1">// [0 to 63, 2^-2]</span>
<span class="n">a</span><span class="p">.</span><span class="n">sat</span><span class="p">(</span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="n">exp</span><span class="p">)</span><span class="w">            </span><span class="c1">// [0 to 31, 2^-2]</span>
<span class="n">a</span><span class="p">.</span><span class="n">sat</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">AFix</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">exp</span><span class="p">))</span><span class="w">  </span><span class="c1">// [0 to 31, 2^-2]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> rounding modes:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// The following require exp &lt; 0</span>
<span class="p">.</span><span class="n">floor</span><span class="p">()</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="p">.</span><span class="n">truncate</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">ceil</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">floorToZero</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">ceilToInf</span><span class="p">()</span><span class="w"></span>
<span class="c1">// The following require exp &lt; -1</span>
<span class="p">.</span><span class="n">roundHalfUp</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">roundHalfDown</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">roundHalfToZero</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">roundHalfToInf</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">roundHalfToEven</span><span class="p">()</span><span class="w"></span>
<span class="p">.</span><span class="n">roundHalfToOdd</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>A mathematical example of these rounding modes is better explained here: <a class="reference external" href="https://en.wikipedia.org/wiki/Rounding">Rounding - Wikipedia</a></p>
<p>All of these modes will result in an <code class="docutils literal notranslate"><span class="pre">AFix</span></code> value with 0 exponent. If rounding to a different exponent is required
consider shifting or use an assignment with the <code class="docutils literal notranslate"><span class="pre">truncated</span></code> tag.</p>
</section>
<section id="assignment">
<h4>Assignment<a class="headerlink" href="#assignment" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">AFix</span></code> will automatically check and expand range and precision during assignment. By default, it is an error to assign
an <code class="docutils literal notranslate"><span class="pre">AFix</span></code> value to another <code class="docutils literal notranslate"><span class="pre">AFix</span></code> value with smaller range or precision.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.truncated</span></code> function is used to control how assignments to smaller types.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">truncated</span><span class="p">(</span><span class="n">saturation</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">overflow</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">rounding</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nc">RoundType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">FLOOR</span><span class="p">)</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">saturated</span><span class="p">():</span><span class="w"> </span><span class="nc">AFix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">truncated</span><span class="p">(</span><span class="n">saturation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">overflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">RoundType</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">RoundType</span><span class="p">.</span><span class="nc">FLOOR</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">CEIL</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">FLOORTOZERO</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">CEILTOINF</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDUP</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDDOWN</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDTOZERO</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDTOINF</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDTOEVEN</span><span class="w"></span>
<span class="nc">RoundType</span><span class="p">.</span><span class="nc">ROUNDTOODD</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">saturation</span></code> flag will add logic to saturate to the assigned datatype range.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">overflow</span></code> flag will allow assignment directly after rounding without range checking.</p>
<p>Rounding is always required when assigning a value with more precision to one with lower precision.</p>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Structuring/index"></span><section id="structuring">
<h2>Structuring<a class="headerlink" href="#structuring" title="Permalink to this heading"></a></h2>
<p>The chapters below explain:</p>
<ul class="simple">
<li><p>how to build reusable components</p></li>
<li><p>alternatives to components to group hardware</p></li>
<li><p>handling of clock/reset domains</p></li>
<li><p>instantiation of existing VHDL and Verilog IP</p></li>
<li><p>how names are assigned in SpinalHDL, and how naming can be influenced</p></li>
</ul>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Structuring/components_hierarchy"></span><section id="components-and-hierarchy">
<span id="component"></span><h3>Components and hierarchy<a class="headerlink" href="#components-and-hierarchy" title="Permalink to this heading"></a></h3>
<p>Like in VHDL and Verilog, you can define components that can be used to build a design hierarchy. However, in SpinalHDL,
you don’t need to bind their ports at instantiation:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdderCell</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Declaring external ports in a Bundle called `io` is recommended</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">cin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="n">cout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Do some logic</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">cout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">Adder</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Create 2 AdderCell instances</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cell0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AdderCell</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cell1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AdderCell</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">cell1</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cell0</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">cout</span><span class="w">   </span><span class="c1">// Connect cout of cell0 to cin of cell1</span>

<span class="w">  </span><span class="c1">// Another example which creates an array of ArrayCell instances</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cellArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">width</span><span class="p">)(</span><span class="k">new</span><span class="w"> </span><span class="nc">AdderCell</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="n">cellArray</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cellArray</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">io</span><span class="p">.</span><span class="n">cout</span><span class="w">   </span><span class="c1">// Connect cout of cell(0) to cin of cell(1)</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">io</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">Bundle</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code></div>
<div class="line">Declaring external ports in a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> called <code class="docutils literal notranslate"><span class="pre">io</span></code> is recommended. If you name your bundle <code class="docutils literal notranslate"><span class="pre">io</span></code>, SpinalHDL
will check that all of its elements are defined as inputs or outputs.</div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If it is better to your taste, you can use the <code class="docutils literal notranslate"><span class="pre">Module</span></code> syntax instead of <code class="docutils literal notranslate"><span class="pre">Component</span></code> (they are the same thing)</p>
</div>
<section id="input-output-definition">
<span id="io"></span><h4>Input / output definition<a class="headerlink" href="#input-output-definition" title="Permalink to this heading"></a></h4>
<p>The syntax to define inputs and outputs is as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 50%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">port</span> <span class="pre">Bool()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">out</span> <span class="pre">port</span> <span class="pre">Bool()</span></code></div>
</div>
</td>
<td><p>Create an input Bool/output Bool</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">Bits/UInt/SInt[(x</span> <span class="pre">bits)]</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">out</span> <span class="pre">Bits/UInt/SInt[(x</span> <span class="pre">bits)]</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">Bits(3</span> <span class="pre">bits)</span></code></div>
</div>
</td>
<td><p>Create an input/output of the corresponding type</p></td>
<td><p>Bits/UInt/SInt</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">in(T)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">out(T)</span></code></div>
</div>
</td>
<td><p>For all other data types, you may have to add some brackets around it. Sorry, this is a Scala limitation.</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">master(T)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">slave(T)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">master(Bool())</span></code></div>
</div>
</td>
<td><p>This syntax is provided by the <code class="docutils literal notranslate"><span class="pre">spinal.lib</span></code> library (If you annotate your object with the <code class="docutils literal notranslate"><span class="pre">slave</span></code> syntax, then import <code class="docutils literal notranslate"><span class="pre">spinal.lib.slave</span></code> instead).
T must extend <code class="docutils literal notranslate"><span class="pre">IMasterSlave</span></code>. Some documentation is available <a class="reference internal" href="index.html#interface-example-apb"><span class="std std-ref">here</span></a>. You may not actually need the brackets, so <code class="docutils literal notranslate"><span class="pre">master</span> <span class="pre">T</span></code> is fine as well.</p></td>
<td><p>T</p></td>
</tr>
</tbody>
</table>
<p>There are some rules to follow with component interconnection:</p>
<ul class="simple">
<li><p>Components can only <strong>read</strong> output and input signals of child components.</p></li>
<li><p>Components can read their own output port values (unlike in VHDL).</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If for some reason you need to read signals from far away in the hierarchy (such as for debugging or temporal
patches), you can do it by using the value returned by <code class="docutils literal notranslate"><span class="pre">some.where.else.theSignal.pull()</span></code></p>
</div>
</section>
<section id="pruned-signals">
<h4>Pruned signals<a class="headerlink" href="#pruned-signals" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will generate all the named signals and their dependencies, while all the useless anonymous / zero width ones
are removed from the RTL generation.</p>
<p>You can collect the list of all the removed ans useless signals via the <code class="docutils literal notranslate"><span class="pre">printPruned</span></code> and the <code class="docutils literal notranslate"><span class="pre">printPrunedIo</span></code>
functions on the generated <code class="docutils literal notranslate"><span class="pre">SpinalReport</span></code> object:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">unusedSignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">unusedSignal2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">unusedSignal2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">unusedSignal</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">).</span><span class="n">printPruned</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This will report :</span>
<span class="w">    </span><span class="c1">//  [Warning] Unused signal detected : toplevel/unusedSignal : UInt[8 bits]</span>
<span class="w">    </span><span class="c1">//  [Warning] Unused signal detected : toplevel/unusedSignal2 : UInt[8 bits]</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="parametrized-hardware-generic-in-vhdl-parameter-in-verilog">
<h4>Parametrized Hardware (“Generic” in VHDL, “Parameter” in Verilog)<a class="headerlink" href="#parametrized-hardware-generic-in-vhdl-parameter-in-verilog" title="Permalink to this heading"></a></h4>
<p>If you want to parameterize your component, you can give parameters to the constructor of the component as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyAdder</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">BitCount</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyAdder</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If you have several parameters, it is a good practice to give a specific configuration class as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MySocConfig</span><span class="p">(</span><span class="n">axiFrequency</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nc">HertzNumber</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">onChipRamSize</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">cpu</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nc">RiscCoreConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">iCache</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nc">InstructionCacheConfig</span><span class="p">)</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">MySoc</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">MySocConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can add functions inside the config, along with requirements on the config attributes:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyBusConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">bytePerWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">addressType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">dataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Data width must be 32 or 64&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This parametrization occurs entirely within the SpinalHDL code-generation during
elaboration.  This generates non-generic HDL code. The methods described here do
not use VHDL generics or Verilog parameters.</p>
<p>See also <a class="reference internal" href="index.html#blackbox"><span class="std std-ref">Blackbox</span></a> for more information around support for
that mechanism.</p>
</div>
</section>
<section id="synthesized-component-names">
<h4>Synthesized component names<a class="headerlink" href="#synthesized-component-names" title="Permalink to this heading"></a></h4>
<p>Within a module, each component has a name, called a “partial name”.
The “full” name is built by joining every component’s parent name with “_”, for example: <code class="docutils literal notranslate"><span class="pre">io_clockDomain_reset</span></code>.
You can use <code class="docutils literal notranslate"><span class="pre">setName</span></code> to replace this convention with a custom name.
This is especially useful when interfacing with external components.
The other methods are called <code class="docutils literal notranslate"><span class="pre">getName</span></code>, <code class="docutils literal notranslate"><span class="pre">setPartialName</span></code>, and <code class="docutils literal notranslate"><span class="pre">getPartialName</span></code> respectively.</p>
<p>When synthesized, each module gets the name of the Scala class defining it. You can override this as well with
<code class="docutils literal notranslate"><span class="pre">setDefinitionName</span></code>.</p>
<!--
TODO
### Input or Output is a basic type

### Input or Output is a bundle type

## Master/Slave interface

--></section>
</section>
<span id="document-SpinalHDL/Structuring/area"></span><section id="area">
<h3>Area<a class="headerlink" href="#area" title="Permalink to this heading"></a></h3>
<p>Sometimes, creating a <code class="docutils literal notranslate"><span class="pre">Component</span></code> to define some logic is overkill because you:</p>
<ul class="simple">
<li><p>Need to define all construction parameters and IO (verbosity, duplication)</p></li>
<li><p>Split your code (more than needed)</p></li>
</ul>
<p>For this kind of case you can use an <code class="docutils literal notranslate"><span class="pre">Area</span></code> to define a group of signals/logic:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tickCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">          </span><span class="c1">// Refer to the tick from timer area</span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<div class="line-block">
<div class="line">In VHDL and Verilog, sometimes prefixes are used to separate variables into logical sections. It is suggested that you use <code class="docutils literal notranslate"><span class="pre">Area</span></code> instead  of this in SpinalHDL.</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="index.html#clock-domain"><span class="std std-ref">ClockingArea</span></a> is a special kind of <code class="docutils literal notranslate"><span class="pre">Area</span></code> that allows you to define chunks of hardware which use a given <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code></p>
</div>
</section>
<span id="document-SpinalHDL/Structuring/function"></span><section id="function">
<span id="id1"></span><h3>Function<a class="headerlink" href="#function" title="Permalink to this heading"></a></h3>
<p>The ways you can use Scala functions to generate hardware are radically different than VHDL/Verilog for many reasons:</p>
<ul>
<li><p>You can instantiate registers, combinational logic, and components inside them.</p></li>
<li><p>You don’t have to play with <code class="docutils literal notranslate"><span class="pre">process</span></code>/<code class="docutils literal notranslate"><span class="pre">&#64;always</span></code> blocks that limit the scope of assignment of signals.</p></li>
<li><div class="line-block">
<div class="line">Everything is passed by reference, which allows easy manipulation.</div>
<div class="line">For example, you can give a bus to a function as an argument, then the function can internally read/write to it. You can also return a Component, a Bus, or anything else from Scala and the Scala world.</div>
</div>
</li>
</ul>
<section id="rgb-to-gray">
<h4>RGB to gray<a class="headerlink" href="#rgb-to-gray" title="Permalink to this heading"></a></h4>
<p>For example, if you want to convert a Red/Green/Blue color into greyscale by using coefficients, you can use functions to apply them:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Input RGB color</span>
<span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Define a function to multiply a UInt by a Scala Float value.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">coef</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">):</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">U</span><span class="p">((</span><span class="mi">255</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">by</span><span class="p">).</span><span class="n">toInt</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Calculate the gray level</span>
<span class="kd">val</span><span class="w"> </span><span class="n">gray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="valid-ready-payload-bus">
<h4>Valid Ready Payload bus<a class="headerlink" href="#valid-ready-payload-bus" title="Permalink to this heading"></a></h4>
<p>For instance, if you define a simple bus with <code class="docutils literal notranslate"><span class="pre">valid</span></code>, <code class="docutils literal notranslate"><span class="pre">ready</span></code>, and <code class="docutils literal notranslate"><span class="pre">payload</span></code> signals, you can then define some useful functions inside of it.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyBus</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">payloadWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define the direction of the data in a master mode</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Connect that to this</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">&lt;&lt;</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">MyBus</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">valid</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="p">.</span><span class="n">ready</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">ready</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Connect this to the FIFO input, return the fifo output</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">queue</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">MyBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">fifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MyBusFifo</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="bp">this</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBusFifo</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">MyBus</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pop</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">MyBus</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">payloadWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// ...</span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Structuring/clock_domain"></span><section id="clock-domains">
<span id="clock-domain"></span><h3>Clock domains<a class="headerlink" href="#clock-domains" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>In SpinalHDL, clock and reset signals can be combined to create a <strong>clock domain</strong>. Clock domains can be applied to some areas of the design and then all synchronous elements instantiated into those areas will then <strong>implicitly</strong> use this clock domain.</p>
<p>Clock domain application works like a stack, which means that if you are in a given clock domain you can still apply another clock domain locally.</p>
<p>Please note that a register captures its clock domain when the register is created, not when it is assigned. So please make sure to create them inside the desired <code class="docutils literal notranslate"><span class="pre">ClockingArea</span></code>.</p>
</section>
<section id="instantiation">
<span id="clock-domain-instantiation"></span><h4>Instantiation<a class="headerlink" href="#instantiation" title="Permalink to this heading"></a></h4>
<p>The syntax to define a clock domain is as follows (using EBNF syntax):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"></span>
<span class="w">  </span><span class="p">[,</span><span class="n">reset</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">[,</span><span class="n">softReset</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">[,</span><span class="n">clockEnable</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">[,</span><span class="n">frequency</span><span class="p">:</span><span class="w"> </span><span class="nc">IClockDomainFrequency</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">[,</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">]</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This definition takes five parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 83%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clock</span></code></p></td>
<td><p>Clock signal that defines the domain.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">reset</span></code></p></td>
<td><p>Reset signal. If a register exists which needs a reset and the clock domain doesn’t provide one,
an error message will be displayed.</p></td>
<td><p>null</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">softReset</span></code></p></td>
<td><p>Reset which infers an additional synchronous reset.</p></td>
<td><p>null</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">clockEnable</span></code></p></td>
<td><p>The goal of this signal is to disable the clock on the whole clock domain without having to manually
implement that on each synchronous element</p></td>
<td><p>null</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">frequency</span></code></p></td>
<td><p>Allows you to specify the frequency of the given clock domain and later read it in your design.
This parameter does not generate a PLL or more hardware to control the frequency.</p></td>
<td><p>UnknownFrequency</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">config</span></code></p></td>
<td><p>Specify the polarity of signals and the nature of the reset.</p></td>
<td><p>Current config</p></td>
</tr>
</tbody>
</table>
<p>An applied example to define a specific clock domain within the design is as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">coreClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="c1">// Define a new clock domain</span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">coreClock</span><span class="p">,</span><span class="w"> </span><span class="n">coreReset</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Use this domain in an area of the design</span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">coreClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">coreClockedRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>When an <cite>Area</cite> is not needed, it is also possible to apply the clock domain directly. Two syntaxes exist:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Counters</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">freeCount</span><span class="p">,</span><span class="w"> </span><span class="n">gatedCount</span><span class="p">,</span><span class="w"> </span><span class="n">gatedCount2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">freeCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">freeCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">freeCounter</span><span class="p">.</span><span class="n">value</span><span class="w"></span>

<span class="w">  </span><span class="c1">// In a real design consider using a glitch free single purpose CLKGATE primitive instead</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gatedClk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">readClockWire</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">enable</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">gatedClk</span><span class="p">,</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">readResetWire</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Here the &quot;gated&quot; clock domain is applied on &quot;gatedCounter&quot; and &quot;gatedCounter2&quot;</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gatedCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gated</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">gatedCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">gatedCounter</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gatedCounter2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gated</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">gatedCount2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">gatedCounter2</span><span class="p">.</span><span class="n">value</span><span class="w"></span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">gatedCounter</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">gatedCounter2</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;gated count mismatch&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<section id="configuration">
<h5>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h5>
<p>In addition to <a class="reference internal" href="#clock-domain-instantiation"><span class="std std-ref">constructor parameters</span></a>, the following elements of each clock domain are configurable via a <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code>class:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Valid values</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clockEdge</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">RISING</span></code>, <code class="docutils literal notranslate"><span class="pre">FALLING</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">resetKind</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ASYNC</span></code>, <code class="docutils literal notranslate"><span class="pre">SYNC</span></code>, and <code class="docutils literal notranslate"><span class="pre">BOOT</span></code> which is supported by some FPGAs (where FF values are loaded by the bitstream)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">resetActiveLevel</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HIGH</span></code>, <code class="docutils literal notranslate"><span class="pre">LOW</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">softResetActiveLevel</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HIGH</span></code>, <code class="docutils literal notranslate"><span class="pre">LOW</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clockEnableActiveLevel</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HIGH</span></code>, <code class="docutils literal notranslate"><span class="pre">LOW</span></code></p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomClockExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">resetn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Configure the clock domain</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clock</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">reset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">resetn</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">clockEdge</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">RISING</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">resetKind</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">ASYNC</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">resetActiveLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LOW</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define an Area which use myClockDomain</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">myClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">myReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>By default, a <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> is applied to the whole design. The configuration of this default domain is:</p>
<ul class="simple">
<li><p>Clock : rising edge</p></li>
<li><p>Reset : asynchronous, active high</p></li>
<li><p>No clock enable</p></li>
</ul>
<p>This corresponds to the following <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">defaultCC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clockEdge</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">RISING</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">resetKind</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">ASYNC</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">resetActiveLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">HIGH</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="internal-clock">
<h5>Internal clock<a class="headerlink" href="#internal-clock" title="Permalink to this heading"></a></h5>
<p>An alternative syntax to create a clock domain is the following:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">internal</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">withReset</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">withSoftReset</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">withClockEnable</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">frequency</span><span class="p">:</span><span class="w"> </span><span class="nc">IClockDomainFrequency</span><span class="p">]</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This definition takes six parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 71%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">name</span></code></p></td>
<td><p>Name of <cite>clk</cite> and <cite>reset</cite> signal</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">config</span></code></p></td>
<td><p>Specify polarity of signals and the nature of the reset</p></td>
<td><p>Current config</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withReset</span></code></p></td>
<td><p>Add a reset signal</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">withSoftReset</span></code></p></td>
<td><p>Add a soft reset signal</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withClockEnable</span></code></p></td>
<td><p>Add a clock enable</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">frequency</span></code></p></td>
<td><p>Frequency of the clock domain</p></td>
<td><p>UnknownFrequency</p></td>
</tr>
</tbody>
</table>
<p>The advantage of this approach is to create clock and reset signals with a known/specified name instead of an inherited one.</p>
<p>Once created, you have to assign the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code>’s signals, as shown in the example below:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InternalClockWithPllExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk100M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">aReset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// myClockDomain.clock will be named myClockName_clk</span>
<span class="w">  </span><span class="c1">// myClockDomain.reset will be named myClockName_reset</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">internal</span><span class="p">(</span><span class="s">&quot;myClockName&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Instantiate a PLL (probably a BlackBox)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">pll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Pll</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clkIn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">clk100M</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Assign myClockDomain signals with something</span>
<span class="w">  </span><span class="n">myClockDomain</span><span class="p">.</span><span class="n">clock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clockOut</span><span class="w"></span>
<span class="w">  </span><span class="n">myClockDomain</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">aReset</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Do whatever you want with myClockDomain</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">myClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">myReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In other components then the one you created the ClockDomain in, you must not use <code class="docutils literal notranslate"><span class="pre">.clock</span></code> and <code class="docutils literal notranslate"><span class="pre">.reset</span></code>,
but <code class="docutils literal notranslate"><span class="pre">.readClockWire</span></code> and <code class="docutils literal notranslate"><span class="pre">.readResetWire</span></code> as listed below. For the global ClockDomain you must always
use those <code class="docutils literal notranslate"><span class="pre">.readXXX</span></code> functions.</p>
</div>
</section>
<section id="external-clock">
<h5>External clock<a class="headerlink" href="#external-clock" title="Permalink to this heading"></a></h5>
<p>You can define a clock domain which is driven by the outside anywhere in your source. It will then automatically add clock and reset wires from the top level inputs to all synchronous elements.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">withReset</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">withSoftReset</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">withClockEnable</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,]</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">frequency</span><span class="p">:</span><span class="w"> </span><span class="nc">IClockDomainFrequency</span><span class="p">]</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>The arguments to the <code class="docutils literal notranslate"><span class="pre">ClockDomain.external</span></code> function are exactly the same as in the <code class="docutils literal notranslate"><span class="pre">ClockDomain.internal</span></code> function. Below is an example of a design using <code class="docutils literal notranslate"><span class="pre">ClockDomain.external</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExternalClockExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// On the top level you have two signals  :</span>
<span class="w">  </span><span class="c1">//     myClockName_clk and myClockName_reset</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;myClockName&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">myClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">myReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="signal-priorities-in-hdl-generation">
<h5>Signal priorities in HDL generation<a class="headerlink" href="#signal-priorities-in-hdl-generation" title="Permalink to this heading"></a></h5>
<p>In the current version, reset and clock enable signals have different priorities. Their order is : <code class="docutils literal notranslate"><span class="pre">asyncReset</span></code>, <code class="docutils literal notranslate"><span class="pre">clockEnable</span></code>, <code class="docutils literal notranslate"><span class="pre">syncReset</span></code> and <code class="docutils literal notranslate"><span class="pre">softReset</span></code>.</p>
<p>Please be careful that clockEnable has a higher priority than syncReset. If you do a sync reset when the clockEnable is disabled (especially at the beginning of a simulation), the gated registers will not be reset.</p>
<p>Here is an example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">clockedArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockEnableArea</span><span class="p">(</span><span class="n">clockEnable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It will generate VerilogHDL codes like:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">clockedArea_newClockEnable</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">resetn</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">clockedArea_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">clockedArea_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io_input</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>
</pre></div>
</div>
<p>If that behavior is problematic, one workaround is to use a when statement as a clock enable instead of using the ClockDomain.enable feature. This is open for future improvements.</p>
</section>
<section id="context">
<h5>Context<a class="headerlink" href="#context" title="Permalink to this heading"></a></h5>
<p>You can retrieve in which clock domain you are by calling <code class="docutils literal notranslate"><span class="pre">ClockDomain.current</span></code> anywhere.</p>
<p>The returned <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> instance has the following functions that can be called:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 71%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>frequency.getValue</p></td>
<td><div class="line-block">
<div class="line">Return the frequency of the clock domain.</div>
<div class="line">This being the arbitrary value you configured the domain with.</div>
</div>
</td>
<td><p>Double</p></td>
</tr>
<tr class="row-odd"><td><p>hasReset</p></td>
<td><p>Return if the clock domain has a reset signal</p></td>
<td><p>Boolean</p></td>
</tr>
<tr class="row-even"><td><p>hasSoftReset</p></td>
<td><p>Return if the clock domain has a soft reset signal</p></td>
<td><p>Boolean</p></td>
</tr>
<tr class="row-odd"><td><p>hasClockEnable</p></td>
<td><p>Return if the clock domain has a clock enable signal</p></td>
<td><p>Boolean</p></td>
</tr>
<tr class="row-even"><td><p>readClockWire</p></td>
<td><p>Return a signal derived from the clock signal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>readResetWire</p></td>
<td><p>Return a signal derived from the reset signal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>readSoftResetWire</p></td>
<td><p>Return a signal derived from the soft reset signal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>readClockEnableWire</p></td>
<td><p>Return a signal derived from the clock enable signal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>isResetActive</p></td>
<td><p>Return True when the reset is active</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>isSoftResetActive</p></td>
<td><p>Return True when the soft reset is active</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>isClockEnableActive</p></td>
<td><p>Return True when the clock enable is active</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<p>An example is included below where a UART controller uses the frequency specification to set its clock divider:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">coreClock</span><span class="p">,</span><span class="w"> </span><span class="n">coreReset</span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="o">=</span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mf">100e6</span><span class="p">))</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">coreArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">coreClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">clockDivider</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">coreClk</span><span class="p">.</span><span class="n">frequency</span><span class="p">.</span><span class="n">getValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">57.6e3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="n">toInt</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="clock-domain-crossing">
<h4>Clock domain crossing<a class="headerlink" href="#clock-domain-crossing" title="Permalink to this heading"></a></h4>
<p>SpinalHDL checks at compile time that there are no unwanted/unspecified cross clock domain signal reads. If you want to read a signal that is emitted by another <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> area, you should add the <code class="docutils literal notranslate"><span class="pre">crossClockDomain</span></code> tag to the destination signal as depicted in the following example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//             _____                        _____             _____</span>
<span class="c1">//            |     |  (crossClockDomain)  |     |           |     |</span>
<span class="c1">//  dataIn --&gt;|     |---------------------&gt;|     |----------&gt;|     |--&gt; dataOut</span>
<span class="c1">//            | FF  |                      | FF  |           | FF  |</span>
<span class="c1">//  clkA   --&gt;|     |              clkB --&gt;|     |   clkB --&gt;|     |</span>
<span class="c1">//  rstA   --&gt;|_____|              rstB --&gt;|_____|   rstB --&gt;|_____|</span>



<span class="c1">// Implementation where clock and reset pins are given by components&#39; IO</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CrossingExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rstA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rstB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// sample dataIn with clkA</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clkA</span><span class="p">,</span><span class="n">io</span><span class="p">.</span><span class="n">rstA</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">dataIn</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2 register stages to avoid metastability issues</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clkB</span><span class="p">,</span><span class="n">io</span><span class="p">.</span><span class="n">rstB</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">buf0</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">area_clkA</span><span class="p">.</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"> </span><span class="n">addTag</span><span class="p">(</span><span class="n">crossClockDomain</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">buf1</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">buf0</span><span class="p">)</span><span class="w">          </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">dataOut</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">area_clkB</span><span class="p">.</span><span class="n">buf1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="c1">// Alternative implementation where clock domains are given as parameters</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CrossingExample</span><span class="p">(</span><span class="n">clkA</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">,</span><span class="n">clkB</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// sample dataIn with clkA</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">clkA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">dataIn</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2 register stages to avoid metastability issues</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">clkB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">buf0</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">area_clkA</span><span class="p">.</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"> </span><span class="n">addTag</span><span class="p">(</span><span class="n">crossClockDomain</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">buf1</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">buf0</span><span class="p">)</span><span class="w">          </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">dataOut</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">area_clkB</span><span class="p">.</span><span class="n">buf1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In general, you can use 2 or more flip-flop driven by the destination clock domain to prevent metastability. The <code class="docutils literal notranslate"><span class="pre">BufferCC(input:</span> <span class="pre">T,</span> <span class="pre">init:</span> <span class="pre">T</span> <span class="pre">=</span> <span class="pre">null,</span> <span class="pre">bufferDepth:</span> <span class="pre">Int</span> <span class="pre">=</span> <span class="pre">2)</span></code> function provided in <code class="docutils literal notranslate"><span class="pre">spinal.lib._</span></code> will instantiate the necessary flip-flops (the number of flip-flops will depends on the <code class="docutils literal notranslate"><span class="pre">bufferDepth</span></code> parameter) to mitigate the phenomena.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossingExample</span><span class="p">(</span><span class="n">clkA</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">,</span><span class="n">clkB</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dataOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// sample dataIn with clkA</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">clkA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">dataIn</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// BufferCC to avoid metastability issues</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">clkB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">buf1</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">area_clkA</span><span class="p">.</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">dataOut</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">area_clkB</span><span class="p">.</span><span class="n">buf1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">BufferCC</span></code> function is only for signals of type <code class="docutils literal notranslate"><span class="pre">Bit</span></code>, or <code class="docutils literal notranslate"><span class="pre">Bits</span></code> operating as Gray-coded counters (only 1 bit-flip per clock cycle), and can not used for multi-bit cross-domain processes. For multi-bit cases, it is recommended to use <code class="docutils literal notranslate"><span class="pre">StreamFifoCC</span></code> for high bandwidth requirements, or use <code class="docutils literal notranslate"><span class="pre">StreamCCByToggle</span></code> to reduce resource usage in cases where bandwidth is not critical.</p>
</div>
</section>
<section id="special-clocking-areas">
<h4>Special clocking Areas<a class="headerlink" href="#special-clocking-areas" title="Permalink to this heading"></a></h4>
<section id="slow-area">
<h5>Slow Area<a class="headerlink" href="#slow-area" title="Permalink to this heading"></a></h5>
<p>A <code class="docutils literal notranslate"><span class="pre">SlowArea</span></code> is used to create a new clock domain area which is slower than the current one:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Use the current clock domain : 100MHz</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">areaStd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Slow the current clockDomain by 4 : 25 MHz</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">areaDiv4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SlowArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Slow the current clockDomain to 50MHz</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area50Mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SlowArea</span><span class="p">(</span><span class="mi">50</span><span class="w"> </span><span class="nc">MHz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">SpinalConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">defaultClockDomainFrequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">).</span><span class="n">generateVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The clock signal used in a SlowArea is the same as the parent one. The SlowArea add instead a clock-enable signal that will slow down
the sampling rate inside it. In other words, <code class="docutils literal notranslate"><span class="pre">ClockDomain.current.readClockWire</span></code> will return the fast (parent
domain) clock. To obtain the clock enable, use <code class="docutils literal notranslate"><span class="pre">ClockDomain.current.readClockEnableWire</span></code></p>
</div>
</section>
<section id="bootreset">
<h5>BootReset<a class="headerlink" href="#bootreset" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">clockDomain.withBootReset()</span></code> could specify register’s resetKind as <code class="docutils literal notranslate"><span class="pre">BOOT</span></code>.
<code class="docutils literal notranslate"><span class="pre">clockDomain.withSyncReset()</span></code> could specify register’s resetKind as <code class="docutils literal notranslate"><span class="pre">SYNC</span></code> (sync-reset).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w">  </span><span class="nc">Top</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w">  </span><span class="o">:=</span><span class="w">  </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w">  </span><span class="o">:=</span><span class="w">  </span><span class="n">clockDomain</span><span class="p">.</span><span class="n">withBootReset</span><span class="p">()</span><span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="o">:=</span><span class="w">  </span><span class="n">clockDomain</span><span class="p">.</span><span class="n">withSyncReset</span><span class="p">()</span><span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="o">:=</span><span class="w">  </span><span class="n">clockDomain</span><span class="p">.</span><span class="n">withAsyncReset</span><span class="p">()</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Top</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="resetarea">
<h5>ResetArea<a class="headerlink" href="#resetarea" title="Permalink to this heading"></a></h5>
<p>A <code class="docutils literal notranslate"><span class="pre">ResetArea</span></code> is used to create a new clock domain area where a special reset signal is combined with the current clock domain reset:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">specialReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The reset of this area is done with the specialReset signal</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">areaRst_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ResetArea</span><span class="p">(</span><span class="n">specialReset</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The reset of this area is a combination between the current reset and the specialReset</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">areaRst_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ResetArea</span><span class="p">(</span><span class="n">specialReset</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="clockenablearea">
<h5>ClockEnableArea<a class="headerlink" href="#clockenablearea" title="Permalink to this heading"></a></h5>
<p>A <code class="docutils literal notranslate"><span class="pre">ClockEnableArea</span></code> is used to add an additional clock enable in the current clock domain:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clockEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Add a clock enable for this area</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">area_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockEnableArea</span><span class="p">(</span><span class="n">clockEnable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Structuring/blackbox"></span><section id="instantiate-vhdl-and-verilog-ip">
<span id="blackbox"></span><h3>Instantiate VHDL and Verilog IP<a class="headerlink" href="#instantiate-vhdl-and-verilog-ip" title="Permalink to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h4>
<p>A blackbox allows the user to integrate an existing VHDL/Verilog component into the design by just specifying its
interfaces. It’s up to the simulator or synthesizer to do the elaboration correctly.</p>
</section>
<section id="defining-an-blackbox">
<h4>Defining an blackbox<a class="headerlink" href="#defining-an-blackbox" title="Permalink to this heading"></a></h4>
<p>An example of how to define a blackbox is shown below:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define a Ram as a BlackBox</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">(</span><span class="n">wordWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">wordCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Add VHDL Generics / Verilog parameters to the blackbox</span>
<span class="w">  </span><span class="c1">// You can use String, Int, Double, Boolean, and all SpinalHDL base</span>
<span class="w">  </span><span class="c1">// types as generic values</span>
<span class="w">  </span><span class="n">addGeneric</span><span class="p">(</span><span class="s">&quot;wordCount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wordCount</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">addGeneric</span><span class="p">(</span><span class="s">&quot;wordWidth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wordWidth</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define IO of the VHDL entity / Verilog module</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="n">wordWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="n">wordWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Map the current clock domain to the io.clk pin</span>
<span class="w">  </span><span class="n">mapClockDomain</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="line-block">
<div class="line">In VHDL, signals of type <code class="docutils literal notranslate"><span class="pre">Bool</span></code> will be translated into <code class="docutils literal notranslate"><span class="pre">std_logic</span></code> and <code class="docutils literal notranslate"><span class="pre">Bits</span></code> into <code class="docutils literal notranslate"><span class="pre">std_logic_vector</span></code>. If you want to get <code class="docutils literal notranslate"><span class="pre">std_ulogic</span></code>, you have to use a <code class="docutils literal notranslate"><span class="pre">BlackBoxULogic</span></code> instead of <code class="docutils literal notranslate"><span class="pre">BlackBox</span></code>.</div>
<div class="line">In Verilog, <code class="docutils literal notranslate"><span class="pre">BlackBoxUlogic</span></code> does not change the generated verilog.</div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">(</span><span class="n">wordWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">wordCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBoxULogic</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="generics">
<h4>Generics<a class="headerlink" href="#generics" title="Permalink to this heading"></a></h4>
<p>There are two different ways to declare generics:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Ram</span><span class="p">(</span><span class="n">wordWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">wordCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">addGeneric</span><span class="p">(</span><span class="s">&quot;wordCount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wordCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">addGeneric</span><span class="p">(</span><span class="s">&quot;wordWidth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wordWidth</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// OR</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Generic</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ram</span><span class="p">.</span><span class="bp">this</span><span class="p">.</span><span class="n">wordCount</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">wordWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ram</span><span class="p">.</span><span class="bp">this</span><span class="p">.</span><span class="n">wordWidth</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="instantiating-a-blackbox">
<h4>Instantiating a blackbox<a class="headerlink" href="#instantiating-a-blackbox" title="Permalink to this heading"></a></h4>
<p>Instantiating a <code class="docutils literal notranslate"><span class="pre">BlackBox</span></code> is just like instantiating a <code class="docutils literal notranslate"><span class="pre">Component</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create the top level and instantiate the Ram</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Instantiate the blackbox</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Connect all the signals</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">en</span><span class="w">   </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">en</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">addr</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">rd</span><span class="p">.</span><span class="n">en</span><span class="w">   </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">rd</span><span class="p">.</span><span class="n">en</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">rd</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">rd</span><span class="p">.</span><span class="n">addr</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">rd</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">rd</span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="clock-and-reset-mapping">
<h4>Clock and reset mapping<a class="headerlink" href="#clock-and-reset-mapping" title="Permalink to this heading"></a></h4>
<p>In your blackbox definition you have to explicitly define clock and reset signals. To map signals of a <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> to corresponding inputs of the blackbox you can use the <code class="docutils literal notranslate"><span class="pre">mapClockDomain</span></code> or <code class="docutils literal notranslate"><span class="pre">mapCurrentClockDomain</span></code> function. <code class="docutils literal notranslate"><span class="pre">mapClockDomain</span></code> has the following parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>name</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>default</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>clockDomain</p></td>
<td><p>ClockDomain</p></td>
<td><p>ClockDomain.current</p></td>
<td><p>Specify the clockDomain which provides the signals</p></td>
</tr>
<tr class="row-odd"><td><p>clock</p></td>
<td><p>Bool</p></td>
<td><p>Nothing</p></td>
<td><p>Blackbox input which should be connected to the clockDomain clock</p></td>
</tr>
<tr class="row-even"><td><p>reset</p></td>
<td><p>Bool</p></td>
<td><p>Nothing</p></td>
<td><p>Blackbox input which should be connected to the clockDomain reset</p></td>
</tr>
<tr class="row-odd"><td><p>enable</p></td>
<td><p>Bool</p></td>
<td><p>Nothing</p></td>
<td><p>Blackbox input which should be connected to the clockDomain enable</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">mapCurrentClockDomain</span></code> has almost the same parameters as <code class="docutils literal notranslate"><span class="pre">mapClockDomain</span></code> but without the clockDomain.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyRam</span><span class="p">(</span><span class="n">clkDomain</span><span class="p">:</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Clock A is map on a specific clock Domain</span>
<span class="w">  </span><span class="n">mapClockDomain</span><span class="p">(</span><span class="n">clkDomain</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">clkA</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Clock B is map on the current clock domain</span>
<span class="w">  </span><span class="n">mapCurrentClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clkB</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>By default the ports of the blackbox are considered clock-less, meaning no clock crossing checks will be made on their usage. You can specify ports clock domain by using the ClockDomainTag :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DemoBlackbox</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">mapCurrentClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">rst</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nc">ClockDomainTag</span><span class="p">(</span><span class="bp">this</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)(</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can also apply the tag to the whole bundle with :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nc">ClockDomainTag</span><span class="p">(</span><span class="bp">this</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)(</span><span class="n">io</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>You can also apply the current clock domain to all the ports using (SpinalHDL 1.10.2):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">setIoCd</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="io-prefix">
<h4>io prefix<a class="headerlink" href="#io-prefix" title="Permalink to this heading"></a></h4>
<p>In order to avoid the prefix “io_” on each of the IOs of the blackbox, you can use the function <code class="docutils literal notranslate"><span class="pre">noIoPrefix()</span></code> as shown below :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define the Ram as a BlackBox</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">(</span><span class="n">wordWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">wordCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Generic</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">.</span><span class="bp">this</span><span class="p">.</span><span class="n">wordCount</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">.</span><span class="bp">this</span><span class="p">.</span><span class="n">wordWidth</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">_wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="n">_wordWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">_wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="n">_wordWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">noIoPrefix</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="n">mapCurrentClockDomain</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="rename-all-io-of-a-blackbox">
<h4>Rename all io of a blackbox<a class="headerlink" href="#rename-all-io-of-a-blackbox" title="Permalink to this heading"></a></h4>
<p>IOs of a <code class="docutils literal notranslate"><span class="pre">BlackBox</span></code> or <code class="docutils literal notranslate"><span class="pre">Component</span></code> can be renamed at compile-time using the <code class="docutils literal notranslate"><span class="pre">addPrePopTask</span></code> function.
This function takes a no-argument function to be applied during compilation, and is useful for adding renaming passes, as shown in the following example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyRam</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Blackbox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">portA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">cs</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">rwn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">dIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">dOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">portB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">cs</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">rwn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">dIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">dOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Map the clk</span>
<span class="w">  </span><span class="n">mapCurrentClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Remove io_ prefix</span>
<span class="w">  </span><span class="n">noIoPrefix</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Function used to rename all signals of the blackbox</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">renameIO</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">flatten</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">bt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">getName</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;portA&quot;</span><span class="p">))</span><span class="w"> </span><span class="n">bt</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">getName</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;portA_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_A&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">getName</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;portB&quot;</span><span class="p">))</span><span class="w"> </span><span class="n">bt</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">getName</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;portB_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_B&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Execute the function renameIO after the creation of the component</span>
<span class="w">  </span><span class="n">addPrePopTask</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">renameIO</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// This code generate these names:</span>
<span class="c1">//    clk</span>
<span class="c1">//    cs_A, rwn_A, dIn_A, dOut_A</span>
<span class="c1">//    cs_B, rwn_B, dIn_B, dOut_B</span>
</pre></div>
</div>
</section>
<section id="add-rtl-source">
<h4>Add RTL source<a class="headerlink" href="#add-rtl-source" title="Permalink to this heading"></a></h4>
<p>With the function <code class="docutils literal notranslate"><span class="pre">addRTLPath()</span></code> you can associate your RTL sources with the blackbox. After the generation of your SpinalHDL code you can call the function <code class="docutils literal notranslate"><span class="pre">mergeRTLSource</span></code> to merge all of the sources together.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyBlackBox</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Blackbox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dIn</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dOut</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Map the clk</span>
<span class="w">  </span><span class="n">mapCurrentClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Remove io_ prefix</span>
<span class="w">  </span><span class="n">noIoPrefix</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Add all rtl dependencies</span>
<span class="w">  </span><span class="n">addRTLPath</span><span class="p">(</span><span class="s">&quot;./rtl/RegisterBank.v&quot;</span><span class="p">)</span><span class="w">                         </span><span class="c1">// Add a verilog file</span>
<span class="w">  </span><span class="n">addRTLPath</span><span class="p">(</span><span class="s">s&quot;./rtl/myDesign.vhd&quot;</span><span class="p">)</span><span class="w">                          </span><span class="c1">// Add a vhdl file</span>
<span class="w">  </span><span class="n">addRTLPath</span><span class="p">(</span><span class="s">s&quot;</span><span class="si">${</span><span class="n">sys</span><span class="p">.</span><span class="n">env</span><span class="p">(</span><span class="s">&quot;MY_PROJECT&quot;</span><span class="p">)</span><span class="si">}</span><span class="s">/myTopLevel.vhd&quot;</span><span class="p">)</span><span class="w">     </span><span class="c1">// Use an environment variable MY_PROJECT (System.getenv(&quot;MY_PROJECT&quot;))</span>
<span class="p">}</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MyBlackBox</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">)</span><span class="w"></span>
<span class="n">report</span><span class="p">.</span><span class="n">mergeRTLSource</span><span class="p">(</span><span class="s">&quot;mergeRTL&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Merge all rtl sources into mergeRTL.vhd and mergeRTL.v files</span>
</pre></div>
</div>
</section>
<section id="vhdl-no-numeric-type">
<h4>VHDL - No numeric type<a class="headerlink" href="#vhdl-no-numeric-type" title="Permalink to this heading"></a></h4>
<p>If you want to use only <code class="docutils literal notranslate"><span class="pre">std_logic_vector</span></code> in your blackbox component, you can add the tag <code class="docutils literal notranslate"><span class="pre">noNumericType</span></code> to the blackbox.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyBlackBox</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">increment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">initValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">mapCurrentClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">noIoPrefix</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="n">addTag</span><span class="p">(</span><span class="n">noNumericType</span><span class="p">)</span><span class="w">  </span><span class="c1">// Only std_logic_vector</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The code above will generate the following VHDL:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">component</span><span class="w"> </span><span class="nc">MyBlackBox</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clk</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">increment</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">initValue</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">component</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Structuring/naming"></span><section id="preserving-names">
<h3>Preserving names<a class="headerlink" href="#preserving-names" title="Permalink to this heading"></a></h3>
<p>This page will describe how SpinalHDL propagate names from the scala code to the generated hardware. Knowing them should enable you to preserve those names as much as possible to generate understandable netlists.</p>
<section id="nameable-base-class">
<h4>Nameable base class<a class="headerlink" href="#nameable-base-class" title="Permalink to this heading"></a></h4>
<p>All the things which can be named in SpinalHDL extends the Nameable base class which.</p>
<p>So in practice, the following classes extends Nameable :</p>
<ul class="simple">
<li><p>Component</p></li>
<li><p>Area</p></li>
<li><p>Data (UInt, SInt, Bundle, …)</p></li>
</ul>
<p>There is a few example of that Nameable API</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;rawrr&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Force name</span>
<span class="w">  </span><span class="n">c</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;rawrr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// Propose a name, will not be applied if a stronger name is already applied</span>
<span class="w">  </span><span class="n">d</span><span class="p">.</span><span class="n">setCompositeName</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;wuff&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Force toto to be named as b.getName() + _wuff&quot;</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generation :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">rawrr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">rawrr_wuff</span><span class="p">;</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>In general, you don’t really need to access that API, unless you want to do tricky stuff for debug reasons or for elaboration purposes.</p>
</section>
<section id="name-extraction-from-scala">
<h4>Name extraction from Scala<a class="headerlink" href="#name-extraction-from-scala" title="Permalink to this heading"></a></h4>
<p>First, since version 1.4.0, SpinalHDL use a scala compiler plugin which can provide a call back each time a new val is defined during the construction of an class.</p>
<p>There is a example showing more or less how SpinalHDL itself is implemented :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// spinal.idslplugin.ValCallback is the Scala compiler plugin feature which will provide the callbacks</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">spinal</span><span class="p">.</span><span class="n">idslplugin</span><span class="p">.</span><span class="nc">ValCallback</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">valCallback</span><span class="p">[</span><span class="nc">T</span><span class="p">](</span><span class="n">ref</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">s&quot;Got </span><span class="si">$</span><span class="n">ref</span><span class="s"> named </span><span class="si">$</span><span class="n">name</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Here we just print what we got as a demo.</span>
<span class="w">    </span><span class="n">ref</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">UInt</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">Bits</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">wuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;miaou&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">toto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UInt</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rawrr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bits</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Debug3</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ^ This will print :</span>
<span class="w">  </span><span class="c1">// Got 2 named two</span>
<span class="w">  </span><span class="c1">// Got miaou named wuff</span>
<span class="w">  </span><span class="c1">// Got spinal.tester.code.sandbox.UInt@691a7f8f named toto</span>
<span class="w">  </span><span class="c1">// Got spinal.tester.code.sandbox.Bits@161b062a named rawrr</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Using that ValCallback “introspection” feature, SpinalHDL’s Component classes are able to be aware of their content and the content’s name.</p>
<p>But this also mean that if you want something to get a name, and you only rely on this automatic naming feature, the reference to your Data (UInt, SInt, …) instances should be stored somewhere in a Component val.</p>
<p>For instance :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// Will be properly named</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">toto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">   </span><span class="c1">// same</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">doStuff</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// This will not be named, as it isn&#39;t stored anywhere in a</span>
<span class="w">                           </span><span class="c1">// component val (but there is a solution explained later)</span>
<span class="w">    </span><span class="n">tmp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x20</span><span class="w"></span>
<span class="w">    </span><span class="n">toto</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">doStuff</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">a</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">toto</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Note that the tmp signal defined in scala was &quot;shortcuted&quot; by SpinalHDL,</span>
<span class="w">  </span><span class="c1">//  as it was unnamed and technically &quot;shortcutable&quot;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">toto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h20</span><span class="p">;</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="area-in-a-component">
<h4>Area in a Component<a class="headerlink" href="#area-in-a-component" title="Permalink to this heading"></a></h4>
<p>One important aspect in the naming system is that you can define new namespaces inside components and manipulate</p>
<p>For instance via Area :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logicA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// This define a new namespace named &quot;logicA</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">toggle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"> </span><span class="c1">// This register will be named &quot;logicA_toggle&quot;</span>
<span class="w">    </span><span class="n">toggle</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">toggle</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">logicA_toggle</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">logicA_toggle</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">logicA_toggle</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="area-in-a-function">
<h4>Area in a function<a class="headerlink" href="#area-in-a-function" title="Permalink to this heading"></a></h4>
<p>You can also define function which will create new Area which will provide a namespace for all its content :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">isZero</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">someLogic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isZero</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">someLogic</span><span class="p">.</span><span class="n">comparator</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Which will generate :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">result</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">someLogic_comparator</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">someLogic_comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">someLogic_comparator</span><span class="p">;</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="composite-in-a-function">
<h4>Composite in a function<a class="headerlink" href="#composite-in-a-function" title="Permalink to this heading"></a></h4>
<p>Added in SpinalHDL 1.5.0, Composite which allow you to create a scope which will use as prefix another Nameable:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Basically, a Composite is an Area that use its construction parameter as namespace prefix</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">isZero</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Composite</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}.</span><span class="n">comparator</span><span class="w">  </span><span class="c1">// Note we don&#39;t return the Composite,</span>
<span class="w">                </span><span class="c1">//  but the element of the composite that we are interested in</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">isZero</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">result</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">value_comparator</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">value_comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value_comparator</span><span class="p">;</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="composite-chains">
<h4>Composite chains<a class="headerlink" href="#composite-chains" title="Permalink to this heading"></a></h4>
<p>You can also chain composites :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">isZero</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Composite</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}.</span><span class="n">comparator</span><span class="w"></span>


<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">inverted</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Composite</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">inverter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="p">}.</span><span class="n">inverter</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">inverted</span><span class="p">(</span><span class="n">isZero</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">result</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">value_comparator</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">value_comparator_inverter</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">value_comparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">value_comparator_inverter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">value_comparator</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value_comparator_inverter</span><span class="p">;</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="composite-in-a-bundle-s-function">
<h4>Composite in a Bundle’s function<a class="headerlink" href="#composite-in-a-bundle-s-function" title="Permalink to this heading"></a></h4>
<p>This behavior can be very useful when implementing Bundle utilities. For instance in the spinal.lib.Stream class is defined the following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="kd">val</span><span class="w"> </span><span class="n">payloadType</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="nc">HardType</span><span class="p">[</span><span class="nc">T</span><span class="p">])</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payloadType</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">queue</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Composite</span><span class="p">(</span><span class="bp">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">fifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">(</span><span class="n">payloadType</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">self</span><span class="w">    </span><span class="c1">// &#39;self&#39; refers to the Composite construction argument (&#39;this&#39; in</span>
<span class="w">                            </span><span class="c1">//  the example). It avoids having to do a boring &#39;Stream.this&#39;</span>
<span class="w">  </span><span class="p">}.</span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">m2sPipe</span><span class="p">():</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Composite</span><span class="p">(</span><span class="bp">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">m2sPipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rValid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m2sPipe</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m2sPipe</span><span class="p">.</span><span class="n">ready</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">rValid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">      </span><span class="n">rData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">m2sPipe</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rValid</span><span class="w"></span>
<span class="w">    </span><span class="n">m2sPipe</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rData</span><span class="w"></span>
<span class="w">  </span><span class="p">}.</span><span class="n">m2sPipe</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Which allow nested calls while preserving the names :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="n">sink</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">queue</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">).</span><span class="n">m2sPipe</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">source_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">source_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">source_payload</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">sink_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">sink_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">sink_payload</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">source_fifo_io_pop_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">source_fifo_io_push_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">source_fifo_io_pop_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">source_fifo_io_pop_payload</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">source_fifo_io_occupancy</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">source_fifo_io_availability</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">source_fifo_io_pop_m2sPipe_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">source_fifo_io_pop_m2sPipe_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">source_fifo_io_pop_m2sPipe_payload</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">source_fifo_io_pop_rValid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">source_fifo_io_pop_rData</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">StreamFifo</span><span class="w"> </span><span class="n">source_fifo</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">io_push_valid</span><span class="w">      </span><span class="p">(</span><span class="n">source_valid</span><span class="w">                 </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_push_ready</span><span class="w">      </span><span class="p">(</span><span class="n">source_fifo_io_push_ready</span><span class="w">    </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_push_payload</span><span class="w">    </span><span class="p">(</span><span class="n">source_payload</span><span class="w">               </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_pop_valid</span><span class="w">       </span><span class="p">(</span><span class="n">source_fifo_io_pop_valid</span><span class="w">     </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_pop_ready</span><span class="w">       </span><span class="p">(</span><span class="n">source_fifo_io_pop_ready</span><span class="w">     </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_pop_payload</span><span class="w">     </span><span class="p">(</span><span class="n">source_fifo_io_pop_payload</span><span class="w">   </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_flush</span><span class="w">           </span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="w">                         </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_occupancy</span><span class="w">       </span><span class="p">(</span><span class="n">source_fifo_io_occupancy</span><span class="w">     </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_availability</span><span class="w">    </span><span class="p">(</span><span class="n">source_fifo_io_availability</span><span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">                </span><span class="p">(</span><span class="n">clk</span><span class="w">                          </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w">              </span><span class="p">(</span><span class="n">reset</span><span class="w">                        </span><span class="p">)</span><span class="w">  </span><span class="c1">//i</span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">source_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_fifo_io_push_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">source_fifo_io_pop_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_valid</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_ready</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_fifo_io_pop_rValid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_fifo_io_pop_rData</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sink_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sink_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sink_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_fifo_io_pop_m2sPipe_payload</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">source_fifo_io_pop_rValid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">source_fifo_io_pop_ready</span><span class="p">)</span><span class="k">begin</span><span class="w"></span>
<span class="w">        </span><span class="n">source_fifo_io_pop_rValid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">source_fifo_io_pop_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">source_fifo_io_pop_ready</span><span class="p">)</span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">source_fifo_io_pop_rData</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">source_fifo_io_pop_payload</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="unnamed-signal-handling">
<h4>Unnamed signal handling<a class="headerlink" href="#unnamed-signal-handling" title="Permalink to this heading"></a></h4>
<p>Since 1.5.0, for signal which end up without name, SpinalHDL will find a signal which is driven by that unnamed signal and propagate its name. This can produce useful results as long you don’t have too large island of unnamed stuff.</p>
<p>The name attributed to such unnamed signal is : _zz_ + drivenSignal.getName()</p>
<p>Note that this naming pattern is also used by the generation backend when they need to breakup some specific expressions or long chain of expression into multiple signals.</p>
<section id="verilog-expression-splitting">
<h5>Verilog expression splitting<a class="headerlink" href="#verilog-expression-splitting" title="Permalink to this heading"></a></h5>
<p>There is an instance of expressions (ex : the + operator) that SpinalHDL need to express in dedicated signals to match the behavior with the Scala API :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">a</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">c</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">d</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_result_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">result</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_result_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_result_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="verilog-long-expression-splitting">
<h5>Verilog long expression splitting<a class="headerlink" href="#verilog-long-expression-splitting" title="Permalink to this heading"></a></h5>
<p>There is a instance of how a very long expression chain will be split up by SpinalHDL :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">conditions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Perform a logical OR between all the condition elements</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conditions</span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// For Bits/UInt/SInt signals the &#39;orR&#39; methods implements this reduction operation</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_3</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_58</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_59</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_60</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_61</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_62</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">conditions_63</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_result_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_result_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">result</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((((((((((((((</span><span class="n">_zz_result_1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_32</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_33</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_34</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_35</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_36</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_37</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_38</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_39</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_40</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_41</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_42</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_43</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_44</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_45</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_46</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_47</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_result_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((((((((((((((</span><span class="n">_zz_result_2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_16</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_17</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_18</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_19</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_20</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_21</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_22</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_23</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_24</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_25</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_26</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_27</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_28</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_29</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_30</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_31</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_result_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((((((((((((((</span><span class="n">conditions_0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_2</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_3</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_4</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_5</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_6</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_7</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_8</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_9</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_10</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_11</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_12</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_13</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_14</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_15</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((((((((((((((</span><span class="n">_zz_result</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_48</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_49</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_50</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_51</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_52</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_53</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_54</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_55</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_56</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_57</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_58</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_59</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_60</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_61</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_62</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">conditions_63</span><span class="p">);</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="when-statement-condition">
<h5>When statement condition<a class="headerlink" href="#when-statement-condition" title="Permalink to this heading"></a></h5>
<p>The <cite>when(cond) { }</cite> statements condition are generated into separated signals named <cite>when_</cite> + fileName + line. A similar thing will also be done for switch statements.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// In file Test.scala</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">isZero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>

<span class="w">  </span><span class="n">isZero</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// At line 117</span>
<span class="w">    </span><span class="n">isZero</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">          </span><span class="n">isZero</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">counter</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">when_Test_l117</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">isZero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">when_Test_l117</span><span class="p">)</span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">isZero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">when_Test_l117</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">when_Test_l117</span><span class="p">)</span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">8&#39;h01</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="in-last-resort">
<h5>In last resort<a class="headerlink" href="#in-last-resort" title="Permalink to this heading"></a></h5>
<p>In last resort, if a signal has no name (anonymous signal), SpinalHDL will seek for a named signal which is driven by the anonymous signal, and use it as a name postfix :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="n">cond</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">):</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// This register is not named (on purpose for the example)</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ret</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">MyComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">enable</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Name given to the register in last resort by looking what was driven by it</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_value</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_value</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">_zz_value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">8&#39;h01</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>This last resort naming skim isn’t ideal in all cases, but can help out.</p>
<p>Note that signal starting with a underscore aren’t stored in the Verilator waves (on purpose)</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Structuring/parametrization"></span><section id="parametrization">
<h3>Parametrization<a class="headerlink" href="#parametrization" title="Permalink to this heading"></a></h3>
<p>There are multiple aspects to parametrization :</p>
<ul class="simple">
<li><p>Providing and the management of, elaboration time parameters provided
to SpinalHDL during elaboration of the design</p></li>
<li><p>Using the parameter data to allow the designer to perform any kind
of hardware construction, configuration and interconnection task
needed in the design.  Such as optional component generation within
the hardware design.</p></li>
</ul>
<p>Parallels exist with the aims of HDL features such as Verilog module
parameters and VHDL generics.  SpinalHDL brings a far richer and more
powerful set of capabilities into this area with the additional
protection of Scala type safety and SpinalHDL built in HDL design rule
checking.</p>
<p>The SpinalHDL mechanisms for parameterization of components is not built
on top of any native HDL mechanism and so is not impeded by HDL language
level/version support or restrictions about what can be achieved in hand
written HDL.</p>
<p>For readers looking to interoperate with parameterized Verilog or
genericized VHDL using SpinalHDL, please see the section on <a class="reference internal" href="index.html#blackbox"><span class="std std-ref">BlackBox</span></a>
IP for those scenarios your project requires.</p>
<section id="elaboration-time-parameters">
<h4>Elaboration time parameters<a class="headerlink" href="#elaboration-time-parameters" title="Permalink to this heading"></a></h4>
<p>You can use the whole Scala syntax to provide elaboration time parameters.</p>
<p>The whole syntax means you have the entire power and feature set of the
Scala language at your disposal to solve parameterization requirements for
your project at the level of complexity you choose.</p>
<p>SpinalHDL does not place any opinionated restrictions on how to achieve
your parameterization goals.  As such there are many Scala design patterns
and a few SpinalHDL helpers that can be used to manage parameters that
are suited to different parameter management scenarios.</p>
<p>Here are some examples and ideas of the possibilities:</p>
<blockquote>
<div><ul class="simple">
<li><p>Hardwired code and constants (not strictly parameter management at all
but serves to highlight the most basic mechanism, a code change, not a
parameter data change)</p></li>
<li><p>Constant values provided from a companion object that are static
constants in Scala.</p></li>
<li><p>Values provided to Scala class constructor, often a <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code> that
causes Scala to capture those constructor argument values as constants.</p></li>
<li><p>Regular Scala flow-control syntax, not limited to but including
conditionals, looping, lambdas/monads, everything.</p></li>
<li><p>Config class pattern (examples exist in library items such as
<a class="reference external" href="https://spinalhdl.github.io/SpinalDoc-RTD/master/SpinalHDL/Examples/Intermediates%20ones/uart.html#controller-construction-parameters">UartCtrlConfig</a>, SpiMasterCtrlConfig)</p></li>
<li><p>Project defined ‘Plugin’ pattern (examples exist in the <a class="reference external" href="https://github.com/SpinalHDL/VexRiscv#plugins">VexRiscV</a> project
to configure the feature set the resulting CPU IP core is built with)</p></li>
<li><p>Values and information loaded from a file or network based source, using
standard Scala/JVM libraries and APIs.</p></li>
<li><p><cite>any mechanism you can create</cite></p></li>
</ul>
</div></blockquote>
<p>All of the mechanisms result in a change in resulting elaborated HDL output.</p>
<p>This could vary from a single constant value change all the way through to
describing the entire bus and interconnection architecture of an entire SoC
all without leaving the Scala programming paradigm.</p>
<p>Here is an example of class parameters</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyBus</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mySignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MyBus</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can also use global variable defined in Scala objects (companion object
pattern).</p>
<p>A <a class="reference internal" href="index.html#scopeproperty"><span class="std std-ref">ScopeProperty</span></a> can also be used for configuration.</p>
</section>
<section id="optional-hardware">
<h4>Optional hardware<a class="headerlink" href="#optional-hardware" title="Permalink to this heading"></a></h4>
<p>So here there is more possibilities.</p>
<p id="generate">For optional signal :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mySignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="c1">// equivalent to &quot;val mySignal = if (flag) Bool() else null&quot;</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">generate</span></code> method is a mechanism to evaluate the expression
that follows for an optional value.  If the predicate is true,
generate will evaluate the given expression and return the
result, otherwise it returns null.</p>
<p>This may be used in cases to help parameterize the SpinalHDL hardware
description using an elaboration-time conditional expression.  Causing HDL
constructs to be emitted or not-emitted in the resulting HDL. The generate
method can be seen as SpinalHDL syntactic sugar reducing language clutter.</p>
<p>Project SpinalHDL code referencing <code class="docutils literal notranslate"><span class="pre">mySignal</span></code> would need to ensure it
handles the possibility of null gracefully.  This is usually not a problem
as those parts of the design can also be omitted dependant on the <code class="docutils literal notranslate"><span class="pre">flag</span></code>
value.  Thus the feature of parameterizing this component is demonstrated.</p>
<p>You can do the same in Bundle.</p>
<p>Note that you can also use scala Option.</p>
<p>If you want to disable the generation of a chunk of hardware :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myHardware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// optional hardware here</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can also use scala for loops :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myHardware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// hardware here</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>So, you can extends those scala usages at elaboration time as much as you want, including using the whole scala collections (List, Set, Map, …)
to build some data model and then converting them into hardware in a procedural way (ex iterating over those list elements).</p>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Semantic/index"></span><section id="semantic">
<span id="semantics"></span><h2>Semantic<a class="headerlink" href="#semantic" title="Permalink to this heading"></a></h2>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Semantic/assignments"></span><section id="assignments">
<h3>Assignments<a class="headerlink" href="#assignments" title="Permalink to this heading"></a></h3>
<p>There are multiple assignment operators:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Symbol</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:=</span></code></p></td>
<td><p>Standard assignment, equivalent to <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> in VHDL/Verilog.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">\=</span></code></p></td>
<td><p>Equivalent to <code class="docutils literal notranslate"><span class="pre">:=</span></code> in VHDL and <code class="docutils literal notranslate"><span class="pre">=</span></code> in Verilog. The value is updated instantly in-place. Only works with combinational signals, does not work with registers.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&lt;&gt;</span></code></p></td>
<td><p>Automatic connection between 2 signals or two bundles of the same type. Direction is inferred by using signal direction (in/out). (Similar behavior to <code class="docutils literal notranslate"><span class="pre">:=</span></code>)</p></td>
</tr>
</tbody>
</table>
<p>When muxing (for instance using <code class="docutils literal notranslate"><span class="pre">when</span></code>, see <a class="reference internal" href="index.html#document-SpinalHDL/Semantic/when_switch"><span class="doc">When/Switch/Mux</span></a>.), the last
valid standard assignment <code class="docutils literal notranslate"><span class="pre">:=</span></code> wins. Else, assigning twice to the same assignee
from the same scope results in an assignment overlap.  SpinalHDL will assume
this is a unintentional design error by default and halt elaboration with error.
For special use-cases assignment overlap can be programmatically permitted on a case by case basis.
(see <a class="reference internal" href="index.html#document-SpinalHDL/Design errors/assignment_overlap"><span class="doc">Assignment overlap</span></a>).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="c1">// a := 1 // this would cause an `assignment overlap` error,</span>
<span class="w">          </span><span class="c1">// if manually overridden the assignment would take assignment priority</span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>

<span class="kd">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">x</span><span class="w">      </span><span class="c1">// y read x with the value 0</span>
<span class="n">x</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">z</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">x</span><span class="w">      </span><span class="c1">// z read x with the value 1</span>

<span class="c1">// Automatic connection between two UART interfaces.</span>
<span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"></span>
</pre></div>
</div>
<p>It also supports Bundle assignment (convert all bit signals into a single bit-bus of suitable width of type Bits, to then use that
wider form in an assignment expression).  Bundle multiple signals together using <code class="docutils literal notranslate"><span class="pre">()</span></code> (Scala Tuple syntax) on both the left hand
side and right hand side of an assignment expression.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">e</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">f</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="mi">2</span><span class="w">  </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">()</span><span class="w"></span>

<span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">).</span><span class="n">asBits</span><span class="w">           </span><span class="c1">// both sides</span>
<span class="n">g</span><span class="w">         </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">).</span><span class="n">asBits</span><span class="w">  </span><span class="c1">// and on the right hand side</span>
</pre></div>
</div>
<p>It is important to understand that in SpinalHDL, the nature of a signal (combinational/sequential) is defined in its declaration, not by the way it is assigned.
All datatype instances will define a combinational signal, while a datatype instance wrapped with <code class="docutils literal notranslate"><span class="pre">Reg(...)</span></code> will define a sequential (registered) signal.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">              </span><span class="c1">// Define a combinational signal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w">         </span><span class="c1">// Define a registered signal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// Define a registered signal which is</span>
<span class="w">                                  </span><span class="c1">//  set to 0 when a reset occurs</span>
</pre></div>
</div>
<section id="width-checking">
<h4>Width checking<a class="headerlink" href="#width-checking" title="Permalink to this heading"></a></h4>
<p>SpinalHDL checks that the bit count of the left side and the right side of an assignment matches. There are multiple ways to adapt the width of a given BitVector (<code class="docutils literal notranslate"><span class="pre">Bits</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt</span></code>, <code class="docutils literal notranslate"><span class="pre">SInt</span></code>):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Resizing techniques</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x := y.resized</p></td>
<td><p>Assign x with a resized copy of y, size inferred from x.</p></td>
</tr>
<tr class="row-odd"><td><p>x := y.resize(newWidth)</p></td>
<td><p>Assign x with a resized copy of y <code class="code docutils literal notranslate"><span class="pre">newWidth</span></code> bits wide.</p></td>
</tr>
<tr class="row-even"><td><p>x := y.resizeLeft(newWidth)</p></td>
<td><p>Assign x with a resized copy of y <code class="code docutils literal notranslate"><span class="pre">newWidth</span></code> bits wide. Pads at the LSB if needed.</p></td>
</tr>
</tbody>
</table>
<p>All resize methods may cause the resulting width to be wider or narrower than the
original width of <code class="code docutils literal notranslate"><span class="pre">y</span></code>. When widening occurs the extra bits are padded
with zeros.</p>
<p>The inferred conversion with <code class="docutils literal notranslate"><span class="pre">x.resized</span></code> is based on the target width on the left hand side of
the assignment expression being resolved and obeys the same semantics as <code class="docutils literal notranslate"><span class="pre">y.resize(someWidth)</span></code>.
The expression <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">:=</span> <span class="pre">y.resized</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">:=</span> <span class="pre">y.resize(x.getBitsWidth</span> <span class="pre">bits)</span></code>.</p>
<p>While the example code snippets show the use of an assignment statement, the
resize family of methods can be chained like any ordinary Scala method.</p>
<p>There is one case where Spinal automatically resizes a value:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// U(3) creates an UInt of 2 bits, which doesn&#39;t match the left side (8 bits)</span>
<span class="n">myUIntOf_8bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">U(3)</span></code> is a “weak” bit count inferred signal, SpinalHDL widens it automatically.
This can be considered to be functionally equivalent to <code class="docutils literal notranslate"><span class="pre">U(3,</span> <span class="pre">2</span> <span class="pre">bits).resized</span></code>
However rest reassured SpinalHDL will do the correct thing and continue to flag an error
if the scenario would require narrowing. An error is reported if the literal required 9
bits (e.g. <code class="docutils literal notranslate"><span class="pre">U(0x100)</span></code>) when trying to assign into <code class="docutils literal notranslate"><span class="pre">myUIntOf_8bits</span></code>.</p>
</section>
<section id="combinatorial-loops">
<h4>Combinatorial loops<a class="headerlink" href="#combinatorial-loops" title="Permalink to this heading"></a></h4>
<p>SpinalHDL checks that there are no combinatorial loops (latches) in your design.
If one is detected, it raises an error and SpinalHDL will print the path of the loop.</p>
</section>
<section id="combinit">
<h4>CombInit<a class="headerlink" href="#combinit" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">CombInit</span></code> can be used to copy a signal and its current combinatorial assignments. The main use-case is to be able to overwrite the copied later, without impacting the original signal.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="c1">// At this point, a and b are evaluated to 2: they reference the same signal</span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CombInit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"></span>
<span class="c1">// Here c and d are evaluated to 1</span>
<span class="n">when</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="c1">// At this point c === 1 and d === 2.</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If we look at the resulting Verilog, <code class="docutils literal notranslate"><span class="pre">b</span></code> is not present. Since it is a copy of <code class="docutils literal notranslate"><span class="pre">a</span></code> by reference, these variables designate the same Verilog <code class="docutils literal notranslate"><span class="pre">wire</span></code>.</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h01</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h02</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">assign</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h01</span><span class="p">;</span><span class="w"></span>
<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h02</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CombInit</span></code> is particularly helpful in helper functions to ensure that the returned value is not referencing an input.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// note that condition is an elaboration time constant</span>
<span class="k">def</span><span class="w"> </span><span class="nf">invertedIf</span><span class="p">(</span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">,</span><span class="w"> </span><span class="n">condition</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">~</span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nc">CombInit</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertedIf</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">a2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Without <code class="docutils literal notranslate"><span class="pre">CombInit</span></code>, if <code class="docutils literal notranslate"><span class="pre">c</span></code> == false (but not if <code class="docutils literal notranslate"><span class="pre">c</span></code> == true), <code class="docutils literal notranslate"><span class="pre">a1</span></code> and <code class="docutils literal notranslate"><span class="pre">a2</span></code> reference the same signal and the zero assignment is also applied to <code class="docutils literal notranslate"><span class="pre">a1</span></code>.
With <code class="docutils literal notranslate"><span class="pre">CombInit</span></code> we have a coherent behavior whatever the <code class="docutils literal notranslate"><span class="pre">c</span></code> value.</p>
</section>
</section>
<span id="document-SpinalHDL/Semantic/when_switch"></span><section id="when-switch-mux">
<h3>When/Switch/Mux<a class="headerlink" href="#when-switch-mux" title="Permalink to this heading"></a></h3>
<section id="when">
<h4>When<a class="headerlink" href="#when" title="Permalink to this heading"></a></h4>
<p>As in VHDL and Verilog, signals can be conditionally assigned when a specified condition is met:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">cond1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Execute when cond1 is true</span>
<span class="p">}</span><span class="w"> </span><span class="n">elsewhen</span><span class="p">(</span><span class="n">cond2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Execute when (not cond1) and cond2</span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Execute when (not cond1) and (not cond2)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the keyword <code class="docutils literal notranslate"><span class="pre">otherwise</span></code> is on the same line as the closing bracket <code class="docutils literal notranslate"><span class="pre">}</span></code> of the <code class="docutils literal notranslate"><span class="pre">when</span></code> condition, no dot is needed.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">cond1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute when cond1 is true</span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute when (not cond1) and (not cond2)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But if <code class="docutils literal notranslate"><span class="pre">.otherwise</span></code> is on another line, a dot is <strong>required</strong>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">cond1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute when cond1 is true</span>
<span class="p">}</span><span class="w"></span>
<span class="p">.</span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute when (not cond1) and (not cond2)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</section>
<section id="whenbuilder">
<h4>WhenBuilder<a class="headerlink" href="#whenbuilder" title="Permalink to this heading"></a></h4>
<p>Sometimes we need to generate some parameters for the when condition,
and the original structure of <code class="docutils literal notranslate"><span class="pre">when</span></code>/<code class="docutils literal notranslate"><span class="pre">otherwise</span></code> is not very suitable.
Therefore, we provide a ‘whenBuilder’ method to achieve this goal:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">conds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">WhenBuilder</span><span class="p">()</span><span class="w"></span>
<span class="n">ctx</span><span class="p">.</span><span class="n">when</span><span class="p">(</span><span class="n">conds</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">ctx</span><span class="p">.</span><span class="n">when</span><span class="p">(</span><span class="n">conds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ctx</span><span class="p">.</span><span class="n">when</span><span class="p">(</span><span class="n">conds</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">ctx</span><span class="p">.</span><span class="n">when</span><span class="p">(</span><span class="n">conds</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Compared to the <code class="docutils literal notranslate"><span class="pre">when</span></code>/<code class="docutils literal notranslate"><span class="pre">elsewhen</span></code>/<code class="docutils literal notranslate"><span class="pre">otherwise</span></code> approach, it might be more convenient for parameterization.
we can also use like this:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">when</span><span class="p">(</span><span class="n">conds</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">ctx</span><span class="p">.</span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">255</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">switch</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">addressElements</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">rdata</span><span class="w"> </span><span class="o">:=</span><span class="w">  </span><span class="n">buffer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This way, we can parameterize priority circuits similar to how we use ‘foreach’ inside ‘switch()’, and generate code in a more intuitive if-else format.</p>
</section>
<section id="switch">
<h4>Switch<a class="headerlink" href="#switch" title="Permalink to this heading"></a></h4>
<p>As in VHDL and Verilog, signals can be conditionally assigned when a signal has a defined value:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute when x === value1</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute when x === value2</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Execute if none of precedent conditions met</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">is</span></code> clauses can be factorized (logical OR) by separating them with a comma <code class="docutils literal notranslate"><span class="pre">is(value1,</span> <span class="pre">value2)</span></code>.</p>
<section id="example">
<h5>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">(</span><span class="n">aluop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">add</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">immI</span><span class="p">.</span><span class="n">signExtend</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">slt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">immI</span><span class="p">.</span><span class="n">signExtend</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">sltu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">immI</span><span class="p">.</span><span class="n">signExtend</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">sll</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">shamt</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">sra</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">shamt</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>is equivalent to</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">(</span><span class="n">aluop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">add</span><span class="p">,</span><span class="w"> </span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">slt</span><span class="p">,</span><span class="w"> </span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">sltu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">immI</span><span class="p">.</span><span class="n">signExtend</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">sll</span><span class="p">,</span><span class="w"> </span><span class="nc">ALUOp</span><span class="p">.</span><span class="n">sra</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">immediate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="p">.</span><span class="n">shamt</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="additional-options">
<h5>Additional options<a class="headerlink" href="#additional-options" title="Permalink to this heading"></a></h5>
<p>By default, SpinalHDL will generate an “UNREACHABLE DEFAULT STATEMENT” error if a <code class="docutils literal notranslate"><span class="pre">switch</span></code> contains a <code class="docutils literal notranslate"><span class="pre">default</span></code> statement while all the possible logical values of the <code class="docutils literal notranslate"><span class="pre">switch</span></code> are already covered by the <code class="docutils literal notranslate"><span class="pre">is</span></code> statements. You can drop this error reporting by specifying `` switch(myValue, coverUnreachable = true) { … }``.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">(</span><span class="n">my2Bits</span><span class="p">,</span><span class="w"> </span><span class="n">coverUnreachable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">default</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// This will parse and validate without error now</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This check is done on the logical values, not on the physical values. For instance, if you have a SpinalEnum(A,B,C) encoded in a one-hot manner, SpinalHDL will only care about the A,B,C values (“001” “010” “100”). Physical values as “000” “011” “101” “110” “111” will not be taken in account.</p>
</div>
<p>By default, SpinalHDL will generate a “DUPLICATED ELEMENTS IN SWITCH IS(…) STATEMENT” error if a given <code class="docutils literal notranslate"><span class="pre">is</span></code> statement provides multiple times the same value. For instance <code class="docutils literal notranslate"><span class="pre">is(42,42)</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code>
You can drop this error reporting by specifying <code class="docutils literal notranslate"><span class="pre">switch(myValue,</span> <span class="pre">strict</span> <span class="pre">=</span> <span class="pre">true){</span> <span class="pre">...</span> <span class="pre">}</span></code>. SpinalHDL will then take care of removing duplicated values.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">strict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// This will be okay</span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="local-declaration">
<h4>Local declaration<a class="headerlink" href="#local-declaration" title="Permalink to this heading"></a></h4>
<p>It is possible to define new signals inside a when/switch statement:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SpinalHDL checks that signals defined inside a scope are only assigned inside that scope.</p>
</div>
</section>
<section id="mux">
<h4>Mux<a class="headerlink" href="#mux" title="Permalink to this heading"></a></h4>
<p>If you just need a <code class="docutils literal notranslate"><span class="pre">Mux</span></code> with a <code class="docutils literal notranslate"><span class="pre">Bool</span></code> selection signal, there are two equivalent syntaxes:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 44%" />
<col style="width: 11%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Mux(cond, whenTrue, whenFalse)</p></td>
<td><p>T</p></td>
<td><p>Return <code class="docutils literal notranslate"><span class="pre">whenTrue</span></code> when <code class="docutils literal notranslate"><span class="pre">cond</span></code> is True, <code class="docutils literal notranslate"><span class="pre">whenFalse</span></code> otherwise</p></td>
</tr>
<tr class="row-odd"><td><p>cond ? whenTrue | whenFalse</p></td>
<td><p>T</p></td>
<td><p>Return <code class="docutils literal notranslate"><span class="pre">whenTrue</span></code> when <code class="docutils literal notranslate"><span class="pre">cond</span></code> is True, <code class="docutils literal notranslate"><span class="pre">whenFalse</span></code> otherwise</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">whenTrue</span><span class="p">,</span><span class="w"> </span><span class="n">whenFalse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">muxOutput</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">whenTrue</span><span class="p">,</span><span class="w"> </span><span class="n">whenFalse</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">muxOutput2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">whenTrue</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">whenFalse</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bitwise-selection">
<h4>Bitwise selection<a class="headerlink" href="#bitwise-selection" title="Permalink to this heading"></a></h4>
<p>A bitwise selection looks like the VHDL <code class="docutils literal notranslate"><span class="pre">when</span></code> syntax.</p>
<section id="id1">
<h5>Example<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">bitwiseSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">bitwiseResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitwiseSelect</span><span class="p">.</span><span class="n">mux</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">src1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">src1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">src1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mux</span></code> checks that all possible values are covered to prevent generation of latches.
If all possible values are covered, the default statement must not be added:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">bitwiseSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">bitwiseResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitwiseSelect</span><span class="p">.</span><span class="n">mux</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">src1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">src1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">src1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">src0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">muxList(...)</span></code> and <code class="docutils literal notranslate"><span class="pre">muxListDc(...)</span></code> are alternatives bitwise selectors that take a sequence of tuples or mappings as input.</p>
<p><code class="docutils literal notranslate"><span class="pre">muxList</span></code> can be used as a direct replacement for <code class="docutils literal notranslate"><span class="pre">mux</span></code>, providing a easier to use interface in code that generates the cases.
It has the same checking behavior as <code class="docutils literal notranslate"><span class="pre">mux</span></code> does, requiring full coverage and prohibiting listing a default if it is not needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">muxtListDc</span></code> can be used if the uncovered values are not important, they can be left unassigned by using <code class="docutils literal notranslate"><span class="pre">muxListDc</span></code>.
This will add a default case if needed. This default case will generate X’s during the simulation if ever encountered.
<code class="docutils literal notranslate"><span class="pre">muxListDc(...)</span></code> is often a good alternative in generic code.</p>
<p>Below is an example of dividing a <code class="docutils literal notranslate"><span class="pre">Bits</span></code> of 128 bits into 32 bits:</p>
<a class="reference internal image-reference" href="_images/MuxList.png"><img alt="_images/MuxList.png" class="align-center" src="_images/MuxList.png" style="width: 300px;" /></a>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">128</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Dividing a wide Bits type into smaller chunks, using a mux:</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dataWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sel</span><span class="p">.</span><span class="n">muxList</span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">                           </span><span class="k">yield</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="mi">32</span><span class="o">+</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="n">index</span><span class="o">*</span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>

<span class="c1">// A shorter way to do the same thing:</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dataWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">subdivideIn</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)(</span><span class="n">sel</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Example for <code class="docutils literal notranslate"><span class="pre">muxListDc</span></code> selecting bits from a configurable width vector:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Example</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 2 bit wide for default width</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">// no need to cover missing case 3 for default width</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dataByte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sel</span><span class="p">.</span><span class="n">muxListDc</span><span class="p">(</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Semantic/rules"></span><section id="rules">
<h3>Rules<a class="headerlink" href="#rules" title="Permalink to this heading"></a></h3>
<p>The semantics behind SpinalHDL are important to learn, so that you understand what is really happening behind the scenes, and how to control it.</p>
<p>These semantics are defined by multiple rules:</p>
<ul class="simple">
<li><p>Signals and registers are operating concurrently with each other (parallel behavioral, as in VHDL and Verilog)</p></li>
<li><p>An assignment to a combinational signal is like expressing a rule which is always true</p></li>
<li><p>An assignment to a register is like expressing a rule which is applied on each cycle of its clock domain</p></li>
<li><p>For each signal, the last valid assignment wins</p></li>
<li><p>Each signal and register can be manipulated as an object during hardware elaboration in a <a class="reference external" href="https://en.wikipedia.org/wiki/Object-oriented_programming">OOP</a> manner</p></li>
</ul>
<section id="concurrency">
<h4>Concurrency<a class="headerlink" href="#concurrency" title="Permalink to this heading"></a></h4>
<p>The order in which you assign each combinational or registered signal has no behavioral impact.</p>
<p>For example, both of the following pieces of code are equivalent:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// Define 3 combinational signals</span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="c1">// c will be set to 7</span>
<span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w">      </span><span class="c1">// b will be set to 2</span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="c1">// a will be set to 5</span>
</pre></div>
</div>
<p>This is equivalent to:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// Define 3 combinational signals</span>
<span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w">      </span><span class="c1">// b will be set to 2</span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="c1">// a will be set to 5</span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="c1">// c will be set to 7</span>
</pre></div>
</div>
<p>More generally, when you use the <code class="docutils literal notranslate"><span class="pre">:=</span></code> assignment operator, it’s like specifying an additional new rule for the left side signal/register.</p>
</section>
<section id="last-valid-assignment-wins">
<h4>Last valid assignment wins<a class="headerlink" href="#last-valid-assignment-wins" title="Permalink to this heading"></a></h4>
<p>If a combinational signal or register is assigned multiple times through the
use of the SpinalHDL <code class="docutils literal notranslate"><span class="pre">:=</span></code> operator, the last assignment that may execute wins
(and so gets to set the value as a result for this state).</p>
<p>It could be said that top to bottom evaluation occurs based on the state that
exists at that time.  If your upstream signal inputs are driven from registers
and so have synchronous behavior, then it could be said that at each clock
cycle the assignments are re-evaluated based on the new state at the time.</p>
<p>Some reasons why an assignment statement may not get to execute in hardware this
clock cycle, maybe due to it being wrapped in a <code class="docutils literal notranslate"><span class="pre">when(cond)</span></code> clause.</p>
<p>Another reason maybe that the SpinalHDL code never made it through elaboration
because the feature was parameterized and disabled during HDL code-generation,
see <code class="docutils literal notranslate"><span class="pre">paramIsFalse</span></code> use below.</p>
<p>As an example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Every clock cycle  evaluation starts here</span>
<span class="kd">val</span><span class="w"> </span><span class="n">paramIsFalse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w">           </span><span class="c1">// Define two combinational signals</span>
<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">   </span><span class="c1">// Define a combinational signal</span>

<span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="n">paramIsFalse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">          </span><span class="c1">// This assignment should win as it is last, but it was never elaborated</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="w">               </span><span class="c1">//  into hardware due to the use of if() and it evaluating to false at the time</span>
<span class="p">}</span><span class="w">                           </span><span class="c1">//  of elaboration.  The three := assignments above are elaborated into hardware.</span>
</pre></div>
</div>
<p>This will produce the following truth table:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>x</p></th>
<th class="head"><p>y</p></th>
<th class="head"><p>=&gt;</p></th>
<th class="head"><p>result</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>False</p></td>
<td><p>False</p></td>
<td></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>False</p></td>
<td><p>True</p></td>
<td></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>True</p></td>
<td><p>False</p></td>
<td></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>True</p></td>
<td><p>True</p></td>
<td></td>
<td><p>3</p></td>
</tr>
</tbody>
</table>
</section>
<section id="signal-and-register-interactions-with-scala-oop-reference-functions">
<h4>Signal and register interactions with Scala (OOP reference + Functions)<a class="headerlink" href="#signal-and-register-interactions-with-scala-oop-reference-functions" title="Permalink to this heading"></a></h4>
<p>In SpinalHDL, each hardware element is modeled by a class instance. This means you can manipulate instances by using their references, such as passing them as arguments to a function.</p>
<p>As an example, the following code implements a register which is incremented when <code class="docutils literal notranslate"><span class="pre">inc</span></code> is True and cleared when <code class="docutils literal notranslate"><span class="pre">clear</span></code> is True (<code class="docutils literal notranslate"><span class="pre">clear</span></code> has priority over <code class="docutils literal notranslate"><span class="pre">inc</span></code>) :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w">          </span><span class="c1">// Define two combinational signals/wires</span>
<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w">  </span><span class="c1">// Define an 8 bit register</span>

<span class="n">when</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w">    </span><span class="c1">// If inc and clear are True, then this  assignment wins</span>
<span class="p">}</span><span class="w">                 </span><span class="c1">//  (last value assignment wins rule)</span>
</pre></div>
</div>
<p>You can implement exactly the same functionality by mixing the previous example with a function that assigns to <code class="docutils literal notranslate"><span class="pre">counter</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">setCounter</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">setCounter</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// Set counter with counter + 1</span>
<span class="p">}</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can also integrate the conditional check inside the function:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">setCounterWhen</span><span class="p">(</span><span class="n">cond</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">,</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">setCounterWhen</span><span class="p">(</span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inc</span><span class="p">,</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">setCounterWhen</span><span class="p">(</span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clear</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>And also specify what should be assigned to the function:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">setSomethingWhen</span><span class="p">(</span><span class="n">something</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">,</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">something</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">setSomethingWhen</span><span class="p">(</span><span class="n">something</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inc</span><span class="p">,</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">setSomethingWhen</span><span class="p">(</span><span class="n">something</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clear</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>All of the previous examples are strictly equivalent both in their generated RTL and also in the SpinalHDL compiler’s perspective.
This is because SpinalHDL only cares about the Scala runtime and the objects instantiated there, it doesn’t care about the Scala syntax itself.</p>
<p>In other words, from a generated RTL generation / SpinalHDL perspective, when you use functions in Scala which generate hardware, it is like the function was inlined.
This is also true case for Scala loops, as they will appear in unrolled form in the generated RTL.</p>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Sequential logic/index"></span><section id="sequential-logic">
<h2>Sequential logic<a class="headerlink" href="#sequential-logic" title="Permalink to this heading"></a></h2>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Sequential logic/registers"></span><section id="registers">
<span id="reg"></span><h3>Registers<a class="headerlink" href="#registers" title="Permalink to this heading"></a></h3>
<p>Creating registers in SpinalHDL is very different than in VHDL or Verilog.</p>
<p>In Spinal, there are no process/always blocks. Registers are explicitly defined at declaration.
This difference from traditional event-driven HDL has a big impact:</p>
<ul class="simple">
<li><p>You can assign registers and signals in the same scope, meaning the code doesn’t need to be split between process/always blocks</p></li>
<li><p>It make things much more flexible (see <a class="reference internal" href="index.html#function"><span class="std std-ref">Functions</span></a>)</p></li>
</ul>
<p>Clocks and resets are handled separately, see the <a class="reference internal" href="index.html#clock-domain"><span class="std std-ref">Clock domain</span></a> chapter for details.</p>
<section id="instantiation">
<h4>Instantiation<a class="headerlink" href="#instantiation" title="Permalink to this heading"></a></h4>
<p>There are 4 ways to instantiate a register:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 48%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Reg(type</span> <span class="pre">:</span> <span class="pre">Data)</span></code></p></td>
<td><p>Register of the given type</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RegInit(resetValue</span> <span class="pre">:</span> <span class="pre">Data)</span></code></p></td>
<td><p>Register loaded with the given <code class="docutils literal notranslate"><span class="pre">resetValue</span></code> when a reset occurs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RegNext(nextValue</span> <span class="pre">:</span> <span class="pre">Data)</span></code></p></td>
<td><p>Register that samples the given <code class="docutils literal notranslate"><span class="pre">nextValue</span></code> each cycle</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RegNextWhen(nextValue</span> <span class="pre">:</span> <span class="pre">Data,</span> <span class="pre">cond</span> <span class="pre">:</span> <span class="pre">Bool)</span></code></p></td>
<td><p>Register that samples the given <code class="docutils literal notranslate"><span class="pre">nextValue</span></code> when a condition occurs</p></td>
</tr>
</tbody>
</table>
<p>Here is an example declaring some registers:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// UInt register of 4 bits</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="c1">// Register that updates itself every cycle with a sample of reg1 incremented by 1</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">reg1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="c1">// UInt register of 4 bits initialized with 0 when the reset occurs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">U</span><span class="s">&quot;0000&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">reg3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reg2</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">reg2</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">reg3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xF</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Register that samples reg3 when cond is True</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNextWhen</span><span class="p">(</span><span class="n">reg3</span><span class="p">,</span><span class="w"> </span><span class="n">cond</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>The code above will infer the following logic:</p>
<img alt="_images/register.svg" class="align-center" src="_images/register.svg" /><div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">reg3</span></code> example above shows how you can assign the value of a <code class="docutils literal notranslate"><span class="pre">RegInit</span></code> register.
It’s possible to use the same syntax to assign to the other register types as well (<code class="docutils literal notranslate"><span class="pre">Reg</span></code>, <code class="docutils literal notranslate"><span class="pre">RegNext</span></code>, <code class="docutils literal notranslate"><span class="pre">RegNextWhen</span></code>).
Just like in combinational assignments, the rule is ‘Last assignment wins’, but if no assignment is done, the register keeps its value.
If the Reg is declared in a design and does not have suitable assignment and consumption it is likely to be pruned (removed from design) at some point by EDA flows after being deemed unnecessary.</p>
</div>
<p id="regnext">Also, <code class="docutils literal notranslate"><span class="pre">RegNext</span></code> is an abstraction which is built over the <code class="docutils literal notranslate"><span class="pre">Reg</span></code> syntax. The two following sequences of code are strictly equivalent:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Standard way</span>
<span class="kd">val</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">something</span><span class="w"></span>

<span class="c1">// Short way</span>
<span class="kd">val</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>It is possible to have multiple options at the same time in other ways and so
slightly more advanced compositions built on top of the basic understand of
the above:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// UInt register of 6 bits (initialized with 42 when the reset occurs)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Register that samples reg1 each cycle (initialized with 0 when the reset occurs)</span>
<span class="c1">// using Scala named parameter argument format</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">reg1</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Register that has multiple features combined</span>

<span class="c1">// My register enable signal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg3Enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="c1">// UInt register of 6 bits (inferred from reg1 type)</span>
<span class="c1">//   assignment preconfigured to update from reg1</span>
<span class="c1">//   only updated when reg3Enable is set</span>
<span class="c1">//   initialized with 99 when the reset occurs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNextWhen</span><span class="p">(</span><span class="n">reg1</span><span class="p">,</span><span class="w"> </span><span class="n">reg3Enable</span><span class="p">,</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">99</span><span class="p">))</span><span class="w"></span>
<span class="c1">// when(reg3Enable) {</span>
<span class="c1">//   reg3 := reg1; // this expression is implied in the constructor use case</span>
<span class="c1">// }</span>

<span class="n">when</span><span class="p">(</span><span class="n">cond2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">// this is a valid assignment, will take priority when executed</span>
<span class="w">   </span><span class="n">reg3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="c1">//  (due to last assignment wins rule), assignment does not require</span>
<span class="p">}</span><span class="w">                  </span><span class="c1">//  reg3Enable condition, you would use `when(cond2 &amp; reg3Enable)` for that</span>

<span class="c1">// UInt register of 8 bits, initialized with 99 when the reset occurs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">99</span><span class="p">))</span><span class="w"></span>
<span class="c1">// My register enable signal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg4Enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="c1">// no implied assignments exist, you must use enable explicitly as necessary</span>
<span class="n">when</span><span class="p">(</span><span class="n">reg4Enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">reg4</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">newValue</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="reset-value">
<h4>Reset value<a class="headerlink" href="#reset-value" title="Permalink to this heading"></a></h4>
<p>In addition to the <code class="docutils literal notranslate"><span class="pre">RegInit(value</span> <span class="pre">:</span> <span class="pre">Data)</span></code> syntax which directly creates the register with a reset value,
you can also set the reset value by calling the <code class="docutils literal notranslate"><span class="pre">init(value</span> <span class="pre">:</span> <span class="pre">Data)</span></code> function on the register.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// UInt register of 4 bits initialized with 0 when the reset occurs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>If you have a register containing a Bundle, you can use the <code class="docutils literal notranslate"><span class="pre">init</span></code> function on each element of the Bundle.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ValidRGB</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">ValidRGB</span><span class="p">())</span><span class="w"></span>
<span class="n">reg</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w">  </span><span class="c1">// Only the valid if that register bundle will have a reset value.</span>
</pre></div>
</div>
</section>
<section id="initialization-value-for-simulation-purposes">
<h4>Initialization value for simulation purposes<a class="headerlink" href="#initialization-value-for-simulation-purposes" title="Permalink to this heading"></a></h4>
<p>For registers that don’t need a reset value in RTL, but need an initialization value for simulation (to avoid x-propagation), you can ask for a random initialization value by calling the <code class="docutils literal notranslate"><span class="pre">randBoot()</span></code> function.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// UInt register of 4 bits initialized with a random value</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">randBoot</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="register-vectors">
<h4>Register vectors<a class="headerlink" href="#register-vectors" title="Permalink to this heading"></a></h4>
<p>As for signals, it is possible to define a vector of registers with <code class="docutils literal notranslate"><span class="pre">Vec</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">vecReg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">vecReg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">8</span><span class="p">)(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">()))</span><span class="w"></span>
</pre></div>
</div>
<p>Initialization can be done with the <code class="docutils literal notranslate"><span class="pre">init</span></code> method as usual, which can be combined with the <code class="docutils literal notranslate"><span class="pre">foreach</span></code> iteration on the registers.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">vecReg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">vecReg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">8</span><span class="p">)(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">()))</span><span class="w"></span>
<span class="n">vecReg2</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>In case where the initialization must be deferred since the init value is not known, use a function as in the example below.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ShiftRegister</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">HardType</span><span class="p">[</span><span class="nc">T</span><span class="p">],</span><span class="w"> </span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">initFunc</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">dataType</span><span class="p">())</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">depth</span><span class="p">)(</span><span class="nc">Reg</span><span class="p">(</span><span class="n">dataType</span><span class="p">()))</span><span class="w"></span>
<span class="w">   </span><span class="n">regs</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">initFunc</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="p">(</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">regs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">regs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">regs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">input</span><span class="w"></span>
<span class="w">   </span><span class="n">io</span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">regs</span><span class="p">(</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">SRConsumer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">initIdleFlow</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">flow</span><span class="p">:</span><span class="w"> </span><span class="nc">Flow</span><span class="p">[</span><span class="nc">T</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">flow</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">SRConsumer</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// ...</span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">sr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ShiftRegister</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)),</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nc">SRConsumer</span><span class="p">.</span><span class="n">initIdleFlow</span><span class="p">[</span><span class="nc">UInt</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="transforming-a-signal-into-a-register">
<h4>Transforming a signal into a register<a class="headerlink" href="#transforming-a-signal-into-a-register" title="Permalink to this heading"></a></h4>
<p>Sometimes it is useful to transform an existing signal into a register. For
instance, when you are using a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>, if you want some outputs of the bundle to
be registers, you might prefer to write <code class="docutils literal notranslate"><span class="pre">io.myBundle.PORT</span> <span class="pre">:=</span> <span class="pre">newValue</span></code> without
declaring registers with <code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">PORT</span> <span class="pre">=</span> <span class="pre">Reg(...)</span></code> and connecting their output to
the port with <code class="docutils literal notranslate"><span class="pre">io.myBundle.PORT</span> <span class="pre">:=</span> <span class="pre">PORT</span></code>. To do this, you just need to use
<code class="docutils literal notranslate"><span class="pre">.setAsReg()</span></code> on the ports you want to control as registers:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="n">apb3Config</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PADDR</span><span class="p">.</span><span class="n">setAsReg</span><span class="p">()</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PWRITE</span><span class="p">.</span><span class="n">setAsReg</span><span class="p">()</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">someCondition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PWRITE</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Notice in the code above that you can also specify an initialization value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The register is created in the clock domain of the signal, and does not depend
on the place where <code class="docutils literal notranslate"><span class="pre">.setAsReg()</span></code> is used.</p>
<p>In the example above, the signal is defined in the <code class="docutils literal notranslate"><span class="pre">io</span></code> Bundle, in the same
clock domain as the component. Even if <code class="docutils literal notranslate"><span class="pre">io.apb.PADDR.setAsReg()</span></code> was
written in a <code class="docutils literal notranslate"><span class="pre">ClockingArea</span></code> with a different clock domain, the register
would use the clock domain of the component and not the one of the
<code class="docutils literal notranslate"><span class="pre">ClockingArea</span></code>.</p>
</div>
</section>
</section>
<span id="document-SpinalHDL/Sequential logic/memory"></span><section id="ram-rom-memory">
<h3>RAM/ROM Memory<a class="headerlink" href="#ram-rom-memory" title="Permalink to this heading"></a></h3>
<p>To create a memory in SpinalHDL, the <code class="docutils literal notranslate"><span class="pre">Mem</span></code> class should be used.
It allows you to define a memory and add read and write ports to it.</p>
<p>The following table shows how to instantiate a memory:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Mem(type</span> <span class="pre">:</span> <span class="pre">Data,</span> <span class="pre">size</span> <span class="pre">:</span> <span class="pre">Int)</span></code></p></td>
<td><p>Create a RAM</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Mem(type</span> <span class="pre">:</span> <span class="pre">Data,</span> <span class="pre">initialContent</span> <span class="pre">:</span> <span class="pre">Array[Data])</span></code></p></td>
<td><p>Create a ROM. If your target is an FPGA, because the memory can be inferred as a block ram, you can still create write ports on it.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to define a ROM, elements of the <code class="docutils literal notranslate"><span class="pre">initialContent</span></code> array should only be literal values (no operator, no resize functions). There is an example <a class="reference internal" href="index.html#sinus-rom"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To give a RAM initial values, you can also use the <code class="docutils literal notranslate"><span class="pre">init</span></code> function.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Write mask width is flexible, and subdivide the memory word in as many slices of equal width as the width of the mask.
For instance if you have a 32 bits memory word and provide a 4 bits mask then it will be a byte mask. If you provide a as many mask bits than you have word bits, then it is a bit mask.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Manipulation of <code class="docutils literal notranslate"><span class="pre">Mem</span></code> is possible in simulation, see section <a class="reference internal" href="index.html#simulation-of-memory"><span class="std std-ref">Load and Store of Memory in Simulation</span></a>.</p>
</div>
<p>The following table show how to add access ports on a memory :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 3%" />
<col style="width: 94%" />
<col style="width: 3%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>mem(address) := data</p></td>
<td><p>Synchronous write</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>mem(x)</p></td>
<td><p>Asynchronous read</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">mem.write(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">data</div>
<div class="line">[enable]</div>
<div class="line">[mask]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Synchronous write with an optional mask.</div>
<div class="line">If no enable is specified, it’s automatically inferred from the conditional scope where this function is called</div>
</div>
</td>
<td></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">mem.readAsync(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">[readUnderWrite]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Asynchronous read with an optional read-under-write policy</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">mem.readSync(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">[enable]</div>
<div class="line">[readUnderWrite]</div>
<div class="line">[clockCrossing]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Synchronous read with an optional enable, read-under-write policy, and <code class="docutils literal notranslate"><span class="pre">clockCrossing</span></code> mode</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">mem.readWriteSync(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">data</div>
<div class="line">enable</div>
<div class="line">write</div>
<div class="line">[mask]</div>
<div class="line">[readUnderWrite]</div>
<div class="line">[clockCrossing]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Infer a read/write port.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">data</span></code> is written when <code class="docutils literal notranslate"><span class="pre">enable</span> <span class="pre">&amp;&amp;</span> <span class="pre">write</span></code>.</div>
<div class="line">Return the read data, the read occurs when <code class="docutils literal notranslate"><span class="pre">enable</span></code> is true</div>
</div>
</td>
<td><p>T</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If for some reason you need a specific memory port which is not implemented in Spinal, you can always abstract over your memory by specifying a BlackBox for it.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Memory ports in SpinalHDL are not inferred, but are explicitly defined. You should not use coding templates like in VHDL/Verilog to help the synthesis tool to infer memory.</p>
</div>
<p>Here is a example which infers a simple dual port ram (32 bits * 256):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"></span>
<span class="n">mem</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">enable</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">writeValid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">writeAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">data</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">writeData</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">readData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">enable</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">readValid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">readAddress</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<section id="synchronous-enable-quirk">
<h4>Synchronous enable quirk<a class="headerlink" href="#synchronous-enable-quirk" title="Permalink to this heading"></a></h4>
<p>When enable signals are used in a block guarded by a conditional block like <cite>when</cite>, only the enable signal will be generated as the access condition: the <cite>when</cite> condition is ignored.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">rdata</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rom</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">rdEna</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In the example above the condition <cite>cond</cite> will not be elaborated.
Prefer to include the condition <cite>cond</cite> in the enable signal directly as below.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="p">.</span><span class="n">rdata</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rom</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">rdEna</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">cond</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="read-under-write-policy">
<h4>Read-under-write policy<a class="headerlink" href="#read-under-write-policy" title="Permalink to this heading"></a></h4>
<p>This policy specifies how a read is affected when a write occurs in the same cycle to the same address.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Kinds</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dontCare</span></code></p></td>
<td><p>Don’t care about the read value when the case occurs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">readFirst</span></code></p></td>
<td><p>The read will get the old value (before the write)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">writeFirst</span></code></p></td>
<td><p>The read will get the new value (provided by the write)</p></td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The generated VHDL/Verilog is always in the <code class="docutils literal notranslate"><span class="pre">readFirst</span></code> mode, which is compatible with <code class="docutils literal notranslate"><span class="pre">dontCare</span></code> but not with <code class="docutils literal notranslate"><span class="pre">writeFirst</span></code>. To generate a design that contains this kind of feature, you need to enable <a class="reference internal" href="#automatic-memory-blackboxing"><span class="std std-ref">automatic memory blackboxing</span></a>.</p>
</div>
</section>
<section id="mixed-width-ram">
<h4>Mixed-width ram<a class="headerlink" href="#mixed-width-ram" title="Permalink to this heading"></a></h4>
<p>You can specify ports that access the memory with a width that is a power of two fraction of the memory width using these functions:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">mem.writeMixedWidth(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">data</div>
<div class="line">[readUnderWrite]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Similar to <code class="docutils literal notranslate"><span class="pre">mem.write</span></code></p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">mem.readAsyncMixedWidth(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">data</div>
<div class="line">[readUnderWrite]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Similar to <code class="docutils literal notranslate"><span class="pre">mem.readAsync</span></code>, but in place of returning the read value, it drives the signal/object given as the <code class="docutils literal notranslate"><span class="pre">data</span></code> argument</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">mem.readSyncMixedWidth(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">data</div>
<div class="line">[enable]</div>
<div class="line">[readUnderWrite]</div>
<div class="line">[clockCrossing]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Similar to <code class="docutils literal notranslate"><span class="pre">mem.readSync</span></code>, but in place of returning the read value, it drives the signal/object given as the <code class="docutils literal notranslate"><span class="pre">data</span></code> argument</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">mem.readWriteSyncMixedWidth(</div>
<div class="line-block">
<div class="line">address</div>
<div class="line">data</div>
<div class="line">enable</div>
<div class="line">write</div>
<div class="line">[mask]</div>
<div class="line">[readUnderWrite]</div>
<div class="line">[clockCrossing]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Equivalent to <code class="docutils literal notranslate"><span class="pre">mem.readWriteSync</span></code></p></td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>As for read-under-write policy, to use this feature you need to enable <a class="reference internal" href="#automatic-memory-blackboxing"><span class="std std-ref">automatic memory blackboxing</span></a>, because there is no universal VHDL/Verilog language template to infer mixed-width ram.</p>
</div>
</section>
<section id="automatic-blackboxing">
<span id="automatic-memory-blackboxing"></span><h4>Automatic blackboxing<a class="headerlink" href="#automatic-blackboxing" title="Permalink to this heading"></a></h4>
<p>Because it’s impossible to infer all ram kinds by using regular VHDL/Verilog, SpinalHDL integrates an optional automatic blackboxing system. This system looks at all memories present in your RTL netlist and replaces them with blackboxes. Then the generated code will rely on third party IP to provide the memory features, such as the read-during-write policy and mixed-width ports.</p>
<p>Here is an example of how to enable blackboxing of memories by default:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalConfig</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">addStandardMemBlackboxing</span><span class="p">(</span><span class="n">blackboxAll</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">generateVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If the standard blackboxing tools don’t do enough for your design, do not hesitate to create a <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/issues">Github issue</a>. There is also a way to create your own blackboxing tool.</p>
<section id="blackboxing-policy">
<h5>Blackboxing policy<a class="headerlink" href="#blackboxing-policy" title="Permalink to this heading"></a></h5>
<p>There are multiple policies that you can use to select which memory you want to blackbox and also what to do when the blackboxing is not feasible:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Kinds</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">blackboxAll</span></code></p></td>
<td><div class="line-block">
<div class="line">Blackbox all memory.</div>
<div class="line">Throw an error on unblackboxable memory.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">blackboxAllWhatsYouCan</span></code></p></td>
<td><p>Blackbox every memory that is replaceable.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">blackboxRequestedAndUninferable</span></code></p></td>
<td><div class="line-block">
<div class="line">Blackbox memory specified by the user and memory that is known to be uninferable (mixed-width, …).</div>
<div class="line">Throw an error on unblackboxable memory.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">blackboxOnlyIfRequested</span></code></p></td>
<td><div class="line-block">
<div class="line">Blackbox memory specified by the user.</div>
<div class="line">Throw an error on unblackboxable memory.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">blackboxByteEnables</span></code></p></td>
<td><div class="line-block">
<div class="line">Blackbox every memory which use write port with byte mask.</div>
<div class="line">Useful because synthesis tool don’t support an unified way to infer byte mask in verilog/VHDL.</div>
<div class="line">Throw an error on unblackboxable memory.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">blackboxOnlyIfRequested</span></code></p></td>
<td><div class="line-block">
<div class="line">Blackbox memory specified by the user.</div>
<div class="line">Throw an error on unblackboxable memory.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>To explicitly set a memory to be blackboxed, you can use its <code class="docutils literal notranslate"><span class="pre">generateAsBlackBox</span></code> function.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">Rgb</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="n">mem</span><span class="p">.</span><span class="n">generateAsBlackBox</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>You can also define your own blackboxing policy by extending the <code class="docutils literal notranslate"><span class="pre">MemBlackboxingPolicy</span></code> class.</p>
</section>
<section id="standard-memory-blackboxes">
<h5>Standard memory blackboxes<a class="headerlink" href="#standard-memory-blackboxes" title="Permalink to this heading"></a></h5>
<p>Shown below are the VHDL definitions of the standard blackboxes used in SpinalHDL:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Simple asynchronous dual port (1 write port, 1 read port)</span>
<span class="n">component</span> <span class="n">Ram_1w_1ra</span> <span class="kr">is</span>
  <span class="kd">generic</span><span class="p">(</span>
    <span class="n">wordCount</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wordWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">technology</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">readUnderWrite</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">wrAddressWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wrDataWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wrMaskWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wrMaskEnable</span> <span class="p">:</span> <span class="kt">boolean</span><span class="p">;</span>
    <span class="n">rdAddressWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">rdDataWidth</span> <span class="p">:</span> <span class="kt">integer</span>
  <span class="p">);</span>
  <span class="n">port</span><span class="p">(</span>
    <span class="n">clk</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">wr_en</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">wr_mask</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">wr_addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">wr_data</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">rd_addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">rd_data</span> <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic_vector</span>
  <span class="p">);</span>
<span class="kr">end</span> <span class="nf">component</span><span class="p">;</span>

<span class="c1">-- Simple synchronous dual port (1 write port, 1 read port)</span>
<span class="n">component</span> <span class="n">Ram_1w_1rs</span> <span class="kr">is</span>
  <span class="kd">generic</span><span class="p">(</span>
    <span class="n">wordCount</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wordWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">clockCrossing</span> <span class="p">:</span> <span class="kt">boolean</span><span class="p">;</span>
    <span class="n">technology</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">readUnderWrite</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">wrAddressWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wrDataWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wrMaskWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wrMaskEnable</span> <span class="p">:</span> <span class="kt">boolean</span><span class="p">;</span>
    <span class="n">rdAddressWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">rdDataWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">rdLatency</span> <span class="p">:</span> <span class="kt">integer</span> <span class="c1">-- Cycles between the rd_en and the actual value on rd_data ports. It will be set to 1, unless the you added the MemReadBufferPhase to the SpinalConfig and the ram can merge a register on the read data path.</span>
  <span class="p">);</span>
  <span class="n">port</span><span class="p">(</span>
    <span class="n">wr_clk</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">wr_en</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">wr_mask</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">wr_addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">wr_data</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">rd_clk</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">rd_en</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">rd_addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">rd_dataEn</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span> <span class="c1">-- Only used if rdLatency &gt; 1, drive the enable of rd_data flip flops</span>
    <span class="n">rd_data</span> <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic_vector</span>
  <span class="p">);</span>
<span class="kr">end</span> <span class="nf">component</span><span class="p">;</span>

<span class="c1">-- Single port (1 readWrite port)</span>
<span class="n">component</span> <span class="n">Ram_1wrs</span> <span class="kr">is</span>
  <span class="kd">generic</span><span class="p">(</span>
    <span class="n">wordCount</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wordWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">readUnderWrite</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">technology</span> <span class="p">:</span> <span class="kt">string</span>
  <span class="p">);</span>
  <span class="n">port</span><span class="p">(</span>
    <span class="n">clk</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">en</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">wr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">wrData</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">rdData</span> <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic_vector</span>
  <span class="p">);</span>
<span class="kr">end</span> <span class="nf">component</span><span class="p">;</span>

<span class="c1">--True dual port (2 readWrite port)</span>
<span class="n">component</span> <span class="n">Ram_2wrs</span> <span class="kr">is</span>
  <span class="kd">generic</span><span class="p">(</span>
    <span class="n">wordCount</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">wordWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">clockCrossing</span> <span class="p">:</span> <span class="kt">boolean</span><span class="p">;</span>
    <span class="n">technology</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">portA_readUnderWrite</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">portA_addressWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">portA_dataWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">portA_maskWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">portA_maskEnable</span> <span class="p">:</span> <span class="kt">boolean</span><span class="p">;</span>
    <span class="n">portB_readUnderWrite</span> <span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
    <span class="n">portB_addressWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">portB_dataWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">portB_maskWidth</span> <span class="p">:</span> <span class="kt">integer</span><span class="p">;</span>
    <span class="n">portB_maskEnable</span> <span class="p">:</span> <span class="kt">boolean</span>
  <span class="p">);</span>
  <span class="n">port</span><span class="p">(</span>
    <span class="n">portA_clk</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">portA_en</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">portA_wr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">portA_mask</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">portA_addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">portA_wrData</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">portA_rdData</span> <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">portB_clk</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">portB_en</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">portB_wr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic</span><span class="p">;</span>
    <span class="n">portB_mask</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">portB_addr</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">unsigned</span><span class="p">;</span>
    <span class="n">portB_wrData</span> <span class="p">:</span> <span class="ow">in</span> <span class="n">std_logic_vector</span><span class="p">;</span>
    <span class="n">portB_rdData</span> <span class="p">:</span> <span class="kr">out</span> <span class="n">std_logic_vector</span>
  <span class="p">);</span>
<span class="kr">end</span> <span class="nf">component</span><span class="p">;</span>
</pre></div>
</div>
<p>As you can see, blackboxes have a technology parameter. To set it, you can use the <code class="docutils literal notranslate"><span class="pre">setTechnology</span></code> function on the corresponding memory.
There are currently 4 kinds of technologies possible:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ramBlock</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">distributedLut</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registerFile</span></code></p></li>
</ul>
<p>Blackboxing can insert HDL attributes if <code class="docutils literal notranslate"><span class="pre">SpinalConfig#setDevice(Device)</span></code>
has been configured for your device-vendor.</p>
<p>The resulting HDL attributes might look like:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">ram_style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;distributed&quot;</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">ramsyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;no_rw_check&quot;</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>SpinalHDL tries to support many common memory types provided by well known
vendors and devices, however this is an ever moving landscape and project
requirements can be very specific in this area.</p>
<p>If this is important to your design flow then check the output HDL for the
expected attributes/generic insertion, while consulting your vendor’s
platform documentation.</p>
<p>HDL attributes can also be added manually using the <cite>addAttribute()</cite> <a class="reference internal" href="index.html#vhdl-and-verilog-attributes"><span class="std std-ref">addAttribute</span></a>
mechanism.</p>
</section>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Design errors/index"></span><section id="design-errors">
<h2>Design errors<a class="headerlink" href="#design-errors" title="Permalink to this heading"></a></h2>
<p>The SpinalHDL compiler will perform many checks on your design to be sure that the generated VHDL/Verilog will be safe for simulation and synthesis.
Basically, it should not be possible to generate a broken VHDL/Verilog design.
Below is a non-exhaustive list of SpinalHDL checks:</p>
<ul class="simple">
<li><p>Assignment overlapping</p></li>
<li><p>Clock crossing</p></li>
<li><p>Hierarchy violation</p></li>
<li><p>Combinatorial loops</p></li>
<li><p>Latches</p></li>
<li><p>Undriven signals</p></li>
<li><p>Width mismatch</p></li>
<li><p>Unreachable switch statements</p></li>
</ul>
<p>On each SpinalHDL error report, you will find a stack trace, which can be useful to accurately find out where the design error is.
These design checks may look like overkill at first glance, but they becomes invaluable as soon as you start to move away from the traditional way of doing hardware description.</p>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Design errors/assignment_overlap"></span><section id="assignment-overlap">
<h3>Assignment overlap<a class="headerlink" href="#assignment-overlap" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that no signal assignment completely erases a previous one.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">66</span><span class="w"> </span><span class="c1">// Erase the a := 42 assignment</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw the following error:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ASSIGNMENT OVERLAP completely the previous one of (toplevel/a :  UInt[8 bits])
  ***
  Source file location of the a := 66 assignment via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">66</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But in the case when you really want to override the previous assignment (as there are times when overriding makes sense), you can do the following:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">allowOverride</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">66</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/clock_crossing_violation"></span><section id="clock-crossing-violation">
<h3>Clock crossing violation<a class="headerlink" href="#clock-crossing-violation" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that every register of your design only depends (through combinational logic paths) on registers which use the same or a synchronous clock domain.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkA&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkB&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkA</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w">   </span><span class="c1">// PlayDev.scala:834</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkB</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w">   </span><span class="c1">// PlayDev.scala:835</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regA</span><span class="w">                </span><span class="c1">// PlayDev.scala:838</span>
<span class="w">  </span><span class="n">regB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>CLOCK CROSSING VIOLATION from (toplevel/regA :  UInt[8 bits]) to (toplevel/regB :  UInt[8 bits]).
- Register declaration at
  ***
  Source file location of the toplevel/regA definition via the stack trace
  ***
- through
      &gt;&gt;&gt; (toplevel/regA :  UInt[8 bits]) at ***(PlayDev.scala:834) &gt;&gt;&gt;
      &gt;&gt;&gt; (toplevel/tmp :  UInt[8 bits]) at ***(PlayDev.scala:838) &gt;&gt;&gt;
      &gt;&gt;&gt; (toplevel/regB :  UInt[8 bits]) at ***(PlayDev.scala:835) &gt;&gt;&gt;
</pre></div>
</div>
<p>There are multiple possible fixes, listed below:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#crossclockdomain-tag"><span class="std std-ref">crossClockDomain tags</span></a></p></li>
<li><p><a class="reference internal" href="#setsynchronouswith"><span class="std std-ref">setSynchronousWith method</span></a></p></li>
<li><p><a class="reference internal" href="#buffercc"><span class="std std-ref">BufferCC type</span></a></p></li>
</ul>
</div></blockquote>
<section id="crossclockdomain-tag">
<span id="id1"></span><h5>crossClockDomain tag<a class="headerlink" href="#crossclockdomain-tag" title="Permalink to this heading"></a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">crossClockDomain</span></code> tag can be used to communicate “It’s alright, don’t panic about this specific clock crossing” to the SpinalHDL compiler.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkA&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkB&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkA</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkB</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))).</span><span class="n">addTag</span><span class="p">(</span><span class="n">crossClockDomain</span><span class="p">)</span><span class="w"></span>


<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regA</span><span class="w"></span>
<span class="w">  </span><span class="n">regB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="setsynchronouswith">
<span id="id2"></span><h5>setSynchronousWith<a class="headerlink" href="#setsynchronouswith" title="Permalink to this heading"></a></h5>
<p>You can also specify that two clock domains are synchronous together by using the <code class="docutils literal notranslate"><span class="pre">setSynchronousWith</span></code> method of one of the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> objects.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkA&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkB&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">clkB</span><span class="p">.</span><span class="n">setSynchronousWith</span><span class="p">(</span><span class="n">clkA</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkA</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkB</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>


<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regA</span><span class="w"></span>
<span class="w">  </span><span class="n">regB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="buffercc">
<span id="id3"></span><h5>BufferCC<a class="headerlink" href="#buffercc" title="Permalink to this heading"></a></h5>
<p>When exchanging single-bit signals (such as <code class="docutils literal notranslate"><span class="pre">Bool</span></code> types), or Gray-coded values, you can use <code class="docutils literal notranslate"><span class="pre">BufferCC</span></code> to safely cross different <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> regions.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not use <code class="docutils literal notranslate"><span class="pre">BufferCC</span></code> with multi-bit signals, as there is a risk of corrupted reads on the receiving side if the clocks are asynchronous.
See the <a class="reference internal" href="index.html#clock-domain"><span class="std std-ref">Clock Domains</span></a> page for more details.</p>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AsyncFifo</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">popToPushGray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">ptrWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">pushToPopGray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">ptrWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">pushCC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">pushClock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">pushPtr</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Counter</span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">pushPtrGray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">toGray</span><span class="p">(</span><span class="n">pushPtr</span><span class="p">.</span><span class="n">valueNext</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">popPtrGray</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">popToPushGray</span><span class="p">,</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ptrWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">full</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">isFull</span><span class="p">(</span><span class="n">pushPtrGray</span><span class="p">,</span><span class="w"> </span><span class="n">popPtrGray</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">...</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">popCC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">popClock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">popPtr</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">Counter</span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">popPtrGray</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">toGray</span><span class="p">(</span><span class="n">popPtr</span><span class="p">.</span><span class="n">valueNext</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">pushPtrGray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">pushToPopGray</span><span class="p">,</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ptrWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">empty</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">isEmpty</span><span class="p">(</span><span class="n">popPtrGray</span><span class="p">,</span><span class="w"> </span><span class="n">pushPtrGray</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">...</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Design errors/combinatorial_loop"></span><section id="combinatorial-loop">
<h3>Combinatorial loop<a class="headerlink" href="#combinatorial-loop" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that there are no combinatorial loops in the design.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// PlayDev.scala line 831</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// PlayDev.scala line 832</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>COMBINATORIAL LOOP :
  Partial chain :
    &gt;&gt;&gt; (toplevel/a :  UInt[8 bits]) at ***(PlayDev.scala:831) &gt;&gt;&gt;
    &gt;&gt;&gt; (toplevel/d :  UInt[8 bits]) at ***(PlayDev.scala:834) &gt;&gt;&gt;
    &gt;&gt;&gt; (toplevel/b :  UInt[8 bits]) at ***(PlayDev.scala:832) &gt;&gt;&gt;
    &gt;&gt;&gt; (toplevel/a :  UInt[8 bits]) at ***(PlayDev.scala:831) &gt;&gt;&gt;

  Full chain :
    (toplevel/a :  UInt[8 bits])
    (toplevel/d :  UInt[8 bits])
    (UInt | UInt)[8 bits]
    (toplevel/b :  UInt[8 bits])
    (toplevel/a :  UInt[8 bits])
</pre></div>
</div>
<p>A possible fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// PlayDev.scala line 831</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// PlayDev.scala line 832</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="false-positives">
<h4>False-positives<a class="headerlink" href="#false-positives" title="Permalink to this heading"></a></h4>
<p>It should be said that SpinalHDL’s algorithm to detect combinatorial loops can be pessimistic, and it may give false positives.
If it is giving a false positive, you can manually disable loop checking on one signal of the loop like so:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// False positive because of this line</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>could be fixed by :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">).</span><span class="n">noCombLoopCheck</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It should also be said that assignments such as <code class="docutils literal notranslate"><span class="pre">(a(1)</span> <span class="pre">:=</span> <span class="pre">a(0))</span></code> can make some tools like <a class="reference external" href="https://www.veripool.org/wiki/verilator">Verilator</a> unhappy.
It may be better to use a <code class="docutils literal notranslate"><span class="pre">Vec(Bool(),</span> <span class="pre">8)</span></code> in this case.</p>
</section>
</section>
<span id="document-SpinalHDL/Design errors/hierarchy_violation"></span><section id="hierarchy-violation">
<h3>Hierarchy violation<a class="headerlink" href="#hierarchy-violation" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that signals are never accessed outside of the current component’s scope.</p>
<p>The following signals can be read inside a component:</p>
<ul class="simple">
<li><p>All directionless signals defined in the current component</p></li>
<li><p>All in/out/inout signals of the current component</p></li>
<li><p>All in/out/inout signals of child components</p></li>
</ul>
<p>In addition, the following signals can be assigned to inside of a component:</p>
<ul class="simple">
<li><p>All directionless signals defined in the current component</p></li>
<li><p>All out/inout signals of the current component</p></li>
<li><p>All in/inout signals of child components</p></li>
</ul>
<p>If a <code class="docutils literal notranslate"><span class="pre">HIERARCHY</span> <span class="pre">VIOLATION</span></code> error appears, it means that one of the above rules was violated.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This is an &#39;in&#39; signal of the current component &#39;Toplevel&#39;</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;x42&quot;</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w">  </span><span class="c1">// ERROR: attempting to assign to an input of current component</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>HIERARCHY VIOLATION : (toplevel/io_a : in UInt[8 bits]) is driven by (toplevel/tmp :  UInt[8 bits]), but isn&#39;t accessible in the toplevel component.
  ***
  Source file location of the `io.a := tmp` via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// changed from in to out</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;x42&quot;</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w">  </span><span class="c1">// now we are assigning to an output</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/iobundle"></span><section id="io-bundle">
<h3>IO bundle<a class="headerlink" href="#io-bundle" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that each <code class="docutils literal notranslate"><span class="pre">io</span></code> bundle contains only in/out/inout signals.
Other kinds of signals are called directionless signals.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>IO BUNDLE ERROR : A direction less (toplevel/io_a :  UInt[8 bits]) signal was defined into toplevel component&#39;s io bundle
  ***
  Source file location of the toplevel/io_a definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">  </span><span class="c1">// provide &#39;in&#39; direction declaration</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But if for meta hardware description reasons you really want <code class="docutils literal notranslate"><span class="pre">io.a</span></code> to be directionless, you can do:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">allowDirectionLessIo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/latch_detected"></span><section id="latch-detected">
<h3>Latch detected<a class="headerlink" href="#latch-detected" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that no combinational signals will infer a latch during synthesis.
In other words, this is a check that no combinational signals are partially assigned.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>LATCH DETECTED from the combinatorial signal (toplevel/a :  UInt[8 bits]), defined at
  ***
  Source file location of the toplevel/io_a definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="due-to-mux">
<h4>Due to mux<a class="headerlink" href="#due-to-mux" title="Permalink to this heading"></a></h4>
<p>Another reason for a latch being detected is often a non-exhaustive <code class="docutils literal notranslate"><span class="pre">mux</span></code>/<code class="docutils literal notranslate"><span class="pre">muxList</span></code> statement
with a missing default:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="n">u1</span><span class="p">.</span><span class="n">mux</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">// case for 1 is missing</span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>which can be fixed by adding the missing case (or a default case):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="n">u1</span><span class="p">.</span><span class="n">mux</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>In e.g. width generic code it is often a better solution to use <code class="docutils literal notranslate"><span class="pre">muxListDc</span></code> as this will not
generate an error for those cases were a default is not needed:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="c1">// automatically adds default if needed</span>
<span class="n">u1</span><span class="p">.</span><span class="n">muxListDc</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/no_driver_on"></span><section id="no-driver-on">
<h3>No driver on<a class="headerlink" href="#no-driver-on" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that all combinational signals which have an impact on the design are assigned by something.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>NO DRIVER ON (toplevel/a :  UInt[8 bits]), defined at
  ***
  Source file location of the toplevel/a definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/nullpointerexception"></span><section id="nullpointerexception">
<h3>NullPointerException<a class="headerlink" href="#nullpointerexception" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">NullPointerException</span></code> is a Scala runtime reported error which can happen when a variable is accessed before it has been initialized.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Exception in thread &quot;main&quot; java.lang.NullPointerException
  ***
  Source file location of the a := 42 assignment via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<section id="issue-explanation">
<h5>Issue explanation<a class="headerlink" href="#issue-explanation" title="Permalink to this heading"></a></h5>
<p>SpinalHDL is not a language, it is a Scala library, which means that it obeys the same rules as the Scala general purpose programming language.</p>
<p>When running the above SpinalHDL hardware description to generate the corresponding VHDL/Verilog RTL, the SpinalHDL hardware description will be executed as a Scala program, and <code class="docutils literal notranslate"><span class="pre">a</span></code> will be a null reference until the program executes <code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">a</span> <span class="pre">=</span> <span class="pre">UInt(8</span> <span class="pre">bits)</span></code>, so trying to assign to it before then will result in a <code class="docutils literal notranslate"><span class="pre">NullPointerException</span></code>.</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Design errors/out_of_range_constant"></span><section id="out-of-range-constant">
<h3>Out of Range Constant<a class="headerlink" href="#out-of-range-constant" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL checks that in comparisons with literals the literal is not wider than the value compared to.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>For example the following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Will result in the following error:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>OUT OF RANGE CONSTANT. Operator UInt &lt; UInt
- Left  operand : (toplevel/value : in UInt[2 bits])
- Right operand : (U&quot;101010&quot; 6 bits)
 is checking a value against a out of range constant
</pre></div>
</div>
</section>
<section id="specifying-exceptions">
<h4>Specifying exceptions<a class="headerlink" href="#specifying-exceptions" title="Permalink to this heading"></a></h4>
<p>In some cases, because of the design parametrization, it can make sense to compare a value to a larger constant and get a statically known <code class="docutils literal notranslate"><span class="pre">True/False</span></code> result.</p>
<p>You have the option to specifically whitelist one instance of a comparison with an out of range constant.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">((</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">42</span><span class="p">).</span><span class="n">allowOutOfRangeLiterals</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Alternatively, you can allow comparisons to out of range constants for the whole design.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalConfig</span><span class="p">(</span><span class="n">allowOutOfRangeLiterals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/register_defined_as_component_input"></span><section id="register-defined-as-component-input">
<h3>Register defined as component input<a class="headerlink" href="#register-defined-as-component-input" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>In SpinalHDL, you are not allowed to define a component that has a register as an input.
The reasoning behind this is to prevent surprises when the user tries to drive the inputs of child components with the registered signal.
If a registered input is desired, you will need to declare the unregistered input in the <code class="docutils literal notranslate"><span class="pre">io</span></code> bundle, and register the signal in the body of the component.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>REGISTER DEFINED AS COMPONENT INPUT : (toplevel/io_a : in UInt[8 bits]) is defined as a registered input of the toplevel component, but isn&#39;t allowed.
  ***
  Source file location of the toplevel/io_a definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If a registered <code class="docutils literal notranslate"><span class="pre">a</span></code> is required, it can be done like so:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/scope_violation"></span><section id="scope-violation">
<h3>Scope violation<a class="headerlink" href="#scope-violation" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that there are no signals assigned outside the scope they are defined in.
This error isn’t easy to trigger as it requires some specific meta hardware description tricks.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">tmp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;x42&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>SCOPE VIOLATION : (toplevel/tmp :  UInt[8 bits]) is assigned outside its declaration scope at
  ***
  Source file location of the tmp := U&quot;x42&quot; via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">tmp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;x42&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/spinal_cant_clone"></span><section id="spinal-can-t-clone-class">
<h3>Spinal can’t clone class<a class="headerlink" href="#spinal-can-t-clone-class" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>This error happens when SpinalHDL wants to create a new datatype instance via the <code class="docutils literal notranslate"><span class="pre">cloneOf</span></code> function but isn’t able to do it.
The reason for this is nearly always because it can’t retrieve the construction parameters of a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>.</p>
</section>
<section id="example-1">
<h4>Example 1<a class="headerlink" href="#example-1" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// cloneOf(this) isn&#39;t able to retrieve the width value that was used to construct itself</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="c1">// Stream requires the capability to cloneOf(new RGB(8))</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>*** Spinal can&#39;t clone class spinal.tester.PlayDevMessages$RGB datatype
*** You have two way to solve that :
*** In place to declare a &quot;class Bundle(args){}&quot;, create a &quot;case class Bundle(args){}&quot;
*** Or override by your self the bundle clone function
  ***
  Source file location of the RGB class definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="example-2">
<h4>Example 2<a class="headerlink" href="#example-2" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Xlen</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">xlen</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MemoryAddress</span><span class="p">()(</span><span class="k">implicit</span><span class="w"> </span><span class="n">xlenConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">Xlen</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">xlenConfig</span><span class="p">.</span><span class="n">xlen</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">DebugMemory</span><span class="p">(</span><span class="k">implicit</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">Xlen</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">inputAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">MemoryAddress</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">someAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">inputAddress</span><span class="p">)</span><span class="w"> </span><span class="c1">// -&gt; ERROR *****************************</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>raises an exeption:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[error] *** Spinal can&#39;t clone class debug.MemoryAddress datatype
</pre></div>
</div>
<p>In this case, a solution is to override the clone function to propagate the implicit parameter.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MemoryAddress</span><span class="p">()(</span><span class="k">implicit</span><span class="w"> </span><span class="n">xlenConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">Xlen</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">xlenConfig</span><span class="p">.</span><span class="n">xlen</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MemoryAddress</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to clone the hardware element, not the eventually assigned value in it.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An alternative is to used <a class="reference internal" href="index.html#scopeproperty"><span class="std std-ref">ScopeProperty</span></a>.</p>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/unassigned_register"></span><section id="unassigned-register">
<h3>Unassigned register<a class="headerlink" href="#unassigned-register" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that all registers which impact the design have been assigned somewhere.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>UNASSIGNED REGISTER (toplevel/a :  UInt[8 bits]), defined at
  ***
  Source file location of the toplevel/a definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="register-with-only-init">
<h4>Register with only init<a class="headerlink" href="#register-with-only-init" title="Permalink to this heading"></a></h4>
<p>In some cases, because of the design parameterization, it could make sense to generate a register which has no assignment but only an <code class="docutils literal notranslate"><span class="pre">init</span></code> statement.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">somethingElse</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>UNASSIGNED REGISTER (toplevel/a :  UInt[8 bits]), defined at
  ***
  Source file location of the toplevel/a definition via the stack trace
  ***
</pre></div>
</div>
<p>To fix it, you can ask SpinalHDL to transform the register into a combinational one if no assignment is present but it has an <code class="docutils literal notranslate"><span class="pre">init</span></code> statement:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)).</span><span class="n">init</span><span class="p">(</span><span class="mi">42</span><span class="p">).</span><span class="n">allowUnsetRegToAvoidLatch</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">somethingElse</span><span class="w"></span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/unreachable_is_statement"></span><section id="unreachable-is-statement">
<h3>Unreachable is statement<a class="headerlink" href="#unreachable-is-statement" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check to ensure that all <code class="docutils literal notranslate"><span class="pre">is</span></code> statements in a <code class="docutils literal notranslate"><span class="pre">switch</span></code> are reachable.</p>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">switch</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">0</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">2</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">3</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">0</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// Duplicated is statement!</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>UNREACHABLE IS STATEMENT in the switch statement at
  ***
  Source file location of the is statement definition via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">switch</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">0</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">2</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="mi">3</span><span class="p">){</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Design errors/width_mismatch"></span><section id="width-mismatch">
<h3>Width mismatch<a class="headerlink" href="#width-mismatch" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>SpinalHDL will check that operators and signals on the left and right side of assignments have the same widths.</p>
</section>
<section id="assignment-example">
<h4>Assignment example<a class="headerlink" href="#assignment-example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>WIDTH MISMATCH on (toplevel/b :  UInt[4 bits]) := (toplevel/a :  UInt[8 bits]) at
  ***
  Source file location of the OR operator via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">resized</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="operator-example">
<h4>Operator example<a class="headerlink" href="#operator-example" title="Permalink to this heading"></a></h4>
<p>The following code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>will throw:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>WIDTH MISMATCH on (UInt | UInt)[8 bits]
- Left  operand : (toplevel/a :  UInt[8 bits])
- Right operand : (toplevel/b :  UInt[4 bits])
  at
  ***
  Source file location of the OR operator via the stack trace
  ***
</pre></div>
</div>
<p>A fix could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">resized</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Other language features/index"></span><section id="other-language-features">
<h2>Other language features<a class="headerlink" href="#other-language-features" title="Permalink to this heading"></a></h2>
<p>The core of the language defines the syntax for many features:</p>
<ul class="simple">
<li><p>Types / Literals</p></li>
<li><p>Register / Clock domains</p></li>
<li><p>Component / Area</p></li>
<li><p>RAM / ROM</p></li>
<li><p>When / Switch / Mux</p></li>
<li><p>BlackBox (to integrate VHDL or Verilog IPs inside Spinal)</p></li>
<li><p>SpinalHDL to VHDL converter</p></li>
</ul>
<p>Then, by using these features, you can define digital hardware, and also build powerful libraries and abstractions.
It’s one of the major advantages of SpinalHDL over other commonly used HDLs, because you can extend the language without having knowledge about the compiler.</p>
<p>One good example of this is the <a class="reference internal" href="index.html#lib-introduction"><span class="std std-ref">SpinalHDL lib</span></a> which adds many utilities, tools, buses, and methodologies.</p>
<p>To use features introduced in the following chapter you need to <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">spinal.core._</span></code> in your sources.</p>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Other language features/utils"></span><section id="utils">
<span id="id1"></span><h3>Utils<a class="headerlink" href="#utils" title="Permalink to this heading"></a></h3>
<section id="general">
<h4>General<a class="headerlink" href="#general" title="Permalink to this heading"></a></h4>
<p>Many tools and utilities are present in <a class="reference internal" href="index.html#lib-introduction"><span class="std std-ref">spinal.lib</span></a> but some are already present in the SpinalHDL Core.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 13%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">widthOf(x</span> <span class="pre">:</span> <span class="pre">BitVector)</span></code></p></td>
<td><p>Int</p></td>
<td><p>Return the width of a Bits/UInt/SInt signal</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">log2Up(x</span> <span class="pre">:</span> <span class="pre">BigInt)</span></code></p></td>
<td><p>Int</p></td>
<td><p>Return the number of bits needed to represent <code class="docutils literal notranslate"><span class="pre">x</span></code> states</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">isPow2(x</span> <span class="pre">:</span> <span class="pre">BigInt)</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>Return true if <code class="docutils literal notranslate"><span class="pre">x</span></code> is a power of two</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">roundUp(that</span> <span class="pre">:</span> <span class="pre">BigInt,</span> <span class="pre">by</span> <span class="pre">:</span> <span class="pre">BigInt)</span></code></p></td>
<td><p>BigInt</p></td>
<td><p>Return the first <code class="docutils literal notranslate"><span class="pre">by</span></code> multiply from <code class="docutils literal notranslate"><span class="pre">that</span></code> (included)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Cat(x:</span> <span class="pre">Data*)</span></code></p></td>
<td><p>Bits</p></td>
<td><p>Concatenate all arguments, from MSB to LSB, see <a class="reference internal" href="#cat">Cat</a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Cat(x:</span> <span class="pre">Iterable[Data])</span></code></p></td>
<td><p>Bits</p></td>
<td><p>Conactenate arguments, from LSB to MSB, see <a class="reference internal" href="#cat">Cat</a></p></td>
</tr>
</tbody>
</table>
<section id="cat">
<span id="id2"></span><h5>Cat<a class="headerlink" href="#cat" title="Permalink to this heading"></a></h5>
<p>As listed above, there are two version of <code class="docutils literal notranslate"><span class="pre">Cat</span></code>. Both versions concatenate the signals they contain, with a subtle difference:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Cat(x:</span> <span class="pre">Data*)</span></code> takes an arbitrary number of hardware signals as parameters.
It mimics other HDLs and the leftmost parameter becomes the MSB of the resulting <code class="docutils literal notranslate"><span class="pre">Bits</span></code>, the rightmost the LSB side. Said differently:
the input is concatenated in the order as written.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cat(x:</span> <span class="pre">Iterable[Data])</span></code> which takes a single Scala iterable collection (Seq / Set / List / …) containing hardware signals.
This version places the first element of the list into the LSB, and the last into the MSB.</p></li>
</ul>
<p>This seeming difference comes mostly from the convention that <code class="docutils literal notranslate"><span class="pre">Bits</span></code> are written from the hightest index to the lowest index, while
Lists are written down starting from index 0 to the highest index. <code class="docutils literal notranslate"><span class="pre">Cat</span></code> places index 0 of both conventions at the LSB.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">bit0</span><span class="p">,</span><span class="w"> </span><span class="n">bit1</span><span class="p">,</span><span class="w"> </span><span class="n">bit2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="n">bit2</span><span class="p">,</span><span class="w"> </span><span class="n">bit1</span><span class="p">,</span><span class="w"> </span><span class="n">bit0</span><span class="p">)</span><span class="w"></span>

<span class="c1">// is equivalent to</span>

<span class="kd">val</span><span class="w"> </span><span class="n">signals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">bit0</span><span class="p">,</span><span class="w"> </span><span class="n">bit1</span><span class="p">,</span><span class="w"> </span><span class="n">bit2</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="cloning-hardware-datatypes">
<h4>Cloning hardware datatypes<a class="headerlink" href="#cloning-hardware-datatypes" title="Permalink to this heading"></a></h4>
<p>You can clone a given hardware data type by using the <code class="docutils literal notranslate"><span class="pre">cloneOf(x)</span></code> function.
It will return a new instance of the same Scala type and parameters.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plusOne</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Will provide new instance of a UInt with the same width as ``value``</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloneOf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// treePlusOne will become a 8 bits value</span>
<span class="kd">val</span><span class="w"> </span><span class="n">treePlusOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plusOne</span><span class="p">(</span><span class="nc">U</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>You can get more information about how hardware data types are managed on the <a class="reference internal" href="index.html#hardware-type"><span class="std std-ref">Hardware types page</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use the <code class="docutils literal notranslate"><span class="pre">cloneOf</span></code> function on a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>, this <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> should be a <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code> or should override the clone function internally.</p>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// An example of a regular &#39;class&#39; with &#39;override def clone()&#39; function</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyBundle</span><span class="p">(</span><span class="n">ppp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">ppp</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MyBundle</span><span class="p">(</span><span class="n">ppp</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MyBundle</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">typeDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">HardType</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyBundle</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"></span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typeDef</span><span class="p">()</span><span class="w"></span>

<span class="w"> </span><span class="n">cloneOf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="c1">// Need clone method, else it errors</span>
<span class="w"> </span><span class="n">cloneOf</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="c1">// Is ok</span>
</pre></div>
</div>
</section>
<section id="passing-a-datatype-as-construction-parameter">
<h4>Passing a datatype as construction parameter<a class="headerlink" href="#passing-a-datatype-as-construction-parameter" title="Permalink to this heading"></a></h4>
<p>Many pieces of reusable hardware need to be parameterized by some data type.
For example if you want to define a FIFO or a shift register, you need a parameter to specify which kind of payload you want for the component.</p>
<p>There are two similar ways to do this.</p>
<section id="the-old-way">
<h5>The old way<a class="headerlink" href="#the-old-way" title="Permalink to this heading"></a></h5>
<p>A good example of the old way to do this is in this definition of a <code class="docutils literal notranslate"><span class="pre">ShiftRegister</span></code> component:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ShiftRegister</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="n">cloneOf</span><span class="p">(</span><span class="n">dataType</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">cloneOf</span><span class="p">(</span><span class="n">dataType</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>And here is how you can instantiate the component:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">shiftReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ShiftRegister</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>As you can see, the raw hardware type is directly passed as a construction parameter.
Then each time you want to create an new instance of that kind of hardware data type, you need to use the <code class="docutils literal notranslate"><span class="pre">cloneOf(...)</span></code> function.
Doing things this way is not super safe as it’s easy to forget to use <code class="docutils literal notranslate"><span class="pre">cloneOf</span></code>.</p>
</section>
<section id="the-safe-way">
<h5>The safe way<a class="headerlink" href="#the-safe-way" title="Permalink to this heading"></a></h5>
<p>An example of the safe way to pass a data type parameter is as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ShiftRegister</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">HardType</span><span class="p">[</span><span class="nc">T</span><span class="p">],</span><span class="w"> </span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">dataType</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>And here is how you instantiate the component (exactly the same as before):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">shiftReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ShiftRegister</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Notice how the example above uses a <code class="docutils literal notranslate"><span class="pre">HardType</span></code> wrapper around the raw data type <code class="docutils literal notranslate"><span class="pre">T</span></code>, which is a “blueprint” definition of a hardware data type.
This way of doing things is easier to use than the “old way”, because to create a new instance of the hardware data type you only need to call the <code class="docutils literal notranslate"><span class="pre">apply</span></code> function of that <code class="docutils literal notranslate"><span class="pre">HardType</span></code> (or in other words, just add parentheses after the parameter).</p>
<p>Additionally, this mechanism is completely transparent from the point of view of the user, as a hardware data type can be implicitly converted into a <code class="docutils literal notranslate"><span class="pre">HardType</span></code>.</p>
</section>
</section>
<section id="frequency-and-time">
<h4>Frequency and time<a class="headerlink" href="#frequency-and-time" title="Permalink to this heading"></a></h4>
<p>SpinalHDL has a dedicated syntax to define frequency and time values:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="w">      </span><span class="c1">// infers type TimeNumber</span>
<span class="kd">val</span><span class="w"> </span><span class="n">timeoutLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">ms</span><span class="w">      </span><span class="c1">// infers type HertzNumber</span>
<span class="kd">val</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">us</span><span class="w">          </span><span class="c1">// infers type TimeNumber</span>

<span class="kd">val</span><span class="w"> </span><span class="n">periodCycles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">period</span><span class="w">             </span><span class="c1">// infers type BigDecimal</span>
<span class="kd">val</span><span class="w"> </span><span class="n">timeoutCycles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">timeoutLimit</span><span class="w">      </span><span class="c1">// infers type BigDecimal</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">For time definitions you can use following postfixes to get a <code class="docutils literal notranslate"><span class="pre">TimeNumber</span></code>:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fs</span></code>, <code class="docutils literal notranslate"><span class="pre">ps</span></code>, <code class="docutils literal notranslate"><span class="pre">ns</span></code>, <code class="docutils literal notranslate"><span class="pre">us</span></code>, <code class="docutils literal notranslate"><span class="pre">ms</span></code>, <code class="docutils literal notranslate"><span class="pre">sec</span></code>, <code class="docutils literal notranslate"><span class="pre">mn</span></code>, <code class="docutils literal notranslate"><span class="pre">hr</span></code></div>
</div>
<div class="line-block">
<div class="line">For time definitions you can use following postfixes to get a <code class="docutils literal notranslate"><span class="pre">HertzNumber</span></code>:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Hz</span></code>, <code class="docutils literal notranslate"><span class="pre">KHz</span></code>, <code class="docutils literal notranslate"><span class="pre">MHz</span></code>, <code class="docutils literal notranslate"><span class="pre">GHz</span></code>, <code class="docutils literal notranslate"><span class="pre">THz</span></code></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TimeNumber</span></code> and <code class="docutils literal notranslate"><span class="pre">HertzNumber</span></code> are based on the <code class="docutils literal notranslate"><span class="pre">PhysicalNumber</span></code> class which use  scala <code class="docutils literal notranslate"><span class="pre">BigDecimal</span></code> to store numbers.</p>
</section>
<section id="binary-prefix">
<h4>Binary prefix<a class="headerlink" href="#binary-prefix" title="Permalink to this heading"></a></h4>
<p>SpinalHDL allows the definition of integer numbers using binary prefix notation according to IEC.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">memSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nc">MiB</span><span class="w">      </span><span class="c1">// infers type BigInt</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dpRamSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="w">      </span><span class="c1">// infers type BigInt</span>
</pre></div>
</div>
<p>The following binary prefix notations are available:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Binary Prefix</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Byte, Bytes</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>KiB</p></td>
<td><p>1024 == 1 &lt;&lt; 10</p></td>
</tr>
<tr class="row-even"><td><p>MiB</p></td>
<td><p>1024<sup>2</sup> == 1 &lt;&lt; 20</p></td>
</tr>
<tr class="row-odd"><td><p>GiB</p></td>
<td><p>1024<sup>3</sup> == 1 &lt;&lt; 30</p></td>
</tr>
<tr class="row-even"><td><p>TiB</p></td>
<td><p>1024<sup>4</sup> == 1 &lt;&lt; 40</p></td>
</tr>
<tr class="row-odd"><td><p>PiB</p></td>
<td><p>1024<sup>5</sup> == 1 &lt;&lt; 50</p></td>
</tr>
<tr class="row-even"><td><p>EiB</p></td>
<td><p>1024<sup>6</sup> == 1 &lt;&lt; 60</p></td>
</tr>
<tr class="row-odd"><td><p>ZiB</p></td>
<td><p>1024<sup>7</sup> == 1 &lt;&lt; 70</p></td>
</tr>
<tr class="row-even"><td><p>YiB</p></td>
<td><p>1024<sup>8</sup> == 1 &lt;&lt; 80</p></td>
</tr>
</tbody>
</table>
<p>Of course, BigInt can also be printed as a string in bytes unit. <code class="docutils literal notranslate"><span class="pre">BigInt(1024).byteUnit</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">memSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nc">MiB</span><span class="w"></span>

<span class="n">println</span><span class="p">(</span><span class="n">memSize</span><span class="p">)</span><span class="w"></span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">536870912</span><span class="w"></span>

<span class="n">println</span><span class="p">(</span><span class="n">memSize</span><span class="p">.</span><span class="n">byteUnit</span><span class="p">)</span><span class="w"></span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">512</span><span class="nc">MiB</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">dpRamSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;123456789&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>

<span class="n">println</span><span class="p">(</span><span class="n">dpRamSize</span><span class="p">.</span><span class="n">byteUnit</span><span class="p">())</span><span class="w"></span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="nc">GiB</span><span class="o">+</span><span class="mi">564</span><span class="nc">MiB</span><span class="o">+</span><span class="mi">345</span><span class="nc">KiB</span><span class="o">+</span><span class="mi">905</span><span class="nc">Byte</span><span class="w"></span>

<span class="n">println</span><span class="p">((</span><span class="mi">32</span><span class="p">.</span><span class="nc">MiB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="p">.</span><span class="nc">KiB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">223</span><span class="p">).</span><span class="n">byteUnit</span><span class="p">())</span><span class="w"></span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="nc">MiB</span><span class="o">+</span><span class="mi">12</span><span class="nc">KiB</span><span class="o">+</span><span class="mi">223</span><span class="nc">Byte</span><span class="w"></span>

<span class="n">println</span><span class="p">((</span><span class="mi">32</span><span class="p">.</span><span class="nc">MiB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="p">.</span><span class="nc">KiB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">223</span><span class="p">).</span><span class="n">byteUnit</span><span class="p">(</span><span class="n">ceil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"></span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">33</span><span class="o">~</span><span class="nc">MiB</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Other language features/stub"></span><section id="stub">
<h3>Stub<a class="headerlink" href="#stub" title="Permalink to this heading"></a></h3>
<p>You can empty an Component Hierarchy as stub:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SubSysModule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">io</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">&lt;-&lt;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">dx</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SubSysModule</span><span class="p">().</span><span class="n">stub</span><span class="w">   </span><span class="c1">// instance an SubSysModule as empty stub</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It will generate the following Verilog code for example:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">SubSysModule</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_dx_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">io_dx_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_dx_payload</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">io_dy_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_dy_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_dy_payload</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>


<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_dx_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_dy_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_dy_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>You can also empty the top Component</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Pinsec</span><span class="p">(</span><span class="mi">500</span><span class="w"> </span><span class="nc">MHz</span><span class="p">).</span><span class="n">stub</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>What does <cite>stub</cite> do ?</p>
<ul class="simple">
<li><p>first walk all the components and find out clock, then keep clock</p></li>
<li><p>then remove all children component</p></li>
<li><p>then remove all assignment and logic we don’t want</p></li>
<li><p>tile 0 to output port</p></li>
</ul>
</section>
<span id="document-SpinalHDL/Other language features/assertion"></span><section id="assertions">
<h3>Assertions<a class="headerlink" href="#assertions" title="Permalink to this heading"></a></h3>
<p>In addition to Scala run-time assertions <cite>assert(condition : Boolean, message : String)</cite>, you can add hardware assertions using the following syntax:</p>
<p><code class="docutils literal notranslate"><span class="pre">assert(assertion</span> <span class="pre">:</span> <span class="pre">Bool,</span> <span class="pre">message</span> <span class="pre">:</span> <span class="pre">String</span> <span class="pre">=</span> <span class="pre">null,</span> <span class="pre">severity:</span> <span class="pre">AssertNodeSeverity</span> <span class="pre">=</span> <span class="pre">Error)</span></code></p>
<p>Severity levels are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NOTE</p></td>
<td><p>Used to report an informative message</p></td>
</tr>
<tr class="row-odd"><td><p>WARNING</p></td>
<td><p>Used to report an unusual case</p></td>
</tr>
<tr class="row-even"><td><p>ERROR</p></td>
<td><p>Used to report an situation that should not happen</p></td>
</tr>
<tr class="row-odd"><td><p>FAILURE</p></td>
<td><p>Used to report a fatal situation and close the simulation</p></td>
</tr>
</tbody>
</table>
<p>One practical example could be to check that the <code class="docutils literal notranslate"><span class="pre">valid</span></code> signal of a handshake protocol never drops when <code class="docutils literal notranslate"><span class="pre">ready</span></code> is low:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// some logic</span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">assertion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">valid</span><span class="p">.</span><span class="n">fall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ready</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">message</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Valid dropped when ready was low&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">severity</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">ERROR</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Scala run time assertions <cite>assert(condition : Boolean, message : String)</cite> do not provide support for a severity level, and if triggered, will always stop the current elaboration/simulation.</p>
</div>
</section>
<span id="document-SpinalHDL/Other language features/report"></span><section id="report">
<h3>Report<a class="headerlink" href="#report" title="Permalink to this heading"></a></h3>
<p>You can add debugging in RTL for simulation, using the following syntax:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">Enum</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">MIAOU</span><span class="p">,</span><span class="w"> </span><span class="nc">RAWRR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="p">.</span><span class="nc">RAWRR</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mh">0x42</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Enum</span><span class="p">.</span><span class="nc">RAWRR</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nc">U</span><span class="p">(</span><span class="mh">0x42</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">report</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="s">&quot;miaou &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It will generate the following Verilog code for example:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="nb">$display</span><span class="p">(</span><span class="s">&quot;NOTE miaou %s%x%s%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a_string</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c_string</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Since SpinalHDL 1.4.4, the following syntax is also supported:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="p">(</span><span class="nc">L</span><span class="s">&quot;miaou $a $b $c $d&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>You can display the current simulation time using the <cite>REPORT_TIME</cite> object:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="p">(</span><span class="nc">L</span><span class="s">&quot;miaou $REPORT_TIME&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>will result in:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="nb">$display</span><span class="p">(</span><span class="s">&quot;NOTE miaou %t&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">$time</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Automatic Handling of Scala Primitive Types (SpinalHDL ^1.12.2)</strong></p>
<p>You can embed Scala primitive types (e.g., <cite>Int</cite>, <cite>Boolean</cite>, <cite>Float</cite>, <cite>BigInt</cite>, <cite>BigDecimal</cite>, <cite>Char</cite>, <cite>Byte</cite>, <cite>Short</cite>, <cite>Long</cite>) within <cite>L””</cite> interpolated strings without explicit <cite>.toString()</cite> calls.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myFloat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14f</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBigInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="mh">0xABCD</span><span class="p">)</span><span class="w"></span>
<span class="n">report</span><span class="p">(</span><span class="nc">L</span><span class="s">&quot;My values: int=$myInt, bool=$myBool, float=$myFloat, bigInt=$myBigInt&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">cacheConfig</span><span class="p">.</span><span class="n">fetchWordsPerFetchGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">report</span><span class="p">(</span><span class="nc">L</span><span class="s">&quot;AdvICache: sCompareTags - Instruction ${i}: ${io.cpu.rsp.payload.instructions(i)}&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Structured Reporting for Complex Data Types (like Bundles) (SpinalHDL ^1.12.2)</strong></p>
<p>For <cite>Bundle`s or other complex data structures, you can define a `Formattable</cite> trait and implement a <cite>format()</cite> method returning <cite>Seq[Any]</cite> to define a structured, nested representation. This allows for clean, one-line reporting of entire complex objects.</p>
<p>First, define a <cite>Formattable</cite> trait and implement it in your Bundles:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">Formattable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">():</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Any</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">DataPayload</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Formattable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">():</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Any</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">L</span><span class="s">&quot;DataPayload(value=0x${value}, checksum=0x${checksum})&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PacketHeader</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Formattable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">packetLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataPayload</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">():</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Any</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nc">L</span><span class="s">&quot;PacketHeader(&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nc">L</span><span class="s">&quot;packetLength=0x${packetLength},&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nc">L</span><span class="s">&quot; packetType=0x${packetType},&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nc">L</span><span class="s">&quot; payload=${payload.format},&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Nested format call</span>
<span class="w">    </span><span class="nc">L</span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">).</span><span class="n">flatten</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then, you can report the entire structure:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">PacketHeader</span><span class="p">()</span><span class="w"> </span><span class="c1">// Assume io is an instance of PacketHeader</span>
<span class="w">  </span><span class="c1">// ... some logic ...</span>
<span class="w">  </span><span class="n">report</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">format</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This will produce a compact, readable output like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<p>PacketHeader(packetLength=0x0c, packetType=0x1, payload=DataPayload(value=0x5678, checksum=0x78))</p>
</section>
<span id="document-SpinalHDL/Other language features/scope_property"></span><section id="scopeproperty">
<span id="id1"></span><h3>ScopeProperty<a class="headerlink" href="#scopeproperty" title="Permalink to this heading"></a></h3>
<p>A scope property is a thing which can store values locally to the current thread. Its API can be used to set/get that value, but also to apply modification to the value for a portion of the execution in a stack manner.</p>
<p>In other words it is a alternative to global variable, scala implicit, ThreadLocal.</p>
<ul class="simple">
<li><p>To compare with global variable, It allow to run multiple thread running the same code independently</p></li>
<li><p>To compare with scala implicit, it is less intrusive in the code base</p></li>
<li><p>To compare with ThreadLocal, it has some API to collect all ScopeProperty and restore them in the same state later on</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">Xlen</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">ScopeProperty</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">ScopePropertyMiaou</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">Xlen</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="nc">Xlen</span><span class="p">.</span><span class="n">get</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1</span>
<span class="w">  </span><span class="nc">Xlen</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nc">Xlen</span><span class="p">.</span><span class="n">get</span><span class="p">)</span><span class="w"> </span><span class="c1">// 2</span>
<span class="w">    </span><span class="nc">Xlen</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">println</span><span class="p">(</span><span class="nc">Xlen</span><span class="p">.</span><span class="n">get</span><span class="p">)</span><span class="w"> </span><span class="c1">// 3</span>
<span class="w">      </span><span class="nc">Xlen</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">println</span><span class="p">(</span><span class="nc">Xlen</span><span class="p">.</span><span class="n">get</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nc">Xlen</span><span class="p">.</span><span class="n">get</span><span class="p">)</span><span class="w"> </span><span class="c1">// 2</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Other language features/analog_inout"></span><section id="analog-and-inout">
<span id="section-analog-and-inout"></span><h3>Analog and inout<a class="headerlink" href="#analog-and-inout" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>You can define native tristate signals by using the <code class="docutils literal notranslate"><span class="pre">Analog</span></code>/<code class="docutils literal notranslate"><span class="pre">inout</span></code> features.
These features were added for the following reasons:</p>
<ul class="simple">
<li><p>Being able to add native tristate signals to the toplevel (it avoids having to manually wrap them with some hand-written VHDL/Verilog).</p></li>
<li><p>Allowing the definition of blackboxes which contain <code class="docutils literal notranslate"><span class="pre">inout</span></code> pins.</p></li>
<li><p>Being able to connect a blackbox’s <code class="docutils literal notranslate"><span class="pre">inout</span></code> pin through the hierarchy to a toplevel <code class="docutils literal notranslate"><span class="pre">inout</span></code> pin.</p></li>
</ul>
<p>As those features were only added for convenience, please do not try other fancy stuff with tristate logic just yet.</p>
<p>If you want to model a component like a memory-mapped GPIO peripheral, please use the <a class="reference internal" href="index.html#section-tristate"><span class="std std-ref">TriState/TriStateArray</span></a> bundles from the Spinal standard library, which abstract over the true nature of tristate drivers.</p>
</section>
<section id="analog">
<h4>Analog<a class="headerlink" href="#analog" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Analog</span></code> is the keyword which allows a signal to be defined as something analog, which in the digital world could mean <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code>, or <code class="docutils literal notranslate"><span class="pre">Z</span></code> (the disconnected, high-impedance state).</p>
<p>For instance:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SdramInterface</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">SdramLayout</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">DQ</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Analog</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// Bidirectional data bus</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">DQM</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">bytePerWord</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ADDR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">chipAddressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BA</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">bankWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">CKE</span><span class="p">,</span><span class="w"> </span><span class="nc">CSn</span><span class="p">,</span><span class="w"> </span><span class="nc">CASn</span><span class="p">,</span><span class="w"> </span><span class="nc">RASn</span><span class="p">,</span><span class="w"> </span><span class="nc">WEn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="inout">
<h4>inout<a class="headerlink" href="#inout" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">inout</span></code> is the keyword which allows you to set an <code class="docutils literal notranslate"><span class="pre">Analog</span></code> signal as a bidirectional (both “in” and “out”) signal.</p>
<p>For instance:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SdramInterface</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">SdramLayout</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">DQ</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Analog</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// Bidirectional data bus</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">DQM</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">bytePerWord</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ADDR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">chipAddressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BA</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">bankWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">CKE</span><span class="p">,</span><span class="w"> </span><span class="nc">CSn</span><span class="p">,</span><span class="w"> </span><span class="nc">CASn</span><span class="p">,</span><span class="w"> </span><span class="nc">RASn</span><span class="p">,</span><span class="w"> </span><span class="nc">WEn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">ADDR</span><span class="p">,</span><span class="w"> </span><span class="nc">BA</span><span class="p">,</span><span class="w"> </span><span class="nc">CASn</span><span class="p">,</span><span class="w"> </span><span class="nc">CKE</span><span class="p">,</span><span class="w"> </span><span class="nc">CSn</span><span class="p">,</span><span class="w"> </span><span class="nc">DQM</span><span class="p">,</span><span class="w"> </span><span class="nc">RASn</span><span class="p">,</span><span class="w"> </span><span class="nc">WEn</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">inout</span><span class="p">(</span><span class="nc">DQ</span><span class="p">)</span><span class="w"> </span><span class="c1">// Set the Analog DQ as an inout signal of the component</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="inoutwrapper">
<h4>InOutWrapper<a class="headerlink" href="#inoutwrapper" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">InOutWrapper</span></code> is a tool which allows you to transform all <code class="docutils literal notranslate"><span class="pre">master</span></code> <code class="docutils literal notranslate"><span class="pre">TriState</span></code>/<code class="docutils literal notranslate"><span class="pre">TriStateArray</span></code>/<code class="docutils literal notranslate"><span class="pre">ReadableOpenDrain</span></code> bundles of a component into native <code class="docutils literal notranslate"><span class="pre">inout(Analog(...))</span></code> signals.
It allows you to keep your hardware description free of any <code class="docutils literal notranslate"><span class="pre">Analog</span></code>/<code class="docutils literal notranslate"><span class="pre">inout</span></code> things, and then transform the toplevel to make it synthesis ready.</p>
<p>For instance:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">(</span><span class="n">gpioWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">TriStateArray</span><span class="p">(</span><span class="n">gpioWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Gpio</span><span class="p">.</span><span class="n">getApb3Config</span><span class="p">()))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nc">SpinalVhdl</span><span class="p">(</span><span class="nc">InOutWrapper</span><span class="p">(</span><span class="nc">Apb3Gpio</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
<p>Will generate:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">entity</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">io_gpio</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">inout</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">-- This io_gpio was originally a TriStateArray Bundle</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PADDR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PSEL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PENABLE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PREADY</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PWRITE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PWDATA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PRDATA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PSLVERROR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">clk</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">reset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Instead of:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">entity</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">io_gpio_read</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_gpio_write</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_gpio_writeEnable</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PADDR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PSEL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PENABLE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PREADY</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PWRITE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PWDATA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PRDATA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_apb_PSLVERROR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">clk</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">reset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="manually-driving-analog-bundles">
<h4>Manually driving Analog bundles<a class="headerlink" href="#manually-driving-analog-bundles" title="Permalink to this heading"></a></h4>
<p>If an <code class="docutils literal notranslate"><span class="pre">Analog</span></code> bundle is not driven, it will default to being high-Z.
Therefore to manually implement a tristate driver (in case the <code class="docutils literal notranslate"><span class="pre">InOutWrapper</span></code> type can’t be used for some reason) you have to conditionally drive the signal.</p>
<p>To manually connect a <code class="docutils literal notranslate"><span class="pre">TriState</span></code> signal to an <code class="docutils literal notranslate"><span class="pre">Analog</span></code> bundle:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Example</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">TriState</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">analog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inout</span><span class="p">(</span><span class="nc">Analog</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">tri</span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">analog</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">tri</span><span class="p">.</span><span class="n">writeEnable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">analog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">tri</span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Other language features/vhdl_generation"></span><section id="vhdl-and-verilog-generation">
<h3>VHDL and Verilog generation<a class="headerlink" href="#vhdl-and-verilog-generation" title="Permalink to this heading"></a></h3>
<section id="generate-vhdl-and-verilog-from-a-spinalhdl-component">
<h4>Generate VHDL and Verilog from a SpinalHDL Component<a class="headerlink" href="#generate-vhdl-and-verilog-from-a-spinalhdl-component" title="Permalink to this heading"></a></h4>
<p>To generate the VHDL from a SpinalHDL component you just need to call <code class="docutils literal notranslate"><span class="pre">SpinalVhdl(new</span> <span class="pre">YourComponent)</span></code> in a Scala <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
<p>Generating Verilog is exactly the same, but with <code class="docutils literal notranslate"><span class="pre">SpinalVerilog</span></code> in place of <code class="docutils literal notranslate"><span class="pre">SpinalVHDL</span></code></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// A simple component definition.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Define some input/output signals. Bundle like a VHDL record or a Verilog struct.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define some asynchronous logic.</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// This is the main function that generates the VHDL and the Verilog corresponding to MyTopLevel.</span>
<span class="k">object</span><span class="w"> </span><span class="nc">MyMain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code class="docutils literal notranslate"><span class="pre">SpinalVhdl</span></code> and <code class="docutils literal notranslate"><span class="pre">SpinalVerilog</span></code> may need to create multiple instances of your component class, therefore the first argument is not a <code class="docutils literal notranslate"><span class="pre">Component</span></code> reference, but a function that returns a new component.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SpinalVerilog</span></code> implementation began the 5th of June, 2016.
This backend successfully passes the same regression tests as the VHDL one (RISCV CPU, Multicore and pipelined mandelbrot, UART RX/TX, Single clock fifo, Dual clock fifo, Gray counter, …).</p>
<p>If you have any issues with this new backend, please make a <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/issues">Github issue</a> describing the problem.</p>
</div>
<section id="parametrization-from-scala">
<h5>Parametrization from Scala<a class="headerlink" href="#parametrization-from-scala" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">mode</span></code></p></td>
<td><p>SpinalMode</p></td>
<td><p>null</p></td>
<td><div class="line-block">
<div class="line">Set the SpinalHDL hdl generation mode.</div>
<div class="line">Can be set to <code class="docutils literal notranslate"><span class="pre">VHDL</span></code> or <code class="docutils literal notranslate"><span class="pre">Verilog</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">defaultConfigForClockDomains</span></code></p></td>
<td><p>ClockDomainConfig</p></td>
<td><div class="line-block">
<div class="line">RisingEdgeClock</div>
<div class="line">AsynchronousReset</div>
<div class="line">ResetActiveHigh</div>
<div class="line">ClockEnableActiveHigh</div>
</div>
</td>
<td><p>Set the clock configuration that will be used as the default value for all new <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">onlyStdLogicVectorAtTopLevelIo</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Change all unsigned/signed toplevel io into std_logic_vector.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">defaultClockDomainFrequency</span></code></p></td>
<td><p>IClockDomainFrequency</p></td>
<td><p> UnknownFrequency</p></td>
<td><p>Default clock frequency.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">targetDirectory</span></code></p></td>
<td><p>String</p></td>
<td><p>Current directory</p></td>
<td><p>Directory where files are generated.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">oneFilePerComponent</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Instead of generating one big VHDL/Verilog file, every component will get its own VHDL/Verilog file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">netlistFileName</span></code></p></td>
<td><p>String</p></td>
<td><p>ToplevelClassName.(vhd|v)</p></td>
<td><p>Allow to change the name of the generated VHDL/Verilog.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">globalPrefix</span></code></p></td>
<td><p>String</p></td>
<td><p>“”</p></td>
<td><p>Will add the given prefix in the front of every global symboles in the VHDL/Verilog (components/modules/enums). This allows to avoid naming conflict between multiple generated file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">privateNamespace</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Every generated Component/Modules names will get prefixed with the toplevel Component/Module name (excepted for the toplevel). This allows to avoid naming conflict between multiple generated file.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">formalAsserts</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Enable the generation of the formal assertions in the VHDL/Verilog.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">anonymSignalPrefix</span></code></p></td>
<td><p>String</p></td>
<td><p>“zz_”</p></td>
<td><p>Set the prefix added to unnamed signals.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">inlineRom</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Configure the Verilog backend to incorporate the ROM values initialization in the verilog itself instead of an bin file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">caseRom</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Generate the ROM as a big switch case.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">mergeAsyncProcess</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Will merge process/always blocks for combinatorial signal which share at least one conditional assignement (if/switch statment)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">mergeSyncProcess</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
<td><p>Will merge process/always blocks for flip-flops which use the same clock domain (if/switch statment)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">genLineComments</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>For each hardware assignment in the generated VHDL/Verilog code, will attach a comment which specifies in which scala file, at which line, the assignement happend. Ex : a = 1’b1; // &#64; MyDesign.scala l1135</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">noAssert</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Remove all the asserts from the generated code</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">headerWithDate</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Add the date at which the VHDL/Verilog was generated in its header.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">headerWithRepoHash</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
<td><p>Add the current directory git hash in the generated VHDL/Verilog header.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">dontCareGenAsZero</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Replace mySignal.assignDontCare() by mySignal := 0</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">obfuscateNames</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Will obfuscate the generated components and signal names.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">rtlHeader</span></code></p></td>
<td><p>String</p></td>
<td><p>disabled</p></td>
<td><p>Allow to manualy specify the VHDL/Verilog file header</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withTimescale</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><p>Enable the addition of the timescale in the generated Verilog</p></td>
</tr>
</tbody>
</table>
<p>And this is the syntax to specify them:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalConfig</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="nc">VHDL</span><span class="p">,</span><span class="w"> </span><span class="n">targetDirectory</span><span class="o">=</span><span class="s">&quot;temp/myDesign&quot;</span><span class="p">).</span><span class="n">generate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Or for Verilog in a more scalable formatting:</span>
<span class="nc">SpinalConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">mode</span><span class="o">=</span><span class="nc">Verilog</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">targetDirectory</span><span class="o">=</span><span class="s">&quot;temp/myDesign&quot;</span><span class="w"></span>
<span class="p">).</span><span class="n">generate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="parametrization-from-shell">
<h5>Parametrization from shell<a class="headerlink" href="#parametrization-from-shell" title="Permalink to this heading"></a></h5>
<p>You can also specify generation parameters by using command line arguments.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalConfig</span><span class="p">.</span><span class="n">shell</span><span class="p">(</span><span class="n">args</span><span class="p">)(</span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The syntax for command line arguments is:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Usage: SpinalCore [options]

  --vhdl
        Select the VHDL mode
  --verilog
        Select the Verilog mode
  -d | --debug
        Enter in debug mode directly
  -o &lt;value&gt; | --targetDirectory &lt;value&gt;
        Set the target directory
</pre></div>
</div>
</section>
</section>
<section id="generated-vhdl-and-verilog">
<h4>Generated VHDL and Verilog<a class="headerlink" href="#generated-vhdl-and-verilog" title="Permalink to this heading"></a></h4>
<p>How a SpinalHDL RTL description is translated into VHDL and Verilog is important:</p>
<ul class="simple">
<li><p>Names in Scala are preserved in VHDL and Verilog.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Component</span></code> hierarchy in Scala is preserved in VHDL and Verilog.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">when</span></code> statements in Scala are emitted as if statements in VHDL and Verilog.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">switch</span></code> statements in Scala are emitted as case statements in VHDL and Verilog in all standard cases.</p></li>
</ul>
<section id="organization">
<h5>Organization<a class="headerlink" href="#organization" title="Permalink to this heading"></a></h5>
<p>When you use the VHDL generator, all modules are generated into a single file which contain three sections:</p>
<ol class="arabic simple">
<li><p>A package that contains the definition of all Enums</p></li>
<li><p>A package that contains functions used by the architectural elements</p></li>
<li><p>All components needed by your design</p></li>
</ol>
<p>When you use the Verilog generation, all modules are generated into a single file which contains two sections:</p>
<ol class="arabic simple">
<li><p>All enumeration definitions used</p></li>
<li><p>All modules needed by your design</p></li>
</ol>
</section>
<section id="combinational-logic">
<h5>Combinational logic<a class="headerlink" href="#combinational-logic" title="Permalink to this heading"></a></h5>
<p>Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">withoutProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">withProcess</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">withoutProcess</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">withProcess</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">U</span><span class="s">&quot;0000&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">withProcess</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">U</span><span class="s">&quot;0001&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">withProcess</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">withProcess</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>VHDL:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">entity</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">io_cond</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_withoutProcess</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_withProcess</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">;</span><span class="w"></span>

<span class="k">architecture</span><span class="w"> </span><span class="nc">arch</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="k">begin</span><span class="w"></span>
<span class="w">  </span><span class="n">io_withoutProcess</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io_value</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">process</span><span class="p">(</span><span class="n">io_cond</span><span class="p">,</span><span class="n">io_value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">io_withProcess</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;0000&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">io_cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">io_value</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;0000&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">          </span><span class="n">io_withProcess</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;1000&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;0001&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">          </span><span class="n">io_withProcess</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="k">others</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">          </span><span class="n">io_withProcess</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">io_value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;0001&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">case</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="k">process</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="nc">arch</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sequential-logic">
<h5>Sequential logic<a class="headerlink" href="#sequential-logic" title="Permalink to this heading"></a></h5>
<p>Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">resultA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">resultB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regWithReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regWithoutReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="n">regWithReset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="n">regWithoutReset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">regWithoutReset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">resultA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">regWithReset</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">resultB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">regWithoutReset</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>VHDL:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">entity</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">io_cond</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">io_value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_resultA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_resultB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">clk</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">reset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">;</span><span class="w"></span>

<span class="k">architecture</span><span class="w"> </span><span class="nc">arch</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">is</span><span class="w"></span>

<span class="w">  </span><span class="k">signal</span><span class="w"> </span><span class="n">regWithReset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">signal</span><span class="w"> </span><span class="n">regWithoutReset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="k">begin</span><span class="w"></span>
<span class="w">  </span><span class="n">io_resultA</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">regWithReset</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">io_resultB</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">regWithoutReset</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">process</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span><span class="n">reset</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">      </span><span class="n">regWithReset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;0000&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">elsif</span><span class="w"> </span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">      </span><span class="n">regWithReset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io_value</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="k">process</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">process</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">      </span><span class="n">regWithoutReset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pkg_unsigned</span><span class="p">(</span><span class="s">&quot;0000&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">io_cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">        </span><span class="n">regWithoutReset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io_value</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="k">process</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="nc">arch</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="vhdl-and-verilog-attributes">
<span id="id1"></span><h4>VHDL and Verilog attributes<a class="headerlink" href="#vhdl-and-verilog-attributes" title="Permalink to this heading"></a></h4>
<p>In some situations, it is useful to give attributes for some signals in a design to modify how they are synthesized.</p>
<p>To do that, you can call the following functions on any signals or memories in the design:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">addAttribute(name)</span></code></p></td>
<td><p>Add a boolean attribute with the given <code class="docutils literal notranslate"><span class="pre">name</span></code> set to true</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">addAttribute(name,</span> <span class="pre">value)</span></code></p></td>
<td><p>Add a string attribute with the given <code class="docutils literal notranslate"><span class="pre">name</span></code> set to <code class="docutils literal notranslate"><span class="pre">value</span></code></p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">pcPlus4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="n">pcPlus4</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="s">&quot;keep&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Produced declaration in VHDL:</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">attribute</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"></span>
<span class="k">signal</span><span class="w"> </span><span class="n">pcPlus4</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="k">attribute</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">pcPlus4</span><span class="o">:</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">true</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Produced declaration in Verilog:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pcPlus4</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/index"></span><section id="libraries">
<span id="lib-introduction"></span><h2>Libraries<a class="headerlink" href="#libraries" title="Permalink to this heading"></a></h2>
<p>The spinal.lib package goals are :</p>
<ul class="simple">
<li><p>Provide things that are commonly used in hardware design (FIFO, clock crossing bridges, useful functions)</p></li>
<li><p>Provide simple peripherals (UART, JTAG, VGA, ..)</p></li>
<li><p>Provide some bus definition (Avalon, AMBA, ..)</p></li>
<li><p>Provide some methodology (Stream, Flow, Fragment)</p></li>
<li><p>Provide some example to get the spirit of spinal</p></li>
<li><p>Provide some tools and facilities (latency analyzer, QSys converter, …)</p></li>
</ul>
<p>To use features introduced in followings chapter you need, in most of cases, to <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">spinal.lib._</span></code> in your sources.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<div class="line-block">
<div class="line">This package is currently under construction. Documented features could be considered as stable.</div>
<div class="line">Do not hesitate to use github for suggestions/bug/fixes/enhancements</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/utils"></span><section id="utils">
<h3>Utils<a class="headerlink" href="#utils" title="Permalink to this heading"></a></h3>
<p>Some utils are also present in <a class="reference internal" href="index.html#utils"><span class="std std-ref">spinal.core</span></a></p>
<section id="state-less-utilities">
<h4>State less utilities<a class="headerlink" href="#state-less-utilities" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 13%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>toGray(x : UInt)</p></td>
<td><p>Bits</p></td>
<td><p>Return the gray value converted from <code class="docutils literal notranslate"><span class="pre">x</span></code> (UInt)</p></td>
</tr>
<tr class="row-odd"><td><p>fromGray(x : Bits)</p></td>
<td><p>UInt</p></td>
<td><p>Return the UInt value converted value from <code class="docutils literal notranslate"><span class="pre">x</span></code> (gray)</p></td>
</tr>
<tr class="row-even"><td><p>Reverse(x : T)</p></td>
<td><p>T</p></td>
<td><p>Flip all bits (lsb + n -&gt; msb - n)</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">OHToUInt(x : Seq[Bool])</div>
<div class="line">OHToUInt(x : BitVector)</div>
</div>
</td>
<td><p>UInt</p></td>
<td><p>Return the index of the single bit set (one hot) in <code class="docutils literal notranslate"><span class="pre">x</span></code></p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">CountOne(x : Seq[Bool])</div>
<div class="line">CountOne(x : BitVector)</div>
</div>
</td>
<td><p>UInt</p></td>
<td><p>Return the number of bit set in <code class="docutils literal notranslate"><span class="pre">x</span></code></p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">CountLeadingZeroes(x : Bits)</div>
</div>
</td>
<td><p>UInt</p></td>
<td><p>Return the number of consecutive zero bits starting from the MSB</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">MajorityVote(x : Seq[Bool])</div>
<div class="line">MajorityVote(x : BitVector)</div>
</div>
</td>
<td><p>Bool</p></td>
<td><p>Return True if the number of bit set is &gt; x.size / 2</p></td>
</tr>
<tr class="row-odd"><td><p>EndiannessSwap(that: T[, base:BitCount])</p></td>
<td><p>T</p></td>
<td><p>Big-Endian &lt;-&gt; Little-Endian</p></td>
</tr>
<tr class="row-even"><td><p>OHMasking.first(x : Bits)</p></td>
<td><p>Bits</p></td>
<td><p>Apply a mask on x to only keep the first bit set</p></td>
</tr>
<tr class="row-odd"><td><p>OHMasking.last(x : Bits)</p></td>
<td><p>Bits</p></td>
<td><p>Apply a mask on x to only keep the last bit set</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">OHMasking.roundRobin(</div>
<div class="line-block">
<div class="line">requests : Bits,</div>
<div class="line">ohPriority : Bits</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Bits</p></td>
<td><div class="line-block">
<div class="line">Apply a mask on x to only keep the bit set from <code class="docutils literal notranslate"><span class="pre">requests</span></code>.</div>
<div class="line">it start looking in <code class="docutils literal notranslate"><span class="pre">requests</span></code> from the <code class="docutils literal notranslate"><span class="pre">ohPriority</span></code> position.</div>
<div class="line">For example if <code class="docutils literal notranslate"><span class="pre">requests</span></code> is “1001” and <code class="docutils literal notranslate"><span class="pre">ohPriority</span></code> is “0010”, the <code class="docutils literal notranslate"><span class="pre">roundRobin</span></code> function will start looking in <cite>requests</cite> from its second bit and will return “1000”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">MuxOH (</div>
<div class="line-block">
<div class="line">oneHot : IndexedSeq[Bool],</div>
<div class="line">inputs : Iterable[T]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>T</p></td>
<td><p>Returns the muxed <code class="docutils literal notranslate"><span class="pre">T</span></code> from the <code class="docutils literal notranslate"><span class="pre">inputs</span></code> based on the <code class="docutils literal notranslate"><span class="pre">oneHot</span></code> vector.</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">PriorityMux (</div>
<div class="line-block">
<div class="line">sel: Seq[Bool],</div>
<div class="line">in:  Seq[T]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>T</p></td>
<td><p>Return the first <code class="docutils literal notranslate"><span class="pre">in</span></code> element whose <code class="docutils literal notranslate"><span class="pre">sel</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">PriorityMux (</div>
<div class="line-block">
<div class="line">in:  Seq[(Bool, T)]</div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>T</p></td>
<td><p>Return the first <code class="docutils literal notranslate"><span class="pre">in</span></code> element whose <code class="docutils literal notranslate"><span class="pre">sel</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="state-full-utilities">
<h4>State full utilities<a class="headerlink" href="#state-full-utilities" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 11%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Delay(that: T, cycleCount: Int)</p></td>
<td><p>T</p></td>
<td><p>Return <code class="docutils literal notranslate"><span class="pre">that</span></code> delayed by <code class="docutils literal notranslate"><span class="pre">cycleCount</span></code> cycles</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">History (</div>
<div class="line-block">
<div class="line">that: T, length: Int</div>
<div class="line"><em>[</em>, when : Bool<em>][</em>, init : T<em>]</em></div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Vec[T]</p></td>
<td><div class="line-block">
<div class="line">Return a Vec of <code class="docutils literal notranslate"><span class="pre">length</span></code> elements</div>
<div class="line">The first element is <code class="docutils literal notranslate"><span class="pre">that</span></code>, the last one is <code class="docutils literal notranslate"><span class="pre">that</span></code> delayed by <code class="docutils literal notranslate"><span class="pre">length</span></code> - 1</div>
<div class="line">The internal shift register sample when <code class="docutils literal notranslate"><span class="pre">when</span></code> is asserted</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">History (</div>
<div class="line-block">
<div class="line">that: T, range: Range</div>
<div class="line"><em>[</em>, when : Bool<em>][</em>, init : T<em>]</em></div>
</div>
<div class="line">)</div>
</div>
</td>
<td><p>Vec[T]</p></td>
<td><div class="line-block">
<div class="line">Same as <code class="docutils literal notranslate"><span class="pre">History(that,</span> <span class="pre">length)</span></code></div>
<div class="line">but return a Vec of size <code class="docutils literal notranslate"><span class="pre">range.length</span></code></div>
<div class="line">where the first element is delayed by <code class="docutils literal notranslate"><span class="pre">range.low</span></code></div>
<div class="line">and the last by <code class="docutils literal notranslate"><span class="pre">range.high</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>BufferCC(input : T)</p></td>
<td><p>T</p></td>
<td><p>Return the input signal synchronized with the current clock domain by using 2 flip-flops</p></td>
</tr>
</tbody>
</table>
<section id="counter">
<h5>Counter<a class="headerlink" href="#counter" title="Permalink to this heading"></a></h5>
<p>The Counter tool can be used to easily instantiate a hardware counter.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Instantiation syntax</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Counter(start:</span> <span class="pre">BigInt,</span> <span class="pre">end:</span> <span class="pre">BigInt[,</span> <span class="pre">inc</span> <span class="pre">:</span> <span class="pre">Bool])</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Counter(range</span> <span class="pre">:</span> <span class="pre">Range[,</span> <span class="pre">inc</span> <span class="pre">:</span> <span class="pre">Bool])</span></code></p></td>
<td><p>Compatible with the  <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">to</span> <span class="pre">y</span></code> <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">until</span> <span class="pre">y</span></code> syntaxes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Counter(stateCount:</span> <span class="pre">BigInt[,</span> <span class="pre">inc</span> <span class="pre">:</span> <span class="pre">Bool])</span></code></p></td>
<td><p>Starts at zero and ends at <code class="docutils literal notranslate"><span class="pre">stateCount</span> <span class="pre">-</span> <span class="pre">1</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Counter(bitCount:</span> <span class="pre">BitCount[,</span> <span class="pre">inc</span> <span class="pre">:</span> <span class="pre">Bool])</span></code></p></td>
<td><p>Starts at zero and ends at <code class="docutils literal notranslate"><span class="pre">(1</span> <span class="pre">&lt;&lt;</span> <span class="pre">bitCount)</span> <span class="pre">-</span> <span class="pre">1</span></code></p></td>
</tr>
</tbody>
</table>
<p>A counter can be controlled by methods, and signals can be read:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Counter</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="c1">// Creates a counter of 8 states (2 to 9)</span>
<span class="c1">// Methods</span>
<span class="n">counter</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w">               </span><span class="c1">// Resets the counter</span>
<span class="n">counter</span><span class="p">.</span><span class="n">increment</span><span class="p">()</span><span class="w">           </span><span class="c1">// Increments the counter</span>
<span class="c1">// Signals</span>
<span class="n">counter</span><span class="p">.</span><span class="n">value</span><span class="w">                 </span><span class="c1">// Current value</span>
<span class="n">counter</span><span class="p">.</span><span class="n">valueNext</span><span class="w">             </span><span class="c1">// Next value</span>
<span class="n">counter</span><span class="p">.</span><span class="n">willOverflow</span><span class="w">          </span><span class="c1">// True if the counter overflows this cycle</span>
<span class="n">counter</span><span class="p">.</span><span class="n">willOverflowIfInc</span><span class="w">     </span><span class="c1">// True if the counter would overflow this cycle if an increment was done</span>
<span class="c1">// Cast</span>
<span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">5</span><span class="p">){</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w">    </span><span class="c1">// counter is implicitly casted to its current value</span>
</pre></div>
</div>
<p>When a <code class="docutils literal notranslate"><span class="pre">Counter</span></code> overflows (reached end value), it restarts the next cycle to its start value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, only up counter are supported.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CounterFreeRun</span></code> builds an always running counter: <code class="docutils literal notranslate"><span class="pre">CounterFreeRun(stateCount:</span> <span class="pre">BigInt)</span></code>.</p>
</section>
<section id="timeout">
<h5>Timeout<a class="headerlink" href="#timeout" title="Permalink to this heading"></a></h5>
<p>The Timeout tool can be used to easily instantiate an hardware timeout.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Instantiation syntax</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Timeout(cycles : BigInt)</p></td>
<td><p>Tick after <code class="docutils literal notranslate"><span class="pre">cycles</span></code> clocks</p></td>
</tr>
<tr class="row-odd"><td><p>Timeout(time : TimeNumber)</p></td>
<td><p>Tick after a <code class="docutils literal notranslate"><span class="pre">time</span></code> duration</p></td>
</tr>
<tr class="row-even"><td><p>Timeout(frequency : HertzNumber)</p></td>
<td><p>Tick at an <code class="docutils literal notranslate"><span class="pre">frequency</span></code> rate</p></td>
</tr>
</tbody>
</table>
<p>There is an example of different syntaxes which could be used with the Counter tool</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Timeout</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="n">ms</span><span class="p">)</span><span class="w">  </span><span class="c1">// Timeout who tick after 10 ms</span>
<span class="n">when</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">               </span><span class="c1">// Check if the timeout has tick</span>
<span class="w">    </span><span class="n">timeout</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w">           </span><span class="c1">// Ask the timeout to clear its flag</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you instantiate an <code class="docutils literal notranslate"><span class="pre">Timeout</span></code> with an time or frequency setup, the implicit <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> should have an frequency setting.</p>
</div>
</section>
<section id="resetctrl">
<h5>ResetCtrl<a class="headerlink" href="#resetctrl" title="Permalink to this heading"></a></h5>
<p>The ResetCtrl provide some utilities to manage resets.</p>
<section id="asyncassertsyncdeassert">
<h6>asyncAssertSyncDeassert<a class="headerlink" href="#asyncassertsyncdeassert" title="Permalink to this heading"></a></h6>
<p>You can filter an asynchronous reset by using an asynchronously asserted synchronously deasserted logic. To do it you can use the <code class="docutils literal notranslate"><span class="pre">ResetCtrl.asyncAssertSyncDeassert</span></code> function which will return you the filtered value.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>input</p></td>
<td><p>Bool</p></td>
<td><p>Signal that should be filtered</p></td>
</tr>
<tr class="row-odd"><td><p>clockDomain</p></td>
<td><p>ClockDomain</p></td>
<td><p>ClockDomain which will use the filtered value</p></td>
</tr>
<tr class="row-even"><td><p>inputPolarity</p></td>
<td><p>Polarity</p></td>
<td><p>HIGH/LOW (default=HIGH)</p></td>
</tr>
<tr class="row-odd"><td><p>outputPolarity</p></td>
<td><p>Polarity</p></td>
<td><p>HIGH/LOW (default=clockDomain.config.resetActiveLevel)</p></td>
</tr>
<tr class="row-even"><td><p>bufferDepth</p></td>
<td><p>Int</p></td>
<td><p>Number of register stages used to avoid metastability (default=2)</p></td>
</tr>
</tbody>
</table>
<p>There is also an <code class="docutils literal notranslate"><span class="pre">ResetCtrl.asyncAssertSyncDeassertDrive</span></code> version of tool which directly assign the <code class="docutils literal notranslate"><span class="pre">clockDomain</span></code> reset with the filtered value.</p>
</section>
</section>
</section>
<section id="special-utilities">
<h4>Special utilities<a class="headerlink" href="#special-utilities" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 11%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LatencyAnalysis(paths : Node*)</p></td>
<td><p>Int</p></td>
<td><div class="line-block">
<div class="line">Return the shortest path, in terms of cycles, that travel through all nodes,</div>
<div class="line">from the first one to the last one</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-SpinalHDL/Libraries/stream"></span><section id="stream">
<span id="id1"></span><h3>Stream<a class="headerlink" href="#stream" title="Permalink to this heading"></a></h3>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h4>
<div class="line-block">
<div class="line">The Stream interface is a simple handshake protocol to carry payload.</div>
<div class="line">It could be used for example to push and pop elements into a FIFO, send requests to a UART controller, etc.</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 71%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signal</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Driver</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Don’t care when</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>valid</p></td>
<td><p>Bool</p></td>
<td><p>Master</p></td>
<td><p>When high =&gt; payload present on the interface</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>ready</p></td>
<td><p>Bool</p></td>
<td><p>Slave</p></td>
<td><p>When low =&gt; transaction are not consumed by the slave</p></td>
<td><p>valid is low</p></td>
</tr>
<tr class="row-even"><td><p>payload</p></td>
<td><p>T</p></td>
<td><p>Master</p></td>
<td><p>Content of the transaction</p></td>
<td><p>valid is low</p></td>
</tr>
</tbody>
</table>

<div style="overflow-x:auto">
<script type="WaveDrom">
{ "signal": [
  {"name": "clk",     "wave": "p........."},
  {"name": "valid"  , "wave": "0101..01.0"},
  {"name": "ready"  , "wave": "x1x0.1x1.x"},
  {"name": "payload", "wave": "x=x=..x==x","data":["D0","D1","D2","D3"]}
]}
</script>
</div>
<p>There is some examples of usage in SpinalHDL :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">StreamArbiter</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="n">portCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="p">),</span><span class="n">portCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each slave can or can’t allow the payload to change when valid is high and ready is low. For examples:</p>
</div>
<ul class="simple">
<li><p>An priority arbiter without lock logic can switch from one input to the other (which will change the payload).</p></li>
<li><p>An UART controller could directly use the write port to drive UART pins and only consume the transaction at the end of the transmission.
Be careful with that.</p></li>
</ul>
</section>
<section id="semantics">
<h4>Semantics<a class="headerlink" href="#semantics" title="Permalink to this heading"></a></h4>
<p>When manually reading/driving the signals of a Stream keep in mind that:</p>
<ul class="simple">
<li><p>After being asserted, <code class="docutils literal notranslate"><span class="pre">valid</span></code> may only be deasserted once the current payload was acknowledged. This means <code class="docutils literal notranslate"><span class="pre">valid</span></code> can only toggle to 0 the cycle after a the slave did a read by asserting <code class="docutils literal notranslate"><span class="pre">ready</span></code>.</p></li>
<li><p>In contrast to that <code class="docutils literal notranslate"><span class="pre">ready</span></code> may change at any time.</p></li>
<li><p>A transfer is only done on cycles where both <code class="docutils literal notranslate"><span class="pre">valid</span></code> and <code class="docutils literal notranslate"><span class="pre">ready</span></code> are asserted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">valid</span></code> of a Stream must not depend on <code class="docutils literal notranslate"><span class="pre">ready</span></code> in a combinatorial way and any path between the two must be registered.</p></li>
<li><p>It is recommended that <code class="docutils literal notranslate"><span class="pre">valid</span></code> does not depend on <code class="docutils literal notranslate"><span class="pre">ready</span></code> at all.</p></li>
</ul>
</section>
<section id="functions">
<h4>Functions<a class="headerlink" href="#functions" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 42%" />
<col style="width: 42%" />
<col style="width: 8%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Latency</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Stream(type : Data)</p></td>
<td><p>Create a Stream of a given type</p></td>
<td><p>Stream[T]</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>master/slave Stream(type : Data)</p></td>
<td><div class="line-block">
<div class="line">Create a Stream of a given type</div>
<div class="line">Initialized with corresponding in/out setup</div>
</div>
</td>
<td><p>Stream[T]</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.fire</p></td>
<td><p>Return True when a transaction is consumed on the bus (valid &amp;&amp; ready)</p></td>
<td><p>Bool</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>x.isStall</p></td>
<td><p>Return True when a transaction is stall on the bus (valid &amp;&amp; ! ready)</p></td>
<td><p>Bool</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.isFree</p></td>
<td><p>Return True when the bus isn’t stuck with a transaction (!isStall)</p></td>
<td><p>Bool</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>x.queue(size:Int)</p></td>
<td><p>Return a Stream connected to x through a FIFO</p></td>
<td><p>Stream[T]</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">x.m2sPipe()</div>
<div class="line">x.stage()</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Return a Stream driven by x</div>
<div class="line">through a register stage that cut valid/payload paths</div>
<div class="line">Cost = (payload width + 1) flip-flops</div>
</div>
</td>
<td><p>Stream[T]</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>x.s2mPipe()</p></td>
<td><div class="line-block">
<div class="line">Return a Stream driven by x</div>
<div class="line">ready paths is cut by a register stage</div>
<div class="line">Cost = payload width * (mux2 + 1 flip-flops)</div>
</div>
</td>
<td><p>Stream[T]</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>x.halfPipe()</p></td>
<td><div class="line-block">
<div class="line">Return a Stream driven by x</div>
<div class="line">valid/ready/payload paths are cut by some register</div>
<div class="line">Cost = (payload width + 2) flip-flops, bandwidth divided by two</div>
</div>
</td>
<td><p>Stream[T]</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">x &lt;&lt; y</div>
<div class="line">y &gt;&gt; x</div>
</div>
</td>
<td><p>Connect y to x</p></td>
<td></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">x &lt;-&lt; y</div>
<div class="line">y &gt;-&gt; x</div>
</div>
</td>
<td><p>Connect y to x through a m2sPipe</p></td>
<td></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">x &lt;/&lt; y</div>
<div class="line">y &gt;/&gt; x</div>
</div>
</td>
<td><p>Connect y to x through a s2mPipe</p></td>
<td></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">x &lt;-/&lt; y</div>
<div class="line">y &gt;/-&gt; x</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Connect y to x through s2mPipe().m2sPipe()</div>
<div class="line">Which imply no combinatorial path between x and y</div>
</div>
</td>
<td></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>x.haltWhen(cond : Bool)</p></td>
<td><div class="line-block">
<div class="line">Return a Stream connected to x</div>
<div class="line">Halted when cond is true</div>
</div>
</td>
<td><p>Stream[T]</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>x.throwWhen(cond : Bool)</p></td>
<td><div class="line-block">
<div class="line">Return a Stream connected to x</div>
<div class="line">When cond is true, transaction are dropped</div>
</div>
</td>
<td><p>Stream[T]</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>x.translateWith(that : T2)</p></td>
<td><div class="line-block">
<div class="line">Return a Stream with payload <cite>that</cite></div>
<div class="line">Modify the payload of the <cite>x</cite> stream, while preserving the <cite>valid</cite> and <cite>ready</cite> signals</div>
</div>
</td>
<td><p>Stream[T2]</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>x.map(translate: (T) =&gt; T2)</p></td>
<td><div class="line-block">
<div class="line">Return a Stream with payload calculated by translate function</div>
<div class="line">Modify the payload of the <cite>x</cite> stream, while preserving the <cite>valid</cite> and <cite>ready</cite> signals</div>
</div>
</td>
<td><p>Stream[T2]</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>The following code will create this logic :</p>
<img alt="_images/stream_throw_m2spipe.svg" class="align-center" src="_images/stream_throw_m2spipe.svg" /><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">red</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">blue</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">isBlack</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">red</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">sink</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="n">sink</span><span class="w"> </span><span class="o">&lt;-&lt;</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">throwWhen</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">isBlack</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="utils">
<h4>Utils<a class="headerlink" href="#utils" title="Permalink to this heading"></a></h4>
<p>There is many utils that you can use in your design in conjunction with the Stream bus, this chapter will document them.</p>
<section id="streamfifo">
<h5>StreamFifo<a class="headerlink" href="#streamfifo" title="Permalink to this heading"></a></h5>
<p>On each stream you can call the .queue(size) to get a buffered stream. But you can also instantiate the FIFO component itself :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">streamA</span><span class="p">,</span><span class="n">streamB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myFifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">dataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">depth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">myFifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">streamA</span><span class="w"></span>
<span class="n">myFifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">streamB</span><span class="w"></span>
</pre></div>
</div>
<p>Mandatory parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dataType</p></td>
<td><p>T</p></td>
<td><p>Payload data type</p></td>
</tr>
<tr class="row-odd"><td><p>depth</p></td>
<td><p>Int</p></td>
<td><p>Number of element stored in the fifo, Note that if <code class="docutils literal notranslate"><span class="pre">withAsyncRead==false</span></code>, then one extra transaction can be stored.</p></td>
</tr>
</tbody>
</table>
<p>Optional parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>withAsyncRead</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Read the memory using asynchronous read port (ex distributed ram). If false, add 1 cycle latency.</p></td>
</tr>
<tr class="row-odd"><td><p>withBypass</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Bypass the push port to the pop port when the fifo is empty.If false, add  1 cycle latency. Only available if <code class="docutils literal notranslate"><span class="pre">withAsyncRead</span> <span class="pre">==</span> <span class="pre">true</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>forFMax</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Tune the design to get the maximal clock frequency.</p></td>
</tr>
<tr class="row-odd"><td><p>useVec</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Use an <code class="docutils literal notranslate"><span class="pre">Vec</span></code> of register instead of a Mem to store the content</p></td>
</tr>
<tr class="row-even"><td><p>initPayload</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
<td><p>A <code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">Option[T]</span></code> function that return a value to init the  <code class="docutils literal notranslate"><span class="pre">Vec</span></code> register, only meaningful when <code class="docutils literal notranslate"><span class="pre">useVec</span> <span class="pre">==</span> <span class="pre">true</span></code></p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 40%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>io name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>push</p></td>
<td><p>Stream[T]</p></td>
<td><p>Used to push elements</p></td>
</tr>
<tr class="row-odd"><td><p>pop</p></td>
<td><p>Stream[T]</p></td>
<td><p>Used to pop elements</p></td>
</tr>
<tr class="row-even"><td><p>flush</p></td>
<td><p>Bool</p></td>
<td><p>Used to remove all elements inside the FIFO</p></td>
</tr>
<tr class="row-odd"><td><p>occupancy</p></td>
<td><p>UInt of log2Up(depth + 1) bits</p></td>
<td><p>Indicate the internal memory occupancy</p></td>
</tr>
</tbody>
</table>
</section>
<section id="streamfifocc">
<h5>StreamFifoCC<a class="headerlink" href="#streamfifocc" title="Permalink to this heading"></a></h5>
<p>You can instantiate the dual clock domain version of the fifo the following way :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">clockA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="o">???</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">clockB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="o">???</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">streamA</span><span class="p">,</span><span class="n">streamB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myFifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamFifoCC</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">dataType</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">depth</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">pushClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clockA</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">popClock</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">clockB</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">myFifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">streamA</span><span class="w"></span>
<span class="n">myFifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">streamB</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>parameter name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dataType</p></td>
<td><p>T</p></td>
<td><p>Payload data type</p></td>
</tr>
<tr class="row-odd"><td><p>depth</p></td>
<td><p>Int</p></td>
<td><p>Size of the memory used to store elements</p></td>
</tr>
<tr class="row-even"><td><p>pushClock</p></td>
<td><p>ClockDomain</p></td>
<td><p>Clock domain used by the push side</p></td>
</tr>
<tr class="row-odd"><td><p>popClock</p></td>
<td><p>ClockDomain</p></td>
<td><p>Clock domain used by the pop side</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 40%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>io name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>push</p></td>
<td><p>Stream[T]</p></td>
<td><p>Used to push elements</p></td>
</tr>
<tr class="row-odd"><td><p>pop</p></td>
<td><p>Stream[T]</p></td>
<td><p>Used to pop elements</p></td>
</tr>
<tr class="row-even"><td><p>pushOccupancy</p></td>
<td><p>UInt of log2Up(depth + 1) bits</p></td>
<td><p>Indicate the internal memory occupancy (from the push side perspective)</p></td>
</tr>
<tr class="row-odd"><td><p>popOccupancy</p></td>
<td><p>UInt of log2Up(depth + 1) bits</p></td>
<td><p>Indicate the internal memory occupancy  (from the pop side perspective)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="streamccbytoggle">
<h5>StreamCCByToggle<a class="headerlink" href="#streamccbytoggle" title="Permalink to this heading"></a></h5>
<div class="line-block">
<div class="line">Component that connects Streams across clock domains based on toggling signals.</div>
<div class="line">This way of implementing a cross clock domain bridge is characterized by a small area usage but also a low bandwidth.</div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">clockA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="o">???</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">clockB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="o">???</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">streamA</span><span class="p">,</span><span class="n">streamB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bridge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamCCByToggle</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">dataType</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">inputClock</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">clockA</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">outputClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clockB</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">bridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">input</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">streamA</span><span class="w"></span>
<span class="n">bridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">streamB</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>parameter name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dataType</p></td>
<td><p>T</p></td>
<td><p>Payload data type</p></td>
</tr>
<tr class="row-odd"><td><p>inputClock</p></td>
<td><p>ClockDomain</p></td>
<td><p>Clock domain used by the push side</p></td>
</tr>
<tr class="row-even"><td><p>outputClock</p></td>
<td><p>ClockDomain</p></td>
<td><p>Clock domain used by the pop side</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>io name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>input</p></td>
<td><p>Stream[T]</p></td>
<td><p>Used to push elements</p></td>
</tr>
<tr class="row-odd"><td><p>output</p></td>
<td><p>Stream[T]</p></td>
<td><p>Used to pop elements</p></td>
</tr>
</tbody>
</table>
<p>Alternatively you can also use a this shorter syntax which directly return you the cross clocked stream:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">clockA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="o">???</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">clockB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="o">???</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">streamA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">streamB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamCCByToggle</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">input</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">streamA</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">inputClock</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">clockA</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">outputClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clockB</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="streamwidthadapter">
<h5>StreamWidthAdapter<a class="headerlink" href="#streamwidthadapter" title="Permalink to this heading"></a></h5>
<p>This component adapts the width of the input stream to the output stream.
When the width of the <code class="docutils literal notranslate"><span class="pre">outStream</span></code> payload is greater than the <code class="docutils literal notranslate"><span class="pre">inStream</span></code>, by combining the payloads of several input transactions into one; conversely, if the payload width of the <code class="docutils literal notranslate"><span class="pre">outStream</span></code> is less than the <code class="docutils literal notranslate"><span class="pre">inStream</span></code>, one input transaction will be split into several output transactions.</p>
<p>In the best case, the width of the payload of the <code class="docutils literal notranslate"><span class="pre">inStream</span></code> should be an integer multiple of the <code class="docutils literal notranslate"><span class="pre">outStream</span></code> as shown below.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">outStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">adapter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamWidthAdapter</span><span class="p">(</span><span class="n">inStream</span><span class="p">,</span><span class="w"> </span><span class="n">outStream</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>As in the example above, the two <code class="docutils literal notranslate"><span class="pre">inStream</span></code> transactions will be merged into one <code class="docutils literal notranslate"><span class="pre">outStream</span></code> transaction, and the payload of the first input transaction will be placed on the lower bits of the output payload by default.</p>
<p>If the expected order of input transaction payload placement is different from the default setting, here is an example.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">outStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">adapter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamWidthAdapter</span><span class="p">(</span><span class="n">inStream</span><span class="p">,</span><span class="w"> </span><span class="n">outStream</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SlicesOrder</span><span class="p">.</span><span class="nc">HIGHER_FIRST</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>There is also a traditional parameter called <code class="docutils literal notranslate"><span class="pre">endianness</span></code>, which has the same effect as <code class="docutils literal notranslate"><span class="pre">ORDER</span></code>.
The value of <code class="docutils literal notranslate"><span class="pre">endianness</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">LOWER_FIRST</span></code> of <code class="docutils literal notranslate"><span class="pre">order</span></code> when it is <code class="docutils literal notranslate"><span class="pre">LITTLE</span></code>, and the same as <code class="docutils literal notranslate"><span class="pre">HIGHER_FIRST</span></code> when it is <code class="docutils literal notranslate"><span class="pre">BIG</span></code>.
The <code class="docutils literal notranslate"><span class="pre">padding</span></code> parameter is an optional boolean value to determine whether the adapter accepts non-integer multiples of the input and output payload width.</p>
</section>
<section id="streamarbiter">
<h5>StreamArbiter<a class="headerlink" href="#streamarbiter" title="Permalink to this heading"></a></h5>
<p>When you have multiple Streams and you want to arbitrate them to drive a single one, you can use the StreamArbiterFactory.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">streamA</span><span class="p">,</span><span class="w"> </span><span class="n">streamB</span><span class="p">,</span><span class="w"> </span><span class="n">streamC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">arbiteredABC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamArbiterFactory</span><span class="p">.</span><span class="n">roundRobin</span><span class="p">.</span><span class="n">onArgs</span><span class="p">(</span><span class="n">streamA</span><span class="p">,</span><span class="w"> </span><span class="n">streamB</span><span class="p">,</span><span class="w"> </span><span class="n">streamC</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">streamD</span><span class="p">,</span><span class="w"> </span><span class="n">streamE</span><span class="p">,</span><span class="w"> </span><span class="n">streamF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">arbiteredDEF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamArbiterFactory</span><span class="p">.</span><span class="n">lowerFirst</span><span class="p">.</span><span class="n">noLock</span><span class="p">.</span><span class="n">onArgs</span><span class="p">(</span><span class="n">streamD</span><span class="p">,</span><span class="w"> </span><span class="n">streamE</span><span class="p">,</span><span class="w"> </span><span class="n">streamF</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Arbitration functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>lowerFirst</p></td>
<td><p>Lower port have priority over higher port</p></td>
</tr>
<tr class="row-odd"><td><p>roundRobin</p></td>
<td><p>Fair round robin arbitration</p></td>
</tr>
<tr class="row-even"><td><p>sequentialOrder</p></td>
<td><div class="line-block">
<div class="line">Could be used to retrieve transaction in a sequential order</div>
<div class="line">First transaction should come from port zero, then from port one, …</div>
</div>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Lock functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>noLock</p></td>
<td><p>The port selection could change every cycle, even if the transaction on the selected port is not consumed.</p></td>
</tr>
<tr class="row-odd"><td><p>transactionLock</p></td>
<td><p>The port selection is locked until the transaction on the selected port is consumed.</p></td>
</tr>
<tr class="row-even"><td><p>fragmentLock</p></td>
<td><div class="line-block">
<div class="line">Could be used to arbitrate Stream[Flow[T]].</div>
<div class="line">In this mode, the port selection is locked until the selected port finish is burst (last=True).</div>
</div>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 67%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Generation functions</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>on(inputs : Seq[Stream[T]])</p></td>
<td><p>Stream[T]</p></td>
</tr>
<tr class="row-odd"><td><p>onArgs(inputs : Stream[T]*)</p></td>
<td><p>Stream[T]</p></td>
</tr>
</tbody>
</table>
</section>
<section id="streamjoin">
<h5>StreamJoin<a class="headerlink" href="#streamjoin" title="Permalink to this heading"></a></h5>
<p>This utility takes multiple input streams and waits until all of them fire <cite>valid</cite> before letting all of them through by providing <cite>ready</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cmdJoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Cmd</span><span class="p">())</span><span class="w"></span>
<span class="n">cmdJoin</span><span class="p">.</span><span class="n">arbitrationFrom</span><span class="p">(</span><span class="nc">StreamJoin</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">cmdABuffer</span><span class="p">,</span><span class="w"> </span><span class="n">cmdBBuffer</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="streamfork">
<h5>StreamFork<a class="headerlink" href="#streamfork" title="Permalink to this heading"></a></h5>
<p>A StreamFork will clone each incoming data to all its output streams. If synchronous is true,
all output streams will always fire together, which means that the stream will halt until all output streams are ready.
If synchronous is false, output streams may be ready one at a time,
at the cost of an additional flip-flop (1 bit per output). The input stream will block until
all output streams have processed each item regardlessly.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="n">outputStream1</span><span class="p">,</span><span class="w"> </span><span class="n">outputStream2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamFork2</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span><span class="w"> </span><span class="n">synchronous</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">outputStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamFork</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span><span class="n">portCount</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">synchronous</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="streammux">
<h5>StreamMux<a class="headerlink" href="#streammux" title="Permalink to this heading"></a></h5>
<p>A mux implementation for <code class="docutils literal notranslate"><span class="pre">Stream</span></code>.
It takes a <code class="docutils literal notranslate"><span class="pre">select</span></code> signal and streams in <code class="docutils literal notranslate"><span class="pre">inputs</span></code>, and returns a <code class="docutils literal notranslate"><span class="pre">Stream</span></code> which is connected to one of the input streams specified by <code class="docutils literal notranslate"><span class="pre">select</span></code>.
<code class="docutils literal notranslate"><span class="pre">StreamArbiter</span></code> is a facility works similar to this but is more powerful.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inputStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)),</span><span class="w"> </span><span class="n">portCount</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">inputStreams</span><span class="p">.</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">outputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamMux</span><span class="p">(</span><span class="n">select</span><span class="p">,</span><span class="w"> </span><span class="n">inputStreams</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">UInt</span></code> type of <code class="docutils literal notranslate"><span class="pre">select</span></code> signal could not be changed while output stream is stalled, or it might break the transaction on the fly.
Use <code class="docutils literal notranslate"><span class="pre">Stream</span></code> typed <code class="docutils literal notranslate"><span class="pre">select</span></code> can generate a stream interface which only fire and change the routing when it is safe.</p>
</div>
</section>
<section id="streamdemux">
<h5>StreamDemux<a class="headerlink" href="#streamdemux" title="Permalink to this heading"></a></h5>
<p>A demux implementation for <code class="docutils literal notranslate"><span class="pre">Stream</span></code>.
It takes a <code class="docutils literal notranslate"><span class="pre">input</span></code>, a <code class="docutils literal notranslate"><span class="pre">select</span></code> and a <code class="docutils literal notranslate"><span class="pre">portCount</span></code> and returns a <code class="docutils literal notranslate"><span class="pre">Vec(Stream)</span></code> where the output stream specified by <code class="docutils literal notranslate"><span class="pre">select</span></code> is connected to <code class="docutils literal notranslate"><span class="pre">input</span></code>, the other output streams are inactive.
For safe transaction, refer the notes above.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">portCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">outputStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamDemux</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="p">,</span><span class="w"> </span><span class="n">portCount</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="streamdispatchersequencial">
<h5>StreamDispatcherSequencial<a class="headerlink" href="#streamdispatchersequencial" title="Permalink to this heading"></a></h5>
<p>This util take its input stream and routes it to <code class="docutils literal notranslate"><span class="pre">outputCount</span></code> stream in a sequential order.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">dispatchedStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamDispatcherSequencial</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputStream</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">outputCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="streamtransactionextender">
<h5>StreamTransactionExtender<a class="headerlink" href="#streamtransactionextender" title="Permalink to this heading"></a></h5>
<p>This utility will take one input transfer and generate several output transfers, it provides the facility to repeat the payload value <code class="docutils literal notranslate"><span class="pre">count+1</span></code> times into output transfers.
The <code class="docutils literal notranslate"><span class="pre">count</span></code> is captured and registered each time inputStream fires for an individual payload.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">outputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">extender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StreamTransactionExtender</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span><span class="w"> </span><span class="n">outputStream</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// id, is the 0-based index of total output transfers so far in the current input transaction.</span>
<span class="w">   </span><span class="c1">// last, is the last transfer indication, same as the last signal for extender.</span>
<span class="w">   </span><span class="c1">// the returned payload is allowed to be modified only based on id and last signals, other</span>
<span class="w">   </span><span class="c1">// translation should be done outside of this.</span>
<span class="w">    </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">payload</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">extender</span></code> provides several status signals, such as <code class="docutils literal notranslate"><span class="pre">working</span></code>, <code class="docutils literal notranslate"><span class="pre">last</span></code>, <code class="docutils literal notranslate"><span class="pre">done</span></code> where
<code class="docutils literal notranslate"><span class="pre">working</span></code> means there is one input transfer accepted and in-progress, <code class="docutils literal notranslate"><span class="pre">last</span></code> indicates the last
output transfer is prepared and waiting to complete, <code class="docutils literal notranslate"><span class="pre">done</span></code> become valid represents the last
output transfer is firing and making the current input transaction process complete and ready to
start another transaction.</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{ "signal": [
  { "name": "clk",         "wave": "p........." },
  { "name": "inputStream",        "wave": "x3x.....4x", "data": ["T1", "T2"] },
  { "name": "count",        "wave": "x3x.....4x", "data": ["2", "4"] },
  { "name": "outputStream",       "wave": "x..2x2x.2x", "data": ["D1", "D2", "D3"] },
  { "name": "working",      "wave": "0.1......."},
  { "name": "done",      "wave": "0.......10"},
  { "name": "first",      "wave": "0.1.0....."},
  { "name": "last",      "wave": "0.....1..0"},
]}
</script>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If only count for output stream is required then use <code class="docutils literal notranslate"><span class="pre">StreamTransactionCounter</span></code> instead.</p>
</div>
</section>
</section>
<section id="simulation-support">
<h4>Simulation support<a class="headerlink" href="#simulation-support" title="Permalink to this heading"></a></h4>
<p>For simulation master and slave implementations are available:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>StreamMonitor</p></td>
<td><p>Used for both master and slave sides, calls function with payload if Stream fires.</p></td>
</tr>
<tr class="row-odd"><td><p>StreamDriver</p></td>
<td><p>Testbench master side, drives values by calling function to apply value (if available). Function must return if value was available. Supports random delays.</p></td>
</tr>
<tr class="row-even"><td><p>StreamReadyRandomizer</p></td>
<td><p>Randomizes <code class="docutils literal notranslate"><span class="pre">ready</span></code> for reception of data, testbench is the slave side.</p></td>
</tr>
<tr class="row-odd"><td><p>ScoreboardInOrder</p></td>
<td><p>Often used to compare reference/dut data</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">sim</span><span class="p">.{</span><span class="nc">StreamMonitor</span><span class="p">,</span><span class="w"> </span><span class="nc">StreamDriver</span><span class="p">,</span><span class="w"> </span><span class="nc">StreamReadyRandomizer</span><span class="p">,</span><span class="w"> </span><span class="nc">ScoreboardInOrder</span><span class="p">}</span>

<span class="k">object</span><span class="w"> </span><span class="nc">Example</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="nc">StreamFifo</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">doSim</span><span class="p">(</span><span class="s">&quot;simple test&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">scoreboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ScoreboardInOrder</span><span class="p">[</span><span class="nc">Int</span><span class="p">]()</span><span class="w"></span>

<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">flush</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>

<span class="w">    </span><span class="c1">// drive random data and add pushed data to scoreboard</span>
<span class="w">    </span><span class="nc">StreamDriver</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">payload</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nc">StreamMonitor</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">scoreboard</span><span class="p">.</span><span class="n">pushRef</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// randmize ready on the output and add popped data to scoreboard</span>
<span class="w">    </span><span class="nc">StreamReadyRandomizer</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">StreamMonitor</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">scoreboard</span><span class="p">.</span><span class="n">pushDut</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitActiveEdgeWhere</span><span class="p">(</span><span class="n">scoreboard</span><span class="p">.</span><span class="n">matches</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/flow"></span><section id="flow">
<h3>Flow<a class="headerlink" href="#flow" title="Permalink to this heading"></a></h3>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h4>
<p>The Flow interface is a simple valid/payload protocol which means the slave can’t halt the bus.
It could be used to represent data coming from an UART controller, requests to write an on-chip memory, etc.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 71%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signal</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Driver</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Don’t care when</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>valid</p></td>
<td><p>Bool</p></td>
<td><p>Master</p></td>
<td><p>When high =&gt; payload present on the interface</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>payload</p></td>
<td><p>T</p></td>
<td><p>Master</p></td>
<td><p>Content of the transaction</p></td>
<td><p>valid is low</p></td>
</tr>
</tbody>
</table>
</section>
<section id="functions">
<h4>Functions<a class="headerlink" href="#functions" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 77%" />
<col style="width: 8%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Latency</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Flow(type : Data)</p></td>
<td><p>Create a Flow of a given type</p></td>
<td><p>Flow[T]</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>master/slave Flow(type : Data)</p></td>
<td><div class="line-block">
<div class="line">Create a Flow of a given type</div>
<div class="line">Initialized with corresponding in/out setup</div>
</div>
</td>
<td><p>Flow[T]</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.m2sPipe()</p></td>
<td><div class="line-block">
<div class="line">Return a Flow driven by x</div>
<div class="line">through a register stage that cut valid/payload paths</div>
</div>
</td>
<td><p>Flow[T]</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>x.stage()</p></td>
<td><p>Equivalent to x.m2sPipe()</p></td>
<td><p>Flow[T]</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">x &lt;&lt; y</div>
<div class="line">y &gt;&gt; x</div>
</div>
</td>
<td><p>Connect y to x</p></td>
<td></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">x &lt;-&lt; y</div>
<div class="line">y &gt;-&gt; x</div>
</div>
</td>
<td><p>Connect y to x through a m2sPipe</p></td>
<td></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>x.throwWhen(cond : Bool)</p></td>
<td><div class="line-block">
<div class="line">Return a Flow connected to x</div>
<div class="line">When cond is high, transaction are dropped</div>
</div>
</td>
<td><p>Flow[T]</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>x.toReg()</p></td>
<td><p>Return a register which is loaded with <code class="docutils literal notranslate"><span class="pre">payload</span></code> when valid is high</p></td>
<td><p>T</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.setIdle()</p></td>
<td><p>Set the Flow in an Idle state: <code class="docutils literal notranslate"><span class="pre">valid</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code> and don’t care about <code class="docutils literal notranslate"><span class="pre">payload</span></code>.</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>x.push(newPayload: T)</p></td>
<td><p>Assign a new valid payload to the Flow. <code class="docutils literal notranslate"><span class="pre">valid</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="code-example">
<h4>Code example<a class="headerlink" href="#code-example" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FlowExample</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">answer</span><span class="p">.</span><span class="n">setIdle</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">idle</span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">storage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">          </span><span class="n">goto</span><span class="p">(</span><span class="n">sendEcho</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sendEcho</span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">answer</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">goto</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// This StateMachine behaves equivalently to</span>
<span class="w">  </span><span class="c1">// io.answer &lt;-&lt; io.request</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="simulation-support">
<h4>Simulation Support<a class="headerlink" href="#simulation-support" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FlowMonitor</p></td>
<td><p>Used for both master and slave sides, calls function with payload if Flow transmits data.</p></td>
</tr>
<tr class="row-odd"><td><p>FlowDriver</p></td>
<td><p>Testbench master side, drives values by calling function to apply value (if available). Function must return if value was available. Supports random delays.</p></td>
</tr>
<tr class="row-even"><td><p>ScoreboardInOrder</p></td>
<td><p>Often used to compare reference/dut data</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="nn">spinaldoc</span><span class="p">.</span><span class="nn">libraries</span><span class="p">.</span><span class="n">flow</span>

<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">sim</span><span class="p">.{</span><span class="nc">FlowDriver</span><span class="p">,</span><span class="w"> </span><span class="nc">FlowMonitor</span><span class="p">,</span><span class="w"> </span><span class="nc">ScoreboardInOrder</span><span class="p">}</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">language</span><span class="p">.</span><span class="n">postfixOps</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SomeDUT</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="o">&lt;-&lt;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">input</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Example</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="nc">SomeDUT</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">doSim</span><span class="p">(</span><span class="s">&quot;simple test&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">scoreboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ScoreboardInOrder</span><span class="p">[</span><span class="nc">Int</span><span class="p">]()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// drive random data at random intervals, and add inputted data to scoreboard</span>
<span class="w">    </span><span class="nc">FlowDriver</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">payload</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nc">FlowMonitor</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">scoreboard</span><span class="p">.</span><span class="n">pushRef</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// add all data coming out of DUT to scoreboard</span>
<span class="w">    </span><span class="nc">FlowMonitor</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">scoreboard</span><span class="p">.</span><span class="n">pushDut</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitActiveEdgeWhere</span><span class="p">(</span><span class="n">scoreboard</span><span class="p">.</span><span class="n">matches</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/fragment"></span><section id="fragment">
<h3>Fragment<a class="headerlink" href="#fragment" title="Permalink to this heading"></a></h3>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Fragment</span></code> bundle is the concept of transmitting a “big” thing by using multiple “small” fragments. For examples :</p>
<ul class="simple">
<li><p>A picture transmitted with width*height transaction on a <code class="docutils literal notranslate"><span class="pre">Stream[Fragment[Pixel]]</span></code></p></li>
<li><p>An UART packet received from an controller without flow control could be transmitted on a <code class="docutils literal notranslate"><span class="pre">Flow[Fragment[Bits]]</span></code></p></li>
<li><p>An AXI read burst could be carried by an <code class="docutils literal notranslate"><span class="pre">Stream[Fragment[AxiReadResponse]]</span></code></p></li>
</ul>
<p>Signals defined by the <code class="docutils literal notranslate"><span class="pre">Fragment</span></code> bundle are :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signal</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Driver</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fragment</p></td>
<td><p>T</p></td>
<td><p>Master</p></td>
<td><p>The “payload” of the current transaction</p></td>
</tr>
<tr class="row-odd"><td><p>last</p></td>
<td><p>Bool</p></td>
<td><p>Master</p></td>
<td><p>High when the fragment is the last of the current packet</p></td>
</tr>
</tbody>
</table>
<p>As you can see with this specification and precedent example, the <code class="docutils literal notranslate"><span class="pre">Fragment</span></code> concept doesn’t specify how transaction are transmitted (You can use Stream,Flow or any other communication protocol). It only add enough information (<code class="docutils literal notranslate"><span class="pre">last</span></code>) to know if the current transaction is the first one, the last one or one in the middle of a given packet.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The protocol didn’t carry a 'first' bit because it can be generated at any place by doing 'RegNextWhen(bus.last, bus.fire) init(True)'</p>
</div>
</section>
<section id="functions">
<h4>Functions<a class="headerlink" href="#functions" title="Permalink to this heading"></a></h4>
<p>For <code class="docutils literal notranslate"><span class="pre">Stream[Fragment[T]]</span></code> and <code class="docutils literal notranslate"><span class="pre">Flow[Fragment[T]]</span></code>, following function are presents :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 91%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.first</p></td>
<td><p>Bool</p></td>
<td><p>Return True when the next or the current transaction is/would be the first of a packet</p></td>
</tr>
<tr class="row-odd"><td><p>x.tail</p></td>
<td><p>Bool</p></td>
<td><p>Return True when the next or the current transaction is/would be not the first of a packet</p></td>
</tr>
<tr class="row-even"><td><p>x.isFirst</p></td>
<td><p>Bool</p></td>
<td><p>Return True when an transaction is present and is the first of a packet</p></td>
</tr>
<tr class="row-odd"><td><p>x.isTail</p></td>
<td><p>Bool</p></td>
<td><p>Return True when an transaction is present and is the not the first/last of a packet</p></td>
</tr>
<tr class="row-even"><td><p>x.isLast</p></td>
<td><p>Bool</p></td>
<td><p>Return True when an transaction is present and is the last of a packet</p></td>
</tr>
</tbody>
</table>
<p>For <code class="docutils literal notranslate"><span class="pre">Stream[Fragment[T]]</span></code>, following function are also accessible :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.insertHeader(header : T)</p></td>
<td><p>Stream[Fragment[T]]</p></td>
<td><p>Add the <code class="docutils literal notranslate"><span class="pre">header</span></code> to each packet on <code class="docutils literal notranslate"><span class="pre">x</span></code> and return the resulting bus</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-SpinalHDL/Libraries/fsm"></span><section id="state-machine">
<span id="id1"></span><h3>State machine<a class="headerlink" href="#state-machine" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>In SpinalHDL you can define your state machine like in VHDL/Verilog, by using enumerations and switch/case statements. But in SpinalHDL you can also use a dedicated syntax.</p>
<p>The state machine below is implemented in the following examples:</p>
<a class="reference internal image-reference" href="_images/fsm_simple.svg"><img alt="_images/fsm_simple.svg" class="align-center" src="_images/fsm_simple.svg" width="300" /></a>
<p>Style A:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">fsm</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateB</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateB</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">onEntry</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">goto</span><span class="p">(</span><span class="n">stateC</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">onExit</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateC</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateA</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Style B:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">fsm</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>

<span class="w">    </span><span class="n">stateA</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateB</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="n">stateB</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">onEntry</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">goto</span><span class="p">(</span><span class="n">stateC</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">onExit</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">stateC</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateA</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="statemachine">
<h4>StateMachine<a class="headerlink" href="#statemachine" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">StateMachine</span></code> is the base class. It manages the logic of the FSM.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myFsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Definition of states</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">StateMachine</span></code> also provides some accessors:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">isActive(state)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Bool</span></code></p></td>
<td><p>Returns <code class="docutils literal notranslate"><span class="pre">True</span></code> when the state machine is in the given state</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">isEntering(state)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Bool</span></code></p></td>
<td><p>Returns <code class="docutils literal notranslate"><span class="pre">True</span></code> when the state machine is entering the given state</p></td>
</tr>
</tbody>
</table>
<section id="entry-point">
<h5>Entry point<a class="headerlink" href="#entry-point" title="Permalink to this heading"></a></h5>
<p>A state can be defined as the entry point of the state machine by extending the EntryPoint trait:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"></span>
</pre></div>
</div>
<p>Or by using <code class="docutils literal notranslate"><span class="pre">setEntry(state)</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>
<span class="n">setEntry</span><span class="p">(</span><span class="n">stateA</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="transitions">
<h5>Transitions<a class="headerlink" href="#transitions" title="Permalink to this heading"></a></h5>
<ul class="simple">
<li><p>Transitions are represented by <code class="docutils literal notranslate"><span class="pre">goto(nextState)</span></code>, which schedules the state machine to be in <code class="docutils literal notranslate"><span class="pre">nextState</span></code> the next cycle.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exit()</span></code> schedules the state machine to be in the boot state the next cycle (or, in <code class="docutils literal notranslate"><span class="pre">StateFsm</span></code>, to exit the current nested state machine).</p></li>
</ul>
<p>These two functions can be used inside state definitions (see below) or using <code class="docutils literal notranslate"><span class="pre">always</span> <span class="pre">{</span> <span class="pre">yourStatements</span> <span class="pre">}</span></code>,
which always applies <code class="docutils literal notranslate"><span class="pre">yourStatements</span></code>, with a priority over states.</p>
</section>
<section id="state-encoding">
<h5>State encoding<a class="headerlink" href="#state-encoding" title="Permalink to this heading"></a></h5>
<p>By default the FSM state vector will be encoded using the native encoding of the language/tools the RTL is generated for (Verilog or VHDL).
This default can be overridden by using the <code class="docutils literal notranslate"><span class="pre">setEncoding(...)</span></code> method which either takes a <code class="docutils literal notranslate"><span class="pre">SpinalEnumEncoding</span></code> or
varargs of type <code class="docutils literal notranslate"><span class="pre">(State,</span> <span class="pre">BigInt)</span></code> for a custom encoding.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Using a <code class="docutils literal notranslate"><span class="pre">SpinalEnumEncoding</span></code></span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">setEncoding</span><span class="p">(</span><span class="n">binaryOneHot</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Using a custom encoding</span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="n">setEncoding</span><span class="p">((</span><span class="n">stateA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x23</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">stateB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x22</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When using the <code class="docutils literal notranslate"><span class="pre">graySequential</span></code> enum encoding, no check is done to verify that the FSM transitions only produce
single-bit changes in the state vector. The encoding is done according to the order of state definitions and the
designer must ensure that only valid transitions are done if needed.</p>
</div>
</section>
</section>
<section id="states">
<h4>States<a class="headerlink" href="#states" title="Permalink to this heading"></a></h4>
<p>Multiple kinds of states can be used:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">State</span></code> (the base one)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">StateDelay</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">StateFsm</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">StateParallelFsm</span></code></p></li>
</ul>
<p>Each of them provides the following functions to define the logic associated to them:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 91%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="p">.</span><span class="n">onEntry</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">yourStatements</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">yourStatements</span></code> is applied when the state machine is not in <code class="docutils literal notranslate"><span class="pre">state</span></code> and will be in <code class="docutils literal notranslate"><span class="pre">state</span></code> the next cycle</p></td>
</tr>
<tr class="row-odd"><td><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="p">.</span><span class="n">onExit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">yourStatements</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">yourStatements</span></code> is applied when the state machine is in <code class="docutils literal notranslate"><span class="pre">state</span></code> and will be in another state the next cycle</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">yourStatements</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">yourStatements</span></code> is applied when the state machine is in <code class="docutils literal notranslate"><span class="pre">state</span></code></p></td>
</tr>
<tr class="row-odd"><td><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="p">.</span><span class="n">whenIsNext</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">yourStatements</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">yourStatements</span></code> is executed when the state machine will be in <code class="docutils literal notranslate"><span class="pre">state</span></code> the next cycle (even if it is already in it)</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">state.</span></code> is implicit in a <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">State</span></code> block:</p>
<a class="reference internal image-reference" href="_images/fsm_stateb.svg"><img alt="_images/fsm_stateb.svg" class="align-center" src="_images/fsm_stateb.svg" width="300" /></a>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateB</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">onEntry</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">goto</span><span class="p">(</span><span class="n">stateC</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">onExit</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<section id="statedelay">
<h5>StateDelay<a class="headerlink" href="#statedelay" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">StateDelay</span></code> allows you to create a state which waits for a fixed number of cycles before executing statements in <code class="docutils literal notranslate"><span class="pre">whenCompleted</span> <span class="pre">{...}</span></code>. The preferred way to use it is:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateDelay</span><span class="p">(</span><span class="n">cyclesCount</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">whenCompleted</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">goto</span><span class="p">(</span><span class="n">stateH</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It can also be written in one line:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateDelay</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">whenCompleted</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateH</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="statefsm">
<h5>StateFsm<a class="headerlink" href="#statefsm" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">StateFsm</span></code> allows you to describe a state containing a nested state machine. When the nested state machine is done (exited), statements in <code class="docutils literal notranslate"><span class="pre">whenCompleted</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code> are executed.</p>
<p>There is an example of StateFsm definition :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// internalFsm is a function defined below</span>
<span class="kd">val</span><span class="w"> </span><span class="n">stateC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateFsm</span><span class="p">(</span><span class="n">fsm</span><span class="o">=</span><span class="n">internalFsm</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">whenCompleted</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">goto</span><span class="p">(</span><span class="n">stateD</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">internalFsm</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">goto</span><span class="p">(</span><span class="n">stateB</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateB</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">onEntry</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">exit</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In the example above, <code class="docutils literal notranslate"><span class="pre">exit()</span></code> makes the state machine jump to the boot state (a internal hidden state). This notifies <code class="docutils literal notranslate"><span class="pre">StateFsm</span></code> about the completion of the inner state machine.</p>
</section>
<section id="stateparallelfsm">
<h5>StateParallelFsm<a class="headerlink" href="#stateparallelfsm" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">StateParallelFsm</span></code> allows you to handle multiple nested state machines. When all nested state machine are done, statements in <code class="docutils literal notranslate"><span class="pre">whenCompleted</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code> are executed.</p>
<p>Example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateParallelFsm</span><span class="w"> </span><span class="p">(</span><span class="n">internalFsmA</span><span class="p">(),</span><span class="w"> </span><span class="n">internalFsmB</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">whenCompleted</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">goto</span><span class="p">(</span><span class="n">stateE</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="notes-about-the-entry-state">
<h5>Notes about the entry state<a class="headerlink" href="#notes-about-the-entry-state" title="Permalink to this heading"></a></h5>
<p>The way the entry state has been defined above makes it so that between the reset and the first clock sampling, the state machine is in a boot state. It is only after the first clock sampling that the defined entry state becomes active. This allows to properly enter the entry state (applying statements in <code class="docutils literal notranslate"><span class="pre">onEntry</span></code>), and allows nested state machines.</p>
<p>While it is useful, it is also possible to bypass that feature and directly having a state machine booting into a user state.</p>
<p>To do so, use <cite>makeInstantEntry()</cite> instead of defining a <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">State</span></code>. This function returns the boot state, active directly after reset.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">onEntry</span></code> of that state will only be called when it transitions from another state to this state and not during boot.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>During simulation, the boot state is always named <code class="docutils literal notranslate"><span class="pre">BOOT</span></code>.</p>
</div>
<p>Example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// State sequance: IDLE, STATE_A, STATE_B, ...</span>
<span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// IDLE is named BOOT in simulation</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">IDLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeInstantEntry</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">STATE_A</span><span class="p">,</span><span class="w"> </span><span class="nc">STATE_B</span><span class="p">,</span><span class="w"> </span><span class="nc">STATE_C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>

<span class="w">  </span><span class="nc">IDLE</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_A</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nc">STATE_A</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_B</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nc">STATE_B</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_C</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nc">STATE_C</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_B</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//  State sequence : BOOT, IDLE, STATE_A, STATE_B, ...</span>
<span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">,</span><span class="w"> </span><span class="nc">STATE_A</span><span class="p">,</span><span class="w"> </span><span class="nc">STATE_B</span><span class="p">,</span><span class="w"> </span><span class="nc">STATE_C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>
<span class="w">  </span><span class="n">setEntry</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="nc">IDLE</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_A</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nc">STATE_A</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_B</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nc">STATE_B</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_C</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nc">STATE_C</span><span class="p">.</span><span class="n">whenIsActive</span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="nc">STATE_B</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="notes-about-using-state-value">
<h5>Notes about using state value<a class="headerlink" href="#notes-about-using-state-value" title="Permalink to this heading"></a></h5>
<p>In cases that users want to retrieve the state value for purpose, where state value could be accessed by <cite>stateReg</cite>.
However, the <cite>stateReg</cite> is not initialized during elaboration of state machine, so any access of <cite>stateReg</cite> directly could cause error.
Use the <cite>postBuild</cite> method as below can solve this problem.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//  After or inside the fsm&#39;s definition.</span>
<span class="n">fsm</span><span class="p">.</span><span class="n">postBuild</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">stateReg</span><span class="p">.</span><span class="n">asBits</span><span class="w"> </span><span class="c1">//io.status is the signal user want to assigned to.</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-SpinalHDL/Libraries/vexriscv"></span><section id="vexriscv-rv32im-cpu">
<h3>VexRiscv (RV32IM CPU)<a class="headerlink" href="#vexriscv-rv32im-cpu" title="Permalink to this heading"></a></h3>
<p>VexRiscv is an fpga friendly RISC-V ISA CPU implementation with following features :</p>
<ul class="simple">
<li><p>RV32IM instruction set</p></li>
<li><p>Pipelined on 5 stages (Fetch, Decode, Execute, Memory, WriteBack)</p></li>
<li><p>1.44 DMIPS/Mhz when all features are enabled</p></li>
<li><p>Optimized for FPGA</p></li>
<li><p>Optional MUL/DIV extension</p></li>
<li><p>Optional instruction and data caches</p></li>
<li><p>Optional MMU</p></li>
<li><p>Optional debug extension allowing eclipse debugging via an GDB &gt;&gt; openOCD &gt;&gt; JTAG connection</p></li>
<li><p>Optional interrupts and exception handling with the Machine and the User mode from the riscv-privileged-v1.9.1 spec.</p></li>
<li><p>Two implementation of shift instructions, Single cycle / shiftNumber cycles</p></li>
<li><p>Each stage could have bypass or interlock hazard logic</p></li>
<li><p>FreeRTOS port <a class="reference external" href="https://github.com/Dolu1990/FreeRTOS-RISCV">https://github.com/Dolu1990/FreeRTOS-RISCV</a></p></li>
</ul>
<p>Much more information there : <a class="reference external" href="https://github.com/SpinalHDL/VexRiscv">https://github.com/SpinalHDL/VexRiscv</a></p>
</section>
<span id="document-SpinalHDL/Libraries/bus_slave_factory"></span><section id="bus-slave-factory">
<span id="id1"></span><h3>Bus Slave Factory<a class="headerlink" href="#bus-slave-factory" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>In many situation it’s needed to implement a bus register bank. The <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> is a tool that provide an abstract and smooth way to define them.</p>
<p>To see capabilities of the tool, an simple example use the Apb3SlaveFactory variation to implement an <a class="reference internal" href="index.html#memory-mapped-uart"><span class="std std-ref">memory mapped UART</span></a>. There is also another example with an <a class="reference internal" href="index.html#timer"><span class="std std-ref">Timer</span></a> which contain a memory mapping function.</p>
<p>You can find more documentation about the internal implementation of the <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> tool <a class="reference internal" href="index.html#bus-slave-factory-implementation"><span class="std std-ref">there</span></a></p>
</section>
<section id="functionality">
<h4>Functionality<a class="headerlink" href="#functionality" title="Permalink to this heading"></a></h4>
<div class="line-block">
<div class="line">There are many implementations of the <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> tool : AHB3-lite, APB3, APB4, AvalonMM, AXI-lite 3, AXI4, BMB, Wishbone, Tilelink, BRAM bus and PipelinedMemoryBus.</div>
<div class="line">Each implementation of that tool take as an argument one instance of the corresponding bus and then offers the following functions to map your hardware into the memory mapping :</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 8%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>busDataWidth</p></td>
<td><p>Int</p></td>
<td><p>Return the data width of the bus</p></td>
</tr>
<tr class="row-odd"><td><p>read(that,address,bitOffset)</p></td>
<td></td>
<td><p>When the bus read the <code class="docutils literal notranslate"><span class="pre">address</span></code>, fill the response with <code class="docutils literal notranslate"><span class="pre">that</span></code> at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code></p></td>
</tr>
<tr class="row-even"><td><p>write(that,address,bitOffset)</p></td>
<td></td>
<td><p>When the bus write the <code class="docutils literal notranslate"><span class="pre">address</span></code>, assign <code class="docutils literal notranslate"><span class="pre">that</span></code> with bus’s data from <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>onWrite(address)(doThat)</p></td>
<td></td>
<td><p>Call <code class="docutils literal notranslate"><span class="pre">doThat</span></code> when a write transaction occur on <code class="docutils literal notranslate"><span class="pre">address</span></code></p></td>
</tr>
<tr class="row-even"><td><p>onRead(address)(doThat)</p></td>
<td></td>
<td><p>Call <code class="docutils literal notranslate"><span class="pre">doThat</span></code> when a read transaction occur on <code class="docutils literal notranslate"><span class="pre">address</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>nonStopWrite(that,bitOffset)</p></td>
<td></td>
<td><p>Permanently assign <code class="docutils literal notranslate"><span class="pre">that</span></code> by the bus write data from <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code></p></td>
</tr>
<tr class="row-even"><td><p>readAndWrite(that,address,bitOffset)</p></td>
<td></td>
<td><p>Make <code class="docutils literal notranslate"><span class="pre">that</span></code> readable and writable at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><p>readMultiWord(that,address)</p></td>
<td></td>
<td><div class="line-block">
<div class="line">Create the memory mapping to read <code class="docutils literal notranslate"><span class="pre">that</span></code> from ‘address’.</div>
<div class="line">If <code class="docutils literal notranslate"><span class="pre">that</span></code> is bigger than one word it extends the register on followings addresses</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>writeMultiWord(that,address)</p></td>
<td></td>
<td><div class="line-block">
<div class="line">Create the memory mapping to write <code class="docutils literal notranslate"><span class="pre">that</span></code> at ‘address’.</div>
<div class="line">If <code class="docutils literal notranslate"><span class="pre">that</span></code> is bigger than one word it extends the register on followings addresses</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>createWriteOnly(dataType,address,bitOffset)</p></td>
<td><p>T</p></td>
<td><p>Create a write only register of type <code class="docutils literal notranslate"><span class="pre">dataType</span></code> at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-even"><td><p>createReadWrite(dataType,address,bitOffset)</p></td>
<td><p>T</p></td>
<td><p>Create a read write register of type <code class="docutils literal notranslate"><span class="pre">dataType</span></code> at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><p>createAndDriveFlow(dataType,address,bitOffset)</p></td>
<td><p>Flow[T]</p></td>
<td><p>Create a writable Flow register of type <code class="docutils literal notranslate"><span class="pre">dataType</span></code> at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-even"><td><p>drive(that,address,bitOffset)</p></td>
<td></td>
<td><p>Drive <code class="docutils literal notranslate"><span class="pre">that</span></code> with a register writable at <code class="docutils literal notranslate"><span class="pre">address</span></code> placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><p>driveAndRead(that,address,bitOffset)</p></td>
<td></td>
<td><p>Drive <code class="docutils literal notranslate"><span class="pre">that</span></code> with a register writable and readable at <code class="docutils literal notranslate"><span class="pre">address</span></code> placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-even"><td><p>driveFlow(that,address,bitOffset)</p></td>
<td></td>
<td><p>Emit on <code class="docutils literal notranslate"><span class="pre">that</span></code> a transaction when a write happen at <code class="docutils literal notranslate"><span class="pre">address</span></code> by using data placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">readStreamNonBlocking(that,</div>
<div class="line-block">
<div class="line">address,</div>
<div class="line">validBitOffset,</div>
<div class="line">payloadBitOffset)</div>
</div>
</div>
</td>
<td></td>
<td><div class="line-block">
<div class="line">Read <code class="docutils literal notranslate"><span class="pre">that</span></code> and consume the transaction when a read happen at <code class="docutils literal notranslate"><span class="pre">address</span></code>.</div>
<div class="line">valid &lt;= validBitOffset bit</div>
<div class="line">payload &lt;= payloadBitOffset+widthOf(payload) downto <code class="docutils literal notranslate"><span class="pre">payloadBitOffset</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">doBitsAccumulationAndClearOnRead(that,</div>
<div class="line-block">
<div class="line">address,</div>
<div class="line">bitOffset)</div>
</div>
</div>
</td>
<td></td>
<td><div class="line-block">
<div class="line">Instantiate an internal register which at each cycle do :</div>
<div class="line">reg := reg | that</div>
<div class="line">Then when a read occur, the register is cleared. This register is readable at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-SpinalHDL/Libraries/fiber"></span><section id="fiber-framework">
<span id="fiber"></span><h3>Fiber framework<a class="headerlink" href="#fiber-framework" title="Permalink to this heading"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This framework is not expected to be used for general RTL generation and targets large system
design management and code generation. It is currently used as toplevel integration tool in
SaxonSoC and VexiiRiscv.</p>
</div>
<p>Currently in development.</p>
<p>Fiber is a framework to run the hardware elaboration in an out of order manner, a bit similarly to
Makefile, where you can define rules and dependencies which will then be solved when you run a make
command. It is very similar to the Scala Future feature.</p>
<p>Using this framework can complicate simple things but provide some strong features for complex cases :</p>
<ul class="simple">
<li><p>You can define things before even knowing all their requirements, for example :
instantiating an interruption controller, before knowing how many interrupt signal lines you need</p></li>
<li><p>Abstract/lazy/partial SoC architecture definition allowing the creation of SoC template for
further specializations</p></li>
<li><p>Automatic requirement negotiation between multiple agents in a decentralized way, for example :
between masters and slaves of a memory bus</p></li>
</ul>
<p>The framework is mainly composed of :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Handle[T]</span></code>, which can be used later to store a value of type <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">handle.load</span></code>, which allow to set the value of a handle (will reschedule all tasks waiting on it)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">handle.get</span></code>, which return the value of the given handle. Will block the task execution if that
handle isn’t loaded yet</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Handle{</span> <span class="pre">/*code*/</span> <span class="pre">}</span></code>, which fork a new task which will execute the given code. The result of
that code will be loaded into the Handle</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">soon(handle)</span></code>, which allows the current task to announce that it will load <code class="docutils literal notranslate"><span class="pre">handle</span></code> with
a value (used for scheduling)</p></li>
</ul>
<section id="simple-dummy-example">
<h4>Simple dummy example<a class="headerlink" href="#simple-dummy-example" title="Permalink to this heading"></a></h4>
<p>Here is a simple example :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">fiber</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// Create two empty Handles</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Handle</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"></span>

<span class="c1">// Create a Handle which will be loaded asynchronously by the given body result</span>
<span class="kd">val</span><span class="w"> </span><span class="n">calculator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Handle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="c1">// .get will block until they are loaded</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Same as above</span>
<span class="kd">val</span><span class="w"> </span><span class="n">printer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Handle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">s&quot;a + b = </span><span class="si">${</span><span class="n">calculator</span><span class="p">.</span><span class="n">get</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// .get is blocking until the calculator body is done</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Synchronously load a and b, this will unblock a.get and b.get</span>
<span class="n">a</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="n">b</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Its runtime will be :</p>
<ul class="simple">
<li><p>create a and b</p></li>
<li><p>fork the calculator task, but is blocked when executing a.get</p></li>
<li><p>fork the printer task, but is blocked when executing calculator.get</p></li>
<li><p>load a and b, which reschedule the calculator task (as it was waiting on a)</p></li>
<li><p>calculator do its a + b sum, and load its Handle with that result, which reschedule the printer task</p></li>
<li><p>printer task print its stuff</p></li>
<li><p>everything done</p></li>
</ul>
<p>So, the main point of that example is to show that we kind of overcome the sequential execution of
things, as a and b are loaded after the definition of the calculator.</p>
</section>
<section id="handle-t">
<h4>Handle[T]<a class="headerlink" href="#handle-t" title="Permalink to this heading"></a></h4>
<p>Handle[T] are a bit like scala’s Future[T], they allow to talk about something before it is even
existing, and wait on it.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Handle</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"></span>

<span class="c1">// x.produce can be used to generate a new Handle when x is loaded</span>
<span class="kd">val</span><span class="w"> </span><span class="n">xPlus2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Handle</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">produce</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>

<span class="c1">// x.derivate is as x.produce, but also provide the x.get as argument of the lambda function</span>
<span class="kd">val</span><span class="w"> </span><span class="n">xPlus3</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Handle</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">derivate</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>

<span class="n">x</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// x will now contain the value 3</span>
</pre></div>
</div>
<section id="soon-handle">
<h5>soon(handle)<a class="headerlink" href="#soon-handle" title="Permalink to this heading"></a></h5>
<p>In order to maintain a proper graph of dependencies between tasks and Handle, a task can specify
in advance that it will load a given handle. This is very useful in case of a generation
starvation/deadlock for SpinalHDL to report accurately where is the issue.</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Libraries/binarySystem"></span><section id="binarysystem">
<h3>BinarySystem<a class="headerlink" href="#binarysystem" title="Permalink to this heading"></a></h3>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h4>
<div class="line-block">
<div class="line">Here things have nothing to do with HDL, but they are very common in digital systems, In particular, the algorithm reference model is widely used. In addition, it is also used in build testbench.</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 31%" />
<col style="width: 62%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>String</strong>.asHex</p></td>
<td><p>HexString to BigInt == BigInt(string, 16)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>String</strong>.asDec</p></td>
<td><p>Decimal String to BigInt == BigInt(string, 10)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-even"><td><p><strong>String</strong>.asOct</p></td>
<td><p>Octal String to BigInt == BigInt(string, 8)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>String</strong>.asBin</p></td>
<td><p>Binary String to BigInt == BigInt(string, 2)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte|Int|Long|BigInt</strong>.hexString()</p></td>
<td><p>to HEX String</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-even"><td><p><strong>Byte|Int|Long|BigInt</strong>.octString()</p></td>
<td><p>to Oct String</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte|Int|Long|BigInt</strong>.binString()</p></td>
<td><p>to Bin String</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-even"><td><p><strong>Byte|Int|Long|BigInt</strong>.hexString(bitSize)</p></td>
<td><p>first align to bit Size, then to HEX String</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte|Int|Long|BigInt</strong>.octString(bitSize)</p></td>
<td><p>first align to bit Size, then to Oct String</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-even"><td><p><strong>Byte|Int|Long|BigInt</strong>.binString(bitSize)</p></td>
<td><p>first align to bit Size, then to Bin String</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p><strong>Byte|Int|Long|BigInt</strong>.toBinInts()</p></td>
<td><p>to BinaryList</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte|Int|Long|BigInt</strong>.toDecInts()</p></td>
<td><p>to DecimalList</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-even"><td><p><strong>Byte|Int|Long|BigInt</strong>.toOctInts()</p></td>
<td><p>to OctalList</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte|Int|Long|BigInt</strong>.toBinInts(num)</p></td>
<td><p>to BinaryList, align to num size and fill 0</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-even"><td><p><strong>Byte|Int|Long|BigInt</strong>.toDecInts(num)</p></td>
<td><p>to DecimalList, align to num size and fill 0</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte|Int|Long|BigInt</strong>.toOctInts(num)</p></td>
<td><p>to OctalList, align to num size and fill 0</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-even"><td><p><strong>“3F2A”</strong>.hexToBinInts</p></td>
<td><p>Hex String to BinaryList</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>“3F2A”</strong>.hexToBinIntsAlign</p></td>
<td><p>Hex String to BinaryList Align to times of 4</p></td>
<td><p>List[Int]</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToHex</p></td>
<td><p>BinaryList to HexString</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-even"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToOct</p></td>
<td><p>BinaryList to OctString</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToHexAlignHigh</p></td>
<td><p>BinaryList size align to times of 4 (fill 0) then to HexString</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-even"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToOctAlignHigh</p></td>
<td><p>BinaryList size align to times of 3 (fill 0) then to HexString</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToInt</p></td>
<td><p>BinaryList (maxSize 32) to Int</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-even"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToLong</p></td>
<td><p>BinaryList (maxSIZE 64) to Long</p></td>
<td><p>Long</p></td>
</tr>
<tr class="row-odd"><td><p><strong>List(1,0,1,0,…)</strong>.binIntsToBigInt</p></td>
<td><p>BinaryList (size no restrictions) to BigInt</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><strong>Int</strong>.toBigInt</p></td>
<td><p>32.toBigInt == BigInt(32)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-even"><td><p><strong>Long</strong>.toBigInt</p></td>
<td><p>3233113232L.toBigInt == BigInt(3233113232L)</p></td>
<td><p>BigInt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Byte</strong>.toBigInt</p></td>
<td><p>8.toByte.toBigInt == BigInt(8.toByte)</p></td>
<td><p>BigInt</p></td>
</tr>
</tbody>
</table>
</section>
<section id="string-to-int-long-bigint">
<h4>String to Int/Long/BigInt<a class="headerlink" href="#string-to-int-long-bigint" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;32FF190&quot;</span><span class="p">.</span><span class="n">asHex</span><span class="w"></span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12384798999999&quot;</span><span class="p">.</span><span class="n">asDec</span><span class="w"></span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;123456777777700&quot;</span><span class="p">.</span><span class="n">asOct</span><span class="w"></span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10100011100111111&quot;</span><span class="p">.</span><span class="n">asBin</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="int-long-bigint-to-string">
<h4>Int/Long/BigInt to String<a class="headerlink" href="#int-long-bigint-to-string" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;32FF190&quot;</span><span class="p">.</span><span class="n">asHex</span><span class="p">.</span><span class="n">hexString</span><span class="p">()</span><span class="w"></span>
<span class="s">&quot;32FF190&quot;</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;123456777777700&quot;</span><span class="p">.</span><span class="n">asOct</span><span class="p">.</span><span class="n">octString</span><span class="p">()</span><span class="w"></span>
<span class="s">&quot;123456777777700&quot;</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10100011100111111&quot;</span><span class="p">.</span><span class="n">asBin</span><span class="p">.</span><span class="n">binString</span><span class="p">()</span><span class="w"></span>
<span class="s">&quot;10100011100111111&quot;</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="il">32323239988L</span><span class="p">.</span><span class="n">hexString</span><span class="p">()</span><span class="w"></span>
<span class="mf">7869d</span><span class="mi">8034</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="il">3239988L</span><span class="p">.</span><span class="n">octString</span><span class="p">()</span><span class="w"></span>
<span class="mi">14270064</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="mi">34</span><span class="p">.</span><span class="n">binString</span><span class="p">()</span><span class="w"></span>
<span class="mi">100010</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="int-long-bigint-to-binary-list">
<h4>Int/Long/BigInt to Binary-List<a class="headerlink" href="#int-long-bigint-to-binary-list" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="p">.</span><span class="n">toBinInts</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="il">1302309988L</span><span class="p">.</span><span class="n">toBinInts</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;100101110&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">).</span><span class="n">toBinInts</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;123456789abcdef0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">).</span><span class="n">toBinInts</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;1234567&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="n">toBinInts</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;123451118&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">).</span><span class="n">toBinInts</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>align to a fixed width</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="mi">39</span><span class="p">.</span><span class="n">toBinInts</span><span class="p">()</span><span class="w"></span>
<span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="mi">39</span><span class="p">.</span><span class="n">toBinInts</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">    </span><span class="c1">// align to 8 bit zero filled at MSB</span>
<span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="binary-list-to-int-long-bigint">
<h4>Binary-List to Int/Long/BigInt<a class="headerlink" href="#binary-list-to-int-long-bigint" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToInt</span><span class="w"></span>
<span class="mi">39</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">:,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToLong</span><span class="w"></span>
<span class="mi">39</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToBigInt</span><span class="w"></span>
<span class="mi">1302309988</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToHex</span><span class="w"></span>
<span class="mi">27</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToHexAlignHigh</span><span class="w"></span>
<span class="mi">9</span><span class="n">c</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToOct</span><span class="w"></span>
<span class="mi">47</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">binIntsToHexAlignHigh</span><span class="w"></span>
<span class="mi">47</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bigint-enricher">
<h4>BigInt enricher<a class="headerlink" href="#bigint-enricher" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="p">.</span><span class="n">toBigInt</span><span class="w"></span>
<span class="mi">32</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="il">3211323244L</span><span class="p">.</span><span class="n">toBigInt</span><span class="w"></span>
<span class="mi">3211323244</span><span class="w"></span>
<span class="n">$</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="n">toByte</span><span class="p">.</span><span class="n">toBigInt</span><span class="w"></span>
<span class="mi">8</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/regIf"></span><section id="regif">
<h3>RegIf<a class="headerlink" href="#regif" title="Permalink to this heading"></a></h3>
<p>Register Interface Builder</p>
<ul class="simple">
<li><p>Automatic address, fields allocation and conflict detection</p></li>
<li><p>28 Register Access types (Covering the 25 types defined by the UVM standard)</p></li>
<li><p>Automatic documentation generation</p></li>
</ul>
<section id="automatic-allocation">
<h4>Automatic allocation<a class="headerlink" href="#automatic-allocation" title="Permalink to this heading"></a></h4>
<p>Automatic address allocation</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RegBankExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Config</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">busif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3BusInterface</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,(</span><span class="mh">0x0000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="nc">Byte</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REG0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REG0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REG1</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REG1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REG2</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REG2&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REGn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newRegAt</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REGn&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REGn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REGn1&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">HtmlGenerator</span><span class="p">(</span><span class="s">&quot;regif&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="c1">// busif.accept(CHeaderGenerator(&quot;header&quot;, &quot;AP&quot;))</span>
<span class="w">  </span><span class="c1">// busif.accept(JsonGenerator(&quot;regif&quot;))</span>
<span class="w">  </span><span class="c1">// busif.accept(RalfGenerator(&quot;regbank&quot;))</span>
<span class="w">  </span><span class="c1">// busif.accept(SystemRdlGenerator(&quot;regif&quot;, &quot;AP&quot;))</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<img alt="_images/reg-auto-allocate.gif" src="_images/reg-auto-allocate.gif" />
<p>Automatic filed allocation</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REG0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REG1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">fd0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fields 0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nc">M_REG0</span><span class="p">.</span><span class="n">reserved</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">fd1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fields 0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">fd2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fields 0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="c1">// auto reserved 2 bits</span>
<span class="kd">val</span><span class="w"> </span><span class="n">fd3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">fieldAt</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fields 3&quot;</span><span class="p">)</span><span class="w"></span>
<span class="c1">// auto reserved 12 bits</span>
</pre></div>
</div>
<img alt="_images/field-auto-allocate.gif" src="_images/field-auto-allocate.gif" />
<p>conflict detection</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">M_REG1</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REG1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">r1fd0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG1</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;fields 1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">r1fd2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG1</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">18</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;fields 1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="n">cause</span><span class="w"> </span><span class="nc">Exception</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">M_REG1</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;REG1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">r1fd0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG1</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;fields 1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">r1fd2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG1</span><span class="p">.</span><span class="n">fieldAt</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;fields 1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="n">cause</span><span class="w"> </span><span class="nc">Exception</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="access-types">
<h4>28 Access Types<a class="headerlink" href="#access-types" title="Permalink to this heading"></a></h4>
<p>Most of these come from UVM specification</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>AccessType</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>From</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RO</p></td>
<td><p>w: no effect, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>RW</p></td>
<td><p>w: as-is, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>RC</p></td>
<td><p>w: no effect, r: clears all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>RS</p></td>
<td><p>w: no effect, r: sets all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>WRC</p></td>
<td><p>w: as-is, r: clears all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>WRS</p></td>
<td><p>w: as-is, r: sets all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>WC</p></td>
<td><p>w: clears all bits, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>WS</p></td>
<td><p>w: sets all bits, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>WSRC</p></td>
<td><p>w: sets all bits, r: clears all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>WCRS</p></td>
<td><p>w: clears all bits, r: sets all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>W1C</p></td>
<td><p>w: 1/0 clears/no effect on matching bit, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>W1S</p></td>
<td><p>w: 1/0 sets/no effect on matching bit, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>W1T</p></td>
<td><p>w: 1/0 toggles/no effect on matching bit, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>W0C</p></td>
<td><p>w: 1/0 no effect on/clears matching bit, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>W0S</p></td>
<td><p>w: 1/0 no effect on/sets matching bit, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>W0T</p></td>
<td><p>w: 1/0 no effect on/toggles matching bit, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>W1SRC</p></td>
<td><p>w: 1/0 sets/no effect on matching bit, r: clears all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>W1CRS</p></td>
<td><p>w: 1/0 clears/no effect on matching bit, r: sets all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>W0SRC</p></td>
<td><p>w: 1/0 no effect on/sets matching bit, r: clears all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>W0CRS</p></td>
<td><p>w: 1/0 no effect on/clears matching bit, r: sets all bits</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>WO</p></td>
<td><p>w: as-is, r: error</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>WOC</p></td>
<td><p>w: clears all bits, r: error</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>WOS</p></td>
<td><p>w: sets all bits, r: error</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>W1</p></td>
<td><p>w: first one after hard reset is as-is, other w have no effects, r: no effect</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-even"><td><p>WO1</p></td>
<td><p>w: first one after hard reset is as-is, other w have no effects, r: error</p></td>
<td><p>UVM</p></td>
</tr>
<tr class="row-odd"><td><p>NA</p></td>
<td><p>w: reserved, r: reserved</p></td>
<td><p>New</p></td>
</tr>
<tr class="row-even"><td><p>W1P</p></td>
<td><p>w: 1/0 pulse/no effect on matching bit, r: no effect</p></td>
<td><p>New</p></td>
</tr>
<tr class="row-odd"><td><p>W0P</p></td>
<td><p>w: 0/1 pulse/no effect on matching bit, r: no effect</p></td>
<td><p>New</p></td>
</tr>
<tr class="row-even"><td><p>HSRW</p></td>
<td><p>w: Hardware Set, SoftWare RW</p></td>
<td><p>New</p></td>
</tr>
<tr class="row-odd"><td><p>RWHS</p></td>
<td><p>w: SoftWare RW, Hardware Set</p></td>
<td><p>New</p></td>
</tr>
<tr class="row-even"><td><p>ROV</p></td>
<td><p>w: ReadOnly Value, used for hardware version</p></td>
<td><p>New</p></td>
</tr>
<tr class="row-odd"><td><p>CSTM</p></td>
<td><p>w: user custom Type, used for document</p></td>
<td><p>New</p></td>
</tr>
</tbody>
</table>
</section>
<section id="automatic-documentation-generation">
<h4>Automatic documentation generation<a class="headerlink" href="#automatic-documentation-generation" title="Permalink to this heading"></a></h4>
<p>Document Type</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Document</p></th>
<th class="head"><p>Usage</p></th>
<th class="head"><p>Status</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>HTML</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">busif.accept(HtmlGenerator(&quot;regif&quot;,</span> <span class="pre">title</span> <span class="pre">=</span> <span class="pre">&quot;XXX</span> <span class="pre">register</span> <span class="pre">file&quot;))</span></code></p></td>
<td><p>Y</p></td>
</tr>
<tr class="row-odd"><td><p>CHeader</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">busif.accept(CHeaderGenerator(&quot;header&quot;,</span> <span class="pre">&quot;AP&quot;))</span></code></p></td>
<td><p>Y</p></td>
</tr>
<tr class="row-even"><td><p>JSON</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">busif.accept(JsonGenerator(&quot;regif&quot;))</span></code></p></td>
<td><p>Y</p></td>
</tr>
<tr class="row-odd"><td><p>RALF(UVM)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">busif.accept(RalfGenerator(&quot;header&quot;))</span></code></p></td>
<td><p>Y</p></td>
</tr>
<tr class="row-even"><td><p>SystemRDL</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">busif.accept(SystemRdlGenerator(&quot;regif&quot;,</span> <span class="pre">&quot;addrmap_name&quot;,</span> <span class="pre">Some(&quot;name&quot;),</span> <span class="pre">Some(&quot;desc&quot;)))</span></code></p></td>
<td><p>Y</p></td>
</tr>
<tr class="row-odd"><td><p>Latex(pdf)</p></td>
<td></td>
<td><p>N</p></td>
</tr>
<tr class="row-even"><td><p>docx</p></td>
<td></td>
<td><p>N</p></td>
</tr>
</tbody>
</table>
<p>HTML auto-doc is now complete, Example source Code:</p>
<p>generated HTML document:</p>
<img alt="_images/regif-html.png" src="_images/regif-html.png" />
</section>
<section id="special-access-usage">
<h4>Special Access Usage<a class="headerlink" href="#special-access-usage" title="Permalink to this heading"></a></h4>
<p><strong>CASE1:</strong> <code class="docutils literal notranslate"><span class="pre">RO</span></code> usage</p>
<p><code class="docutils literal notranslate"><span class="pre">RO</span></code> is different from other types. It does not create registers and requires an external signal to drive it,
Attention, please don’t forget to drive it.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;counter&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">cnt</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">xxstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xx-ctrl state&quot;</span><span class="p">).</span><span class="n">asInput</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">overflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xx-ip parameter&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">ovfreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="n">overflow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ovfreg</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">inc</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;counter&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Counter</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w">  </span><span class="n">inc</span><span class="p">)</span><span class="w"></span>
<span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cnt</span><span class="w"></span>
</pre></div>
</div>
<p><strong>CASE2:</strong> <code class="docutils literal notranslate"><span class="pre">ROV</span></code> usage</p>
<p>ASIC design often requires some solidified version information. Unlike RO, it is not expected to generate wire signals</p>
<p>old way:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xx-device version&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;F000A801&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>new way:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">ROV</span><span class="p">,</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;F000A801&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;xx-device version&quot;</span><span class="p">)(</span><span class="nc">Symbol</span><span class="p">(</span><span class="s">&quot;Version&quot;</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p><strong>CASE3:</strong> <code class="docutils literal notranslate"><span class="pre">HSRW/RWHS</span></code> hardware set type
In some cases, such registers are not only configured by software, but also set by hardware signals</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">xxx_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">xxx_set_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">reg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG0</span><span class="p">.</span><span class="n">fieldHSRW</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set_val</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xx-device version&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 0x0000</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG1</span><span class="p">.</span><span class="n">fieldRWHS</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set_val</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xx-device version&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 0x0004</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rstn</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rstn</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">     </span><span class="n">reg0</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">&#39;0</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">reg0</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">&#39;0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">hit_0x0000</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">        </span><span class="n">reg0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">end</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">      </span><span class="c1">// HW have High priority than SW</span>
<span class="w">        </span><span class="n">reg0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set_val</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">end</span><span class="w"></span>

<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">        </span><span class="n">reg1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">xxx_set_val</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">end</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">hit_0x0004</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">      </span><span class="c1">// SW have High priority than HW</span>
<span class="w">        </span><span class="n">reg1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
</pre></div>
</div>
<p><strong>CASE4:</strong> <code class="docutils literal notranslate"><span class="pre">CSTM</span></code> Although SpinalHDL includes 25 register types and 6 extension types,
there are still various demands for private register types in practical application.
Therefore, we reserve CSTM types for scalability.
CSTM is only used to generate software interfaces, and does not generate actual circuits</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nc">REG</span><span class="p">.</span><span class="n">registerAtOnlyReadLogic</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="nc">CSTM</span><span class="p">(</span><span class="s">&quot;BMRW&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">resetValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;custom field&quot;</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">busif</span><span class="p">.</span><span class="n">dowrite</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">reg</span><span class="w"> </span><span class="o">:=</span><span class="w">  </span><span class="n">reg</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">busif</span><span class="p">.</span><span class="n">writeData</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">writeData</span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">writeData</span><span class="p">(</span><span class="mi">31</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>CASE5:</strong> <code class="docutils literal notranslate"><span class="pre">parasiteField</span></code></p>
<p>This is used for software to share the same register on multiple address instead of generating multiple register entities</p>
<p>example1: clock gate software enable</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">M_CG_ENS_SET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;Clock Gate Enables&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// x00000</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">M_CG_ENS_CLR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;Clock Gate Enables&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 0x0004</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">M_CG_ENS_RO</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;Clock Gate Enables&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 0x0008</span>

<span class="kd">val</span><span class="w"> </span><span class="n">xx_sys_cg_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CG_ENS_SET</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">W1S</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;clock gate enables, write 1 set&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="nc">M_CG_ENS_CLR</span><span class="p">.</span><span class="n">parasiteField</span><span class="p">(</span><span class="n">xx_sys_cg_en</span><span class="p">,</span><span class="w"> </span><span class="nc">W1C</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;clock gate enables, write 1 clear&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="nc">M_CG_ENS_RO</span><span class="p">.</span><span class="n">parasiteField</span><span class="p">(</span><span class="n">xx_sys_cg_en</span><span class="p">,</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;clock gate enables, read only&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>example2: interrupt raw reg with force interface for software</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">RAW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">newRegAt</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="s">&quot;Interrupt Raw status Register\n set when event \n clear raw when write 1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">FORCE</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="s">&quot;Interrupt Force  Register\n for SW debug use \n write 1 set raw&quot;</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">raw</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">RAW</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">AccessType</span><span class="p">.</span><span class="nc">W1C</span><span class="p">,</span><span class="w">    </span><span class="n">resetValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">s&quot;raw, default 0&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="nc">FORCE</span><span class="p">.</span><span class="n">parasiteField</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="w"> </span><span class="nc">AccessType</span><span class="p">.</span><span class="nc">W1S</span><span class="p">,</span><span class="w">   </span><span class="n">resetValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">s&quot;force, write 1 set, debug use&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p><strong>CASE6:</strong> <code class="docutils literal notranslate"><span class="pre">SpinalEnum</span></code></p>
<p>When the field type is SpinalEnum, the resetValue specifies the index of the enum elements.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="p">(</span><span class="n">defaultEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryOneHot</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">sIdle</span><span class="p">,</span><span class="w"> </span><span class="n">sStart</span><span class="p">,</span><span class="w"> </span><span class="n">sData</span><span class="p">,</span><span class="w"> </span><span class="n">sParity</span><span class="p">,</span><span class="w"> </span><span class="n">sStop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M_REG2</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">UartCtrlTxState</span><span class="p">(),</span><span class="w"> </span><span class="nc">AccessType</span><span class="p">.</span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">resetValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;state&quot;</span><span class="p">)</span><span class="w"></span>
<span class="c1">// raw will be init to sData</span>
</pre></div>
</div>
</section>
<section id="byte-mask">
<h4>Byte Mask<a class="headerlink" href="#byte-mask" title="Permalink to this heading"></a></h4>
<p>withStrb</p>
</section>
<section id="typical-example">
<h4>Typical Example<a class="headerlink" href="#typical-example" title="Permalink to this heading"></a></h4>
<p>Batch create REG-Address and fields register</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="nn">regif</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RegBank</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Config</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">IQ</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">busif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3BusInterface</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mh">0x000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="nc">Byte</span><span class="p">),</span><span class="w"> </span><span class="n">regPre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">9</span><span class="p">).</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// here use setName give REG uniq name for Docs usage</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">REG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">s&quot;Register</span><span class="si">${</span><span class="n">i</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="n">setName</span><span class="p">(</span><span class="s">s&quot;REG</span><span class="si">${</span><span class="n">i</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">REG</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">AccessType</span><span class="p">.</span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Complex real&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">imag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">REG</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">AccessType</span><span class="p">.</span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Complex imag&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">REG</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="nc">AccessType</span><span class="p">.</span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Accelerator status&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="nc">IQ</span><span class="p">(</span><span class="n">i</span><span class="p">)(</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">real</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="nc">IQ</span><span class="p">(</span><span class="n">i</span><span class="p">)(</span><span class="mi">15</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">imag</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="w">    </span><span class="n">stat</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">stats</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">genDocs</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">CHeaderGenerator</span><span class="p">(</span><span class="s">&quot;regbank&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">HtmlGenerator</span><span class="p">(</span><span class="s">&quot;regbank&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Interupt Example&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">JsonGenerator</span><span class="p">(</span><span class="s">&quot;regbank&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">RalfGenerator</span><span class="p">(</span><span class="s">&quot;regbank&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">SystemRdlGenerator</span><span class="p">(</span><span class="s">&quot;regbank&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="bp">this</span><span class="p">.</span><span class="n">genDocs</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">RegBank</span><span class="p">())</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="interrupt-factory">
<h4>Interrupt Factory<a class="headerlink" href="#interrupt-factory" title="Permalink to this heading"></a></h4>
<p>Manual writing interruption</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">cpInterruptExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">tx_done</span><span class="p">,</span><span class="w"> </span><span class="n">rx_done</span><span class="p">,</span><span class="w"> </span><span class="n">frame_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Config</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">busif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3BusInterface</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mh">0x000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="nc">Byte</span><span class="p">),</span><span class="w"> </span><span class="n">regPre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_CP_INT_RAW</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;cp int raw register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">tx_int_raw</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_RAW</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">W1C</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;tx interrupt enable register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">rx_int_raw</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_RAW</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">W1C</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;rx interrupt enable register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">frame_int_raw</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_RAW</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">W1C</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;frame interrupt enable register&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_CP_INT_FORCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;cp int force register\n for debug use&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">tx_int_force</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_FORCE</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;tx interrupt enable register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">rx_int_force</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_FORCE</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;rx interrupt enable register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">frame_int_force</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_FORCE</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;frame interrupt enable register&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_CP_INT_MASK</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;cp int mask register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">tx_int_mask</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_MASK</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;tx interrupt mask register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">rx_int_mask</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_MASK</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;rx interrupt mask register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">frame_int_mask</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_MASK</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RW</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;frame interrupt mask register&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="nc">M_CP_INT_STATUS</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">newReg</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;cp int state register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">tx_int_status</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_STATUS</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;tx interrupt state register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">rx_int_status</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_STATUS</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;rx interrupt state register&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">frame_int_status</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">M_CP_INT_STATUS</span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="nc">Bool</span><span class="p">(),</span><span class="w"> </span><span class="nc">RO</span><span class="p">,</span><span class="w"> </span><span class="n">doc</span><span class="o">=</span><span class="s">&quot;frame interrupt state register&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="n">rx_int_raw</span><span class="p">.</span><span class="n">setWhen</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">rx_done</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">tx_int_raw</span><span class="p">.</span><span class="n">setWhen</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">tx_done</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">frame_int_raw</span><span class="p">.</span><span class="n">setWhen</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">frame_end</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="n">rx_int_status</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">rx_int_raw</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">rx_int_force</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rx_int_mask</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">tx_int_status</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">tx_int_raw</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">rx_int_force</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rx_int_mask</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">frame_int_status</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">frame_int_raw</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">frame_int_force</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">frame_int_mask</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rx_int_status</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tx_int_status</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">frame_int_status</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>this is a very tedious and repetitive work, a better way is to use the “factory” paradigm to auto-generate the documentation for each signal.</p>
<p>now the InterruptFactory can do that.</p>
<p>Easy Way create interruption:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EasyInterrupt</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Config</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">busif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BusInterface</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,(</span><span class="mh">0x000</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">regPre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">interruptFactory</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">e</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">CHeaderGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">,</span><span class="s">&quot;AP&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">HtmlGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Interupt Example&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">JsonGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">RalfGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">SystemRdlGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<img alt="_images/easy-intr.png" src="_images/easy-intr.png" />
<section id="ip-level-interrupt-factory">
<h5>IP level interrupt Factory<a class="headerlink" href="#ip-level-interrupt-factory" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>AccessType</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RAW</p></td>
<td><p>W1C</p></td>
<td><p>int raw register, set by int event, clear when bus write 1</p></td>
</tr>
<tr class="row-odd"><td><p>FORCE</p></td>
<td><p>RW</p></td>
<td><p>int force register, for SW debug use</p></td>
</tr>
<tr class="row-even"><td><p>MASK</p></td>
<td><p>RW</p></td>
<td><p>int mask register, 1: off; 0: open; default 1 int off</p></td>
</tr>
<tr class="row-odd"><td><p>STATUS</p></td>
<td><p>RO</p></td>
<td><p>int status, Read Only, <code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">raw</span> <span class="pre">&amp;&amp;</span> <span class="pre">!</span> <span class="pre">mask</span></code></p></td>
</tr>
</tbody>
</table>
<img alt="_images/RFMS.svg" src="_images/RFMS.svg" /><p>SpinalUsage:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">busif</span><span class="p">.</span><span class="n">interruptFactory</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">e</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sys-level-interrupt-merge">
<h5>SYS level interrupt merge<a class="headerlink" href="#sys-level-interrupt-merge" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>AccessType</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>MASK</p></td>
<td><p>RW</p></td>
<td><p>int mask register, 1: off; 0: open; default 1 int off</p></td>
</tr>
<tr class="row-odd"><td><p>STATUS</p></td>
<td><p>RO</p></td>
<td><p>int status, RO, <code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">int_level</span> <span class="pre">&amp;&amp;</span> <span class="pre">!</span> <span class="pre">mask</span></code></p></td>
</tr>
</tbody>
</table>
<img alt="_images/MS.svg" src="_images/MS.svg" /><p>SpinalUsage:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">busif</span><span class="p">.</span><span class="n">interruptLevelFactory</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sys_int0</span><span class="p">,</span><span class="w"> </span><span class="n">sys_int1</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="spinal-factory">
<h5>Spinal Factory<a class="headerlink" href="#spinal-factory" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>BusInterface method</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">InterruptFactory(regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create RAW/FORCE/MASK/STATUS for pulse event</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">InterruptFactoryNoForce(regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create RAW/MASK/STATUS for pulse event</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">InterruptLevelFactory(regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create MASK/STATUS for level_int merge</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">InterruptFactoryAt(addrOffset:</span> <span class="pre">Int,</span> <span class="pre">regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create RAW/FORCE/MASK/STATUS for pulse event at addrOffset</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">InterruptFactoryNoForceAt(addrOffset:</span> <span class="pre">Int,</span> <span class="pre">regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create RAW/MASK/STATUS for pulse event at addrOffset</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">InterruptFactoryAt(addrOffset:</span> <span class="pre">Int,</span> <span class="pre">regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create MASK/STATUS for level_int merge at addrOffset</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">interrupt_W1SCmask_FactoryAt(addrOffset:</span> <span class="pre">BigInt,</span> <span class="pre">regNamePre:</span> <span class="pre">String,</span> <span class="pre">triggers:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create RAW/FORCE/MASK(SET/CLR)/STATUS for pulse event at addrOffset</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">interruptLevel_W1SCmask_FactoryAt(addrOffset:</span> <span class="pre">BigInt,</span> <span class="pre">regNamePre:</span> <span class="pre">String,</span> <span class="pre">levels:</span> <span class="pre">Bool*)</span></code></p></td>
<td><p>create RAW/FORCE/MASK(SET/CLR)/STATUS for level event at addrOffset</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example">
<h5>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RegFileIntrExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Config</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">int_pulse0</span><span class="p">,</span><span class="w"> </span><span class="n">int_pulse1</span><span class="p">,</span><span class="w"> </span><span class="n">int_pulse2</span><span class="p">,</span><span class="w"> </span><span class="n">int_pulse3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">int_level0</span><span class="p">,</span><span class="w"> </span><span class="n">int_level1</span><span class="p">,</span><span class="w"> </span><span class="n">int_level2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">sys_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">     </span><span class="kd">val</span><span class="w"> </span><span class="n">gpio_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">busif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BusInterface</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="mh">0x000</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">regPre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AP&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">io</span><span class="p">.</span><span class="n">sys_int</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">interruptFactory</span><span class="p">(</span><span class="s">&quot;SYS&quot;</span><span class="p">,</span><span class="n">io</span><span class="p">.</span><span class="n">int_pulse0</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">int_pulse1</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">int_pulse2</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">int_pulse3</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">io</span><span class="p">.</span><span class="n">gpio_int</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">busif</span><span class="p">.</span><span class="n">interruptLevelFactory</span><span class="p">(</span><span class="s">&quot;GPIO&quot;</span><span class="p">,</span><span class="n">io</span><span class="p">.</span><span class="n">int_level0</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">int_level1</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">int_level2</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">sys_int</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">genDoc</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">CHeaderGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">,</span><span class="s">&quot;Intr&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">HtmlGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Interrupt Example&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">JsonGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">RalfGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="n">busif</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="nc">SystemRdlGenerator</span><span class="p">(</span><span class="s">&quot;intrreg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Intr&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="bp">this</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="bp">this</span><span class="p">.</span><span class="n">genDoc</span><span class="p">()</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<img alt="_images/intc.jpeg" src="_images/intc.jpeg" />
</section>
</section>
<section id="defaultreadvalue">
<h4>DefaultReadValue<a class="headerlink" href="#defaultreadvalue" title="Permalink to this heading"></a></h4>
<p>When the software reads a reserved address, the current policy is to return normally, readerror=0.
In order to facilitate software debugging, the read back value can be configured, which is 0 by default</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">busif</span><span class="p">.</span><span class="n">setReservedAddressReadValue</span><span class="p">(</span><span class="mh">0x0000EF00</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">   </span><span class="n">busif_rdata</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h0000EF00</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">busif_rderr</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="w">         </span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="developers-area">
<h4>Developers Area<a class="headerlink" href="#developers-area" title="Permalink to this heading"></a></h4>
<p>You can add your document Type by extending the <cite>BusIfVisitor</cite> Trait</p>
<p><code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span> <span class="pre">Latex(fileName</span> <span class="pre">:</span> <span class="pre">String)</span> <span class="pre">extends</span> <span class="pre">BusIfVisitor{</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>BusIfVisitor give access BusIf.RegInsts to do what you want</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// lib/src/main/scala/spinal/lib/bus/regif/BusIfBase.scala</span>

<span class="k">trait</span><span class="w"> </span><span class="nc">BusIfVisitor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">begin</span><span class="p">(</span><span class="n">busDataWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">descr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">FifoDescr</span><span class="p">)</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">descr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">RegDescr</span><span class="p">)</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">end</span><span class="p">()</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Bus/index"></span><section id="bus">
<h3>Bus<a class="headerlink" href="#bus" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/Bus/amba3/ahblite3"></span><section id="ahb-lite3">
<h4>AHB-Lite3<a class="headerlink" href="#ahb-lite3" title="Permalink to this heading"></a></h4>
<section id="configuration-and-instantiation">
<h5>Configuration and instantiation<a class="headerlink" href="#configuration-and-instantiation" title="Permalink to this heading"></a></h5>
<p>First each time you want to create a AHB-Lite3 bus, you will need a configuration object. This configuration object is an <code class="docutils literal notranslate"><span class="pre">AhbLite3Config</span></code> and has following arguments :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>addressWidth</p></td>
<td><p>Int</p></td>
<td></td>
<td><p>Width of HADDR (byte granularity)</p></td>
</tr>
<tr class="row-odd"><td><p>dataWidth</p></td>
<td><p>Int</p></td>
<td></td>
<td><p>Width of HWDATA and HRDATA</p></td>
</tr>
</tbody>
</table>
<p>There is in short how the AHB-Lite3 bus is defined in the SpinalHDL library :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">AhbLite3</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">AhbLite3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">//  Address and control</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HSEL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HWRITE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HTRANS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HMASTLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">//  Data</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HWDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HRDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">//  Transfer response</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HREADYOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">HRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">HADDR</span><span class="p">,</span><span class="nc">HWRITE</span><span class="p">,</span><span class="nc">HSIZE</span><span class="p">,</span><span class="nc">HBURST</span><span class="p">,</span><span class="nc">HPROT</span><span class="p">,</span><span class="nc">HTRANS</span><span class="p">,</span><span class="nc">HMASTLOCK</span><span class="p">,</span><span class="nc">HWDATA</span><span class="p">,</span><span class="nc">HREADY</span><span class="p">,</span><span class="nc">HSEL</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="nc">HREADYOUT</span><span class="p">,</span><span class="nc">HRESP</span><span class="p">,</span><span class="nc">HRDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>There is a short example of usage :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">ahbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AhbLite3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">ahbX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AhbLite3</span><span class="p">(</span><span class="n">ahbConfig</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">ahbY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AhbLite3</span><span class="p">(</span><span class="n">ahbConfig</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">ahbY</span><span class="p">.</span><span class="nc">HSEL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="variations">
<h5>Variations<a class="headerlink" href="#variations" title="Permalink to this heading"></a></h5>
<p>There is an AhbLite3Master variation. The only difference is the absence of the <code class="docutils literal notranslate"><span class="pre">HREADYOUT</span></code> signal. This variation should only be used by masters while the interconnect and slaves use <code class="docutils literal notranslate"><span class="pre">AhbLite3</span></code>.</p>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Bus/amba3/apb3"></span><section id="apb3">
<h4>Apb3<a class="headerlink" href="#apb3" title="Permalink to this heading"></a></h4>
<p>The AMBA3-APB bus is commonly used to interface low bandwidth peripherals.</p>
<section id="configuration-and-instantiation">
<h5>Configuration and instantiation<a class="headerlink" href="#configuration-and-instantiation" title="Permalink to this heading"></a></h5>
<p>First each time you want to create a APB3 bus, you will need a configuration object. This configuration object is an <code class="docutils literal notranslate"><span class="pre">Apb3Config</span></code> and has following arguments :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>addressWidth</p></td>
<td><p>Int</p></td>
<td></td>
<td><p>Width of PADDR (byte granularity)</p></td>
</tr>
<tr class="row-odd"><td><p>dataWidth</p></td>
<td><p>Int</p></td>
<td></td>
<td><p>Width of PWDATA and PRDATA</p></td>
</tr>
<tr class="row-even"><td><p>selWidth</p></td>
<td><p>Int</p></td>
<td><p>1</p></td>
<td><p>With of PSEL</p></td>
</tr>
<tr class="row-odd"><td><p>useSlaveError</p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
<td><p>Specify the presence of PSLVERROR</p></td>
</tr>
</tbody>
</table>
<p>There is in short how the APB3 bus is defined in the SpinalHDL library :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>There is a short example of usage :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">apbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">apbX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">apbY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">apbY</span><span class="p">.</span><span class="nc">PENABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="functions-and-operators">
<h5>Functions and operators<a class="headerlink" href="#functions-and-operators" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>X &gt;&gt; Y</p></td>
<td></td>
<td><p>Connect X to Y. Address of Y could be smaller than the one of X</p></td>
</tr>
<tr class="row-odd"><td><p>X &lt;&lt; Y</p></td>
<td></td>
<td><p>Do the reverse of the &gt;&gt; operator</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Bus/amba4/axi4"></span><section id="axi4">
<h4>Axi4<a class="headerlink" href="#axi4" title="Permalink to this heading"></a></h4>
<p>The AXI4 is a high bandwidth bus defined by ARM.</p>
<section id="configuration-and-instantiation">
<h5>Configuration and instantiation<a class="headerlink" href="#configuration-and-instantiation" title="Permalink to this heading"></a></h5>
<p>First each time you want to create a AXI4 bus, you will need a configuration object. This configuration object is an <code class="docutils literal notranslate"><span class="pre">Axi4Config</span></code> and has following arguments :</p>
<p>Note : useXXX specify if the bus has XXX signal present.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>addressWidth</p></td>
<td><p>Int</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>dataWidth</p></td>
<td><p>Int</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>idWidth</p></td>
<td><p>Int</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>userWidth</p></td>
<td><p>Int</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>useId</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>useRegion</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>useBurst</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>useLock</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>useCache</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>useSize</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>useQos</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>useLen</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>useLast</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>useResp</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>useProt</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>useStrb</p></td>
<td><p>Boolean</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>useUser</p></td>
<td><p>Boolean</p></td>
<td><p>false</p></td>
</tr>
</tbody>
</table>
<p>There is in short how the AXI4 bus is defined in the SpinalHDL library :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Axi4</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">Axi4Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">aw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Axi4Aw</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">w</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Axi4W</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Axi4B</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Axi4Ar</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Axi4R</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">master</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span><span class="n">aw</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">slave</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>There is a short example of usage :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">axiConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">idWidth</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">axiX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4</span><span class="p">(</span><span class="n">axiConfig</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">axiY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4</span><span class="p">(</span><span class="n">axiConfig</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">axiY</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="variations">
<h5>Variations<a class="headerlink" href="#variations" title="Permalink to this heading"></a></h5>
<p>There is 3 other variation of the Axi4 bus :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Axi4ReadOnly</p></td>
<td><p>Only AR and R channels are present</p></td>
</tr>
<tr class="row-odd"><td><p>Axi4WriteOnly</p></td>
<td><p>Only AW, W and B channels are present</p></td>
</tr>
<tr class="row-even"><td><p>Axi4Shared</p></td>
<td><div class="line-block">
<div class="line">This variation is a library initiative.</div>
<div class="line">It use 4 channels, W, B ,R and also a new one which is named AWR.</div>
<div class="line">The AWR channel can be used to transmit AR and AW transactions. To dissociate them, a signal <code class="docutils literal notranslate"><span class="pre">write</span></code> is present.</div>
<div class="line">The advantage of this Axi4Shared variation is to use less area, especially in the interconnect.</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="functions-and-operators">
<h5>Functions and operators<a class="headerlink" href="#functions-and-operators" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>X &gt;&gt; Y</p></td>
<td></td>
<td><p>Connect X to Y. Able infer default values as specified in the AXI4 specification, and also to adapt some width in a safe manner.</p></td>
</tr>
<tr class="row-odd"><td><p>X &lt;&lt; Y</p></td>
<td></td>
<td><p>Do the reverse of the &gt;&gt; operator</p></td>
</tr>
<tr class="row-even"><td><p>X.toWriteOnly</p></td>
<td><p>Axi4WriteOnly</p></td>
<td><p>Return an Axi4WriteOnly bus drive by X</p></td>
</tr>
<tr class="row-odd"><td><p>X.toReadOnly</p></td>
<td><p>Axi4ReadOnly</p></td>
<td><p>Return an Axi4ReadOnly bus drive by X</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Bus/avalon/avalonmm"></span><section id="avalonmm">
<h4>AvalonMM<a class="headerlink" href="#avalonmm" title="Permalink to this heading"></a></h4>
<p>The AvalonMM bus fit very well in FPGA. It is very flexible :</p>
<ul class="simple">
<li><p>Able of the same simplicity than APB</p></li>
<li><p>Better for than AHB in many application that need bandwidth because AvalonMM has a mode that decouple read response from commands (reduce latency read latency impact).</p></li>
<li><p>Less performance than AXI but use much less area (Read and write command use the same handshake channel. The master don’t need to store address of pending request to avoid Read/Write hazard)</p></li>
</ul>
<section id="configuration-and-instantiation">
<h5>Configuration and instantiation<a class="headerlink" href="#configuration-and-instantiation" title="Permalink to this heading"></a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">AvalonMM</span></code> Bundle has a construction argument <code class="docutils literal notranslate"><span class="pre">AvalonMMConfig</span></code>. Because of the flexible nature of the Avalon bus, the <code class="docutils literal notranslate"><span class="pre">AvalonMMConfig</span></code> as many configuration elements. For more information the Avalon spec could be find on the intel website.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">AvalonMMConfig</span><span class="p">(</span><span class="w"> </span><span class="n">addressWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">dataWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">burstCountWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useByteEnable</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useDebugAccess</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useRead</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useWrite</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useResponse</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useLock</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useWaitRequestn</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useReadDataValid</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">useBurstCount</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="c1">// useEndOfPacket : Boolean,</span>

<span class="w">                           </span><span class="n">addressUnits</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">AddressUnits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">symbols</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">burstCountUnits</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">AddressUnits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">words</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">burstOnBurstBoundariesOnly</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">constantBurstBehavior</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">holdTime</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">linewrapBursts</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">maximumPendingReadTransactions</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">maximumPendingWriteTransactions</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// unlimited</span>
<span class="w">                           </span><span class="n">readLatency</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">readWaitTime</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">setupTime</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">writeWaitTime</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">                           </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This configuration class has also some functions :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>getReadOnlyConfig</p></td>
<td><p>AvalonMMConfig</p></td>
<td><p>Return a similar configuration but with all write feature disabled</p></td>
</tr>
<tr class="row-odd"><td><p>getWriteOnlyConfig</p></td>
<td><p>AvalonMMConfig</p></td>
<td><p>Return a similar configuration but with all read feature disabled</p></td>
</tr>
</tbody>
</table>
<p>This configuration companion object has also some functions to provide some <code class="docutils literal notranslate"><span class="pre">AvalonMMConfig</span></code> templates :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fixed(addressWidth,dataWidth,readLatency)</p></td>
<td><p>AvalonMMConfig</p></td>
<td><p>Return a simple configuration with fixed read timings</p></td>
</tr>
<tr class="row-odd"><td><p>pipelined(addressWidth,dataWidth)</p></td>
<td><p>AvalonMMConfig</p></td>
<td><p>Return a configuration with variable latency read (readDataValid)</p></td>
</tr>
<tr class="row-even"><td><p>bursted(addressWidth,dataWidth,burstCountWidth)</p></td>
<td><p>AvalonMMConfig</p></td>
<td><p>Return a configuration with variable latency read and burst capabilities</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a write only AvalonMM configuration with burst capabilities and byte enable</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myAvalonConfig</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nc">AvalonMMConfig</span><span class="p">.</span><span class="n">bursted</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addressWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDataWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">burstCountWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log2Up</span><span class="p">(</span><span class="n">burstSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">useByteEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">constantBurstBehavior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">burstOnBurstBoundariesOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">                      </span><span class="p">).</span><span class="n">getWriteOnlyConfig</span><span class="w"></span>

<span class="c1">// Create an instance of the AvalonMM bus by using this configuration</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AvalonMM</span><span class="p">(</span><span class="n">myAvalonConfig</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Bus/tilelink/tilelink"></span><section id="tilelink">
<h4>Tilelink<a class="headerlink" href="#tilelink" title="Permalink to this heading"></a></h4>
<section id="configuration-and-instantiation">
<h5>Configuration and instantiation<a class="headerlink" href="#configuration-and-instantiation" title="Permalink to this heading"></a></h5>
<p>There is a short example to define two non coherent tilelink bus instance and connect them:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="n">tilelink</span>
<span class="kd">val</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">BusParameter</span><span class="p">.</span><span class="n">simple</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">sizeBytes</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">sourceWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">busA</span><span class="p">,</span><span class="w"> </span><span class="n">busB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">Bus</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="w"></span>
<span class="n">busA</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">busB</span><span class="w"></span>
</pre></div>
</div>
<p>Here is the same as above, but with coherency channels</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="n">tilelink</span>
<span class="kd">val</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">BusParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">sizeBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">sourceWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">sinkWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">withBCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">withDataA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">withDataB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">withDataC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">withDataD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">busA</span><span class="p">,</span><span class="w"> </span><span class="n">busB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">Bus</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="w"></span>
<span class="n">busA</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">busB</span><span class="w"></span>
</pre></div>
</div>
<p>Those above where for the hardware instantiation, the thing is that it is the simple / easy part. When things goes into SoC / memory coherency, you kind of need an additional layer to negotiate / propagate parameters all around.
That’s what tilelink.fabric.Node is about.</p>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Bus/tilelink/tilelink_fabric"></span><section id="tilelink-fabric-node">
<h4>tilelink.fabric.Node<a class="headerlink" href="#tilelink-fabric-node" title="Permalink to this heading"></a></h4>
<p>tilelink.fabric.Node is an additional layer over the regular tilelink hardware instantiation which handle negotiation and parameters propagation at a SoC level.</p>
<p>It is mostly based on the Fiber API, which allows to create elaboration time fibers (user-space threads), allowing to schedule future parameter propagation / negotiation and hardware elaboration.</p>
<p>A Node can be created in 3 ways :</p>
<ul class="simple">
<li><p>tilelink.fabric.Node.down() : To create a node which can connect downward (toward slaves), so it would be used in a CPU / DMA / bridges agents</p></li>
<li><p>tilelink.fabric.Node() : To create an intermediate nodes</p></li>
<li><p>tilelink.fabric.Node.up() : To create a node which can connect upward (toward masters), so it would be used in peripherals / memories / bridges agents</p></li>
</ul>
<p>Nodes mostly have the following attributes :</p>
<ul class="simple">
<li><p>bus : Handle[tilelink.Bus]; the hardware instance of the bus</p></li>
<li><p>m2s.proposed : Handle[tilelink.M2sSupport]; The set of features which is proposed by the upward connections</p></li>
<li><p>m2s.supported : Handle[tilelink.M2sSupport] : The set of feature supported by the downward connections</p></li>
<li><p>m2s.parameter : Handle[tilelink.M2sParameter] : The final bus parameter</p></li>
</ul>
<p>You can note that they all are Handles. Handle is a way in SpinalHDL to share a value between fibers. If a fiber read a Handle while this one has no value yet, it will block the execution of that fiber until another fiber provide a value to the Handle.</p>
<p>There is also a set of attributes like m2s, but reversed (named s2m) which specify the parameters for the transactions initiated by the slave side of the interconnect (ex memory coherency).</p>
<p>There is two talks which where introducing the tilelink.fabric.Node. Those talk may not exactly follow the actual syntax, they are still follow the concepts :</p>
<ul class="simple">
<li><p>Introduction : <a class="reference external" href="https://youtu.be/hVi9xOGuuek">https://youtu.be/hVi9xOGuuek</a></p></li>
<li><p>In depth : <a class="reference external" href="https://peertube.f-si.org/videos/watch/bcf49c84-d21d-4571-a73e-96d7eb89e907">https://peertube.f-si.org/videos/watch/bcf49c84-d21d-4571-a73e-96d7eb89e907</a></p></li>
</ul>
<section id="example-toplevel">
<h5>Example Toplevel<a class="headerlink" href="#example-toplevel" title="Permalink to this heading"></a></h5>
<p>Here is an example of a simple fictive SoC toplevel :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CpuFiber</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RamFiber</span><span class="p">()</span><span class="w"></span>

<span class="c1">// Map the ram at [0x10000-0x101FF], the ram will infer its own size from it.</span>
<span class="n">ram</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x200</span><span class="p">)</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">down</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GpioFiber</span><span class="p">()</span><span class="w"></span>

<span class="c1">// Map the gpio at [0x20000-0x20FFF], its range of 4KB being fixed internally.</span>
<span class="n">gpio</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x20000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">down</span><span class="w"></span>
</pre></div>
</div>
<p>You can also define intermediate nodes in the interconnect as following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CpuFiber</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RamFiber</span><span class="p">()</span><span class="w"></span>
<span class="n">ram</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x200</span><span class="p">)</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">down</span><span class="w"></span>

<span class="c1">// Create a peripherals namespace to keep things clean.</span>
<span class="kd">val</span><span class="w"> </span><span class="n">peripherals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Create a intermediate node in the interconnect.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">access</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x20000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">down</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gpioA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GpioFiber</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">gpioA</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x0000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">access</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gpioB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GpioFiber</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">gpioB</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x1000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">access</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="example-gpiofiber">
<h5>Example GpioFiber<a class="headerlink" href="#example-gpiofiber" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">GpioFiber</span></code> is a simple tilelink peripheral which can read / drive a 32 bits tristate array.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="n">tilelink</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">fiber</span><span class="p">.</span><span class="nc">Fiber</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GpioFiber</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Define a node facing upward (toward masters only).</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="nc">Node</span><span class="p">.</span><span class="n">up</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define a elaboration thread to specify the &quot;up&quot; parameters and generate the hardware.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fiber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Fiber</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Here we first define what our up node support. m2s mean master to slave requests.</span>
<span class="w">    </span><span class="n">up</span><span class="p">.</span><span class="n">m2s</span><span class="p">.</span><span class="n">supported</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">M2sSupport</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Transfers define which kind of memory transactions our up node will support.</span>
<span class="w">      </span><span class="c1">// Here it only support 4 bytes get/putfull.</span>
<span class="w">      </span><span class="n">transfers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">M2sTransfers</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">SizeRange</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">putFull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">SizeRange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// s2m mean slave to master requests, those are only use for memory coherency purpose</span>
<span class="w">    </span><span class="c1">// So here we specify we do not need any.</span>
<span class="w">    </span><span class="n">up</span><span class="p">.</span><span class="n">s2m</span><span class="p">.</span><span class="n">none</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Then we can finally generate some hardware.</span>
<span class="w">    </span><span class="c1">// Starting by defining a 32 bits TriStateArray (Array meaning that each pin has its</span>
<span class="w">    </span><span class="c1">// own writeEnable bit.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">TriStateArray</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="c1">// tilelink.SlaveFactory is a utility allowing to easily generate the logic required</span>
<span class="w">    </span><span class="c1">// to control some hardware from a tilelink bus.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">SlaveFactory</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="n">bus</span><span class="p">,</span><span class="w"> </span><span class="n">allowBurst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Use the SlaveFactory API to generate some hardware to read / drive the pins.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">writeEnableReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="n">drive</span><span class="p">(</span><span class="n">pins</span><span class="p">.</span><span class="n">writeEnable</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">writeReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="n">drive</span><span class="p">(</span><span class="n">pins</span><span class="p">.</span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">factory</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">pins</span><span class="p">.</span><span class="n">read</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="example-ramfiber">
<h5>Example RamFiber<a class="headerlink" href="#example-ramfiber" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">RamFiber</span></code> is the integration layer of a regular tilelink Ram component.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="n">tilelink</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">fiber</span><span class="p">.</span><span class="nc">Fiber</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RamFiber</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="nc">Node</span><span class="p">.</span><span class="n">up</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Fiber</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Here the supported parameters are function of what the master would like us to</span>
<span class="w">    </span><span class="c1">// ideally support. The tilelink.Ram support all addressWidth / dataWidth /</span>
<span class="w">    </span><span class="c1">// burst length / get / put accesses but doesn&#39;t support atomic / coherency.</span>
<span class="w">    </span><span class="c1">// So we take what is proposed to use and restrict it to all sorts of</span>
<span class="w">    </span><span class="c1">// get / put request.</span>
<span class="w">    </span><span class="n">up</span><span class="p">.</span><span class="n">m2s</span><span class="p">.</span><span class="n">supported</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">m2s</span><span class="p">.</span><span class="n">proposed</span><span class="p">.</span><span class="n">intersect</span><span class="p">(</span><span class="nc">M2sTransfers</span><span class="p">.</span><span class="n">allGetPut</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">up</span><span class="p">.</span><span class="n">s2m</span><span class="p">.</span><span class="n">none</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Here we infer how many bytes our ram need to be, by looking at the memory</span>
<span class="w">    </span><span class="c1">// mapping of the connected masters.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">ups</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">mapping</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">highestBound</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">mapping</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">lowerBound</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">max</span><span class="p">.</span><span class="n">toInt</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Then we finally generate the regular hardware</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">Ram</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="n">bus</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">logic</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">bus</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="example-cpufiber">
<h5>Example CpuFiber<a class="headerlink" href="#example-cpufiber" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">CpuFiber</span></code> is an fictive example of a master integration.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="n">tilelink</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">fiber</span><span class="p">.</span><span class="nc">Fiber</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CpuFiber</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Define a node facing downward (toward slaves only)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="nc">Node</span><span class="p">.</span><span class="n">down</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fiber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Fiber</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Here we force the bus parameters to a specific configurations.</span>
<span class="w">    </span><span class="n">down</span><span class="p">.</span><span class="n">m2s</span><span class="w"> </span><span class="n">forceParameters</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">M2sParameters</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="c1">// We define the traffic of each master using this node. (one master =&gt; one M2sAgent).</span>
<span class="w">      </span><span class="c1">// In our case, there is only the CpuFiber.</span>
<span class="w">      </span><span class="n">masters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">M2sAgent</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CpuFiber</span><span class="p">.</span><span class="bp">this</span><span class="p">,</span><span class="w"> </span><span class="c1">// Reference to the original agent.</span>
<span class="w">          </span><span class="c1">// A agent can use multiple sets of source ID for different purposes.</span>
<span class="w">          </span><span class="c1">// Here we define the usage of every sets of source ID.</span>
<span class="w">          </span><span class="c1">// In our case, let&#39;s say we use ID [0-3] to emit get/putFull requests.</span>
<span class="w">          </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">M2sSource</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SizeMapping</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">emits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">M2sTransfers</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Meaning the get access can be any power of 2 size in [1, 64].</span>
<span class="w">                </span><span class="n">get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">SizeRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">putFull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">SizeRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Let&#39;s say the CPU doesn&#39;t support any slave initiated requests (memory coherency).</span>
<span class="w">    </span><span class="n">down</span><span class="p">.</span><span class="n">s2m</span><span class="p">.</span><span class="n">supported</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="nc">S2mSupport</span><span class="p">.</span><span class="n">none</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Then we can generate some hardware (nothing useful in this example)</span>
<span class="w">    </span><span class="n">down</span><span class="p">.</span><span class="n">bus</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">setIdle</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">down</span><span class="p">.</span><span class="n">bus</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>One particularity of Tilelink, is that it assumes a master will not emit requests to a unmapped memory space.
To allow a master to identify what memory access it is allowed to do, you can use the
<code class="docutils literal notranslate"><span class="pre">spinal.lib.system.tag.MemoryConnection.getMemoryTransfers</span></code> tool as following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">mappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spinal</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="nc">MemoryConnection</span><span class="p">.</span><span class="n">getMemoryTransfers</span><span class="p">(</span><span class="n">down</span><span class="p">)</span><span class="w"></span>
<span class="c1">// Here we just print the values out in stdout, but instead you can generate some</span>
<span class="c1">// hardware from it.</span>
<span class="k">for</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mappings</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="s">s&quot;- </span><span class="si">${</span><span class="n">mapping</span><span class="p">.</span><span class="n">where</span><span class="si">}</span><span class="s"> -&gt; </span><span class="si">${</span><span class="n">mapping</span><span class="p">.</span><span class="n">transfers</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If you run this in the Cpu’s fiber, in the following soc :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CpuFiber</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RamFiber</span><span class="p">()</span><span class="w"></span>
<span class="n">ram</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x200</span><span class="p">)</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">down</span><span class="w"></span>

<span class="c1">// Create a peripherals namespace to keep things clean</span>
<span class="kd">val</span><span class="w"> </span><span class="n">peripherals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Create a intermediate node in the interconnect</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tilelink</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">access</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x20000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">down</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gpioA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GpioFiber</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">gpioA</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x0000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">access</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gpioB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GpioFiber</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">gpioB</span><span class="p">.</span><span class="n">up</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x1000</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">access</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You will get :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">toplevel</span><span class="o">/</span><span class="n">ram_up</span> <span class="n">mapped</span><span class="o">=</span><span class="n">SM</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="n">through</span><span class="o">=</span><span class="n">List</span><span class="p">(</span><span class="n">OT</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">))</span>  <span class="o">-&gt;</span> <span class="n">GF</span>
<span class="o">-</span> <span class="n">toplevel</span><span class="o">/</span><span class="n">peripherals_gpioA_up</span> <span class="n">mapped</span><span class="o">=</span><span class="n">SM</span><span class="p">(</span><span class="mh">0x20000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="n">through</span><span class="o">=</span><span class="n">List</span><span class="p">(</span><span class="n">OT</span><span class="p">(</span><span class="mh">0x20000</span><span class="p">),</span> <span class="n">OT</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>  <span class="o">-&gt;</span> <span class="n">GF</span>
<span class="o">-</span> <span class="n">toplevel</span><span class="o">/</span><span class="n">peripherals_gpioB_up</span> <span class="n">mapped</span><span class="o">=</span><span class="n">SM</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="n">through</span><span class="o">=</span><span class="n">List</span><span class="p">(</span><span class="n">OT</span><span class="p">(</span><span class="mh">0x20000</span><span class="p">),</span> <span class="n">OT</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">))</span>  <span class="o">-&gt;</span> <span class="n">GF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>“through=” specify the chain of address transformations done to reach the target.</p></li>
<li><p>“SM” means SizeMapping(address, size)</p></li>
<li><p>“OT” means OffsetTransformer(offset)</p></li>
</ul>
<p>Note that you can also add PMA (Physical Memory Attributes) to nodes and retrieves them via this getMemoryTransfers utilities.</p>
<p>The currently defined PMA are :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">object</span> <span class="n">MAIN</span>          <span class="n">extends</span> <span class="n">PMA</span>
<span class="nb">object</span> <span class="n">IO</span>            <span class="n">extends</span> <span class="n">PMA</span>
<span class="nb">object</span> <span class="n">CACHABLE</span>      <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">an</span> <span class="n">intermediate</span> <span class="n">agent</span> <span class="n">may</span> <span class="n">have</span> <span class="n">cached</span> <span class="n">a</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="n">region</span> <span class="k">for</span> <span class="n">you</span>
<span class="nb">object</span> <span class="n">TRACEABLE</span>     <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">the</span> <span class="n">region</span> <span class="n">may</span> <span class="n">have</span> <span class="n">been</span> <span class="n">cached</span> <span class="n">by</span> <span class="n">another</span> <span class="n">master</span><span class="p">,</span> <span class="n">but</span> <span class="n">coherence</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">provided</span>
<span class="nb">object</span> <span class="n">UNCACHABLE</span>    <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">the</span> <span class="n">region</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">been</span> <span class="n">cached</span> <span class="n">yet</span><span class="p">,</span> <span class="n">but</span> <span class="n">should</span> <span class="n">be</span> <span class="n">cached</span> <span class="n">when</span> <span class="n">possible</span>
<span class="nb">object</span> <span class="n">IDEMPOTENT</span>    <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">reads</span> <span class="k">return</span> <span class="n">most</span> <span class="n">recently</span> <span class="n">put</span> <span class="n">content</span><span class="p">,</span> <span class="n">but</span> <span class="n">content</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">cached</span>
<span class="nb">object</span> <span class="n">EXECUTABLE</span>    <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">Allows</span> <span class="n">an</span> <span class="n">agent</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">code</span> <span class="kn">from</span> <span class="nn">this</span> <span class="n">region</span>
<span class="nb">object</span> <span class="n">VOLATILE</span>      <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">content</span> <span class="n">may</span> <span class="n">change</span> <span class="n">without</span> <span class="n">a</span> <span class="n">write</span>
<span class="nb">object</span> <span class="n">WRITE_EFFECTS</span> <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">writes</span> <span class="n">produce</span> <span class="n">side</span> <span class="n">effects</span> <span class="ow">and</span> <span class="n">so</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">combined</span><span class="o">/</span><span class="n">delayed</span>
<span class="nb">object</span> <span class="n">READ_EFFECTS</span>  <span class="n">extends</span> <span class="n">PMA</span> <span class="o">//</span> <span class="n">reads</span> <span class="n">produce</span> <span class="n">side</span> <span class="n">effects</span> <span class="ow">and</span> <span class="n">so</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">issued</span> <span class="n">speculatively</span>
</pre></div>
</div>
<p>The getMemoryTransfers utility rely on a dedicated SpinalTag :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trait</span> <span class="n">MemoryConnection</span> <span class="n">extends</span> <span class="n">SpinalTag</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Side</span> <span class="n">toward</span> <span class="n">the</span> <span class="n">masters</span> <span class="n">of</span> <span class="n">the</span> <span class="n">system</span>
  <span class="k">def</span> <span class="nf">up</span> <span class="p">:</span> <span class="n">Nameable</span> <span class="k">with</span> <span class="n">SpinalTagReady</span>

  <span class="o">//</span> <span class="n">Side</span> <span class="n">toward</span> <span class="n">the</span> <span class="n">slaves</span> <span class="n">of</span> <span class="n">the</span> <span class="n">system</span>
  <span class="k">def</span> <span class="nf">down</span> <span class="p">:</span> <span class="n">Nameable</span> <span class="k">with</span> <span class="n">SpinalTagReady</span>

  <span class="o">//</span> <span class="n">Specify</span> <span class="n">the</span> <span class="n">memory</span> <span class="n">mapping</span> <span class="n">of</span> <span class="n">the</span> <span class="n">slave</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">master</span> <span class="n">address</span> <span class="p">(</span><span class="n">before</span> <span class="n">transformers</span> <span class="n">are</span> <span class="n">applied</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">mapping</span> <span class="p">:</span> <span class="n">AddressMapping</span>

  <span class="o">//</span> <span class="n">List</span> <span class="n">of</span> <span class="n">alteration</span> <span class="n">done</span> <span class="n">to</span> <span class="n">the</span> <span class="n">address</span> <span class="n">on</span> <span class="n">this</span> <span class="n">connection</span> <span class="p">(</span><span class="n">ex</span> <span class="n">offset</span><span class="p">,</span> <span class="n">interleaving</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">transformers</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AddressTransformer</span><span class="p">]</span>

  <span class="o">//</span> <span class="n">Convert</span> <span class="n">the</span> <span class="n">slave</span> <span class="n">MemoryTransfers</span> <span class="n">capabilities</span> <span class="n">into</span> <span class="n">the</span> <span class="n">master</span> <span class="n">ones</span>
  <span class="k">def</span> <span class="nf">sToM</span><span class="p">(</span><span class="n">downs</span> <span class="p">:</span> <span class="n">MemoryTransfers</span><span class="p">,</span> <span class="n">args</span> <span class="p">:</span> <span class="n">MappedNode</span><span class="p">)</span> <span class="p">:</span> <span class="n">MemoryTransfers</span> <span class="o">=</span> <span class="n">downs</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That SpinalTag can be used applied to both ends of a given memory bus connection to keep this connection discoverable at elaboration time, creating a graph of MemoryConnection. One good thing about it is that is is bus agnostic, meaning it isn’t tilelink specific.</p>
</section>
<section id="example-widthadapter">
<h5>Example WidthAdapter<a class="headerlink" href="#example-widthadapter" title="Permalink to this heading"></a></h5>
<p>The width adapter is a simple example of bridge.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WidthAdapterFiber</span><span class="p">()</span> <span class="n">extends</span> <span class="n">Area</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">up</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
  <span class="n">val</span> <span class="n">down</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>

  <span class="o">//</span> <span class="n">Populate</span> <span class="n">the</span> <span class="n">MemoryConnection</span> <span class="n">graph</span><span class="o">.</span>
  <span class="n">new</span> <span class="n">MemoryConnection</span> <span class="p">{</span>
    <span class="n">override</span> <span class="k">def</span> <span class="nf">up</span> <span class="o">=</span> <span class="n">up</span>
    <span class="n">override</span> <span class="k">def</span> <span class="nf">down</span> <span class="o">=</span> <span class="n">down</span>
    <span class="n">override</span> <span class="k">def</span> <span class="nf">transformers</span> <span class="o">=</span> <span class="n">Nil</span>
    <span class="n">override</span> <span class="k">def</span> <span class="nf">mapping</span> <span class="o">=</span> <span class="n">SizeMapping</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BigInt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">WidthAdapterFiber</span><span class="o">.</span><span class="n">this</span><span class="o">.</span><span class="n">up</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">addressWidth</span><span class="p">)</span>
    <span class="n">populate</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">Fiber</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">we</span> <span class="n">will</span> <span class="n">negotiate</span> <span class="n">the</span> <span class="n">data</span> <span class="n">width</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="n">generate</span> <span class="n">the</span> <span class="n">hardware</span><span class="o">.</span>
  <span class="n">val</span> <span class="n">logic</span> <span class="o">=</span> <span class="n">Fiber</span> <span class="n">build</span> <span class="n">new</span> <span class="n">Area</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">First</span><span class="p">,</span> <span class="n">we</span> <span class="n">propagate</span> <span class="n">downward</span> <span class="n">the</span> <span class="n">parameter</span> <span class="n">proposal</span><span class="p">,</span> <span class="n">hopping</span> <span class="n">that</span> <span class="n">the</span> <span class="n">downward</span> <span class="n">side</span> <span class="n">will</span> <span class="n">agree</span><span class="o">.</span>
    <span class="n">down</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">proposed</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">proposed</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Second</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">propagate</span> <span class="n">upward</span> <span class="n">what</span> <span class="ow">is</span> <span class="n">actually</span> <span class="n">supported</span><span class="p">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">take</span> <span class="n">care</span> <span class="n">of</span> <span class="nb">any</span>
    <span class="o">//</span> <span class="n">dataWidth</span> <span class="n">mismatch</span><span class="o">.</span>
    <span class="n">up</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">supported</span> <span class="n">load</span> <span class="n">down</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">supported</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
      <span class="n">dataWidth</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">proposed</span><span class="o">.</span><span class="n">dataWidth</span>
    <span class="p">)</span>

    <span class="o">//</span> <span class="n">Third</span><span class="p">,</span> <span class="n">we</span> <span class="n">propagate</span> <span class="n">downward</span> <span class="n">the</span> <span class="n">final</span> <span class="n">bus</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">take</span> <span class="n">care</span> <span class="n">of</span> <span class="nb">any</span> <span class="n">dataWidth</span> <span class="n">mismatch</span><span class="o">.</span>
    <span class="n">down</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">parameters</span> <span class="n">load</span> <span class="n">up</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
      <span class="n">dataWidth</span> <span class="o">=</span> <span class="n">down</span><span class="o">.</span><span class="n">m2s</span><span class="o">.</span><span class="n">supported</span><span class="o">.</span><span class="n">dataWidth</span>
    <span class="p">)</span>

    <span class="o">//</span> <span class="n">No</span> <span class="n">alteration</span> <span class="n">on</span> <span class="n">s2m</span> <span class="n">parameters</span><span class="o">.</span>
    <span class="n">up</span><span class="o">.</span><span class="n">s2m</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">down</span><span class="o">.</span><span class="n">s2m</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Finally</span><span class="p">,</span> <span class="n">we</span> <span class="n">generate</span> <span class="n">the</span> <span class="n">hardware</span><span class="o">.</span>
    <span class="n">val</span> <span class="n">bridge</span> <span class="o">=</span> <span class="n">new</span> <span class="n">tilelink</span><span class="o">.</span><span class="n">WidthAdapter</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">down</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="n">bridge</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">up</span> <span class="o">&lt;&lt;</span> <span class="n">up</span><span class="o">.</span><span class="n">bus</span>
    <span class="n">bridge</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">down</span> <span class="o">&gt;&gt;</span> <span class="n">down</span><span class="o">.</span><span class="n">bus</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/Com/index"></span><section id="com">
<h3>Com<a class="headerlink" href="#com" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/Com/spiXdr"></span><section id="spi-xdr">
<h4>SPI XDR<a class="headerlink" href="#spi-xdr" title="Permalink to this heading"></a></h4>
<p>There is a SPI controller which support :</p>
<ul class="simple">
<li><p>half/full duplex</p></li>
<li><p>single/dual/quad SPI</p></li>
<li><p>SDR/DDR/.. data rate</p></li>
</ul>
<p>You can find its APB3 implementation here :</p>
<p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/68b6158700fc2440ea7980406f927262c004faca/lib/src/main/scala/spinal/lib/com/spi/xdr/Apb3SpiXdrMasterCtrl.scala#L43">https://github.com/SpinalHDL/SpinalHDL/blob/68b6158700fc2440ea7980406f927262c004faca/lib/src/main/scala/spinal/lib/com/spi/xdr/Apb3SpiXdrMasterCtrl.scala#L43</a></p>
<section id="configuration">
<h5>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h5>
<p>Here is an example.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">Apb3SpiXdrMasterCtrl</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpiXdrMasterCtrl</span><span class="p">.</span><span class="nc">MemoryMappingParameters</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpiXdrMasterCtrl</span><span class="p">.</span><span class="nc">Parameters</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="c1">// Each transfer will be 8 bits</span>
<span class="w">      </span><span class="n">timerWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="c1">// The timer is used to slow down the transmission</span>
<span class="w">      </span><span class="n">spi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpiXdrParameter</span><span class="p">(</span><span class="w"> </span><span class="c1">// Specify the physical SPI interface</span>
<span class="w">        </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// Number of physical SPI data pins</span>
<span class="w">        </span><span class="n">ioRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// Specify the number of transfer that each spi pin can do per clock 1 =&gt; SDR, 2 =&gt; DDR</span>
<span class="w">        </span><span class="n">ssWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">// Number of chip selects</span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">addFullDuplex</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// Add support for regular SPI (MISO / MOSI) using the mode id 0</span>
<span class="w">    </span><span class="p">.</span><span class="n">addHalfDuplex</span><span class="p">(</span><span class="w"> </span><span class="c1">// Add another mode</span>
<span class="w">      </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">// mapped on mode id 1</span>
<span class="w">      </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// When rate is 1, the clock will do up to one toggle per cycle, divided by the (timer+1)</span>
<span class="w">                </span><span class="c1">// When rate bigger (ex 2), the controller will ignore the timer, and use the SpiXdrParameter.ioRate</span>
<span class="w">                </span><span class="c1">// capabilities to emit up to &quot;rate&quot; transition per clock cycle.</span>
<span class="w">      </span><span class="n">ddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// sdr =&gt; 1 bit per SPI clock, DDR =&gt; 2 bits per SPI clock</span>
<span class="w">      </span><span class="n">spiWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">// Number of physical SPI data pin used for serialization</span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">cmdFifoDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rspFifoDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">xip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="software-driver">
<h5>Software Driver<a class="headerlink" href="#software-driver" title="Permalink to this heading"></a></h5>
<p>See :</p>
<p><a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/blob/dev-0.3/software/standalone/driver/spi.h">https://github.com/SpinalHDL/SaxonSoc/blob/dev-0.3/software/standalone/driver/spi.h</a>
<a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/blob/dev-0.3/software/standalone/spiDemo/src/main.c">https://github.com/SpinalHDL/SaxonSoc/blob/dev-0.3/software/standalone/spiDemo/src/main.c</a></p>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Com/uart"></span><section id="uart">
<h4>UART<a class="headerlink" href="#uart" title="Permalink to this heading"></a></h4>
<p>The UART protocol could be used, for instance, to emit and receive RS232 / RS485 frames.</p>
<p>There is an example of an 8 bits frame, with no parity and one stop bit :</p>
<img alt="_images/uart.png" src="_images/uart.png" />
<section id="bus-definition">
<h5>Bus definition<a class="headerlink" href="#bus-definition" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Uart</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="c1">// Used to emit frames</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rxd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="c1">// Used to receive frames</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">txd</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">rxd</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uartctrl">
<h5>UartCtrl<a class="headerlink" href="#uartctrl" title="Permalink to this heading"></a></h5>
<p>An Uart controller is implemented in the library. This controller has the specificity to use a sampling window to read the <code class="docutils literal notranslate"><span class="pre">rxd</span></code> pin and then to using an majority vote to filter its value.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>IO name</p></th>
<th class="head"><p>direction</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>config</p></td>
<td><p>in</p></td>
<td><p>UartCtrlConfig</p></td>
<td><p>Used to set the clock divider/parity/stop/data length of the controller</p></td>
</tr>
<tr class="row-odd"><td><p>write</p></td>
<td><p>slave</p></td>
<td><p>Stream[Bits]</p></td>
<td><p>Stream port used to request a frame transmission</p></td>
</tr>
<tr class="row-even"><td><p>read</p></td>
<td><p>master</p></td>
<td><p>Flow[Bits]</p></td>
<td><p>Flow port used to receive decoded frames</p></td>
</tr>
<tr class="row-odd"><td><p>uart</p></td>
<td><p>master</p></td>
<td><p>Uart</p></td>
<td><p>Interface to the real world</p></td>
</tr>
</tbody>
</table>
<p>The controller could be instantiated via an <code class="docutils literal notranslate"><span class="pre">UartCtrlGenerics</span></code> configuration object :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dataWidthMax</p></td>
<td><p>Int</p></td>
<td><p>Maximal number of bit inside a frame</p></td>
</tr>
<tr class="row-odd"><td><p>clockDividerWidth</p></td>
<td><p>Int</p></td>
<td><p>Width of the internal clock divider</p></td>
</tr>
<tr class="row-even"><td><p>preSamplingSize</p></td>
<td><p>Int</p></td>
<td><p>Specify how many samplingTick are drop at the beginning of a UART baud</p></td>
</tr>
<tr class="row-odd"><td><p>samplingSize</p></td>
<td><p>Int</p></td>
<td><p>Specify how many samplingTick are used to sample <code class="docutils literal notranslate"><span class="pre">rxd</span></code> values in the middle of the UART baud</p></td>
</tr>
<tr class="row-even"><td><p>postSamplingSize</p></td>
<td><p>Int</p></td>
<td><p>Specify how many samplingTick are drop at the end of a UART baud</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Com/usb_device"></span><section id="usb-device">
<h4>USB device<a class="headerlink" href="#usb-device" title="Permalink to this heading"></a></h4>
<p>Here exists a USB device controller in the SpinalHDL library.</p>
<p>A few bullet points to summarize support:</p>
<ul class="simple">
<li><p>Implemented to allow a CPU to configure and manage the endpoints</p></li>
<li><p>A internal ram which store the endpoints states and transactions descriptors</p></li>
<li><p>Up to 16 endpoints (for virtually no price)</p></li>
<li><p>Support USB host full speed (12 Mbps)</p></li>
<li><p>Test on linux using its own driver (<a class="reference external" href="https://github.com/SpinalHDL/linux/blob/dev/drivers/usb/gadget/udc/spinal_udc.c">https://github.com/SpinalHDL/linux/blob/dev/drivers/usb/gadget/udc/spinal_udc.c</a>)</p></li>
<li><p>Bmb memory interface for the configuration</p></li>
<li><p>Require a clock for the internal phy which is a multiple of 12 Mhz at least 48 Mhz</p></li>
<li><p>The controller frequency is not restricted</p></li>
<li><p>No external phy required</p></li>
</ul>
<p>Linux gadget tested and functional :</p>
<ul class="simple">
<li><p>Serial connection</p></li>
<li><p>Ethernet connection</p></li>
<li><p>Mass storage (~8 Mbps on ArtyA7 linux)</p></li>
</ul>
<p>Deployments :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/digilent/ArtyA7SmpLinux">https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/digilent/ArtyA7SmpLinux</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/radiona/ulx3s/smp">https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/radiona/ulx3s/smp</a></p></li>
</ul>
<section id="architecture">
<h5>Architecture<a class="headerlink" href="#architecture" title="Permalink to this heading"></a></h5>
<p>The controller is composed of :</p>
<ul class="simple">
<li><p>A few control registers</p></li>
<li><p>A internal ram used to store the endpoint status, the transfer descriptors and the endpoint 0 SETUP data.</p></li>
</ul>
<p>A linked list of descriptors for each endpoint in order to handle the USB IN/OUT transactions and data.</p>
<p>The endpoint 0 manage the IN/OUT transactions like all the other endpoints but has some additional hardware to manage the SETUP transactions :</p>
<ul class="simple">
<li><p>Its linked list is cleared on each setup transactions</p></li>
<li><p>The data from the SETUP transaction is stored in a fixed location (SETUP_DATA)</p></li>
<li><p>It has a specific interrupt flag for SETUP transactions</p></li>
</ul>
</section>
<section id="registers">
<h5>Registers<a class="headerlink" href="#registers" title="Permalink to this heading"></a></h5>
<p>Note that all registers and memories of the controller are only accessible in 32 bits word access, bytes access isn’t supported.</p>
<section id="frame-0xff00">
<h6>FRAME (0xFF00)<a class="headerlink" href="#frame-0xff00" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbFrameId</p></td>
<td><p>RO</p></td>
<td><p>31-0</p></td>
<td><p>Current usb frame id</p></td>
</tr>
</tbody>
</table>
</section>
<section id="address-0xff04">
<h6>ADDRESS (0xFF04)<a class="headerlink" href="#address-0xff04" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>address</p></td>
<td><p>WO</p></td>
<td><p>6-0</p></td>
<td><p>The device will only listen at tokens with the specified address
This field is automatically cleared on usb reset events</p></td>
</tr>
<tr class="row-odd"><td><p>enable</p></td>
<td><p>WO</p></td>
<td><p>8</p></td>
<td><p>Enable the USB address filtering if set</p></td>
</tr>
<tr class="row-even"><td><p>trigger</p></td>
<td><p>WO</p></td>
<td><p>9</p></td>
<td><p>Set the enable (see above) on the next EP0 IN token completion
Cleared by the hardware after any EP0 completion</p></td>
</tr>
</tbody>
</table>
<p>The idea here is to keep the whole register cleared until a USB SET_ADDRESS setup packet is received on EP0.
At that moment, you can set the address and the trigger field, then provide the IN zero length descriptor to EP0 to
finalize the SET_ADDRESS sequence. The controller will then automatically turn on the address filtering at the completion of that descriptor.</p>
</section>
<section id="interrupt-0xff08">
<h6>INTERRUPT (0xFF08)<a class="headerlink" href="#interrupt-0xff08" title="Permalink to this heading"></a></h6>
<p>Individual bits of this register can be cleared by writing ‘1’ in them.
Reading this register returns the current interrupt status.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>endpoints</p></td>
<td><p>W1C</p></td>
<td><p>15-0</p></td>
<td><p>Raised when an endpoint generates an interrupt</p></td>
</tr>
<tr class="row-odd"><td><p>reset</p></td>
<td><p>W1C</p></td>
<td><p>16</p></td>
<td><p>Raised when a USB reset occurs</p></td>
</tr>
<tr class="row-even"><td><p>ep0Setup</p></td>
<td><p>W1C</p></td>
<td><p>17</p></td>
<td><p>Raised when endpoint 0 receives a setup transaction</p></td>
</tr>
<tr class="row-odd"><td><p>suspend</p></td>
<td><p>W1C</p></td>
<td><p>18</p></td>
<td><p>Raised when a USB suspend occurs</p></td>
</tr>
<tr class="row-even"><td><p>resume</p></td>
<td><p>W1C</p></td>
<td><p>19</p></td>
<td><p>Raised when a USB resume occurs</p></td>
</tr>
<tr class="row-odd"><td><p>disconnect</p></td>
<td><p>W1C</p></td>
<td><p>20</p></td>
<td><p>Raised when a USB disconnect occurs</p></td>
</tr>
</tbody>
</table>
</section>
<section id="halt-0xff0c">
<h6>HALT (0xFF0C)<a class="headerlink" href="#halt-0xff0c" title="Permalink to this heading"></a></h6>
<p>This register allows placement of a single endpoint into a dormant state in order to ensure atomicity of CPU operations, allowing to do things as read/modify/write on the endpoint registers and descriptors.
The peripheral will return NAK if the given endpoint is addressed by the usb host while halt is enabled and the endpoint is enabled.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>endpointId</p></td>
<td><p>WO</p></td>
<td><p>3-0</p></td>
<td><p>The endpoint you want to put in sleep</p></td>
</tr>
<tr class="row-odd"><td><p>enable</p></td>
<td><p>WO</p></td>
<td><p>4</p></td>
<td><p>When set halt is active, when clear endpoint is unhalted.</p></td>
</tr>
<tr class="row-even"><td><p>effective
enable</p></td>
<td><p>RO</p></td>
<td><p>5</p></td>
<td><p>After setting the enable, you need to wait for this bit to be
set by the hardware itself to ensure atomicity</p></td>
</tr>
</tbody>
</table>
</section>
<section id="config-0xff10">
<h6>CONFIG (0xFF10)<a class="headerlink" href="#config-0xff10" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pullupSet</p></td>
<td><p>SO</p></td>
<td><p>0</p></td>
<td><p>Write ‘1’ to enable the USB device pullup on the dp pin</p></td>
</tr>
<tr class="row-odd"><td><p>pullupClear</p></td>
<td><p>SO</p></td>
<td><p>1</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>interruptEnableSet</p></td>
<td><p>SO</p></td>
<td><p>2</p></td>
<td><p>Write ‘1’ to let the present and future interrupt happening</p></td>
</tr>
<tr class="row-odd"><td><p>interruptEnableClear</p></td>
<td><p>SO</p></td>
<td><p>3</p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="info-0xff20">
<h6>INFO (0xFF20)<a class="headerlink" href="#info-0xff20" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ramSize</p></td>
<td><p>RO</p></td>
<td><p>3-0</p></td>
<td><p>The internal ram will have (1 &lt;&lt; this) bytes</p></td>
</tr>
</tbody>
</table>
</section>
<section id="endpoints-0x0000-0x003f">
<h6>ENDPOINTS (0x0000 - 0x003F)<a class="headerlink" href="#endpoints-0x0000-0x003f" title="Permalink to this heading"></a></h6>
<p>The endpoints status are stored at the beginning of the internal ram over one 32 bits word each.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>enable</p></td>
<td><p>RW</p></td>
<td><p>0</p></td>
<td><p>If not set, the endpoint will ignore all the traffic</p></td>
</tr>
<tr class="row-odd"><td><p>stall</p></td>
<td><p>RW</p></td>
<td><p>1</p></td>
<td><p>If set, the endpoint will always return STALL status</p></td>
</tr>
<tr class="row-even"><td><p>nack</p></td>
<td><p>RW</p></td>
<td><p>2</p></td>
<td><p>If set, the endpoint will always return NACK status</p></td>
</tr>
<tr class="row-odd"><td><p>dataPhase</p></td>
<td><p>RW</p></td>
<td><p>3</p></td>
<td><p>Specify the IN/OUT data PID used. ‘0’ =&gt; DATA0.
This field is also updated by the controller.</p></td>
</tr>
<tr class="row-even"><td><p>head</p></td>
<td><p>RW</p></td>
<td><p>15-4</p></td>
<td><p>Specify the current descriptor head (linked list).
0 =&gt; empty list, byte address = this &lt;&lt; 4</p></td>
</tr>
<tr class="row-odd"><td><p>isochronous</p></td>
<td><p>RW</p></td>
<td><p>16</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>maxPacketSize</p></td>
<td><p>RW</p></td>
<td><p>31-22</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>To get a endpoint responsive you need :</p>
<ul class="simple">
<li><p>Set its enable flag to 1</p></li>
</ul>
<p>Then the there is a few cases :
- Either you have the stall or nack flag set, and so, the controller will always respond with the corresponding responses
- Either, for EP0 setup request, the controller will not use descriptors, but will instead write the data into the SETUP_DATA register, and ACK
- Either you have a empty linked list (head==0) in which case it will answer NACK
- Either you have at least one descriptor pointed by head, in which case it will execute it and ACK if all was going smooth</p>
</section>
<section id="setup-data-0x0040-0x0047">
<h6>SETUP_DATA (0x0040 - 0x0047)<a class="headerlink" href="#setup-data-0x0040-0x0047" title="Permalink to this heading"></a></h6>
<p>When endpoint 0 receives a SETUP transaction, the data of the transaction will be stored in this location.</p>
</section>
</section>
<section id="descriptors">
<h5>Descriptors<a class="headerlink" href="#descriptors" title="Permalink to this heading"></a></h5>
<p>Descriptors allows to specify how an endpoint needs to handle the data phase of IN/OUT transactions.
They are stored in the internal ram, can be linked together via their linked lists and need to be aligned on 16 bytes boundaries</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Word</p></th>
<th class="head"><p>Bits</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>offset</p></td>
<td><p>0</p></td>
<td><p>15-0</p></td>
<td><p>Specify the current progress in the transfer (in byte)</p></td>
</tr>
<tr class="row-odd"><td><p>code</p></td>
<td><p>0</p></td>
<td><p>19-16</p></td>
<td><p>0xF =&gt; in progress, 0x0 =&gt; success</p></td>
</tr>
<tr class="row-even"><td><p>next</p></td>
<td><p>1</p></td>
<td><p>15-4</p></td>
<td><p>Pointer to the next descriptor
0 =&gt; nothing, byte address = this &lt;&lt; 4</p></td>
</tr>
<tr class="row-odd"><td><p>length</p></td>
<td><p>1</p></td>
<td><p>31-16</p></td>
<td><p>Number of bytes allocated for the data field</p></td>
</tr>
<tr class="row-even"><td><p>direction</p></td>
<td><p>2</p></td>
<td><p>16</p></td>
<td><p>‘0’ =&gt; OUT, ‘1’ =&gt; IN</p></td>
</tr>
<tr class="row-odd"><td><p>interrupt</p></td>
<td><p>2</p></td>
<td><p>17</p></td>
<td><p>If set, the completion of the descriptor will generate an
interrupt.</p></td>
</tr>
<tr class="row-even"><td><p>completionOnFull</p></td>
<td><p>2</p></td>
<td><p>18</p></td>
<td><p>Normally, a descriptor completion only occurs when a USB transfer
is smaller than the maxPacketSize. But if this field is set,
then when the descriptor become full is also a considered
as a completion event. (offset == length)</p></td>
</tr>
<tr class="row-odd"><td><p>data1OnCompletion</p></td>
<td><p>2</p></td>
<td><p>19</p></td>
<td><p>force the endpoint dataPhase to DATA1 on the completion of the
descriptor</p></td>
</tr>
<tr class="row-even"><td><p>data</p></td>
<td><p>…</p></td>
<td><p>…</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>Note, if the controller receives a frame where the IN/OUT does not match the descriptor IN/OUT, the frame will be ignored.</p>
<p>Also, to initialize a descriptor, the CPU should set the code field to 0xF</p>
</section>
<section id="usage">
<h5>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="nn">bmb</span><span class="p">.</span><span class="nc">BmbParameter</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">phy</span><span class="p">.</span><span class="nc">UsbDevicePhyNative</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="nc">UsbLsFsPhyAbstractIoAgent</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">udc</span><span class="p">.{</span><span class="nc">UsbDeviceCtrl</span><span class="p">,</span><span class="w"> </span><span class="nc">UsbDeviceCtrlParameter</span><span class="p">}</span>


<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UsbDeviceTop</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ctrlCd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;ctrlCd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phyCd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;phyCd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">48</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrlCd</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UsbDeviceCtrl</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UsbDeviceCtrlParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bmbParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BmbParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UsbDeviceCtrl</span><span class="p">.</span><span class="n">ctrlAddressWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">sourceWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">contextWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">lengthWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phyCd</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UsbDevicePhyNative</span><span class="p">(</span><span class="n">sim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">cc</span><span class="p">(</span><span class="n">ctrlCd</span><span class="p">,</span><span class="w"> </span><span class="n">phyCd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">ctrl</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bmb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">usb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">power</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">pullup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pullup</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">toIo</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">object</span><span class="w"> </span><span class="nc">UsbDeviceGen</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">UsbDeviceTop</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Com/usb_ohci"></span><section id="usb-ohci">
<h4>USB OHCI<a class="headerlink" href="#usb-ohci" title="Permalink to this heading"></a></h4>
<p>Here exists a USB OHCi controller (host) in the SpinalHDL library.</p>
<p>A few bullet points to summarize support:</p>
<ul class="simple">
<li><p>It follow the <cite>OpenHCI Open Host Controller Interface Specification for USB</cite> specification (OHCI).</p></li>
<li><p>It is compatible with the upstream linux / uboot OHCI drivers already. (there is also an OHCI driver on tinyUSB)</p></li>
<li><p>This provides USB host full speed and low speed capabilities (12 Mbps and 1.5 Mbps)</p></li>
<li><p>Tested on linux and uboot</p></li>
<li><p>One controller can host multiple ports (up to 16)</p></li>
<li><p>Bmb memory interface for DMA accesses</p></li>
<li><p>Bmb memory interface for the configuration</p></li>
<li><p>Requires a clock for the internal phy which is a multiple of 12 Mhz at least 48 Mhz</p></li>
<li><p>The controller frequency is not restricted</p></li>
<li><p>No external phy required</p></li>
</ul>
<p>Devices tested and functional :</p>
<ul class="simple">
<li><p>Mass storage (~8 Mbps on ArtyA7 linux)</p></li>
<li><p>Keyboard / Mouse</p></li>
<li><p>Audio output</p></li>
<li><p>Hub</p></li>
</ul>
<p>Limitations :</p>
<ul class="simple">
<li><p>Some USB hub (had one so far) do not like having a full speed host with low speed devices attached.</p></li>
<li><p>Some modern devices will not work on USB full speed (ex :  Gbps ethernet adapter)</p></li>
<li><p>Require memory coherency with the CPU (or the cpu need to be able to flush its data cache in the driver)</p></li>
</ul>
<p>Deployments :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/digilent/ArtyA7SmpLinux">https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/digilent/ArtyA7SmpLinux</a></p></li>
<li><p><a class="reference external" href="https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/radiona/ulx3s/smp">https://github.com/SpinalHDL/SaxonSoc/tree/dev-0.3/bsp/radiona/ulx3s/smp</a></p></li>
</ul>
<section id="usage">
<h5>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="nn">bmb</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="nn">bmb</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">bus</span><span class="p">.</span><span class="nn">misc</span><span class="p">.</span><span class="nc">SizeMapping</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">ohci</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">phy</span><span class="p">.</span><span class="nc">UsbHubLsFs</span><span class="p">.</span><span class="nc">CtrlCc</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">com</span><span class="p">.</span><span class="nn">usb</span><span class="p">.</span><span class="nn">phy</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UsbOhciTop</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UsbOhciParameter</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ohci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UsbOhci</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nc">BmbParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">sourceWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">contextWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">lengthWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phyCd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;phyCd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">48</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phyCd</span><span class="p">(</span><span class="nc">UsbLsFsPhy</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">portCount</span><span class="p">,</span><span class="w"> </span><span class="n">sim</span><span class="o">=</span><span class="kc">true</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phyCc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CtrlCc</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">portCount</span><span class="p">,</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">phyCd</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">phyCc</span><span class="p">.</span><span class="n">input</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ohci</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">phy</span><span class="w"></span>
<span class="w">  </span><span class="n">phyCc</span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">ctrl</span><span class="w"></span>

<span class="w">  </span><span class="c1">// propagate io signals</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ohci</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">toIo</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ohci</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">toIo</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ohci</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">.</span><span class="n">toIo</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">usb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">toIo</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">management</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phy</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">management</span><span class="p">.</span><span class="n">toIo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">UsbHostGen</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UsbOhciParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">noPowerSwitching</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">powerSwitchingMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">noOverCurrentProtection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">powerOnToPowerGoodTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="c1">// DMA data width, up to 128</span>
<span class="w">    </span><span class="n">portsConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">4</span><span class="p">)(</span><span class="nc">OhciPortParameter</span><span class="p">())</span><span class="w"> </span><span class="c1">// 4 Ports</span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">UsbOhciTop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/IO/index"></span><section id="io">
<h3>IO<a class="headerlink" href="#io" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/IO/readableOpenDrain"></span><section id="readableopendrain">
<h4>ReadableOpenDrain<a class="headerlink" href="#readableopendrain" title="Permalink to this heading"></a></h4>
<p>The ReadableOpenDrain bundle is defined as following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ReadableOpenDrain</span><span class="p">[</span><span class="nc">T</span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">HardType</span><span class="p">[</span><span class="nc">T</span><span class="p">])</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="p">,</span><span class="n">read</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataType</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">write</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">read</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then, as a master, you can use the <code class="docutils literal notranslate"><span class="pre">read</span></code> signal to read the outside value and use the <code class="docutils literal notranslate"><span class="pre">write</span></code> to set the value that you want to drive on the output.</p>
<p>There is an example of usage :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">ReadableOpenDrain</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x12345678</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Libraries/IO/tristate"></span><section id="tristate">
<span id="section-tristate"></span><h4>TriState<a class="headerlink" href="#tristate" title="Permalink to this heading"></a></h4>
<p>Tri-state signals are difficult to handle in many cases:</p>
<ul class="simple">
<li><p>They are not really kind of digital things</p></li>
<li><p>And except for IO, they aren’t used for digital design</p></li>
<li><p>The tristate concept doesn’t fit naturally in the SpinalHDL internal graph.</p></li>
</ul>
<p>SpinalHDL provides two different abstractions for tristate signals. The <code class="docutils literal notranslate"><span class="pre">TriState</span></code> bundle and <a class="reference internal" href="index.html#section-analog-and-inout"><span class="std std-ref">Analog and inout</span></a> signals.
Both serve different purposes:</p>
<ul class="simple">
<li><p>TriState should be used for most purposes, especially within a design. The bundle contains an additional signal to carry the current direction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Analog</span></code> and <code class="docutils literal notranslate"><span class="pre">inout</span></code> should be used for drivers on the device boundary and in some other special cases. See the referenced documentation page for more details.</p></li>
</ul>
<p>As stated above, the recommended approach is to use <code class="docutils literal notranslate"><span class="pre">TriState</span></code> within a design. On the top-level the <code class="docutils literal notranslate"><span class="pre">TriState</span></code> bundle is then assigned to an analog inout to get the
synthesis tools to infer the correct I/O driver. This can be done automatically done via the <a class="reference internal" href="index.html#section-analog-and-inout"><span class="std std-ref">InOutWrapper</span></a> or manually if needed.</p>
<section id="id1">
<h5>TriState<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h5>
<p>The TriState bundle is defined as following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TriState</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">HardType</span><span class="p">[</span><span class="nc">T</span><span class="p">])</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">read</span><span class="p">,</span><span class="n">write</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataType</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">writeEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">write</span><span class="p">,</span><span class="n">writeEnable</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">read</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>A master can use the <code class="docutils literal notranslate"><span class="pre">read</span></code> signal to read the outside value, the <code class="docutils literal notranslate"><span class="pre">writeEnable</span></code> to enable the output,
and finally use <code class="docutils literal notranslate"><span class="pre">write</span></code> to set the value that is driven on the output.</p>
<p>There is an example of usage:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">TriState</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">writeEnable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x12345678</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="tristatearray">
<h5>TriStateArray<a class="headerlink" href="#tristatearray" title="Permalink to this heading"></a></h5>
<p>In some case, you need to have the control over the output enable of each individual pin (Like for GPIO). In this range of cases, you can use the TriStateArray bundle.</p>
<p>It is defined as following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TriStateArray</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BitCount</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">read</span><span class="p">,</span><span class="n">write</span><span class="p">,</span><span class="n">writeEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">write</span><span class="p">,</span><span class="n">writeEnable</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">read</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It is the same than the TriState bundle, except that the <code class="docutils literal notranslate"><span class="pre">writeEnable</span></code> is an Bits to control each output buffer.</p>
<p>There is an example of usage :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">TriStateArray</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">writeEnable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x87654321</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x12345678</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">dataBus</span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/Graphics/index"></span><section id="graphics">
<h3>Graphics<a class="headerlink" href="#graphics" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/Graphics/colors"></span><section id="colors">
<h4>Colors<a class="headerlink" href="#colors" title="Permalink to this heading"></a></h4>
<section id="rgb">
<h5>RGB<a class="headerlink" href="#rgb" title="Permalink to this heading"></a></h5>
<p>You can use an Rgb bundle to model colors in hardware. This Rgb bundle take as parameter an RgbConfig classes which specify the number of bits for each channels :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">(</span><span class="n">rWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="n">gWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="n">bWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bWidth</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">gWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">bWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Those classes could be used as following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"></span>
<span class="n">color</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">31</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Graphics/vga"></span><section id="vga">
<h4>VGA<a class="headerlink" href="#vga" title="Permalink to this heading"></a></h4>
<section id="vga-bus">
<h5>VGA bus<a class="headerlink" href="#vga-bus" title="Permalink to this heading"></a></h5>
<p>An VGA bus definition is available via the Vga bundle.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Vga</span><span class="w"> </span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w">  </span><span class="c1">// High when the frame is inside the color area</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">asOutput</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="vga-timings">
<h5>VGA timings<a class="headerlink" href="#vga-timings" title="Permalink to this heading"></a></h5>
<p>VGA timings could be modeled in hardware by using an VgaTimings bundle :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">syncStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">syncEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimings</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">setAs_h640_v480_r60</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactory</span><span class="p">,</span><span class="n">baseAddress</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="vga-controller">
<h5>VGA controller<a class="headerlink" href="#vga-controller" title="Permalink to this heading"></a></h5>
<p>An VGA controller is available. Its definition is the following :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaCtrl</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">,</span><span class="w"> </span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">softReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">timings</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">VgaTimings</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">frameStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pixels</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="nc">Rgb</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">vga</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Vga</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">error</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">frameStart</span></code> is a signals that pulse one cycle at the beginning of each new frame.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">pixels</span></code> is a stream of color used to feed the VGA interface when needed.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">error</span></code> is high when a transaction on the pixels is needed, but nothing is present.</div>
</div>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/EDA/index"></span><section id="eda">
<h3>EDA<a class="headerlink" href="#eda" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/EDA/altera/qsysify"></span><section id="qsysify">
<h4>QSysify<a class="headerlink" href="#qsysify" title="Permalink to this heading"></a></h4>
<p>QSysify is a tool which is able to generate a QSys IP (tcl script) from a SpinalHDL component by analyzing its IO definition. It currently implement the following interfaces features :</p>
<ul class="simple">
<li><p>Master/Slave AvalonMM</p></li>
<li><p>Master/Slave APB3</p></li>
<li><p>Clock domain input</p></li>
<li><p>Reset output</p></li>
<li><p>Interrupt input</p></li>
<li><p>Conduit (Used in last resort)</p></li>
</ul>
<section id="example">
<h5>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h5>
<p>In the case of a UART controller :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">AvalonMMUartCtrl</span><span class="p">(...)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">slave</span><span class="p">(</span><span class="nc">AvalonMM</span><span class="p">(</span><span class="nc">AvalonMMUartCtrl</span><span class="p">.</span><span class="n">getAvalonMMConfig</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Uart</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The following  <code class="docutils literal notranslate"><span class="pre">main</span></code> will generate the Verilog and the QSys TCL script with io.bus as an AvalonMM and io.uart as a conduit :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">AvalonMMUartCtrl</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Generate the Verilog</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">toplevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="nc">AvalonMMUartCtrl</span><span class="p">(</span><span class="nc">UartCtrlMemoryMappedConfig</span><span class="p">(...))).</span><span class="n">toplevel</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add some tags to the avalon bus to specify it&#39;s clock domain (information used by QSysify)</span>
<span class="w">    </span><span class="n">toplevel</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">bus</span><span class="w"> </span><span class="n">addTag</span><span class="p">(</span><span class="nc">ClockDomainTag</span><span class="p">(</span><span class="n">toplevel</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Generate the QSys IP (tcl script)</span>
<span class="w">    </span><span class="nc">QSysify</span><span class="p">(</span><span class="n">toplevel</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="tags">
<h5>tags<a class="headerlink" href="#tags" title="Permalink to this heading"></a></h5>
<p>Because QSys require some information that are not specified in the SpinalHDL hardware specification, some tags should be added to interface:</p>
<section id="avalonmm-apb3">
<h6>AvalonMM / APB3<a class="headerlink" href="#avalonmm-apb3" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="p">.</span><span class="n">bus</span><span class="w"> </span><span class="n">addTag</span><span class="p">(</span><span class="nc">ClockDomainTag</span><span class="p">(</span><span class="n">busClockDomain</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="interrupt-input">
<h6>Interrupt input<a class="headerlink" href="#interrupt-input" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="w"> </span><span class="n">addTag</span><span class="p">(</span><span class="nc">InterruptReceiverTag</span><span class="p">(</span><span class="n">relatedMemoryInterfacei</span><span class="p">,</span><span class="w"> </span><span class="n">interruptClockDomain</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="reset-output">
<h6>Reset output<a class="headerlink" href="#reset-output" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="p">.</span><span class="n">resetOutput</span><span class="w"> </span><span class="n">addTag</span><span class="p">(</span><span class="nc">ResetEmitterTag</span><span class="p">(</span><span class="n">resetOutputClockDomain</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="adding-new-interface-support">
<h5>Adding new interface support<a class="headerlink" href="#adding-new-interface-support" title="Permalink to this heading"></a></h5>
<p>Basically, the QSysify tool can be setup with a list of interface <code class="docutils literal notranslate"><span class="pre">emitter</span></code> <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/764193013f84cfe4f82d7d1f1739c4561ef65860/lib/src/main/scala/spinal/lib/eda/altera/QSys.scala#L12">(as you can see here)</a></p>
<p>You can create your own emitter by creating a new class extending <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/764193013f84cfe4f82d7d1f1739c4561ef65860/lib/src/main/scala/spinal/lib/eda/altera/QSys.scala#L24">QSysifyInterfaceEmiter</a></p>
</section>
</section>
<span id="document-SpinalHDL/Libraries/EDA/altera/quartus_flow"></span><section id="quartusflow">
<h4>QuartusFlow<a class="headerlink" href="#quartusflow" title="Permalink to this heading"></a></h4>
<p>A compilation flow is an Altera-defined sequence of commands that use a combination of command-line executables.
A full compilation flow launches all Compiler modules in sequence to synthesize, fit, analyze final timing, and generate a device programming file.</p>
<p>Tools in <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/dev/lib/src/main/scala/spinal/lib/eda/altera/QuartusFlow.scala">this file</a> help you get rid of redundant Quartus GUI.</p>
<section id="for-a-single-rtl-file">
<h5>For a single rtl file<a class="headerlink" href="#for-a-single-rtl-file" title="Permalink to this heading"></a></h5>
<p>The object <code class="docutils literal notranslate"><span class="pre">spinal.lib.eda.altera.QuartusFlow</span></code> can automatically report the used area and maximum frequency of a single rtl file.</p>
<section id="example">
<h6>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">QuartusFlow</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">quartusPath</span><span class="o">=</span><span class="s">&quot;/eda/intelFPGA_lite/17.0/quartus/bin/&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">workspacePath</span><span class="o">=</span><span class="s">&quot;/home/spinalvm/tmp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">toplevelPath</span><span class="o">=</span><span class="s">&quot;TopLevel.vhd&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">family</span><span class="o">=</span><span class="s">&quot;Cyclone V&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">device</span><span class="o">=</span><span class="s">&quot;5CSEMA5F31C6&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">frequencyTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nc">MHz</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="n">report</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>The code above will create a new Quartus project with <code class="docutils literal notranslate"><span class="pre">TopLevel.vhd</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This operation will remove the folder <code class="docutils literal notranslate"><span class="pre">workspacePath</span></code>!</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">family</span></code> and <code class="docutils literal notranslate"><span class="pre">device</span></code> values are passed straight to the Quartus CLI as parameters. Please check the Quartus documentation for the correct value to use in your project.</p>
</div>
</section>
<section id="tip">
<h6>Tip<a class="headerlink" href="#tip" title="Permalink to this heading"></a></h6>
<p>To test a component that has too many pins, set them as <code class="docutils literal notranslate"><span class="pre">VIRTUAL_PIN</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">miaou</span><span class="p">:</span><span class="w"> </span><span class="nc">Vec</span><span class="p">[</span><span class="nc">Flow</span><span class="p">[</span><span class="nc">Bool</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">master</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())),</span><span class="w"> </span><span class="mi">666</span><span class="p">)</span><span class="w"></span>
<span class="n">miaou</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="s">&quot;altera_attribute&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-name VIRTUAL_PIN ON&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="for-an-existing-project">
<h5>For an existing project<a class="headerlink" href="#for-an-existing-project" title="Permalink to this heading"></a></h5>
<p>The class <code class="docutils literal notranslate"><span class="pre">spinal.lib.eda.altera.QuartusProject</span></code> can automatically find configuration files in an existing project. Those are used for compilation and programming the device.</p>
<section id="id1">
<h6>Example<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h6>
<p>Specify the path that contains your project files like <code class="docutils literal notranslate"><span class="pre">.qpf</span></code> and <code class="docutils literal notranslate"><span class="pre">.cdf</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">prj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">QuartusProject</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">quartusPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;F:/intelFPGA_lite/20.1/quartus/bin64/&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">workspacePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;G:/&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">prj</span><span class="p">.</span><span class="n">compile</span><span class="p">()</span><span class="w"></span>
<span class="n">prj</span><span class="p">.</span><span class="n">program</span><span class="p">()</span><span class="w">  </span><span class="c1">// automatically find Chain Description File of the project</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember to save the <code class="docutils literal notranslate"><span class="pre">.cdf</span></code> of your project before calling <code class="docutils literal notranslate"><span class="pre">prj.program()</span></code>.</p>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/Pipeline/index"></span><section id="pipeline">
<h3>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/Pipeline/introduction"></span><section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">spinal.lib.misc.pipeline</span></code> provides a pipelining API. The main advantages over manual pipelining are :</p>
<ul class="simple">
<li><p>You don’t have to predefine all the signal elements needed for the entire staged system upfront. You can create and consume stageable signals in a more ad hoc fashion as your design requires - without needing to refactor all the intervening stages to know about the signal</p></li>
<li><p>Signals of the pipeline can utilize the powerful parametrization capabilities of SpinalHDL and be subject to optimization/removal if a specific design build does not require a particular parametrized feature, without any need to modify the staging system design or project code base in a significant way.</p></li>
<li><p>Manual retiming is much easier, as you don’t have to handle the registers / arbitration manually</p></li>
<li><p>Manage the arbitration by itself</p></li>
</ul>
<p>The API is composed of 4 main things :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Node</span></code> : which represents a layer in the pipeline</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Link</span></code> : which allows to connect nodes to each other</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Builder</span></code> : which will generate the hardware required for a whole pipeline</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Payload</span></code> : which are used to retrieve hardware signals on nodes along the pipeline</p></li>
</ul>
<p>It is important to understand that <code class="docutils literal notranslate"><span class="pre">Payload</span></code> isn’t a hardware data/signal instance,
but a key to retrieve a data/signal on nodes along the pipeline, and that the pipeline builder
will then automatically interconnect/pipeline every occurrence of a given <code class="docutils literal notranslate"><span class="pre">Payload</span></code> between nodes.</p>
<p>Here is an example to illustrate :</p>
<a class="reference internal image-reference" href="_images/intro_pip.png"><img alt="_images/intro_pip.png" src="_images/intro_pip.png" style="width: 251.99999999999997px; height: 331.79999999999995px;" /></a>
<p>Here is a video about this API :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=74h_-FMWWIM">https://www.youtube.com/watch?v=74h_-FMWWIM</a></p></li>
</ul>
<section id="simple-example">
<h5>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this heading"></a></h5>
<p>Here is a simple example which only uses the basics of the API :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">misc</span><span class="p">.</span><span class="nn">pipeline</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s define 3 Nodes for our pipeline</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s connect those nodes by using simples registers</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">s01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">s12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s define a few Payload things that can go through the pipeline</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RESULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s bind io.up to n0</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n0</span><span class="p">.</span><span class="n">ready</span><span class="w"></span>
<span class="w">  </span><span class="n">n0</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">  </span><span class="n">n0</span><span class="p">(</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s do some processing on n1</span>
<span class="w">  </span><span class="n">n1</span><span class="p">(</span><span class="nc">RESULT</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n1</span><span class="p">(</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1200</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s bind n2 to io.down</span>
<span class="w">  </span><span class="n">n2</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">.</span><span class="n">ready</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n2</span><span class="p">(</span><span class="nc">RESULT</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s ask the builder to generate all the required hardware</span>
<span class="w">  </span><span class="nc">Builder</span><span class="p">(</span><span class="n">s01</span><span class="p">,</span><span class="w"> </span><span class="n">s12</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This will produce the following hardware :</p>
<a class="reference internal image-reference" href="_images/simple_pip.png"><img alt="_images/simple_pip.png" src="_images/simple_pip.png" style="width: 232.39999999999998px; height: 336.0px;" /></a>
<p>Here is a simulation wave :</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{signal: [
  {name: 'clk', wave: '0...p........'},
  {name: 'reset', wave: '1..0.........'},
  {name: 'io_up_valid', wave: '0.....10.....'},
  {},
  {name: 'n0_valid', wave: '0.....10.....'},
  {name: 'n0_VALUE', wave: 'x.....2......', data: ['0042']},
  {},
  {name: 'n1_valid', wave: '0......10....'},
  {name: 'n1_VALUE', wave: 'x......2.....', data: ['0042']},
  {name: 'n1_RESULT', wave: 'x......2.....', data: ['1242']},
  {},
  {name: 'n2_valid', wave: '0.......10...'},
  {name: 'n2_RESULT', wave: 'x.......2....', data: ['1242']},
  {},
  {name: 'io_down_valid', wave: '0.......10...'},
]}
</script>
</div>
<p>Here is the same example but using more of the API :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">misc</span><span class="p">.</span><span class="nn">pipeline</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">VALUE</span><span class="p">)</span><span class="w">  </span><span class="c1">// VALUE can also be used as a HardType</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// NodesBuilder will be used to register all the nodes created, connect them via stages and</span>
<span class="w">  </span><span class="c1">// generate the hardware.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">NodesBuilder</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s define a Node which connect from io.up .</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">arbitrateFrom</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s define a Node which do some processing.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">RESULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="nc">VALUE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1200</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">//  Let&#39;s define a Node which connect to io.down.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">arbitrateTo</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="nc">RESULT</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s connect those nodes by using registers stages and generate the related hardware.</span>
<span class="w">  </span><span class="n">builder</span><span class="p">.</span><span class="n">genStagedPipeline</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="payload">
<h4>Payload<a class="headerlink" href="#payload" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Payload</span></code> objects are used to refer to data which can go through the pipeline.
Technically speaking, <code class="docutils literal notranslate"><span class="pre">Payload</span></code> is a <code class="docutils literal notranslate"><span class="pre">HardType</span></code> which has a name and is used as a “key” to retrieve
the signals in a certain pipeline stage.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">PC_PLUS_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">s01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>

<span class="n">n0</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x42</span><span class="w"></span>
<span class="n">n1</span><span class="p">(</span><span class="nc">PC_PLUS_4</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n1</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
</pre></div>
</div>
<p>Note that I got used to name the <code class="docutils literal notranslate"><span class="pre">Payload</span></code> instances using uppercase. This is to make it very explicit
that the thing isn’t a hardware signal, but are more like a “key/type” to access things.</p>
</section>
<section id="node">
<h4>Node<a class="headerlink" href="#node" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Node</span></code> mostly hosts the valid/ready arbitration signals, and the hardware signals required for all
the <code class="docutils literal notranslate"><span class="pre">Payload</span></code> values going through it.</p>
<p>You can access its arbitration via :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 8%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Access</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.valid</span></code></p></td>
<td><p>RW</p></td>
<td><p>Is the signal which specifies if a transaction is present on the node. It is driven by the upstream. Once asserted, it must only be de-asserted the cycle after which either both <code class="docutils literal notranslate"><span class="pre">valid</span></code> and <code class="docutils literal notranslate"><span class="pre">ready</span></code> or <code class="docutils literal notranslate"><span class="pre">node.cancel</span></code> are high. <code class="docutils literal notranslate"><span class="pre">valid</span></code> must not depend on <code class="docutils literal notranslate"><span class="pre">ready</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.ready</span></code></p></td>
<td><p>RW</p></td>
<td><p>Is the signal which specifies if the node’s transaction can proceed downstream. It is driven by the downstream to create backpressure. The signal has no meaning when there is no transaction (<code class="docutils literal notranslate"><span class="pre">node.valid</span></code> being deasserted).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.cancel</span></code></p></td>
<td><p>RW</p></td>
<td><p>Is the signal which specifies if the node’s transaction in being canceled from the pipeline. It is driven by the downstream. The signal has no meaning when there is no transaction (<code class="docutils literal notranslate"><span class="pre">node.valid</span></code> being deasserted)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.isValid</span></code></p></td>
<td><p>RO</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">node.valid</span></code>’s read only accessor</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.isReady</span></code></p></td>
<td><p>RO</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">node.ready</span></code>’s read only accessor</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.isCancel</span></code></p></td>
<td><p>RO</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">node.cancel</span></code>’s read only accessor</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.isFiring</span></code></p></td>
<td><p>RO</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code> when the node transaction is successfully moving further (<code class="docutils literal notranslate"><span class="pre">valid</span> <span class="pre">&amp;&amp;</span> <span class="pre">ready</span> <span class="pre">&amp;&amp;</span> <span class="pre">!cancel</span></code>). Useful to commit state changes.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.isMoving</span></code></p></td>
<td><p>RO</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code> when the node transaction will not be present anymore on the node (starting from the next cycle),
either because downstream is ready to take the transaction,
or because the transaction is canceled from the pipeline (<code class="docutils literal notranslate"><span class="pre">valid</span> <span class="pre">&amp;&amp;</span> <span class="pre">(ready</span> <span class="pre">||</span> <span class="pre">cancel)</span></code>). Useful to “reset” states.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.isCanceling</span></code></p></td>
<td><p>RO</p></td>
<td><p>True when the node transaction is being cleaned up. Meaning that it will not appear anywhere in the pipeline in future cycles. It is equivalent to <code class="docutils literal notranslate"><span class="pre">isValid</span> <span class="pre">&amp;&amp;</span> <span class="pre">isCancel</span></code>.</p></td>
</tr>
</tbody>
</table>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">node.valid</span></code>/<code class="docutils literal notranslate"><span class="pre">node.ready</span></code> signals follows the same conventions than
the <a class="reference internal" href="index.html#document-SpinalHDL/Libraries/stream"><span class="doc">Stream</span></a>’s ones .</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Node</span></code> controls (<code class="docutils literal notranslate"><span class="pre">valid</span></code>/<code class="docutils literal notranslate"><span class="pre">ready</span></code>/<code class="docutils literal notranslate"><span class="pre">cancel</span></code>) and status (<code class="docutils literal notranslate"><span class="pre">isValid</span></code>, <code class="docutils literal notranslate"><span class="pre">isReady</span></code>,
<code class="docutils literal notranslate"><span class="pre">isCancel</span></code>, <code class="docutils literal notranslate"><span class="pre">isFiring</span></code>, …) signals are created on demand. So for instance you can create
pipelines with no backpressure by never referring to the ready signal. That’s why it is important
to use status signals when you want to read the status of something and only use control signals
when you want to drive something.</p>
<p>Here is a list of arbitration cases you can have on a node. <code class="docutils literal notranslate"><span class="pre">valid</span></code>/<code class="docutils literal notranslate"><span class="pre">ready</span></code>/<code class="docutils literal notranslate"><span class="pre">cancel</span></code> define
the state we are in, while <code class="docutils literal notranslate"><span class="pre">isFiring</span></code>/<code class="docutils literal notranslate"><span class="pre">isMoving</span></code> result of those :</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>valid</p></th>
<th class="head"><p>ready</p></th>
<th class="head"><p>cancel</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>isFiring</p></th>
<th class="head"><p>isMoving</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td><p>No transaction</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>Going through</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>Blocked</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>X</p></td>
<td><p>1</p></td>
<td><p>Canceled</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>Note that if you want to model things like for instance a CPU stage which can block and flush stuff, take a look a the CtrlLink, as it provides the API to do such things.</p>
<p>You can access signals referenced by a Payload via:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node(Payload)</span></code></p></td>
<td><p>Return the corresponding hardware signal</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node(Payload,</span> <span class="pre">Any)</span></code></p></td>
<td><p>Same as above, but include a second argument which is used as a “secondary key”. This eases the construction of multi-lane hardware. For instance, when you have a multi issue CPU pipeline, you can use the lane Int id as secondary key</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.insert(Data)</span></code></p></td>
<td><p>Return a new Payload instance which is connected to the given Data hardware signal</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">n0</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x42</span><span class="w"></span>
<span class="n">n0</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x42</span><span class="w"></span>
<span class="n">n0</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x666</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xEE</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">SOMETHING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n0</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myHardwareSignal</span><span class="p">)</span><span class="w"> </span><span class="c1">// This create a new Payload</span>
<span class="n">when</span><span class="p">(</span><span class="n">n1</span><span class="p">(</span><span class="nc">SOMETHING</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mh">0xFFAA</span><span class="p">){</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>While you can manually drive/read the arbitration/data of the first/last stage of your pipeline, there is a few utilities to connect its boundaries.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.arbitrateFrom(Stream[T]])</span></code></p></td>
<td><p>Drive a node arbitration from a <code class="docutils literal notranslate"><span class="pre">Stream</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.arbitrateFrom(Flow[T]])</span></code></p></td>
<td><p>Drive a node arbitration from a <code class="docutils literal notranslate"><span class="pre">Flow</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.arbitrateTo(Stream[T]])</span></code></p></td>
<td><p>Drive a <code class="docutils literal notranslate"><span class="pre">Stream</span></code> arbitration from the node.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.arbitrateTo(Flow[T]])</span></code></p></td>
<td><p>Drive a <code class="docutils literal notranslate"><span class="pre">Flow</span></code> arbitration from the node.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.driveFrom(Stream[T]])((Node,</span> <span class="pre">T)</span> <span class="pre">=&gt;</span> <span class="pre">Unit)</span></code></p></td>
<td><p>Drive a node from a stream. The provided lambda function can be use to connect the data.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.driveFrom(Flow[T]])((Node,</span> <span class="pre">T)</span> <span class="pre">=&gt;</span> <span class="pre">Unit)</span></code></p></td>
<td><p>Same as above but for <code class="docutils literal notranslate"><span class="pre">Flow</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">node.driveTo(Stream[T]])((T,</span> <span class="pre">Node)</span> <span class="pre">=&gt;</span> <span class="pre">Unit)</span></code></p></td>
<td><p>Drive a stream from the node. The provided lambda function can be use to connect the data.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">node.driveTo(Flow[T]])((T,</span> <span class="pre">Node)</span> <span class="pre">=&gt;</span> <span class="pre">Unit)</span></code></p></td>
<td><p>Same as above but for <code class="docutils literal notranslate"><span class="pre">Flow</span></code>.</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="nc">IN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">OUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="n">n1</span><span class="p">(</span><span class="nc">OUT</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n1</span><span class="p">(</span><span class="nc">IN</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x42</span><span class="w"></span>

<span class="c1">// Define the input / output stream that will be later connected to the pipeline</span>
<span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// Note master Stream(OUT) is good as well</span>

<span class="n">n0</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">up</span><span class="p">)((</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">self</span><span class="p">(</span><span class="nc">IN</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<span class="n">n2</span><span class="p">.</span><span class="n">driveTo</span><span class="p">(</span><span class="n">down</span><span class="p">)((</span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">self</span><span class="p">(</span><span class="nc">OUT</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>In order to reduce verbosity, there is a set of implicit conversions between <code class="docutils literal notranslate"><span class="pre">Payload</span></code> toward their data representation
which can be used when you are in the context of a <code class="docutils literal notranslate"><span class="pre">Node</span></code> :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// VALUE is implicitly converted into its n1(VALUE) representation</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PLUS_ONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="nc">VALUE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can also use those implicit conversions by importing them :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">n1Stuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nn">n1</span><span class="p">.</span><span class="n">_</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PLUS_ONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">// Equivalent to n1.insert(n1(VALUE)) + 1</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>There is also an API which allows you to create new <code class="docutils literal notranslate"><span class="pre">Area</span></code> which provide the whole API of a given node instance
(including implicit conversion) without import :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">n1Stuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PLUS_ONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">// Equivalent to n1.insert(n1(VALUE)) + 1</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Such feature is very useful when you have parametrizable pipeline locations for your hardware (see retiming example).</p>
</section>
<section id="links">
<h4>Links<a class="headerlink" href="#links" title="Permalink to this heading"></a></h4>
<p>There is few different <code class="docutils literal notranslate"><span class="pre">Link</span></code> already implemented (but you could also create your own custom one).
The idea of links is to connect two nodes together in various ways.
They generally have a <code class="docutils literal notranslate"><span class="pre">up</span></code> Node and a <code class="docutils literal notranslate"><span class="pre">down</span></code> <code class="docutils literal notranslate"><span class="pre">Node</span></code>.</p>
<section id="directlink">
<h5>DirectLink<a class="headerlink" href="#directlink" title="Permalink to this heading"></a></h5>
<p>Very simple, it connect two nodes with signals only. Here is an example :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DirectLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="stagelink">
<h5>StageLink<a class="headerlink" href="#stagelink" title="Permalink to this heading"></a></h5>
<p>This connect two nodes using registers on the <code class="docutils literal notranslate"><span class="pre">data</span></code>/<code class="docutils literal notranslate"><span class="pre">valid</span></code> signals and some arbitration on the <code class="docutils literal notranslate"><span class="pre">ready</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="s2mlink">
<h5>S2mLink<a class="headerlink" href="#s2mlink" title="Permalink to this heading"></a></h5>
<p>This connect two nodes using registers on the <code class="docutils literal notranslate"><span class="pre">ready</span></code> signal, which can be useful to improve backpressure combinatorial timings.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">S2mLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="ctrllink">
<h5>CtrlLink<a class="headerlink" href="#ctrllink" title="Permalink to this heading"></a></h5>
<p>This is a kind of special <code class="docutils literal notranslate"><span class="pre">Link</span></code>, as it connects two nodes with optional flow control / bypass logic. Its API
should be flexible enough to implement a CPU stage with it.</p>
<p>Here is its flow control API (The Bool arguments enable the features) :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">haltWhen(Bool)</span></code></p></td>
<td><p>Allows to block the current transaction (clear <code class="docutils literal notranslate"><span class="pre">up.ready</span></code> and <code class="docutils literal notranslate"><span class="pre">down.valid</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">throwWhen(Bool)</span></code></p></td>
<td><p>Allows to cancel the current transaction from the pipeline (clear <code class="docutils literal notranslate"><span class="pre">down.valid</span></code> and make the transaction driver forget its current state)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">forgetOneWhen(Bool)</span></code></p></td>
<td><p>Allows to request the upstream to forget its current transaction (but doesn’t clear the <code class="docutils literal notranslate"><span class="pre">down.valid</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ignoreReadyWhen(Bool)</span></code></p></td>
<td><p>Allows to ignore the downstream ready (set <code class="docutils literal notranslate"><span class="pre">up.ready</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">duplicateWhen(Bool)</span></code></p></td>
<td><p>Allows to duplicate the current transaction (clear <code class="docutils literal notranslate"><span class="pre">up.ready</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">terminateWhen(Bool)</span></code></p></td>
<td><p>Allows to hide the current transaction from downstream (clear <code class="docutils literal notranslate"><span class="pre">down.valid</span></code>)</p></td>
</tr>
</tbody>
</table>
<p>Also note that if you want to do flow control in a conditional scope (ex in a <code class="docutils literal notranslate"><span class="pre">when</span></code> statement), you can
call the following functions :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">haltIt()</span></code>, <code class="docutils literal notranslate"><span class="pre">duplicateIt()</span></code>, <code class="docutils literal notranslate"><span class="pre">terminateIt()</span></code>, <code class="docutils literal notranslate"><span class="pre">forgetOneNow()</span></code>, <code class="docutils literal notranslate"><span class="pre">ignoreReadyNow()</span></code>, <code class="docutils literal notranslate"><span class="pre">throwIt()</span></code></p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CtrlLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>

<span class="n">c01</span><span class="p">.</span><span class="n">haltWhen</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="c1">// Explicit halt request</span>

<span class="n">when</span><span class="p">(</span><span class="n">somethingElse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Conditional scope sensitive halt request, same as c01.haltWhen(somethingElse)</span>
<span class="w">    </span><span class="n">c01</span><span class="p">.</span><span class="n">haltIt</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can retrieve which nodes are connected to the <code class="docutils literal notranslate"><span class="pre">Link</span></code> using <code class="docutils literal notranslate"><span class="pre">node.up</span></code> / <code class="docutils literal notranslate"><span class="pre">node.down</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CtrlLink</span></code> also provide an API to access <code class="docutils literal notranslate"><span class="pre">Payload</span></code> :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">link(Payload)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">Link.down(Payload)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">link(Payload,</span> <span class="pre">Any)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">Link.down(Payload,</span> <span class="pre">Any)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">link.insert(Data)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">Link.down.insert(Data)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">link.bypass(Payload)</span></code></p></td>
<td><p>Allows to conditionally override a <code class="docutils literal notranslate"><span class="pre">Payload</span></code> value between <code class="docutils literal notranslate"><span class="pre">link.up</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">link.down</span></code>. This can be used to fix data hazard in CPU pipelines for instance.</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CtrlLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">c01</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x42</span><span class="w"></span>
<span class="n">c01</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x666</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xEE</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="nc">DATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="c1">// Let&#39;s say Data is inserted in the pipeline before c01</span>
<span class="n">when</span><span class="p">(</span><span class="n">hazard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">c01</span><span class="p">.</span><span class="n">bypass</span><span class="p">(</span><span class="nc">DATA</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">fixedValue</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// c01(DATA) and below will get the hazard patch</span>
</pre></div>
</div>
<p>Note that if you create a <code class="docutils literal notranslate"><span class="pre">CtrlLink</span></code> without node arguments, it will create its own nodes internally.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">decode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CtrlLink</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CtrlLink</span><span class="p">()</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">d2e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">decode</span><span class="p">.</span><span class="n">down</span><span class="p">,</span><span class="w"> </span><span class="n">execute</span><span class="p">.</span><span class="n">up</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="other-links">
<h5>Other Links<a class="headerlink" href="#other-links" title="Permalink to this heading"></a></h5>
<p>There is also a <code class="docutils literal notranslate"><span class="pre">JoinLink</span></code> / <code class="docutils literal notranslate"><span class="pre">ForkLink</span></code> implemented.</p>
</section>
<section id="your-custom-link">
<h5>Your custom Link<a class="headerlink" href="#your-custom-link" title="Permalink to this heading"></a></h5>
<p>You can implement your custom links by implementing the <code class="docutils literal notranslate"><span class="pre">Link</span></code> base class.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">Link</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ups</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Node</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">downs</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Node</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">propagateDown</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">propagateUp</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But that API may change a bit, as it is still fresh.</p>
</section>
</section>
<section id="builders">
<h4>Builders<a class="headerlink" href="#builders" title="Permalink to this heading"></a></h4>
<p>To generate the hardware of your pipeline, you need to give a list of all the links used in your pipeline.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Let&#39;s define 3 Nodes for our pipeline</span>
<span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>

<span class="c1">// Let&#39;s connect those nodes by using simples registers</span>
<span class="kd">val</span><span class="w"> </span><span class="n">s01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">s12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Let&#39;s ask the builder to generate all the required hardware</span>
<span class="nc">Builder</span><span class="p">(</span><span class="n">s01</span><span class="p">,</span><span class="w"> </span><span class="n">s12</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>There is also a set of “all in one” builders that you can instantiate to help yourself.</p>
<section id="stagepipeline">
<h5>StagePipeline<a class="headerlink" href="#stagepipeline" title="Permalink to this heading"></a></h5>
<p>For instance there is the <code class="docutils literal notranslate"><span class="pre">StagePipeline</span></code> class which serve two purposes :
- It ease the creation of simple pipelines which are composed of : <code class="docutils literal notranslate"><span class="pre">Node</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">StageLink</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Node</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">StageLink</span></code> -&gt; …
- It extends the pipeline length on the fly</p>
<p>Here is an example which :</p>
<ul class="simple">
<li><p>Take the input at stage 0</p></li>
<li><p>Sum the input at stage 1</p></li>
<li><p>Square the sum at stage 2</p></li>
<li><p>Provide the result at stage 3</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Let&#39;s define a few inputs/outputs</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="c1">// Let&#39;s create the pipelining tool.</span>
<span class="kd">val</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StagePipeline</span><span class="w"></span>

<span class="c1">// Let&#39;s insert a and b into the pipeline at stage 0</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pip</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pip</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">insert</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Lets insert the sum of A and B into the stage 1 of our pipeline</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">insert</span><span class="p">(</span><span class="n">pip</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="nc">A</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pip</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="nc">B</span><span class="p">))</span><span class="w"></span>

<span class="c1">// Clearly, i don&#39;t want to say pip(x)(y) on every pipelined thing.</span>
<span class="c1">// So instead we can create a pip.Area(x) which will provide a scope which work in stage &quot;x&quot;</span>
<span class="kd">val</span><span class="w"> </span><span class="n">onSquare</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">pip</span><span class="p">.</span><span class="nc">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">){</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="nc">SUM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">SUM</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Lets assign our output result from stage 3</span>
<span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pip</span><span class="p">(</span><span class="mi">3</span><span class="p">)(</span><span class="n">onSquare</span><span class="p">.</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Now that everything is specified, we can build the pipeline</span>
<span class="n">pip</span><span class="p">.</span><span class="n">build</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="stagectrlpipeline">
<h5>StageCtrlPipeline<a class="headerlink" href="#stagectrlpipeline" title="Permalink to this heading"></a></h5>
<p>Very similar to <code class="docutils literal notranslate"><span class="pre">StagePipeline</span></code>, but it replace Nodes by <code class="docutils literal notranslate"><span class="pre">CtrlLink</span></code>, allowing to handle
the arbitration / bypasses on each stages, which is for instance quite useful for CPU designs.</p>
<p>Here is an example which :</p>
<ul class="simple">
<li><p>Take the input at stage 0</p></li>
<li><p>Sum the input at stage 1</p></li>
<li><p>Check the sum value and eventually drop the transaction at stage 2</p></li>
<li><p>Provide the result at stage 3</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Let&#39;s define a few inputs/outputs.</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="c1">// Let&#39;s create the pipelining tool.</span>
<span class="kd">val</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StageCtrlPipeline</span><span class="w"></span>

<span class="c1">// Let&#39;s insert a and b into the pipeline at stage 0.</span>
<span class="kd">val</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pip</span><span class="p">.</span><span class="n">ctrl</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pip</span><span class="p">.</span><span class="n">ctrl</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">insert</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Let&#39;s sum A and B at stage 1.</span>
<span class="kd">val</span><span class="w"> </span><span class="n">onSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">pip</span><span class="p">.</span><span class="nc">Ctrl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="nc">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">B</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Let&#39;s check if the sum is bad (&gt; 128) in stage 2 and if that is the case,</span>
<span class="c1">// we drop the transaction.</span>
<span class="kd">val</span><span class="w"> </span><span class="n">onTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">pip</span><span class="p">.</span><span class="nc">Ctrl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">isBad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onSum</span><span class="p">.</span><span class="nc">VALUE</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">128</span><span class="w"></span>
<span class="w">  </span><span class="n">throwWhen</span><span class="p">(</span><span class="n">isBad</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Let&#39;s assign our output result from stage 3.</span>
<span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pip</span><span class="p">.</span><span class="n">ctrl</span><span class="p">(</span><span class="mi">3</span><span class="p">)(</span><span class="n">onSum</span><span class="p">.</span><span class="nc">VALUE</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Now that everything is specified, we can build the pipeline.</span>
<span class="n">pip</span><span class="p">.</span><span class="n">build</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="composability">
<h4>Composability<a class="headerlink" href="#composability" title="Permalink to this heading"></a></h4>
<p>One good thing about the API is that it easily allows to compose a pipeline with multiple parallel things.
What it means by “compose” is that sometime the pipeline you need to design has parallel processing to do.</p>
<p>Imagine you need to do floating point multiplication on 4 pairs of numbers (to later sum them).
If those 4 pairs are provided at the same time by a single stream of data, then you don’t want 4 different pipelines
to multiply them, instead you want to process them all in parallel in the same pipeline.</p>
<p>The example below show a pattern which composes a pipeline with multiple lanes to process them in parallel.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// This area allows to take a input value and do +1 +1 +1 over 3 stages.</span>
<span class="c1">// I know that&#39;s useless, but let&#39;s pretend that instead it does a multiplication</span>
<span class="c1">// between two numbers over 3 stages (for FMax reasons).</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Plus3</span><span class="p">(</span><span class="nc">INPUT</span><span class="p">:</span><span class="w"> </span><span class="nc">Payload</span><span class="p">[</span><span class="nc">UInt</span><span class="p">],</span><span class="w"> </span><span class="n">stage1</span><span class="p">:</span><span class="w"> </span><span class="nc">Node</span><span class="p">,</span><span class="w"> </span><span class="n">stage2</span><span class="p">:</span><span class="w"> </span><span class="nc">Node</span><span class="p">,</span><span class="w"> </span><span class="n">stage3</span><span class="p">:</span><span class="w"> </span><span class="nc">Node</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage1</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">stage1</span><span class="p">(</span><span class="nc">INPUT</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">TWO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage2</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">stage2</span><span class="p">(</span><span class="nc">ONE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">THREE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage3</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">stage3</span><span class="p">(</span><span class="nc">TWO</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Let&#39;s define a component which takes a stream as input,</span>
<span class="c1">// which carries &#39;lanesCount&#39; values that we want to process in parallel</span>
<span class="c1">// and put the result on an output stream.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">(</span><span class="n">lanesCount</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">lanesCount</span><span class="p">)(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Vec</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">lanesCount</span><span class="p">)(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s define 3 Nodes for our pipeline</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Node</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s connect those nodes by using simples registers</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">s01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">s12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s bind io.up to n0</span>
<span class="w">  </span><span class="n">n0</span><span class="p">.</span><span class="n">arbitrateFrom</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">LANES_INPUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">n0</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s use our &quot;reusable&quot; Plus3 area to generate each processing lane</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">lanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">lanesCount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Plus3</span><span class="p">(</span><span class="nc">LANES_INPUT</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s bind n2 to io.down</span>
<span class="w">  </span><span class="n">n2</span><span class="p">.</span><span class="n">arbitrateTo</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">lanesCount</span><span class="p">)</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">.</span><span class="n">payload</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">n2</span><span class="p">(</span><span class="n">lanes</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="nc">THREE</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s ask the builder to generate all the required hardware</span>
<span class="w">  </span><span class="nc">Builder</span><span class="p">(</span><span class="n">s01</span><span class="p">,</span><span class="w"> </span><span class="n">s12</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This will produce the following data path (assuming <code class="docutils literal notranslate"><span class="pre">lanesCount</span> <span class="pre">=</span> <span class="pre">2</span></code>), arbitration not being shown :</p>
<a class="reference internal image-reference" href="_images/composable_lanes.png"><img alt="_images/composable_lanes.png" src="_images/composable_lanes.png" style="width: 406.0px; height: 630.0px;" /></a>
</section>
<section id="retiming-variable-length">
<h4>Retiming / Variable length<a class="headerlink" href="#retiming-variable-length" title="Permalink to this heading"></a></h4>
<p>Sometime you want to design a pipeline, but you don’t really know where the critical paths will be
and what the right balance between stages is. And often you can’t rely on the synthesis tool doing
a good job with automatic retiming.</p>
<p>So, you kind of need a easy way to move the logic of your pipeline around.</p>
<p>Here is how it can be done with this pipelining API :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define a component which will take a input stream of RGB value</span>
<span class="c1">// Process (~(R + G + B)) * 0xEE</span>
<span class="c1">// And provide that result into an output stream.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RgbToSomething</span><span class="p">(</span><span class="n">addAt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">invAt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">mulAt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">resultAt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="n">spinal</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">graphic</span><span class="p">.</span><span class="nc">Rgb</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s define the Nodes for our pipeline.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">resultAt</span><span class="o">+</span><span class="mi">1</span><span class="p">)(</span><span class="nc">Node</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s specify which node will be used for what part of the pipeline.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">insertNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">addNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">addAt</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">invNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">invAt</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mulNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">mulAt</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">resultNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">resultAt</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define the hardware which will feed the io.up stream into the pipeline.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">inserter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">insertNode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">arbitrateFrom</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">RGB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Sum the r g b values of the color.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">adder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">addNode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">inserter</span><span class="p">.</span><span class="nc">RGB</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inserter</span><span class="p">.</span><span class="nc">RGB</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inserter</span><span class="p">.</span><span class="nc">RGB</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Flip all the bit of the RGB sum.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">inverter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">invNode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">INV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="o">~</span><span class="n">adder</span><span class="p">.</span><span class="nc">SUM</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Multiply the inverted bits with 0xEE.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">mulNode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">MUL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">inverter</span><span class="p">.</span><span class="nc">INV</span><span class="o">*</span><span class="mh">0xEE</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Connect the end of the pipeline to the io.down stream.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">resulter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">resultNode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">arbitrateTo</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">down</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">multiplier</span><span class="p">.</span><span class="nc">MUL</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s connect those nodes sequentially by using simples registers.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">links</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">resultAt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">nodes</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Let&#39;s ask the builder to generate all the required hardware</span>
<span class="w">  </span><span class="nc">Builder</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If then you generate this component like this :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">RgbToSomething</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">addAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">invAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">mulAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resultAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>You will get 4 stages separated by 3 layers of flip-flops doing your processing :</p>
<a class="reference internal image-reference" href="_images/rgbToSomething.png"><img alt="_images/rgbToSomething.png" src="_images/rgbToSomething.png" style="width: 114.8px; height: 392.0px;" /></a>
<p>Note the generated hardware verilog is kinda clean (by my standards at least :P) :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL dev    git head : 1259510dd72697a4f2c388ad22b269d4d2600df7</span>
<span class="c1">// Component : RgbToSomething</span>
<span class="c1">// Git hash  : 63da021a1cd082d22124888dd6c1e5017d4a37b2</span>

<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ps</span><span class="w"></span>

<span class="k">module</span><span class="w"> </span><span class="n">RgbToSomething</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">io_up_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">io_up_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_up_payload_r</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_up_payload_g</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_up_payload_b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">io_down_valid</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">io_down_ready</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_down_payload</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_nodes_0_adder_SUM</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">nodes_3_multiplier_MUL</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">nodes_2_multiplier_MUL</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_2_inverter_INV</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_1_inverter_INV</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_1_adder_SUM</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_0_adder_SUM</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_0_inserter_RGB_r</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_0_inserter_RGB_g</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">nodes_0_inserter_RGB_b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">nodes_0_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">nodes_0_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">nodes_1_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">nodes_1_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">nodes_2_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">nodes_2_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">nodes_3_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">nodes_3_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">when_StageLink_l56</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">when_StageLink_l56_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">when_StageLink_l56_2</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_nodes_0_adder_SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nodes_0_inserter_RGB_r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodes_0_inserter_RGB_g</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_0_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_up_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_up_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_0_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_0_inserter_RGB_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_up_payload_r</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_0_inserter_RGB_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_up_payload_g</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_0_inserter_RGB_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_up_payload_b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_0_adder_SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_nodes_0_adder_SUM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodes_0_inserter_RGB_b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_1_inverter_INV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">nodes_1_adder_SUM</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_2_multiplier_MUL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nodes_2_inverter_INV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">8&#39;hee</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_down_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_3_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">nodes_3_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_down_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_down_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_3_multiplier_MUL</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">nodes_0_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_1_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">when_StageLink_l56</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_0_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">when_StageLink_l56</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">nodes_1_valid</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">nodes_1_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_2_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">when_StageLink_l56_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_1_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">when_StageLink_l56_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">nodes_2_valid</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">nodes_2_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_3_ready</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">when_StageLink_l56_2</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_2_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">when_StageLink_l56_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">nodes_3_valid</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_1_valid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_2_valid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_3_valid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">nodes_0_ready</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">        </span><span class="n">nodes_1_valid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nodes_0_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">end</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">nodes_1_ready</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">        </span><span class="n">nodes_2_valid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nodes_1_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">end</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">nodes_2_ready</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">        </span><span class="n">nodes_3_valid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nodes_2_valid</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nodes_0_ready</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_1_adder_SUM</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nodes_0_adder_SUM</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nodes_1_ready</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_2_inverter_INV</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nodes_1_inverter_INV</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nodes_2_ready</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">nodes_3_multiplier_MUL</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nodes_2_multiplier_MUL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>


<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>Also, you can easily tweak how many stages and where you want the processing to be done, for instance
you may want to move the inversion hardware to the same stage as the adder. This can be done the following way :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">RgbToSomething</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">addAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">invAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">mulAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resultAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>When you may want to remove the output register stage :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">RgbToSomething</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">addAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">invAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">mulAt</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resultAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>One thing about this example is the necessity intermediate val as <code class="docutils literal notranslate"><span class="pre">addNode</span></code>. I mean :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">addNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">addAt</span><span class="p">)</span><span class="w"></span>
<span class="c1">// sum the r g b values of the color</span>
<span class="kd">val</span><span class="w"> </span><span class="n">adder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">addNode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Unfortunately, scala doesn’t allow to replace <cite>new addNode.Area</cite> with <cite>new nodes(addAt).Area</cite>.
One workaround is to define a class as :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">NodeArea</span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">NodeMirror</span><span class="p">(</span><span class="n">nodes</span><span class="p">(</span><span class="n">at</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">adder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">NodeArea</span><span class="p">(</span><span class="n">addAt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Depending the scale of your pipeline, it can payoff.</p>
</section>
<section id="simple-cpu-example">
<h4>Simple CPU example<a class="headerlink" href="#simple-cpu-example" title="Permalink to this heading"></a></h4>
<p>Here is a simple/stupid 8 bits CPU example with :</p>
<ul class="simple">
<li><p>3 stages (fetch, decode, execute)</p></li>
<li><p>embedded fetch memory</p></li>
<li><p>add / jump / led /delay instructions</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Cpu</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fetch</span><span class="p">,</span><span class="w"> </span><span class="n">decode</span><span class="p">,</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CtrlLink</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">f2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">fetch</span><span class="p">.</span><span class="n">down</span><span class="p">,</span><span class="w"> </span><span class="n">decode</span><span class="p">.</span><span class="n">up</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">d2e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StageLink</span><span class="p">(</span><span class="n">decode</span><span class="p">.</span><span class="n">down</span><span class="p">,</span><span class="w"> </span><span class="n">execute</span><span class="p">.</span><span class="n">up</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">INSTRUCTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Payload</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">fetch</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pcReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">up</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pcReg</span><span class="w"></span>
<span class="w">    </span><span class="n">up</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="n">isFiring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">pcReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">256</span><span class="p">)(</span><span class="nc">INSTRUCTION</span><span class="p">).</span><span class="n">simPublic</span><span class="w"></span>
<span class="w">    </span><span class="nc">INSTRUCTION</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">readAsync</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">decoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">decode</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">INSTRUCTION</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">IS_ADD</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">IS_JUMP</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mh">0x2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">IS_LED</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mh">0x3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">IS_DELAY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mh">0x4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>


<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">alu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">execute</span><span class="p">.</span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">regfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span><span class="w"> </span><span class="n">decode</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">stage</span><span class="p">.</span><span class="n">throwWhen</span><span class="p">(</span><span class="n">flush</span><span class="p">,</span><span class="w"> </span><span class="n">usingReady</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">delayCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">isValid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="nc">IS_ADD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">regfile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">regfile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="nc">INSTRUCTION</span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="nc">IS_JUMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">flush</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">        </span><span class="n">fetcher</span><span class="p">.</span><span class="n">pcReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="nc">INSTRUCTION</span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="nc">IS_LED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">led</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">regfile</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="nc">IS_DELAY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">delayCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">delayCounter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">delayCounter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="nc">INSTRUCTION</span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">8</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">delayCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">execute</span><span class="p">.</span><span class="n">haltIt</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nc">Builder</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span><span class="w"> </span><span class="n">decode</span><span class="p">,</span><span class="w"> </span><span class="n">execute</span><span class="p">,</span><span class="w"> </span><span class="n">f2d</span><span class="p">,</span><span class="w"> </span><span class="n">d2e</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here is a simple testbench which implement a loop which will make the led counting up.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withFstWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Cpu</span><span class="p">).</span><span class="n">doSim</span><span class="p">(</span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">){</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">nop</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">jump</span><span class="p">(</span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">led</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">delay</span><span class="p">(</span><span class="n">cycles</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">cycles</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">fetcher</span><span class="p">.</span><span class="n">mem</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">nop</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nop</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="mh">0x1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">led</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">(</span><span class="mh">0x2</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/Libraries/Misc/index"></span><section id="misc">
<h3>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Libraries/Misc/PLIC/plic_mapper"></span><section id="plic-mapper">
<span id="id1"></span><h4>Plic Mapper<a class="headerlink" href="#plic-mapper" title="Permalink to this heading"></a></h4>
<p>The PLIC Mapper defines the register generation and access for a PLIC (Platform Level Interrupt Controller.</p>
<section id="plicmapper-apply">
<h5><code class="docutils literal notranslate"><span class="pre">PlicMapper.apply</span></code><a class="headerlink" href="#plicmapper-apply" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">(bus:</span> <span class="pre">BusSlaveFactory,</span> <span class="pre">mapping:</span> <span class="pre">PlicMapping)(gateways</span> <span class="pre">:</span> <span class="pre">Seq[PlicGateway],</span> <span class="pre">targets</span> <span class="pre">:</span> <span class="pre">Seq[PlicTarget])</span></code></p>
<p>args for PlicMapper:</p>
<ul class="simple">
<li><p><strong>bus</strong>: bus to which this ctrl is attached</p></li>
<li><p><strong>mapping</strong>: a mapping configuration (see above)</p></li>
<li><p><strong>gateways</strong>: a sequence of PlicGateway (interrupt sources) to generate the bus access control</p></li>
<li><p><strong>targets</strong>: the sequence of PlicTarget (eg. multiple cores) to generate the bus access control</p></li>
</ul>
<p>It follows the interface given by riscv: <a class="reference external" href="https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc">https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc</a></p>
<p>As of now, two memory mappings are available :</p>
</section>
<section id="plicmapping-sifive">
<h5><code class="docutils literal notranslate"><span class="pre">PlicMapping.sifive</span></code><a class="headerlink" href="#plicmapping-sifive" title="Permalink to this heading"></a></h5>
<p>Follows the SiFive PLIC mapping (eg. <a class="reference external" href="https://sifive.cdn.prismic.io/sifive/9169d157-0d50-4005-a289-36c684de671b_e31_core_complex_manual_21G1.pdf">E31 core complex Manual</a> ), basically a full fledged PLIC</p>
</section>
<section id="plicmapping-light">
<h5><code class="docutils literal notranslate"><span class="pre">PlicMapping.light</span></code><a class="headerlink" href="#plicmapping-light" title="Permalink to this heading"></a></h5>
<p>This mapping generates a lighter PLIC, at the cost of some missing optional features:</p>
<ul class="simple">
<li><p>not reading the interrupt’s priority</p></li>
<li><p>not reading the interrupt’s pending bit (must use the claim/complete mechanism)</p></li>
<li><p>not reading the target’s threshold</p></li>
</ul>
<p>The rest of the registers &amp; logic is generated.</p>
</section>
</section>
<span id="document-SpinalHDL/Libraries/Misc/service_plugin"></span><section id="plugin">
<h4>Plugin<a class="headerlink" href="#plugin" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>For some design, instead of implementing your Component’s hardware directly in it,
you may instead want to compose its hardware by using some sorts of Plugins. This can provide a few key features :</p>
<ul class="simple">
<li><p>You can extend the features of your component by adding new plugins in its parameters. For instance adding Floating point support in a CPU.</p></li>
<li><p>You can swap various implementations of the same functionality just by using another set of plugins. For instance one implementation of a CPU multiplier may fit well on some FPGA, while others may fit well on ASIC.</p></li>
<li><p>It avoid the very very very large hand written toplevel syndrome where everything has to be connected manually. Instead plugins can discover their neighborhood by looking/using the software interface of other plugins.</p></li>
</ul>
<p>VexRiscv and NaxRiscv projects are an example of this. Their are CPUs which have a mostly empty toplevel,
and their hardware parts are injected using plugins. For instance :</p>
<ul class="simple">
<li><p>PcPlugin</p></li>
<li><p>FetchPlugin</p></li>
<li><p>DecoderPlugin</p></li>
<li><p>RegFilePlugin</p></li>
<li><p>IntAluPlugin</p></li>
<li><p>…</p></li>
</ul>
<p>And those plugins will then negotiate/propagate/interconnect to each others via their pool of services.</p>
<p>While VexRiscv use a strict synchronous 2 phase system (setup/build callback), NaxRiscv uses a more flexible approach which uses the spinal.core.fiber API to fork elaboration threads which can interlock each others in order to ensure a workable elaboration ordering.</p>
<p>The Plugin API provide a NaxRiscv like system to define composable components using plugins.</p>
</section>
<section id="execution-order">
<h5>Execution order<a class="headerlink" href="#execution-order" title="Permalink to this heading"></a></h5>
<p>The main idea is that you have multiple 2 executions phases :</p>
<ul class="simple">
<li><p>Setup phase, in which plugins can lock/retain each others. The idea is not to start negotiation / elaboration yet.</p></li>
<li><p>Build phase, in which plugins can negotiation / elaboration hardware.</p></li>
</ul>
<p>The build phase will not start before all FiberPlugin are done with their setup phase.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Here we are executing code in the setup phase</span>
<span class="w">    </span><span class="n">awaitBuild</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Here we are executing code in the build phase</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyPlugin2</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Here we are executing code in the build phase</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="simple-example">
<h5>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this heading"></a></h5>
<p>Here is a simple dummy example with a SubComponent which will be composed using 2 plugins :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">misc</span><span class="p">.</span><span class="nn">plugin</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// Let&#39;s define a Component with a PluginHost instance</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SubComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PluginHost</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Let&#39;s define a plugin which create a register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StatePlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// during build new Area { body } will run the body of code in the Fiber build phase, in the context of the PluginHost</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Let&#39;s define a plugin which will make the StatePlugin&#39;s register increment</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DriverPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// We define how to get the instance of StatePlugin.logic from the PluginHost. It is a lazy val, because we can&#39;t evaluate it until the plugin is bound to its host.</span>
<span class="w">  </span><span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">[</span><span class="nc">StatePlugin</span><span class="p">].</span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Generate the increment hardware</span>
<span class="w">    </span><span class="n">sp</span><span class="p">.</span><span class="n">signal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">signal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SubComponent</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Here we create plugins and embed them in sub.host</span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">DriverPlugin</span><span class="p">().</span><span class="n">setHost</span><span class="p">(</span><span class="n">sub</span><span class="p">.</span><span class="n">host</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">StatePlugin</span><span class="p">().</span><span class="n">setHost</span><span class="p">(</span><span class="n">sub</span><span class="p">.</span><span class="n">host</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Such TopLevel would generate the following Verilog code :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">TopLevel</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>


<span class="w">  </span><span class="n">SubComponent</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="c1">// i</span>
<span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w">  </span><span class="c1">// i</span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>

<span class="k">module</span><span class="w"> </span><span class="n">SubComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">StatePlugin_logic_signal</span><span class="p">;</span><span class="w"> </span><span class="c1">// Created by StatePlugin</span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">StatePlugin_logic_signal</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">StatePlugin_logic_signal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32&#39;h00000001</span><span class="p">);</span><span class="w"> </span><span class="c1">// incremented by DriverPlugin</span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>Note each “during build” fork an elaboration thread, the DriverPlugin.logic thread execution will be blocked on the “sp” evaluation until the StatePlugin.logic execution is done.</p>
</section>
<section id="interlocking-ordering">
<h5>Interlocking / Ordering<a class="headerlink" href="#interlocking-ordering" title="Permalink to this heading"></a></h5>
<p>Plugins can interlock each others using Retainer instances.
Each plugin instance has a built in lock which can be controlled using retain/release functions.</p>
<p>Here is an example based on the above <cite>Simple example</cite> but that time, the DriverPlugin will increment the StatePlugin.logic.signal
by an amount set by other plugins (SetupPlugin in our case). And to ensure that the DriverPlugin doesn’t generate the hardware too early,
the SetupPlugin uses the DriverPlugin.retain/release functions.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">misc</span><span class="p">.</span><span class="nn">plugin</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">fiber</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SubComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PluginHost</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">StatePlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">DriverPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// incrementBy will be set by others plugin at elaboration time</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">incrementBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="c1">// retainer allows other plugins to create locks, on which this plugin will wait before using incrementBy</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">retainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Retainer</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">[</span><span class="nc">StatePlugin</span><span class="p">].</span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="w"></span>
<span class="w">    </span><span class="n">retainer</span><span class="p">.</span><span class="n">await</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Generate the incrementer hardware</span>
<span class="w">    </span><span class="n">sp</span><span class="p">.</span><span class="n">signal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">signal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">incrementBy</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Let&#39;s define a plugin which will modify the DriverPlugin.incrementBy variable because letting it elaborate its hardware</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SetupPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">FiberPlugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// during setup { body } will spawn the body of code in the Fiber setup phase (it is before the Fiber build phase)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// *** Setup phase code ***</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">[</span><span class="nc">DriverPlugin</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Prevent the DriverPlugin from executing its build&#39;s body (until release() is called)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="n">retainer</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Wait until the fiber phase reached build phase</span>
<span class="w">    </span><span class="n">awaitBuild</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// *** Build phase code ***</span>
<span class="w">    </span><span class="c1">// Let&#39;s mutate DriverPlugin.incrementBy</span>
<span class="w">    </span><span class="n">dp</span><span class="p">.</span><span class="n">incrementBy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Allows the DriverPlugin to execute its build&#39;s body</span>
<span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SubComponent</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="n">sub</span><span class="p">.</span><span class="n">host</span><span class="p">.</span><span class="n">asHostOf</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">DriverPlugin</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">StatePlugin</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">SetupPlugin</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">SetupPlugin</span><span class="p">()</span><span class="w"> </span><span class="c1">// Let&#39;s add a second SetupPlugin, because we can</span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here is the generated verilog</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">TopLevel</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>


<span class="w">  </span><span class="n">SubComponent</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="c1">// i</span>
<span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w">  </span><span class="c1">// i</span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>

<span class="k">module</span><span class="w"> </span><span class="n">SubComponent</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">StatePlugin_logic_signal</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">StatePlugin_logic_signal</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">StatePlugin_logic_signal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32&#39;h00000002</span><span class="p">);</span><span class="w"> </span><span class="c1">// + 2 as we have two SetupPlugin</span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>Clearly, those examples are overkilled for what they do, the idea in general is more about :</p>
<ul class="simple">
<li><p>Negotiate / create interfaces between plugins (ex jump / flush ports)</p></li>
<li><p>Schedule the elaboration (ex decode / dispatch specification)</p></li>
<li><p>Provide a distributed framework which can scale up (minimal hardcoding)</p></li>
</ul>
</section>
</section>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/Simulation/index"></span><section id="simulation">
<h2>Simulation<a class="headerlink" href="#simulation" title="Permalink to this heading"></a></h2>
<p>As always, you can use your standard simulation tools to simulate the VHDL/Verilog generated by SpinalHDL.
However, since SpinalHDL 1.0.0, the language integrates an API to write testbenches and test your hardware
directly in Scala. This API provides the capabilities to read and write the DUT signals, fork and join
simulation processes, sleep and wait until a given condition is reached. Therefore, using SpinalHDL’s
simulation API, it is easy to integrate testbenches with the most common Scala unit-test frameworks.</p>
<p>To be able to simulate user-defined components, SpinalHDL uses external HDL simulators as backend. Currently, four simulators are supported:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.veripool.org/verilator/">Verilator</a></p></li>
<li><p><a class="reference external" href="http://ghdl.free.fr/">GHDL</a></p></li>
<li><p><a class="reference external" href="https://steveicarus.github.io/iverilog/">Icarus Verilog</a></p></li>
<li><p><a class="reference external" href="https://www.synopsys.com/verification/simulation/vcs.html">VCS</a> <strong>(experimental, since SpinalHDL 1.7.0)</strong></p></li>
<li><p><a class="reference external" href="https://www.google.com/search?q=site%3Axilinx.com+xsim">XSim</a> <strong>(experimental, since SpinalHDL 1.7.0)</strong></p></li>
</ul>
<p>With external HDL simulators it is possible to directly test the generated HDL sources without increasing the SpinalHDL codebase complexity.</p>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Simulation/install/index"></span><section id="sbt-setup-for-simulation">
<h3>SBT setup for simulation<a class="headerlink" href="#sbt-setup-for-simulation" title="Permalink to this heading"></a></h3>
<p>To enable SpinalSim, the following lines have to be added in your build.sbt file :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">fork</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
</pre></div>
</div>
<p>Also the following imports have to be added in testbenches sources :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
<p id="sim-backend-install">Also, if you need to use gmake instead of make (ex OpenBSD) you can set the SPINAL_MAKE_CMD environnement variable to “gmake”</p>
<section id="backend-dependent-installation-instructions">
<h4>Backend-dependent installation instructions<a class="headerlink" href="#backend-dependent-installation-instructions" title="Permalink to this heading"></a></h4>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Simulation/install/GHDL"></span><section id="setup-and-installation-of-ghdl">
<h5>Setup and installation of GHDL<a class="headerlink" href="#setup-and-installation-of-ghdl" title="Permalink to this heading"></a></h5>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you installed the recommended oss-cad-suite during SpinalHDL <a class="reference internal" href="index.html#install"><span class="std std-ref">setup</span></a> you
can skip the instructions below - but you need to activate the oss-cad-suite environment.</p>
</div>
<p>Even though GHDL is generally available in linux distributions package system, SpinalHDL depends on bugfixes of GHDL codebase that were added after the release of GHDL v0.37. Therefore it is reccomended to install GHDL from source.
The C++ library boost-interprocess, which is contained in the libboost-dev package in debian-like distributions, has to be installed too. boost-interprocess is required to generate the shared memory communication interface.</p>
<section id="linux">
<h6>Linux<a class="headerlink" href="#linux" title="Permalink to this heading"></a></h6>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get install build-essential libboost-dev git
sudo apt-get install gnat <span class="c1"># Ada compiler used to buid GHDL</span>
git clone https://github.com/ghdl/ghdl.git
<span class="nb">cd</span> ghdl
mkdir build
<span class="nb">cd</span> build
../configure
make
sudo make install
</pre></div>
</div>
<p>Also the openjdk package that corresponds to your Java version has to be installed.</p>
<p>For more configuration options and Windows installation see <a class="reference external" href="https://ghdl.github.io/ghdl/getting.html">https://ghdl.github.io/ghdl/getting.html</a></p>
</section>
</section>
<span id="document-SpinalHDL/Simulation/install/Icarus Verilog"></span><section id="setup-and-installation-of-icarus-verilog">
<h5>Setup and installation of Icarus Verilog<a class="headerlink" href="#setup-and-installation-of-icarus-verilog" title="Permalink to this heading"></a></h5>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you installed the recommended oss-cad-suite during SpinalHDL <a class="reference internal" href="index.html#install"><span class="std std-ref">setup</span></a> you
can skip the instructions below - but you need to activate the oss-cad-suite environment.</p>
</div>
<p>In most recent linux distributions, a recent version of Icarus Verilog is generally available through the package system.
The C++ library boost-interprocess, which is contained in the libboost-dev package in debian-like distributions, has to be installed too. boost-interprocess is required to generate the shared memory communication interface.</p>
<section id="linux">
<h6>Linux<a class="headerlink" href="#linux" title="Permalink to this heading"></a></h6>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get install build-essential libboost-dev iverilog
</pre></div>
</div>
<p>Also the openjdk package that corresponds to your Java version has to be installed.
Refer to <a class="reference external" href="https://iverilog.fandom.com/wiki/Installation_Guide">https://iverilog.fandom.com/wiki/Installation_Guide</a> for more information about Windows and installation from source.</p>
</section>
</section>
<span id="document-SpinalHDL/Simulation/install/VCS"></span><section id="vcs-simulation-configuration">
<h5>VCS Simulation Configuration<a class="headerlink" href="#vcs-simulation-configuration" title="Permalink to this heading"></a></h5>
<section id="environment-variable">
<span id="vcs-env"></span><h6>Environment variable<a class="headerlink" href="#environment-variable" title="Permalink to this heading"></a></h6>
<p>You should have several environment variables defined before:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VCS_HOME</span></code>: The home path to your VCS installation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERDI_HOME</span></code>: The home path to your Verdi installation.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">$VCS_HOME/bin</span></code> and <code class="docutils literal notranslate"><span class="pre">$VERDI_HOME/bin</span></code> to your <code class="docutils literal notranslate"><span class="pre">PATH</span></code>.</p></li>
</ul>
<p>Prepend the following paths to your <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> to enable PLI features.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$VERDI_HOME</span>/share/PLI/VCS/LINUX64:<span class="nv">$LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$VERDI_HOME</span>/share/PLI/IUS/LINUX64:<span class="nv">$LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$VERDI_HOME</span>/share/PLI/lib/LINUX64:<span class="nv">$LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$VERDI_HOME</span>/share/PLI/Ius/LINUX64:<span class="nv">$LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$VERDI_HOME</span>/share/PLI/MODELSIM/LINUX64:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></div>
</div>
<p>If you encounter the <code class="docutils literal notranslate"><span class="pre">Compilation</span> <span class="pre">of</span> <span class="pre">SharedMemIface.cpp</span> <span class="pre">failed</span></code> error, make sure that you have installed C++ boost library correctly.
The header and library files path should be added to <code class="docutils literal notranslate"><span class="pre">CPLUS_INCLUDE_PATH</span></code>, <code class="docutils literal notranslate"><span class="pre">LIBRARY_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> respectively.</p>
</section>
<section id="user-defined-environment-setup">
<h6>User defined environment setup<a class="headerlink" href="#user-defined-environment-setup" title="Permalink to this heading"></a></h6>
<p>Sometimes a VCS environment setup file <cite>synopsys_sim.setup</cite> is required to run VCS simulation. Also you may want to run some scripts or code
to setup the environment just before VCS starting compilation. You can do this by <cite>withVCSSimSetup</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">simConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">withVCS</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">withVCSSimSetup</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">setupFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;~/work/myproj/sim/synopsys_sim.setup&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">beforeAnalysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// this code block will be run before VCS analysis step.</span>
<span class="w">      </span><span class="s">&quot;pwd&quot;</span><span class="p">.</span><span class="o">!</span><span class="w"></span>
<span class="w">      </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello, VCS&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This method will copy your own <cite>synopsys_sim.setup</cite> file to the VCS work directory under the <cite>workspacePath</cite> (default as <cite>simWorkspace</cite>) directory,
and run your scripts.</p>
</section>
<section id="vcs-flags">
<h6>VCS Flags<a class="headerlink" href="#vcs-flags" title="Permalink to this heading"></a></h6>
<p>The VCS backend follows the three step compilation flow:</p>
<ol class="arabic simple">
<li><p>Analysis step: analysis the HDL model using <code class="docutils literal notranslate"><span class="pre">vlogan</span></code> and <code class="docutils literal notranslate"><span class="pre">vhdlan</span></code>.</p></li>
<li><p>Elaborate step: elaborate the model using <code class="docutils literal notranslate"><span class="pre">vcs</span></code> and generate the executable hardware model.</p></li>
<li><p>Simulation step: run the simulation.</p></li>
</ol>
<p>In each step, user can pass some specific flags through <code class="docutils literal notranslate"><span class="pre">VCSFlags</span></code> to enable some features like SDF back-annotation or multi-threads.</p>
<p><code class="docutils literal notranslate"><span class="pre">VCSFlags</span></code> takes three parameters,</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 42%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">compileFlags</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[String]</span></code></p></td>
<td><p>Flags pass to <code class="docutils literal notranslate"><span class="pre">vlogan</span></code> or <code class="docutils literal notranslate"><span class="pre">vhdlan</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">elaborateFlags</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[String]</span></code></p></td>
<td><p>Flags pass to <code class="docutils literal notranslate"><span class="pre">vcs</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">runFlags</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[String]</span></code></p></td>
<td><p>Flags pass to executable hardware model.</p></td>
</tr>
</tbody>
</table>
<p>For example, you pass the <code class="docutils literal notranslate"><span class="pre">-kdb</span></code> flags to both compilation step and elaboration step, for Verdi debugging,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VCSFlags</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">compileFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="s">&quot;-kdb&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">elaborateFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="s">&quot;-kdb&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="nc">SimConfig</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">withVCS</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">withFSDBWave</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">workspacePath</span><span class="p">(</span><span class="s">&quot;tb&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="nc">UIntAdder</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="waveform-generation">
<h6>Waveform generation<a class="headerlink" href="#waveform-generation" title="Permalink to this heading"></a></h6>
<p>VCS backend can generate three waveform format: <code class="docutils literal notranslate"><span class="pre">VCD</span></code>, <code class="docutils literal notranslate"><span class="pre">VPD</span></code> and <code class="docutils literal notranslate"><span class="pre">FSDB</span></code> (Verdi required).</p>
<p>You can enable them by the following methods of <code class="docutils literal notranslate"><span class="pre">SpinalSimConfig</span></code>,</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withWave</span></code></p></td>
<td><p>Enable <code class="docutils literal notranslate"><span class="pre">VCD</span></code> waveform.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">withVPDWave</span></code></p></td>
<td><p>Enable <code class="docutils literal notranslate"><span class="pre">VPD</span></code> waveform.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withFSDBWave</span></code></p></td>
<td><p>Enable <code class="docutils literal notranslate"><span class="pre">FSDB</span></code> waveform.</p></td>
</tr>
</tbody>
</table>
<p>Also, you can control the wave trace depth by using <code class="docutils literal notranslate"><span class="pre">withWaveDepth(depth:</span> <span class="pre">Int)</span></code>.</p>
</section>
<section id="simulation-with-blackbox">
<h6>Simulation with <code class="docutils literal notranslate"><span class="pre">Blackbox</span></code><a class="headerlink" href="#simulation-with-blackbox" title="Permalink to this heading"></a></h6>
<p>Sometimes, IP vendors will provide you with some design entities in Verilog/VHDL format and you want to integrate them into your SpinalHDL design.
The integration can done by following two ways:</p>
<ol class="arabic simple">
<li><p>In a <code class="docutils literal notranslate"><span class="pre">Blackbox</span></code> definition, use <code class="docutils literal notranslate"><span class="pre">addRTLPath(path:</span> <span class="pre">String)</span></code> to assign a external Verilog/VHDL file to this blackbox.</p></li>
<li><p>Use the method <code class="docutils literal notranslate"><span class="pre">mergeRTLSource(fileName:</span> <span class="pre">String=null)</span></code> of <code class="docutils literal notranslate"><span class="pre">SpinalReport</span></code>.</p></li>
</ol>
</section>
</section>
<span id="document-SpinalHDL/Simulation/install/Verilator"></span><section id="setup-and-installation-of-verilator">
<h5>Setup and installation of Verilator<a class="headerlink" href="#setup-and-installation-of-verilator" title="Permalink to this heading"></a></h5>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you installed the recommended oss-cad-suite during SpinalHDL <a class="reference internal" href="index.html#install"><span class="std std-ref">setup</span></a> you
can skip the instructions below - but you need to activate the oss-cad-suite environment.</p>
</div>
<p>SpinalSim + Verilator is supported on both Linux and Windows platforms.</p>
<p>It is recommended that v4.218 is the oldest Verilator version to use.  While it maybe
possible to use older verilator versions, some optional and Scala source dependent
features that SpinalHDL can use (such as Verilog <code class="docutils literal notranslate"><span class="pre">$urandom</span></code> support) may not be supported
by older Verilator versions and will cause an error when trying to simulate.</p>
<p>Ideally the latest v4.xxx and v5.xxx is well supported and bug reports should be opened
with any issues you have.</p>
<section id="scala">
<h6>Scala<a class="headerlink" href="#scala" title="Permalink to this heading"></a></h6>
<p>Don’t forget to add the following in your <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> file:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">fork</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
</pre></div>
</div>
<p>And you will always need the following imports in your Scala testbench:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
</section>
<section id="linux">
<h6>Linux<a class="headerlink" href="#linux" title="Permalink to this heading"></a></h6>
<p>You will also need a recent version of Verilator installed :</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get install git make autoconf g++ flex bison  <span class="c1"># First time prerequisites</span>
git clone https://github.com/verilator/verilator.git   <span class="c1"># Only first time</span>
unsetenv VERILATOR_ROOT  <span class="c1"># For csh; ignore error if on bash</span>
<span class="nb">unset</span> VERILATOR_ROOT  <span class="c1"># For bash</span>
<span class="nb">cd</span> verilator
git pull             <span class="c1"># Make sure we&#39;re up-to-date</span>
git checkout v4.218  <span class="c1"># Can use newer v4.228 and v5.xxx</span>
autoconf             <span class="c1"># Create ./configure script</span>
./configure
make -j<span class="k">$(</span>nproc<span class="k">)</span>
sudo make install
<span class="nb">echo</span> <span class="s2">&quot;DONE&quot;</span>
</pre></div>
</div>
</section>
<section id="windows">
<h6>Windows<a class="headerlink" href="#windows" title="Permalink to this heading"></a></h6>
<p>In order to get SpinalSim + Verilator working on Windows, you have to do the following:</p>
<ul class="simple">
<li><p>Install <a class="reference external" href="https://www.msys2.org/">MSYS2</a></p></li>
<li><p>Via MSYS2 get gcc/g++/verilator (for Verilator you can compile it from the sources)</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">bin</span></code> and <code class="docutils literal notranslate"><span class="pre">usr\bin</span></code> of MSYS2 into your windows <code class="docutils literal notranslate"><span class="pre">PATH</span></code> (ie : <code class="docutils literal notranslate"><span class="pre">C:\msys64\usr\bin;C:\msys64\mingw64\bin</span></code>)</p></li>
<li><p>Check that the JAVA_HOME environment variable points to the JDK installation folder (i.e.: <code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files\Java\jdk-13.0.2</span></code>)</p></li>
</ul>
<p>Then you should be able to run SpinalSim + Verilator from your Scala project without having to use MSYS2 anymore.</p>
<p>From a fresh install of MSYS2 MinGW 64-bit, you will have to run the following commands inside the MSYS2 MinGW 64-bits shell (enter commands one by one):</p>
<section id="from-the-mingw-package-manager">
<h6 aria-level="7">From the MinGW package manager<a class="headerlink" href="#from-the-mingw-package-manager" title="Permalink to this heading"></a></h6>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -Syuu
<span class="c1"># Close the MSYS2 shell once you&#39;re asked to</span>
pacman -Syuu
pacman -S --needed base-devel mingw-w64-x86_64-toolchain <span class="se">\</span>
                   git flex<span class="se">\</span>
                   mingw-w64-x86_64-cmake

pacman -U http://repo.msys2.org/mingw/x86_64/mingw-w64-x86_64-verilator-4.032-1-any.pkg.tar.xz

<span class="c1"># Add C:\msys64\usr\bin;C:\msys64\mingw64\bin to your Windows PATH</span>
</pre></div>
</div>
</section>
<section id="from-source">
<h6 aria-level="7">From source<a class="headerlink" href="#from-source" title="Permalink to this heading"></a></h6>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -Syuu
<span class="c1"># Close the MSYS2 shell once you&#39;re asked to</span>
pacman -Syuu
pacman -S --needed base-devel mingw-w64-x86_64-toolchain <span class="se">\</span>
                   git flex<span class="se">\</span>
                   mingw-w64-x86_64-cmake

git clone https://github.com/verilator/verilator.git
<span class="nb">unset</span> VERILATOR_ROOT
<span class="nb">cd</span> verilator
git pull
git checkout v4.218   <span class="c1"># Can use newer v4.228 and v5.xxx</span>
autoconf
./configure
<span class="nb">export</span> <span class="nv">CPLUS_INCLUDE_PATH</span><span class="o">=</span>/usr/include:<span class="nv">$CPLUS_INCLUDE_PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/usr/bin/core_perl:<span class="nv">$PATH</span>
cp /usr/include/FlexLexer.h ./src

make -j<span class="k">$(</span>nproc<span class="k">)</span>
make install
<span class="nb">echo</span> <span class="s2">&quot;DONE&quot;</span>
<span class="c1"># Add C:\msys64\usr\bin;C:\msys64\mingw64\bin to your Windows PATH</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Be sure that your <code class="docutils literal notranslate"><span class="pre">PATH</span></code> environnement variable is pointing to the JDK 1.8 and doesn’t contain a JRE installation.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Adding the MSYS2 <code class="docutils literal notranslate"><span class="pre">bin</span></code> folders into your windows <code class="docutils literal notranslate"><span class="pre">PATH</span></code> could potentially have some side effects.
This is why it is safer to add them as the last elements of the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> to reduce their priority.</p>
</div>
</section>
</section>
</section>
</div>
</section>
</section>
<span id="document-SpinalHDL/Simulation/bootstraps"></span><section id="boot-a-simulation">
<h3>Boot a simulation<a class="headerlink" href="#boot-a-simulation" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>Below is an example hardware definition + testbench:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// Identity takes n bits in a and gives them back in z</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Identity</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>

<span class="k">object</span><span class="w"> </span><span class="nc">TestIdentity</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Use the component with n = 3 bits as &quot;dut&quot; (device under test)</span>
<span class="w">  </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="n">doSim</span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// For each number from 3&#39;b000 to 3&#39;b111 included</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Apply input</span>
<span class="w">      </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Wait for a simulation time unit</span>
<span class="w">      </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Read output</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="n">toInt</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Check result</span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;Got </span><span class="si">$</span><span class="n">z</span><span class="s">, expected </span><span class="si">$</span><span class="n">a</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">SimConfig</span></code> will return a default simulation configuration instance on which you can call multiple functions to configure your simulation:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withWave</span></code></p></td>
<td><p>Enable simulation wave capture (default format)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">withVcdWave</span></code></p></td>
<td><p>Enable simulation wave capture (VCD text format)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withFstWave</span></code></p></td>
<td><p>Enable simulation wave capture (FST binary format)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">withConfig(SpinalConfig)</span></code></p></td>
<td><p>Specify the <code class="docutils literal notranslate"><span class="pre">SpinalConfig</span></code> that should be use to generate the hardware</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">allOptimisation</span></code></p></td>
<td><p>Enable all the RTL compilation optimizations to reduce simulation time (will increase compilation time)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">workspacePath(path)</span></code></p></td>
<td><p>Change the folder where the sim files are generated</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withVerilator</span></code></p></td>
<td><p>Use Verilator as simulation backend (default)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">withGhdl</span></code></p></td>
<td><p>Use GHDL as simulation backend</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">withIVerilog</span></code></p></td>
<td><p>Use Icarus Verilog as simulation backend</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">withVCS</span></code></p></td>
<td><p>Use Synopsys VCS as simulation backend</p></td>
</tr>
</tbody>
</table>
<p>Then you can call the <code class="docutils literal notranslate"><span class="pre">compile(rtl)</span></code> function to compile the hardware and warm up the simulator.
This function will return a <code class="docutils literal notranslate"><span class="pre">SimCompiled</span></code> instance.</p>
<p>On this <code class="docutils literal notranslate"><span class="pre">SimCompiled</span></code> instance you can run your simulation with the following functions:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">doSim[(simName[,</span> <span class="pre">seed])]{dut</span> <span class="pre">=&gt;</span> <span class="pre">/*</span> <span class="pre">main</span> <span class="pre">stimulus</span> <span class="pre">code</span> <span class="pre">*/}</span></code></dt><dd><p>Run the simulation until the main thread runs to completion and exits/returns.
It will detect and report an error if the simulation gets fully stuck. As long as
e.g. a clock is running the simulation can continue forever, it is therefore recommended
to use <code class="docutils literal notranslate"><span class="pre">SimTimeout(cycles)</span></code> to limit the possible runtime.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">doSimUntilVoid[(simName[,</span> <span class="pre">seed])]{dut</span> <span class="pre">=&gt;</span> <span class="pre">...}</span></code></dt><dd><p>Run the simulation until it is ended by calling either <code class="docutils literal notranslate"><span class="pre">simSuccess()</span></code> or <code class="docutils literal notranslate"><span class="pre">simFailure()</span></code>.
The main stimulus thread can continue or exit early. As long as there are events to process,
the simulation will continue. The simulation will report an error if it gets fully stuck.</p>
</dd>
</dl>
<p>The following testbench template will use the following toplevel :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here is a template with many simulation configurations:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">spinalConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalConfig</span><span class="p">(</span><span class="n">defaultClockDomainFrequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>

<span class="nc">SimConfig</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">withConfig</span><span class="p">(</span><span class="n">spinalConfig</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">withWave</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">allOptimisation</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">workspacePath</span><span class="p">(</span><span class="s">&quot;~/tmp&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">doSim</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Simulation code here</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here is a template where the simulation ends by completing the simulation main thread execution:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">).</span><span class="n">doSim</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSamplingWhere</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here is a template where the simulation ends by explicitly calling <cite>simSuccess()</cite>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">).</span><span class="n">doSimUntilVoid</span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSamplingWhere</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">simSuccess</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Note is it equivalent to:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">).</span><span class="n">doSim</span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSamplingWhere</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">simSuccess</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">simThread</span><span class="p">.</span><span class="n">suspend</span><span class="p">()</span><span class="w"> </span><span class="c1">// Avoid the &quot;doSim&quot; completion</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The location where the simulation files will be placed is defined by default in $WORKSPACE/$COMPILED.</p>
<ul class="simple">
<li><p>$WORKSPACE being by default <code class="docutils literal notranslate"><span class="pre">simWorkspace</span></code>, you can override it with the <code class="docutils literal notranslate"><span class="pre">SPINALSIM_WORKSPACE</span></code> environnement variable.</p></li>
<li><p>$COMPILED being the name of the toplevel being simulated.</p></li>
<li><p>The location of the wave file depend the backend used. For verilator it will be in the folder (<code class="docutils literal notranslate"><span class="pre">$WORKSPACE/$COMPILED/$TEST</span></code> by default).</p></li>
<li><p>For the verilator backend, you can override the location of the test folder via the <code class="docutils literal notranslate"><span class="pre">SimConfig.setTestPath(path)</span></code> function.</p></li>
<li><p>You can retrieve the location of the test path during simulation by calling the currentTestPath() function.</p></li>
</ul>
</section>
<section id="running-multiple-tests-on-the-same-hardware">
<h4>Running multiple tests on the same hardware<a class="headerlink" href="#running-multiple-tests-on-the-same-hardware" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">compiled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Dut</span><span class="p">)</span><span class="w"></span>

<span class="n">compiled</span><span class="p">.</span><span class="n">doSim</span><span class="p">(</span><span class="s">&quot;testA&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">   </span><span class="c1">// Simulation code here</span>
<span class="p">}</span><span class="w"></span>

<span class="n">compiled</span><span class="p">.</span><span class="n">doSim</span><span class="p">(</span><span class="s">&quot;testB&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">   </span><span class="c1">// Simulation code here</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="throw-success-or-failure-of-the-simulation-from-a-thread">
<h4>Throw Success or Failure of the simulation from a thread<a class="headerlink" href="#throw-success-or-failure-of-the-simulation-from-a-thread" title="Permalink to this heading"></a></h4>
<p>At any moment during a simulation you can call <code class="docutils literal notranslate"><span class="pre">simSuccess</span></code> or <code class="docutils literal notranslate"><span class="pre">simFailure</span></code> to end it.</p>
<p>It is possible to make a simulation fail when it is too long, for instance because the test-bench is waiting for a condition which never occurs. To do so, call <code class="docutils literal notranslate"><span class="pre">SimTimeout(maxDuration)</span></code> where <code class="docutils literal notranslate"><span class="pre">maxDuration</span></code> is the time (in simulation units of time) after the which the simulation should be considered to have failed.</p>
<p>For instance, to make the simulation fail after 1000 times the duration of a clock cycle:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="w"></span>
<span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">period</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="capturing-wave-for-a-given-window-before-failure">
<h4>Capturing wave for a given window before failure<a class="headerlink" href="#capturing-wave-for-a-given-window-before-failure" title="Permalink to this heading"></a></h4>
<p>In the case you have a very long simulation, and you don’t want to capture the wave on all of it (too bug, too slow), you have mostly 2 ways to do it.</p>
<p>Either you know already at which <code class="docutils literal notranslate"><span class="pre">simTime</span></code> the simulation failed, in which case you can do the following in your testbench :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">disableSimWave</span><span class="p">()</span><span class="w"></span>
<span class="n">delayed</span><span class="p">(</span><span class="n">timeFromWhichIWantToCapture</span><span class="p">)(</span><span class="n">enableSimWave</span><span class="p">())</span><span class="w"></span>
</pre></div>
</div>
<p>Or you can run a dual lock-step simulation, with one running a bit delayed from the the other one, and which will start recording the wave once the leading simulation had a failure.</p>
<p>To do this, you can use the DualSimTracer utility, with parameters for the compiled hardware, the window of time you want to capture before failure, and a seed.</p>
<p>Here is an example :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="nn">spinaldoc</span><span class="p">.</span><span class="nn">libraries</span><span class="p">.</span><span class="n">sim</span>

<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">misc</span><span class="p">.</span><span class="nn">test</span><span class="p">.</span><span class="nc">DualSimTracer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Toplevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Example</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">compiled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withFstWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Toplevel</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="nc">DualSimTracer</span><span class="p">(</span><span class="n">compiled</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">){</span><span class="n">dut</span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">onSamplings</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">toInt</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mh">0x1000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">f&quot;Value=0x</span><span class="si">$</span><span class="n">value</span><span class="s">%x at </span><span class="si">${</span><span class="n">simTime</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Throw a simulation failure after 64K cycles</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">simFailure</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This will generate the following file structure :</p>
<ul class="simple">
<li><p>simWorkspace/Toplevel/explorer/stdout.log : stdout of the simulation which is ahead</p></li>
<li><p>simWorkspace/Toplevel/tracer/stdout.log : stdout of the simulation doing the wave tracing</p></li>
<li><p>simWorkspace/Toplevel/tracer.fst : Waveform of the failure</p></li>
</ul>
<p>The scala terminal will show the explorer simulation stdout.</p>
</section>
</section>
<span id="document-SpinalHDL/Simulation/signal"></span><section id="accessing-signals-of-the-simulation">
<h3>Accessing signals of the simulation<a class="headerlink" href="#accessing-signals-of-the-simulation" title="Permalink to this heading"></a></h3>
<section id="read-and-write-signals">
<h4>Read and write signals<a class="headerlink" href="#read-and-write-signals" title="Permalink to this heading"></a></h4>
<p>Each interface signal of the toplevel can be read and written from Scala:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Bool.toBoolean</span></code></p></td>
<td><p>Read a hardware <code class="docutils literal notranslate"><span class="pre">Bool</span></code> as a Scala <code class="docutils literal notranslate"><span class="pre">Boolean</span></code> value</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Bits</span></code>/<code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt.toInt</span></code></p></td>
<td><p>Read a hardware <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> as a Scala <code class="docutils literal notranslate"><span class="pre">Int</span></code> value</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Bits</span></code>/<code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt.toLong</span></code></p></td>
<td><p>Read a hardware <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> as a Scala <code class="docutils literal notranslate"><span class="pre">Long</span></code> value</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Bits</span></code>/<code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt.toBigInt</span></code></p></td>
<td><p>Read a hardware <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> as a Scala <code class="docutils literal notranslate"><span class="pre">BigInt</span></code> value</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SpinalEnumCraft.toEnum</span></code></p></td>
<td><p>Read a hardware <code class="docutils literal notranslate"><span class="pre">SpinalEnumCraft</span></code> as a Scala <code class="docutils literal notranslate"><span class="pre">SpinalEnumElement</span></code> value</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Bool</span> <span class="pre">#=</span> <span class="pre">Boolean</span></code></p></td>
<td><p>Assign a hardware <code class="docutils literal notranslate"><span class="pre">Bool</span></code> from an Scala <code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Bits</span></code>/<code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt</span> <span class="pre">#=</span> <span class="pre">Int</span></code></p></td>
<td><p>Assign a hardware <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> from a Scala <code class="docutils literal notranslate"><span class="pre">Int</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Bits</span></code>/<code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt</span> <span class="pre">#=</span> <span class="pre">Long</span></code></p></td>
<td><p>Assign a hardware <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> from a Scala <code class="docutils literal notranslate"><span class="pre">Long</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Bits</span></code>/<code class="docutils literal notranslate"><span class="pre">UInt</span></code>/<code class="docutils literal notranslate"><span class="pre">SInt</span> <span class="pre">#=</span> <span class="pre">BigInt</span></code></p></td>
<td><p>Assign a hardware <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> from a Scala <code class="docutils literal notranslate"><span class="pre">BigInt</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SpinalEnumCraft</span> <span class="pre">#=</span> <span class="pre">SpinalEnumElement</span></code></p></td>
<td><p>Assign a hardware <code class="docutils literal notranslate"><span class="pre">SpinalEnumCraft</span></code> from a Scala <code class="docutils literal notranslate"><span class="pre">SpinalEnumElement</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Data.randomize()</span></code></p></td>
<td><p>Assign a random value to a SpinalHDL value.</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="il">42l</span><span class="w"></span>
<span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;101010&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">(</span><span class="s">&quot;0123456789ABCDEF&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="accessing-signals-inside-the-component-s-hierarchy">
<h4>Accessing signals inside the component’s hierarchy<a class="headerlink" href="#accessing-signals-inside-the-component-s-hierarchy" title="Permalink to this heading"></a></h4>
<p>To access signals which are inside the component’s hierarchy, you have first to set the given signal as <code class="docutils literal notranslate"><span class="pre">simPublic</span></code>.</p>
<p>You can add this <code class="docutils literal notranslate"><span class="pre">simPublic</span></code> tag directly in the hardware description:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">SimAccessSubSignal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">simPublic</span><span class="p">()</span><span class="w"> </span><span class="c1">// Here we add the simPublic tag on the counter register to make it visible</span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">).</span><span class="n">doSim</span><span class="p">{</span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Or you can add it later, after having instantiated your toplevel for the simulation:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">SimAccessSubSignal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">compile</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"></span>
<span class="w">      </span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">simPublic</span><span class="p">()</span><span class="w">     </span><span class="c1">// Call simPublic() here</span>
<span class="w">      </span><span class="n">dut</span><span class="w"></span>
<span class="w">    </span><span class="p">}.</span><span class="n">doSim</span><span class="p">{</span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">counter</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="load-and-store-of-memory-in-simulation">
<span id="simulation-of-memory"></span><h4>Load and Store of Memory in Simulation<a class="headerlink" href="#load-and-store-of-memory-in-simulation" title="Permalink to this heading"></a></h4>
<p>It is possible to modify the contents of <code class="docutils literal notranslate"><span class="pre">Mem</span></code> hardware interface
components in simulation.  The <cite>data</cite> argument should be a word-width
value with the <cite>address</cite> being the word-address within.</p>
<p>There is no API to convert address and/or individual data bits into
units other than the natural word size.</p>
<p>There is no API to mark any memory location with simulation <cite>X</cite> (undefined)
state.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Mem.getBigInt(address:</span> <span class="pre">Long):</span> <span class="pre">BigInt</span></code></p></td>
<td><p>Read a word from simulator at the word-address.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Mem.setBigInt(address:</span> <span class="pre">Long,</span> <span class="pre">data:</span> <span class="pre">BigInt)</span></code></p></td>
<td><p>Write a word to simulator at the word-address.</p></td>
</tr>
</tbody>
</table>
<p>Using this simple example using a memory:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MemoryExample</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bit</span><span class="p">),</span><span class="w"> </span><span class="n">wordCount</span><span class="o">=</span><span class="n">wordCount</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mem</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">mem</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">i</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Setting up the simulation we make the memory accessible:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withVcdWave</span><span class="p">.</span><span class="n">compile</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MemoryExample</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="c1">// make memory accessible during simulation</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">simPublic</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">d</span><span class="w"></span>
<span class="w">  </span><span class="p">}.</span><span class="n">doSim</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
</pre></div>
</div>
<p>We can read data during simulation, but have to take care that the data is already available (might be
a cycle late due to simulation event ordering):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// do a write</span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">we</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="mh">0xaf</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// check written data is there</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">getBigInt</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xaf</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>And can write to memory like so:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// set some data in memory</span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">setBigInt</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// do a read to check if it&#39;s there</span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="mi">15</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">o</span><span class="p">.</span><span class="n">toBigInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Care has to be taken that due to event ordering in simulation e.g. the read depicted above has to be delayed
to when the value is actually available in the memory.</p>
</section>
</section>
<span id="document-SpinalHDL/Simulation/clock"></span><section id="clock-domains">
<h3>Clock domains<a class="headerlink" href="#clock-domains" title="Permalink to this heading"></a></h3>
<section id="stimulus-api">
<h4>Stimulus API<a class="headerlink" href="#stimulus-api" title="Permalink to this heading"></a></h4>
<p>Below is a list of <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> stimulation functions:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ClockDomain stimulus functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">forkStimulus(period)</span></code></p></td>
<td><p>Fork a simulation process to generate the ClockDomain stimulus (clock, reset, softReset, clockEnable signals)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">forkSimSpeedPrinter(printPeriod)</span></code></p></td>
<td><p>Fork a simulation process which will periodically print the simulation speed in kilo-cycles per real time second. <code class="docutils literal notranslate"><span class="pre">printPeriod</span></code> is in realtime seconds</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clockToggle()</span></code></p></td>
<td><p>Toggle the clock signal</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fallingEdge()</span></code></p></td>
<td><p>Clear the clock signal</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">risingEdge()</span></code></p></td>
<td><p>Set the clock signal</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">assertReset()</span></code></p></td>
<td><p>Set the reset signal to its active level</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">deassertReset()</span></code></p></td>
<td><p>Set the reset signal to its inactive level</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">assertClockEnable()</span></code></p></td>
<td><p>Set the clockEnable signal to its active level</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">deassertClockEnable()</span></code></p></td>
<td><p>Set the clockEnable signal to its active level</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">assertSoftReset()</span></code></p></td>
<td><p>Set the softReset signal to its active level</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">deassertSoftReset()</span></code></p></td>
<td><p>Set the softReset signal to its active level</p></td>
</tr>
</tbody>
</table>
</section>
<section id="wait-api">
<h4>Wait API<a class="headerlink" href="#wait-api" title="Permalink to this heading"></a></h4>
<p>Below is a list of <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> utilities that you can use to wait for a given event from the domain:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ClockDomain wait functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">waitSampling([cyclesCount])</span></code></p></td>
<td><p>Wait until the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> makes a sampling, (active clock edge &amp;&amp; deassertReset &amp;&amp; assertClockEnable)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">waitRisingEdge([cyclesCount])</span></code></p></td>
<td><p>Wait cyclesCount rising edges on the clock; cycleCount defaults to 1 cycle if not otherwise specified. Note, cyclesCount = 0 is legal, and the function is not sensitive to reset/softReset/clockEnable</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">waitFallingEdge([cyclesCount])</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitRisingEdge</span></code> but for the falling edge</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">waitActiveEdge([cyclesCount])</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitRisingEdge</span></code> but for the edge level specified by the <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">waitInactiveEdge([cyclesCount])</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitFallingEdge</span></code> but for the edge level specified by the <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">waitRisingEdgeWhere(condition)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitRisingEdge</span></code>, but to exit, the boolean <code class="docutils literal notranslate"><span class="pre">condition</span></code> must be true when the rising edge occurs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">waitFallingEdgeWhere(condition)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitRisingEdgeWhere</span></code>, but for the falling edge</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">waitActiveEdgeWhere(condition)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitRisingEdgeWhere</span></code>, but for the edge level specified by the <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">waitInactiveEdgeWhere(condition)</span></code></p></td>
<td><p>Same as <code class="docutils literal notranslate"><span class="pre">waitFallingEdgeWhere</span></code>, but for the edge level specified by the <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">waitSamplingWhere(condition)</span> <span class="pre">:</span> <span class="pre">Boolean</span></code></p></td>
<td><p>Wait until a clockdomain sampled and the given condition is true</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">waitSamplingWhere(timeout)(condition)</span> <span class="pre">:</span> <span class="pre">Boolean</span></code></p></td>
<td><p>Same as waitSamplingWhere defined above, but will never block more than timeout cycles. Return true if the exit condition came from the timeout</p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>All the functionality of the wait API can only be called directly from inside a thread, and not from a callback executed via the Callback API.</p>
</div>
</section>
<section id="callback-api">
<span id="sim-clock-threadless"></span><h4>Callback API<a class="headerlink" href="#callback-api" title="Permalink to this heading"></a></h4>
<p>Below is a list of <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> utilities that you can use to wait for a given event from the domain:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ClockDomain callback functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">onNextSampling</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Execute the callback code only once on the next <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> sample (active edge + reset off + clock enable on)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">onSamplings</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Execute the callback code each time the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> sample (active edge + reset off + clock enable on)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">onActiveEdges</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Execute the callback code each time the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> clock generates its configured edge</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">onEdges</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Execute the callback code each time the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> clock generates a rising or falling edge</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">onRisingEdges</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Execute the callback code each time the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> clock generates a rising edge</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">onFallingEdges</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Execute the callback code each time the <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> clock generates a falling edge</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">onSamplingWhile</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">:</span> <span class="pre">Boolean</span> <span class="pre">}</span></code></p></td>
<td><p>Same as onSampling, but you can stop it (forever) by letting the callback returning false</p></td>
</tr>
</tbody>
</table>
</section>
<section id="default-clockdomain">
<h4>Default ClockDomain<a class="headerlink" href="#default-clockdomain" title="Permalink to this heading"></a></h4>
<p>You can access the default <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> of your toplevel as shown below:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Example of thread forking to generate a reset, and then toggling the clock each 5 time units.</span>
<span class="c1">// dut.clockDomain refers to the implicit clock domain created during component instantiation.</span>
<span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">assertReset</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">fallingEdge</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">clockToggle</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Note that you can also directly fork a standard reset/clock process:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>An example of how to wait for a rising edge on the clock:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitRisingEdge</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="new-clockdomain">
<h4>New ClockDomain<a class="headerlink" href="#new-clockdomain" title="Permalink to this heading"></a></h4>
<p>If your toplevel defines some clock and reset inputs which aren’t directly integrated into their <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code>, you can define their corresponding <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> directly in the testbench:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// In the testbench</span>
<span class="nc">ClockDomain</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">coreClk</span><span class="p">,</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">coreReset</span><span class="p">).</span><span class="n">forkStimulus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Simulation/threadFull"></span><section id="thread-full-api">
<h3>Thread-full API<a class="headerlink" href="#thread-full-api" title="Permalink to this heading"></a></h3>
<p>In SpinalSim, you can write your testbench by using multiple threads in a similar way to SystemVerilog, and a bit like VHDL/Verilog process/always blocks.
This allows you to write concurrent tasks and control the simulation time using a fluent API.</p>
<section id="fork-and-join-simulation-threads">
<h4>Fork and join simulation threads<a class="headerlink" href="#fork-and-join-simulation-threads" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new thread</span>
<span class="kd">val</span><span class="w"> </span><span class="n">myNewThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// New simulation thread body</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Wait until `myNewThread` is execution is done.</span>
<span class="n">myNewThread</span><span class="p">.</span><span class="n">join</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sleep-and-waituntil">
<h4>Sleep and waitUntil<a class="headerlink" href="#sleep-and-waituntil" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Sleep 1000 units of time</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>

<span class="c1">// waitUntil the dut.io.a value is bigger than 42 before continuing</span>
<span class="n">waitUntil</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Simulation/threadLess"></span><section id="thread-less-api">
<h3>Thread-less API<a class="headerlink" href="#thread-less-api" title="Permalink to this heading"></a></h3>
<p>There are some functions that you can use to avoid the need for threading, but which still allow you to control the flow of simulation time.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Threadless functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">delayed(delay){</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Register the callback code to be called at a simulation time <code class="docutils literal notranslate"><span class="pre">delay</span></code> steps after the current timestep.</p></td>
</tr>
</tbody>
</table>
<p>The advantages of the <code class="docutils literal notranslate"><span class="pre">delayed</span></code> function over using a regular simulation thread + sleep are:</p>
<blockquote>
<div><ul class="simple">
<li><p>Performance (no context switching)</p></li>
<li><p>Memory usage (no native JVM thread memory allocation)</p></li>
</ul>
</div></blockquote>
<p>Some other thread-less functions related to <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> objects are documented as part of the <a class="reference internal" href="index.html#sim-clock-threadless"><span class="std std-ref">Callback API</span></a>, and some others related with the delta-cycle execution process are documented as part of the <a class="reference internal" href="index.html#sim-sensitive-api"><span class="std std-ref">Sensitive API</span></a></p>
</section>
<span id="document-SpinalHDL/Simulation/sensitive"></span><section id="sensitive-api">
<span id="sim-sensitive-api"></span><h3>Sensitive API<a class="headerlink" href="#sensitive-api" title="Permalink to this heading"></a></h3>
<p>You can register callback functions to be called on each delta-cycle of the simulation:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sensitive functions</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">forkSensitive</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Register the callback code to be called at each delta-cycle of the simulation</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">forkSensitiveWhile</span> <span class="pre">{</span> <span class="pre">callback</span> <span class="pre">}</span></code></p></td>
<td><p>Register the callback code to be called at each delta-cycle of the simulation, while the callback return value is true (meaning it should be rescheduled for the next delta-cycle)</p></td>
</tr>
</tbody>
</table>
</section>
<span id="document-SpinalHDL/Simulation/simulator_specifics"></span><section id="simulator-specific-details">
<h3>Simulator specific details<a class="headerlink" href="#simulator-specific-details" title="Permalink to this heading"></a></h3>
<section id="how-spinalhdl-simulates-the-hardware-with-verilator-backend">
<h4>How SpinalHDL simulates the hardware with Verilator backend<a class="headerlink" href="#how-spinalhdl-simulates-the-hardware-with-verilator-backend" title="Permalink to this heading"></a></h4>
<ol class="arabic simple">
<li><p>Behind the scenes, SpinalHDL generates a Verilog equivalent hardware model of the DUT and then uses Verilator to convert it to a C++ cycle-accurate model.</p></li>
<li><p>The C++ model is compiled into a shared object (.so), which is bound to Scala via JNI-FFI.</p></li>
<li><p>The native Verilator API is abstracted by providing a simulation multi-threaded API.</p></li>
</ol>
<p><strong>Advantages:</strong></p>
<ul class="simple">
<li><p>Since the Verilator backend uses a compiled C++ simulation model, the simulation speed is fast compared to most of the other commercial and free simulators.</p></li>
</ul>
<p><strong>Limitations:</strong></p>
<ul class="simple">
<li><p>Verilator accepts only synthesizable Verilog/System Verilog code. Therefore special care has to be taken when simulating Verilog blackbox components that may have non-synthesizable statements.</p></li>
<li><p>VHDL blackboxes cannot be simulated.</p></li>
<li><p>The simulation boot process is slow due to the necessity to compile and link the generated C++ model.  Some support to incrementally compile and link exists which can provide speedups for subsequent simulations after building the first.</p></li>
</ul>
</section>
<section id="how-spinalhdl-simulates-the-hardware-with-ghdl-icarus-verilog-backend">
<h4>How SpinalHDL simulates the hardware with GHDL/Icarus Verilog backend<a class="headerlink" href="#how-spinalhdl-simulates-the-hardware-with-ghdl-icarus-verilog-backend" title="Permalink to this heading"></a></h4>
<ol class="arabic simple">
<li><p>Depending on the chosen simulator, SpinalHDL generates a Verilog or VHDL hardware model of the DUT.</p></li>
<li><p>The HDL model is loaded in the simulator.</p></li>
<li><p>The communication between the simulation and the JVM is established through shared memory. The commands are issued to the simulator using <a class="reference external" href="https://en.wikipedia.org/wiki/Verilog_Procedural_Interface">VPI</a>.</p></li>
</ol>
<p><strong>Advantages:</strong></p>
<ul class="simple">
<li><p>Both GHDL and Icarus Verilog can accept non-synthesizable HDL code.</p></li>
<li><p>The simulation boot process is quite faster compared to Verilator.</p></li>
</ul>
<p><strong>Limitations:</strong></p>
<ul class="simple">
<li><p>GHDL accepts VHDL code only. Therefore only VHDL blackboxes can be used with this simulator.</p></li>
<li><p>Icarus Verilog accepts Verilog code only. Therefore only Verilog blackboxes can be used with this simulator.</p></li>
<li><p>The simulation speed is around one order of magnitude slower compared to Verilator.</p></li>
</ul>
<p>Finally, as the native Verilator API is rather crude, SpinalHDL abstracts over it by providing both single and multi-threaded simulation APIs to help the user construct testbench implementations.</p>
</section>
<section id="how-spinalhdl-simulates-the-hardware-with-synopsys-vcs-backend">
<h4>How SpinalHDL simulates the hardware with Synopsys VCS backend<a class="headerlink" href="#how-spinalhdl-simulates-the-hardware-with-synopsys-vcs-backend" title="Permalink to this heading"></a></h4>
<ol class="arabic simple">
<li><p>SpinalHDL generates a Verilog/VHDL (depended on your choice) hardware model of the DUT.</p></li>
<li><p>The HDL model is loaded in the simulator.</p></li>
<li><p>The communication between the simulation and the JVM is established through shared memory. The commands are issued to the simulator using <a class="reference external" href="https://en.wikipedia.org/wiki/Verilog_Procedural_Interface">VPI</a>.</p></li>
</ol>
<p><strong>Advantages:</strong></p>
<ul class="simple">
<li><p>Support all language features of SystemVerilog/Verilog/VHDL.</p></li>
<li><p>Support encrypted IP.</p></li>
<li><p>Support FSDB wave format dump.</p></li>
<li><p>High Performance of both compilation and simulation.</p></li>
</ul>
<p><strong>Limitations:</strong></p>
<ul class="simple">
<li><p>Synopsys VCS is a <strong>commercial</strong> simulation tool. It is close source and not free. You have to own the licenses to <strong>legally</strong> use it.</p></li>
</ul>
<p>Before using VCS as the simulation backend, make sure that you have checked your system environment as <a class="reference internal" href="index.html#vcs-env"><span class="std std-ref">VCS environment</span></a>.</p>
</section>
<section id="how-spinalhdl-simulates-the-hardware-with-xilinx-xsim-backend">
<h4>How SpinalHDL simulates the hardware with Xilinx XSim backend<a class="headerlink" href="#how-spinalhdl-simulates-the-hardware-with-xilinx-xsim-backend" title="Permalink to this heading"></a></h4>
<ol class="arabic simple">
<li><p>SpinalHDL generates a Verilog/VHDL (depended on your choice) hardware model of the DUT.</p></li>
<li><p>The HDL model is loaded in the simulator.</p></li>
<li><p>The communication between the simulation and the JVM is established through shared memory. The commands are issued to the simulator using XSI.</p></li>
</ol>
<p><strong>Advantages:</strong></p>
<ul class="simple">
<li><p>Support Xilinx built-in primitives and cores.</p></li>
</ul>
<p><strong>Limitations:</strong></p>
<ul class="simple">
<li><p>Xilinx XSim is a <strong>commercial</strong> tool installed with Vivado. It is closed source and subject to licensing terms to use. You have to own the licenses to <strong>legally</strong> use it.</p></li>
<li><p>Vivado versions prior to 2019.1 do not work properly.</p></li>
</ul>
<p>Before using XSim as the simulation backend, make sure that you have done following steps.
1. Define VIVADO_HOME environment variable to specify where your vivado located. ex <cite>export VIVADO_HOME=/d/Xilinx/Vivado/2022.1</cite> (under MSYS2).
2. Make sure two vivado path is inside the PATH. For Windows MSYS2 user, run shell command like <cite>export PATH=$PATH:$VIVADO_HOME/bin:$VIVADO_HOME/lib/win64.o</cite>. For Linux user just source the Vivado’s settings64.sh file located at <cite>VIVADO_HOME</cite>.</p>
</section>
<section id="performance">
<h4>Performance<a class="headerlink" href="#performance" title="Permalink to this heading"></a></h4>
<p>When a high-performance simulation is required, Verilator should be used as a backend. On a little SoC like <a class="reference external" href="https://github.com/SpinalHDL/VexRiscv">Murax</a>, an Intel® Core™ i7-4720HQ is capable of simulating 1.2 million clock cycles per second. However, when the DUT is simple and a maximum of few thousands clock cycles have to be simulated, using GHDL or Icarus Verilog could yield a better result, due to their lower simulation loading overhead.</p>
</section>
</section>
<span id="document-SpinalHDL/Simulation/engine"></span><section id="simulation-engine">
<h3>Simulation engine<a class="headerlink" href="#simulation-engine" title="Permalink to this heading"></a></h3>
<p>This page explains the internals of the simulation engine.</p>
<p>The simulation engine emulates an event-driven simulator (VHDL/Verilog like) by applying the following simulation loop on the top of the Verilator C++ simulation model:</p>
<img alt="_images/simEngine.png" class="align-center" src="_images/simEngine.png" />
<p>At a low level, the simulation engine manages the following primitives:</p>
<blockquote>
<div><ul class="simple">
<li><p><em>Sensitive callbacks</em>, which allow users to call a function on each simulation delta cycle.</p></li>
<li><p><em>Delayed callbacks</em>, which allow users to call a function at a future simulation time.</p></li>
<li><p><em>Simulation threads</em>, which allow users to describe concurrent processes.</p></li>
<li><p><em>Command buffer</em>, which allows users to delay write access to the <abbr title="Device Under Test">DUT</abbr> until the end of the current delta cycle.</p></li>
</ul>
</div></blockquote>
<p>There are some practical uses of those primitives:</p>
<blockquote>
<div><ul class="simple">
<li><p>Sensitive callbacks can be used to wake up a simulation thread when a given condition happens, like a rising edge on a clock.</p></li>
<li><p>Delayed callbacks can be used to schedule stimuli, such as deasserting a reset after a given time, or toggling the clock.</p></li>
<li><p>Both sensitive and delayed callbacks can be used to resume a simulation thread.</p></li>
<li><p>A simulation thread can be used (for instance) to produce stimulus and check the DUT’s output values.</p></li>
<li><p>The command buffer’s purpose is mainly to avoid all concurrency issues between the DUT and the testbench.</p></li>
</ul>
</div></blockquote>
</section>
<span id="document-SpinalHDL/Simulation/examples/index"></span><section id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Simulation/examples/asynchronous"></span><section id="asynchronous-adder">
<span id="sim-example-asynchronous-adder"></span><h4>Asynchronous adder<a class="headerlink" href="#asynchronous-adder" title="Permalink to this heading"></a></h4>
<p>This example creates a <code class="docutils literal notranslate"><span class="pre">Component</span></code> out of combinational logic that does some simple arithmetic on 3 operands.</p>
<p>The test bench performs the following steps 100 times:</p>
<blockquote>
<div><ul class="simple">
<li><p>Initialize <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> to random integers in the 0..255 range.</p></li>
<li><p>Stimulate the <abbr title="Device Under Test">DUT</abbr>’s matching <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">c</span></code> inputs.</p></li>
<li><p>Wait 1 simulation timestep (to allow the inputs to propagate).</p></li>
<li><p>Check for correct output.</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nc">Random</span>


<span class="k">object</span><span class="w"> </span><span class="nc">SimAsynchronousExample</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Dut</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Dut</span><span class="p">).</span><span class="n">doSim</span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// Sleep 1 simulation timestep</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Simulation/examples/dual_clock_fifo"></span><section id="dual-clock-fifo">
<span id="sim-example-dual-clock-fifo"></span><h4>Dual clock fifo<a class="headerlink" href="#dual-clock-fifo" title="Permalink to this heading"></a></h4>
<p>This example creates a <code class="docutils literal notranslate"><span class="pre">StreamFifoCC</span></code>, which is designed for crossing clock domains, along with 3 simulation threads.</p>
<p>The threads handle:</p>
<blockquote>
<div><ul class="simple">
<li><p>Management of the two clocks</p></li>
<li><p>Pushing to the FIFO</p></li>
<li><p>Popping from the FIFO</p></li>
</ul>
</div></blockquote>
<p>The FIFO push thread randomizes the inputs.</p>
<p>The FIFO pop thread handles checking the the <abbr title="Device Under Test">DUT</abbr>’s outputs against the reference model (an ordinary <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Queue</span></code> instance).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">mutable</span><span class="p">.</span><span class="nc">Queue</span>


<span class="k">object</span><span class="w"> </span><span class="nc">SimStreamFifoCCExample</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Compile the Component for the simulator.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">compiled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">allOptimisation</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">rtl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StreamFifoCC</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">dataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">pushClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkA&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">popClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;clkB&quot;</span><span class="p">,</span><span class="n">withReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Run the simulation.</span>
<span class="w">    </span><span class="n">compiled</span><span class="p">.</span><span class="n">doSimUntilVoid</span><span class="p">{</span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">queueModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutable</span><span class="p">.</span><span class="nc">Queue</span><span class="p">[</span><span class="nc">Long</span><span class="p">]()</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Fork a thread to manage the clock domains signals</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">clocksThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Clear the clock domains&#39; signals, to be sure the simulation captures their first edges.</span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">pushClock</span><span class="p">.</span><span class="n">fallingEdge</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">popClock</span><span class="p">.</span><span class="n">fallingEdge</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">pushClock</span><span class="p">.</span><span class="n">deassertReset</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Do the resets.</span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">pushClock</span><span class="p">.</span><span class="n">assertReset</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">pushClock</span><span class="p">.</span><span class="n">deassertReset</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Forever, randomly toggle one of the clocks.</span>
<span class="w">        </span><span class="c1">// This will create asynchronous clocks without fixed frequencies.</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="nc">Random</span><span class="p">.</span><span class="n">nextBoolean</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dut</span><span class="p">.</span><span class="n">pushClock</span><span class="p">.</span><span class="n">clockToggle</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dut</span><span class="p">.</span><span class="n">popClock</span><span class="p">.</span><span class="n">clockToggle</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Push data randomly, and fill the queueModel with pushed transactions.</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">pushThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">pushClock</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">ready</span><span class="p">.</span><span class="n">toBoolean</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">queueModel</span><span class="p">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">toLong</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Pop data randomly, and check that it match with the queueModel.</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">popThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">100000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">ready</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">popClock</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">ready</span><span class="p">.</span><span class="n">toBoolean</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">toLong</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">queueModel</span><span class="p">.</span><span class="n">dequeue</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">simSuccess</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Simulation/examples/single_clock_fifo"></span><section id="single-clock-fifo">
<span id="sim-example-single-clock-fifo"></span><h4>Single clock fifo<a class="headerlink" href="#single-clock-fifo" title="Permalink to this heading"></a></h4>
<p>This example creates a <code class="docutils literal notranslate"><span class="pre">StreamFifo</span></code>, and spawns 3 simulation threads.
Unlike the <a class="reference internal" href="index.html#sim-example-dual-clock-fifo"><span class="std std-ref">Dual clock fifo</span></a> example, this FIFO does not need complex clock management.</p>
<p>The 3 simulation threads handle:</p>
<blockquote>
<div><ul class="simple">
<li><p>Managing the clock/reset</p></li>
<li><p>Pushing to the FIFO</p></li>
<li><p>Popping from the FIFO</p></li>
</ul>
</div></blockquote>
<p>The FIFO push thread randomizes the inputs.</p>
<p>The FIFO pop thread handles checking the the <abbr title="Device Under Test">DUT</abbr>’s outputs against the reference model (an ordinary <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Queue</span></code> instance).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">mutable</span><span class="p">.</span><span class="nc">Queue</span>


<span class="k">object</span><span class="w"> </span><span class="nc">SimStreamFifoExample</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Compile the Component for the simulator.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">compiled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">allOptimisation</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">rtl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StreamFifo</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">dataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Run the simulation.</span>
<span class="w">    </span><span class="n">compiled</span><span class="p">.</span><span class="n">doSimUntilVoid</span><span class="p">{</span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">queueModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutable</span><span class="p">.</span><span class="nc">Queue</span><span class="p">[</span><span class="nc">Long</span><span class="p">]()</span><span class="w"></span>

<span class="w">      </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nc">SimTimeout</span><span class="p">(</span><span class="mi">1000000</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Push data randomly, and fill the queueModel with pushed transactions.</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">pushThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">ready</span><span class="p">.</span><span class="n">toBoolean</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">queueModel</span><span class="p">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">toLong</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Pop data randomly, and check that it match with the queueModel.</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">popThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">100000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">ready</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">ready</span><span class="p">.</span><span class="n">toBoolean</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">toLong</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">queueModel</span><span class="p">.</span><span class="n">dequeue</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">simSuccess</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Simulation/examples/synchronous"></span><section id="synchronous-adder">
<span id="sim-example-synchronous-adder"></span><h4>Synchronous adder<a class="headerlink" href="#synchronous-adder" title="Permalink to this heading"></a></h4>
<p>This example creates a <code class="docutils literal notranslate"><span class="pre">Component</span></code> out of sequential logic that does some simple arithmetic on 3 operands.</p>
<p>The test bench performs the following steps 100 times:</p>
<blockquote>
<div><ul class="simple">
<li><p>Initialize <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> to random integers in the 0..255 range.</p></li>
<li><p>Stimulate the <abbr title="Device Under Test">DUT</abbr>’s matching <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">c</span></code> inputs.</p></li>
<li><p>Wait until the simulation samples the DUT’s signals again.</p></li>
<li><p>Check for correct output.</p></li>
</ul>
</div></blockquote>
<p>The main difference between this example and the <a class="reference internal" href="index.html#sim-example-asynchronous-adder"><span class="std std-ref">Asynchronous adder</span></a> example is that this <code class="docutils literal notranslate"><span class="pre">Component</span></code> has to use <code class="docutils literal notranslate"><span class="pre">forkStimulus</span></code> to generate a clock signal, since it is using sequential logic internally.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">sim</span><span class="p">.</span><span class="n">_</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nc">Random</span>


<span class="k">object</span><span class="w"> </span><span class="nc">SimSynchronousExample</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Dut</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SimConfig</span><span class="p">.</span><span class="n">withWave</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Dut</span><span class="p">).</span><span class="n">doSim</span><span class="p">{</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">forkStimulus</span><span class="p">(</span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="n">resultModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dut</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">waitSampling</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">resultModel</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resultModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">toInt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Simulation/examples/uart_decoder"></span><section id="uart-decoder">
<h4>Uart decoder<a class="headerlink" href="#uart-decoder" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Fork a simulation process which will analyze the uartPin and print transmitted bytes into the simulation terminal.</span>
<span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Wait until the design sets the uartPin to true (wait for the reset effect).</span>
<span class="w">  </span><span class="n">waitUntil</span><span class="p">(</span><span class="n">uartPin</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">waitUntil</span><span class="p">(</span><span class="n">uartPin</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">uartPin</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">bitId</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">uartPin</span><span class="p">.</span><span class="n">toBoolean</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">buffer</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bitId</span><span class="w"></span>
<span class="w">      </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">uartPin</span><span class="p">.</span><span class="n">toBoolean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">toChar</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Simulation/examples/uart_encoder"></span><section id="uart-encoder">
<h4>Uart encoder<a class="headerlink" href="#uart-encoder" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Fork a simulation process which will get chars typed into the simulation terminal and transmit them on the simulation uartPin.</span>
<span class="n">fork</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">uartPin</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// System.in is the java equivalent of the C&#39;s stdin.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nc">System</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">System</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="n">uartPin</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="n">bitId</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">uartPin</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="p">((</span><span class="n">buffer</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bitId</span><span class="p">)</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">uartPin</span><span class="w"> </span><span class="o">#=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">      </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sleep</span><span class="p">(</span><span class="n">baudPeriod</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="c1">// Sleep a little while to avoid polling System.in too often.</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/Formal verification/index"></span><section id="formal-verification">
<h2>Formal verification<a class="headerlink" href="#formal-verification" title="Permalink to this heading"></a></h2>
<section id="general">
<h3>General<a class="headerlink" href="#general" title="Permalink to this heading"></a></h3>
<p>SpinalHDL allows to generate a subset of the SystemVerilog Assertions (SVA). Mostly assert, assume, cover and a few others.</p>
<p>In addition it provide a formal verification backend which allows to directly run the formal verification in the open-source Symbi-Yosys toolchain.</p>
</section>
<section id="formal-backend">
<h3>Formal backend<a class="headerlink" href="#formal-backend" title="Permalink to this heading"></a></h3>
<p>You can run the formal verification of a component via:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">formal</span><span class="p">.</span><span class="n">_</span>
<span class="nc">FormalConfig</span><span class="p">.</span><span class="n">withBMC</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">doVerify</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Toplevel to verify</span>
<span class="p">})</span><span class="w"></span>
</pre></div>
</div>
<p>Currently, 3 modes are supported :</p>
<ul class="simple">
<li><p>withBMC(depth)</p></li>
<li><p>withProve(depth)</p></li>
<li><p>withCover(depth)</p></li>
</ul>
</section>
<section id="installing-requirements">
<h3>Installing requirements<a class="headerlink" href="#installing-requirements" title="Permalink to this heading"></a></h3>
<p>To install the Symbi-Yosys, you have a few options. You can fetch a precompiled package at:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/YosysHQ/oss-cad-suite-build/releases">https://github.com/YosysHQ/oss-cad-suite-build/releases</a></p></li>
<li><p><a class="reference external" href="https://github.com/YosysHQ/fpga-toolchain/releases">https://github.com/YosysHQ/fpga-toolchain/releases</a> (EOL - superseded by oss-cad-suite)</p></li>
</ul>
<p>Or you can compile things from scratch :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://symbiyosys.readthedocs.io/en/latest/install.html">https://symbiyosys.readthedocs.io/en/latest/install.html</a></p></li>
</ul>
</section>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h3>
<section id="external-assertions">
<h4>External assertions<a class="headerlink" href="#external-assertions" title="Permalink to this heading"></a></h4>
<p>Here is an example of a simple counter and the corresponding formal testbench.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// Here is our DUT</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LimitedCounter</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The value register will always be between [2:10]</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">LimitedCounterFormal</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// import utilities to run the formal verification, but also some utilities to describe formal stuff</span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">formal</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="c1">// Here we run a formal verification which will explore the state space up to 15 cycles to find an assertion failure</span>
<span class="w">  </span><span class="nc">FormalConfig</span><span class="p">.</span><span class="n">withBMC</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">doVerify</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Instantiate our LimitedCounter DUT as a FormalDut, which ensure that all the outputs of the dut are:</span>
<span class="w">    </span><span class="c1">// - directly and indirectly driven (no latch / no floating signal)</span>
<span class="w">    </span><span class="c1">// - allows the current toplevel to read every signal across the hierarchy</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FormalDut</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">LimitedCounter</span><span class="p">())</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Ensure that the state space start with a proper reset</span>
<span class="w">    </span><span class="n">assumeInitial</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">isResetActive</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Check a few things</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="internal-assertions">
<h4>Internal assertions<a class="headerlink" href="#internal-assertions" title="Permalink to this heading"></a></h4>
<p>If you want you can embed formal statements directly into the DUT:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LimitedCounterEmbedded</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// That code block will not be in the SpinalVerilog netlist by default. (would need to enable SpinalConfig().includeFormal. ...</span>
<span class="w">  </span><span class="nc">GenerationFlags</span><span class="p">.</span><span class="n">formal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">LimitedCounterEmbeddedFormal</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">formal</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="nc">FormalConfig</span><span class="p">.</span><span class="n">withBMC</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">doVerify</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FormalDut</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">LimitedCounterEmbedded</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">assumeInitial</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">isResetActive</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="external-stimulus">
<h4>External stimulus<a class="headerlink" href="#external-stimulus" title="Permalink to this heading"></a></h4>
<p>If your DUT has inputs, you need to drive them from the testbench. You can use all the regular hardware statements to do it,
but you can also use the formal <cite>anyseq</cite>, <cite>anyconst</cite>, <cite>allseq</cite>, <cite>allconst</cite> statement:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LimitedCounterInc</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Only increment the value when the inc input is set</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">inc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">LimitedCounterIncFormal</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">formal</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="nc">FormalConfig</span><span class="p">.</span><span class="n">withBMC</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">doVerify</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FormalDut</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">LimitedCounterInc</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">assumeInitial</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">isResetActive</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Drive dut.inc with random values</span>
<span class="w">    </span><span class="n">anyseq</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">inc</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="more-assertions-past">
<h4>More assertions / past<a class="headerlink" href="#more-assertions-past" title="Permalink to this heading"></a></h4>
<p>For instance we can check that the value is counting up (if not already at 10):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">FormalConfig</span><span class="p">.</span><span class="n">withBMC</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">doVerify</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FormalDut</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">LimitedCounter</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="n">assumeInitial</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">isResetActive</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Check that the value is incrementing.</span>
<span class="w">  </span><span class="c1">// hasPast is used to ensure that the past(dut.value) had at least one sampling out of reset</span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">pastValid</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">past</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">past</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="assuming-memory-content">
<h4>Assuming memory content<a class="headerlink" href="#assuming-memory-content" title="Permalink to this heading"></a></h4>
<p>Here is an example where we want to prevent the value <code class="docutils literal notranslate"><span class="pre">1</span></code> from ever being present in a memory :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DutWithRam</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">4</span><span class="p">)(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="n">ram</span><span class="p">.</span><span class="n">writePort</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="n">ram</span><span class="p">.</span><span class="n">readAsyncPort</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">FormalRam</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">formal</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="nc">FormalConfig</span><span class="p">.</span><span class="n">withBMC</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="n">doVerify</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FormalDut</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">DutWithRam</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">assumeInitial</span><span class="p">(</span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">isResetActive</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// assume that no word in the ram has the value 1</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">ram</span><span class="p">.</span><span class="n">wordCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assumeInitial</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">ram</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Allow the write anything but value 1 in the ram</span>
<span class="w">    </span><span class="n">anyseq</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">write</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">clockDomain</span><span class="p">.</span><span class="n">withoutReset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// As the memory write can occur during reset, we need to ensure the assume apply there too</span>
<span class="w">      </span><span class="n">assume</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Check that no word in the ram is set to 1</span>
<span class="w">    </span><span class="n">anyseq</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="utilities-and-primitives">
<h3>Utilities and primitives<a class="headerlink" href="#utilities-and-primitives" title="Permalink to this heading"></a></h3>
<section id="assertions-clock-reset">
<h4>Assertions / clock / reset<a class="headerlink" href="#assertions-clock-reset" title="Permalink to this heading"></a></h4>
<p>Assertions are always clocked and disabled during resets. This also apply for assumes and covers.</p>
<p>If you want to keep your assertion enabled during reset you can do:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">withoutReset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">wuff</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="specifying-the-initial-value-of-a-signal">
<h4>Specifying the initial value of a signal<a class="headerlink" href="#specifying-the-initial-value-of-a-signal" title="Permalink to this heading"></a></h4>
<p>For instance, for the reset signal of the current clockdomain (useful at the top)</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">readResetWire</span><span class="w"> </span><span class="n">initial</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="specifying-a-initial-assumption">
<h4>Specifying a initial assumption<a class="headerlink" href="#specifying-a-initial-assumption" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">assumeInitial</span><span class="p">(</span><span class="n">clockDomain</span><span class="p">.</span><span class="n">isResetActive</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="memory-content-mem">
<h4>Memory content (Mem)<a class="headerlink" href="#memory-content-mem" title="Permalink to this heading"></a></h4>
<p>If you have a Mem in your design, and you want to check its content, you can do it the following ways :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Manual access</span>
<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">dut</span><span class="p">.</span><span class="n">ram</span><span class="p">.</span><span class="n">wordCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assumeInitial</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">ram</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="nc">X</span><span class="p">)</span><span class="w"> </span><span class="c1">// No occurrence of the word X</span>
<span class="p">}</span><span class="w"></span>

<span class="n">assumeInitial</span><span class="p">(</span><span class="o">!</span><span class="n">dut</span><span class="p">.</span><span class="n">ram</span><span class="p">.</span><span class="n">formalContains</span><span class="p">(</span><span class="nc">X</span><span class="p">))</span><span class="w"> </span><span class="c1">// No occurrence of the word X</span>

<span class="n">assumeInitial</span><span class="p">(</span><span class="n">dut</span><span class="p">.</span><span class="n">ram</span><span class="p">.</span><span class="n">formalCount</span><span class="p">(</span><span class="nc">X</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// only one occurrence of the word X</span>
</pre></div>
</div>
</section>
<section id="specifying-assertion-in-the-reset-scope">
<h4>Specifying assertion in the reset scope<a class="headerlink" href="#specifying-assertion-in-the-reset-scope" title="Permalink to this heading"></a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">duringReset</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assume</span><span class="p">(</span><span class="n">rawrrr</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">assume</span><span class="p">(</span><span class="n">wuff</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="formal-primitives">
<h4>Formal primitives<a class="headerlink" href="#formal-primitives" title="Permalink to this heading"></a></h4>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 14%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Returns</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">assert(Bool)</span></code></p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">assume(Bool)</span></code></p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cover(Bool)</span></code></p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">past(that</span> <span class="pre">:</span> <span class="pre">T,</span> <span class="pre">delay</span> <span class="pre">:</span> <span class="pre">Int)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">past(that</span> <span class="pre">:</span> <span class="pre">T)</span></code></div>
</div>
</td>
<td><p>T</p></td>
<td><p>Return <code class="docutils literal notranslate"><span class="pre">that</span></code> delayed by <code class="docutils literal notranslate"><span class="pre">delay</span></code> cycles. (default 1 cycle)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rose(that</span> <span class="pre">:</span> <span class="pre">Bool)</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Return True when <code class="docutils literal notranslate"><span class="pre">that</span></code> transitioned from False to True</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fell(that</span> <span class="pre">:</span> <span class="pre">Bool)</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Return True when <code class="docutils literal notranslate"><span class="pre">that</span></code> transitioned from True to False</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">changed(that</span> <span class="pre">:</span> <span class="pre">Bool)</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Return True when <code class="docutils literal notranslate"><span class="pre">that</span></code> current value changed between compared to the last cycle</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">stable(that</span> <span class="pre">:</span> <span class="pre">Bool)</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Return True when <code class="docutils literal notranslate"><span class="pre">that</span></code> current value didn’t changed between compared to the last cycle</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">initstate()</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Return True the first cycle</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pastValid()</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Returns True when the past value is valid (False on the first cycle). Recommended to be used with each application of <code class="docutils literal notranslate"><span class="pre">past</span></code>, <code class="docutils literal notranslate"><span class="pre">rose</span></code>, <code class="docutils literal notranslate"><span class="pre">fell</span></code>, <code class="docutils literal notranslate"><span class="pre">changed</span></code> and <code class="docutils literal notranslate"><span class="pre">stable</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pastValidAfterReset()</span></code></p></td>
<td><p>Bool</p></td>
<td><p>Similar to <code class="docutils literal notranslate"><span class="pre">pastValid</span></code>, where only difference is that this would take reset into account. Can be understood as <code class="docutils literal notranslate"><span class="pre">pastValid</span> <span class="pre">&amp;</span> <span class="pre">past(!reset)</span></code>.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Note that you can use the init statement on past:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">past</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">False</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading"></a></h3>
<p>There is no support for unclocked assertions. But their usage in third party formal verification examples seems mostly code style related.</p>
</section>
<section id="naming-polices">
<h3>Naming polices<a class="headerlink" href="#naming-polices" title="Permalink to this heading"></a></h3>
<p>All formal validation related functions return Area or Composite (preferred), and naming as formalXXXX.
<code class="docutils literal notranslate"><span class="pre">formalContext</span></code> can be used to create formal related logic, there could be <code class="docutils literal notranslate"><span class="pre">formalAsserts</span></code>, <code class="docutils literal notranslate"><span class="pre">formalAssumes</span></code> and <code class="docutils literal notranslate"><span class="pre">formalCovers</span></code> in it.</p>
<section id="for-component">
<h4>For Component<a class="headerlink" href="#for-component" title="Permalink to this heading"></a></h4>
<p>The minimum required assertions internally in a <code class="docutils literal notranslate"><span class="pre">Component</span></code> for “prove” can be named as <code class="docutils literal notranslate"><span class="pre">formalAsserts</span></code>.</p>
</section>
<section id="for-interfaces-implement-imasterslave">
<h4>For interfaces implement IMasterSlave<a class="headerlink" href="#for-interfaces-implement-imasterslave" title="Permalink to this heading"></a></h4>
<p>There could be functions in name <code class="docutils literal notranslate"><span class="pre">formalAssertsMaster</span></code>, <code class="docutils literal notranslate"><span class="pre">formalAssertsSlave</span></code>, <code class="docutils literal notranslate"><span class="pre">formalAssumesMaster</span></code>, <code class="docutils literal notranslate"><span class="pre">formalAssumesSlave</span></code> or <code class="docutils literal notranslate"><span class="pre">formalCovers</span></code>.
Master/Slave are target interface type, so that <code class="docutils literal notranslate"><span class="pre">formalAssertsMaster</span></code> can be understand as “formal verification assertions for master interface”.</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Examples/index"></span><section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h2>
<div class="toctree-wrapper compound" id="example-list">
<span id="document-SpinalHDL/Examples/Simple ones/index"></span><section id="simple-ones">
<h3>Simple ones<a class="headerlink" href="#simple-ones" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Examples/Simple ones/apb3"></span><section id="apb3-definition">
<span id="example-apb3"></span><h4>APB3 definition<a class="headerlink" href="#apb3-definition" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>This example will show the syntax to define an APB3 <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>.</p>
</section>
<section id="specification">
<h5>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h5>
<p>The specification from ARM could be interpreted as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signal Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Driver side</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PADDR</p></td>
<td><p>UInt(addressWidth bits)</p></td>
<td><p>Master</p></td>
<td><p>Address in byte</p></td>
</tr>
<tr class="row-odd"><td><p>PSEL</p></td>
<td><p>Bits(selWidth)</p></td>
<td><p>Master</p></td>
<td><p>One bit per slave</p></td>
</tr>
<tr class="row-even"><td><p>PENABLE</p></td>
<td><p>Bool</p></td>
<td><p>Master</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>PWRITE</p></td>
<td><p>Bool</p></td>
<td><p>Master</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>PWDATA</p></td>
<td><p>Bits(dataWidth bits)</p></td>
<td><p>Master</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>PREADY</p></td>
<td><p>Bool</p></td>
<td><p>Slave</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>PRDATA</p></td>
<td><p>Bits(dataWidth bits)</p></td>
<td><p>Slave</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>PSLVERROR</p></td>
<td><p>Bool</p></td>
<td><p>Slave</p></td>
<td><p>Optional</p></td>
</tr>
</tbody>
</table>
</section>
<section id="implementation">
<h5>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h5>
<p>This specification shows that the APB3 bus has multiple possible configurations. To represent that, we can define a configuration class in Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">selWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">useSlaveError</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then we can define the APB3 <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> which will be used to represent the bus in hardware:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">PADDR</span><span class="p">,</span><span class="nc">PSEL</span><span class="p">,</span><span class="nc">PENABLE</span><span class="p">,</span><span class="nc">PWRITE</span><span class="p">,</span><span class="nc">PWDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="nc">PREADY</span><span class="p">,</span><span class="nc">PRDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">PSLVERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="usage">
<h5>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h5>
<p>Here is a usage example of this definition:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3User</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PREADY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PSEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PENABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PRDATA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">Apb3User</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">selWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="nc">Apb3User</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Examples/Simple ones/carry_adder"></span><section id="carry-adder">
<h4>Carry adder<a class="headerlink" href="#carry-adder" title="Permalink to this heading"></a></h4>
<p>This example defines a component with inputs <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>, and a <code class="docutils literal notranslate"><span class="pre">result</span></code> output.
At any time, <code class="docutils literal notranslate"><span class="pre">result</span></code> will be the sum of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> (combinatorial).
This sum is manually done by a carry adder logic.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">CarryAdder</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">  </span><span class="c1">// result = a + b</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w">   </span><span class="c1">// Carry, like a VHDL variable</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Create some intermediate value in the loop scope.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// The carry adder&#39;s asynchronous logic</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="c1">// variable assignment</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">CarryAdderProject</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="nc">CarryAdder</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Examples/Simple ones/color_summing"></span><section id="color-summing">
<h4>Color summing<a class="headerlink" href="#color-summing" title="Permalink to this heading"></a></h4>
<p>First let’s define a Color <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> with an addition operator.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">+</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">Color</span><span class="p">):</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">r</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">g</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">():</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then let’s define a component with a <code class="docutils literal notranslate"><span class="pre">sources</span></code> input which is a vector of colors, and a <code class="docutils literal notranslate"><span class="pre">result</span></code> output which is the sum of the <code class="docutils literal notranslate"><span class="pre">sources</span></code> input.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ColorSumming</span><span class="p">(</span><span class="n">sourceCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">),</span><span class="w"> </span><span class="n">sourceCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">sum</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">sourceCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">sources</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Examples/Simple ones/counter_with_clear"></span><section id="counter-with-clear">
<h4>Counter with clear<a class="headerlink" href="#counter-with-clear" title="Permalink to this heading"></a></h4>
<p>This example defines a component with a <code class="docutils literal notranslate"><span class="pre">clear</span></code> input and a <code class="docutils literal notranslate"><span class="pre">value</span></code> output.
Each clock cycle, the <code class="docutils literal notranslate"><span class="pre">value</span></code> output is incrementing, but when <code class="docutils literal notranslate"><span class="pre">clear</span></code> is high, <code class="docutils literal notranslate"><span class="pre">value</span></code> is cleared.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Counter</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">register</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clear</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">register</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">register</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Examples/Simple ones/pll_resetctrl"></span><section id="pll-blackbox-and-reset-controller">
<h4>PLL BlackBox and reset controller<a class="headerlink" href="#pll-blackbox-and-reset-controller" title="Permalink to this heading"></a></h4>
<p>Let’s imagine you want to define a <code class="docutils literal notranslate"><span class="pre">TopLevel</span></code> component which instantiates a PLL <code class="docutils literal notranslate"><span class="pre">BlackBox</span></code>, and create a new clock domain from it which will be used by your core logic. Let’s also imagine that you want to adapt an external asynchronous reset into this core clock domain to a synchronous reset source.</p>
<p>The following imports will be used in code examples on this page:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
<section id="the-pll-blackbox-definition">
<h5>The PLL BlackBox definition<a class="headerlink" href="#the-pll-blackbox-definition" title="Permalink to this heading"></a></h5>
<p>This is how to define the PLL <code class="docutils literal notranslate"><span class="pre">BlackBox</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PLL</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">isLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">noIoPrefix</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This will correspond to the following VHDL component:</p>
<div class="highlight-VHDL notranslate"><div class="highlight"><pre><span></span><span class="k">component</span><span class="w"> </span><span class="nc">PLL</span><span class="w"> </span><span class="k">is</span><span class="w"></span>
<span class="w">  </span><span class="k">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clkIn</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">clkOut</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">isLocked</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="kt">std_logic</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">component</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="toplevel-definition">
<h5>TopLevel definition<a class="headerlink" href="#toplevel-definition" title="Permalink to this heading"></a></h5>
<p>This is how to define your <code class="docutils literal notranslate"><span class="pre">TopLevel</span></code> which instantiates the PLL, creates the new <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code>, and also adapts the asynchronous reset input to a synchronous reset:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">aReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk100Mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Create an Area to manage all clocks and reset things</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Instantiate and drive the PLL</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PLL</span><span class="w"></span>
<span class="w">    </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clkIn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">clk100Mhz</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create a new clock domain named &#39;core&#39;</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">internal</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;core&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">200</span><span class="w"> </span><span class="nc">MHz</span><span class="p">)</span><span class="w">  </span><span class="c1">// This frequency specification can be used</span>
<span class="w">    </span><span class="p">)</span><span class="w">                                      </span><span class="c1">// by coreClockDomain users to do some calculations</span>

<span class="w">    </span><span class="c1">// Drive clock and reset signals of the coreClockDomain previously created</span>
<span class="w">    </span><span class="n">coreClockDomain</span><span class="p">.</span><span class="n">clock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clkOut</span><span class="w"></span>
<span class="w">    </span><span class="n">coreClockDomain</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">ResetCtrl</span><span class="p">.</span><span class="n">asyncAssertSyncDeassert</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">aReset</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">isLocked</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">clockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Create a ClockingArea which will be under the effect of the clkCtrl.coreClockDomain</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">clkCtrl</span><span class="p">.</span><span class="n">coreClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Do your stuff which use coreClockDomain here</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Examples/Simple ones/rgb_to_gray"></span><section id="rgb-to-gray">
<h4>RGB to gray<a class="headerlink" href="#rgb-to-gray" title="Permalink to this heading"></a></h4>
<p>Let’s imagine a component that converts an RGB color into a gray one, and then writes it into external memory.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>io name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>clear</p></td>
<td><p>in</p></td>
<td><p>Clear all internal registers</p></td>
</tr>
<tr class="row-odd"><td><p>r,g,b</p></td>
<td><p>in</p></td>
<td><p>Color inputs</p></td>
</tr>
<tr class="row-even"><td><p>wr</p></td>
<td><p>out</p></td>
<td><p>Memory write</p></td>
</tr>
<tr class="row-odd"><td><p>address</p></td>
<td><p>out</p></td>
<td><p>Memory address, incrementing each cycle</p></td>
</tr>
<tr class="row-even"><td><p>data</p></td>
<td><p>out</p></td>
<td><p>Memory data, gray level</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RgbToGray</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">scaled</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">,</span><span class="n">by</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">):</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">U</span><span class="p">((</span><span class="mi">255</span><span class="o">*</span><span class="n">by</span><span class="p">).</span><span class="n">toInt</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">scaled</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">r</span><span class="p">,</span><span class="mf">0.3f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="n">scaled</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">g</span><span class="p">,</span><span class="mf">0.4f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="n">scaled</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="mf">0.3f</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="n">stateCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">address</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">gray</span><span class="w"></span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clear</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gray</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<span id="document-SpinalHDL/Examples/Simple ones/sinus_rom"></span><section id="sinus-rom">
<span id="id1"></span><h4>Sinus ROM<a class="headerlink" href="#sinus-rom" title="Permalink to this heading"></a></h4>
<p>Let’s imagine that you want to generate a sine wave and also have a filtered version of it (which is completely useless in practice, but let’s do it as an example).</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameters name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>resolutionWidth</p></td>
<td><p>Int</p></td>
<td><p>Number of bits used to represent numbers</p></td>
</tr>
<tr class="row-odd"><td><p>sampleCount</p></td>
<td><p>Int</p></td>
<td><p>Number of samples in a sine period</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 31%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>IO name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>sin</p></td>
<td><p>out</p></td>
<td><p>SInt(resolutionWidth bits)</p></td>
<td><p>Output which plays the sine wave</p></td>
</tr>
<tr class="row-odd"><td><p>sinFiltered</p></td>
<td><p>out</p></td>
<td><p>SInt(resolutionWidth bits)</p></td>
<td><p>Output which plays the filtered version of the sine</p></td>
</tr>
</tbody>
</table>
<p>So let’s define the <code class="docutils literal notranslate"><span class="pre">Component</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SineRom</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinFiltered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<p>To play the sine wave on the <code class="docutils literal notranslate"><span class="pre">sin</span></code> output, you can define a ROM which contain all samples of a sine period (it could be just a quarter, but let’s do things the most simple way).
Then you can read that ROM with an phase counter and this will generate your sine wave.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Calculate values for the lookup table</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">sinTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">S</span><span class="p">((</span><span class="n">sinValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">resolutionWidth</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)).</span><span class="n">toInt</span><span class="p">,</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="n">initialContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinTable</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">phase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rom</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then to generate <code class="docutils literal notranslate"><span class="pre">sinFiltered</span></code>, you can for example use a first order low pass filter implementation:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltered</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltered</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
<p>Here is the complete code:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SineRom</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinFiltered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Calculate values for the lookup table</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">sinTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">S</span><span class="p">((</span><span class="n">sinValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">resolutionWidth</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)).</span><span class="n">toInt</span><span class="p">,</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="n">initialContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinTable</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">phase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rom</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltered</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltered</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/Examples/Intermediates ones/index"></span><section id="intermediates-ones">
<h3>Intermediates ones<a class="headerlink" href="#intermediates-ones" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Examples/Intermediates ones/fractal"></span><section id="fractal-calculator">
<h4>Fractal calculator<a class="headerlink" href="#fractal-calculator" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>This example will show a simple implementation (without optimization) of a Mandelbrot fractal calculator by using data streams and fixed point calculations.</p>
</section>
<section id="specification">
<h5>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h5>
<p>The component will receive one <code class="docutils literal notranslate"><span class="pre">Stream</span></code> of pixel tasks (which contain the XY coordinates in the Mandelbrot space) and will produce one <code class="docutils literal notranslate"><span class="pre">Stream</span></code> of pixel results (which contain the number of iterations done for the corresponding task).</p>
<p>Let’s specify the IO of our component:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>IO Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>cmd</p></td>
<td><p>slave</p></td>
<td><p>Stream[PixelTask]</p></td>
<td><p>Provide XY coordinates to process</p></td>
</tr>
<tr class="row-odd"><td><p>rsp</p></td>
<td><p>master</p></td>
<td><p>Stream[PixelResult]</p></td>
<td><p>Return iteration count needed for the corresponding cmd transaction</p></td>
</tr>
</tbody>
</table>
<p>Let’s specify the PixelTask <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x</p></td>
<td><p>SFix</p></td>
<td><p>Coordinate in the Mandelbrot space</p></td>
</tr>
<tr class="row-odd"><td><p>y</p></td>
<td><p>SFix</p></td>
<td><p>Coordinate in the Mandelbrot space</p></td>
</tr>
</tbody>
</table>
<p>Let’s specify the PixelResult <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>iteration</p></td>
<td><p>UInt</p></td>
<td><p>Number of iterations required to solve the Mandelbrot coordinates</p></td>
</tr>
</tbody>
</table>
</section>
<section id="elaboration-parameters-generics">
<h5>Elaboration parameters (Generics)<a class="headerlink" href="#elaboration-parameters-generics" title="Permalink to this heading"></a></h5>
<p>Let’s define the class that will provide construction parameters of our system:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PixelSolverGenerics</span><span class="p">(</span><span class="n">fixAmplitude</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">fixResolution</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">iterationLimit</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">iterationWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log2Up</span><span class="p">(</span><span class="n">iterationLimit</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">iterationType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">iterationWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">fixType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SFix</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">peak</span><span class="o">=</span><span class="n">fixAmplitude</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resolution</span><span class="o">=</span><span class="n">fixResolution</span><span class="w"> </span><span class="n">exp</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>iterationType and fixType are functions that you can call to instantiate new signals. It’s like a typedef in C.</p>
</div>
</section>
<section id="bundle-definition">
<h5>Bundle definition<a class="headerlink" href="#bundle-definition" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PixelTask</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">PixelSolverGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">fixType</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PixelResult</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">PixelSolverGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">iterationType</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="component-implementation">
<h5>Component implementation<a class="headerlink" href="#component-implementation" title="Permalink to this heading"></a></h5>
<p>And now the implementation. The one below is a very simple one without pipelining / multi-threading.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PixelSolver</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">PixelSolverGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w">  </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">PixelTask</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rsp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">PixelResult</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">g</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="c1">// Define states</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">fixType</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">iterationType</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Do some shared calculation</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">xx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Apply default assignment</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">iteration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">iteration</span><span class="w"></span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Is the mandelbrot iteration done ?</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">xx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">yy</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">iterationLimit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">io</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="n">iteration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">xx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">yy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">truncated</span><span class="w"></span>
<span class="w">      </span><span class="n">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(((</span><span class="n">xy</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">truncated</span><span class="w"></span>
<span class="w">      </span><span class="n">iteration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Examples/Intermediates ones/uart"></span><section id="uart">
<span id="example-uart"></span><h4>UART<a class="headerlink" href="#uart" title="Permalink to this heading"></a></h4>
<section id="specification">
<h5>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h5>
<p>This UART controller tutorial is based on <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/tree/master/lib/src/main/scala/spinal/lib/com/uart">this</a> implementation.</p>
<p>This implementation is characterized by:</p>
<ul class="simple">
<li><p>ClockDivider/Parity/StopBit/DataLength configs are set by the component inputs.</p></li>
<li><p>RXD input is filtered by using a sampling window of N samples and a majority vote.</p></li>
</ul>
<p>Interfaces of this UartCtrl are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>config</p></td>
<td><p>UartCtrlConfig</p></td>
<td><p>Give all configurations to the controller</p></td>
</tr>
<tr class="row-odd"><td><p>write</p></td>
<td><p>Stream[Bits]</p></td>
<td><p>Port used by the system to give transmission order to the controller</p></td>
</tr>
<tr class="row-even"><td><p>read</p></td>
<td><p>Flow[Bits]</p></td>
<td><p>Port used by the controller to notify the system about a successfully received frame</p></td>
</tr>
<tr class="row-odd"><td><p>uart</p></td>
<td><p>Uart</p></td>
<td><p>Uart interface with rxd / txd</p></td>
</tr>
</tbody>
</table>
</section>
<section id="data-structures">
<h5>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this heading"></a></h5>
<p>Before implementing the controller itself we need to define some data structures.</p>
<section id="controller-construction-parameters">
<h6>Controller construction parameters<a class="headerlink" href="#controller-construction-parameters" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<colgroup>
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 91%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dataWidthMax</p></td>
<td><p>Int</p></td>
<td><p>Maximum number of data bits that could be sent using a single UART frame</p></td>
</tr>
<tr class="row-odd"><td><p>clockDividerWidth</p></td>
<td><p>Int</p></td>
<td><p>Number of bits that the clock divider has</p></td>
</tr>
<tr class="row-even"><td><p>preSamplingSize</p></td>
<td><p>Int</p></td>
<td><p>Number of samples to drop at the beginning of the sampling window</p></td>
</tr>
<tr class="row-odd"><td><p>samplingSize</p></td>
<td><p>Int</p></td>
<td><p>Number of samples use at the middle of the window to get the filtered RXD value</p></td>
</tr>
<tr class="row-even"><td><p>postSamplingSize</p></td>
<td><p>Int</p></td>
<td><p>Number of samples to drop at the end of the sampling window</p></td>
</tr>
</tbody>
</table>
<p>To make the implementation easier let’s assume that <code class="docutils literal notranslate"><span class="pre">preSamplingSize</span> <span class="pre">+</span> <span class="pre">samplingSize</span> <span class="pre">+</span> <span class="pre">postSamplingSize</span></code> is always a power of two.
If so we can skip resetting counters in a few places.</p>
<p>Instead of adding each construction parameters (generics) to <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code> one by one, we can group them inside a class that will be used as single parameter of <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">clockDividerWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="c1">// baudrate = Fclk / rxSamplePerBit / clockDividerWidth</span>
<span class="w">                            </span><span class="n">preSamplingSize</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">samplingSize</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">postSamplingSize</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rxSamplePerBit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preSamplingSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">samplingSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">postSamplingSize</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">isPow2</span><span class="p">(</span><span class="n">rxSamplePerBit</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">samplingSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalWarning</span><span class="p">(</span><span class="s">s&quot;It&#39;s not nice to have a odd samplingSize value (because of the majority vote)&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uart-interface">
<h6>UART interface<a class="headerlink" href="#uart-interface" title="Permalink to this heading"></a></h6>
<p>Let’s define a UART interface bundle without flow control.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Uart</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rxd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">txd</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">rxd</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uart-configuration-enums">
<h6>UART configuration enums<a class="headerlink" href="#uart-configuration-enums" title="Permalink to this heading"></a></h6>
<p>Let’s define parity and stop bit enumerations.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">UartParityType</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="p">(</span><span class="n">binarySequential</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">NONE</span><span class="p">,</span><span class="w"> </span><span class="nc">EVEN</span><span class="p">,</span><span class="w"> </span><span class="nc">ODD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">UartStopType</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="p">(</span><span class="n">binarySequential</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ONE</span><span class="p">,</span><span class="w"> </span><span class="nc">TWO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">toBitCount</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">C</span><span class="p">):</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">ONE</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;1&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uartctrl-configuration-bundles">
<h6>UartCtrl configuration Bundles<a class="headerlink" href="#uartctrl-configuration-bundles" title="Permalink to this heading"></a></h6>
<p>Let’s define bundles that will be used as IO elements to setup <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlFrameConfig</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dataLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">dataWidthMax</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// Bit count = dataLength + 1</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stop</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">parity</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlConfig</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">frame</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlFrameConfig</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clockDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">clockDividerWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="c1">// see UartCtrlGenerics.clockDividerWidth for calculation</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">setClockDivider</span><span class="p">(</span><span class="n">baudrate</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="p">,</span><span class="w"> </span><span class="n">clkFrequency</span><span class="p">:</span><span class="w"> </span><span class="nc">HertzNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">frequency</span><span class="p">.</span><span class="n">getValue</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">clockDivider</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">clkFrequency</span><span class="p">.</span><span class="n">toDouble</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">baudrate</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">rxSamplePerBit</span><span class="p">).</span><span class="n">toInt</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="implementation">
<h5>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h5>
<p>In <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code>, 3 things will be instantiated:</p>
<ul class="simple">
<li><p>One clock divider that generates a tick pulse at the UART RX sampling rate.</p></li>
<li><p>One <code class="docutils literal notranslate"><span class="pre">UartCtrlTx</span></code> component</p></li>
<li><p>One <code class="docutils literal notranslate"><span class="pre">UartCtrlRx</span></code> component</p></li>
</ul>
<section id="uartctrltx">
<h6>UartCtrlTx<a class="headerlink" href="#uartctrltx" title="Permalink to this heading"></a></h6>
<p>The interfaces of this <code class="docutils literal notranslate"><span class="pre">Component</span></code> are the following :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>configFrame</p></td>
<td><p>UartCtrlFrameConfig</p></td>
<td><p>Contains data bit width count and party/stop bits configurations</p></td>
</tr>
<tr class="row-odd"><td><p>samplingTick</p></td>
<td><p>Bool</p></td>
<td><p>Time reference that pulses <code class="docutils literal notranslate"><span class="pre">rxSamplePerBit</span></code> times per UART baud</p></td>
</tr>
<tr class="row-even"><td><p>write</p></td>
<td><p>Stream[Bits]</p></td>
<td><p>Port used by the system to give transmission orders to the controller</p></td>
</tr>
<tr class="row-odd"><td><p>txd</p></td>
<td><p>Bool</p></td>
<td><p>UART txd pin</p></td>
</tr>
</tbody>
</table>
<p>Let’s define the enumeration that will be used to store the state of <code class="docutils literal notranslate"><span class="pre">UartCtrlTx</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">,</span><span class="w"> </span><span class="nc">START</span><span class="p">,</span><span class="w"> </span><span class="nc">DATA</span><span class="p">,</span><span class="w"> </span><span class="nc">PARITY</span><span class="p">,</span><span class="w"> </span><span class="nc">STOP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s define the skeleton of <code class="docutils literal notranslate"><span class="pre">UartCtrlTx</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlTx</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">g</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">configFrame</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">UartCtrlFrameConfig</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">samplingTick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide one clockDivider.tick each rxSamplePerBit pulses of io.samplingTick</span>
<span class="w">  </span><span class="c1">// Used by the stateMachine as a baud rate time reference</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clockDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">rxSamplePerBit</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Count up each clockDivider.tick, used by the state machine to count up data bits and stop bits</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tickCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="nc">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">_</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">parity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="p">..</span><span class="w"></span>
<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">..</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">txd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">stateMachine</span><span class="p">.</span><span class="n">txd</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="nc">True</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>And here is the complete implementation:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlTx</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">g</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">configFrame</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">UartCtrlFrameConfig</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">samplingTick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide one clockDivider.tick each rxSamplePerBit pulse of io.samplingTick</span>
<span class="w">  </span><span class="c1">// Used by the stateMachine as a baudrate time reference</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clockDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">rxSamplePerBit</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="n">tick</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Count up each clockDivider.tick, used by the state machine to count up data bits and stop bits</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tickCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="nc">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">_</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">parity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">txd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">parity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">parity</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">txd</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">START</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">START</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">txd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">DATA</span><span class="w"></span>
<span class="w">          </span><span class="n">parity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">ODD</span><span class="w"></span>
<span class="w">          </span><span class="n">tickCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">DATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">txd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">payload</span><span class="p">(</span><span class="n">tickCounter</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">when</span><span class="p">(</span><span class="n">tickCounter</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">dataLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">            </span><span class="n">tickCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">STOP</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">PARITY</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">PARITY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">txd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">parity</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">STOP</span><span class="w"></span>
<span class="w">          </span><span class="n">tickCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">STOP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">when</span><span class="p">(</span><span class="n">tickCounter</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">.</span><span class="n">toBitCount</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">stop</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">START</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">IDLE</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">txd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">stateMachine</span><span class="p">.</span><span class="n">txd</span><span class="p">,</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uartctrlrx">
<h6>UartCtrlRx<a class="headerlink" href="#uartctrlrx" title="Permalink to this heading"></a></h6>
<p>The interfaces of this <code class="docutils literal notranslate"><span class="pre">Component</span></code> are the following:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>configFrame</p></td>
<td><p>UartCtrlFrameConfig</p></td>
<td><p>Contains data bit width and party/stop bits configurations</p></td>
</tr>
<tr class="row-odd"><td><p>samplingTick</p></td>
<td><p>Bool</p></td>
<td><p>Time reference that pulses <code class="docutils literal notranslate"><span class="pre">rxSamplePerBit</span></code> times per UART baud</p></td>
</tr>
<tr class="row-even"><td><p>read</p></td>
<td><p>Flow[Bits]</p></td>
<td><p>Port used by the controller to notify the system about a successfully received frame</p></td>
</tr>
<tr class="row-odd"><td><p>rxd</p></td>
<td><p>Bool</p></td>
<td><p>UART rxd pin, not synchronized with the current clock domain</p></td>
</tr>
</tbody>
</table>
<p>Let’s define the enumeration that will be used to store the state of <code class="docutils literal notranslate"><span class="pre">UartCtrlTx</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">UartCtrlRxState</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">,</span><span class="w"> </span><span class="nc">START</span><span class="p">,</span><span class="w"> </span><span class="nc">DATA</span><span class="p">,</span><span class="w"> </span><span class="nc">PARITY</span><span class="p">,</span><span class="w"> </span><span class="nc">STOP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s define the skeleton of the UartCtrlRx :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlRx</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">g</span><span class="p">.</span><span class="n">_</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">configFrame</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">UartCtrlFrameConfig</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">samplingTick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">read</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Flow</span><span class="w"> </span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rxd</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Implement the rxd sampling with a majority vote over samplingSize bits</span>
<span class="w">  </span><span class="c1">// Provide a new sampler.value each time sampler.tick is high</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sampler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">syncroniser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">rxd</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">samples</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">History</span><span class="p">(</span><span class="n">that</span><span class="o">=</span><span class="n">syncroniser</span><span class="p">,</span><span class="n">when</span><span class="o">=</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="n">samplingSize</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="nc">MajorityVote</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide a bitTimer.tick each rxSamplePerBit</span>
<span class="w">  </span><span class="c1">// reset() can be called to recenter the counter over a start bit.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bitTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">rxSamplePerBit</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">preSamplingSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">samplingSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide bitCounter.value that count up each bitTimer.tick, Used by the state machine to count data bits and stop bits</span>
<span class="w">  </span><span class="c1">// reset() can be called to reset it to zero</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bitCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="nc">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlRxState</span><span class="p">.</span><span class="n">_</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">parity</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">shifter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>And here is the complete implementation:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlRx</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">g</span><span class="p">.</span><span class="n">_</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">configFrame</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">UartCtrlFrameConfig</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">samplingTick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">read</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nc">Flow</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rxd</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Implement the rxd sampling with a majority vote over samplingSize bits</span>
<span class="w">  </span><span class="c1">// Provide a new sampler.value each time sampler.tick is high</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sampler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">synchronizer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">rxd</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">samples</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">spinal</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="nc">History</span><span class="p">(</span><span class="n">that</span><span class="o">=</span><span class="n">synchronizer</span><span class="p">,</span><span class="w"> </span><span class="n">when</span><span class="o">=</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">=</span><span class="n">samplingSize</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="nc">MajorityVote</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide a bitTimer.tick each rxSamplePerBit</span>
<span class="w">  </span><span class="c1">// reset() can be called to recenter the counter over a start bit.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bitTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">rxSamplePerBit</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">preSamplingSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">samplingSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">sampler</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="n">tick</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Provide bitCounter.value that count up each bitTimer.tick, Used by the state machine to count data bits and stop bits</span>
<span class="w">  </span><span class="c1">// reset() can be called to reset it to zero</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bitCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="nc">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">dataWidthMax</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">bitTimer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlRxState</span><span class="p">.</span><span class="n">_</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">parity</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">shifter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Parity calculation</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">bitTimer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">parity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">parity</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="o">!</span><span class="n">sampler</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">START</span><span class="w"></span>
<span class="w">          </span><span class="n">bitTimer</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">bitCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">START</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">bitTimer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">DATA</span><span class="w"></span>
<span class="w">          </span><span class="n">bitCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">parity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">ODD</span><span class="w"></span>
<span class="w">          </span><span class="n">when</span><span class="p">(</span><span class="n">sampler</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">IDLE</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">DATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">bitTimer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">shifter</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
<span class="w">          </span><span class="n">when</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">dataLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">bitCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">STOP</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">PARITY</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">PARITY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">bitTimer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">STOP</span><span class="w"></span>
<span class="w">          </span><span class="n">bitCounter</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">when</span><span class="p">(</span><span class="n">parity</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">IDLE</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">is</span><span class="p">(</span><span class="nc">STOP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">bitTimer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">when</span><span class="p">(</span><span class="o">!</span><span class="n">sampler</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">IDLE</span><span class="w"></span>
<span class="w">          </span><span class="p">}.</span><span class="n">elsewhen</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">.</span><span class="n">toBitCount</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="p">.</span><span class="n">stop</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">IDLE</span><span class="w"></span>
<span class="w">            </span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">stateMachine</span><span class="p">.</span><span class="n">shifter</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uartctrl">
<h6>UartCtrl<a class="headerlink" href="#uartctrl" title="Permalink to this heading"></a></h6>
<p>Let’s write <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code> that instantiates the <code class="docutils literal notranslate"><span class="pre">UartCtrlRx</span></code> and <code class="docutils literal notranslate"><span class="pre">UartCtrlTx</span></code> parts, generate the clock divider logic, and connect them to each other.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="o">=</span><span class="nc">UartCtrlGenerics</span><span class="p">())</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">UartCtrlConfig</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">read</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">uart</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Uart</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrlTx</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrlRx</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Clock divider used by RX and TX</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clockDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">clockDividerWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">clockDivider</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">tx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="w"></span>
<span class="w">  </span><span class="n">rx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">samplingTick</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">clockDivider</span><span class="p">.</span><span class="n">tick</span><span class="w"></span>

<span class="w">  </span><span class="n">tx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="w"></span>
<span class="w">  </span><span class="n">rx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">configFrame</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="w"></span>

<span class="w">  </span><span class="n">tx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="w"></span>
<span class="w">  </span><span class="n">rx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">txd</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">txd</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">rxd</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">rx</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">rxd</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>To make it easier to use the UART with fixed settings, we introduce an companion object for <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code>. It allows us to provide
additional ways of instantiating a UartCtrl component with different sets of parameters. Here we define a <code class="docutils literal notranslate"><span class="pre">UartCtrlInitConfig</span></code>
holding the settings for a component that is not runtime configurable. Note that it is still possible to instantiate the UartCtrl
manually like all other components, which one would do if a runtime-configurable UART is needed (via <code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">uart</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">UartCtrl()</span></code>).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlInitConfig</span><span class="p">(</span><span class="n">baudrate</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">dataLength</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">parity</span><span class="p">:</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">stop</span><span class="p">:</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">.</span><span class="nc">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                             </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">dataLength</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initReg</span><span class="p">(</span><span class="n">reg</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlConfig</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">require</span><span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">isReg</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">baudrate</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">clockDivider</span><span class="w"> </span><span class="n">init</span><span class="p">((</span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">frequency</span><span class="p">.</span><span class="n">getValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">baudrate</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">rxSamplePerBit</span><span class="p">).</span><span class="n">toInt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">dataLength</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">dataLength</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="n">dataLength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">parity</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">parity</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stop</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">stop</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlInitConfig</span><span class="p">,</span><span class="w"> </span><span class="n">readonly</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">):</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">setClockDivider</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">baudrate</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">dataLength</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">dataLength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">parity</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">stop</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readonly</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">      </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="simple-usage">
<h5>Simple usage<a class="headerlink" href="#simple-usage" title="Permalink to this heading"></a></h5>
<p>To synthesize a <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code> as <code class="docutils literal notranslate"><span class="pre">115200-N-8-1</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="o">=</span><span class="nc">UartCtrlInitConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">baudrate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">115200</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">dataLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">parity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">.</span><span class="nc">ONE</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>If you are using <code class="docutils literal notranslate"><span class="pre">txd</span></code> pin only, add:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">rxd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">tx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">txd</span><span class="w"></span>
</pre></div>
</div>
<p>On the contrary, if you are using <code class="docutils literal notranslate"><span class="pre">rxd</span></code> pin only:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlInitConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">baudrate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">115200</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">dataLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">parity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">NONE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">.</span><span class="nc">ONE</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">readonly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="example-with-test-bench">
<h5>Example with test bench<a class="headerlink" href="#example-with-test-bench" title="Permalink to this heading"></a></h5>
<p>Here is a top level example that does the followings things:</p>
<ul class="simple">
<li><p>Instantiate <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code> and set its configuration to 921600 baud/s, no parity, 1 stop bit.</p></li>
<li><p>Each time a byte is received from the UART, it writes it on the leds output.</p></li>
<li><p>Every 2000 cycles, it sends the switches input value to the UART.</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrlUsageExample</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Uart</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">switches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">leds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="c1">// set config manually to show that this is still OK</span>
<span class="w">  </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">setClockDivider</span><span class="p">(</span><span class="mi">921600</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">dataLength</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="c1">// 8 bits</span>
<span class="w">  </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">UartParityType</span><span class="p">.</span><span class="nc">NONE</span><span class="w"></span>
<span class="w">  </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">UartStopType</span><span class="p">.</span><span class="nc">ONE</span><span class="w"></span>
<span class="w">  </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Assign io.led with a register loaded each time a byte is received</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">leds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">toReg</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Write the value of switch on the uart each 2000 cycles</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">2000</span><span class="p">).</span><span class="n">willOverflow</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">switches</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">UartCtrlUsageExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">defaultClockDomainFrequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">).</span><span class="n">generateVhdl</span><span class="p">(</span><span class="nc">UartCtrlUsageExample</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/master/tester/src/test/resources/UartCtrlUsageExample_tb.vhd">Here</a> you can get a simple VHDL testbench for this small <code class="docutils literal notranslate"><span class="pre">UartCtrlUsageExample</span></code>.</p>
</section>
<section id="bonus-having-fun-with-stream">
<h5>Bonus: Having fun with Stream<a class="headerlink" href="#bonus-having-fun-with-stream" title="Permalink to this heading"></a></h5>
<p>If you want to queue data received from the UART:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">queuedReads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">toStream</span><span class="p">.</span><span class="n">queue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>If you want to add a queue on the write interface and do some flow control:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">writeCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stopIt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">writeCmd</span><span class="p">.</span><span class="n">queue</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">haltWhen</span><span class="p">(</span><span class="n">stopIt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="w"></span>
</pre></div>
</div>
<p>If you want to send a 0x55 header before sending the value of switches, you can replace the write generator of the preceding example by:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">Fragment</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="mi">4000</span><span class="p">).</span><span class="n">willOverflow</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">.</span><span class="n">fragment</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">switches</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">.</span><span class="n">stage</span><span class="p">().</span><span class="n">insertHeader</span><span class="p">(</span><span class="mh">0x55</span><span class="p">).</span><span class="n">toStreamOfFragment</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Examples/Intermediates ones/vga"></span><section id="vga">
<h4>VGA<a class="headerlink" href="#vga" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>VGA interfaces are becoming an endangered species, but implementing a VGA controller is still a good exercise.</p>
<p>An explanation about the VGA protocol can be found <a class="reference external" href="https://web.mit.edu/6.111/www/s2004/NEWKIT/vga.shtml">here</a>.</p>
<p>This VGA controller tutorial is based on <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/master/lib/src/main/scala/spinal/lib/graphic/vga/VgaCtrl.scala">this</a> implementation.</p>
</section>
<section id="data-structures">
<h5>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this heading"></a></h5>
<p>Before implementing the controller itself we need to define some data structures.</p>
<section id="rgb-color">
<h6>RGB color<a class="headerlink" href="#rgb-color" title="Permalink to this heading"></a></h6>
<p>First, we need a three channel color structure (Red, Green, Blue). This data structure will be used to feed the controller with pixels and also will be used by the VGA bus.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">(</span><span class="n">rWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">gWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">bWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bWidth</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">gWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">bWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="vga-bus">
<h6>VGA bus<a class="headerlink" href="#vga-bus" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>io name</p></th>
<th class="head"><p>Driver</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>vSync</p></td>
<td><p>master</p></td>
<td><p>Vertical synchronization, indicate the beginning of a new frame</p></td>
</tr>
<tr class="row-odd"><td><p>hSync</p></td>
<td><p>master</p></td>
<td><p>Horizontal synchronization, indicate the beginning of a new line</p></td>
</tr>
<tr class="row-even"><td><p>colorEn</p></td>
<td><p>master</p></td>
<td><p>High when the interface is in the visible part</p></td>
</tr>
<tr class="row-odd"><td><p>color</p></td>
<td><p>master</p></td>
<td><p>Carry the color, don’t care when colorEn is low</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Vga</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">color</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">asOutput</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This Vga <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> uses the <code class="docutils literal notranslate"><span class="pre">IMasterSlave</span></code> trait, which allows you to create master/slave VGA interfaces using the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>master(Vga(...))
slave(Vga(...))
</pre></div>
</div>
</section>
<section id="vga-timings">
<h6>VGA timings<a class="headerlink" href="#vga-timings" title="Permalink to this heading"></a></h6>
<p>The VGA interface is driven by using 8 different timings. Here is one simple example of a <code class="docutils literal notranslate"><span class="pre">Bundle</span></code> that is able to carry them.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimings</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hSyncStart</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hSyncEnd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hColorStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hColorEnd</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vSyncStart</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vSyncEnd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vColorStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vColorEnd</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But this not a very good way to specify it because it is redundant for vertical and horizontal timings.</p>
<p>Let’s write it in a clearer way:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEnd</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">syncStart</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">syncEnd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimings</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then we can add some some functions to set these timings for specific resolutions and frame rates:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEnd</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">syncStart</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">syncEnd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaTimings</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">setAs_h640_v480_r60</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">syncStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">syncEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">800</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">colorStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">colorEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">800</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">syncStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">syncEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">525</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">colorStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">colorEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">525</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">setAs_h64_v64_r60</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">syncStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">syncEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">800</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">colorStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">288</span><span class="w"></span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">colorEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">800</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">288</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">syncStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">syncEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">525</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">colorStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">208</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">colorEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">525</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">208</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="vga-controller">
<h5>VGA Controller<a class="headerlink" href="#vga-controller" title="Permalink to this heading"></a></h5>
<section id="specification">
<h6>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h6>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>io name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>softReset</p></td>
<td><p>in</p></td>
<td><p>Reset internal counters and keep the VGA interface inactive</p></td>
</tr>
<tr class="row-odd"><td><p>timings</p></td>
<td><p>in</p></td>
<td><p>Specify VGA horizontal and vertical timings</p></td>
</tr>
<tr class="row-even"><td><p>pixels</p></td>
<td><p>slave</p></td>
<td><p>Stream of RGB colors that feeds the VGA controller</p></td>
</tr>
<tr class="row-odd"><td><p>error</p></td>
<td><p>out</p></td>
<td><p>High when the pixels stream is too slow</p></td>
</tr>
<tr class="row-even"><td><p>frameStart</p></td>
<td><p>out</p></td>
<td><p>High when a new frame starts</p></td>
</tr>
<tr class="row-odd"><td><p>vga</p></td>
<td><p>master</p></td>
<td><p>VGA interface</p></td>
</tr>
</tbody>
</table>
<p>The controller does not integrate any pixel buffering. It directly takes them from the <code class="docutils literal notranslate"><span class="pre">pixels</span></code> <code class="docutils literal notranslate"><span class="pre">Stream</span></code> and puts them on the <code class="docutils literal notranslate"><span class="pre">vga.color</span></code> out at the right time. If <code class="docutils literal notranslate"><span class="pre">pixels</span></code> is not valid then <code class="docutils literal notranslate"><span class="pre">error</span></code> becomes high for one cycle.</p>
</section>
<section id="component-and-io-definition">
<h6>Component and io definition<a class="headerlink" href="#component-and-io-definition" title="Permalink to this heading"></a></h6>
<p>Let’s define a new VgaCtrl <code class="docutils literal notranslate"><span class="pre">Component</span></code>, which takes as <code class="docutils literal notranslate"><span class="pre">RgbConfig</span></code> and <code class="docutils literal notranslate"><span class="pre">timingsWidth</span></code> as parameters. Let’s give the bit width a default value of 12.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaCtrl</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">,</span><span class="w"> </span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">softReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">timings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">VgaTimings</span><span class="p">(</span><span class="n">timingsWidth</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="nc">Stream</span><span class="w"> </span><span class="nc">Rgb</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">frameStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">vga</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Vga</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="horizontal-and-vertical-logic">
<h6>Horizontal and vertical logic<a class="headerlink" href="#horizontal-and-vertical-logic" title="Permalink to this heading"></a></h6>
<p>The logic that generates horizontal and vertical synchronization signals is quite the same. It kind of resembles ~PWM~. The horizontal one counts up each cycle, while the vertical one use the horizontal synchronization signal as to increment.</p>
<p>Let’s define <code class="docutils literal notranslate"><span class="pre">HVArea</span></code>, which represents one ~PWM~ and then instantiate it two times: one for both horizontal and vertical synchronization.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaCtrl</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">,</span><span class="w"> </span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">HVArea</span><span class="p">(</span><span class="n">timingsHV</span><span class="p">:</span><span class="w"> </span><span class="nc">VgaTimingsHV</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">timingsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">syncStart</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">timingsHV</span><span class="p">.</span><span class="n">syncStart</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">syncEnd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">timingsHV</span><span class="p">.</span><span class="n">syncEnd</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">colorStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">timingsHV</span><span class="p">.</span><span class="n">colorStart</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEnd</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">timingsHV</span><span class="p">.</span><span class="n">colorEnd</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">syncEnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sync</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"> </span><span class="n">setWhen</span><span class="w"> </span><span class="n">syncStart</span><span class="w"> </span><span class="n">clearWhen</span><span class="w"> </span><span class="n">syncEnd</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"> </span><span class="n">setWhen</span><span class="w"> </span><span class="n">colorStart</span><span class="w"> </span><span class="n">clearWhen</span><span class="w"> </span><span class="n">colorEnd</span><span class="w"></span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">softReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="n">sync</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">      </span><span class="n">colorEn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">HVArea</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">HVArea</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">syncEnd</span><span class="p">)</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<p>As you can see, it’s done by using <code class="docutils literal notranslate"><span class="pre">Area</span></code>. This is to avoid the creation of a new <code class="docutils literal notranslate"><span class="pre">Component</span></code> which would have been much more verbose.</p>
</section>
<section id="interconnections">
<h6>Interconnections<a class="headerlink" href="#interconnections" title="Permalink to this heading"></a></h6>
<p>Now that we have timing generators for horizontal and vertical synchronization, we need to drive the outputs.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaCtrl</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">,</span><span class="w"> </span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">colorEn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">colorEn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">colorEn</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">pixels</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">colorEn</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">colorEn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">pixels</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">frameStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">syncEnd</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">vga</span><span class="p">.</span><span class="n">hSync</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">sync</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">vga</span><span class="p">.</span><span class="n">vSync</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">sync</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">vga</span><span class="p">.</span><span class="n">colorEn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">colorEn</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">vga</span><span class="p">.</span><span class="n">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">pixels</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bonus">
<h6>Bonus<a class="headerlink" href="#bonus" title="Permalink to this heading"></a></h6>
<p>The VgaCtrl that was defined above is generic (not application specific).
We can imagine a case where the system provides a <code class="docutils literal notranslate"><span class="pre">Stream</span></code> of <code class="docutils literal notranslate"><span class="pre">Fragment</span></code> of RGB, which means the system transmits pixels between start/end of picture indications.</p>
<p>In this case we can automatically manage the <code class="docutils literal notranslate"><span class="pre">softReset</span></code> input by asserting it when an <code class="docutils literal notranslate"><span class="pre">error</span></code> occurs, then wait for the end of the current <code class="docutils literal notranslate"><span class="pre">pixels</span></code> picture to deassert <code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
<p>Let’s add a function to <code class="docutils literal notranslate"><span class="pre">VgaCtrl</span></code> that can be called from the parent component to feed <code class="docutils literal notranslate"><span class="pre">VgaCtrl</span></code> by using this <code class="docutils literal notranslate"><span class="pre">Stream</span></code> of <code class="docutils literal notranslate"><span class="pre">Fragment</span></code> of RGB.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VgaCtrl</span><span class="p">(</span><span class="n">rgbConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">,</span><span class="w"> </span><span class="n">timingsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">feedWith</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">Fragment</span><span class="p">[</span><span class="nc">Rgb</span><span class="p">]]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">pixels</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">toStreamOfFragment</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">error</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">isLast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">error</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">softReset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">error</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">that</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-SpinalHDL/Examples/Advanced ones/index"></span><section id="advanced-ones">
<h3>Advanced ones<a class="headerlink" href="#advanced-ones" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Examples/Advanced ones/jtag"></span><section id="jtag-tap">
<h4>JTAG TAP<a class="headerlink" href="#jtag-tap" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The goal of this page is to show the implementation of a JTAG TAP (a slave) by a non-conventional way.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<div class="line-block">
<div class="line">This implementation is not a simple one, it mix object oriented programming, abstract interfaces decoupling, hardware generation and hardware description.</div>
<div class="line">Of course a simple JTAG TAP implementation could be done only with a simple hardware description, but the goal here is really to going forward and creating an very reusable and extensible JTAG TAP generator</div>
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This page will not explain how JTAG works. A good tutorial can be found <a class="reference external" href="https://www.fpga4fun.com/JTAG.html">there</a>.</p>
</div>
<p>One big difference between commonly used HDL and Spinal, is the fact that SpinalHDL allow you to define hardware generators/builders. It’s very different than describing hardware.
Let’s take a look into the example bellow because the difference between generate/build/describing could seem “playing with word” or could be interpreted differently.</p>
<p>The example bellow is a JTAG TAP which allow the JTAG master to read <code class="docutils literal notranslate"><span class="pre">switchs</span></code>/<code class="docutils literal notranslate"><span class="pre">keys</span></code> inputs and write <code class="docutils literal notranslate"><span class="pre">leds</span></code> outputs. This TAP could also be recognized by a master by using the UID 0x87654321.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleJtagTap</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">jtag</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Jtag</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">switchs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">keys</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">leds</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">JtagTap</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">idcodeArea</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">idcode</span><span class="p">(</span><span class="nc">B</span><span class="s">&quot;x87654321&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">switchsArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">switchs</span><span class="p">)</span><span class="w">     </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">keysArea</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span><span class="w">        </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ledsArea</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">leds</span><span class="p">)</span><span class="w">       </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As you can see, a JtagTap is created but then some Generator/Builder functions (idcode,read,write) are called to create each JTAG instruction. This is what i call “Hardware generator/builder”, then these Generator/Builder are used by the user to describing an hardware. And there is the point, in commonly HDL you can only describe your hardware, which imply many donkey job.</p>
<p>This JTAG TAP tutorial is based on <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/tree/master/lib/src/main/scala/spinal/lib/com/jtag">this</a> implementation.</p>
</section>
<section id="jtag-bus">
<span id="jtag"></span><h5>JTAG bus<a class="headerlink" href="#jtag-bus" title="Permalink to this heading"></a></h5>
<p>First we need to define a JTAG bus bundle.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Jtag</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tdi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tdo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="n">tdi</span><span class="p">,</span><span class="w"> </span><span class="n">tms</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="n">tdo</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As you can see this bus don’t contain the TCK pin because it will be provided by the clock domain.</p>
</section>
<section id="jtag-state-machine">
<h5>JTAG state machine<a class="headerlink" href="#jtag-state-machine" title="Permalink to this heading"></a></h5>
<p>Let’s define the JTAG state machine as explained <a class="reference external" href="https://www.fpga4fun.com/JTAG2.html">here</a></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">JtagState</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">RESET</span><span class="p">,</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nc">IR_SELECT</span><span class="p">,</span><span class="w"> </span><span class="nc">IR_CAPTURE</span><span class="p">,</span><span class="w"> </span><span class="nc">IR_SHIFT</span><span class="p">,</span><span class="w"> </span><span class="nc">IR_EXIT1</span><span class="p">,</span><span class="w"> </span><span class="nc">IR_PAUSE</span><span class="p">,</span><span class="w"> </span><span class="nc">IR_EXIT2</span><span class="p">,</span><span class="w"> </span><span class="nc">IR_UPDATE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nc">DR_SELECT</span><span class="p">,</span><span class="w"> </span><span class="nc">DR_CAPTURE</span><span class="p">,</span><span class="w"> </span><span class="nc">DR_SHIFT</span><span class="p">,</span><span class="w"> </span><span class="nc">DR_EXIT1</span><span class="p">,</span><span class="w"> </span><span class="nc">DR_PAUSE</span><span class="p">,</span><span class="w"> </span><span class="nc">DR_EXIT2</span><span class="p">,</span><span class="w"> </span><span class="nc">DR_UPDATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">JtagFsm</span><span class="p">(</span><span class="n">jtag</span><span class="p">:</span><span class="w"> </span><span class="nc">Jtag</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="n">_</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stateNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">stateNext</span><span class="p">)</span><span class="w"> </span><span class="n">randBoot</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">stateNext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">mux</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">default</span><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">RESET</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">),</span><span class="w">           </span><span class="c1">// RESET</span>
<span class="w">    </span><span class="nc">IDLE</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_SELECT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_SELECT</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">RESET</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nc">IR_CAPTURE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_CAPTURE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">IR_EXIT1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nc">IR_SHIFT</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_SHIFT</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">IR_EXIT1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nc">IR_SHIFT</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_EXIT1</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">IR_UPDATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">IR_PAUSE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_PAUSE</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">IR_EXIT2</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nc">IR_PAUSE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_EXIT2</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">IR_UPDATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">IR_SHIFT</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">IR_UPDATE</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_SELECT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_SELECT</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">IR_SELECT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">DR_CAPTURE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_CAPTURE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_EXIT1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nc">DR_SHIFT</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_SHIFT</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_EXIT1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nc">DR_SHIFT</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_EXIT1</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_UPDATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">DR_PAUSE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_PAUSE</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_EXIT2</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nc">DR_PAUSE</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_EXIT2</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_UPDATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">DR_SHIFT</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nc">DR_UPDATE</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nc">DR_SELECT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">IDLE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">randBoot()</span></code> on <code class="docutils literal notranslate"><span class="pre">state</span></code> make it initialized with a random state. It’s only for simulation purpose.</p>
</div>
</section>
<section id="id1">
<h5>JTAG TAP<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h5>
<p>Let’s implement the core of the JTAG TAP, without any instruction, just the base manage the instruction register (IR) and the bypass.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JtagTap</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">jtag</span><span class="p">:</span><span class="w"> </span><span class="nc">Jtag</span><span class="p">,</span><span class="w"> </span><span class="n">instructionWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">JtagFsm</span><span class="p">(</span><span class="n">jtag</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">instructionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">instructionShift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">instructionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">bypass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="n">jtag</span><span class="p">.</span><span class="n">tdo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">bypass</span><span class="w"></span>

<span class="w">  </span><span class="n">switch</span><span class="p">(</span><span class="n">fsm</span><span class="p">.</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">IR_CAPTURE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">instructionShift</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">IR_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">instructionShift</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">jtag</span><span class="p">.</span><span class="n">tdi</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">instructionShift</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="n">jtag</span><span class="p">.</span><span class="n">tdo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instructionShift</span><span class="p">.</span><span class="n">lsb</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">IR_UPDATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">instruction</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">instructionShift</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">is</span><span class="p">(</span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">DR_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">bypass</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">jtag</span><span class="p">.</span><span class="n">tdi</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ignore the reference to <cite>with JTagTapAccess</cite> for now, it will be explained further down.</p>
</div>
</section>
<section id="jtag-instructions">
<h5>Jtag instructions<a class="headerlink" href="#jtag-instructions" title="Permalink to this heading"></a></h5>
<p>Now that the JTAG TAP core is done, we can think about how to implement JTAG instructions by an reusable way.</p>
<section id="jtag-tap-class-interface">
<h6>JTAG TAP class interface<a class="headerlink" href="#jtag-tap-class-interface" title="Permalink to this heading"></a></h6>
<p>First we need to define how an instruction could interact with the JTAG TAP core. We could of course directly take the JtagTap area, but it’s not very nice because is some situation the JTAG TAP core is provided by another IP (Altera virtual JTAG for example).</p>
<p>So let’s define a simple and abstract interface between the JTAG TAP core and instructions :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getTdi</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getTms</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">setTdo</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getState</span><span class="p">:</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">C</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getInstruction</span><span class="p">():</span><span class="w"> </span><span class="nc">Bits</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">setInstruction</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then let the <code class="docutils literal notranslate"><span class="pre">JtagTap</span></code> implement this abstract interface:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Additions to <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">JtagTap</span></code></span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JtagTap</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">jtag</span><span class="p">:</span><span class="w"> </span><span class="nc">Jtag</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getTdi</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jtag</span><span class="p">.</span><span class="n">tdi</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">setTdo</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jtag</span><span class="p">.</span><span class="n">tdo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getTms</span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jtag</span><span class="p">.</span><span class="n">tms</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getState</span><span class="p">:</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">state</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getInstruction</span><span class="p">():</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">setInstruction</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</section>
<section id="base-class">
<h6>Base class<a class="headerlink" href="#base-class" title="Permalink to this heading"></a></h6>
<p>Let’s define a useful base class for JTAG instruction that provide some callback (doCapture/doShift/doUpdate/doReset) depending the selected instruction and the state of the JTAG TAP :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JtagInstruction</span><span class="p">(</span><span class="n">tap</span><span class="p">:</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="p">,</span><span class="kd">val</span><span class="w"> </span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">doCapture</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">doShift</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">doUpdate</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">doReset</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">instructionHit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">getInstruction</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">instructionId</span><span class="w"></span>

<span class="w">  </span><span class="nc">Component</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">addPrePopTask</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">instructionHit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">DR_CAPTURE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">doCapture</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">DR_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">doShift</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">DR_UPDATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">doUpdate</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">JtagState</span><span class="p">.</span><span class="nc">RESET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">doReset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">About the Component.current.addPrePopTask(…) :</div>
<div class="line">This allows you to call the given code at the end of the current component construction. Because of object oriented nature of JtagInstruction, doCapture, doShift, doUpdate and doReset should not be called before children classes construction (because children classes will use it as a callback to do some logic).</div>
</div>
</div>
</section>
<section id="read-instruction">
<h6>Read instruction<a class="headerlink" href="#read-instruction" title="Permalink to this heading"></a></h6>
<p>Let’s implement an instruction that allow the JTAG to read a signal.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JtagInstructionRead</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)(</span><span class="n">tap</span><span class="p">:</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">JtagInstruction</span><span class="p">(</span><span class="n">tap</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">shifter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doCapture</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">shifter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doShift</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">shifter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getTdi</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">shifter</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">tap</span><span class="p">.</span><span class="n">setTdo</span><span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">lsb</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="write-instruction">
<h6>Write instruction<a class="headerlink" href="#write-instruction" title="Permalink to this heading"></a></h6>
<p>Let’s implement an instruction that allow the JTAG to write a register (and also read its current value).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JtagInstructionWrite</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">cleanUpdate</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">,</span><span class="w"> </span><span class="n">readable</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)(</span><span class="n">tap</span><span class="p">:</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">JtagInstruction</span><span class="p">(</span><span class="n">tap</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">shifter</span><span class="p">,</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doCapture</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">shifter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">store</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doShift</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">shifter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getTdi</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">shifter</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">tap</span><span class="p">.</span><span class="n">setTdo</span><span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">lsb</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doUpdate</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">shifter</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">data</span><span class="p">.</span><span class="n">assignFromBits</span><span class="p">(</span><span class="n">store</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="idcode-instruction">
<h6>Idcode instruction<a class="headerlink" href="#idcode-instruction" title="Permalink to this heading"></a></h6>
<p>Let’s implement the instruction that return a idcode to the JTAG and also, when a reset occur, set the instruction register (IR) to it own instructionId.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JtagInstructionIdcode</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)(</span><span class="n">tap</span><span class="p">:</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">JtagInstruction</span><span class="p">(</span><span class="n">tap</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">shifter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doShift</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">shifter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">tap</span><span class="p">.</span><span class="n">getTdi</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">shifter</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">tap</span><span class="p">.</span><span class="n">setTdo</span><span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">lsb</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doReset</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">shifter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="w">    </span><span class="n">tap</span><span class="p">.</span><span class="n">setInstruction</span><span class="p">(</span><span class="n">instructionId</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="user-friendly-wrapper">
<h5>User friendly wrapper<a class="headerlink" href="#user-friendly-wrapper" title="Permalink to this heading"></a></h5>
<p>Let’s add some user friendly function to the JtagTapAccess to make instructions instantiation easier .</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Additions to <code class="docutils literal notranslate"><span class="pre">trait</span> <span class="pre">JtagTapAccess</span></code></span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">JtagTapAccess</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">idcode</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)(</span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">JtagInstructionIdcode</span><span class="p">(</span><span class="n">value</span><span class="p">)(</span><span class="bp">this</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)(</span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w">   </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">JtagInstructionRead</span><span class="p">(</span><span class="n">data</span><span class="p">)(</span><span class="bp">this</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">cleanUpdate</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">readable</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)(</span><span class="n">instructionId</span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">JtagInstructionWrite</span><span class="p">[</span><span class="nc">T</span><span class="p">](</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">cleanUpdate</span><span class="p">,</span><span class="w"> </span><span class="n">readable</span><span class="p">)(</span><span class="bp">this</span><span class="p">,</span><span class="w"> </span><span class="n">instructionId</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</section>
<section id="usage-demonstration">
<h5>Usage demonstration<a class="headerlink" href="#usage-demonstration" title="Permalink to this heading"></a></h5>
<p>And there we are, we can now very easily create an application specific JTAG TAP without having to write any logic or any interconnections.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleJtagTap</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">jtag</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Jtag</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">switchs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">keys</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">leds</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">JtagTap</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">idcodeArea</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">idcode</span><span class="p">(</span><span class="nc">B</span><span class="s">&quot;x87654321&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">switchsArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">switchs</span><span class="p">)</span><span class="w">     </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">keysArea</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span><span class="w">        </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ledsArea</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">tap</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">leds</span><span class="p">)</span><span class="w">       </span><span class="p">(</span><span class="n">instructionId</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// end SimpleJtagTap</span>
</pre></div>
</div>
<p>This way of doing things (Generating hardware) could also be applied to, for example, generating an APB/AHB/AXI bus slave.</p>
</section>
</section>
<span id="document-SpinalHDL/Examples/Advanced ones/memory_mapped_uart"></span><section id="memory-mapped-uart">
<span id="id1"></span><h4>Memory mapped UART<a class="headerlink" href="#memory-mapped-uart" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>This example will take the <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code> component implemented in the previous <a class="reference internal" href="index.html#example-uart"><span class="std std-ref">example</span></a> to create a memory mapped UART controller.</p>
</section>
<section id="specification">
<h5>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h5>
<p>The implementation will be based on the APB3 bus with a RX FIFO.</p>
<p>Here is the register mapping table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Access</p></th>
<th class="head"><p>Address</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>clockDivider</p></td>
<td><p>UInt</p></td>
<td><p>RW</p></td>
<td><p>0</p></td>
<td><p>Set the UartCtrl clock divider</p></td>
</tr>
<tr class="row-odd"><td><p>frame</p></td>
<td><p>UartCtrlFrameConfig</p></td>
<td><p>RW</p></td>
<td><p>4</p></td>
<td><p>Set the dataLength, the parity and the stop bit configuration</p></td>
</tr>
<tr class="row-even"><td><p>writeCmd</p></td>
<td><p>Bits</p></td>
<td><p>W</p></td>
<td><p>8</p></td>
<td><p>Send a write command to UartCtrl</p></td>
</tr>
<tr class="row-odd"><td><p>writeBusy</p></td>
<td><p>Bool</p></td>
<td><p>R</p></td>
<td><p>8</p></td>
<td><p>Bit 0 =&gt; zero when a new writeCmd can be sent</p></td>
</tr>
<tr class="row-even"><td><p>read</p></td>
<td><p>Bool / Bits</p></td>
<td><p>R</p></td>
<td><p>12</p></td>
<td><div class="line-block">
<div class="line">Bits 7 downto 0 =&gt; rx payload</div>
<div class="line">Bit 31 =&gt; rx payload valid</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="implementation">
<h5>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h5>
<p>For this implementation, the Apb3SlaveFactory tool will be used. It allows you to define a APB3 slave with a nice syntax. You can find the documentation of this tool <a class="reference internal" href="index.html#bus-slave-factory"><span class="std std-ref">there</span></a>.</p>
<p>First, we just need to define the <code class="docutils literal notranslate"><span class="pre">Apb3Config</span></code> that will be used for the controller. It is defined in a Scala object as a function to be able to get it from everywhere.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">Apb3UartCtrl</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getApb3Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then we can define a <code class="docutils literal notranslate"><span class="pre">Apb3UartCtrl</span></code> component which instantiates a <code class="docutils literal notranslate"><span class="pre">UartCtrl</span></code> and creates the memory mapping logic between it and the APB3 bus:</p>
<img alt="_images/memory_mapped_uart.svg" class="align-center" src="_images/memory_mapped_uart.svg" /><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3UartCtrl</span><span class="p">(</span><span class="n">uartCtrlConfig</span><span class="p">:</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">,</span><span class="w"> </span><span class="n">rxFifoDepth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3UartCtrl</span><span class="p">.</span><span class="n">getApb3Config</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Uart</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Instantiate an simple uart controller</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="p">(</span><span class="n">uartCtrlConfig</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Create an instance of the Apb3SlaveFactory that will then be used as a slave factory drived by io.bus</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">busCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3SlaveFactory</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">bus</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Ask the busCtrl to create a readable/writable register at the address 0</span>
<span class="w">  </span><span class="c1">// and drive uartCtrl.io.config.clockDivider with this register</span>
<span class="w">  </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">driveAndRead</span><span class="p">(</span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">clockDivider</span><span class="p">,</span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Do the same thing than above but for uartCtrl.io.config.frame at the address 4</span>
<span class="w">  </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">driveAndRead</span><span class="p">(</span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Ask the busCtrl to create a writable Flow[Bits] (valid/payload) at the address 8.</span>
<span class="w">  </span><span class="c1">// Then convert it into a stream and connect it to the uartCtrl.io.write by using an register stage (&gt;-&gt;)</span>
<span class="w">  </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">createAndDriveFlow</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">uartCtrlConfig</span><span class="p">.</span><span class="n">dataWidthMax</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="n">toStream</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="w"></span>

<span class="w">  </span><span class="c1">// To avoid losing writes commands between the Flow to Stream transformation just above,</span>
<span class="w">  </span><span class="c1">// make the occupancy of the uartCtrl.io.write readable at address 8</span>
<span class="w">  </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Take uartCtrl.io.read, convert it into a Stream, then connect it to the input of a FIFO of 64 elements</span>
<span class="w">  </span><span class="c1">// Then make the output of the FIFO readable at the address 12 by using a non blocking protocol</span>
<span class="w">  </span><span class="c1">// (Bit 7 downto 0 =&gt; read data &lt;br&gt; Bit 31 =&gt; read data valid )</span>
<span class="w">  </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">readStreamNonBlocking</span><span class="p">(</span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">queue</span><span class="p">(</span><span class="n">rxFifoDepth</span><span class="p">),</span><span class="w"></span>
<span class="w">                                </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">validBitOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="n">payloadBitOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<div class="line-block">
<div class="line">Yes, that’s all it takes. It’s also synthesizable.</div>
<div class="line">The Apb3SlaveFactory tool is not something hard-coded into the SpinalHDL compiler. It’s something implemented with SpinalHDL regular hardware description syntax.</div>
</div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Examples/Advanced ones/pinesec"></span><section id="pinesec">
<h4>Pinesec<a class="headerlink" href="#pinesec" title="Permalink to this heading"></a></h4>
<p>Remember to add it</p>
</section>
<span id="document-SpinalHDL/Examples/Advanced ones/slots"></span><section id="slots">
<span id="id1"></span><h4>Slots<a class="headerlink" href="#slots" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>Let’s say you have some hardware which has to keep track of multiple similar ongoing activities,
you may want to implement an array of “slots” to do so. This example show how to do it using
<code class="docutils literal notranslate"><span class="pre">Area</span></code>, <code class="docutils literal notranslate"><span class="pre">OHMasking.first</span></code>, <code class="docutils literal notranslate"><span class="pre">onMask</span></code> and <code class="docutils literal notranslate"><span class="pre">reader</span></code>.</p>
<section id="implementation">
<h6>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h6>
<p>This implementation avoid the use of <code class="docutils literal notranslate"><span class="pre">Vec</span></code>. Instead, it use Area which allow to mix signals,
registers and logic definitions in each slot.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">reader</span></code> API is for SpinalHDL version coming after 1.9.1</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="nn">spinaldoc</span><span class="p">.</span><span class="nn">examples</span><span class="p">.</span><span class="n">advanced</span>

<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">language</span><span class="p">.</span><span class="n">postfixOps</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SlotsDemo</span><span class="p">(</span><span class="n">slotsCount</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// Create the hardware for each slot.</span>
<span class="w">  </span><span class="c1">// Note each slot is an Area, not a Bundle.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">slotsCount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Because the slot is an Area, we can define mix signals, registers, </span>
<span class="w">    </span><span class="c1">// logic definitions.</span>
<span class="w">    </span><span class="c1">// Here are the registers for each slots:</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// Will count since how many cycles the slot is valid</span>

<span class="w">    </span><span class="c1">// Here is some hardware behavior for each slots.</span>
<span class="w">    </span><span class="c1">// Implement the age logic.</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">age</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// removeIt will be used as a slot interface later on.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">removeIt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">removeIt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Logic to allocate a new slot.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// Interface to issue requests.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">!</span><span class="n">_</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">freeOh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">OHMasking</span><span class="p">.</span><span class="n">first</span><span class="p">(</span><span class="n">free</span><span class="p">)</span><span class="w"> </span><span class="c1">// Get the first free slot (on hot mask).</span>
<span class="w">    </span><span class="n">cmd</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">free</span><span class="p">.</span><span class="n">orR</span><span class="w"> </span><span class="c1">// Only allow cmd when there is a free slot.</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">fire</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// slots.onMask(freeOh)(code) will execute the code for each slot where</span>
<span class="w">      </span><span class="c1">// the corresponding freeOh bit is set</span>
<span class="w">      </span><span class="n">slots</span><span class="p">.</span><span class="n">onMask</span><span class="p">(</span><span class="n">freeOh</span><span class="p">){</span><span class="n">slot</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">slot</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">        </span><span class="n">slot</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">        </span><span class="n">slot</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Logic to remove the slots which match a given address (assuming</span>
<span class="w">  </span><span class="c1">// there is not more than one match).</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Flow</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">// Interface to issue requests.</span>
<span class="w">    </span><span class="c1">// oh meaning &quot;one hot&quot;</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">oh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">fire</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">slots</span><span class="p">.</span><span class="n">onMask</span><span class="p">(</span><span class="n">oh</span><span class="p">){</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">slot</span><span class="p">.</span><span class="n">removeIt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create a facility to read the slots using &quot;oh&quot; as index</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slots</span><span class="p">.</span><span class="n">reader</span><span class="p">(</span><span class="n">oh</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="c1">// Age of the slot which is selected by &quot;oh&quot;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">SlotsDemo</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="nc">SlotsDemo</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="in-practice">
<h6>In practice<a class="headerlink" href="#in-practice" title="Permalink to this heading"></a></h6>
<p>For instance, this kind of slot pattern is used in Tilelink coherency hub to keep track of all
ongoing memory probes in flight <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/008c73f1ce18e294f137efe7a1442bd3f8fa2ee0/lib/src/main/scala/spinal/lib/bus/tilelink/coherent/Hub.scala#L376">in SpinalHDL code</a>.</p>
<p>As well in the DRAM / SDR / DDR memory controller to implement the handling of multiple memory
transactions at once (having multiple precharge / active / read / write running at the same time to
improve performances) <a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/1edba1890b5f629b28e5171b3c449155337d2548/lib/src/main/scala/spinal/lib/memory/sdram/xdr/Tasker.scala#L202">here</a>.</p>
<p>As well in the NaxRiscv (out of order CPU) load-store-unit to handle the store-queue / load-queue
hardware (a bit too scary to show here in the doc XD).</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Examples/Advanced ones/timer"></span><section id="timer">
<span id="id1"></span><h4>Timer<a class="headerlink" href="#timer" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>A timer module is probably one of the most basic pieces of hardware. But even for a timer, there are some interesting things that you can do with SpinalHDL. This example will define a simple timer component which integrates a bus bridging utile.</p>
</section>
<section id="id2">
<h5>Timer<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h5>
<p>So let’s start with the <code class="docutils literal notranslate"><span class="pre">Timer</span></code> component.</p>
<section id="specification">
<h6>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h6>
<p>The <code class="docutils literal notranslate"><span class="pre">Timer</span></code> component will have a single construction parameter:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>width</p></td>
<td><p>Int</p></td>
<td><p>Specify the bit width of the timer counter</p></td>
</tr>
</tbody>
</table>
<p>And also some inputs/outputs:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>IO Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>tick</p></td>
<td><p>in</p></td>
<td><p>Bool</p></td>
<td><p>When <code class="docutils literal notranslate"><span class="pre">tick</span></code> is True, the timer count up until <code class="docutils literal notranslate"><span class="pre">limit</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>clear</p></td>
<td><p>in</p></td>
<td><p>Bool</p></td>
<td><p>When <code class="docutils literal notranslate"><span class="pre">tick</span></code> is True, the timer is set to zero. <code class="docutils literal notranslate"><span class="pre">clear</span></code> has priority over <code class="docutils literal notranslate"><span class="pre">tick</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>limit</p></td>
<td><p>in</p></td>
<td><p>UInt(width bits)</p></td>
<td><p>When the timer value is equal to <code class="docutils literal notranslate"><span class="pre">limit</span></code>, the <code class="docutils literal notranslate"><span class="pre">tick</span></code> input is inhibited.</p></td>
</tr>
<tr class="row-odd"><td><p>full</p></td>
<td><p>out</p></td>
<td><p>Bool</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">full</span></code> is high when the timer value is equal to <code class="docutils literal notranslate"><span class="pre">limit</span></code> and <code class="docutils literal notranslate"><span class="pre">tick</span></code> is high.</p></td>
</tr>
<tr class="row-even"><td><p>value</p></td>
<td><p>out</p></td>
<td><p>UInt(width bits)</p></td>
<td><p>Wire out the timer counter value.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="implementation">
<h6>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">full</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">tick</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clear</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">limit</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">tick</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="bridging-function">
<h5>Bridging function<a class="headerlink" href="#bridging-function" title="Permalink to this heading"></a></h5>
<p>Now we can start with the main purpose of this example: defining a bus bridging function. To do that we will use two techniques:</p>
<ul class="simple">
<li><p>Using the <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> tool documented <a class="reference internal" href="index.html#bus-slave-factory"><span class="std std-ref">here</span></a></p></li>
<li><p>Defining a function inside the <code class="docutils literal notranslate"><span class="pre">Timer</span></code> component which can be called from the parent component to drive the <code class="docutils literal notranslate"><span class="pre">Timer</span></code>‘s IO in an abstract way.</p></li>
</ul>
<section id="id3">
<h6>Specification<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h6>
<p>This bridging function will take the following parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>busCtrl</p></td>
<td><p>BusSlaveFactory</p></td>
<td><p>The <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> instance that will be used by the function to create the bridging logic.</p></td>
</tr>
<tr class="row-odd"><td><p>baseAddress</p></td>
<td><p>BigInt</p></td>
<td><p>The base address where the bridging logic should be mapped.</p></td>
</tr>
<tr class="row-even"><td><p>ticks</p></td>
<td><p>Seq[Bool]</p></td>
<td><p>A list of Bool sources that can be used as a tick signal.</p></td>
</tr>
<tr class="row-odd"><td><p>clears</p></td>
<td><p>Seq[Bool]</p></td>
<td><p>A list of Bool sources that can be used as a clear signal.</p></td>
</tr>
</tbody>
</table>
<p>The register mapping assumes that the bus system is 32 bits wide:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Access</p></th>
<th class="head"><p>Width</p></th>
<th class="head"><p>Address offset</p></th>
<th class="head"><p>Bit offset</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ticksEnable</p></td>
<td><p>RW</p></td>
<td><p>len(ticks)</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>Each <code class="docutils literal notranslate"><span class="pre">ticks</span></code> bool can be activated if the corresponding <code class="docutils literal notranslate"><span class="pre">ticksEnable</span></code> bit is high.</p></td>
</tr>
<tr class="row-odd"><td><p>clearsEnable</p></td>
<td><p>RW</p></td>
<td><p>len(clears)</p></td>
<td><p>0</p></td>
<td><p>16</p></td>
<td><p>Each <code class="docutils literal notranslate"><span class="pre">clears</span></code> bool can be activated if the corresponding <code class="docutils literal notranslate"><span class="pre">clearsEnable</span></code> bit is high.</p></td>
</tr>
<tr class="row-even"><td><p>limit</p></td>
<td><p>RW</p></td>
<td><p>width</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><div class="line-block">
<div class="line">Access the limit value of the timer component.</div>
<div class="line">When this register is written to, the timer is cleared.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>value</p></td>
<td><p>R</p></td>
<td><p>width</p></td>
<td><p>8</p></td>
<td><p>0</p></td>
<td><p>Access the value of the timer.</p></td>
</tr>
<tr class="row-even"><td><p>clear</p></td>
<td><p>W</p></td>
<td></td>
<td><p>8</p></td>
<td></td>
<td><p>When this register is written to, it clears the timer.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id4">
<h6>Implementation<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h6>
<p>Let’s add this bridging function inside the <code class="docutils literal notranslate"><span class="pre">Timer</span></code> component.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The function prototype uses Scala currying funcName(arg1,arg2)(arg3,arg3)</span>
<span class="w">  </span><span class="c1">// which allow to call the function with a nice syntax later</span>
<span class="w">  </span><span class="c1">// This function also returns an area, which allows to keep names of inner signals in the generated VHDL/Verilog.</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactory</span><span class="p">,</span><span class="w"> </span><span class="n">baseAddress</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)(</span><span class="n">ticks</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Bool</span><span class="p">],</span><span class="w"> </span><span class="n">clears</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Bool</span><span class="p">])</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Offset 0 =&gt; clear/tick masks + bus</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ticksEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">createReadAndWrite</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">ticks</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">baseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clearsEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">createReadAndWrite</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">clears</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">baseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">busClearing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">clear</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">clearsEnable</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">clears</span><span class="p">.</span><span class="n">asBits</span><span class="p">).</span><span class="n">orR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">busClearing</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">tick</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ticksEnable</span><span class="w">  </span><span class="n">&amp;</span><span class="w"> </span><span class="n">ticks</span><span class="p">.</span><span class="n">asBits</span><span class="w"> </span><span class="p">).</span><span class="n">orR</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Offset 4 =&gt; read/write limit (+ auto clear)</span>
<span class="w">    </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">driveAndRead</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">baseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">busClearing</span><span class="p">.</span><span class="n">setWhen</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">.</span><span class="n">isWriting</span><span class="p">(</span><span class="n">baseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Offset 8 =&gt; read timer value / write =&gt; clear timer value</span>
<span class="w">    </span><span class="n">busCtrl</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">baseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">busClearing</span><span class="p">.</span><span class="n">setWhen</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">.</span><span class="n">isWriting</span><span class="p">(</span><span class="n">baseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="usage">
<h6>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h6>
<p>Here is some demonstration code which is very close to the one used in the Pinsec SoC timer module. Basically it instantiates following elements:</p>
<ul class="simple">
<li><p>One 16 bit prescaler</p></li>
<li><p>One 32 bit timer</p></li>
<li><p>Three 16 bit timers</p></li>
</ul>
<p>Then by using an <code class="docutils literal notranslate"><span class="pre">Apb3SlaveFactory</span></code> and functions defined inside the <code class="docutils literal notranslate"><span class="pre">Timer</span></code>s, it creates bridging logic between the APB3 bus and all instantiated components.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="nc">Apb3Config</span><span class="p">(</span><span class="n">addressWidth</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">dataWidth</span><span class="o">=</span><span class="mi">32</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Prescaler is very similar to the timer, it mainly integrates a piece of auto reload logic.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Prescaler</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">timerA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Timer</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">timerB</span><span class="p">,</span><span class="n">timerC</span><span class="p">,</span><span class="n">timerD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Timer</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">busCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3SlaveFactory</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="n">prescaler</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">timerA</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">)(</span><span class="w"></span>
<span class="w">    </span><span class="n">ticks</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="nc">True</span><span class="p">,</span><span class="w"> </span><span class="n">prescaler</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">overflow</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">clears</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="n">timerA</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">timerB</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">,</span><span class="w"> </span><span class="mh">0x50</span><span class="p">)(</span><span class="w"></span>
<span class="w">    </span><span class="n">ticks</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="nc">True</span><span class="p">,</span><span class="w"> </span><span class="n">prescaler</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">tick</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">clears</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="n">timerB</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">clear</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">timerC</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">)(</span><span class="w"></span>
<span class="w">    </span><span class="n">ticks</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="nc">True</span><span class="p">,</span><span class="w"> </span><span class="n">prescaler</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">tick</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">clears</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="n">timerC</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">clear</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">timerD</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">)(</span><span class="w"></span>
<span class="w">    </span><span class="n">ticks</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="nc">True</span><span class="p">,</span><span class="w"> </span><span class="n">prescaler</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">tick</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">clears</span><span class="o">=</span><span class="nc">List</span><span class="p">(</span><span class="n">timerD</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">clear</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">interruptCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InterruptCtrl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">interruptCtrl</span><span class="p">.</span><span class="n">driveFrom</span><span class="p">(</span><span class="n">busCtrl</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">interruptCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timerA</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="w"></span>
<span class="w">  </span><span class="n">interruptCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timerB</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="w"></span>
<span class="w">  </span><span class="n">interruptCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timerC</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="w"></span>
<span class="w">  </span><span class="n">interruptCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timerD</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">full</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">interruptCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pendings</span><span class="p">.</span><span class="n">orR</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
</div>
</section>
</div>
<p id="example-introduction">Examples are split into three kinds:</p>
<ul class="simple">
<li><p>Simple examples that could be used to get used to the basics of SpinalHDL.</p></li>
<li><p>Intermediate examples which implement components by using a traditional approach.</p></li>
<li><p>Advanced examples which go further than traditional HDL by using object-oriented programming, functional programming, and meta-hardware description.</p></li>
</ul>
<p>They are all accessible in the sidebar under the corresponding sections.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The SpinalHDL workshop contains many labs with their solutions. See <a class="reference external" href="https://github.com/SpinalHDL/SpinalWorkshop">here</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also find a list of repositories using SpinalHDL <a class="reference internal" href="index.html#users-repositories"><span class="std std-ref">there</span></a></p>
</div>
<section id="getting-started">
<h3>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this heading"></a></h3>
<p>All examples assume that you have the following imports on the top of your scala file:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
<p>To generate VHDL for a given component, you can place the following at the bottom of your scala file:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">MyMainObject</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">TheComponentThatIWantToGenerate</span><span class="p">(</span><span class="n">constructionArguments</span><span class="p">))</span><span class="w">   </span><span class="c1">// Or SpinalVerilog</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Legacy/index"></span><section id="legacy">
<h2>Legacy<a class="headerlink" href="#legacy" title="Permalink to this heading"></a></h2>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Legacy/riscv"></span><section id="riscv">
<h3>RiscV<a class="headerlink" href="#riscv" title="Permalink to this heading"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This page only documents the first generation of RISC-V CPU created in SpinalHDL.
This page does not document the VexRiscV CPU, which is the second generation of this CPU and is available
<a class="reference external" href="https://github.com/SpinalHDL/VexRiscv">here</a> and offers better performance/area/features.</p>
</div>
<section id="features">
<h4>Features<a class="headerlink" href="#features" title="Permalink to this heading"></a></h4>
<p>RISC-V CPU</p>
<ul class="simple">
<li><p>Pipelined on 5 stages (Fetch Decode Execute0 Execute1 WriteBack)</p></li>
<li><p>Multiple branch prediction modes : (disable, static or dynamic)</p></li>
<li><p>Data path parameterizable between fully bypassed to fully interlocked</p></li>
</ul>
<p>Extensions</p>
<ul class="simple">
<li><p>One cycle multiplication</p></li>
<li><p>34 cycle division</p></li>
<li><p>Iterative shifter (N shift -&gt; N cycles)</p></li>
<li><p>Single cycle shifter</p></li>
<li><p>Interruption controller</p></li>
<li><p>Debugging module (with JTAG bridge, openOCD port and GDB)</p></li>
<li><p>Instruction cache with wrapped burst memory interface, one way</p></li>
<li><p>Data cache with instructions to evict/flush the whole cache or a given address, one way</p></li>
</ul>
<p>Performance/Area (on cyclone II)</p>
<ul class="simple">
<li><p>small core -&gt; 846 LE, 0.6 DMIPS/Mhz</p></li>
<li><p>debug module (without JTAG) -&gt; 240 LE</p></li>
<li><p>JTAG Avalon master -&gt; 238 LE</p></li>
<li><p>big core with MUL/DIV/Full shifter/I$/Interrupt/Debug -&gt; 2200 LE, 1.15 DMIPS/Mhz, at least 100 Mhz (with default synthesis option)</p></li>
</ul>
</section>
<section id="base-fpga-project">
<h4>Base FPGA project<a class="headerlink" href="#base-fpga-project" title="Permalink to this heading"></a></h4>
<p>You can find a DE1-SOC project which integrate two instance of the CPU with MUL/DIV/Full shifter/I$/Interrupt/Debug there :</p>
<p><a class="reference external" href="https://drive.google.com/drive/folders/0B-CqLXDTaMbKNkktb2k3T3lzcUk?usp=sharing">https://drive.google.com/drive/folders/0B-CqLXDTaMbKNkktb2k3T3lzcUk?usp=sharing</a></p>
<p>CPU/JTAG/VGA IP are pre-generated.
Quartus Prime : 15.1.</p>
</section>
<section id="how-to-generate-the-cpu-vhdl">
<h4>How to generate the CPU VHDL<a class="headerlink" href="#how-to-generate-the-cpu-vhdl" title="Permalink to this heading"></a></h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This avalon version of the CPU isn’t present in recent releases of SpinalHDL. Please consider the <a class="reference external" href="https://github.com/SpinalHDL/VexRiscv">VexRiscv</a> instead.</p>
</div>
</section>
<section id="how-to-debug">
<h4>How to debug<a class="headerlink" href="#how-to-debug" title="Permalink to this heading"></a></h4>
<p>You can find the openOCD fork here :</p>
<p><a class="reference external" href="https://github.com/Dolu1990/openocd_riscv">https://github.com/Dolu1990/openocd_riscv</a></p>
<p>An example target configuration file could be find here :</p>
<p><a class="reference external" href="https://github.com/Dolu1990/openocd_riscv/blob/riscv_spinal/tcl/target/riscv_spinal.cfg">https://github.com/Dolu1990/openocd_riscv/blob/riscv_spinal/tcl/target/riscv_spinal.cfg</a></p>
<p>Then you can use the RISCV GDB.</p>
</section>
<section id="todo">
<h4>Todo<a class="headerlink" href="#todo" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Documentation</p></li>
<li><p>Optimize instruction/data caches FMax by moving line hit condition forward into combinatorial paths.</p></li>
</ul>
<p>Contact <a class="reference external" href="mailto:spinalhdl&#37;&#52;&#48;gmail&#46;com">spinalhdl<span>&#64;</span>gmail<span>&#46;</span>com</a> for more information</p>
</section>
</section>
<span id="document-SpinalHDL/Legacy/pinsec/index"></span><section id="pinsec">
<h3>pinsec<a class="headerlink" href="#pinsec" title="Permalink to this heading"></a></h3>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Legacy/pinsec/introduction"></span><section id="introduction">
<span id="pinsec-introduction"></span><h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page only documents the SoC implemented with the first generation of RISC-V CPU created in SpinalHDL.
This page does not document the VexRiscV CPU, which is the second generation of this SoC (and CPU) is available
<a class="reference external" href="https://github.com/SpinalHDL/VexRiscv">here</a> and offers better performance/area/features.</p>
</div>
<section id="id1">
<h5>Introduction<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h5>
<p>Pinsec is the name of a little FPGA SoC fully written in SpinalHDL. Goals of this project are multiple :</p>
<ul class="simple">
<li><p>Prove that SpinalHDL is a viable HDL alternative in non-trivial projects.</p></li>
<li><p>Show advantage of SpinalHDL meta-hardware description capabilities in a concrete project.</p></li>
<li><p>Provide a fully open source SoC.</p></li>
</ul>
<p>Pinsec has followings hardware features:</p>
<ul class="simple">
<li><p>AXI4 interconnect for high speed busses</p></li>
<li><p>APB3 interconnect for peripherals</p></li>
<li><p>RISCV CPU with instruction cache, MUL/DIV extension and interrupt controller</p></li>
<li><p>JTAG bridge to load binaries and debug the CPU</p></li>
<li><p>SDRAM SDR controller</p></li>
<li><p>On chip ram</p></li>
<li><p>One UART controller</p></li>
<li><p>One VGA controller</p></li>
<li><p>Some timer module</p></li>
<li><p>Some GPIO</p></li>
</ul>
<p>The toplevel code explanation could be find <a class="reference internal" href="index.html#pinsec-hardware-toplevel"><span class="std std-ref">there</span></a></p>
</section>
<section id="board-support">
<h5>Board support<a class="headerlink" href="#board-support" title="Permalink to this heading"></a></h5>
<p>A DE1-SOC FPGA project can be find <a class="reference external" href="https://drive.google.com/drive/folders/0B-CqLXDTaMbKOGhIU0JGdHVVSk0?usp=sharing">here</a> with some demo binaries.</p>
</section>
</section>
<span id="document-SpinalHDL/Legacy/pinsec/hardware"></span><section id="hardware">
<h4>Hardware<a class="headerlink" href="#hardware" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p>There is the Pinsec toplevel hardware diagram :</p>
<img alt="_images/pinsec_hardware.svg" class="align-center" src="_images/pinsec_hardware.svg" /></section>
<section id="riscv">
<h5>RISCV<a class="headerlink" href="#riscv" title="Permalink to this heading"></a></h5>
<p>The RISCV is a 5 stage pipelined CPU with following features :</p>
<ul class="simple">
<li><p>Instruction cache</p></li>
<li><p>Single cycle Barrel shifter</p></li>
<li><p>Single cycle MUL, 34 cycle DIV</p></li>
<li><p>Interruption support</p></li>
<li><p>Dynamic branch prediction</p></li>
<li><p>Debug port</p></li>
</ul>
</section>
<section id="axi4">
<h5>AXI4<a class="headerlink" href="#axi4" title="Permalink to this heading"></a></h5>
<p>As previously said, Pinsec integrates an AXI4 bus fabric. AXI4 is not the easiest bus to work with but has many advantages like:</p>
<ul class="simple">
<li><p>A flexible topology</p></li>
<li><p>High bandwidth potential</p></li>
<li><p>Potential out of order request completion</p></li>
<li><p>Easy methods to meets clocks timings</p></li>
<li><p>Standard used by many IP cores</p></li>
<li><p>A handshake methodology that fits with SpinalHDL Stream.</p></li>
</ul>
<p>From an Area utilization perspective, AXI4 is for sure not the lightest solution, but some techniques could dramatically reduce that concern :</p>
<ul class="simple">
<li><p>Using Read-Only/Write-Only AXI4 variations where that is possible</p></li>
<li><p>Introducing an Axi4-Shared variation where a new ARW channel is introduced to replace and combine AR and AW channels. This solution reduces resource usage by a factor of two for the address decoding and the address arbitration.</p></li>
<li><p>Timing relaxation is possible depending upon the interconnect implementation, and if all masters never stall the R/B channel (RREADY and BREADY are strapped to 1). Both xREADY signals can be removed by synthesis in this case, relaxing timings.</p></li>
<li><p>As the AXI4 spec suggests, the interconnect can expand the transactions ID by aggregating the corresponding input port ID. This allows the interconnect to have an infinite number of pending requests and also to support out of order completion with a negligible area cost (transaction ID expand).</p></li>
</ul>
<p>The Pinsec interconnect doesn’t introduce latency cycles.</p>
</section>
<section id="apb3">
<h5>APB3<a class="headerlink" href="#apb3" title="Permalink to this heading"></a></h5>
<p>In Pinsec, all peripherals implement an APB3 bus to be interfaced. The APB3 choice was motivated by following reasons :</p>
<ul class="simple">
<li><p>Very simple bus (no burst)</p></li>
<li><p>Use very few resources</p></li>
<li><p>Standard used by many IP cores</p></li>
</ul>
</section>
<section id="generate-the-rtl">
<h5>Generate the RTL<a class="headerlink" href="#generate-the-rtl" title="Permalink to this heading"></a></h5>
<p>To generate the RTL, you have multiple solutions :</p>
<p>You can download the SpinalHDL source code, and then run :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">sbt</span><span class="w"> </span><span class="s">&quot;project SpinalHDL-lib&quot;</span><span class="w"> </span><span class="s">&quot;run-main spinal.lib.soc.pinsec.Pinsec&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>Or you can create your own main into your own SBT project and then run it :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">soc</span><span class="p">.</span><span class="nn">pinsec</span><span class="p">.</span><span class="n">_</span>

<span class="k">object</span><span class="w"> </span><span class="nc">PinsecMain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Pinsec</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Pinsec</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="nc">MHz</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, only the verilog version was tested in simulation and in FPGA because the last release of GHDL is not compatible with cocotb.</p>
</div>
</section>
</section>
<span id="document-SpinalHDL/Legacy/pinsec/hardware_toplevel"></span><section id="soc-toplevel-pinsec">
<span id="pinsec-hardware-toplevel"></span><h4>SoC toplevel (Pinsec)<a class="headerlink" href="#soc-toplevel-pinsec" title="Permalink to this heading"></a></h4>
<section id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">Pinsec</span></code> is a little SoC designed for FPGA. It is available in the SpinalHDL library and some documentation could be find <a class="reference internal" href="index.html#pinsec-introduction"><span class="std std-ref">there</span></a></p>
<p>Its toplevel implementation is an interesting example, because it is a mix some design patterns that make it very easy to modify. Adding a new master or a new peripheral to the bus fabric could be done with little effort.</p>
<p>The toplevel implementation could be consulted at the links here :
<a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/master/lib/src/main/scala/spinal/lib/soc/pinsec/Pinsec.scala">https://github.com/SpinalHDL/SpinalHDL/blob/master/lib/src/main/scala/spinal/lib/soc/pinsec/Pinsec.scala</a></p>
<p>This is the Pinsec toplevel hardware diagram :</p>
<img alt="_images/pinsec_hardware.svg" class="align-center" src="_images/pinsec_hardware.svg" /></section>
<section id="defining-all-io">
<h5>Defining all IO<a class="headerlink" href="#defining-all-io" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Clocks / reset</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">asyncReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">axiClk</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vgaClk</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Main components IO</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">jtag</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Jtag</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sdram</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">SdramInterface</span><span class="p">(</span><span class="nc">IS42x320D</span><span class="p">.</span><span class="n">layout</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Peripherals IO</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gpioA</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">TriStateArray</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w">   </span><span class="c1">// Each pin has an individual output enable control</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gpioB</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">TriStateArray</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">uart</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Uart</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vga</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Vga</span><span class="p">(</span><span class="nc">RgbConfig</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="clock-and-resets">
<h5>Clock and resets<a class="headerlink" href="#clock-and-resets" title="Permalink to this heading"></a></h5>
<p>Pinsec has three clocks inputs :</p>
<ul class="simple">
<li><p>axiClock</p></li>
<li><p>vgaClock</p></li>
<li><p>jtag.tck</p></li>
</ul>
<p>And one reset input :</p>
<ul class="simple">
<li><p>asyncReset</p></li>
</ul>
<p>Which will finally give 5 ClockDomain (clock/reset couple) :</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Clock</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>resetCtrlClockDomain</p></td>
<td><p>axiClock</p></td>
<td><p>Used by the reset controller, Flops of this clock domain are initialized by the FPGA bitstream</p></td>
</tr>
<tr class="row-odd"><td><p>axiClockDomain</p></td>
<td><p>axiClock</p></td>
<td><p>Used by all component connected to the AXI and the APB interconnect</p></td>
</tr>
<tr class="row-even"><td><p>coreClockDomain</p></td>
<td><p>axiClock</p></td>
<td><p>The only difference with the axiClockDomain, is the fact that the reset could also be asserted by the debug module</p></td>
</tr>
<tr class="row-odd"><td><p>vgaClockDomain</p></td>
<td><p>vgaClock</p></td>
<td><p>Used by the VGA controller backend as a pixel clock</p></td>
</tr>
<tr class="row-even"><td><p>jtagClockDomain</p></td>
<td><p>jtag.tck</p></td>
<td><p>Used to clock the frontend of the JTAG controller</p></td>
</tr>
</tbody>
</table>
<section id="reset-controller">
<h6>Reset controller<a class="headerlink" href="#reset-controller" title="Permalink to this heading"></a></h6>
<p>First we need to define the reset controller clock domain, which has no reset signal, but use the FPGA bitstream loading to setup flip-flops.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">resetCtrlClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">axiClk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">resetKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BOOT</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then we can define a simple reset controller under this clock domain.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">resetCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">resetCtrlClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">axiResetUnbuffered</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">coreResetUnbuffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Implement an counter to keep the reset axiResetOrder high 64 cycles</span>
<span class="w">  </span><span class="c1">// Also this counter will automaticly do a reset when the system boot.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">axiResetCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">axiResetCounter</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="n">axiResetCounter</span><span class="p">.</span><span class="n">range</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">axiResetCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">axiResetCounter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">axiResetUnbuffered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">asyncReset</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">axiResetCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// When an axiResetOrder happen, the core reset will as well</span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">axiResetUnbuffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">coreResetUnbuffered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Create all reset used later in the design</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">axiReset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">axiResetUnbuffered</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">coreReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">coreResetUnbuffered</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vgaReset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">BufferCC</span><span class="p">(</span><span class="n">axiResetUnbuffered</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="clock-domain-setup-for-each-system">
<h6>Clock domain setup for each system<a class="headerlink" href="#clock-domain-setup-for-each-system" title="Permalink to this heading"></a></h6>
<p>Now that the reset controller is implemented, we can define clock domain for all sub-systems of Pinsec :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">axiClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">axiClk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">reset</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">resetCtrl</span><span class="p">.</span><span class="n">axiReset</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">50</span><span class="w"> </span><span class="nc">MHz</span><span class="p">)</span><span class="w"> </span><span class="c1">// The frequency information is used by the SDRAM controller</span>
<span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">axiClk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resetCtrl</span><span class="p">.</span><span class="n">coreReset</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">vgaClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">vgaClk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resetCtrl</span><span class="p">.</span><span class="n">vgaReset</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">jtagClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="n">tck</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Also all the core system of Pinsec will be defined into a <code class="docutils literal notranslate"><span class="pre">axi</span></code> clocked area :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">axi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">axiClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Here will come the rest of Pinsec</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="main-components">
<h5>Main components<a class="headerlink" href="#main-components" title="Permalink to this heading"></a></h5>
<p>Pinsec is constituted mainly by 4 main components :</p>
<ul class="simple">
<li><p>One RISCV CPU</p></li>
<li><p>One SDRAM controller</p></li>
<li><p>One on chip memory</p></li>
<li><p>One JTAG controller</p></li>
</ul>
<section id="riscv-cpu">
<h6>RISCV CPU<a class="headerlink" href="#riscv-cpu" title="Permalink to this heading"></a></h6>
<p>The RISCV CPU used in Pinsec as many parametrization possibilities :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">coreConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CoreConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">pcWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">addrWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">startAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">regFileReadyKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sync</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">branchPrediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamic</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bypassExecute0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bypassExecute1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bypassWriteBack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bypassWriteBackBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">collapseBubble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fastFetchCmdPcCalculation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dynamicBranchPredictorCacheSizeLog2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The CPU has a systems of plugin which allow to add new feature into the core.</span>
<span class="w">  </span><span class="c1">// Those extension are not directly implemented into the core, but are kind of additive logic patch defined in a separated area.</span>
<span class="w">  </span><span class="n">coreConfig</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MulExtension</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">coreConfig</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">DivExtension</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">coreConfig</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">BarrelShifterFullExtension</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">iCacheConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InstructionCacheConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">cacheSize</span><span class="w"> </span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bytePerLine</span><span class="w"> </span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wayCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">// Can only be one for the moment</span>
<span class="w">    </span><span class="n">wrappedMemAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cpuDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">memDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// There is the instantiation of the CPU by using all those construction parameters</span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="nc">RiscvAxi4</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">coreConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coreConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">iCacheConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iCacheConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dCacheConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">interruptCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="on-chip-ram">
<h6>On chip RAM<a class="headerlink" href="#on-chip-ram" title="Permalink to this heading"></a></h6>
<p>The instantiation of the AXI4 on chip RAM is very simple.</p>
<p>In fact it’s not an AXI4 but an Axi4Shared, which mean that a ARW channel replace the AR and AW ones.
This solution uses less area while being fully interoperable with full AXI4.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4SharedOnChipRam</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">byteCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">idWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">     </span><span class="c1">// Specify the AXI4 ID width.</span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sdram-controller">
<h6>SDRAM controller<a class="headerlink" href="#sdram-controller" title="Permalink to this heading"></a></h6>
<p>First you need to define the layout and timings of your SDRAM device. On the DE1-SOC, the SDRAM device is an IS42x320D one.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">IS42x320D</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SdramLayout</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">bankWidth</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">columnWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rowWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dataWidth</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">timingGrade7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SdramTimings</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">bootRefreshCount</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tPOW</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">us</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tREF</span><span class="w">             </span><span class="o">=</span><span class="w">  </span><span class="mi">64</span><span class="w"> </span><span class="n">ms</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tRC</span><span class="w">              </span><span class="o">=</span><span class="w">  </span><span class="mi">60</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tRFC</span><span class="w">             </span><span class="o">=</span><span class="w">  </span><span class="mi">60</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tRAS</span><span class="w">             </span><span class="o">=</span><span class="w">  </span><span class="mi">37</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tRP</span><span class="w">              </span><span class="o">=</span><span class="w">  </span><span class="mi">15</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tRCD</span><span class="w">             </span><span class="o">=</span><span class="w">  </span><span class="mi">15</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cMRD</span><span class="w">             </span><span class="o">=</span><span class="w">   </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tWR</span><span class="w">              </span><span class="o">=</span><span class="w">  </span><span class="mi">10</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cWR</span><span class="w">              </span><span class="o">=</span><span class="w">   </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then you can used those definition to parametrize the SDRAM controller instantiation.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">sdramCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4SharedSdramCtrl</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">axiDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">axiIdWidth</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">layout</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">IS42x320D</span><span class="p">.</span><span class="n">layout</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">timing</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">IS42x320D</span><span class="p">.</span><span class="n">timingGrade7</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nc">CAS</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="jtag-controller">
<h6>JTAG controller<a class="headerlink" href="#jtag-controller" title="Permalink to this heading"></a></h6>
<p>The JTAG controller could be used to access memories and debug the CPU from an PC.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">jtagCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">JtagAxi4SharedDebugger</span><span class="p">(</span><span class="nc">SystemDebuggerConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">memAddressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">memDataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">remoteCmdWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">jtagClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jtagClockDomain</span><span class="w"></span>
<span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="peripherals">
<h5>Peripherals<a class="headerlink" href="#peripherals" title="Permalink to this heading"></a></h5>
<p>Pinsec has some integrated peripherals :</p>
<ul class="simple">
<li><p>GPIO</p></li>
<li><p>Timer</p></li>
<li><p>UART</p></li>
<li><p>VGA</p></li>
</ul>
<section id="gpio">
<h6>GPIO<a class="headerlink" href="#gpio" title="Permalink to this heading"></a></h6>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">gpioACtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">gpioWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">gpioBCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Gpio</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">gpioWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="timer">
<h6>Timer<a class="headerlink" href="#timer" title="Permalink to this heading"></a></h6>
<p>The Pinsec timer module consists of :</p>
<ul class="simple">
<li><p>One prescaler</p></li>
<li><p>One 32 bits timer</p></li>
<li><p>Three 16 bits timers</p></li>
</ul>
<p>All of them are packed into the PinsecTimerCtrl component.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">timerCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">PinsecTimerCtrl</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uart-controller">
<h6>UART controller<a class="headerlink" href="#uart-controller" title="Permalink to this heading"></a></h6>
<p>First we need to define a configuration for our UART controller :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrlConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlMemoryMappedConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">uartCtrlConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlGenerics</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">dataWidthMax</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">clockDividerWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">preSamplingSize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">samplingSize</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">postSamplingSize</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">txFifoDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">rxFifoDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then we can use it to instantiate the UART controller</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">uartCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3UartCtrl</span><span class="p">(</span><span class="n">uartCtrlConfig</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="vga-controller">
<h6>VGA controller<a class="headerlink" href="#vga-controller" title="Permalink to this heading"></a></h6>
<p>First we need to define a configuration for our VGA controller :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">vgaCtrlConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4VgaCtrlGenerics</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">axiAddressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">axiDataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">burstLength</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">           </span><span class="c1">// In Axi words</span>
<span class="w">  </span><span class="n">frameSizeMax</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="o">*</span><span class="mi">1512</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="c1">// In byte</span>
<span class="w">  </span><span class="n">fifoSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w">         </span><span class="c1">// In axi words</span>
<span class="w">  </span><span class="n">rgbConfig</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">RgbConfig</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">vgaClock</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">vgaClockDomain</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then we can use it to instantiate the VGA controller</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">vgaCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4VgaCtrl</span><span class="p">(</span><span class="n">vgaCtrlConfig</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="bus-interconnects">
<h5>Bus interconnects<a class="headerlink" href="#bus-interconnects" title="Permalink to this heading"></a></h5>
<p>There is three interconnections components :</p>
<ul class="simple">
<li><p>AXI4 crossbar</p></li>
<li><p>AXI4 to APB3 bridge</p></li>
<li><p>APB3 decoder</p></li>
</ul>
<section id="axi4-to-apb3-bridge">
<h6>AXI4 to APB3 bridge<a class="headerlink" href="#axi4-to-apb3-bridge" title="Permalink to this heading"></a></h6>
<p>This bridge will be used to connect low bandwidth peripherals to the AXI crossbar.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">apbBridge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4SharedToApb3Bridge</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">idWidth</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="axi4-crossbar">
<h6>AXI4 crossbar<a class="headerlink" href="#axi4-crossbar" title="Permalink to this heading"></a></h6>
<p>The AXI4 crossbar that interconnect AXI4 masters and slaves together is generated by using an factory.
The concept of this factory is to create it, then call many function on it to configure it, and finally call
the <code class="docutils literal notranslate"><span class="pre">build</span></code> function to ask the factory to generate the corresponding hardware :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">axiCrossbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axi4CrossbarFactory</span><span class="p">()</span><span class="w"></span>
<span class="c1">// Where you will have to call function the the axiCrossbar factory to populate its configuration</span>
<span class="n">axiCrossbar</span><span class="p">.</span><span class="n">build</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>First you need to populate slaves interfaces :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//          Slave  -&gt; (base address,  size) ,</span>

<span class="n">axiCrossbar</span><span class="p">.</span><span class="n">addSlaves</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00000000</span><span class="nc">L</span><span class="p">,</span><span class="w">   </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x40000000</span><span class="nc">L</span><span class="p">,</span><span class="w">  </span><span class="mi">64</span><span class="w"> </span><span class="nc">MiB</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">apbBridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0xF0000000</span><span class="nc">L</span><span class="p">,</span><span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="nc">MiB</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then you need to populate a matrix of interconnections between slaves and masters (this sets up visibility) :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//         Master -&gt; List of slaves which are accessible</span>

<span class="n">axiCrossbar</span><span class="p">.</span><span class="n">addConnections</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">i</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,</span><span class="w"> </span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">d</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,</span><span class="w"> </span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,</span><span class="w"> </span><span class="n">apbBridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">jtagCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">ram</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,</span><span class="w"> </span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,</span><span class="w"> </span><span class="n">apbBridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">vgaCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w">            </span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then to reduce combinatorial path length and have a good design FMax, you can ask the factory to insert pipelining stages between itself a given master or slave :</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">halfPipe</span></code> / &gt;&gt; / &lt;&lt; / &gt;/-&gt;  in the following code are provided by the Stream bus library.</div>
<div class="line">Some documentation could be find <a class="reference internal" href="index.html#stream"><span class="std std-ref">there</span></a>. In short, it’s just some pipelining and interconnection stuff.</div>
</div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Pipeline the connection between the crossbar and the apbBridge.io.axi</span>
<span class="n">axiCrossbar</span><span class="p">.</span><span class="n">addPipelining</span><span class="p">(</span><span class="n">apbBridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,(</span><span class="n">crossbar</span><span class="p">,</span><span class="n">bridge</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">sharedCmd</span><span class="p">.</span><span class="n">halfPipe</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bridge</span><span class="p">.</span><span class="n">sharedCmd</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">writeData</span><span class="p">.</span><span class="n">halfPipe</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bridge</span><span class="p">.</span><span class="n">writeData</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">writeRsp</span><span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bridge</span><span class="p">.</span><span class="n">writeRsp</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">readRsp</span><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bridge</span><span class="p">.</span><span class="n">readRsp</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>

<span class="c1">// Pipeline the connection between the crossbar and the sdramCtrl.io.axi</span>
<span class="n">axiCrossbar</span><span class="p">.</span><span class="n">addPipelining</span><span class="p">(</span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">axi</span><span class="p">,(</span><span class="n">crossbar</span><span class="p">,</span><span class="n">ctrl</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">sharedCmd</span><span class="p">.</span><span class="n">halfPipe</span><span class="p">()</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w">  </span><span class="n">ctrl</span><span class="p">.</span><span class="n">sharedCmd</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">writeData</span><span class="w">            </span><span class="o">&gt;/-&gt;</span><span class="w"> </span><span class="n">ctrl</span><span class="p">.</span><span class="n">writeData</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">writeRsp</span><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">ctrl</span><span class="p">.</span><span class="n">writeRsp</span><span class="w"></span>
<span class="w">  </span><span class="n">crossbar</span><span class="p">.</span><span class="n">readRsp</span><span class="w">               </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">ctrl</span><span class="p">.</span><span class="n">readRsp</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="apb3-decoder">
<h6>APB3 decoder<a class="headerlink" href="#apb3-decoder" title="Permalink to this heading"></a></h6>
<p>The interconnection between the APB3 bridge and all peripherals is done via an APB3Decoder :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">apbDecoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Decoder</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apbBridge</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">slaves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">gpioACtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">gpioBCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x01000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x10000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">timerCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x20000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">vgaCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x30000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">debugBus</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0xF0000</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="misc">
<h5>Misc<a class="headerlink" href="#misc" title="Permalink to this heading"></a></h5>
<p>To connect all toplevel IO to components, the following code is required :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="p">.</span><span class="n">gpioA</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">axi</span><span class="p">.</span><span class="n">gpioACtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">gpio</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">gpioB</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">axi</span><span class="p">.</span><span class="n">gpioBCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">gpio</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="w">  </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">axi</span><span class="p">.</span><span class="n">jtagCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w">  </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">axi</span><span class="p">.</span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">uart</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">sdram</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">axi</span><span class="p">.</span><span class="n">sdramCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">sdram</span><span class="w"></span>
<span class="n">io</span><span class="p">.</span><span class="n">vga</span><span class="w">   </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">axi</span><span class="p">.</span><span class="n">vgaCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">vga</span><span class="w"></span>
</pre></div>
</div>
<p>And finally some connections between components are required like interrupts and core debug module resets</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">uartCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="w"></span>
<span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timerCtrl</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">interrupt</span><span class="w"></span>

<span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">debugResetIn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">resetCtrl</span><span class="p">.</span><span class="n">axiReset</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">debugResetOut</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">resetCtrl</span><span class="p">.</span><span class="n">coreResetUnbuffered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Legacy/pinsec/software"></span><section id="software">
<h4>Software<a class="headerlink" href="#software" title="Permalink to this heading"></a></h4>
<section id="riscv-tool-chain">
<h5>RISCV tool-chain<a class="headerlink" href="#riscv-tool-chain" title="Permalink to this heading"></a></h5>
<p>Binaries executed by the CPU can be defined in ASM/C/C++ and compiled by the GCC RISCV fork. Also, to load binaries and debug the CPU, an OpenOCD fork and RISCV GDB can be used.</p>
<div class="line-block">
<div class="line">RISCV tools : <a class="reference external" href="https://github.com/riscv/riscv-wiki/wiki/RISC-V-Software-Status">https://github.com/riscv/riscv-wiki/wiki/RISC-V-Software-Status</a></div>
<div class="line">OpenOCD fork : <a class="reference external" href="https://github.com/Dolu1990/openocd_riscv">https://github.com/Dolu1990/openocd_riscv</a></div>
<div class="line">Software examples : <a class="reference external" href="https://github.com/Dolu1990/pinsecSoftware">https://github.com/Dolu1990/pinsecSoftware</a></div>
</div>
</section>
<section id="openocd-gdb-eclipse-configuration">
<h5>OpenOCD/GDB/Eclipse  configuration<a class="headerlink" href="#openocd-gdb-eclipse-configuration" title="Permalink to this heading"></a></h5>
<p>About the OpenOCD fork, there is the configuration file that could be used to connect the Pinsec SoC : <a class="reference external" href="https://github.com/Dolu1990/openocd_riscv/blob/riscv_spinal/tcl/target/riscv_spinal.cfg">https://github.com/Dolu1990/openocd_riscv/blob/riscv_spinal/tcl/target/riscv_spinal.cfg</a></p>
<p>There is an example of arguments used to run the OpenOCD tool :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>openocd -f ../tcl/interface/ftdi/ft2232h_breakout.cfg -f ../tcl/target/riscv_spinal.cfg -d 3
</pre></div>
</div>
<p>To debug with eclipse, you will need the Zylin plugin and then create an “Zynlin embedded debug (native)”.</p>
<p>Initialize commands :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>target remote localhost:3333
monitor reset halt
load
</pre></div>
</div>
<p>Run commands :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>continue
</pre></div>
</div>
</section>
</section>
</div>
</section>
</div>
</section>
<span id="document-SpinalHDL/miscelenea/index"></span><section id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this heading"></a></h2>
<p>This section includes content that may be:</p>
<blockquote>
<div><ul class="simple">
<li><p>out-of-date</p></li>
<li><p>could be better curated</p></li>
<li><p>may contain duplicate information (better found elsewhere here or in another repo)</p></li>
<li><p>drafts of documentation and works in progress</p></li>
</ul>
</div></blockquote>
<p>So please consider the information in this section with caution and a best
effort on the author to provide documentation.</p>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/miscelenea/frequent_errors"></span><section id="frequent-errors">
<h3>Frequent Errors<a class="headerlink" href="#frequent-errors" title="Permalink to this heading"></a></h3>
<p>This page will talk about errors which could happen when people are using SpinalHDL.</p>
</section>
<section id="exception-in-thread-main-java-lang-nullpointerexception">
<h3>Exception in thread “main” java.lang.NullPointerException<a class="headerlink" href="#exception-in-thread-main-java-lang-nullpointerexception" title="Permalink to this heading"></a></h3>
<p><strong>Console symptoms :</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Exception in thread &quot;main&quot; java.lang.NullPointerException
</pre></div>
</div>
<p><strong>Code Example :</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">         </span><span class="c1">// b can&#39;t be read at that time, because b isn&#39;t instantiated yet</span>
<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Issue explanation :</strong></p>
<p>SpinalHDL is not a language, it is an Scala library, which mean, it obey to the same rules than the Scala general purpose programming language. When you run your SpinalHDL hardware description to generate the corresponding VHDL/Verilog RTL, your SpinalHDL hardware description will be executed as a Scala programm, and b will be a <code class="docutils literal notranslate"><span class="pre">null</span></code> reference until the programm execution come to that line, and it’s why you can’t use it before.</p>
</section>
<section id="hierarchy-violation">
<h3>Hierarchy violation<a class="headerlink" href="#hierarchy-violation" title="Permalink to this heading"></a></h3>
<p>The SpinalHDL compiler check that all your assignments are legal from an hierarchy perspective. Multiple cases are elaborated in following chapters</p>
<section id="signal-x-can-t-be-assigned-by-y">
<h4>Signal X can’t be assigned by Y<a class="headerlink" href="#signal-x-can-t-be-assigned-by-y" title="Permalink to this heading"></a></h4>
<p><strong>Console symptoms :</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Hierarchy violation : Signal X can&#39;t be assigned by Y
</pre></div>
</div>
<p><strong>Code Example :</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ComponentX</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">ComponentY</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">componentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ComponentX</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">componentX</span><span class="p">.</span><span class="nc">X</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="c1">// This assignment is not legal</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ComponentX</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="c1">// Forgot to specify an in/out direction</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">ComponentY</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">componentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ComponentX</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">componentX</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="nc">X</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="c1">// This assignment will be detected as not legal</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Issue explanation :</strong></p>
<p>You can only assign input signals of subcomponents, else there is an hierarchy violation. If this issue happened, you probably forgot to specify the X signal’s direction.</p>
</section>
<section id="input-signal-x-can-t-be-assigned-by-y">
<h4>Input signal X can’t be assigned by Y<a class="headerlink" href="#input-signal-x-can-t-be-assigned-by-y" title="Permalink to this heading"></a></h4>
<p><strong>Console symptoms :</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Hierarchy violation : Input signal X can&#39;t be assigned by Y
</pre></div>
</div>
<p><strong>Code Example :</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ComponentXY</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="nc">X</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="c1">// This assignment is not legal</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Issue explanation :</strong></p>
<p>You can only assign an input signals from the parent component, else there is an hierarchy violation. If this issue happened, you probably mixed signals direction declaration.</p>
</section>
<section id="output-signal-x-can-t-be-assigned-by-y">
<h4>Output signal X can’t be assigned by Y<a class="headerlink" href="#output-signal-x-can-t-be-assigned-by-y" title="Permalink to this heading"></a></h4>
<p><strong>Console symptoms :</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Hierarchy violation : Output signal X can&#39;t be assigned by Y
</pre></div>
</div>
<p><strong>Code Example :</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ComponentX</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">ComponentY</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">componentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ComponentX</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">componentX</span><span class="p">.</span><span class="nc">X</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Y</span><span class="w"> </span><span class="c1">// This assignment is not legal</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Issue explanation :</strong></p>
<p>You can only assign output signals of a component from the inside of it, else there is an hierarchy violation. If this issue happened, you probably mixed signals direction declaration.</p>
</section>
</section>
<span id="document-SpinalHDL/miscelenea/core/core_components"></span><section id="the-spinal-core-components">
<h3>The <code class="docutils literal notranslate"><span class="pre">spinal.core</span></code> components<a class="headerlink" href="#the-spinal-core-components" title="Permalink to this heading"></a></h3>
<p>The core components of the language are described in this document. It is part of the general</p>
<p>The core language components are as follows:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#core-components-clock-domain-definition"><span class="std std-ref">*Clock domains*</span></a>, which allow to define and interoperate multiple clock domains within a design</p></li>
<li><p><em>Memory instantiation</em>, which permit the automatic instantiation of RAM and ROM memories.</p></li>
<li><p><em>IP instantiation</em>, using either existing VHDL or Verilog component.</p></li>
<li><p>Assignments</p></li>
<li><p>When / Switch</p></li>
<li><p>Component hierarchy</p></li>
<li><p>Area</p></li>
<li><p>Functions</p></li>
<li><p>Utility functions</p></li>
<li><p>VHDL generator</p></li>
</ul>
<section id="clock-domains-definitions">
<span id="core-components-clock-domain-definition"></span><h4>Clock domains definitions<a class="headerlink" href="#clock-domains-definitions" title="Permalink to this heading"></a></h4>
<p>In <em>Spinal</em>, clock and reset signals can be combined to create a <strong>clock domain</strong>. Clock domains could be applied to some area of the design and then all synchronous elements instantiated into this area will then <strong>implicitly</strong> use this clock domain.</p>
<p>Clock domain application work like a stack, which mean, if you are in a given clock domain, you can still apply another clock domain locally.</p>
<section id="clock-domain-syntax">
<span id="core-componets-clock-constructor"></span><h5>Clock domain syntax<a class="headerlink" href="#clock-domain-syntax" title="Permalink to this heading"></a></h5>
<p>The syntax to define a clock domain is as follows (using EBNF syntax):</p>
<p><code class="docutils literal notranslate"><span class="pre">ClockDomain(clock</span> <span class="pre">:</span> <span class="pre">Bool[,reset</span> <span class="pre">:</span> <span class="pre">Bool[,enable</span> <span class="pre">:</span> <span class="pre">Bool]]])</span></code></p>
<p>This definition takes three parameters:</p>
<ol class="arabic simple">
<li><p>The clock signal that defines the domain</p></li>
<li><p>An optional <code class="docutils literal notranslate"><span class="pre">reset</span></code>signal. If a register which need a reset and his clock domain didn’t provide one, an error message happen</p></li>
<li><p>An optional <code class="docutils literal notranslate"><span class="pre">enable</span></code> signal. The goal of this signal is to disable the clock on the whole clock domain without having to  manually implement that on each synchronous element.</p></li>
</ol>
<p>An applied example to define a specific clock domain within the design is as follows:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">coreClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="c1">// Define a new clock domain</span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">coreClock</span><span class="p">,</span><span class="n">coreReset</span><span class="p">)</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="c1">// Use this domain in an area of the design</span>
<span class="kd">val</span><span class="w"> </span><span class="n">coreArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">coreClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">coreClockedRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="clock-configuration">
<h5>Clock configuration<a class="headerlink" href="#clock-configuration" title="Permalink to this heading"></a></h5>
<p>In addition to the constructor parameters given <a class="reference internal" href="#core-componets-clock-constructor"><span class="std std-ref">here</span></a> , the following elements of each clock domain are configurable via a <code class="docutils literal notranslate"><span class="pre">ClockDomainConfig</span></code> class :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Valid values</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clockEdge</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">RISING</span></code>, <code class="docutils literal notranslate"><span class="pre">FALLING</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ResetKind</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ASYNC</span></code>, <code class="docutils literal notranslate"><span class="pre">SYNC</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">resetActiveHigh</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">clockEnableActiveHigh</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomClockExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">resetn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myClockDomainConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomainConfig</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clockEdge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RISING</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resetKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ASYNC</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">resetActiveLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LOW</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">,</span><span class="n">io</span><span class="p">.</span><span class="n">resetn</span><span class="p">,</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myClockDomainConfig</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">myClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">myReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>By default, a ClockDomain is applied to the whole design. The configuration of this one is :</p>
<ul class="simple">
<li><p>clock : rising edge</p></li>
<li><p>reset: asynchronous, active high</p></li>
<li><p>no enable signal</p></li>
</ul>
</section>
<section id="external-clock">
<h5>External clock<a class="headerlink" href="#external-clock" title="Permalink to this heading"></a></h5>
<p>You can define everywhere a clock domain which is driven by the outside. It will then automatically add clock and reset signal from the top level inputs to all synchronous elements.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExternalClockExample</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;myClockName&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">myArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">myClockDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">myReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myReg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cross-clock-domain">
<h5>Cross Clock Domain<a class="headerlink" href="#cross-clock-domain" title="Permalink to this heading"></a></h5>
<p>SpinalHDL checks at compile time that there is no unwanted/unspecified cross clock domain signal reads. If you want to read a signal that is emitted by another <code class="docutils literal notranslate"><span class="pre">ClockDomain</span></code> area, you should add the <code class="docutils literal notranslate"><span class="pre">crossClockDomain</span></code> tag to the destination signal as depicted in the following example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">asynchronousSignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">buffer0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)).</span><span class="n">addTag</span><span class="p">(</span><span class="n">crossClockDomain</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">buffer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">buffer0</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">asynchronousSignal</span><span class="w"></span>
<span class="n">buffer1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">buffer0</span><span class="w">   </span><span class="c1">// Second register stage to be avoid metastability issues</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Or in less lines:</span>
<span class="kd">val</span><span class="w"> </span><span class="n">buffer0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">asynchronousSignal</span><span class="p">).</span><span class="n">addTag</span><span class="p">(</span><span class="n">crossClockDomain</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">buffer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">buffer0</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="assignments">
<h4>Assignments<a class="headerlink" href="#assignments" title="Permalink to this heading"></a></h4>
<p>There are multiple assignment operator :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Symbol</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>:=</p></td>
<td><div class="line-block">
<div class="line">Standard assignment, equivalent to ‘&lt;=’ in VHDL/Verilog</div>
<div class="line">last assignment win, value updated at next delta cycle</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>/=</p></td>
<td><div class="line-block">
<div class="line">Equivalent to := in VHDL and = in Verilog</div>
<div class="line">value updated instantly</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>&lt;&gt;</p></td>
<td><div class="line-block">
<div class="line">Automatic connection between 2 signals. Direction is inferred by using signal direction (in/out)</div>
<div class="line">Similar behavioral than :=</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Because of hardware concurrency is always read with the value &#39;1&#39; by b and c</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// a := 1 win</span>
<span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>

<span class="kd">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">x</span><span class="w">      </span><span class="c1">// y read x with the value 0</span>
<span class="n">x</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">z</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">x</span><span class="w">      </span><span class="c1">// z read x with the value 1</span>
</pre></div>
</div>
<p>SpinalHDL check that bitcount of left and right assignment side match. There is multiple ways to adapt bitcount of BitVector (Bits, UInt, SInt) :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Resizing ways</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x := y.resized</p></td>
<td><p>Assign x wit a resized copy of y, resize value is automatically inferred to match x</p></td>
</tr>
<tr class="row-odd"><td><p>x := y.resize(newWidth)</p></td>
<td><p>Assign x with a resized copy of y, size is manually calculated</p></td>
</tr>
</tbody>
</table>
<p>There are 2 cases where spinal automatically resize things :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 33%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Problem</p></th>
<th class="head"><p>SpinalHDL action</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>myUIntOf_8bit := U(3)</p></td>
<td><p>U(3) create an UInt of 2 bits, which don’t match with left side</p></td>
<td><p>Because  U(3) is a “weak” bit inferred signal, SpinalHDL resize it automatically</p></td>
</tr>
<tr class="row-odd"><td><p>myUIntOf_8bit := U(2 -&gt; False default -&gt; true)</p></td>
<td><p>The right part infer a 3 bit UInt, which doesn’t match with the left part</p></td>
<td><p>SpinalHDL reapply the default value to bit that are missing</p></td>
</tr>
</tbody>
</table>
</section>
<section id="when-switch">
<h4>When / Switch<a class="headerlink" href="#when-switch" title="Permalink to this heading"></a></h4>
<p>As VHDL and Verilog, signals and registers can be conditionally assigned by using when and switch syntaxes</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">when</span><span class="p">(</span><span class="n">cond1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// execute when      cond1 is true</span>
<span class="p">}.</span><span class="n">elsewhen</span><span class="p">(</span><span class="n">cond2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// execute when (not cond1) and cond2</span>
<span class="p">}.</span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// execute when (not cond1) and (not cond2)</span>
<span class="p">}</span><span class="w"></span>

<span class="n">switch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// execute when x === value1</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// execute when x === value2</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// execute if none of precedent condition meet</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can also define new signals into a when/switch statement. It’s useful if you want to calculate an intermediate value.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">toto</span><span class="p">,</span><span class="n">titi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">toto</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="w">  </span><span class="n">titi</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">toto</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">titi</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="component-hierarchy">
<h4>Component/Hierarchy<a class="headerlink" href="#component-hierarchy" title="Permalink to this heading"></a></h4>
<p>Like in VHDL and Verilog, you can define components that could be used to build a design hierarchy.  But unlike them, you don’t need to bind them at instantiation.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdderCell</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Declaring all in/out in an io Bundle is probably a good practice</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">cin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="n">cout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Do some logic</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">cout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">Adder</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Create 2 AdderCell</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cell0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AdderCell</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cell1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AdderCell</span><span class="w"></span>
<span class="w">  </span><span class="n">cell1</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">cin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cell0</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">cout</span><span class="w"> </span><span class="c1">// Connect carrys</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">cellArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">width</span><span class="p">)(</span><span class="k">new</span><span class="w"> </span><span class="nc">AdderCell</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Syntax to define in/out is the following :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 50%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>in/out(x : Data)</p></td>
<td><p>Set x an input/output</p></td>
<td><p>x</p></td>
</tr>
<tr class="row-odd"><td><p>in/out Bool()</p></td>
<td><p>Create an input/output Bool</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>in/out Bits/UInt/SInt(x bits)</p></td>
<td><p>Create an input/output of the corresponding type</p></td>
<td><p>T</p></td>
</tr>
</tbody>
</table>
<p>There is some rules about component interconnection :</p>
<ul class="simple">
<li><p>Components can only read outputs/inputs signals of children components</p></li>
<li><p>Components can read outputs/inputs ports values</p></li>
<li><p>If for some reason, you need to read a signals from far away in the hierarchy (debug, temporal patch) you can do it by using the value returned by some.where.else.theSignal.pull().</p></li>
</ul>
</section>
<section id="area">
<h4>Area<a class="headerlink" href="#area" title="Permalink to this heading"></a></h4>
<p>Sometime, creating a component to define some logic is overkill and to much verbose. For this kind of cases you can use Area :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UartCtrl</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tickCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">          </span><span class="c1">// Refer to the tick from timer area</span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">stateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="function">
<h4>Function<a class="headerlink" href="#function" title="Permalink to this heading"></a></h4>
<p>The ways you can use Scala functions to generate hardware are radically different than VHDL/Verilog for many reasons:</p>
<ul>
<li><p>You can instantiate register, combinatorial logic and component inside them.</p></li>
<li><p>You don’t have to play with <code class="docutils literal notranslate"><span class="pre">process</span></code>/<code class="docutils literal notranslate"><span class="pre">&#64;always</span></code> that limit the scope of assignment of signals</p></li>
<li><div class="line-block">
<div class="line">Everything work by reference, which allow many manipulation.</div>
<div class="line">For example you can give to a function an bus as argument, then the function can internally read/write it.</div>
<div class="line">You can also return a Component, a Bus, are anything else from scala the scala world.</div>
</div>
</li>
</ul>
<section id="rgb-to-gray">
<h5>RGB to gray<a class="headerlink" href="#rgb-to-gray" title="Permalink to this heading"></a></h5>
<p>For example if you want to convert a Red/Green/Blue color into a gray one by using coefficient, you can use functions to apply them :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Input RGB color</span>
<span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Define a function to multiply a UInt by a scala Float value.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">coef</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">,</span><span class="n">by</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">U</span><span class="p">((</span><span class="mi">255</span><span class="o">*</span><span class="n">by</span><span class="p">).</span><span class="n">toInt</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Calculate the gray level</span>
<span class="kd">val</span><span class="w"> </span><span class="n">gray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mf">0.3f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">           </span><span class="n">coef</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="mf">0.4f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">           </span><span class="n">coef</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mf">0.3f</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="valid-ready-payload-bus">
<h5>Valid Ready Payload bus<a class="headerlink" href="#valid-ready-payload-bus" title="Permalink to this heading"></a></h5>
<p>For instance if you define a simple Valid Ready Payload bus, you can then define useful function inside it.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyBus</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">:</span><span class="w">  </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">payloadWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// connect that to this</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">&lt;&lt;</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">MyBus</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">ready</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Connect this to the FIFO input, return the fifo output</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">queue</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">MyBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">fifo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Fifo</span><span class="p">(</span><span class="n">payloadWidth</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">push</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="bp">this</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fifo</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">pop</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="vhdl-generation">
<h4>VHDL generation<a class="headerlink" href="#vhdl-generation" title="Permalink to this heading"></a></h4>
<p>There is a small component and a <code class="docutils literal notranslate"><span class="pre">main</span></code> that generate the corresponding VHDL.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// spinal.core contain all basics (Bool, UInt, Bundle, Reg, Component, ..)</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// A simple component definition</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Define some input/output. Bundle like a VHDL record or a verilog struct.</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Define some asynchronous logic</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// This is the main of the project. It create a instance of MyTopLevel and</span>
<span class="c1">// call the SpinalHDL library to flush it into a VHDL file.</span>
<span class="k">object</span><span class="w"> </span><span class="nc">MyMain</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="instantiate-vhdl-and-verilog-ip">
<h4>Instantiate VHDL and Verilog IP<a class="headerlink" href="#instantiate-vhdl-and-verilog-ip" title="Permalink to this heading"></a></h4>
<blockquote>
<div><p>In some cases, it could be useful to instantiate a VHDL or a Verilog component into a SpinalHDL design. To do that, you need to define BlackBox which is like a Component, but its internal implementation should be provided by a separate VHDL/Verilog file to the simulator/synthesis tool.</p>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Ram_1w_1r</span><span class="p">(</span><span class="n">_wordWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">_wordCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Generic</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wordCount</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wordWidth</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">_wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="n">_wordWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">_wordCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="n">_wordWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">mapClockDomain</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">io</span><span class="p">.</span><span class="n">clk</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="utils">
<h4>Utils<a class="headerlink" href="#utils" title="Permalink to this heading"></a></h4>
<p>The SpinalHDL core contain some utils :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 63%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>log2Up(x : BigInt)</p></td>
<td><p>Return the number of bit needed to represent x states</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-odd"><td><p>isPow2(x : BigInt)</p></td>
<td><p>Return true if x is a power of two</p></td>
<td><p>Boolean</p></td>
</tr>
</tbody>
</table>
<p>Much more tool and utils are present in spinal.lib</p>
</section>
</section>
<span id="document-SpinalHDL/miscelenea/core/elements"></span><section id="element">
<span id="id1"></span><h3>Element<a class="headerlink" href="#element" title="Permalink to this heading"></a></h3>
<p>Elements could be defined as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x : Int -&gt; y : Boolean/Bool</p></td>
<td><p>Set bit x with y</p></td>
</tr>
<tr class="row-odd"><td><p>x : Range -&gt; y : Boolean/Bool</p></td>
<td><p>Set each bits in range x with y</p></td>
</tr>
<tr class="row-even"><td><p>x : Range -&gt; y : T</p></td>
<td><p>Set bits in range x with y</p></td>
</tr>
<tr class="row-odd"><td><p>x : Range -&gt; y : String</p></td>
<td><div class="line-block">
<div class="line">Set bits in range x with y</div>
<div class="line">The string format follow same rules than B”xyz” one</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>default -&gt; y : Boolean/Bool</p></td>
<td><div class="line-block">
<div class="line">Set all unconnected bits with the y value.</div>
<div class="line">This feature could only be use to do assignments without the B prefix or with the B prefix combined with the bits specification</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="range">
<span id="id2"></span><h3>Range<a class="headerlink" href="#range" title="Permalink to this heading"></a></h3>
<p>You can define a Range values</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Range syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Width</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(x downto y)</p></td>
<td><p>[x:y], x &gt;= y</p></td>
<td><p>x-y+1</p></td>
</tr>
<tr class="row-odd"><td><p>(x to y)</p></td>
<td><p>[x:y], x &lt;= y</p></td>
<td><p>y-x+1</p></td>
</tr>
<tr class="row-even"><td><p>(x until y)</p></td>
<td><p>[x:y[, x &lt; y</p></td>
<td><p>y-x</p></td>
</tr>
</tbody>
</table>
</section>
</div>
</section>
<span id="document-SpinalHDL/Developers area/index"></span><section id="developers-area">
<h2>Developers area<a class="headerlink" href="#developers-area" title="Permalink to this heading"></a></h2>
<div class="toctree-wrapper compound">
<span id="document-SpinalHDL/Developers area/bus_slave_factory_impl"></span><section id="bus-slave-factory-implementation">
<span id="id1"></span><h3>Bus Slave Factory Implementation<a class="headerlink" href="#bus-slave-factory-implementation" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>This page will document the implementation of the BusSlaveFactory tool and one of those variant. You can get more information about the functionality of that tool <a class="reference internal" href="index.html#bus-slave-factory"><span class="std std-ref">here</span></a>.</p>
</section>
<section id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this heading"></a></h4>
<p>The class diagram is the following :</p>
<img alt="_images/bus_slave_factory_classes.svg" class="align-center" src="_images/bus_slave_factory_classes.svg" /><p>The <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> abstract class define minimum requirements that each implementation of it should provide :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>busDataWidth</p></td>
<td><p>Return the data width of the bus</p></td>
</tr>
<tr class="row-odd"><td><p>read(that,address,bitOffset)</p></td>
<td><p>When the bus read the <code class="docutils literal notranslate"><span class="pre">address</span></code>, fill the response with <code class="docutils literal notranslate"><span class="pre">that</span></code> at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code></p></td>
</tr>
<tr class="row-even"><td><p>write(that,address,bitOffset)</p></td>
<td><p>When the bus write the <code class="docutils literal notranslate"><span class="pre">address</span></code>, assign <code class="docutils literal notranslate"><span class="pre">that</span></code> with bus’s data from <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>onWrite(address)(doThat)</p></td>
<td><p>Call <code class="docutils literal notranslate"><span class="pre">doThat</span></code> when a write transaction occur on <code class="docutils literal notranslate"><span class="pre">address</span></code></p></td>
</tr>
<tr class="row-even"><td><p>onRead(address)(doThat)</p></td>
<td><p>Call <code class="docutils literal notranslate"><span class="pre">doThat</span></code> when a read transaction occur on <code class="docutils literal notranslate"><span class="pre">address</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>nonStopWrite(that,bitOffset)</p></td>
<td><p>Permanently assign <code class="docutils literal notranslate"><span class="pre">that</span></code> by the bus write data from <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code></p></td>
</tr>
</tbody>
</table>
<p>By using them the <code class="docutils literal notranslate"><span class="pre">BusSlaveFactory</span></code> should also be able to provide many utilities :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 8%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Return</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>readAndWrite(that,address,bitOffset)</p></td>
<td></td>
<td><p>Make <code class="docutils literal notranslate"><span class="pre">that</span></code> readable and writable at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><p>readMultiWord(that,address)</p></td>
<td></td>
<td><div class="line-block">
<div class="line">Create the memory mapping to read <code class="docutils literal notranslate"><span class="pre">that</span></code> from ‘address’. :</div>
<div class="line">If <code class="docutils literal notranslate"><span class="pre">that</span></code> is bigger than one word it extends the register on followings addresses</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>writeMultiWord(that,address)</p></td>
<td></td>
<td><div class="line-block">
<div class="line">Create the memory mapping to write <code class="docutils literal notranslate"><span class="pre">that</span></code> at ‘address’. :</div>
<div class="line">If <code class="docutils literal notranslate"><span class="pre">that</span></code> is bigger than one word it extends the register on followings addresses</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>createWriteOnly(dataType,address,bitOffset)</p></td>
<td><p>T</p></td>
<td><p>Create a write only register of type <code class="docutils literal notranslate"><span class="pre">dataType</span></code> at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-even"><td><p>createReadWrite(dataType,address,bitOffset)</p></td>
<td><p>T</p></td>
<td><p>Create a read write register of type <code class="docutils literal notranslate"><span class="pre">dataType</span></code> at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><p>createAndDriveFlow(dataType,address,bitOffset)</p></td>
<td><p>Flow[T]</p></td>
<td><p>Create a writable Flow register of type <code class="docutils literal notranslate"><span class="pre">dataType</span></code> at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-even"><td><p>drive(that,address,bitOffset)</p></td>
<td></td>
<td><p>Drive <code class="docutils literal notranslate"><span class="pre">that</span></code> with a register writable at <code class="docutils literal notranslate"><span class="pre">address</span></code> placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><p>driveAndRead(that,address,bitOffset)</p></td>
<td></td>
<td><p>Drive <code class="docutils literal notranslate"><span class="pre">that</span></code> with a register writable and readable at <code class="docutils literal notranslate"><span class="pre">address</span></code> placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-even"><td><p>driveFlow(that,address,bitOffset)</p></td>
<td></td>
<td><p>Emit on <code class="docutils literal notranslate"><span class="pre">that</span></code> a transaction when a write happen at <code class="docutils literal notranslate"><span class="pre">address</span></code> by using data placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">readStreamNonBlocking(that,address,</div>
<div class="line">validBitOffset,payloadBitOffset)</div>
</div>
</td>
<td></td>
<td><div class="line-block">
<div class="line">Read <code class="docutils literal notranslate"><span class="pre">that</span></code> and consume the transaction when a read happen at <code class="docutils literal notranslate"><span class="pre">address</span></code>.</div>
<div class="line">valid &lt;= validBitOffset bit</div>
<div class="line">payload &lt;= payloadBitOffset+widthOf(payload) downto <code class="docutils literal notranslate"><span class="pre">payloadBitOffset</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">doBitsAccumulationAndClearOnRead</div>
<div class="line">(that,address,bitOffset)</div>
</div>
</td>
<td></td>
<td><div class="line-block">
<div class="line">Instantiate an internal register which at each cycle do :</div>
<div class="line">reg := reg | that</div>
<div class="line">Then when a read occur, the register is cleared. This register is readable at <code class="docutils literal notranslate"><span class="pre">address</span></code> and placed at <code class="docutils literal notranslate"><span class="pre">bitOffset</span></code> in the word</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>About <code class="docutils literal notranslate"><span class="pre">BusSlaveFactoryDelayed</span></code>, it’s still an abstract class, but it capture each primitives (BusSlaveFactoryElement) calls into a data-model. This datamodel is one list that contain all primitives, but also a HashMap that link each address used to a list of primitives that are using it. Then when they all are collected (at the end of the current component), it do a callback that should be implemented by classes that extends it. The implementation of this callback should implement the hardware corresponding to all primitives collected.</p>
</section>
<section id="implementation">
<h4>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h4>
<section id="busslavefactory">
<h5>BusSlaveFactory<a class="headerlink" href="#busslavefactory" title="Permalink to this heading"></a></h5>
<p>Let’s describe primitives abstract function :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">BusSlaveFactory</span><span class="w">  </span><span class="k">extends</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">busDataWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">onWrite</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)(</span><span class="n">doThat</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">onRead</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)(</span><span class="n">doThat</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">nonStopWrite</span><span class="p">(</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then let’s operate the magic to implement all utile based on them :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">BusSlaveFactory</span><span class="w">  </span><span class="k">extends</span><span class="w"> </span><span class="nc">Are</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">readAndWrite</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">that</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">that</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">drive</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">that</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">driveAndRead</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">that</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">driveFlow</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Flow</span><span class="p">[</span><span class="nc">T</span><span class="p">],</span><span class="w"></span>
<span class="w">                           </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">onWrite</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">that</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">nonStopWrite</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">createReadWrite</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">):</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">reg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">createAndDriveFlow</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">dataType</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Flow</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Flow</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">driveFlow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">flow</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">doBitsAccumulationAndClearOnRead</span><span class="p">(</span><span class="w">   </span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">getWidth</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">busDataWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="n">that</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">reg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">that</span><span class="w"></span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">onRead</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">reg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">that</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">readStreamNonBlocking</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">T</span><span class="p">],</span><span class="w"></span>
<span class="w">                                        </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">validBitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">payloadBitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">that</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">    </span><span class="n">onRead</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">that</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">valid</span><span class="w">  </span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">validBitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">payloadBitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">readMultiWord</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">widthOf</span><span class="p">(</span><span class="n">that</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">busDataWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">valueBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">asBits</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">wordCount</span><span class="o">*</span><span class="n">busDataWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">wordCount</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">valueBits</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">busDataWidth</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">busDataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">wordId</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">wordCount</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">read</span><span class="p">(</span><span class="n">words</span><span class="p">(</span><span class="n">wordId</span><span class="p">),</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wordId</span><span class="o">*</span><span class="n">busDataWidth</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">writeMultiWord</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">widthOf</span><span class="p">(</span><span class="n">that</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">busDataWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">wordId</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">wordCount</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">write</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">that</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DataWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getBitsWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="nc">Math</span><span class="p">.</span><span class="n">min</span><span class="p">(</span><span class="n">busDataWidth</span><span class="p">,</span><span class="w"> </span><span class="n">widthOf</span><span class="p">(</span><span class="n">that</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wordId</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">busDataWidth</span><span class="p">)</span><span class="w"></span>

<span class="w">          </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">assignFromBits</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bits</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">that</span><span class="p">.</span><span class="n">assignFromBits</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">bits</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">resized</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">offset</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">wordId</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">busDataWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">bitCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getBitsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wordId</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">busDataWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="busslavefactorydelayed">
<h5>BusSlaveFactoryDelayed<a class="headerlink" href="#busslavefactorydelayed" title="Permalink to this heading"></a></h5>
<p>Let’s implement classes that will be used to store primitives :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="w"></span>

<span class="c1">// Ask to make `that` readable when a access is done on `address`.</span>
<span class="c1">// bitOffset specify where `that` is placed on the answer</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BusSlaveFactoryRead</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="w"></span>

<span class="c1">// Ask to make `that` writable when a access is done on `address`.</span>
<span class="c1">// bitOffset specify where `that` get bits from the request</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BusSlaveFactoryWrite</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="w"></span>

<span class="c1">// Ask to execute `doThat` when a write access is done on `address`</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BusSlaveFactoryOnWrite</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">doThat</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="w"></span>

<span class="c1">// Ask to execute `doThat` when a read access is done on `address`</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BusSlaveFactoryOnRead</span><span class="p">(</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">doThat</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="w"></span>

<span class="c1">// Ask to constantly drive `that` with the data bus</span>
<span class="c1">// bitOffset specify where `that` get bits from the request</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BusSlaveFactoryNonStopWrite</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="w"></span>
</pre></div>
</div>
<p>Then let’s implement the <code class="docutils literal notranslate"><span class="pre">BusSlaveFactoryDelayed</span></code> itself :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">BusSlaveFactoryDelayed</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactory</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// elements is an array of all BusSlaveFactoryElement requested</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="nc">BusSlaveFactoryElement</span><span class="p">]()</span><span class="w"></span>


<span class="w">  </span><span class="c1">// elementsPerAddress is more structured than elements, it group all BusSlaveFactoryElement per requested addresses</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">elementsPerAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collection</span><span class="p">.</span><span class="n">mutable</span><span class="p">.</span><span class="nc">HashMap</span><span class="p">[</span><span class="nc">BigInt</span><span class="p">,</span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="nc">BusSlaveFactoryElement</span><span class="p">]]()</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">addAddressableElement</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactoryElement</span><span class="p">,</span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">elements</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">e</span><span class="w"></span>
<span class="w">    </span><span class="n">elementsPerAddress</span><span class="p">.</span><span class="n">getOrElseUpdate</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="nc">BusSlaveFactoryElement</span><span class="p">]())</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">e</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">bitOffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">busDataWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">addAddressableElement</span><span class="p">(</span><span class="nc">BusSlaveFactoryRead</span><span class="p">(</span><span class="n">that</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">),</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">bitOffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">busDataWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">addAddressableElement</span><span class="p">(</span><span class="nc">BusSlaveFactoryWrite</span><span class="p">(</span><span class="n">that</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">),</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">onWrite</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)(</span><span class="n">doThat</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">addAddressableElement</span><span class="p">(</span><span class="nc">BusSlaveFactoryOnWrite</span><span class="p">(</span><span class="n">address</span><span class="p">,()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doThat</span><span class="p">),</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">onRead</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BigInt</span><span class="p">)(</span><span class="n">doThat</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">addAddressableElement</span><span class="p">(</span><span class="nc">BusSlaveFactoryOnRead</span><span class="p">(</span><span class="n">address</span><span class="p">,()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doThat</span><span class="p">),</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">nonStopWrite</span><span class="p">(</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Data</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">bitOffset</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">bitOffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">busDataWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">elements</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nc">BusSlaveFactoryNonStopWrite</span><span class="p">(</span><span class="n">that</span><span class="p">,</span><span class="n">bitOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// This is the only thing that should be implement by class that extends BusSlaveFactoryDelayed</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"></span>

<span class="w">  </span><span class="n">component</span><span class="p">.</span><span class="n">addPrePopTask</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">build</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="avalonmmslavefactory">
<h5>AvalonMMSlaveFactory<a class="headerlink" href="#avalonmmslavefactory" title="Permalink to this heading"></a></h5>
<p>First let’s implement the companion object that provide the compatible AvalonMM configuration object that correspond to the following table :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Pin name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>read</p></td>
<td><p>Bool</p></td>
<td><p>High one cycle to produce a read request</p></td>
</tr>
<tr class="row-odd"><td><p>write</p></td>
<td><p>Bool</p></td>
<td><p>High one cycle to produce a write request</p></td>
</tr>
<tr class="row-even"><td><p>address</p></td>
<td><p>UInt(addressWidth bits)</p></td>
<td><p>Byte granularity but word aligned</p></td>
</tr>
<tr class="row-odd"><td><p>writeData</p></td>
<td><p>Bits(dataWidth bits)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>readDataValid</p></td>
<td><p>Bool</p></td>
<td><p>High to respond a read command</p></td>
</tr>
<tr class="row-odd"><td><p>readData</p></td>
<td><p>Bits(dataWidth bits)</p></td>
<td><p>Valid when readDataValid is high</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">AvalonMMSlaveFactory</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getAvalonConfig</span><span class="p">(</span><span class="w"> </span><span class="n">addressWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">dataWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">AvalonMMConfig</span><span class="p">.</span><span class="n">pipelined</span><span class="p">(</span><span class="w">   </span><span class="c1">// Create a simple pipelined configuration of the Avalon Bus</span>
<span class="w">      </span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addressWidth</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataWidth</span><span class="w"></span>
<span class="w">    </span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="w">                     </span><span class="c1">// Change some parameters of the configuration</span>
<span class="w">      </span><span class="n">useByteEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">useWaitRequestn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">bus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">AvalonMM</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AvalonMMSlaveFactory</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then, let’s implement the AvalonMMSlaveFactory itself.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AvalonMMSlaveFactory</span><span class="p">(</span><span class="n">bus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">AvalonMM</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BusSlaveFactoryDelayed</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nc">AvalonMMSlaveFactory</span><span class="p">.</span><span class="n">getAvalonConfig</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">addressWidth</span><span class="p">,</span><span class="n">bus</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">dataWidth</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">readAtCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Flow</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">readAtRsp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readAtCmd</span><span class="p">.</span><span class="n">stage</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="n">bus</span><span class="p">.</span><span class="n">readDataValid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">readAtRsp</span><span class="p">.</span><span class="n">valid</span><span class="w"></span>
<span class="w">  </span><span class="n">bus</span><span class="p">.</span><span class="n">readData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">readAtRsp</span><span class="p">.</span><span class="n">payload</span><span class="w"></span>

<span class="w">  </span><span class="n">readAtCmd</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">bus</span><span class="p">.</span><span class="n">read</span><span class="w"></span>
<span class="w">  </span><span class="n">readAtCmd</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">element</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactoryNonStopWrite</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">element</span><span class="p">.</span><span class="n">that</span><span class="p">.</span><span class="n">assignFromBits</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">bitOffset</span><span class="p">,</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">that</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="p">((</span><span class="n">address</span><span class="p">,</span><span class="n">jobs</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">elementsPerAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">when</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">write</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="n">element</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">jobs</span><span class="p">)</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactoryWrite</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">element</span><span class="p">.</span><span class="n">that</span><span class="p">.</span><span class="n">assignFromBits</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">bitOffset</span><span class="p">,</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">that</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactoryOnWrite</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">doThat</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">read</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="n">element</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">jobs</span><span class="p">)</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactoryRead</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">readAtCmd</span><span class="p">.</span><span class="n">payload</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">bitOffset</span><span class="p">,</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">that</span><span class="p">.</span><span class="n">getBitsWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">that</span><span class="p">.</span><span class="n">asBits</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">BusSlaveFactoryOnRead</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">doThat</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">busDataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bus</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading"></a></h4>
<p>That’s all, you can check one example that use this <code class="docutils literal notranslate"><span class="pre">Apb3SlaveFactory</span></code> to create an Apb3UartCtrl <a class="reference internal" href="index.html#memory-mapped-uart"><span class="std std-ref">here</span></a>.</p>
<p>If you want to add the support of a new memory bus, it’s very simple you just need to implement another variation of the <code class="docutils literal notranslate"><span class="pre">BusSlaveFactoryDelayed</span></code> trait. The <code class="docutils literal notranslate"><span class="pre">Apb3SlaveFactory</span></code> is probably a good starting point :D</p>
</section>
</section>
<span id="document-SpinalHDL/Developers area/howotuselocalspinalclone"></span><section id="how-to-use-a-local-spinalhdl-clone-as-project-dependency">
<h3>How to use a local SpinalHDL clone as project dependency<a class="headerlink" href="#how-to-use-a-local-spinalhdl-clone-as-project-dependency" title="Permalink to this heading"></a></h3>
<p>The default way to use SpinalHDL is by using the released version of it as is
automatically downloaded by sbt or mill. Living on the cutting edge, you might
want to use the upstream and non released <code class="docutils literal notranslate"><span class="pre">dev</span></code> branch from git directly. Be
it just because you want to use a new shiny feature or because you want to test
your own extension to Spinal (please consider upstreaming it by opening a PR)
within a project.</p>
<p>As an example of where this is used you can also refer to <a class="reference external" href="https://github.com/SpinalHDL/VexiiRiscv/blob/dev/build.sbt">VexiiRiscv</a>.</p>
<section id="create-local-git-clone-of-spinalhdl">
<h4>Create local git clone of SpinalHDL<a class="headerlink" href="#create-local-git-clone-of-spinalhdl" title="Permalink to this heading"></a></h4>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /somewhere
git clone --depth <span class="m">1</span> -b dev https://github.com/SpinalHDL/SpinalHDL.git
</pre></div>
</div>
<p>In the command above you can replace <code class="docutils literal notranslate"><span class="pre">dev</span></code> by the name of the branch you want
to checkout. <code class="docutils literal notranslate"><span class="pre">--depth</span> <span class="pre">1</span></code> prevents from downloading the repository history.</p>
</section>
<section id="configure-buildsystem">
<h4>Configure buildsystem<a class="headerlink" href="#configure-buildsystem" title="Permalink to this heading"></a></h4>
<p>Depending on which tool you use, instruct either sbt or mill to load the local
git folder as dependency:</p>
<section id="configure-sbt-update-build-sbt">
<h5>Configure sbt (update <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>)<a class="headerlink" href="#configure-sbt-update-build-sbt" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="w">              </span><span class="c1">// change as needed</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalaVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;2.12.18&quot;</span><span class="w">     </span><span class="c1">// change as needed</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organization</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;org.example&quot;</span><span class="w"> </span><span class="c1">// change as needed</span>

<span class="kd">val</span><span class="w"> </span><span class="n">spinalRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;/somewhere/SpinalHDL&quot;</span><span class="p">)</span><span class="w"></span>
<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">spinalIdslPlugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ProjectRef</span><span class="p">(</span><span class="n">spinalRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;idslplugin&quot;</span><span class="p">)</span><span class="w"></span>
<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">spinalSim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ProjectRef</span><span class="p">(</span><span class="n">spinalRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sim&quot;</span><span class="p">)</span><span class="w"></span>
<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">spinalCore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ProjectRef</span><span class="p">(</span><span class="n">spinalRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;core&quot;</span><span class="p">)</span><span class="w"></span>
<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">spinalLib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ProjectRef</span><span class="p">(</span><span class="n">spinalRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lib&quot;</span><span class="p">)</span><span class="w"></span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">projectname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">project</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span><span class="w"></span>
<span class="p">.</span><span class="n">settings</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalaSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">baseDirectory</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s">&quot;hw&quot;</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s">&quot;spinal&quot;</span><span class="p">,</span><span class="w"></span>
<span class="p">).</span><span class="n">dependsOn</span><span class="p">(</span><span class="n">spinalIdslPlugin</span><span class="p">,</span><span class="w"> </span><span class="n">spinalSim</span><span class="p">,</span><span class="w"> </span><span class="n">spinalCore</span><span class="p">,</span><span class="w"> </span><span class="n">spinalLib</span><span class="p">)</span><span class="w"></span>

<span class="n">scalacOptions</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">spinalIdslPlugin</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">packageBin</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">artifactPath</span><span class="p">).</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="s">s&quot;-Xplugin:</span><span class="si">${</span><span class="n">file</span><span class="p">.</span><span class="n">getAbsolutePath</span><span class="si">}</span><span class="s">&quot;</span><span class="w"></span>
<span class="p">}.</span><span class="n">value</span><span class="w"></span>

<span class="n">fork</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="configure-mill-update-build-sc">
<h5>Configure mill (update <code class="docutils literal notranslate"><span class="pre">build.sc</span></code>)<a class="headerlink" href="#configure-mill-update-build-sc" title="Permalink to this heading"></a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">mill</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scalalib</span><span class="p">.</span><span class="n">_</span>

<span class="k">import</span><span class="w"> </span><span class="nn">$file</span><span class="p">.</span><span class="nn">^</span><span class="p">.</span><span class="nc">SpinalHDL</span><span class="p">.</span><span class="n">build</span>
<span class="k">import</span><span class="w"> </span><span class="nn">^</span><span class="p">.</span><span class="nc">SpinalHDL</span><span class="p">.</span><span class="nn">build</span><span class="p">.{</span><span class="n">core</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">spinalCore</span><span class="p">}</span>
<span class="k">import</span><span class="w"> </span><span class="nn">^</span><span class="p">.</span><span class="nc">SpinalHDL</span><span class="p">.</span><span class="nn">build</span><span class="p">.{</span><span class="n">lib</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">spinalLib</span><span class="p">}</span>
<span class="k">import</span><span class="w"> </span><span class="nn">^</span><span class="p">.</span><span class="nc">SpinalHDL</span><span class="p">.</span><span class="nn">build</span><span class="p">.{</span><span class="n">idslplugin</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">spinalIdslplugin</span><span class="p">}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">spinalVers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1.10.2a&quot;</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">scalaVers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2.12.18&quot;</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">projectname</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">RootModule</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">SbtModule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">scalaVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scalaVers</span><span class="w"></span>
<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">T</span><span class="p">.</span><span class="n">sources</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="bp">this</span><span class="p">.</span><span class="n">millSourcePath</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s">&quot;hw&quot;</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s">&quot;spinal&quot;</span><span class="w"></span>
<span class="w">   </span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">idslplugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spinalIdslplugin</span><span class="p">(</span><span class="n">scalaVers</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">moduleDeps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">spinalCore</span><span class="p">(</span><span class="n">scalaVers</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">spinalLib</span><span class="p">(</span><span class="n">scalaVers</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">idslplugin</span><span class="w"></span>
<span class="w">   </span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">scalacOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">super</span><span class="p">.</span><span class="n">scalacOptions</span><span class="p">()</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">idslplugin</span><span class="p">.</span><span class="n">pluginOptions</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Note the line <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">$file.^.SpinalHDL.build</span></code>. It is using ammonite REPL
magic <code class="docutils literal notranslate"><span class="pre">$file</span></code> to look up the <code class="docutils literal notranslate"><span class="pre">build.sc</span></code> of SpinalHDL. (The <code class="docutils literal notranslate"><span class="pre">^</span></code> moves up
one directory from the current.) This is assuming the following directory
structure:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">somewhere</span><span class="w"></span>
<span class="o">|-</span><span class="nc">SpinalHDL</span><span class="w">   </span><span class="n">#</span><span class="w"> </span><span class="o">&lt;--</span><span class="w"> </span><span class="n">cloned</span><span class="w"> </span><span class="n">spinal</span><span class="w"> </span><span class="n">git</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="o">|-</span><span class="n">build</span><span class="p">.</span><span class="n">sc</span><span class="w"></span>
<span class="o">|-</span><span class="n">projectname</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="o">|-</span><span class="n">build</span><span class="p">.</span><span class="n">sc</span><span class="w">  </span><span class="n">#</span><span class="w"> </span><span class="o">&lt;--</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">mill</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">ran</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="done">
<h4>Done<a class="headerlink" href="#done" title="Permalink to this heading"></a></h4>
<p>Note the addition to <code class="docutils literal notranslate"><span class="pre">scalacOptions</span></code>. Without it, compiling any Spinal project
might produce countless <code class="docutils literal notranslate"><span class="pre">SCOPE</span> <span class="pre">VIOLATION</span></code> or <code class="docutils literal notranslate"><span class="pre">HIERARCHY</span> <span class="pre">VIOLATION</span></code> errors
because the <code class="docutils literal notranslate"><span class="pre">idslplugin</span></code> of spinal is not actually invoked.</p>
<p>After the changes, the next compilation of your project will take a considerable
amount of time (~2 minutes). This is only for the first compile. After this,
your project should compile as usual.</p>
</section>
</section>
<span id="document-SpinalHDL/Developers area/howtodocument"></span><section id="how-to-hack-this-documentation">
<h3>How to HACK this documentation<a class="headerlink" href="#how-to-hack-this-documentation" title="Permalink to this heading"></a></h3>
<p>If you want to add your page to this documentation you need to add
your source file in the appropriate section.
I opted to create a structure that resample the various section of the documentation,
this is not strictly necessary, but for clarity sake, highly encourage.</p>
<p>This documentation uses a recursive index tree: every folder have a special <code class="docutils literal notranslate"><span class="pre">index.rst</span></code> files
that tell sphinx which file, and in what order to put it in the documentation tree.</p>
<section id="title-convention">
<h4>Title convention<a class="headerlink" href="#title-convention" title="Permalink to this heading"></a></h4>
<p>Sphinx is very smart, the document structure is deduced from how you use
non alphanumerical characters (like:  <code class="docutils literal notranslate"><span class="pre">=</span> <span class="pre">-</span> <span class="pre">`</span> <span class="pre">:</span> <span class="pre">'</span> <span class="pre">&quot;</span> <span class="pre">~</span> <span class="pre">^</span> <span class="pre">_</span> <span class="pre">*</span> <span class="pre">+</span> <span class="pre">#</span> <span class="pre">&lt;</span> <span class="pre">&gt;</span></code>), you only need to be consistent.
Still, for consistency sakes we use this progression:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">=</span></code> over and underline for section titles</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">=</span></code> underline for titles</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-</span></code> underline for paragraph</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">^</span></code> for subparagraph</p></li>
</ul>
</div></blockquote>
</section>
<section id="wavedrom-integration">
<h4>Wavedrom integration<a class="headerlink" href="#wavedrom-integration" title="Permalink to this heading"></a></h4>
<p>This documentation makes use of the <code class="docutils literal notranslate"><span class="pre">sphinxcontrib-wavedrom</span></code> plugin,
So you can specify a timing diagram, or a register description with the <a class="reference external" href="https://github.com/wavedrom/wavedrom/wiki/WaveJSON">WaveJSON</a> syntax like so:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">..</span><span class="w"> </span><span class="nx">wavedrom</span><span class="o">::</span><span class="w"></span>

<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;signal&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pclk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;p.......&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Pclk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;P.......&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;nclk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;n.......&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Nclk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;N.......&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clk0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;phnlPHNL&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clk1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;xhlhLHl.&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clk2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;hpHplnLn&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clk3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;nhNhplPl&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clk4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wave&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;xlh.L.Hx&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">]}</span><span class="w"></span>
</pre></div>
</div>
<p>and you get:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{ "signal": [
   { "name": "pclk", "wave": "p......." },
   { "name": "Pclk", "wave": "P......." },
   { "name": "nclk", "wave": "n......." },
   { "name": "Nclk", "wave": "N......." },
   {},
   { "name": "clk0", "wave": "phnlPHNL" },
   { "name": "clk1", "wave": "xhlhLHl." },
   { "name": "clk2", "wave": "hpHplnLn" },
   { "name": "clk3", "wave": "nhNhplPl" },
   { "name": "clk4", "wave": "xlh.L.Hx" }
]}
</script>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>if you want the Wavedrom diagram to be present in the pdf export, you need to use the “non relaxed” JSON dialect.
long story short, no javascript code and use <code class="docutils literal notranslate"><span class="pre">&quot;</span></code> around key value (Eg. <code class="docutils literal notranslate"><span class="pre">&quot;name&quot;</span></code>).</p>
</div>
<p>you can describe register mapping with the same syntax:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;reg&quot;</span><span class="o">:</span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="s2">&quot;bits&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;things&quot;</span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="s2">&quot;bits&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;stuff&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="s2">&quot;bits&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">6</span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;bits&quot;</span><span class="o">:</span><span class="mf">16</span><span class="p">,</span><span class="s2">&quot;lanes&quot;</span><span class="o">:</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>

<div style="overflow-x:auto">
<script type="WaveDrom">
{"reg":[
   {"bits": 8, "name": "things"},
   {"bits": 2, "name": "stuff" },
   {"bits": 6}
  ],
  "config": { "bits":16,"lanes":1 }
}
</script>
</div>
</section>
<section id="new-section">
<h4>New section<a class="headerlink" href="#new-section" title="Permalink to this heading"></a></h4>
<p>if you want to add a new  section you need to specify in the top index, the index file of the new section.
I suggest to name the folder like the section name, but is not required;
Sphinx will take the name of the section from the title of the index file.</p>
<section id="example">
<h5>example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h5>
<p>I want to document the new feature in SpinalHDL, and I want to create a section for it; let’s call it <code class="docutils literal notranslate"><span class="pre">Cheese</span></code></p>
<p>So I need to create a folder named <code class="docutils literal notranslate"><span class="pre">Cheese</span></code> (name is not important), and in it create a index file like:</p>
<div class="highlight-ReST notranslate"><div class="highlight"><pre><span></span><span class="gh">======</span>
<span class="gh">Cheese</span>
<span class="gh">======</span>

<span class="p">..</span> <span class="ow">toctree</span><span class="p">::</span>
<span class="nc">:glob:</span>

introduction
*
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">..</span> <span class="pre">toctree::</span></code> directive accept some parameters, in this case <code class="docutils literal notranslate"><span class="pre">:glob:</span></code>
makes so you can use the <code class="docutils literal notranslate"><span class="pre">*</span></code> to include all the remaining files.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The file path is relative to the index file, if you want to specify the absolute path, you need to prepend <code class="docutils literal notranslate"><span class="pre">/</span></code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">introduction.rst</span></code> will be always the first on the list because it’s specified in the index file.
Other files will be included in alphabetical order.</p>
</div>
<p>Now I can add the <code class="docutils literal notranslate"><span class="pre">introduction.rst</span></code> and other files like <code class="docutils literal notranslate"><span class="pre">cheddar.rst</span></code>, <code class="docutils literal notranslate"><span class="pre">stilton.rst</span></code>, etc.</p>
<p>The only thing remaining to do is to add cheese to the top index file like so:</p>
<div class="highlight-ReST notranslate"><div class="highlight"><pre><span></span><span class="gh">Welcome to SpinalHDL&#39;s documentation!</span>
<span class="gh">=====================================</span>

<span class="p">..</span> <span class="ow">toctree</span><span class="p">::</span>
   <span class="nc">:maxdepth:</span> 2
   <span class="nc">:titlesonly:</span>

   rst/About SpinalHDL/index
   rst/Getting Started/index
   rst/Data types/index
   rst/Structuring/index
   rst/Semantic/index
   rst/Sequential logic/index
   rst/Design errors/index
   rst/Other language features/index
   rst/Libraries/index
   rst/Simulation/index
   rst/Examples/index
   rst/Legacy/index
   rst/Developers area/index
   rst/Cheese/index
</pre></div>
</div>
<p>that’s it, now you can add all you want in cheese and all pages will show up in the documentation.</p>
</section>
</section>
</section>
<span id="document-SpinalHDL/Developers area/mill support"></span><section id="build-through-mill">
<h3>Build through Mill<a class="headerlink" href="#build-through-mill" title="Permalink to this heading"></a></h3>
<p>SpinalHDL itself can be built with Mill.  This is an alternative to the Sbt
build tool that can be found at <a class="reference external" href="http://mill-build.com/mill/Intro_to_Mill.html">Introduction_to_Mill</a>.
It can compile/test/publishLocal the existing modules.
Build through mill can be much faster than Sbt, which is useful while debugging.</p>
<section id="compile-the-library">
<h4>Compile the library<a class="headerlink" href="#compile-the-library" title="Permalink to this heading"></a></h4>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mill __.compile
sbt compile <span class="c1"># equivalent alternatives</span>
</pre></div>
</div>
</section>
<section id="run-all-test-suites">
<h4>Run all test suites<a class="headerlink" href="#run-all-test-suites" title="Permalink to this heading"></a></h4>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mill __.test
sbt <span class="nb">test</span> <span class="c1"># equivalent alternatives</span>
</pre></div>
</div>
</section>
<section id="run-a-specified-test-suite">
<h4>Run a specified test suite<a class="headerlink" href="#run-a-specified-test-suite" title="Permalink to this heading"></a></h4>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mill tester.test.testOnly spinal.xxxxx.xxxxx
sbt <span class="s2">&quot;tester/testOnly spinal.xxxxx.xxxxx&quot;</span> <span class="c1"># equivalent alternatives</span>
</pre></div>
</div>
</section>
<section id="run-a-specified-app">
<h4>Run a specified App<a class="headerlink" href="#run-a-specified-app" title="Permalink to this heading"></a></h4>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mill tester.runMain spinal.xxxxx.xxxxx
sbt <span class="s2">&quot;tester/runMain spinal.xxxxx.xxxxx&quot;</span> <span class="c1"># equivalent alternatives</span>
</pre></div>
</div>
</section>
<section id="publish-locally">
<h4>Publish locally<a class="headerlink" href="#publish-locally" title="Permalink to this heading"></a></h4>
<p>Mill can also publish the library to the local ivy2 repository as a <code class="docutils literal notranslate"><span class="pre">dev</span></code> version.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mill __.publishLocal
sbt publishLocal <span class="c1"># equivalent alternatives</span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Developers area/spinalhdl_datamodel"></span><section id="spinalhdl-internal-datamodel">
<h3>SpinalHDL internal datamodel<a class="headerlink" href="#spinalhdl-internal-datamodel" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>This page provides documentation on the internal data structure utilized by SpinalHDL for storing and modifying the netlist described by users via the SpinalHDL API.</p>
</section>
<section id="general-structure">
<h4>General structure<a class="headerlink" href="#general-structure" title="Permalink to this heading"></a></h4>
<p>The following diagrams follow the UML nomenclature :</p>
<ul class="simple">
<li><p>A link with a white arrow mean “base extend target”</p></li>
<li><p>A link with a black diamond mean “base contains target”</p></li>
<li><p>A link with a white diamond mean “base has a reference to target”</p></li>
<li><p>The * symbol mean “multiple”</p></li>
</ul>
<p>The majority of the data structures are stored using double-linked lists, which facilitate the insertion and removal of elements.</p>
<p>There is a diagram of the global data structure :</p>
<img alt="_images/astGlobal.png" class="align-center" src="_images/astGlobal.png" />
<p>And here more details about the <cite>Statement</cite> class :</p>
<img alt="_images/astStatement.png" class="align-center" src="_images/astStatement.png" />
<p>In general, when an element within the data model utilizes other expressions or statements, that element typically includes functions for iterating over these usages. For example, each Expression is equipped with a <em>foreachExpression</em> function.</p>
<p>When using these iteration functions, you have the option to remove the current element from the tree.</p>
<p>Additionally, as a side note, while the <em>foreachXXX</em> functions iterate only one level deep, there are often corresponding <em>walkXXX</em> functions that perform recursive iteration. For instance, using <em>myExpression.walkExpression</em> on <em>((a+b)+c)+d</em> will traverse the entire tree of addition operations.</p>
<p>There are also utilities like <em>myExpression.remapExpressions(Expression =&gt; Expression),</em> which iterate through all the expressions used within <em>myExpression</em> and replace them with the one you provide.</p>
<p>More generally, most of the graph checks and transformations done by SpinalHDL are located in &lt;<a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/dev/core/src/main/scala/spinal/core/internals/Phase.scala">https://github.com/SpinalHDL/SpinalHDL/blob/dev/core/src/main/scala/spinal/core/internals/Phase.scala</a>&gt;</p>
</section>
<section id="exploring-the-datamodel">
<h4>Exploring the datamodel<a class="headerlink" href="#exploring-the-datamodel" title="Permalink to this heading"></a></h4>
<p>Here is an example that identifies all adders within the netlist without utilizing shortcuts. :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">FindAllAddersManually</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Toplevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="nn">internals</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">PrintBaseTypes</span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Phase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">impl</span><span class="p">(</span><span class="n">pc</span><span class="p">:</span><span class="w"> </span><span class="nc">PhaseContext</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">println</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="n">recComponent</span><span class="p">(</span><span class="n">pc</span><span class="p">.</span><span class="n">topLevel</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">recComponent</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">Component</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">recComponent</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="n">dslBody</span><span class="p">.</span><span class="n">foreachStatements</span><span class="p">(</span><span class="n">recStatement</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">recStatement</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">Statement</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="n">foreachExpression</span><span class="p">(</span><span class="n">recExpression</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">ts</span><span class="p">:</span><span class="w"> </span><span class="nc">TreeStatement</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ts</span><span class="p">.</span><span class="n">foreachStatements</span><span class="p">(</span><span class="n">recStatement</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">recExpression</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">Expression</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">e</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">op</span><span class="p">:</span><span class="w"> </span><span class="nc">Operator</span><span class="p">.</span><span class="nc">BitVector</span><span class="p">.</span><span class="nc">Add</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">s&quot;Found </span><span class="si">${</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="si">}</span><span class="s"> + </span><span class="si">${</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="n">foreachExpression</span><span class="p">(</span><span class="n">recExpression</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">hasNetlistImpact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>

<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">toString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="bp">super</span><span class="p">.</span><span class="n">toString</span><span class="si">}</span><span class="s"> - </span><span class="si">$</span><span class="n">message</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalConfig</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add a early phase</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">addTransformationPhase</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">PrintBaseTypes</span><span class="p">(</span><span class="s">&quot;Early&quot;</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add a late phase</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">phasesInserters</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">{</span><span class="n">phases</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">phases</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">phases</span><span class="p">.</span><span class="n">indexWhere</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="k">isInstanceOf</span><span class="p">[</span><span class="nc">PhaseVerilog</span><span class="p">]),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PrintBaseTypes</span><span class="p">(</span><span class="s">&quot;Late&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">generateVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Toplevel</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Which will produces :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[Runtime] SpinalHDL v1.6.1    git head : 3100c81b37a04715d05d9b9873c3df07a0786a9b
[Runtime] JVM max memory : 8044.0MiB
[Runtime] Current date : 2021.10.16 20:31:33
[Progress] at 0.000 : Elaborate components
[Progress] at 0.163 : Checks and transforms
Early
Found (toplevel/a : in UInt[8 bits]) + (toplevel/b : in UInt[8 bits])
Found (toplevel/??? :  UInt[? bits]) + (toplevel/c : in UInt[8 bits])
[Progress] at 0.191 : Generate Verilog
Late
Found (UInt + UInt)[8 bits] + (toplevel/c : in UInt[8 bits])
Found (toplevel/a : in UInt[8 bits]) + (toplevel/b : in UInt[8 bits])
[Done] at 0.218
</pre></div>
</div>
<p>Please note that in many cases, shortcuts are available. All the recursive processes mentioned earlier could have been replaced by a single one. :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">impl</span><span class="p">(</span><span class="n">pc</span><span class="p">:</span><span class="w"> </span><span class="nc">PhaseContext</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">pc</span><span class="p">.</span><span class="n">walkExpression</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">op</span><span class="p">:</span><span class="w"> </span><span class="nc">Operator</span><span class="p">.</span><span class="nc">BitVector</span><span class="p">.</span><span class="nc">Add</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">s&quot;Found </span><span class="si">${</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="si">}</span><span class="s"> + </span><span class="si">${</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="compilation-phases">
<h4>Compilation Phases<a class="headerlink" href="#compilation-phases" title="Permalink to this heading"></a></h4>
<p>Here is the complete list of default phases, arranged in order, that are employed to modify, check, and generate Verilog code from a top-level component. :</p>
<p>&lt;<a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/ec8cd9f513566b43cbbdb08d0df4dee1f0fee655/core/src/main/scala/spinal/core/internals/Phase.scala#L2487">https://github.com/SpinalHDL/SpinalHDL/blob/ec8cd9f513566b43cbbdb08d0df4dee1f0fee655/core/src/main/scala/spinal/core/internals/Phase.scala#L2487</a>&gt;</p>
<p>If you, as a user, add a new compilation phase by using <em>SpinalConfig.addTransformationPhase(new MyPhase())</em>, this phase will be inserted immediately after the user component elaboration process, which is relatively early in the compilation sequence. During this phase, you can still make use of the complete SpinalHDL user API to introduce elements into the netlist.</p>
<p>If you choose to use the SpinalConfig.phasesInserters API, it’s essential to exercise caution and ensure that any modifications made to the netlist align with the phases that have already been executed. For instance, if you insert your phase after the <em>PhaseInferWidth</em>, you must specify the width of each node you introduce.</p>
</section>
<section id="modifying-a-netlist-as-a-user-without-plugins">
<h4>Modifying a netlist as a user without plugins<a class="headerlink" href="#modifying-a-netlist-as-a-user-without-plugins" title="Permalink to this heading"></a></h4>
<p>There are several user APIs that enable you to make modifications during the user elaboration phase. :</p>
<ul class="simple">
<li><p>mySignal.removeAssignments : Will remove all previous <cite>:=</cite> affecting the given signal</p></li>
<li><p>mySignal.removeStatement : Will void the existence of the signal</p></li>
<li><p>mySignal.setAsDirectionLess : Will turn a in / out signal into a internal signal</p></li>
<li><p>mySignal.setName : Enforce a given name on a signal (there is many other variants)</p></li>
<li><p>mySubComponent.mySignal.pull() : Will provide a readable copy of the given signal, even if that signal is somewhere else in the hierarchy</p></li>
<li><p>myComponent.rework{ myCode } : Execute <cite>myCode</cite> in the context of <cite>myComponent</cite>, allowing modifying it with the user API</p></li>
</ul>
<p>For example, the following code can be used to modify a top-level component by adding a three-stage shift register to each input and output of the component. This is particularly useful for synthesis testing.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ffIo</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Component</span><span class="p">](</span><span class="n">c</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">):</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">buf1</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">KeepAttribute</span><span class="p">(</span><span class="nc">RegNext</span><span class="p">(</span><span class="n">that</span><span class="p">)).</span><span class="n">addAttribute</span><span class="p">(</span><span class="s">&quot;DONT_TOUCH&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">buf</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span><span class="n">that</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf1</span><span class="p">(</span><span class="n">buf1</span><span class="p">(</span><span class="n">buf1</span><span class="p">(</span><span class="n">that</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="p">.</span><span class="n">rework</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">getAllIo</span><span class="p">.</span><span class="n">toList</span><span class="w"></span>
<span class="w">    </span><span class="n">ios</span><span class="p">.</span><span class="n">foreach</span><span class="p">{</span><span class="n">io</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;clk&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Do nothing</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">isInput</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">setAsDirectionLess</span><span class="p">().</span><span class="n">allowDirectionLessIo</span><span class="w">  </span><span class="c1">// allowDirectionLessIo is to disable the io Bundle linting</span>
<span class="w">        </span><span class="n">io</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">buf</span><span class="p">(</span><span class="n">in</span><span class="p">(</span><span class="n">cloneOf</span><span class="p">(</span><span class="n">io</span><span class="p">).</span><span class="n">setName</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_wrap&quot;</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">isOutput</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">setAsDirectionLess</span><span class="p">().</span><span class="n">allowDirectionLessIo</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="p">(</span><span class="n">cloneOf</span><span class="p">(</span><span class="n">io</span><span class="p">).</span><span class="n">setName</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_wrap&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">buf</span><span class="p">(</span><span class="n">io</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">???</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You can use the code in the following manner: :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="n">ffIo</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyToplevel</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>Here is a function that enables you to execute the body code as if the current component’s context did not exist. This can be particularly useful for defining new signals without the influence of the current conditional scope (such as when or switch).</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">atBeginingOfCurrentComponent</span><span class="p">[</span><span class="nc">T</span><span class="p">](</span><span class="n">body</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Component</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">dslBody</span><span class="w">  </span><span class="c1">// Get the head of the current component symbols tree (AST in other words)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">.</span><span class="n">push</span><span class="p">()</span><span class="w">                 </span><span class="c1">// Now all access to the SpinalHDL API will be append to it (instead of the current context)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">swapContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">.</span><span class="n">swap</span><span class="p">()</span><span class="w">         </span><span class="c1">// Empty the symbol tree (but keep a reference to the old content)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">that</span><span class="w">                        </span><span class="c1">// Execute the block of code (will be added to the recently empty body)</span>
<span class="w">  </span><span class="n">ctx</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span><span class="w">                         </span><span class="c1">// Restore the original context in which this function was called</span>
<span class="w">  </span><span class="n">swapContext</span><span class="p">.</span><span class="n">appendBack</span><span class="p">()</span><span class="w">              </span><span class="c1">// append the original symbols tree to the modified body</span>
<span class="w">  </span><span class="n">ret</span><span class="w">                                   </span><span class="c1">// return the value returned by that</span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutable</span><span class="p">.</span><span class="nc">HashMap</span><span class="p">[</span><span class="nc">Any</span><span class="p">,</span><span class="w"> </span><span class="nc">Bool</span><span class="p">]()</span><span class="w"></span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Any</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">database</span><span class="p">.</span><span class="n">getOrElseUpdate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">atBeginingOfCurrentComponent</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">object</span><span class="w"> </span><span class="nc">key</span><span class="w"></span>

<span class="n">when</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">somehow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">database</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This kind of functionality is, for instance, employed in the VexRiscv pipeline to dynamically create components or elements as needed.</p>
</section>
<section id="user-space-netlist-analysis">
<h4>User space netlist analysis<a class="headerlink" href="#user-space-netlist-analysis" title="Permalink to this heading"></a></h4>
<p>The SpinalHDL data model is also accessible and can be read during user-time elaboration. Here’s an example that can help find the shortest logical path (in terms of clock cycles) to traverse a list of signals. In this specific case, it is being used to analyze the latency of the VexRiscv FPU design.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">println</span><span class="p">(</span><span class="s">&quot;cpuDecode to fpuDispatch &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">vex</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">arbitration</span><span class="p">.</span><span class="n">isValid</span><span class="p">,</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">valid</span><span class="p">))</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;fpuDispatch to cpuRsp    &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">logic</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span><span class="w"> </span><span class="n">plugin</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">valid</span><span class="p">))</span><span class="w"></span>

<span class="n">println</span><span class="p">(</span><span class="s">&quot;cpuWriteback to fpuAdd   &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">vex</span><span class="p">.</span><span class="n">writeBack</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">plugin</span><span class="p">.</span><span class="nc">FPU_COMMIT</span><span class="p">),</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">commitLogic</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">add</span><span class="p">.</span><span class="n">counter</span><span class="p">))</span><span class="w"></span>

<span class="n">println</span><span class="p">(</span><span class="s">&quot;add                      &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">logic</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="n">rs1</span><span class="p">.</span><span class="n">mantissa</span><span class="p">,</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">merge</span><span class="p">.</span><span class="n">arbitrated</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">mantissa</span><span class="p">))</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;mul                      &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">logic</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">mul</span><span class="p">.</span><span class="n">rs1</span><span class="p">.</span><span class="n">mantissa</span><span class="p">,</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">merge</span><span class="p">.</span><span class="n">arbitrated</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">mantissa</span><span class="p">))</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;fma                      &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">logic</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">mul</span><span class="p">.</span><span class="n">rs1</span><span class="p">.</span><span class="n">mantissa</span><span class="p">,</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="n">rs1</span><span class="p">.</span><span class="n">mantissa</span><span class="p">,</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">merge</span><span class="p">.</span><span class="n">arbitrated</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">mantissa</span><span class="p">))</span><span class="w"></span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;short                    &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">LatencyAnalysis</span><span class="p">(</span><span class="n">logic</span><span class="p">.</span><span class="n">decode</span><span class="p">.</span><span class="n">shortPip</span><span class="p">.</span><span class="n">rs1</span><span class="p">.</span><span class="n">mantissa</span><span class="p">,</span><span class="w"> </span><span class="n">logic</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">merge</span><span class="p">.</span><span class="n">arbitrated</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">mantissa</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>Here you can find the implementation of that LatencyAnalysis tool :
&lt;<a class="reference external" href="https://github.com/SpinalHDL/SpinalHDL/blob/3b87c898cb94dc08456b4fe2b1e8b145e6c86f63/lib/src/main/scala/spinal/lib/Utils.scala#L620">https://github.com/SpinalHDL/SpinalHDL/blob/3b87c898cb94dc08456b4fe2b1e8b145e6c86f63/lib/src/main/scala/spinal/lib/Utils.scala#L620</a>&gt;</p>
</section>
<section id="enumerating-every-clockdomain-in-use">
<h4>Enumerating every ClockDomain in use<a class="headerlink" href="#enumerating-every-clockdomain-in-use" title="Permalink to this heading"></a></h4>
<p>In this case, this is accomplished after the elaboration process by utilizing the SpinalHDL report.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">MyTopLevelVerilog</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cdA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;rawrr&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdA</span><span class="p">(</span><span class="nc">RegNext</span><span class="p">(</span><span class="nc">False</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">cdB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">external</span><span class="p">(</span><span class="s">&quot;miaou&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">regB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdB</span><span class="p">(</span><span class="nc">RegNext</span><span class="p">(</span><span class="nc">False</span><span class="p">))</span><span class="w"></span>

<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">clkC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CombInit</span><span class="p">(</span><span class="n">regB</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">cdC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">(</span><span class="n">clkC</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">regC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdC</span><span class="p">(</span><span class="nc">RegNext</span><span class="p">(</span><span class="nc">False</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MyTopLevel</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clockDomains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutable</span><span class="p">.</span><span class="nc">LinkedHashSet</span><span class="p">[</span><span class="nc">ClockDomain</span><span class="p">]()</span><span class="w"></span>
<span class="w">  </span><span class="n">report</span><span class="p">.</span><span class="n">toplevel</span><span class="p">.</span><span class="n">walkComponents</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">dslBody</span><span class="p">.</span><span class="n">walkStatements</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">s</span><span class="p">.</span><span class="n">foreachClockDomain</span><span class="p">(</span><span class="n">cd</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">clockDomains</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cd</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;ClockDomains : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">clockDomains</span><span class="p">.</span><span class="n">mkString</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">externals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clockDomains</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">clock</span><span class="p">.</span><span class="n">component</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Externals : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">externals</span><span class="p">.</span><span class="n">mkString</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Will print out</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ClockDomains</span> <span class="p">:</span> <span class="n">rawrr_clk</span><span class="p">,</span> <span class="n">miaou_clk</span><span class="p">,</span> <span class="n">clkC</span>
<span class="n">Externals</span> <span class="p">:</span> <span class="n">rawrr_clk</span><span class="p">,</span> <span class="n">miaou_clk</span>
</pre></div>
</div>
</section>
</section>
<span id="document-SpinalHDL/Developers area/types"></span><section id="types">
<h3>Types<a class="headerlink" href="#types" title="Permalink to this heading"></a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h4>
<p>The language provides 5 base types and 2 composite types that can be used.</p>
<ul class="simple">
<li><p>Base types : <code class="docutils literal notranslate"><span class="pre">Bool</span></code>, <code class="docutils literal notranslate"><span class="pre">Bits</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt</span></code> for unsigned integers, <code class="docutils literal notranslate"><span class="pre">SInt</span></code> for signed integers, <code class="docutils literal notranslate"><span class="pre">Enum</span></code>.</p></li>
<li><p>Composite types : Bundle, Vec.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/types.svg"><img alt="_images/types.svg" class="align-center" src="_images/types.svg" width="300" /></a>
<p>Those types and their usage (with examples) are explained hereafter.</p>
<p>Fixed point support is documented <a class="reference internal" href="index.html#fixed"><span class="std std-ref">Fixed-Point</span></a></p>
</section>
<section id="bool">
<h4>Bool<a class="headerlink" href="#bool" title="Permalink to this heading"></a></h4>
<p>This is the standard <em>boolean</em> type that corresponds to a single bit.</p>
<section id="declaration">
<h5>Declaration<a class="headerlink" href="#declaration" title="Permalink to this heading"></a></h5>
<p>The syntax to declare such as value is as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Bool()</p></td>
<td><p>Create a Bool</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>True</p></td>
<td><p>Create a Bool assigned with <code class="docutils literal notranslate"><span class="pre">true</span></code></p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>False</p></td>
<td><p>Create a Bool assigned with <code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>Bool(value : Boolean)</p></td>
<td><p>Create a Bool assigned with a Scala Boolean</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
<p>Using this type into SpinalHDL yields:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w">         </span><span class="c1">// := is the assignment operator</span>
<span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w">   </span><span class="c1">// Use a Scala Boolean to create a literal</span>
</pre></div>
</div>
</section>
<section id="operators">
<h5>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h5>
<p>The following operators are available for the <code class="docutils literal notranslate"><span class="pre">Bool</span></code> type</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 70%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>!x</p></td>
<td><p>Logical NOT</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">x &amp;&amp; y</div>
<div class="line">x &amp; y</div>
</div>
</td>
<td><p>Logical AND</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">x || y</div>
<div class="line">x | y</div>
</div>
</td>
<td><p>Logical OR</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x ^ y</p></td>
<td><p>Logical XOR</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.set[()]</p></td>
<td><p>Set x to True</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>x.clear[()]</p></td>
<td><p>Set x to False</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.rise[()]</p></td>
<td><p>Return True when x was low at the last cycle and is now high</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.rise(initAt : Bool)</p></td>
<td><p>Same as x.rise but with a reset value</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.fall[()]</p></td>
<td><p>Return True when x was high at the last cycle and is now low</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.fall(initAt : Bool)</p></td>
<td><p>Same as x.fall but with a reset value</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.setWhen(cond)</p></td>
<td><p>Set x when cond is True</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.clearWhen(cond)</p></td>
<td><p>Clear x when cond is True</p></td>
<td><p>Bool</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="the-bitvector-family-bits-uint-sint">
<h4>The BitVector family - (<code class="docutils literal notranslate"><span class="pre">Bits</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt</span></code>, <code class="docutils literal notranslate"><span class="pre">SInt</span></code>)<a class="headerlink" href="#the-bitvector-family-bits-uint-sint" title="Permalink to this heading"></a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">BitVector</span></code> is a family of types for storing multiple bits of information in a single value. This type has three subtypes that can be used to model different behaviours:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Bits</span></code> do not convey any sign information whereas the <code class="docutils literal notranslate"><span class="pre">UInt</span></code> (unsigned integer) and <code class="docutils literal notranslate"><span class="pre">SInt</span></code> (signed integer) provide the required operations to compute correct results if signed / unsigned arithmetic is used.</div>
</div>
<section id="declaration-syntax">
<h5>Declaration syntax<a class="headerlink" href="#declaration-syntax" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Bits/UInt/SInt [()]</p></td>
<td><p>Create a BitVector, bits count is inferred</p></td>
<td><p>Bits/UInt/SInt</p></td>
</tr>
<tr class="row-odd"><td><p>Bits/UInt/SInt(x bits)</p></td>
<td><p>Create a BitVector with x bits</p></td>
<td><p>Bits/UInt/SInt</p></td>
</tr>
<tr class="row-even"><td><p>B/U/S(value : Int[,width : BitCount])</p></td>
<td><p>Create a BitVector assigned with ‘value’</p></td>
<td><p>Bits/UInt/SInt</p></td>
</tr>
<tr class="row-odd"><td><p>B/U/S”[[size’]base]value”</p></td>
<td><p>Create a BitVector assigned with ‘value’</p></td>
<td><p>Bits/UInt/SInt</p></td>
</tr>
<tr class="row-even"><td><p>B/U/S([x bits], element, …)</p></td>
<td><p>Create a BitVector assigned with the value specified by elements (see the table below)</p></td>
<td><p>Bits/UInt/SInt</p></td>
</tr>
</tbody>
</table>
<p>Elements could be defined as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x : Int -&gt; y : Boolean/Bool</p></td>
<td><p>Set bit x with y</p></td>
</tr>
<tr class="row-odd"><td><p>x : Range -&gt; y : Boolean/Bool</p></td>
<td><p>Set each bits in range x with y</p></td>
</tr>
<tr class="row-even"><td><p>x : Range -&gt; y : T</p></td>
<td><p>Set bits in range x with y</p></td>
</tr>
<tr class="row-odd"><td><p>x : Range -&gt; y : String</p></td>
<td><div class="line-block">
<div class="line">Set bits in range x with y</div>
<div class="line">The string format follows the same rules as B/U/S”xyz” one</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>x : Range -&gt; y : T</p></td>
<td><p>Set bits in range x with y</p></td>
</tr>
<tr class="row-odd"><td><p>default -&gt; y : Boolean/Bool</p></td>
<td><div class="line-block">
<div class="line">Set all unconnected bits with the y value.</div>
<div class="line">This feature can only be used to do assignments without the U/B/S prefix</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>You can define a Range values</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Range syntax</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Width</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(x downto y)</p></td>
<td><p>[x:y] x &gt;= y</p></td>
<td><p>x-y+1</p></td>
</tr>
<tr class="row-odd"><td><p>(x to y)</p></td>
<td><p>[x:y] x &lt;= y</p></td>
<td><p>y-x+1</p></td>
</tr>
<tr class="row-even"><td><p>(x until y)</p></td>
<td><p>[x:y[ x &lt; y</p></td>
<td><p>y-x</p></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;0000_0101&quot;</span><span class="w">  </span><span class="c1">// Base per default is binary =&gt; 5</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;h1A&quot;</span><span class="w">        </span><span class="c1">// Base could be x (base 16)</span>
<span class="w">                        </span><span class="c1">//               h (base 16)</span>
<span class="w">                        </span><span class="c1">//               d (base 10)</span>
<span class="w">                        </span><span class="c1">//               o (base 8)</span>
<span class="w">                        </span><span class="c1">//               b (base 2)</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;8&#39;h1A&quot;</span><span class="w"></span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w">             </span><span class="c1">// You can use scala Int as literal value</span>

<span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,(</span><span class="mi">6</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myBool</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myUInt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="p">(</span><span class="n">myUInt</span><span class="p">.</span><span class="n">range</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>

<span class="c1">// For assignment purposes, you can omit the B/U/S, which also alow the use of the [default -&gt; ???] feature</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">                       </span><span class="c1">// Assign myUInt with &quot;11111111&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">myUInt</span><span class="p">.</span><span class="n">range</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">                  </span><span class="c1">// Assign myUInt with &quot;11111111&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">            </span><span class="c1">// Assign myUInt with &quot;10000000&quot;</span>
<span class="n">myUInt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">((</span><span class="mi">4</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="n">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="c1">// Assign myUInt with &quot;00011110&quot;</span>
</pre></div>
</div>
</section>
<section id="id1">
<h5>Operators<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h5>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 44%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>~x</p></td>
<td><p>Bitwise NOT</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &amp; y</p></td>
<td><p>Bitwise AND</p></td>
<td><p>T(max(w(x), w(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x | y</p></td>
<td><p>Bitwise OR</p></td>
<td><p>T(max(w(x), w(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x ^ y</p></td>
<td><p>Bitwise XOR</p></td>
<td><p>T(max(w(x), w(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x(y)</p></td>
<td><p>Read bitfield, y : Int/UInt</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x(hi,lo)</p></td>
<td><p>Read bitfield, hi : Int, lo : Int</p></td>
<td><p>T(hi-lo+1 bits)</p></td>
</tr>
<tr class="row-even"><td><p>x(offset,width)</p></td>
<td><p>Read bitfield, offset: UInt, width: Int</p></td>
<td><p>T(width bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x(y) := z</p></td>
<td><p>Assign bits, y : Int/UInt</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x(hi,lo) := z</p></td>
<td><p>Assign bitfield, hi : Int, lo : Int</p></td>
<td><p>T(hi-lo+1 bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x(offset,width) := z</p></td>
<td><p>Assign bitfield, offset: UInt, width: Int</p></td>
<td><p>T(width bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.msb</p></td>
<td><p>Return the most significant bit</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.lsb</p></td>
<td><p>Return the least significant bit</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.range</p></td>
<td><p>Return the range (x.high downto 0)</p></td>
<td><p>Range</p></td>
</tr>
<tr class="row-odd"><td><p>x.high</p></td>
<td><p>Return the upper bound of the type x</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-even"><td><p>x.xorR</p></td>
<td><p>XOR all bits of x</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.orR</p></td>
<td><p>OR all bits of x</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.andR</p></td>
<td><p>AND all bits of x</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x.clearAll[()]</p></td>
<td><p>Clear all bits</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-even"><td><p>x.setAll[()]</p></td>
<td><p>Set all bits</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-odd"><td><p>x.setAllTo(value : Boolean)</p></td>
<td><p>Set all bits to the given Boolean value</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.setAllTo(value : Bool)</p></td>
<td><p>Set all bits to the given Bool value</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>x.asBools</p></td>
<td><p>Cast into an array of Bool</p></td>
<td><p>Vec(Bool(),width(x))</p></td>
</tr>
</tbody>
</table>
</section>
<section id="masked-comparison">
<h5>Masked comparison<a class="headerlink" href="#masked-comparison" title="Permalink to this heading"></a></h5>
<p>Sometimes you need to check equality between a <code class="docutils literal notranslate"><span class="pre">BitVector</span></code> and a bits constant that contain
holes defined as a bitmask (bit positions not to be compared by the equality expression).</p>
<p>An example demonstrating how to do that (note the use of ‘M’ prefix) :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">itMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myBits</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">M</span><span class="s">&quot;00--10--&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="bits">
<h4>Bits<a class="headerlink" href="#bits" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x &gt;&gt; y</p></td>
<td><p>Logical shift right, y : Int</p></td>
<td><p>T(w(x) - y bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;&gt; y</p></td>
<td><p>Logical shift right, y : UInt</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x &lt;&lt; y</p></td>
<td><p>Logical shift left, y : Int</p></td>
<td><p>T(w(x) + y bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &lt;&lt; y</p></td>
<td><p>Logical shift left, y : UInt</p></td>
<td><p>T(w(x) + max(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.rotateLeft(y)</p></td>
<td><p>Logical left rotation, y : UInt</p></td>
<td><p>T(w(x))</p></td>
</tr>
<tr class="row-odd"><td><p>x.resize(y)</p></td>
<td><p>Return a resized copy of x, filled with zero bits as necessary at the
MSB to widen, may also truncate width retaining at the LSB side, y : Int</p></td>
<td><p>T(y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.resizeLeft(y)</p></td>
<td><p>Return a resized copy of x, filled with zero bits as necessary at the
LSB to widen, may also truncate width retraining at the MSB side, y : Int</p></td>
<td><p>T(y bits)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="uint-sint">
<h4>UInt, SInt<a class="headerlink" href="#uint-sint" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 50%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x + y</p></td>
<td><p>Addition</p></td>
<td><p>T(max(w(x), w(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x - y</p></td>
<td><p>Subtraction</p></td>
<td><p>T(max(w(x), w(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x * y</p></td>
<td><p>Multiplication</p></td>
<td><p>T(w(x) + w(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt; y</p></td>
<td><p>Greater than</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x &gt;= y</p></td>
<td><p>Greater than or equal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &lt; y</p></td>
<td><p>Less than</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x &lt;= y</p></td>
<td><p>Less than or equal</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x &gt;&gt; y</p></td>
<td><p>Arithmetic shift right, y : Int</p></td>
<td><p>T(w(x) - y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x &gt;&gt; y</p></td>
<td><p>Arithmetic shift right, y : UInt</p></td>
<td><p>T(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x &lt;&lt; y</p></td>
<td><p>Arithmetic shift left, y : Int</p></td>
<td><p>T(w(x) + y bits)</p></td>
</tr>
<tr class="row-even"><td><p>x &lt;&lt; y</p></td>
<td><p>Arithmetic shift left, y : UInt</p></td>
<td><p>T(w(x) + max(y) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.resize(y)</p></td>
<td><p>Return an arithmetic resized copy of x, y : Int</p></td>
<td><p>T(y bits)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="bool-bits-uint-sint">
<h4>Bool, Bits, UInt, SInt<a class="headerlink" href="#bool-bits-uint-sint" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Binary cast in Bits</p></td>
<td><p>Bits(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asUInt</p></td>
<td><p>Binary cast in UInt</p></td>
<td><p>UInt(w(x) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asSInt</p></td>
<td><p>Binary cast in SInt</p></td>
<td><p>SInt(w(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.asBool</p></td>
<td><p>Binary cast in Bool</p></td>
<td><p>Bool(x.lsb)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="vec">
<h4>Vec<a class="headerlink" href="#vec" title="Permalink to this heading"></a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Declaration</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Vec(type : Data, size : Int)</p></td>
<td><p>Create a vector of size time the given type</p></td>
</tr>
<tr class="row-odd"><td><p>Vec(x,y,..)</p></td>
<td><div class="line-block">
<div class="line">Create a vector where indexes point to given elements.</div>
<div class="line">this construct supports mixed element width</div>
</div>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 67%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x(y)</p></td>
<td><p>Read element y, y : Int/UInt</p></td>
<td><p>T</p></td>
</tr>
<tr class="row-odd"><td><p>x(y) := z</p></td>
<td><p>Assign element y with z, y : Int/UInt</p></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">myVecOfSInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">myVecOfSInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">myVecOfSInt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">myVecOfSInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">myVecOfMixedUInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">myVecOf_xyz_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="w"></span>
<span class="k">for</span><span class="p">(</span><span class="n">element</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">myVecOf_xyz_ref</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">element</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="c1">// Assign x,y,z with the value 0</span>
<span class="p">}</span><span class="w"></span>
<span class="n">myVecOf_xyz_ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="w">    </span><span class="c1">// Assign y with the value 3</span>
</pre></div>
</div>
</section>
<section id="bundle">
<h4>Bundle<a class="headerlink" href="#bundle" title="Permalink to this heading"></a></h4>
<div class="line-block">
<div class="line">Bundles could be used to model data structure line buses and interfaces.</div>
<div class="line">All attributes that extends Data (Bool, Bits, UInt, …) that are defined inside the bundle are considered as part of the bundle.</div>
</div>
<section id="simple-example-rgb-vga">
<h5>Simple example (RGB/VGA)<a class="headerlink" href="#simple-example-rgb-vga" title="Permalink to this heading"></a></h5>
<p>The following example show an RGB bundle definition with some internal function.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">red</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">blue</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">isBlack</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">red</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">isWhite</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="p">((</span><span class="n">channelWidth</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">red</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">max</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then you can also incorporate a Bundle inside Bundle as deeply as you want:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VGA</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">hsync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">vsync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RGB</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>And finally instantiate your Bundles inside the hardware :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">vgaIn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">VGA</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">        </span><span class="c1">// Create a RGB instance</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vgaOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VGA</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="n">vgaOut</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">vgaIn</span><span class="w">            </span><span class="c1">// Assign the whole bundle</span>
<span class="n">vgaOut</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">green</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w">    </span><span class="c1">// Fix the green to zero</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vgaInRgbIsBlack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vgaIn</span><span class="p">.</span><span class="n">rgb</span><span class="p">.</span><span class="n">isBlack</span><span class="w">   </span><span class="c1">// Get if the vgaIn rgb is black</span>
</pre></div>
</div>
<p>If you want to specify your bundle as an input or an output of a Component, you have to do it by the following way :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyComponent</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w">    </span><span class="c1">// Don&#39;t forget the bracket around the bundle.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">rsp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="interface-example-apb">
<span id="id2"></span><h5>Interface example (APB)<a class="headerlink" href="#interface-example-apb" title="Permalink to this heading"></a></h5>
<p>If you want to define an interface, let’s imagine an APB interface, you can also use bundles :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">selWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w">   </span><span class="c1">// This signal is created only when useSlaveError is true</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Example of usage :</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">selWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>One good practice is to group all construction parameters inside a configuration class.
This could make the parametrization much easier later in your components, especially if you have to reuse the same configuration at multiple places.
Also if one time you need to add another construction parameter, you will only have to add it into the configuration class and everywhere this one is instantiated:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">selWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// [val] config, make the configuration public</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Example of usage</span>
<span class="kd">val</span><span class="w"> </span><span class="n">apbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="n">selWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">busA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">busB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then at some points, you will probably need to use the APB bus as master or as slave interface of some components. To do that you can define some functions :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">selWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">PADDR</span><span class="p">,</span><span class="nc">PSEL</span><span class="p">,</span><span class="nc">PENABLE</span><span class="p">,</span><span class="nc">PWRITE</span><span class="p">,</span><span class="nc">PWDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="nc">PREADY</span><span class="p">,</span><span class="nc">PRDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">PSLVERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">asSlave</span><span class="p">():</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">asMaster</span><span class="p">().</span><span class="n">flip</span><span class="p">()</span><span class="w"> </span><span class="c1">// Flip reverse all in out configuration.</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Example of usage</span>
<span class="kd">val</span><span class="w"> </span><span class="n">apbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="n">selWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">masterBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">).</span><span class="n">asMaster</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">slaveBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">).</span><span class="n">asSlave</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Then to make that better, the spinal.lib integrates a small master slave utility named IMasterSlave. When a bundle extends IMasterSlave, it should implement/override the asMaster function.
It give you the ability to setup a master or a slave interface in a smoother way :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">apbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="n">selWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">masterBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">slaveBus</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>An example of an APB bus that implement this IMasterSlave :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// You need to import spinal.lib._ to use IMasterSlave</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">selWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">APB</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">APBConfig</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w">   </span><span class="c1">// This signal is created only when useSlaveError is true</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">PADDR</span><span class="p">,</span><span class="nc">PSEL</span><span class="p">,</span><span class="nc">PENABLE</span><span class="p">,</span><span class="nc">PWRITE</span><span class="p">,</span><span class="nc">PWDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="nc">PREADY</span><span class="p">,</span><span class="nc">PRDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">PSLVERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The asSlave is by default the flipped version of asMaster.</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="enum">
<h4>Enum<a class="headerlink" href="#enum" title="Permalink to this heading"></a></h4>
<p>SpinalHDL supports enumeration with some encodings :</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Encoding</p></th>
<th class="head"><p>Bit width</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>native</p></td>
<td></td>
<td><p>Use the VHDL enumeration system, this is the default encoding</p></td>
</tr>
<tr class="row-odd"><td><p>binarySequancial</p></td>
<td><p>log2Up(stateCount)</p></td>
<td><p>Use Bits to store states in declaration order (value from 0 to n-1)</p></td>
</tr>
<tr class="row-even"><td><p>binaryOneHot</p></td>
<td><p>stateCount</p></td>
<td><p>Use Bits to store state. Each bit position corresponds to one state,
only one bit is active at a time when encoded.</p></td>
</tr>
</tbody>
</table>
<p>Define an enumeration type:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SpinalEnum</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Or SpinalEnum(defaultEncoding=encodingOfYourChoice)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sIdle</span><span class="p">,</span><span class="w"> </span><span class="n">sStart</span><span class="p">,</span><span class="w"> </span><span class="n">sData</span><span class="p">,</span><span class="w"> </span><span class="n">sParity</span><span class="p">,</span><span class="w"> </span><span class="n">sStop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newElement</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Instantiate a signal to store the enumeration encoded value and assign it a value :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">stateNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">()</span><span class="w"> </span><span class="c1">// Or UartCtrlTxState(encoding=encodingOfYouChoice)</span>
<span class="n">stateNext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">sIdle</span><span class="w"></span>

<span class="c1">// You can also import the enumeration to have the visibility on its elements</span>
<span class="k">import</span><span class="w"> </span><span class="nc">UartCtrlTxState</span><span class="p">.</span><span class="n">_</span>
<span class="n">stateNext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sIdle</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="data-bool-bits-uint-sint-enum-bundle-vec">
<h4>Data (Bool, Bits, UInt, SInt, Enum, Bundle, Vec)<a class="headerlink" href="#data-bool-bits-uint-sint-enum-bundle-vec" title="Permalink to this heading"></a></h4>
<p>All hardware types extends the Data class, which mean that all of them provide following operators :</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Return</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>x === y</p></td>
<td><p>Equality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-odd"><td><p>x =/= y</p></td>
<td><p>Inequality</p></td>
<td><p>Bool</p></td>
</tr>
<tr class="row-even"><td><p>x.getWidth</p></td>
<td><p>Return bitcount</p></td>
<td><p>Int</p></td>
</tr>
<tr class="row-odd"><td><p>x ## y</p></td>
<td><p>Concatenate, x-&gt;high, y-&gt;low</p></td>
<td><p>Bits(width(x) + width(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>Cat(x)</p></td>
<td><p>Concatenate list, first element on lsb, x : Array[Data]</p></td>
<td><p>Bits(sumOfWidth bits)</p></td>
</tr>
<tr class="row-odd"><td><p>Mux(cond,x,y)</p></td>
<td><p>if cond ? x : y</p></td>
<td><p>T(max(w(x), w(y) bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.asBits</p></td>
<td><p>Cast in Bits</p></td>
<td><p>Bits(width(x) bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.assignFromBits(bits)</p></td>
<td><p>Assign from Bits</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>x.assignFromBits(bits,hi,lo)</p></td>
<td><p>Assign bitfield, hi : Int, lo : Int</p></td>
<td><p>T(hi-lo+1 bits)</p></td>
</tr>
<tr class="row-odd"><td><p>x.assignFromBits(bits,offset,width)</p></td>
<td><p>Assign bitfield, offset: UInt, width: Int</p></td>
<td><p>T(width bits)</p></td>
</tr>
<tr class="row-even"><td><p>x.getZero</p></td>
<td><p>Get equivalent type assigned with zero</p></td>
<td><p>T</p></td>
</tr>
</tbody>
</table>
</section>
<section id="literals-as-signal-declaration">
<h4>Literals as signal declaration<a class="headerlink" href="#literals-as-signal-declaration" title="Permalink to this heading"></a></h4>
<p>Literals are generally use as a constant value. But you can also use them to do two things in a single one :</p>
<ul class="simple">
<li><p>Define a signal which is assigned with a constant value</p></li>
<li><p>Setup inferred type: UInt(4 bits)</p></li>
<li><p>Clock cycles where <cite>cond =/= True</cite> will result in the constant being reinstated</p></li>
<li><p>Clock cycles where <cite>cond === True</cite> will result in the signal having the
value of <cite>red</cite> due to the last statement wins rule.</p></li>
</ul>
<p>An example :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">red</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w">          </span><span class="c1">// Bool signal which is by default assigned with False</span>
<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;0100&quot;</span><span class="w">        </span><span class="c1">// UInt signal of 4 bits which is by default assigned with 4</span>
<span class="n">when</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">red</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="continuous-assignment-literals-as-signal-declaration">
<h4>Continuous Assignment Literals as signal declaration<a class="headerlink" href="#continuous-assignment-literals-as-signal-declaration" title="Permalink to this heading"></a></h4>
<p>You can also use them in expressions to do three things at once :</p>
<ul class="simple">
<li><p>Define a wire</p></li>
<li><p>Maintain the result of an equality operation in the hardware logic implementation with the constant
value and another signal</p></li>
<li><p>Setup inferred type: Bool due to use of === equality operator having a
result of type Bool</p></li>
</ul>
<p>There is an example :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="nc">False</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">U</span><span class="s">&quot;0001&quot;</span><span class="w">  </span><span class="c1">// inferred type is Bool due to use of === operator</span>
<span class="n">when</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
</div>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018 - 2025, SpinalHDL.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
    <!-- source/_templates/footer.html -->
    
    <div class="doc-footer-current-version"><p>
    Version: master (HEAD) git~8d2a6517fb 2025-05-29
    </p></div>
    


</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
       <dt>Languages</dt>
       
          
            <dd class="rtd-current-item"><a href="#">en</a></dd>
          
       
          
            <dd><a href="../zh_CN/index.html">zh_CN</a></dd>
          
       
    </dl>
    <dl>
      <dt>Tags</dt>
      <dd><a href="../v1.3.1/index.html">v1.3.1</a></dd>
      <dd><a href="../v1.3.8/index.html">v1.3.8</a></dd>
      <dd><a href="../v1.5.0/index.html">v1.5.0</a></dd>
      <dd><a href="../v1.6.0/index.html">v1.6.0</a></dd>
      <dd><a href="../v1.8.0/index.html">v1.8.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../dev/index.html">dev</a></dd>
      <dd><a href="index.html">master</a></dd>
    </dl>
    <dl>
      <dt>Downloads</dt>
      <dd><a href="artefacts/SpinalHDL_docs-master.">HTML</a></dd>
      <dd><a href="artefacts/SpinalHDL_docs-master-SingleHTML.zip">SingleHTML</a></dd>
      <dd><a href="artefacts/SpinalHDL_docs-master.pdf">PDF</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>